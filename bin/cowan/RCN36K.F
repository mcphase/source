      PROGRAM RCN36
C     PROGRAM RCN36(IN36,TAPE10=IN36,OUT36,TAPE9=OUT36,TAPE11,
C    1  INDIEL,TAPE12=INDIEL,TAPE4,TAPE2N,TAPE2=TAPE2N,TAPE7)
C
C          THIS PROGRAM COPYRIGHT BY LOS ALAMOS NATIONAL LABORATORY
C               AND THE U.S. GOVERNMENT.  THE PROGRAM MAY BE FREELY
C               DISTRIBUTED GRATIS ANYWHERE IN THE WORLD, BUT
C               MAY NOT BE SOLD.
C
C
C     HARTREE-FOCK-SLATER SELF-CONSISTENT ATOMIC FIELD PROGRAM(KUT=1,0)
C          WITH OPTIONS FOR HARTREE (KUT=-1, EXFM1=0.0) OR FOR
C               HARTREE-PLUS-STATISTICAL-EXCHANGE (KUT=-1, EXFM1.GT.0)
C               OR FOR HARTREE-SLATER (KUT=-2)
C               OR FOR HARTREE-FOCK (IHF=2)
C
C      ORIGINALLY  WRITTEN BY SHERWOOD SKILLMAN,
C           RCA LABORATORIES, PRINCETON, NEW JERSEY, SPRING 1961
C      MODIFIED BY FRANK HERMAN, SUMMER 1961
C      FURTHER MODIFIED BY RICHARD KORTUM,  LOCKHEED RESEARCH
C           LABORATORIES, PALO ALTO, CALIFORNIA,  SUMMER 1962
C      FURTHER MOD BY R. D. COWAN, LASL, JAN-MAR,1964, OCT,65-MAR,66,
C           MAY-JUNE,1966, NOV-DEC,1966.
C      FURTHER MOD BY K. L. ANDREW, LASL, MAY 1968, TO SIMPLIFY
C           CONFIGURATION INPUT
C      METHOD OF CALCULATING CORRELATION-ENERGY CORRECTION
C           MODIFIED JANUARY, 1971.
C      CALCULATION OF CONTINUUM FUNCTIONS MODIFIED JUNE, 1972
C           TO HANDLE KINETIC ENERGIES UP TO 500 RYDBERGS
C           (NO MESH-SIZE DOUBLING BEYOND POINT IDB AT WHICH
C                DELTAR=0.25/SQRT(EMX)   )
C      FINITE-BOUNDARY AND RELATIVISTIC OPTIONS ADDED SPRING,1973
C      HARTREE-FOCK OPTIONS (IHF=2) ADDED APRIL AND AUGUST 1981
C      MORE FLEXIBLE CONFIGURATION-CARD INPUT INTRODUCED (MOD 33)
C           AT PURDUE, JULY-AUGUST 1987
C      VINTI-INTEGRAL OPTION ADDED AT ROYAL HOLLOWAY BEDFORD NEW COLLEGE,
C           OCTOBER 1987
C      OPTION TO DELETE WRITING OF OUTPUT ON TAPE2 WHEN THE CONFIGURATION
C           CARD CONTAINS AN ASTERISK ANYWHERE IN COLUMNS 21 TO 26
C           ADDED AT THE ZEEMAN LABORATORY, DECEMBER 1987.
C
C      RCN MOD 34, ADAPTED TO THE VAX 8200 AT LUND UNIVERSITY,
C           MADE MARCH 1988.  FURTHER MODIFIED TO USE GENERIC FUNCTIONS,
C           ETC., AT LANL, JULY-DECEMBER, 1988
C      RCN MOD 35, INCORPORATING SUBROUTINES
C           DIEL AND ANALYZ1 TO SET UP INPUT FOR DIELECTRONIC-
C           RECOMBINATION RUNS, MADE AT LANL JANUARY 1989
C      THIS VERSION (MOD 36) WITH COMMONS OF THE SAME NAME HAVING THE
C           SAME LENGTH IN ALL ROUTINES, AND WITH TIMING ROUTINE
C           SECONDS CODED FOR CRAY, VAX AND MACINTOSH, SUN, OR
C           IBM SYSTEM/6000 RISC, MADE AT LANL FEBRUARY-APRIL 1992
C               (UNCOMMENT APPROPRIATE SECTION OF THIS ROUTINE)
C      MODIFICATIONS FOR MACINTOSH CENTRIS (USING LANGUAGE SYSTEMS
C           FORTRAN), AND FEATURE TO WRITE SOME OUTPUT TO THE MONITOR
C           SCREEN IF IW6<0, ADDED MAY 1993
C               -----------------------------------------------
C
C
C     BINARY TAPE 2  CONTAINS SELF CONSISTENT ATOMIC POTENTIAL,
C      ENERGY EIGENVALUES, AND RADIAL WAVE FUNCTIONS
C      SUCCESSIVE SOLUTIONS SEPARATED BY END OF LOGICAL RECORD.
C     Z = ATOMIC NUMBER.  ION = IONICITY.  ZZZ = ION+1.
C     RHO=TOTAL ELECTRON DENSITY
C     RHOM=ELECTRON DENSITY OF MIN(WWNL(M),2.0) ELECTRONS IN ORBITAL M
C     RUEE=TOTAL CLASSICAL ELECTRON-ELECTRON POTENTIAL
C     RUEEM=SAME FOR ONE ELECTRON OF ORBITAL M
C     RUEXCH=-2.0*(3.0*RHO/PI)**(1.0/3.0)
C     RU=-2.0*Z+RUEE+EXF10*RUEXCH
C     KUT= 1, RV=MIN1F(RU,-2.0*ION) ---HFS (NO TAIL CUTOFF)
C     KUT= 0, RV=MIN1F(RU,-2.0*ZZZ) ---HFS (WITH LATTER TAIL CUTOFF)
C     KUT=-1, ---HX OR HARTREE
C       RV=-2*Z+RUEE-RUEEM+EXFM1*RUEXCH*(1.0-RHOM/RHO)*F1*F2
C          F1=(RHO-RHOM)/(RHO-RHOM+CA0/(N-L))
C          F2=1.0 EXCEPT FOR L(M) GREATER THAN 1 AND EITHER
C            L(M-1)=L(M), OR L(M-2)=L(M) AND WWNL(M-1)=1,
C                 IN WHICH CASES
C          F2=1.0+CA1*(R(J)-R(I))/R(J)  FOR I LESS THAN J,
C            WHERE R(J) IS THE POSITION OF THE KTH NODE OF PNL(M)
C               (K=NO. OF ORBITALS WITH L=L(M) AND N LESS THAN N(M).)
C     IHF=1, WRITE OUTPUT ON TAPE7 AS INPUT TO PROGRAM HF8
C     IHF=2, MAKE SELF-CONTAINED HARTREE-FOCK CALCULATION WITHIN RCN
C
C     MAXIT = MAXIMUM NO. OF ITERATIONS
C     EXF=FACTOR MULTIPLYING SLATER EXCHANGE TERM
C     CORRF=FACTOR MULTIPLYING CORRELATION TERM
C
C
      CHARACTER*20 INF
C
C          ----------------------------------------------------------
C          COMMENT OUT IMPLICIT REAL*8 CARDS FOR 64-BIT MACHINES,
C               UNCOMMENT THEM FOR VAX, SUN, ETC.
C          ----------------------------------------------------------
C          OPEN FILES, IF NOT DONE VIA PROGRAM CARD
C            (USE III>1 AND PROGRAM CARD AT START
C             OF PROGRAM FOR CRAY AND CDC COMPUTERS)
C            (OTHERWISE, COMMENT OUT PROGRAM CARD THAT DEFINES FILES AND
C             SET III=1 TO USE STANDARD FILE NAMES, OR
C             SET III=0 TO NAME FILES INTERACTIVELY, E.G. FOR VAX)
C           ---------------------------------------------------------
C
      III=1
      IF (III.EQ.1) GO TO 150
      IF (III.GT.1) GO TO 160
C
      WRITE(6,*) ' INPUT FILE NAME  '
      READ(5,11) INF
   11 FORMAT(A20)
      OPEN(10,FILE=INF,STATUS='OLD')
      WRITE(6,*) ' OUTPUT FILE NAME  '
      READ(5,12) INF
   12 FORMAT (A)
      OPEN(9,FILE=INF,STATUS='UNKNOWN')
      WRITE(6,*) ' GIVE NAME OF DATA FILE FOR THE RCN2-PROGRAM '
      READ(5,12) INF
      IF(INF.NE.'   ') GO TO 120
      OPEN(2,STATUS='SCRATCH',FORM='UNFORMATTED')
      GO TO 155
  120 OPEN(2,FILE=INF,STATUS='UNKNOWN',FORM='UNFORMATTED')
      GO TO 155
C
C          USE THESE OPEN STATEMENTS FOR STANDARD FILE NAMES
C               (SET III=1 IN STATEMENT ABOVE)
C
  150 OPEN(10,FILE='IN36',STATUS='OLD')
      OPEN(9,FILE='OUT36',STATUS='UNKNOWN')
      OPEN(2,FILE='TAPE2N',STATUS='UNKNOWN',FORM='UNFORMATTED')
  155 CONTINUE
      OPEN(7,STATUS='SCRATCH')
      OPEN(4,STATUS='SCRATCH',FORM='UNFORMATTED')
C
C
  160 REWIND 10
      READ (10,10,END=200) INF(1:5)
   10 FORMAT (A5)
      IF (INF(1:5).NE.'   -1') GO TO 300
C
C          IF TAPE10 IS EMPTY OR THE FIRST RECORD IS AN EXIT CARD, 
C      CALL DIEL TO SET UP RCN INPUT FOR DIELECTRONIC RECOMBINATION RUNS
C
  200 IF (III.LT.2) OPEN(12,FILE='INDIEL',STATUS='OLD')
      IF (III.LT.2) OPEN(11,STATUS='SCRATCH')
      CALL DIEL
C
C          CALL RCN FOR (FINAL) CALCULATION OF RADIAL WAVEFUNCTIONS
C
  300 REWIND 10
      CALL RCN
      END
      SUBROUTINE RCN
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      CHARACTER*8 NLBCD(KO),NLBCDO(KO),NLBCD8(KO),IFG(10,9),JFG(10,9),
     1  NLA,NLB
      CHARACTER CONF(3)*6,INPCARD*70
      COMMON/CHAR/CONF,NLBCD,NLBCDO,NLBCD8,IFG,JFG,NLA,NLB,INPCARD
      COMMON XI(KMSH),XJ(KMSH),V(KMSH),RSCORE(KMSH),RSVALE(KMSH),
     1  RECORR(KMSH),RUCORR(KMSH),RC(KMSH),PNLO(KMSH),X1(KMSH),X2(KMSH)
C
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
      COMMON/C3/NPAR,NZI,NFIJ,NGIJ,VPRM(50),KPAR(50),ZI(8),FIJ(30),
     1  GIJ(35),NORB,NORBPT,DH(5),DELTA,NPR
      COMMON/C4/VR(KMSH),QQ0(KMSH),IREL,NITER,NN,LAM,E,END,NODF,I,J,K,
     1  MM,IMATCH,RSINT,RSINT1,HXID,IZHXBW,IPHFWF,IHF,IHF1,NPRINT
      COMMON/C5/IZO,IONO,LBCD(21),MORB(7),IBLANK,WWWNL(39),EEO(KO),
     1  WWNL8(8),EE8,NOELEC,IERROR,WWNLO(KO),N1SC,N1SCF
      COMMON/C6/A0,A1,A2,A3,A4,AB1,AB3,B0,B1,B2,B3,ERAS,ERAS1,ERAS2
      COMMON/C7/T0,T1,T2
      COMMON/C8/NHFTRM,NFG,ETOTRL,EHF(KO),T1HF(9),T2HF(9),ETERM,
     1  NF(9),NG(9),CFG(10,9),FG(10,9),KFG(10,9),RHFMTC(KO),II
      COMMON PNL(KMSH,KO),QNL(KMSHQ,KOQ)
      COMMON/LC2/RA(KMSH),RB(KMSH)
C
      DIMENSION RSQ(KMSH),QQ(KMSH),DELP(KO),ALFM(KO),
     1  S1(10,KO),S2(10,KO),ZETA(KO,3)
      EQUIVALENCE (RU,      F1), (RUEE,  F2), (RUEXCH,RSQ,XA,EMN),
     1  (RSATOM,QQ,DRUDR,XB), (A,DELP,RRYD), (B,ALFM,RKAY)
      EQUIVALENCE (RSATOM,S1),(RSATOM(251),S2),(RSATOM(501),ZETA)
C
      INTEGER WWWNL,WWNL8
      INTEGER FG
C
      DIMENSION RU0(91)
      CHARACTER*8 CHXID
      DATA HXID1,HXID2,HFID1,HFID2 /2HXB,2HXR,2HHF,2HHR/
      DATA RU0/1.0D0,0.99094D0,0.98164D0,0.97218D0,0.96266D0,0.95311D0,
     1  0.94359D0,0.93413D0,0.92475D0,0.91549D0,0.90634D0,0.88844D0,
     2  0.87109D0,0.85429D0,0.83802D0,0.82227D0,0.80700D0,0.79220D0,
     3  0.77785D0,0.76393D0,0.75044D0,0.72473D0,0.70066D0,0.67816D0,
     4  0.65710D0,0.63732D0,0.61866D0,0.60097D0,0.58416D0,0.56814D0,
     5  0.55285D0,0.52427D0,0.49813D0,0.47416D0,0.45214D0,0.43184D0,
     6  0.41304D0,0.39553D0,0.37916D0,0.36377D0,0.34927D0,0.32262D0,
     7  0.29887D0,0.27789D0,0.25953D0,0.24348D0,0.22926D0,0.21645D0,
     8  0.20468D0,0.19376D0,0.18354D0,0.16493D0,0.14852D0,0.13412D0,
     9  0.12152D0,0.11053D0,0.10094D0,0.09255D0,0.08517D0,0.07866D0,
     A  0.07289D0,0.06311D0,0.05556D0,0.048D0,0.042D0,0.037D0,0.033D0,
     B  0.030D0,0.025D0,0.021D0,0.017D0,0.014D0,0.011D0,0.009D0,0.007D0,
     C  0.006D0,0.005D0,0.004D0,0.003D0,0.002D0,0.001D0,0.D0,0.D0,0.D0,
     D  0.D0,0.D0,0.D0,0.D0,0.D0,0.D0,0.D0/
      DATA JHLF/'F'/
      DATA JHUF/'F'/
C
C      KMSH=1801
C      KO=20
C
C
C     POSITION TAPES 2, 4, AND 7 FOR NEXT RUN
C
  160 REWIND 2
      REWIND 4
      REWIND 7
      MESHX=KMSH
      MESH=MESHX
      IZO=-7
      IONO=-7
      DO 165 M=1,20
      EEO(M)=-7.D0
      WWNLO(M)=0.D0
  165 NLBCDO(M)=' '
      NCSPVO=0
      NS=1
      NCONF=0
      NCONFT=0
      NCONFT2=0
      RSINT1=0.D0
      DO 170 I=1,MESH
      RUEXCH(I)=0.D0
  170 RUEE(I)=0.D0
C
C          EXPAND ATOMIC POTENTIAL FROM DATA BLOCK
C
  195 M=0
      DO 196 I=1,361,4
      M=M+1
  196 RU(I)=RU0(M)
      CALL SECONDS(T0)
      T0=T0
      T1=T0
C
C          READ CONTROL CARD.
C
  200 READ (10,20) ITPOW,IPTVU,IPTEB,NORBPT,IZHXBW,IPHFWF,IHF,IBB,
     1  TOLSTB,TOLKM2,TOLEND,THRESH,
     2  KUTD,KUT1,IVINTI,IREL,MAXIT,NPR,EXF10,EXFM1,EMX,CORRF,IW6
   20 FORMAT (3I1,I2,I1,2I2,I3,F2.1,E5.1,2E10.1,I2,I2,2I1,2I2,4F5.5,I5)
      CA0=0.50
      CA1=0.70
      IHF1=IHF
      IF (IHF.GT.1) IHF=0
      THRES1=THRESH
      IF ((KMSHQ.LT.KMSH.OR.KOQ.LT.KO).AND.IREL.EQ.2) IREL=1
      HXID=HXID1
      IF (IREL.NE.0) HXID=HXID2
      IF (IHF1.GT.1) HXID=HFID1
      IF (IHF1.GT.1.AND.IREL.NE.0) HXID=HFID2
      CHXID='        '
      IF (IHF1.GT.1) CHXID='HF      '
      IF (IHF1.GT.1.AND.IREL.NE.0) CHXID='HFR     '
      IF (KUTD.EQ.0) KUTD=-2
      IF (EMX.GT.0.0) GO TO 204
C          SET EMX = LARGEST CONTINUUM ENERGY (IF ANY)
      IREAD=0
C 201 READ (10,19) N,IZ,EE8
C  19 FORMAT (I1,I4,69X,0PF6.5)
  201 READ (10,21) N,IZ,IBB1,NSPECT,INPCARD
      CALL ANALYZ
      IREAD=IREAD+1
      IF (IZ.LE.0) GO TO 202
      EMX=MAX(EMX,EE8)
      IF (N.EQ.0) GO TO 201
      DO 1201 I=1,N
      READ (10,18) NFG
   18 FORMAT (10X,I5)
      IF (NFG.GT.3) READ (10,18)
      IF (NFG.GT.7) READ (10,18)
 1201 IREAD=IREAD+1+NFG/4
      GO TO 201
C
  202 IF (IREAD.EQ.0) GO TO 204
      DO 203 I=1,IREAD
  203 BACKSPACE 10
C
  204 IF (EMX.LE.0.D0) EMX=1.D-20
      MESH=MESHX
      IF (EMX.LE.1.D-20) MESH=MIN0(MESH,641)
      IB=IBB
      IF (IBB.EQ.0.AND.MESH.LT.MESHX) IB=MESH
      IF (IBB.EQ.0.AND.IB.EQ.0) IB=MESH-1
      ICUT=MESH
      IF (IREL.EQ.0) GO TO 210
      DO 205 I=1,MESH
  205 VR(I)=0.D0
C
C          READ Z, STAGE OF IONIZATION, AND CONFIGURATION.
C
C 210 READ (10,21) NHFTRM,IZ,IBB1,NSPECT,CONF,IALFMIN,IALFMAX,
C    1  (NLBCD8(M),WWNL8(M), M=1,8), KUT,EE8
C  21 FORMAT (I1,I4,I3,I2,3A6,2I2,8(A3,A2),I2,0PF6.5)
C     ALFMIN=0.01D0*IALFMIN
C     ALFMAX=0.01D0*IALFMAX
  210 READ (10,21) NHFTRM,IZ,IBB1,NSPECT,INPCARD
   21 FORMAT (I1,I4,I3,I2,A70)
      N1SCF=1
      IF (IBB1.LE.KO.AND.NCONFT.GT.0) N1SCF=MAX0(1,IBB1+1)
      IF (IBB1.LE.KO) IBB1=0
      IF (IZ.EQ.-999) RETURN
      IF (IZ) 212,200,214
  212 END FILE 2
      REWIND 2
      IF (IHF.NE.0) GO TO 213
      CLOSE (7,STATUS='DELETE')
      CLOSE (4,STATUS='DELETE')
      IF (III.LT.2) CLOSE (11,STATUS='DELETE')
      STOP '(NORMAL EXIT)'
  213 NCSPVS=0
      WRITE (7) CONF,NCONF,IZ,Z,NCSPVS,RHOHF,H,NO,NHFTRM,IREL,ETOTRL,
     1  NUFSH,IZHXBW,NS,IPHFWF
      END FILE 7
      REWIND 7
      STOP '(CFF HF EXIT)'
  214 IF (INPCARD(1:6).NE.'      ') GO TO 216
C          SKIP OVER IZ COMPLETED RUNS ON TAPE 2
      DO 215 N=1,IZ
      READ (2) NNN,L,WWNL,NCSPVS,VPRM,CONF,NCONF,IZ1,Z,ION,IREL,HXID,
     1  MESH,C,IDB,EXF,CORRF,CA1,CA0,KUT,NPAR,NLBCD,NNLZ,NKKK,EE,NORB,
     2  R,RU
  215 WRITE (9,22) NCONF, (CONF(I), I=1,3)
   22 FORMAT (36H0ON TAPE 2, SKIP OVER CONFIGURATION ,I3,1H=,3X,3A6)
      NCONFT=NCONF
      NCONFT2=NCONF
      GO TO 210
  216 IF (IBB1.GT.0) IB=IBB1
      IF (NSPECT.EQ.0)  NSPECT = 1
      NOELEC = IZ + 1 - NSPECT
C          ANALYZE INPCARD
      CALL ANALYZ
C
      NF(1)=0
      NG(1)=0
      IF (IHF.EQ.0) GO TO 217
      IF (IREL.GT.0.AND.NOELEC.GT.2) GO TO 217
      IF (TOLEND.GT.5.D-5) TOLEND=5.D-8
      IF (THRESH.GT.1.D-8) THRESH=1.D-11
      THRES1=THRESH
  217 IF (NHFTRM.EQ.0) GO TO 230
      DO 220 I=1,NHFTRM
      READ (10,23) T1HF(I),T2HF(I),NFG,
     1  (CFG(J,I),FG(J,I),KFG(J,I),IFG(J,I),JFG(J,I), J=1,3)
   23 FORMAT (A7,A3,I5,5X,3(F9.8,A1,I1,1X,A3,1X,A3,1X))
      IF (NFG.GT.3) READ (10,24)
     1  (CFG(J,I),FG(J,I),KFG(J,I),IFG(J,I),JFG(J,I), J=4,NFG)
   24 FORMAT (4(F9.8,A1,I1,1X,A3,1X,A3,1X))
      NF(I)=0
      DO 218 J=1,NFG
      IF (FG(J,I).EQ.JHLF.OR.FG(J,I).EQ.JHUF) NF(I)=NF(I)+1
  218 CONTINUE
  220 NG(I)=NFG-NF(I)
  230 IF (ALFMIN.EQ.0.D0)  ALFMIN=0.2D0
      IF (ALFMAX.EQ.0.D0)  ALFMAX=1.D0
      ALFFIX=0.4D0*ALFMAX
      IF (KUT.EQ.-1) ALFFIX=1.D0
      IF (KUT.EQ.0)  KUT = KUT1
      IF (IZ.NE.IZO.AND.KUT.LT.0) KUT=0
      Z=IZ
      TWOZ=Z+Z
      NVALES=1
      C=0.88534138D0/Z**(1.D0/3.D0)
      NBLOCK=(MESH)/40
C
      IF (ITPOW.LT.8) GO TO 240
      WRITE (9,26) IZ,NSPECT,CONF,ALFMIN,ALFMAX, (NLBCD8(M),WWNL8(M),
     1  M=1,8), EE8,ALFFIX
   26 FORMAT (29H1CARD IMAGE EXCEPT FOR ALPHAS,2(2X,I3),3A6, F5.3,1X,
     1  F5.3, 8(A3,A2),F8.5, 8HALFFIX =,F5.3 //  )
C
C           SET UP ORBITALS AND ESTIMATE EIGENVALUES
C
  240 CALL SETCFG
      IF (IERROR.NE.0) GO TO 210
      IF (IHF.EQ.0.OR.NNN(NCSPVS).LE.10) GO TO 260
      IF (TOLEND.GT.5.D-5) TOLEND=5.D-8
      IF (THRESH.GT.1.D-8) THRESH=1.D-11
      THRES1=THRESH
  260 IF (N1SC.GT.1.OR.N1SCF.GT.1) GO TO 300
C
C          CONSTRUCT ATOMIC POTENTIAL
C
  270 IF (NCONFT.GT.0) GO TO 280
      DO 272 I=1,357,4
  272 RU(I)=-RU(I)*TWOZ
      RU(361)=RU(357)
      RU(365)=RU(357)
      M=9
      DO 275 I=1,357,4
      M=M-1
      IF (M.GE.0) GO TO 274
      RU(I+1)=(22.D0*RU(I)+11.D0*RU(I+4)-RU(I+8))/32.D0
      RU(I+2)=(10.D0*RU(I)+15.D0*RU(I+4)-RU(I+8))/24.D0
      RU(I+3)=( 6.D0*RU(I)+27.D0*RU(I+4)-RU(I+8))/32.D0
      M=9
      GO TO 275
  274 RU(I+1)=(21.D0*RU(I)+14.D0*RU(I+4)-3.D0*RU(I+8))/32.D0
      RU(I+2)=( 3.D0*RU(I)+ 6.D0*RU(I+4)-     RU(I+8))/ 8.D0
      RU(I+3)=( 5.D0*RU(I)+30.D0*RU(I+4)-3.D0*RU(I+8))/32.D0
  275 CONTINUE
      DO 276 I=362,MESH
  276 RU(I)=RU(361)
      GO TO 285
C
  280 IF (DABS(TWOZ+RU(1)).LE.0.001D0) GO TO 285
      ERAS=(-TWOZ-RU(MESH))/(RU(1)-RU(MESH))
      DO 282 I=1,MESH
  282 RU(I)=RU(MESH)+ERAS*(RU(I)-RU(MESH))
  285 RUM=-TWOION
      IF (RU(MESH).LE.RUM) GO TO 290
      ERAS=(RUM-RU(1))/(RU(MESH)-RU(1))
      DO 289 I=2,MESH
  289 RU(I)=RU(1)+ERAS*(RU(I)-RU(1))
C
C          CONSTRUCT R MESH
C
  290 I=1
      R(1)=0.D0
      IDB=1
      RDB=0.D0
      DELTAR=0.0025D0*C
      DRX=0.4D0/DSQRT(EMX)
      DO 295 J=1,NBLOCK
      DO 294 K=1,40
      I=I+1
      R(I)=R(I-1)+DELTAR
  294 CONTINUE
      IF (DELTAR.GE.DRX) GO TO 295
      IDB=I
      RDB=R(I)
      DELTAR=DELTAR+DELTAR
  295 CONTINUE
      R(1)=1.D-10
      V(1)=-TWOZ/R(1)
C
C
  300 IHFTRM=MAX0(1,NHFTRM)
      IF (IHF.EQ.1) IHFTRM=1
      WRITE (NLA,29) CONF(1)
   29 FORMAT (A6)
      NDEL=1
      DO 305 K=1,6
      IF (NLA(K:K).EQ.'*') NDEL=0
  305 CONTINUE
      DO 850 II=1,IHFTRM
      NFG=NF(II)+NG(II)
      NCONFT=NCONFT+1
      NCONFT2=NCONFT2+NDEL
      NCONF=0
      IF (NDEL.EQ.1) NCONF=NCONFT2
      ION=IZ-NOELEC
      DELTA=2000.D0
      DELT=2000.D0
      EXF=EXF10
      IF (KUT.EQ.-1) EXF=EXFM1
  310 NITER=0
      END=0.D0
C
  330 IF (TOLEND.LT.1.D-4) WRITE (9,30)
   30 FORMAT (1H1)
      WRITE (9,31) CONF,NCONF,IZ,NCORES,NVALES,ION,C,CA1
   31 FORMAT (3H   ,3A6,2X,10H    NCONF=,I3,6H    Z=,I3,11H    NCORES=,
     1  I2,11H    NVALES=,I2, 8H    ION=,I2, 14H    R(I)/X(I)=,F10.8,
     2  6X,4HCA1=,F5.3)
      N1SCFM1=N1SCF-1
      N1SC=N1SCF
      IF (ITPOW.EQ.2) GO TO 390
      WRITE (9,32)TOLSTB,TOLKM2,TOLEND,THRESH,KUT, EXF,CORRF,CA0,IHF1,
     1  MESH,IDB,RDB,EMX,R(MESH),IREL,IB
   32 FORMAT (/8H TOLSTB=,F5.3,3X,7HTOLK-2=,F7.5,3X,7HTOLEND=,E8.1,
     1  3X,7HTHRESH=,E8.1,3X,4HKUT=,I2,4X,4HEXF=,F5.3,9H   CORRF=,F5.3,
     2  6X,4HCA0=,F6.3//18H0RCN MOD 36  IHF1=,I2,
     3  8X,5HMESH=,I4,3X,4HIDB=,I4,3X,4HRDB=,F8.3,3X,4HEMX=,F7.2,
     4  3X,8HR(MESH)=,F8.3,5X,5HIREL=,I2,5X,3HIB=,I4)
      IF (IHF1.NE.2) GO TO 360
      IF (NHFTRM.GT.0) GO TO 345
      WRITE (9,33) CHXID
   33 FORMAT (1H0,A8,15H ENERGY = E(AV))
      GO TO 360
  345 WRITE (9,34) T1HF(II),T2HF(II),(CFG(J,II),FG(J,II),KFG(J,II),
     1  IFG(J,II),JFG(J,II), J=1,NFG)
   34 FORMAT (12H0ENERGY = E(,A7,A3,9H) = E(AV),4(3H + ,F9.6,1H*,A1,I1,
     1  1H(,A3,1H,,A3,1H))
     2  /31X,4(3H + ,F9.6,1H*,A1,I1,1H(,A3,1H,,A3,1H)))
  360 IF (N1SC.GT.1) WRITE (9,36)
   36 FORMAT (50X,45H CALCULATE ONLY OUTERMOST (CONTINUUM) ORBITAL)
      IF (N1SCF.LE.1) GO TO 370
      WRITE (9,27) N1SCFM1
   27 FORMAT ('0*****FIRST',I3,' ORBITAL(S) HELD FIXED')
C
  370 WRITE (9,37) (NLBCD(M),M=1,NCSPVS)
   37 FORMAT (//31H IT  TIME   DELTA  IDEL KUT ITP,1X,19(A3,2X)/
     1  34X,10(A3,2X))
  390 IF (IW6.LT.0) WRITE (6,37) (NLBCD(M),M=1,NCSPVS)
C
C          START SCF ITERATION
C
  400 NITERP=0
      IF (KUT.EQ.-1) NITERP=1
  401 NITERP=NITERP+1
  402 NITER=NITER+1
      THRESH=THRES1
      IF (ALFFIX.GE.0.7D0) GO TO 406
C     IF (DELTA/TOLEND.LT.100.D0) GO TO 406
C     THRESH=DSQRT(THRES1*DELTA)
  406 IF (NPR.LE.0) GO TO 409
      WRITE (9,40) NITER, (RU(I), I=1,400,20), (RUEE(I), I=1,400,20),
     1  (RUEXCH(I), I=1,400,20)
   40 FORMAT (1H1,I2,5X,14HRU,RUEE,RUEXCH/(10F12.6/10F12.6//))
  409 DO 410 I=1,MESH
      RSCORE(I)=0.D0
  410 RSVALE(I)=0.D0
      NOD=0
      NOF=0
C
C          CALC V FOR KUT GREATER THAN -1
C
  411 DO 413 I=1,MESH
  413 RC(I)=RSATOM(I)
      ERAS=-TWOZZZ
      IF (KUT) 430,418,417
  417 ERAS=-TWOION
  418 DO 425 I=2,MESH
      A0=DMIN1(RU(I),ERAS)
      V(I)=A0/R(I)
  425 X2(I)=V(I)
C
C     SOLVE SCHROEDINGER EQUATION FOR EACH ORBITAL IN TURN.
C            ALSO, CALCULATE CORE AND VALENCE CHARGE DENSITIES.
C
  430 DO 499 M=1,NCSPVS
      IF (END.GT.0.D0.AND.M.GT.NCSPVS) GO TO 800
      KKK=NKKK(M)
      IF (END.EQ.0.D0.AND.N1SC.GT.1.AND.M.LT.N1SC) GO TO 491
      E=EE(M)
      NN=NNN(M)
      LAM=L(M)
      NODF=0
      IF (LAM-2) 433,431,432
  431 NOD=NOD+1
      NODF=NOD
      GO TO 433
  432 IF (LAM.NE.3) GO TO 433
      NOF=NOF+1
      NODF=NOF
  433 IF (E.LE.0.D0) GO TO 434
      NN=99999
  434 IF (KUT.LT.0) GO TO 435
      IF (END) 450,450,449
  435 IF (M.GT.NCSPVO) GO TO 450
      DO 437 I=1,MESH
      IF (E.LE.0.D0) GO TO 436
      RSATOM(I)=0.D0
      GO TO 437
  436 RSATOM(I)=PNL(I,M)**2
  437 CONTINUE
C
C     CALC XI(I)=COULOMB ENERGY OF ONE ELECTRON IN ORBITAL M
C
      CALL QUAD2(1)
C
C          IF (IHF1.GT.1) CALC HF POTENTIAL
      IF (IHF1.GT.1) CALL HFPOT(M)
      TWO=2.D0
      A4=DMIN1(WWNL(M),TWO)
      J=JJJ(M)
      DO 447 I=2,MESH
      IF (IHF1.GT.1.AND.IREL.EQ.0) GO TO 446
      IF (KUT.EQ.-2) GO TO 442
C          CALC HX POTENTIAL
      ERAS=RC(I)-A4*RSATOM(I)
      A0=EXFM1*ERAS/(ERAS+A0M(M))
      IF (I.GE.J) GO TO 441
      A0=A0*(1.D0+CA1*(R(J)-R(I))/R(J))
  441 CONTINUE
      A2=0.D0
      IF (RC(I).NE.0.D0) A2=ERAS/RC(I)
      X1(I)=RU(I)-XI(I)+(A0*A2-EXF10)*RUEXCH(I)
      GO TO 444
C          CALC HS POTENTIAL
  442 ERAS1=R(I)
      ERAS=A4*RSATOM(I)
      ERAS=2.D0*RSATOM(I)
      CALL SUBCOR
      X1(I)=RU(I)-XI(I)-EXF10*B3
      IF (WWNL(M).GT.1.D0) GO TO 444
      ERAS=RC(I)+RSATOM(I)
      CALL SUBCOR
      X1(I)=X1(I)+EXF10*(B3-RUEXCH(I))
  444 CONTINUE
      X2(I)=X1(I)/R(I)
      IF (IHF1.LE.1) XJ(I)=X1(I)
  446 V(I)=XJ(I)/R(I)
C          ADD CORRELATION CONTRIBUTION TO POTENTIAL
      IF (CORRF.LE.0.D0) GO TO 447
      ERAS1=R(I)
      ERAS=RC(I)-RSATOM(I)
      CALL SUBCOR
      V(I)=V(I)+CORRF*B2/ERAS1
  447 CONTINUE
      IF (END.LE.0.D0) GO TO 450
      KKK=NKKK(M)
      IF (IHF.EQ.1.AND.IREL.EQ.0.AND.NCSPVS.GT.1) GO TO 449
      IF (IPTVU.LT.5) GO TO 449
      ERAS=DELP(M)/PNL(KKK-47,M)
      ERAS1=L(M)*(L(M)+1)
      DO 448 I=1,400,20
  448 RSATOM(I)=XJ(I)+ERAS1/R(I)
      WRITE (9,49) NITER,NLBCD(M),RSINT1,ERAS, (XI(I), I=1,400,20),
     1  (XJ(I), I=1,400,20), (RSATOM(I),I=1,400,20)
      IF (IPTVU.LT.6.OR.M.LT.NCSPVS) GO TO 449
      WRITE (9,1570) CONF,NLBCD(M),EE(M)
 1570 FORMAT (1H1,3A6,1H(,A3,10H FUNCTION,,3X,2HE=,F11.6,1H)///5X,1HI,
     1  10X,1HR,13X,3HR*V,10X,6HR*VEFF,12X,1HP,9X,10H(VEFF-E)*P,3X,
     2  14HD2P/DR2 (5 PT),1X,14HD2P/DR2 (3 PT),5X,6HVEFF-E/)
      IX=MIN0(NKKK(M),500)
      DO 1571 I=2,IX
      RSATOM(I)=XJ(I)+ERAS1/R(I)
      A4=RSATOM(I)/R(I)-EE(M)
      B0=A4*PNL(I,M)
      IF (I.EQ.2.OR.MOD(I,40).EQ.0) GO TO 1569
      J=I+2
      JJ=40*(I/40)+1
      A0=1.D0/(R(J)-R(J-1))**2
      DO 1568 I1=1,5
      PNLO(553-I1)=PNL(J,M)
      J=J-1
      IF (J.LT.JJ) J=J-1
 1568 CONTINUE
      B2=A0*(16.D0*(PNLO(551)+PNLO(549))-30.D0*PNLO(550)-PNLO(552)
     1  -PNLO(548))/12.D0
      B1=A0*(PNLO(551)-2.D0*PNLO(550)+PNLO(549))
      GO TO 1571
 1569 B2=0.D0
      B1=4.D0*A0*(PNL(I+1,M)-2.D0*PNL(I,M)+PNL(I-1,M))
 1571 WRITE (9,1572) I,R(I),XJ(I),RSATOM(I),PNL(I,M),B0,B2,B1,A4
 1572 FORMAT (I6,7F15.6,1P,E19.6)
  449 WRITE (4) (V(I), I=1,MESH)
      GO TO 499
C
C     INTEGRATE DIFFERENTIAL EQUATION TO OBTAIN RADIAL WAVEFUNCTION PNL
C
  450 MM=M
      IF (M.LT.N1SCF) GO TO 491
      CALL SCHEQ
      JJJ(M)=J
      IF (M.LT.3) GO TO 451
      IF (L(M).EQ.L(M-1)) GO TO 452
      IF (L(M).NE.L(M-2)) GO TO 451
      IF (WWNL(M-1).EQ.1.D0) GO TO 452
  451 JJJ(M)=1
C
  452 EE(M)=E
      EHF(M)=-E
      NKKK(M)=KKK
      KKK=NKKK(M)
      IMAT(M)=IMATCH
      IF (NITER.GT.10) GO TO 454
      NSCH(NITER,M)=NPRINT
C
C          STABILIZE PNL IF E NEG AND NITERP GR THAN 1
C
  454 ERAS=0.D0
      ERAS=PNLO(KKK-47)-PNL(KKK-47,M)
      IF (NITERP.EQ.1) GO TO 460
      IF (E.GT.0.D0) GO TO 459
      IF (ERAS.EQ.0.D0) GO TO 461
      IF (NITERP-2) 460,470,480
  459 ALFM(M)=1.D0
      GO TO 461
  460 ALFM(1)=ALFFIX
      ALFM(M)=0.D0
  461 DO 462 I=1,KKK
  462 PNL(I,M)=PNLO(I)
      GO TO 487
  470 ALFM(M)=ALFFIX
      GO TO 485
  480 IF (DELP(M).EQ.0.D0) GO TO 484
      B0=ERAS/DELP(M)
      IF (B0.GT.-0.2D0) GO TO 482
      ALFM(M)=DMAX1(ALFMIN,ALFM(M)*0.66667D0)
      GO TO 485
  482 IF (B0.LT.0.2D0) GO TO 484
      ALFM(M)=DMIN1(ALFMAX,ALFM(M)*1.5D0)
  484 IF (ALFM(M).GE.1.D0) GO TO 461
  485 A0=1.D0-ALFM(M)
      DO 486 I=1,KKK
  486 XJ(I)=ALFM(M)*PNLO(I)+A0*PNL(I,M)
      IF (EE(M).GT.0.D0) GO TO 487
      CALL QUAD5(XJ,2,1,KKK,PNORM)
      PNORM=1.D0/DSQRT(PNORM)
      DO 1486 I=1,KKK
 1486 PNL(I,M)=PNORM*XJ(I)
  487 IF (KKK.GE.MESH) GO TO 490
      K1=KKK+1
      DO 489 I=K1,MESH
  489 PNL(I,M)=0.D0
  490 DELP(M)=ERAS
C
  491 IF (M.GT.NCORES) GO TO 493
      IF (EE(M).GT.0.D0) GO TO 495
      DO 492 I=1,KKK
  492 RSCORE(I)=RSCORE(I)+WWNL(M)*PNL(I,M)**2
      GO TO 495
  493 DO 494 I=1,KKK
  494 RSVALE(I)=RSVALE(I)+WWNL(M)*PNL(I,M)**2
  495 IF (NPR.LE.0) GO TO 499
      DO 497 I=1,400
  497 XJ(I)=V(I)*R(I)
      WRITE (9,49) NITER,NLBCD(M),RSINT1,E,(XI(I),I=1,400,20), (XJ(I),
     1  I=1,400,20), (PNLO(I), I=1,400,20),(PNL(I,M),I=1,400,20)
   49 FORMAT (/1H0,I2,3X,A3,F15.7,F15.6,3X,8HR*VSELF,,2X,9HR*VTOTAL,,2X,
     1  7HR*VEFF,,3X,59H(IF DIAGNOSTIC PRINT OUT-R*VS, R*VT, CALC. WVFN,
     2 MOD. WVFN)  / (10F12.6/10F12.6 // ))
  499 CONTINUE
      NCSPVO=NCSPVS
      IF (END.GT.0.D0) GO TO 800
C
C     CALC TOTAL CHARGE DENSITY AND EXCHANGE AND CORRELATION POTENTIALS
C
  500 DO 509 I=1,MESH
      IF (EE(NCSPVS).LE.0.D0) GO TO 502
      RSATOM(I)=RSCORE(I)
      GO TO 503
  502 RSATOM(I)=RSCORE(I)+RSVALE(I)
  503 ERAS1=R(I)
      ERAS=RSATOM(I)
      CALL SUBCOR
      RC(I)=B0
      RECORR(I)=B1
      RUCORR(I)=B2
      RUEXCH(I)=B3
  509 CONTINUE
      RC(1)=RC(2)+RC(2)-RC(3)
C
C       CALC RUEE=R*(ELECTRON-ELECTRON ENERGY), XJ=R*(TOTAL ENERGY)
C
      CALL QUAD2(2)
C
C
C          CALCULATE DELTA
C
  530 DELTA=0.D0
      DELTO=DELT
      IDELTO=IDELTA
      DO 540 I=1,MESH
      A0=XJ(I)-RU(I)
      ERAS=DABS(A0)
      IF (ERAS-DELTA) 540,540,535
  535 DELTA=ERAS
      DELT=A0
      IDELTA=I
  540 CONTINUE
      IF (NITERP.GT.2.AND.DABS(DELT/DELTO).GT.1.D0.AND.ALFMAX.GT.0.5D0)
     1THEN
        HALF=0.5D0
        ALFMAX=DMAX1(0.8D0*ALFMAX,HALF)
        ALFMIN=DMIN1(0.2D0*ALFMAX,ALFMIN)
      ENDIF
      CALL SECONDS(T2)
      TIME=T2-T1
      IF (IW6.LT.0) WRITE (6,55) NITER,TIME,DELT,IDELTA,KUT,NITERP,
     1  (ALFM(M), M=1,NCSPVS)
  550 IF (ITPOW.NE.1.AND.ITPOW.LT.3.AND.NPR.EQ.0) GO TO 600
      WRITE (9,55) NITER,TIME,DELT,IDELTA,KUT,NITERP,
     1  (ALFM(M), M=1,NCSPVS)
   55 FORMAT (1X,I2,F6.2,F10.6,I4,I3,I4,1X,19F5.2/F38.2,9F5.2)
C
C          CALCULATE NEXT TRIAL POTENTIAL.
C             (STABILIZE RU IF NITERP=1)
C
  600 A1=1.D0
      IF (NITERP.GT.1) GO TO 650
      ERAS=DELT/DELTO
      IF (ERAS.GT.-0.3D0) GO TO 603
      ALFFIX=ALFFIX*0.8D0
      GO TO 610
  603 IF (ERAS.LT.0.3D0) GO TO 610
      IF (IABS(IDELTA-IDELTO).GT.50) GO TO 610
      ALFFIX=ALFFIX*1.25D0
  610 A1=ALFFIX
  650 A0=1.D0-A1
      DO 660 I=1,MESH
  660 RU(I)=A1*XJ(I)+A0*RU(I)
C
C     TEST SELF-CONSISTENCY OF ATOMIC POTENTIAL,
C          AND (IF THRESH=THRES1) OF THE WAVEFUNCTIONS.
C
  700 IF (NITER.LE.1) GO TO 402
      IF (DELTA.GE.TOLEND) GO TO 710
      IF (THRESH.GT.THRES1) GO TO 710
      IF (IHF.EQ.1.AND.NCSPVS.GT.1) GO TO 780
      IF (TOLKM2.GE.0.1.AND.KUT.GT.-1) GO TO 710
      DO 708 M=N1SC,NCSPVS
      KKK=NKKK(M)
      IF (DABS(DELP(M)/PNL(KKK-47,M)).GT.5.D-6) GO TO 710
  708 CONTINUE
      IF (EE(NCSPVS).GT.0.D0.AND.DABS(DELP(NCSPVS)).GT.1.D-7) GO TO 710
      GO TO 780
  710 IF (NITER.LT.MAXIT) GO TO 730
      IF (NPR.NE.9999) GO TO 725
      NPR=NPR0
      MAXIT=MAXIT-4
      GO TO 780
  725 IF (DELTA.LE.4.D0*TOLEND) GO TO 780
      NPR0=NPR
      NPR=9999
      MAXIT=MAXIT+4
  730 IF (KUT.LT.0) GO TO 740
      IF (KUT.GE.0.AND.TOLKM2.GT.TOLEND.AND.DELTA.LT.TOLKM2) GO TO 735
      IF (DELTA.LT.TOLEND) GO TO 740
      IF (DELTA.GE.TOLKM2) GO TO 740
  735 KUT=-1
      EXF=EXFM1
      IF (KUTD.NE.-1) GO TO 400
      KUT=-2
      EXF=EXF10
      GO TO 400
  740 IF (NITERP.GE.2) GO TO 401
      IF (DELTA-TOLSTB) 401,402,402
C
  780 END=1.D0
      IF (NPR.EQ.9999) NPR=NPR0
      WRITE (4) RU,RUEE,RUEXCH,RSATOM,RECORR,RUCORR
      IF (IHF.EQ.0) GO TO 411
      IF (TOLEND.GT.1.D-4) GO TO 800
      IF (IHF.EQ.1.AND.IREL.NE.0.AND.NCSPVS.GT.1) GO TO 800
      GO TO 411
C
  800 IF (ITPOW.NE.2) GO TO 810
      WRITE (9,32)TOLSTB,TOLKM2,TOLEND,THRESH,KUT, EXF,CORRF,CA0,IHF1,
     1  MESH,IDB,RDB,EMX,R(MESH),IREL,IB
      IF (IHF1.NE.2) GO TO 806
      IF (NHFTRM.GT.0) GO TO 803
      WRITE (9,33) CHXID
      GO TO 806
  803 WRITE (9,34) T1HF(II),T2HF(II),(CFG(J,II),FG(J,II),KFG(J,II),
     1  IFG(J,II),JFG(J,II), J=1,NFG)
  806 IF (N1SC.GT.1) WRITE (9,36)
      IF (N1SCF.LE.1) GO TO 810
      WRITE (9,27) N1SCFM1
C
  810 IF (IHF.EQ.0) CALL CLOCK
      CALL OUTPT
      IF (NNN(NCSPVS).GT.98) CALL PHSHIFT
      IF (IHF.NE.0.OR.NHFTRM.EQ.0) GO TO 840
      IF (II.EQ.1) WRITE (7,55)
      DO 820 I=2,NPAR
  820 VPRM(I)=VPRM(I)/109.73731
      WRITE (7,82) CONF,T1HF(II),T2HF(II),(VPRM(I),KPAR(I),I=1,NPAR)
   82 FORMAT (2A6,A2,A7,A3,F12.4,I1,8(F9.5,I1)/28X,9(F9.5,I1))
C
  840 IF (IVINTI.GT.0) CALL VINTI(IVINTI)
      CALL CLOCK
      IF (IW6.LT.0) THEN
        TR=T2-T1
        TJ=T2-T0
        WRITE (6,85) CONF,TR,TJ
   85   FORMAT (' FINISHED  ',2A6,A2,'  AT   T(RUN)=',F6.2,',',5X,
     1    'T(JOB)=',F7.2,' SECONDS')
      ENDIF
      T1=T2
  850 CONTINUE
C
      IF (TOLKM2.NE.TOLEND.AND.KUT.GT.-1) GO TO 210
  991 KUT=KUT-1
      IF (KUT.EQ.KUTD) GO TO 991
      IF (KUT+2) 210,300,300
C
      END
      SUBROUTINE ANALYZ
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      CHARACTER*8 NLBCD(KO),NLBCDO(KO),NLBCD8(KO),IFG(10,9),JFG(10,9),
     1  NLA,NLB
      CHARACTER CONF(3)*6,INPCARD*70,CHTEMP*70,LBCD(21)*1
      COMMON/CHAR/CONF,NLBCD,NLBCDO,NLBCD8,IFG,JFG,NLA,NLB,INPCARD
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
      COMMON/C5/IZO,IONO,IDUM(21),MORB(7),IBLANK,WWWNL(39),EEO(KO),
     1  WWNL8(8),EE8,NOELEC,IERROR,WWNLO(KO),N1SC,N1SCF
      CHARACTER*4 WWWNL,WWNL8
C
      DATA LBCD/'S','P','D','F','G','H','I','K','L','M',
     1          'N','O','Q','R','T','U','V','W','X','Y','Z'/
C
      I=6
  110 NBL=0
  112 I=I+1
      IF (INPCARD(I:I).NE.' ') GO TO 110
      NBL=NBL+1
      IF (NBL.GE.3.OR.I.GE.18) GO TO 120
      GO TO 112
C          CONFIGURATION IDENTIFICATION
  120 CHTEMP=' '
      I=MIN0(I,18)
      CHTEMP(1:I)=INPCARD(1:I)
      READ (CHTEMP,12) CONF
   12 FORMAT (3A6)
C
      I3=I
      DO 125 J=1,8
      NLBCD8(J)='   '
  125 WWNL8(J)='    '
      KUT=0
      EE8=0.D0
      NALF=0
      ALFMIN=0.D0
      ALFMAX=0.D0
      NORB=0
C
C
  130 I=I3
      I1=0
      I2=0
      I3=0
      IDEC=0
      INEG=0
      CHTEMP=' '
C
  132 I=I+1
      IF (I.GT.70) GO TO 900
      IF (INPCARD(I:I).NE.' ') GO TO 134
      IF (I3.NE.0) GO TO 150
      GO TO 132
  134 IF (I1.EQ.0) I1=I
      IF (I2.GT.0) GO TO 138
      DO 136 J=1,20
      IF (INPCARD(I:I).EQ.LBCD(J)) I2=I
  136 CONTINUE
      IF (INPCARD(I:I).EQ.'.') IDEC=I
      IF (INPCARD(I:I).EQ.'-') INEG=I
  138 I3=I
      IF (I.LT.70.OR.I1.EQ.0) GO TO 132
C
  150 CHTEMP=' '
      IF (I2.NE.0.AND.I1.GE.I2-2) GO TO 300
      IF (NORB.EQ.0.AND.NALF.EQ.0.AND.I3.GT.I1.AND.INEG.EQ.0) GO TO 200
      IF (IDEC.GT.0) GO TO 500
      IF (INEG.GT.0.OR.I1.EQ.I3) GO TO 400
      GO TO 500
C          ALFMAX AND (IF I3-I1.GT.1) ALFMIN
  200 IF (I2.GT.0) I3=I2-3
      CHTEMP(I1-I3+4:4)=INPCARD(I1:I3)
      READ (CHTEMP,20) IALFMIN,IALFMAX
   20 FORMAT (2I2)
      ALFMIN=0.01D0*IALFMIN
      ALFMAX=0.01D0*IALFMAX
      NALF=1
      GO TO 130
C          ORBITAL
  300 I3=MIN0(I3,I2+2)
      CHTEMP(3+I1-I2:5)=INPCARD(I1:I3)
      NORB=NORB+1
      READ (CHTEMP,30) NLBCD8(NORB),WWNL8(NORB)
   30 FORMAT (A3,A2)
      GO TO 130
C          KUT
  400 CHTEMP(1:2)=INPCARD(I3-1:I3)
      READ (CHTEMP,40) KUT
   40 FORMAT (I2)
      GO TO 130
C          EE8
  500 CHTEMP=INPCARD(I1:I3)
      READ (CHTEMP,50) EE8
   50 FORMAT (F70.3)
      GO TO 130
C
  900 CONTINUE
C     WRITE (9,90) INPCARD
C  90 FORMAT (/3X,A70)
C     WRITE (9,91) CONF,ALFMIN,ALFMAX,(NLBCD8(M),WWNL8(M),M=1,8),
C    1  KUT,EE8
C  91 FORMAT (1X,3A6,2F3.1,8(A3,A2),I2,F6.2)
      RETURN
      END
      BLOCK DATA
 
      IMPLICIT REAL*8 (A-H,O-Z)
      INTEGER WWWNL,WWNL8
      PARAMETER (KO=20)
      COMMON/C5/IZO,IONO,LBCD(21),MORB(7),IBLANK,WWWNL(39),EEO(KO),
     1  WWNL8(8),EE8,NOELEC,IERROR,WWNLO(KO),N1SC,N1SCF
      COMMON/TIMING/TINIT,ITINIT
      DATA ITINIT /0/
C
      DATA IBLANK /2H  /
      DATA (MORB(I),I=1,7)   /1,3,5,8,11,15,19/
      DATA (LBCD(I),I=1,21)/1HS,1HP,1HD,1HF,1HG,1HH,1HI,1HK,1HL,1HM,
     1                      1HN,1HO,1HQ,1HR,1HT,1HU,1HV,1HW,1HX,1HY,1HZ/
      DATA (WWWNL(M),M=1,39) /2H0 ,2H1 ,2H2 ,2H3 ,2H4 ,2H5 ,2H6 ,2H7 ,
     1           2H8 ,2H9 ,2H10,2H11,2H12,2H13,2H14,2H15,
     2           2H16,2H17,2H18,2H 0,2H 1,2H 2,2H 3,2H 4,
     3           2H 5,2H 6,2H 7,2H 8,2H 9,2H00,2H01,2H02,
     4           2H03,2H04,2H05,2H06,2H07,2H08,2H09/
C
      END
      SUBROUTINE SETCFG
C
C     SET UP HEAVIEST NOBLE GAS CONFIGURATION WITH NO. OF ELECTRONS
C          .LE.IZ-NSPECT+1, AND MODIFY AS INDICATED ON CONFIG. INPUT CAR
C     ESTIMATE EIGENVALUE FOR EACH ORBITAL
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      CHARACTER*8 NLBCD(KO),NLBCDO(KO),NLBCD8(KO),IFG(10,9),JFG(10,9),
     1  NLA,NLB
      CHARACTER CONF(3)*6,INPCARD*70
      COMMON/CHAR/CONF,NLBCD,NLBCDO,NLBCD8,IFG,JFG,NLA,NLB,INPCARD
      COMMON XI(KMSH),XJ(KMSH),V(KMSH),RSCORE(KMSH),RSVALE(KMSH),
     1  RECORR(KMSH),RUCORR(KMSH),RC(KMSH),PNLO(KMSH),X1(KMSH),X2(KMSH)
C
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
      COMMON/C3/NPAR,NZI,NFIJ,NGIJ,VPRM(50),KPAR(50),ZI(8),FIJ(30),
     1  GIJ(35),NORB,NORBPT,DH(5),DELTA,NPR
      COMMON/C4/VR(KMSH),QQ0(KMSH),IREL,NITER,NN,LAM,E,END,NODF,I,J,K,
     1  MM,IMATCH,RSINT,RSINT1,HXID,IZHXBW,IPHFWF,IHF,IHF1,NPRINT
      COMMON/C5/IZO,IONO,LBCD(21),MORB(7),IBLANK,WWWNL(39),EEO(KO),
     1  WWNL8(8),EE8,NOELEC,IERROR,WWNLO(KO),N1SC,N1SCF
      COMMON/C6/A0,A1,A2,A3,A4,AB1,AB3,B0,B1,B2,B3,ERAS,ERAS1,ERAS2
      COMMON PNL(KMSH,KO),QNL(KMSHQ,KOQ)
C
      DIMENSION RSQ(KMSH),QQ(KMSH),DELP(KO),ALFM(KO),
     1  S1(10,KO),S2(10,KO),ZETA(KO,3)
      DIMENSION NE(7)
      EQUIVALENCE (RU,      F1), (RUEE,  F2), (RUEXCH,RSQ,XA,EMN),
     1  (RSATOM,QQ,DRUDR,XB), (A,DELP,RRYD), (B,ALFM,RKAY)
      EQUIVALENCE (RSATOM,S1),(RSATOM(251),S2),(RSATOM(501),ZETA)
      INTEGER WWWNL,WWNL8
C
      DATA (NE(I),I=1,7)     /2,10,18,36,54,86,118/
C
C     SET UP NOBLE GAS CORE WITH ATOMIC NUMBER LESS THAN OR EQUAL TO NOE
C
C     FIRST FIND NUMBER OF ORBITALS IN THIS CORE FROM TABLE
C
      IERROR=0
  218 MCORE=0
      NECORE=0
      DO 220 N=1,7
      IF (NE(N).GT.NOELEC) GO TO 221
      NECORE=NE(N)
  220 MCORE=MORB(N)
  221 M=0
      DO 225 N=1,7
      DO 225 LP1=1,N
      IF (MCORE.EQ.M) GO TO 230
      M=M+1
      NNN(M)=N
      L(M)=LP1-1
      I=L(M)+1
C     ENCODE (3,22,NLBCD(M))  NNN(M),LBCD(I)
      WRITE (NLBCD(M),22)  NNN(M),LBCD(I)
   22 FORMAT (I2,A1)
      WWNL(M)=4*LP1-2
      IF (NECORE.EQ.54.AND.N.EQ.4.AND.L(M).EQ.3)  M=M-1
      IF (NECORE.EQ.86.AND.N.EQ.5.AND.L(M).EQ.3)  M=M-1
      IF (NECORE.EQ.86.AND.N.EQ.5.AND.L(M).EQ.4)  M=M-1
      IF (NECORE.EQ.118.AND.N.EQ.5.AND.L(M).EQ.4)  M=M-1
      IF (NECORE.EQ.118.AND.N.EQ.6.AND.L(M).EQ.3)  M=M-1
      IF (NECORE.EQ.118.AND.N.EQ.6.AND.L(M).EQ.4)  M=M-1
      IF (NECORE.EQ.118.AND.N.EQ.6.AND.L(M).EQ.5)  M=M-1
  225 CONTINUE
C
C     DECODE AND STORE N, L, AND OCCUPATION NOS. FOR SUBSHELLS
C          OUTSIDE OF OR WHICH MODIFY THE CORE
C
  230 DO 241 I=1,8
      IF (NLBCD8(I)(1:3).EQ.'   ') GO TO 241
      DO 233 J=1,39
      IF (WWNL8(I).NE.WWWNL(J)) GO TO 233
      WW8=J-1
      IF (J.LT.20) GO TO 234
      WW8=J-20
      IF (J.LT.30) GO TO 234
      WW8=J-30
      GO TO 234
  233 CONTINUE
      WW8=1.D0
  234 IF (M.EQ.0) GO TO 237
      M1=M
      DO 236 J=1,M1
      IF (NLBCD8(I).NE.NLBCD(J)) GO TO 236
      IF (WW8.NE.0.D0.OR.J.LT.N1SCF) GO TO 240
      M=M-1
      IF (J.EQ.M+1) GO TO 241
      DO 235 MP=J,M
      NNN(MP)=NNN(MP+1)
      L(MP)=L(MP+1)
      NLBCD(MP)=NLBCD(MP+1)
  235 WWNL(MP)=WWNL(MP+1)
      GO TO 241
  236 CONTINUE
  237 IF (WW8.EQ.0.D0.AND.M+1.GE.N1SCF) GO TO 241
      M=M+1
      J=M
      NLBCD(M)=NLBCD8(I)
C     DECODE (3,22,NLBCD(M))  NNN(M),LI
      READ (NLBCD(M),22)  NNN(M),LI
      DO 238 III=1,21
      IF (LI.EQ.LBCD(III)) GO TO 239
  238 CONTINUE
      WRITE (9,23)  M,NLBCD(M)
   23 FORMAT (7H0NLBCD(,I2, 4H) = ,A3,
     1  43H WAS NOT FOUND IN TABLE.  NEXT CASE PLEASE.  ///)
      GO TO 310
  239 L(M)=III-1
      IF (III.GT.NNN(M)) GO TO 1241
  240 WWNL(J)=WW8
  241 CONTINUE
      NCSPVS=M
      NCORES=M-1
      IF (M.GT.0) GO TO 242
 1241 WRITE (9,24) IZ,NOELEC,CONF,ALFMIN,ALFMAX, (NLBCD8(M),WWNL8(M),
     1  M=1,8), EE8
   24 FORMAT (55H0NCSPVS = 0  YOU HAVE TROUBLES WITH THE FOLLOWING CASE-
     1  //2(2X,I3),3A6,2F5.2,8(A3,A2),0PF8.5//22H TRY THE NEXT ELEMENT
     2  //1H1  )
      GO TO 310
C
C     ACCUMULATE NO. OF ELECTRONS, ESTIMATE EIGENVALUE FOR EACH ORBITAL
C
  242 WWW=0.
      DO 243 M=1,NCSPVS
      WWW=WWW+WWNL(M)
      IF (M.EQ.NCORES) NCELEC=WWW
      ERAS=NNN(M)-L(M)
  243 A0M(M)=CA0/ERAS
      IF (EE8.GT.0.D0) WWW=NCELEC
      NOELEC=WWW
      NVELEC=NOELEC-NCELEC
      ION=IZ-NOELEC
      TWOION=ION+ION
      ZZZ=ION+1
      TWOZZZ=ZZZ+ZZZ
      N1SC=1
      IF (EEO(NCSPVS).LT.0.D0.OR.EE(NCSPVS).LT.0.D0.OR.EE8.LE.0.D0)
     1  GO TO 265
      IF (IZ.NE.IZO.OR.ION.NE.IONO+1) GO TO 265
      DO 262 M=1,NCSPVS
      IF (M.EQ.NCSPVS) GO TO 262
      IF (NLBCD(M).NE.NLBCDO(M).OR.WWNL(M).NE.WWNLO(M)) GO TO 265
  262 CONTINUE
      N1SC=NCSPVS
      KUT=-1
  265 DO 250 M=1,NCSPVS
      IF (N1SC.GT.1) GO TO 246
      SMSIG=0.D0
      IF (IZ.NE.IZO) GO TO 244
      IF (ION.NE.IONO.AND.M.GE.NCSPVS-2) GO TO 244
      IF (M.GE.NCSPVS) GO TO 244
      IF (NLBCD(M).EQ.NLBCDO(M)) GO TO 246
  244 ERAS=L(M)
      SIG1=0.6D0+0.05D0*ERAS
      DO 245  MP=1,NCSPVS
      ERAS=NNN(M)-NNN(MP)
      SIG=SIG1+0.2D0*ERAS
      IF (SIG.LT.0.D0) GO TO 245
      IF (SIG.GT.1.D0) SIG=1.D0
      WWNLX=WWNL(MP)
      IF (NNN(M).EQ.NNN(MP).AND.L(M).EQ.L(MP)) WWNLX=WWNLX-1.D0
      SMSIG=SMSIG+SIG*WWNLX
  245 CONTINUE
      IF (NNN(M)+L(M).EQ.1.AND.WWNL(M).EQ.2.D0) SMSIG=0.5D0*SMSIG+0.3D0
      EE(M)=-((Z-SMSIG)/FLOAT(NNN(M)))**2
  246 IF (N1SC+N1SCF.GT.2.AND.M.LT.NCSPVS) EE(M)=EEO(M)
      IF (M.EQ.NCSPVS.AND.EE8.GT.0.D0) EE(M)=EE8
      IF (ITPOW.LT.8.OR.N1SC.GT.1) GO TO 250
      WRITE (9,25) M,NNN(M),L(M),WWNL(M),NLBCD(M),WWNL(M),EE(M), SMSIG
   25 FORMAT (4H M =,I2, I3,I2,F3.0,3X,A3,F2.0,F14.5, 9H RYDBERGS, 5X,
     1 38HSCREENING OF ELECTRON IN MTH ORBITAL =  ,F9.5  )
  250 CONTINUE
      IF (ITPOW.LT.8) GO TO 260
      WRITE (9,26) MCORE, NECORE, WWW
   26 FORMAT (8H0MCORE =,I3, 3X,8HNECORE =,I3, 8H   WWW =,F3.0  //  )
  260 DO 268 M=1,NCSPVS
      WWNLO(M)=WWNL(M)
  268 NLBCDO(M)=NLBCD(M)
      M=NCSPVS
      IF (EE(M).NE.0.D0) GO TO 300
      FN=NNN(M)
      EE(M)=-(ZZZ/FN)**2
  300 RETURN
  310 IERROR=7
      RETURN
      END
      SUBROUTINE DIEL
C
C     SUBROUTINE TO CONSTRUCT CONTINUUM CONFIGURATION CARDS FOR
C          RCN/RCG AUTOIONIZATION-PROBLEM RUNS
C
C          TO USE THIS OPTION, MAKE TAPE10=IN36 AN EMPTY FILE, 
C          OR A FILE CONTAINING A SINGLE RECORD WITH "-1" IN COLUMNS 4-5;
C
C          INPUT (IN FILE CALLED TAPE12=INDIEL) CONSISTS OF:
C     (1) RCN36 CONTROL CARD (WITH APPROPRIATE VALUE OF EMX, OR ZERO)
C     (2) ION CONFIG. CARD(S) TO WHICH A CONTINUUM ELECTRON IS TO BE 
C         ADDED (1 TO 5 IN NUMBER)
C     (3) FIRST-PARITY (RADIATIVE-DECAY) CONFIGURATIONS
C     (4) SECOND-PARITY (DOUBLY EXCITED) CONFIGURATION(S)
C          (1 TO 10 IN NUMBER)
C     (5) CARD WITH -1 IN COLUMNS 4-5 (RCN EXIT CARD)
C          FURTHER SETS OF CARDS (2)-(5) MAY BE ADDED AS DESIRED
C
C          ACTION OF SUBROUTINE:
C     (A) FIRST PORTION OF PROGRAM WRITES CONTROL CARD (1) ON
C          TAPE10 (INPUT FILE FOR PRELIMINARY RCN RUN) AND ON
C          TAPE11=IN34 (INPUT FILE FOR FINAL RCN/RCG RUN)
C     (B) STATEMENTS 100-300 COPY CARDS (2) AND (4)-(5) ON TAPE 10
C     (C) RCN IS CALLED TO PROVIDE DATA FOR CALCULATION OF
C          KINETIC ENERGY OF FREE ELECTRON
C     (D) STATEMENTS 410-799 COPY CARDS (3)-(4) ONTO TAPE11 AND
C          ADD CONTINUUM CONFIGURATION CARDS
C     (E) PARTS (B)-(D) ARE REPEATED FOR EACH ADDITIONAL
C          SET OF INPUT DATA CARDS (2)-(5)
C     (F) STATEMENT 800 ADDS THE RCN EXIT CARD TO TAPE11
C
C    FINAL TAPE11 (COPIED TO TAPE10) IS READY TO BE USED DIRECTLY AS
C      INPUT FILE FOR FINAL RCN/RCN2/RCG RUN, EXCEPT FOR THE FOLLOWING
C    (I) IT MAY BE NECESSARY TO REVISE THE VALUE OF EMX ON THE
C      CONTROL CARD IF IT WAS NOT ADEQUATELY ESTIMATED ON INPUT CARD (1)
C    (II) IF THE PARITIES OF CARDS (3)--OR THE PARITIES OF CARDS (4)--
C      WERE NOT THE SAME IN CONTIGUOUS SETS BUT THE VALUES OF Z
C      WERE THE SAME, THEN IT IS NECESSARY TO BREAK TAPE11
C      INTO TWO PIECES, ONE FOR EACH PARITY, BECAUSE OF THE REQUIREMENTS
C      OF RCN2
C      (THIS CAN BE DONE AUTOMATICALLY BY INCLUDING AT THE APPROPRIATE
C      PLACE ON TAPE12 A SINGLE ION CARD OF DIFFERENT Z,
C      PLUS AN RCN EXIT CARD (5). )
C
C
      IMPLICIT REAL*8 (A-H,O-Z)
      CHARACTER*8 IA(10),IB(3),INPCARD*70,IBA,ICARD*80,FORM*42,HIBO*5
      COMMON/CH/IA,IB,INPCARD,IBA
      PARAMETER (KO=20)
      COMMON/D0/CONFG(3),VPAR(45)
      DIMENSION LBCD(21),IWWNL(40)
      DIMENSION LHION(8,10),NION(8,10),IOCHION(8,10),
     1 LION(8,10),IOCCION(8,10),IPARION(10),MIONK(10),EAVION(10),ALF(10)
      COMMON/D3/NATOM(8,10),LATOM(8,10),IOCCATM(8,10),MATMK(10),LA(2)
      DIMENSION MESS(2),NT2(KO),LT2(KO),WT2(KO)
C
      DATA (LBCD(I),I=1,21)/1HS,1HP,1HD,1HF,1HG,1HH,1HI,1HK,1HL,1HM,
     1                      1HN,1HO,1HQ,1HR,1HT,1HU,1HV,1HW,1HX,1HY,1HZ/
      DATA (IWWNL(M),M=1,40) /2H0 ,2H1 ,2H2 ,2H3 ,2H4 ,2H5 ,2H6 ,2H7 ,
     1           2H8 ,2H9 ,2H10,2H11,2H12,2H13,2H14,2H15,
     2           2H16,2H17,2H18,2H 0,2H 1,2H 2,2H 3,2H 4,
     3           2H 5,2H 6,2H 7,2H 8,2H 9,2H00,2H01,2H02,
     4           2H03,2H04,2H05,2H06,2H07,2H08,2H09,2H  /
      DATA ALF/1HA,1HB,1HC,1HD,1HE,1HF,1HG,1HH,1HI,1HJ/
      DATA MESS(1)/1/
      DATA FFF1,FFF2,FFF3/5HF6.4,,5HF6.2,,5HF6.1,/
      DATA HIBO /5HDUMMY/
C
      REWIND 11
      REWIND 10
C          READ RCN CONTROL CARD
      READ (12,10) IA
   10 FORMAT (10A8)
      WRITE (11,10) IA
      WRITE (10,10) IA
      WRITE (9,11) IA
   11 FORMAT (//1H ,10A8)
C          READ ION CONFIGURATION CARD(S)
  100 REWIND 10
      READ (10,10) IA
      IRD=0
      IPARTY0=-7
      I=0
  150 I=I+1
      READ (12,22,END=800) IZ,ISPECT,INPCARD
      IRD=IRD+1
      IF (I.EQ.1) ISP1=ISPECT
      IF (I.EQ.1) IZO=IZ
      IF (I.GT.2.OR.IZ.GT.0) GO TO 160
      ISPECT=IZO-1
      WRITE (11,22) IZO,ISPECT,HIBO
      GO TO 100
  160 IF (ISP1.NE.ISPECT) GO TO 230
      WRITE (10,22) IZ,ISPECT,INPCARD
      WRITE (9,30) IZ,ISPECT,INPCARD
      GO TO 150
C          SELECT SECOND-PARITY CONFIGURATION CARDS
  200 IPARTY0=-7
  220 READ (12,22) IZ,ISPECT,INPCARD
   22 FORMAT (2I5,A70)
      IRD=IRD+1
  230 IF (IZ.LE.0) GO TO 300
  240 IPARITY=0
      CALL ANALYZ1
      DO 280 I=1,8
C     DECODE (5,24,IA(I)) N,L,IOCC
      READ (IA(I),24) N,L,IOCC
   24 FORMAT (I2,A1,A2)
      IF (N.LE.0) GO TO 290
      DO 245 J=1,21
      IF (L.EQ.LBCD(J)) GO TO 250
  245 CONTINUE
  250 L=J-1
      DO 255 M=1,40
      IF (IOCC.EQ.IWWNL(M)) GO TO 260
  255 CONTINUE
  260 IOCC=M-1
      IF (M.GE.20) IOCC=M-20
      IF (M.GE.30) IOCC=M-30
      IF (M.EQ.40) IOCC=1
      IPARITY=IPARITY+L*IOCC
  280 CONTINUE
  290 IPARITY=MOD(IPARITY,2)
      IF (IPARTY0.EQ.-7) IPARTY0=IPARITY
      IF (IPARITY.EQ.IPARTY0) GO TO 220
C
  300 IF (IZ.LT.0) IZ=-999
      WRITE (10,22) IZ,ISPECT,INPCARD
      WRITE (9,30) IZ,ISPECT,INPCARD
   30 FORMAT (1H ,2I5,A70)
      IF (IZ.GT.0) GO TO 220
C
      REWIND 10
C          RUN RCN TO CALCULATE FREE-ELECTRON ENERGIES
      CALL RCN
      REWIND 2
C
      DO 410 I=1,IRD
  410 BACKSPACE 12
C          READ ION CONFIGURATION(S)
      K=0
  420 K=K+1
      READ (12,52) IZ,ISPION,INPCARD
      IF (K.EQ.1) ISP=ISPION
      IF (ISPION.EQ.ISP) GO TO 430
      KION=K-1
      BACKSPACE 12
      GO TO 500
  430 IPARITY=0
      CALL ANALYZ1
      DO 480 I=1,8
C     DECODE (5,54,IA(I)) NION(I,K),LHION(I,K),IOCHION(I,K)
      READ (IA(I),54) NION(I,K),LHION(I,K),IOCHION(I,K)
      IF (NION(I,K).GT.0) MIONK(K)=I
      DO 435 J=1,10
      IF (LHION(I,K).EQ.LBCD(J)) GO TO 450
  435 CONTINUE
      J=1
  450 LION(I,K)=J-1
      DO 455 M=1,40
      IF (IOCHION(I,K).EQ.IWWNL(M)) GO TO 460
  455 CONTINUE
      M=1
  460 IOCC=M-1
      IF (M.GE.20) IOCC=M-20
      IF (M.GE.30) IOCC=M-30
      IF (M.EQ.40) IOCC=1
      IF (NION(I,K).EQ.0) IOCC=0
      IPARITY=IPARITY+LION(I,K)*IOCC
      IOCCION(I,K)=IOCC
  480 CONTINUE
      I=1
  490 IPARION(K)=MOD(IPARITY,2)
      READ (2) NT2,LT2,WT2,NCSPVS,VPAR
      EAVION(K)=VPAR(1)
      GO TO 420
C          COPY BOUND-STATE CONFIGURATIONS
  500 IPARTY0=-7
      K=1
  520 READ (12,52) IZ,ISPECT,INPCARD
   52 FORMAT (2I5,A70)
      IF (IZ.LE.0) GO TO 600
      WRITE (11,52) IZ,ISPECT,INPCARD
      WRITE (9,52) IZ,ISPECT,INPCARD
  540 IPARITY=0
      CALL ANALYZ1
      DO 580 I=1,8
C     DECODE (5,54,IA(I)) N,L,IOCC
      READ (IA(I),54) N,L,IOCC
   54 FORMAT (I2,A1,A2)
      IF (N.LE.0) GO TO 590
      NATOM(I,K)=N
      DO 545 J=1,21
      IF (L.EQ.LBCD(J)) GO TO 550
  545 CONTINUE
      J=1
  550 LATOM(I,K)=J-1
      DO 555 M=1,40
      IF (IOCC.EQ.IWWNL(M)) GO TO 560
  555 CONTINUE
      M=1
  560 IOCC=M-1
      IF (M.GE.20) IOCC=M-20
      IF (M.GE.30) IOCC=M-30
      IF (M.EQ.40) IOCC=1
      IPARITY=IPARITY+LATOM(I,K)*IOCC
      IOCCATM(I,K)=IOCC
  580 CONTINUE
  590 IPARITY=MOD(IPARITY,2)
      IF (IPARTY0.EQ.-7) IPARTY0=IPARITY
      KATM=K
      MATMK(K)=I-1
      IZA=IZ
      ISPA=ISPECT
      IBA=IB(1)
      IF (IPARITY.NE.IPARTY0) K=K+1
      GO TO 520
C          SET UP CONTINUUM CARDS
  600 DO 799 KA=1,KATM
      MATOM=MATMK(KA)
      READ (2) NT2,LT2,WT2,NCSPVS,VPAR
      DO 798 K=1,KION
      MION=MIONK(K)
      EPS=VPAR(1)-EAVION(K)
      IF (EPS.GT.0.D0) GO TO 605
      WRITE (9,60) KA,K,EPS
   60 FORMAT (/' FOR ATOM CONFIG.',I3,' AND ION CONFIG.',
     1  I3,' EPS=',E14.4)
      GO TO 798
  605 JI=0
      DO 649 MI=1,MION
      DO 609 MA=1,MATOM
      IF (NION(MI,K).NE.NATOM(MA,KA).OR.LION(MI,K).NE.LATOM(MA,KA))
     1  GO TO 609
      IF (IOCCION(MI,K).LE.IOCCATM(MA,KA)) GO TO 649
  609 CONTINUE
  610 JI=JI+1
      IF (JI.EQ.1) GO TO 620
      J=1
      MA=8
      WRITE (9,61) J,MI,MA
   61 FORMAT (11H0*****ERROR,I1,2I5/)
      GO TO 798
  620 LI1=LION(MI,K)
  649 CONTINUE
      JA=0
      DO 699 MA=1,MATOM
      IOCCA=IOCCATM(MA,KA)
      DO 659 MI=1,MION
      IF (NION(MI,K).NE.NATOM(MA,KA).OR.LION(MI,K).NE.LATOM(MA,KA))
     1  GO TO 659
      IF (IOCCION(MI,K).GE.IOCCA) GO TO 699
      GO TO 680
  659 CONTINUE
      MI=8
  680 JA=JA+1
      IF (JA.LE.2) GO TO 685
      J=2
      MI=8
      WRITE (9,61) J,MI,MA
      GO TO 798
  685 LA(JA)=LATOM(MA,KA)
      IOCCA=IOCCA-1
      WRITE (9,9685) MA,MI,K,JA,LA(JA),IOCCA,IOCCION(MI,K)
 9685 FORMAT (10I5)
      IF (IOCCA.GT.IOCCION(MI,K)) GO TO 680
  699 CONTINUE
C
  700 K1=IABS(LA(1)-LA(2))
      K2=LA(1)+LA(2)
      LCONTX=LI1+K2
      LCONTN=MOD(LCONTX,2)
  702 IF (IABS(LI1-LCONTN).LE.K2.AND.LI1+LCONTN.GE.K1) GO TO 703
      LCONTN=LCONTN+2
      GO TO 702
  703 CONTINUE
      WRITE (9,9705) K,LA,LI1,K1,K2,LCONTN,LCONTX
 9705 FORMAT (10I5)
      FFF=FFF2
      IF (EPS.GT.999.D0) FFF=FFF3
      IF (EPS.LT.9.99D0) FFF=FFF1
      MP1=MION+1
      MX=42-5*MP1
C     ENCODE (42,71,FORM) FFF,MP1,FFF
      WRITE (FORM,71) FFF,MP1,FFF
   71 FORMAT (11H(2I5,A5,A1,,A5,6HA1,9X,,I1,11H(I2,A1,A2),,3H3X,,A4,1H))
      KK=99
      IF (LCONTX.GT.9) LCONTX=9
      IF (LCONTX.LT.LCONTN) GO TO 798
      DO 720 L=LCONTN,LCONTX,2
      LH=LBCD(L+1)
      WRITE (11,FORM) IZA,ISPA,IBA,ALF(K),EPS,LH, (NION(I,K),
     1  LHION(I,K),IOCHION(I,K), I=1,MION), KK,LH,IWWNL(40),EPS
  720 WRITE (9,FORM) IZA,ISPA,IBA,ALF(K),EPS,LH, (NION(I,K),
     1  LHION(I,K),IOCHION(I,K), I=1,MION), KK,LH,IWWNL(40),EPS
  798 CONTINUE
  799 CONTINUE
      GO TO 100
C
  800 WRITE (11,80)
   80 FORMAT (3X,2H-1,10X)
      REWIND 11
      REWIND 10
  850 READ (11,81,END=900) ICARD
   81 FORMAT (A)
      WRITE (10,82) ICARD
   82 FORMAT (A80)
      GO TO 850
  900 REWIND 10
      REWIND 9
      RETURN
      END
      SUBROUTINE ANALYZ1
C
      IMPLICIT REAL*8 (A-H,O-Z)
      CHARACTER*8 IA(10),IB(3),INPCARD*70,IBA
      COMMON/CH/IA,IB,INPCARD,IBA
      CHARACTER CHTEMP*70,LBCD(21)*1
C
      DATA LBCD/'S','P','D','F','G','H','I','K','L','M',
     1          'N','O','Q','R','T','U','V','W','X','Y','Z'/
C
      I=6
  110 NBL=0
  112 I=I+1
      IF (INPCARD(I:I).NE.' ') GO TO 110
      NBL=NBL+1
      IF (NBL.GE.3.OR.I.GE.18) GO TO 120
      GO TO 112
C          CONFIGURATION IDENTIFICATION
  120 CHTEMP=' '
      I=MIN0(I,18)
      CHTEMP(1:I)=INPCARD(1:I)
      READ (CHTEMP,12) IB
   12 FORMAT (3A8)
C
      I3=I
      KUT=0
      EE8=0.D0
      NALF=0
      ALFMIN=0.D0
      ALFMAX=0.D0
      NORB=0
      DO 125 J=1,10
  125 IA(J)='          '
C
C
  130 I=I3
      I1=0
      I2=0
      I3=0
      IDEC=0
      INEG=0
      CHTEMP=' '
C
  132 I=I+1
      IF (I.GT.70) GO TO 900
      IF (INPCARD(I:I).NE.' ') GO TO 134
      IF (I3.NE.0) GO TO 150
      GO TO 132
  134 IF (I1.EQ.0) I1=I
      IF (I2.GT.0) GO TO 138
      DO 136 J=1,20
      IF (INPCARD(I:I).EQ.LBCD(J)) I2=I
  136 CONTINUE
      IF (INPCARD(I:I).EQ.'.') IDEC=I
      IF (INPCARD(I:I).EQ.'-') INEG=I
  138 I3=I
      IF (I.LT.70.OR.I1.EQ.0) GO TO 132
C
  150 CHTEMP=' '
      IF (I2.NE.0.AND.I1.GE.I2-2) GO TO 300
      IF (NORB.EQ.0.AND.NALF.EQ.0.AND.I3.GT.I1.AND.INEG.EQ.0) GO TO 200
      IF (IDEC.GT.0) GO TO 500
      IF (INEG.GT.0.OR.I1.EQ.I3) GO TO 400
      GO TO 500
C          ALFMAX AND (IF I3-I1.GT.1) ALFMIN
  200 IF (I2.GT.0) I3=I2-3
      CHTEMP(I1-I3+4:4)=INPCARD(I1:I3)
      READ (CHTEMP,20) IALFMIN,IALFMAX
   20 FORMAT (2I2)
      ALFMIN=0.01D0*IALFMIN
      ALFMAX=0.01D0*IALFMAX
      NALF=1
      GO TO 130
C          ORBITAL
  300 I3=MIN0(I3,I2+2)
      CHTEMP(3+I1-I2:5)=INPCARD(I1:I3)
      NORB=NORB+1
      READ (CHTEMP,30) IA(NORB)
   30 FORMAT (A5)
      GO TO 130
C          KUT
  400 CHTEMP(1:2)=INPCARD(I3-1:I3)
      READ (CHTEMP,40) KUT
   40 FORMAT (I2)
      GO TO 130
C          EE8
  500 CHTEMP=INPCARD(I1:I3)
      READ (CHTEMP,50) EE8
   50 FORMAT (F70.3)
      GO TO 130
C
  900 CONTINUE
      WRITE (9,90) INPCARD
   90 FORMAT (/3X,A70)
      WRITE (9,91) IB,ALFMIN,ALFMAX,(IA(M),M=1,8),KUT,EE8
   91 FORMAT (1X,2A8,A2,2F3.1,8A5,I2,F6.2)
      RETURN
      END
      SUBROUTINE SCHEQ
C
C     COMPUTE ENERGY EIGENVALUE AND WAVE FUNCTION
C      ORIGINALLY  WRITTEN BY SHERWOOD SKILLMAN
C      RCA LABORATORIES, PRINCETON, NEW JERSEY, SPRING 1961
C      MODIFIED BY FRANK HERMAN, SUMMER 1961
C      FURTHER MODIFIED BY RICHARD KORTUM,  LOCKHEED RESEARCH
C       LABORATORIES, PALO ALTO, CALIFORNIA,  SUMMER 1962
C      FURTHER MODIFIED BY R. D. COWAN, LASL, JAN-FEB, 1964
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      COMMON XI(KMSH),XJ(KMSH),V(KMSH),RSCORE(KMSH),RSVALE(KMSH),
     1  RECORR(KMSH),RUCORR(KMSH),RC(KMSH),PNLO(KMSH),X1(KMSH),X2(KMSH)
C
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,KM3(KO)
      COMMON/C3/NPAR,NZI,NFIJ,NGIJ,VPRM(50),KPAR(50),ZI(8),FIJ(30),
     1  GIJ(35),NORB,NORBPT,DH(5),DELTA,NPR
      COMMON/C4/VR(KMSH),QQ0(KMSH),IREL,NITER,NN,LAM,E,END,NODF,I,J,K,
     1  MM,IMATCH,RSINT,RSINT1,HXID,IZHXBW,IPHFWF,IHF,IHF1,NPRINT
      COMMON/C5/IZO,IONO,LBCD(21),MORB(7),IBLANK,WWWNL(39),EEO(KO),
     1  WWNL8(8),EE8,NOELEC,IERROR,WWNLO(KO),N1SC,N1SCF
      COMMON/C6/A0,A1,A2,A3,A4,AB1,AB3,B0,B1,B2,B3,ERAS,ERAS1,ERAS2
      COMMON PNL(KMSH,KO),QNL(KMSHQ,KOQ)
C
      DIMENSION RSQ(KMSH),QQ(KMSH),DELP(KO),ALFM(KO),
     1  S1(10,KO),S2(10,KO),ZETA(KO,3)
      EQUIVALENCE (RU,      F1), (RUEE,  F2), (RUEXCH,RSQ,XA,EMN),
     1  (RSATOM,QQ,DRUDR,XB), (A,DELP,RRYD), (B,ALFM,RKAY)
      EQUIVALENCE (RSATOM,S1),(RSATOM(251),S2),(RSATOM(501),ZETA)
C
      DIMENSION P(5),D(5),Q(5),T(5)
      INTEGER WWWNL,WWNL8
C
C
C
C     SET UP CONSTANTS AND INITIALIZE
C
      ERASX=0.D0
  100 MANY=99
      EMORE=-1.D-10
      ELESS=-1.D12
      EG=0.D0
      DE=0.D0
      NPRINT=0
      IMATCH=0
      LAMM=LAM-1
      LAMP=LAM+1
      XLP=LAMP
      NDCR=NN-LAMP
      IF (NN.GT.98) NDCR=9999
      B0=LAM*LAMP
      H=R(2)
      H1=H*H
      B3=(V(3)-V(2))/H-Z/H1
      Y=H+H
      FLPS=4*LAM+6
      SLPT=6*LAM+12
      ELPT=8*LAM+20
      A1=-Z/XLP
      YSQ=Y*Y
      B1=-Z-Z
      AB1=A1*B1
      AB3=A1*B3
C
C     RAISE H AND Y TO LAM+1
C
      HTL=H
      YTL=Y
      IF (LAM) 210,140,120
  120 DO 130 I=1,LAM
      HTL=HTL*H
  130 YTL=YTL*Y
  140 BOHS=B0/H1
      BOH=B1/H
      BTH=B3*H
      BQ3=BOHS+BOH+BTH
      BQ4=BOHS/4.D0+BOH/2.D0+BTH+BTH
  150 IF ((NITER.EQ.1.AND.N1SC.EQ.1).OR.IREL.EQ.0) GO TO 200
      IF (LAM.NE.0) GO TO 200
C          CALC DARWIN RELATIVISTIC TERM
      KKK=NKKK(MM)
      NBLK=KKK/40
      I=2
      K1=2
      K2=40
      DO 160 J=1,NBLK
      IF (J.EQ.NBLK) K2=39
      ERAS=0.5D0/(R(I+1)-R(I))
      DO 155 K=K1,K2
      I=I+1
      ERAS1=ERAS*(PNL(I+1,MM)-PNL(I-1,MM))
      ERAS1=ERAS1/PNL(I,MM)-1.D0/R(I)
  155 VR(I)=ERAS1*ERAS*(X2(I+1)-X2(I-1))
      K1=1
      IF (I.GT.IDB.OR.J.EQ.NBLK) GO TO 160
      ERAS=0.5D0*ERAS
      ERAS1=ERAS*(PNL(I+1,MM)-PNL(I-2,MM))
      ERAS1=ERAS1/PNL(I,MM)-1.D0/R(I)
      VR(I)=ERAS1*ERAS*(X2(I+1)-X2(I-2))
  160 CONTINUE
      VR(2)=4.D0*VR(3)
      VR(MESH)=VR(MESH-1)
      IF (IPTVU.GE.6.AND.MOD(NITER-2,5).EQ.0)
     1  WRITE (9,7788) NN,LAM,ERAS, (VR(K), K=2,47)
 7788 FORMAT (2I10/(1P,8E15.5))
      IF (IREL.NE.3) GO TO 200
      ERAS=1.D0/(12.D0*(R(2)-R(1)))
      DO 165 I=4,39
      ERAS1=ERAS*(8.D0*(PNL(I+1,MM)-PNL(I-1,MM))-PNL(I+2,MM)+
     1  PNL(I-2,MM))
      ERAS1=ERAS1/PNL(I,MM)-1.D0/R(I)
  165 VR(I)=ERAS1*ERAS*(8.D0*(X2(I+1)-X2(I-1))-X2(I+2)+X2(I-2))
      ERAS1=DLOG(VR(4)/VR(5))/DLOG(R(5)/R(4))
      VR(3)=VR(4)*((R(4)/R(3))**ERAS1)
      VR(2)=VR(4)*((R(4)/R(2))**ERAS1)
      VR(MESH)=VR(MESH-1)
      IF (IPTVU.GE.5.AND.MOD(NITER-2,5).EQ.0)
     1  WRITE (9,7788) NN,LAM,ERAS, (VR(K), K=2,47)
C
C     START OUTWARD INTEGRATION
C
  200 NPRINT=NPRINT+1
      J=IABS(NPR)
      IF (J.EQ.0.OR.J.GT.9) GO TO 880
      IF (MOD(NPRINT,J).NE.0) GO TO 880
C     IF (MM.LT.NCSPVS-2) GO TO 880
      WRITE (9,17) NITER,NPRINT,NN,LAM,IK,IMATCH,KKK,NCROSS,
     1  DE,EG,EMORE,ELESS
   17 FORMAT (//3I3,I1,4I5,4F10.6)
      WRITE (9,18) (QQ(J),J=201,KKK,10)
   18 FORMAT (1X,10F12.4)
      WRITE (9,19) (PNLO(J),J=201,KKK,10)
   19 FORMAT (1X,10F12.7)
  880 CONTINUE
      EPS =E-EG
      EG =E
      IF (NPRINT-MANY) 220,220,201
  201 WRITE (9,20) NN,LAM,NPRINT,ELESS,EMORE,E, DE,NCROSS,IMATCH,I,IK,
     1  IKMAX, (PNLO(J), J=1,MESH,2)
   20 FORMAT (18H NO CONVERGENCE ON,I4,I1,I4,4F17.8,5I4//
     1  (3X,1P,10E11.3))
      IF (DABS(DE/E)-8.D0*THRESH) 900,205,205
  205 END=1.D0
      GO TO 990
  210 NSTOP=210
  211 WRITE (9,21)NSTOP
   21 FORMAT(5H0STOP,I4,9H IN SCHEQ)
      STOP 210
  220 DO 221 I=1,MESH
  221 PNLO(I)=0.D0
C
C     CALC QQ.    IF E NEG, MAKE CERTAIN THAT QQ(MESH) IS POSITIVE,
C         AND THAT QQ(I) IS NEGATIVE FOR SOME I LESS THAN IKMAX
C
      N2BG=NPRINT+NN
      IF (NPRINT-1) 210,230,235
  230 DO 231 I=1,MESH
  231 QQ(I) = V(I)+B0/(R(I)*R(I))-E
      IF ((NITER.EQ.1.AND.N1SC.EQ.1).OR.IREL.EQ.0) GO TO 233
C          CALC MASS-VELOCITY RELATIVISTIC TERM
      ERAS=(0.5D0/137.036D0)**2
      DO 232 I=2,KKK
      ERAS1=E-V(I)
      ERAS2=ERAS*ERAS1
      QQ0(I)=QQ(I)
      ERAS3=ERAS1*ERAS2
      IF (LAM.EQ.0) ERAS3=ERAS3+ERAS*VR(I)/(1.D0+ERAS2)
  232 QQ(I)=QQ(I)-ERAS3
      IF (NITER.NE.8.OR.IREL.LT.4) GO TO 233
      WRITE(9,22) NITER,NPRINT,MM,B0,E
   22 FORMAT (1H1,3I5,2F17.7//)
      WRITE(9,23)(I,R(I),V(I),VR(I),QQ0(I),QQ(I),PNL(I,MM), I=11,KKK,10)
   23 FORMAT (I5,6F18.7)
  233 IK=MESH+1
      IF (E) 240,240,250
  235 DO 236 I=1,MESH
  236 QQ(I) = QQ(I)-EPS
      IF (NPRINT-20) 240,240,237
  237 IF (DABS(EPS/E)-0.00001D0) 250,250,240
  240 M=MESH
      IK=M+1
      DO 246 I=10,MESH
      IF (QQ(M)) 245,246,246
  245 IK=M+20
      GO TO 247
  246 M=M-1
      EPS=-0.3D0*E
      GO TO 248
  247 IKMAX=MESH-MIN0( 60, 6000/(NPRINT+NN)**2 )
      IF (IK.LE.IKMAX+5) GO TO 250
      MESH=MESH
      EPS=DMIN1(QQ(IKMAX-10),QQ(MESH)-0.000001D0)
  248 E=E+EPS
      EG=E
      N2BG=N2BG+1
      IF (N2BG.LE.22) GO TO 235
      IF (NPRINT.LT.MANY) GO TO 250
      WRITE (9,24) NN,LAM, (QQ(I), I=201,MESH)
   24 FORMAT (//2I3//(5X,10F11.5))
C
C          CALC STARTING VALUES FOR IREL=0
C     B0=LAM*(LAM+1)
C     B1= -2.*Z
C     B3=(V(3)-V(2))/H -Z/HSQ
C     A1= -Z/(LAM+1)
C     A2=(A1*B1+B2)/(4*LAM+6)
C     A3=(A2*B1+A1*B2+B3)/(6*LAM+12)
C     A4=(A3*B1+A2*B2+A1*B3)/(8*LAM+20)
C     P(3)=(1.0+A1*H+A2*H**2+A3*H**3+A4*H**4)*H**(XL+1.0)
C     P(4)=(1.0+A1*Y+A2*Y**2+A3*Y**3+A4*Y**4)*Y**(XL+1.0)
C     Q(3)=(B+B1*H+B2*H**2+B3*H**3)/H**2
C     Q(4)=(B+B1*Y+B2*Y**2+B3*Y**3)/Y**2
C
  250 H=R(2)
      Y=H+H
      B2=3.D0*Z/H-E+2.D0*V(2)-V(3)
      A2=(AB1+B2)/FLPS
      A3=(A2*B1+A1*B2+B3)/SLPT
      A4=(A3*B1+A2*B2+AB3)/ELPT
      P(3)=(1.D0+H*(A1+H*(A2+H*(A3+H*A4))))*HTL
      P(4)=(1.D0+Y*(A1+Y*(A2+Y*(A3+Y*A4))))*YTL
      P(5)=0.D0
      Q(3)=BQ3+B2
      Q(4)=BQ4+B2
      I=3
      DX=H
      H1=H**2
      H2=H1/12.D0
      IF (IREL.EQ.0) GO TO 255
C          CALC STARTING VALUES FOR IREL.NE.0 (RELATIVISTIC TERMS INCLUD
      Q(3)=QQ(2)
      Q(4)=QQ(3)
      ERAS1=(Z/137.036D0)**2
      D2=1.D0/(1.D0+(274.072D0**2+E)*R(3)*0.5D0/Z)
      IF (LAM.NE.0) D2=0.D0
      ERAS=0.5D0*(1.D0-D2)+DSQRT(B0+0.25D0*((1.D0+D2)**2)-ERAS1)
      P(3)=R(2)**ERAS
      P(4)=R(3)**ERAS
      ERAS2=ERAS+1.D0+D2
      A1=-(2.D0*Z+ERAS1*E/Z)/(ERAS2*ERAS-B0+ERAS1)
      P(3)=P(3)*(1.D0+A1*R(2))
      P(4)=P(4)*(1.D0+A1*R(3))
C
  255 PNLO(2)=P(3)
      PNLO(3)=P(4)
      T(3)=P(3)*(1.D0-H2*QQ(2))
      T(4)=P(4)*(1.D0-H2*QQ(3))
      D(4)=T(4)-T(3)
      NCOUNT=2
      NINT=2
      IF (NPRINT-40) 280,260,260
  260 WRITE (9,26) NN,LAM,NITER,NPRINT,IKMAX,IK,IMATCH,NCROSS,E,EPS,
     1  ELESS,EMORE,ALFM(MM),DELTA
   26 FORMAT (1H ,I2,I1,6I6,4F19.11,F6.3,F10.6)
  280 NCROSS=0
      IB1=IB+1
      PTTHREE=0.3D0
C
C          INTEGRATE OUTWARD
C
  300 I=I+1
      IF (I.LT.IB1) GO TO 310
      IF (E.GE.0.D0) GO TO 960
      IF (NCROSS-NDCR) 370,303,360
  303 IF (IK-IB1) 370,850,850
C
  310 Q(5)=QQ(I)
      IF (DABS(P(5)).GT.1.D30) GO TO 312
      IF (I.LT.IK) GO TO 314
  312 IF (NCOUNT.GT.1) GO TO 314
      IF (NINT.GT.4) GO TO 350
  314 D(5)=D(4)+H1*Q(4)*P(4)
      T(5)=D(5)+T(4)
      ERAS=H2*Q(5)
      IF (DABS(ERAS).GT.DABS(ERASX)) ERASX=ERAS
      IF (DABS(ERAS).GT.PTTHREE) ERAS=SIGN(PTTHREE,ERAS)
  315 P(5)=T(5)/(1.D0-ERAS)
      PNLO(I)=P(5)
      IF (P(5).GT.0.D0.AND.P(4).GT.0.D0) GO TO 331
      IF (P(5).LT.0.D0.AND.P(4).LT.0.D0) GO TO 331
      IF (P(5).EQ.0.D0) GO TO 331
C          COUNT CHANGES IN SIGN
  330 NCROSS=NCROSS+1
  331 NCOUNT=NCOUNT+1
      IF (NCOUNT.EQ.6) NCOUNT=1
      NINT=NINT+1
      IF (I.GT.IDB) GO TO 341
      IF (NINT.LT.40) GO TO 341
  340 DX=DX+DX
      H=DX
      H1=H**2
      H2=H1/12.D0
      NINT=0
      T(5)=P(5)*(1.D0-H2*Q(5))
      T(3)=P(3)*(1.D0-H2*Q(3))
      D(5)=T(5)-T(3)
  341 DO 342 K=1,4
      P(K)=P(K+1)
      T(K)=T(K+1)
      D(K)=D(K+1)
  342 Q(K)=Q(K+1)
      GO TO 300
C
C     MATCHING RADIUS HAS BEEN REACHED GOING OUT
C
  350 IF (NCROSS-NDCR) 370,380,360
C          TOO MANY CROSSINGS, INCREASE ABSF(E)
  360 EMORE=DMIN1(EMORE,E)
      E=DMAX1(2.D0*E,0.5D0*(ELESS+EMORE))
      GO TO 200
C          TOO FEW CROSSINGS, DECREASE ABSF(E)
  370 ELESS=DMAX1(ELESS,E)
      DE=EMORE-ELESS
      IF (DE.LT.0.0001D0) EMORE=EMORE+0.1D0*DE
      IF (EMORE.GE.0.D0) EMORE=-1.D-8
      E=DMIN1(0.5D0*E,0.5D0*(ELESS+EMORE))
      GO TO 200
C
C     NUMBER OF CROSSINGS IS CORRECT
C     CHECK TO SEE THAT WAVE IS IN THE DAMPED REGION (ABSOLUTE VALUE
C       DECREASING AND SIGNS ALIKE)
C
  380 IF (DABS(PNLO(I-1))-DABS(PNLO(I-2))) 382,381,381
C     LARGE ABSOLUTE VALUE OF P IN WHAT SHOULD BE THE DAMPED REGION
C       INDICATES TOO FEW PEAKS, DECREASE ABSF(E)
  381 IF (DABS(P(5))-1.D5) 314,370,370
C
  382 IF (P(5)) 383,314,384
  383 IF (PNLO(I-2)) 400,314,314
  384 IF (PNLO(I-2)) 314,314,400
C
C     NOW NDCR = NCROSS AND MATCHING RADIUS LIES IN DAMPED REGION
C         CALCULATE LOGARITHMIC DERIVATIVE
C
  400 IMATCH=I-2
      XMATCH=R(I-2)
      PPOUT=(T(4)-T(2)-0.5*(P(4)-P(2)))/H
      S6=PPOUT/P(3)
C
C  INTEGRATE PNLO**2
C
      CALL QUAD5(PNLO,2,1,IMATCH,SUM1)
C
      S5=SUM1/P(3)**2
      PMATCH=P(3)
C
C          START INWARD INTEGRATION
C
C       CHOOSE OUTERMOST MESH POINT, KKK
  500 XINW=10.D0*XMATCH
  510 DO 511 I=41,MESH,40
      IF (R(I).GE.XINW) GO TO 512
  511 CONTINUE
      KKK=MESH
      GO TO 550
  512 KKK=I
C       CALC STARTING VALUES
  550 I=KKK
      DX=R(I)-R(I-1)
      H=-DX
      H1=H*H
      H2=H1/12.D0
      Q(3)=QQ(I)
      ERAS1=DSQRT(Q(3))
      ERAS2=R(I)*ERAS1
      P(3)=DEXP(-ERAS2)
      I=I-1
      Q(4)=QQ(I)
      ERAS3=R(I)*DSQRT(Q(4))
      P(4)=DEXP(-ERAS3)
      IF (DABS(P(4)).GT.1.D-35) GO TO 580
      KKK=KKK-40
      IF (KKK.GT.IMATCH) GO TO 550
  570 WRITE (9,57)Z,NN,LAM,KKK,IMATCH
   57 FORMAT (6H0AT Z=,F6.0,6H   NL=,I3,I1,10H,     KKK=,I3,
     1    22H  IS LESS THAN IMATCH=,I3,
     2    48H.    INWARD INTEGRATION WILL BE TRIED AT KKK+40.)
      KKK=KKK+40
      P(3)=1.D-35
      P(4)=P(3)*DEXP(ERAS2-ERAS3)
  580 IF (PMATCH.GT.0.D0) GO TO 582
      P(3)=-P(3)
      P(4)=-P(4)
  582 PNLO(I+1)=P(3)
      PNLO(I)=P(4)
      T(3)=P(3)*(1.D0-H2*Q(3))
      T(4)=P(4)*(1.D0-H2*Q(4))
      D(4)=T(4)-T(3)
      SUM3=P(3)*P(3)/(2.D0*ERAS1)
C
C          INTEGRATE INWARD
C
      M2=KKK-IDB
      IF (M2.LT.40) M2=40
  600 DO 620 M=2,M2
      I=I-1
      Q(5)=QQ(I)
      D(5)=H1*Q(4)*P(4)+D(4)
      T(5)=D(5)+T(4)
      P(5)=T(5)/(1.D0-H2*Q(5))
      IF (I.EQ.IMATCH-1) GO TO 700
      PNLO(I)=P(5)
      DO 620 K=1,4
      P(K)=P(K+1)
      T(K)=T(K+1)
      D(K)=D(K+1)
  620 Q(K)=Q(K+1)
      M2=40
      Q(5)=QQ(I-2)
      D(5)=H1*Q(4)*P(4)+D(4)
      T(5)=D(5)+T(4)
      P(5)=T(5)/(1.D0-H2*Q(5))
      P(5)=1.09375D0*P(4)+0.2734375D0*P(5)-0.546875D0*P(3)
     1     +0.21875D0*P(2)-0.0390625D0*P(1)
      I=I-1
      DX=DX/2.D0
      Q(5)=QQ(I)
      H=-DX
      H1=H*H
      H2=H1/12.D0
      T(5)=P(5)*(1.D0-H2*Q(5))
      T(4)=P(4)*(1.D0-H2*Q(4))
      D(5)=T(5)-T(4)
      PNLO(I)=P(5)
      DO 630 L1=1,4
      P(L1)=P(L1+1)
      T(L1)=T(L1+1)
      D(L1)=D(L1+1)
  630 Q(L1)=Q(L1+1)
      GO TO 600
C
C     MATCHING RADIUS HAS BEEN REACHED COMING IN
C            INTEGRATE PNLO**2 AND CALC LOGARITHMIC DERIVATIVE
C
  700 K=KKK
      CALL QUAD5(PNLO,2,IMATCH,KKK,SUM4)
      SUM3=SUM3+SUM4
  760 S3=SUM3/P(4)**2
      PPIN=(T(5)-T(3)-0.5D0*(P(5)-P(3)))/H
      S4=PPIN/P(4)
C
C     IMPROVE TRIAL EIGENVALUE BY PERTURBATION THEORY IF NECESSARY
C
  800 DE=(S6-S4)/(S5+S3)
      IF (DE) 801,900,802
  801 EMORE=DMIN1(EMORE,E)
      DE=DMAX1(DE,0.8D0*(ELESS-E))
      GO TO 805
  802 ELESS=DMAX1(ELESS,E)
      DE=DMIN1(DE,0.8D0*(EMORE-E))
  805 E=E+DE
      IF (DABS(DE/E).GT.THRESH) GO TO 200
      IF (KKK.EQ.IB) GO TO 912
      GO TO 900
C
C     IMPROVE TRIAL EIGENVALUE FOR FINITE-BOUNDARY CASE
C
  850 KKK=IB
      PPOUT=(PNLO(KKK+1)-PNLO(KKK-1))/(R(KKK+1)-R(KKK-1))
      IF (MOD(KKK-1,40).NE.0) GO TO 860
      PPOUT=0.5*(PPOUT+(PNLO(KKK)-PNLO(KKK-1))/(R(KKK)-R(KKK-1)))
  860 CALL QUAD5(PNLO,2,1,KKK,SUM1)
      S6=PPOUT/PNLO(KKK)
      S5=SUM1/PNLO(KKK)**2
      S4=1.D0/R(KKK)
      S3=0.D0
      GO TO 800
C
C     DETERMINE NORMALIZATION CONSTANT FOR BOUND WAVEFUNCTION
C
  900 POP=PMATCH/P(4)
      KKK=MIN0(KKK,IB)
      DO 910 J=IMATCH,KKK
  910 PNLO(J)=PNLO(J)*POP
  912 CALL QUAD5(PNLO,2,1,KKK,SUM1)
  950 C1=DSQRT(SUM1)
      IF (PNLO(3).GT.0.D0) GO TO 980
      C1=-C1
      GO TO 980
C
C     DETERMINE NORMALIZATION CONSTANT FOR UNBOUND WAVEFUNCTION
C  ( PMAX=1.D0/DSQRT(PI*DSQRT(E)) )
C
  960 I=I-1
      NMIN=I
  962 I=I-1
      INMIN=I
      IF (PNLO(I+1).EQ.0.0) GO TO 962
      IF (PNLO(I)/PNLO(I+1).LT.1.0) GO TO 962
  964 I=I-1
      IF (PNLO(I)/PNLO(I+1).GT.1.0) GO TO 964
  972 A1=(PNLO(I)-PNLO(I+1))/(R(I)-R(I+1))
      B1=(PNLO(I+1)-PNLO(I+2))/(R(I+1)-R(I+2))
      A1=(A1-B1)/(R(I)-R(I+2))
      B1=B1-A1*(R(I+1)+R(I+2))
      C1=PNLO(I+1)-R(I+1)*(A1*R(I+1)+B1)
      C1=DABS(C1-B1*B1/4.D0/A1)
      ZST=ZZZ-1.D0+1.D-7
      A1=0.5D0*ZST/(E*R(I+1))
      B0=LAM*LAMP
      B1=1.D0-B0/(2.D0*ZST*R(I+1))-2.5D0*A1
      F=1.D0-A1*B1
      IF ((KUT.EQ.-1.AND.DELTA.LT.(20.D0*TOLEND)).AND.DABS(DELP(MM)).
     1  LT.4.D-6) WRITE (9,97) ZST,E,R(I+1),A1,B1,F,I,INMIN,NMIN
   97 FORMAT (1H0,9X,23H*****ZST,E,R,A1,B1,F,I=,3F13.6,3F13.8,3I7)
      C1=C1/F
      C1=C1*DSQRT(3.141592654D0*DSQRT(E))
      KKK=MESH
      IMATCH=I+1
C
C     CALCULATE THE NORMALIZED WAVE FUNCTION
C
  980 J=1
      IF (MOD(NITER,5).EQ.0.AND.IREL.GT.3) WRITE (9,9872) M,LAM,ERASX
 9872 FORMAT (10X,2I6,6HERASX=,F10.6)
      K=2
      C1=1.D0/C1
      DO 985 I=1,KKK
      IF (PNLO(J)*PNLO(J+1).GE.0.D0) GO TO 984
      IF (K.GE.NODF) GO TO 985
      K=K+1
  984 J=J+1
  985 PNLO(I)=PNLO(I)*C1
      IF (NITER.NE.17.OR.NN.GT.2) GO TO 8790
      IF (IREL.NE.3) GO TO 8790
      QQ0(1)=0.D0
      QQ(1)=0.D0
      DO 8787 I=2,360
      ERAS=PNLO(I-1)
      IF (MOD(I-1,40).EQ.0) ERAS=PNLO(I-2)
      ERAS=PNLO(I+1)-2.D0*PNLO(I)+ERAS
      QQ0(I)=ERAS/(R(I+1)-R(I))**2
 8787 QQ(I)=QQ(I)*PNLO(I)
      WRITE (9,8788)
 8788 FORMAT (1H1)
      WRITE (9,8786) (I,PNLO(I),QQ0(I),QQ(I), I=1,51)
 8786 FORMAT (3(I4,F11.7,2F14.2))
 8790 CONTINUE
      IF (NODF.GT.1) GO TO 990
      J=1
  990 RETURN
      END
      SUBROUTINE OUTPT
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      CHARACTER*8 NLBCD(KO),NLBCDO(KO),NLBCD8(KO),IFG(10,9),JFG(10,9),
     1  NLA,NLB
      CHARACTER CONF(3)*6,INPCARD*70
      COMMON/CHAR/CONF,NLBCD,NLBCDO,NLBCD8,IFG,JFG,NLA,NLB,INPCARD
      COMMON XI(KMSH),XJ(KMSH),V(KMSH),RSCORE(KMSH),RSVALE(KMSH),
     1  RECORR(KMSH),RUCORR(KMSH),RC(KMSH),PNLO(KMSH),X1(KMSH),X2(KMSH)
C
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
      COMMON/C3/NPAR,NZI,NFIJ,NGIJ,VPRM(50),KPAR(50),ZI(8),FIJ(30),
     1  GIJ(35),NORB,NORBPT,DH(5),DELTA,NPR
      COMMON/C4/VR(KMSH),QQ0(KMSH),IREL,NITER,NN,LAM,E,END,NODF,I,J,K,
     1  MM,IMATCH,RSINT,RSINT1,HXID,IZHXBW,IPHFWF,IHF,IHF1,NPRINT
      COMMON/C5/IZO,IONO,LBCD(21),MORB(7),IBLANK,WWWNL(39),EEO(KO),
     1  WWNL8(8),EE8,NOELEC,IERROR,WWNLO(KO),N1SC,N1SCF
      COMMON/C6/A0,A1,A2,A3,A4,AB1,AB3,B0,B1,B2,B3,ERAS,ERAS1,ERAS2
      COMMON/C8/NHFTRM,NFG,ETOTRL,EHF(KO),T1HF(9),T2HF(9),ETERM,
     1  NF(9),NG(9),CFG(10,9),FG(10,9),KFG(10,9),RHFMTC(KO),II
      COMMON PNL(KMSH,KO),QNL(KMSHQ,KOQ)
C
      DIMENSION RSQ(KMSH),QQ(KMSH),DELP(KO),ALFM(KO),
     1  S1(10,KO),S2(10,KO),ZETA(KO,3)
      EQUIVALENCE (RU,      F1), (RUEE,  F2), (RUEXCH,RSQ,XA,EMN),
     1  (RSATOM,QQ,DRUDR,XB), (A,DELP,RRYD), (B,ALFM,RKAY)
      EQUIVALENCE (RSATOM,S1),(RSATOM(251),S2),(RSATOM(501),ZETA)
C
      INTEGER WWWNL,WWNL8
      INTEGER FG
      DATA HDG1,HDG2,HDG3/6HRC(A0),6HR (A0),6H  PNL(/
C
  800 REWIND 4
      READ (4) RU,RUEE,RUEXCH,RSATOM,RECORR,RUCORR
C
C     COMPUTE FIRST TERM OF SERIES. (PNL(R)/R**(LAM+1) AT R=0)
C
      DO 807 M=1,NCSPVS
      LP=L(M)+1
      DO 806 I=1,4
      A(I,1)=1.D0
      A(I,2)=R(I+1)
      A(I,3)=R(I+1)*R(I+1)
      A(I,4)=R(I+1)*A(I,3)
  806 A(I,5)=PNL(I+1,M)/(R(I+1)**LP)
      CALL CROSYM (4)
      AZ(M)=A(1,5)
  807 CONTINUE
      ETOTRL=0.D0
      IF (TOLEND.GT.1.D-4) GO TO 987
      IF (IHF.EQ.0.OR.NCSPVS.LE.1) GO TO 808
      IF (IREL.NE.0) GO TO 990
      GO TO 982
C
C          CALCULATE ONE-ELECTRON ENERGY INTEGRALS
C
  808 TWOOALF=2.D0*137.036D0
      FROASQ=TWOOALF**2
      DO 850 M=1,NCSPVS
      READ (4) (V(I), I=1,MESH)
      IF (M.LT.N1SC) GO TO 850
  810 KKK=NKKK(M)
      QNL(1,M)=0.D0
      XI(1)=0.D0
      DO 812 I=2,KKK
      XJ(I)=PNL(I,M)**2
      ERAS1=R(I)
      ERAS=RSCORE(I)-XJ(I)
      IF (EE(NCSPVS).LT.0.D0) ERAS=ERAS+RSVALE(I)
      CALL SUBCOR
      RECORR(I)=B1
      RUCORR(I)=B2
      IF (IREL.NE.2.OR.EE(M).GE.0.D0) GO TO 812
      ERAS=TWOOALF/(FROASQ-V(I)+EE(M))
      QNL(I,M)=ERAS*((PNL(I+1,M)-PNL(I-1,M))/(R(I+1)-R(I-1))
     1  -PNL(I,M)/R(I))
  812 PNLO(I)=XJ(I)/R(I)
      IF (IREL.EQ.2.AND.EE(M).LT.0.D0) QNL(KKK,M)=0.D0
      A1=0.D0
  815 DO 840 N=1,6
      IF (EE(M)) 820,820,840
  820 DO 835 I=2,KKK
      GO TO (821,822,823,824,825,826), N
  821 XI(I)=XJ(I)*TWOZ/R(I)
      GO TO 835
  822 XI(I)=XJ(I)*V(I)
      GO TO 835
  823 XI(I)=PNLO(I)*RUEE(I)
      GO TO 835
  824 XI(I)=PNLO(I)*RUEXCH(I)
      GO TO 835
  825 XI(I)=PNLO(I)*RUCORR(I)
      GO TO 835
  826 XI(I)=PNLO(I)*RECORR(I)
  835 CONTINUE
      CALL QUAD5(XI,1,1,KKK,A1)
  840 B(N)=A1
      EKIN(M)=EE(M)-B(2)
      EEN(M)=-B(1)
      EI(M)=EKIN(M)+EEN(M)
      UEE(M)=B(3)
      UEX(M)=B(4)*EXF10
      UCORR(M)=B(5)
      ECORR(M)=B(6)
      EPSS(M)=EI(M)+UEE(M)+1.5D0*B(4)+ECORR(M)
  850 CONTINUE
      DO 870 I=1,MESH
      IF (EE(NCSPVS).LE.0.D0) GO TO 869
      RSATOM(I)=RSCORE(I)
      GO TO 870
  869 RSATOM(I)=RSCORE(I)+RSVALE(I)
  870 CONTINUE
      REWIND 4
C
C       OUTPUT
C
  900 EITOT=0.D0
      EKINT=0.D0
      EENTOT=0.D0
      EEETOT=0.D0
      EEXTOT=0.D0
      UCORRT=0.D0
      ECORRT=0.D0
      DO 907 M=1,NCSPVS
      IF (EE(M).GE.0.D0) GO TO 907
      EITOT=EITOT+EI(M)*WWNL(M)
      EKINT=EKINT+EKIN(M)*WWNL(M)
      EENTOT=EENTOT+EEN(M)*WWNL(M)
      EEETOT=EEETOT+UEE(M)*WWNL(M)
      EEXTOT=EEXTOT+UEX(M)*WWNL(M)
      UCORRT=UCORRT+UCORR(M)*WWNL(M)
      ECORRT=ECORRT+ECORR(M)*WWNL(M)
  907 CONTINUE
C
      EEETOT=0.5*EEETOT
      EEXTOT=0.75*EEXTOT/EXF10
      ETOT=EITOT+EEETOT+EEXTOT+ECORRT
      ECORRK=-ECORRT+3.D0*(UCORRT-ECORRT)
      ECORRP=ECORRT-ECORRK
      ETOTK=EKINT+ECORRK
      ETOTP=ETOT-ETOTK
C
      IF (IPTEB-1) 917,912,908
  908 WRITE (9,84) NCELEC,NVELEC,NOELEC,RSINT
   84 FORMAT (8H1NCELEC=,I3,11H    NVELEC=,I2,11H    NOELEC=,I3,
     1  10H    RSINT=,F10.6///
     2  30H0 M  NL  W  IMT KKK    E (RYD), 6X,5HE KIN,7X,5HE E-N,
     3  6X,5HU E-E,5X,6HU EXCH,4X,6HU CORR,6X,5HEPS S,
     4  5X,6HE CORR,18H   NO SCHEQ CYCLES//)
      I1=MIN0(NITER,10)
      DO 910 M=1,NCSPVS
  910 WRITE (9,86) M,NLBCD(M),WWNL(M),IMAT(M),NKKK(M),EE(M),EKIN(M),
     1 EEN(M),UEE(M),UEX(M),UCORR(M),EPSS(M),ECORR(M),(NSCH(I,M),I=1,I1)
   86 FORMAT (I3,1X,A3,F4.0,2I4,3F12.5,F11.5,2F10.5,F12.5,F10.5,2I3,8I2)
      WRITE (9,87) ETOT,EKINT,EENTOT,EEETOT,EEXTOT,ECORRT,ETOTK,ETOTP,
     1  ECORRK,ECORRP
   87 FORMAT (/1H0,12X,5HETOT=,F13.5,1H=,F11.5,F12.5,1H+,2F10.5,F32.5///
     1    22X,10HE TOT K,P=,F11.5,F12.5,27X,11HE CORR K,P=,2F10.5)
C
  912 WRITE (9,77)
   77 FORMAT (//1H2/7H  NL  W,10X,2HEE,9X,1HJ,8X,4HR(J),9X,2HAZ/)
      DO 915 M=1,NCSPVS
      J=JJJ(M)
  915 WRITE (9,78) NLBCD(M),WWNL(M),EE(M),JJJ(M),R(J),AZ(M)
   78 FORMAT (1X,A3,F4.0,F14.5,I8,F12.5,F12.3)
  917 READ (4) RU,RUEE,RUEXCH,RSATOM,RECORR,RUCORR
      KKK=0
      DO 920 M=1,NCSPVS
      IF (NKKK(M)-KKK) 920,920,919
  919 KKK=NKKK(M)
  920 CONTINUE
      DO 930 M=1,NCSPVS
      K=NKKK(M)+5
      IF (K-KKK) 925,925,930
  925 DO 926 I=K,KKK,5
  926 PNL(I,M)=0.D0
  930 CONTINUE
      IF (KKK.GT.MESH) KKK=KKK-5
C
      IF (IPTVU.LT.4) GO TO 945
      WRITE (9,89) CONF,NCONF,IZ,ION,KUT,EXF,CORRF,CA1,CA0
   89 FORMAT (1H1,3A6,4X,6HNCONF=,I3,6X,2HZ=,I3,5X,4HION=,I2,5X,4HKUT=,
     1  I2,6X,4HEXF=,F5.3,5X,6HCORRF=,F5.3,7H   CA1=,F5.3,7H   CA0=,
     2  F5.3///)
  933 WRITE (9,90)
   90 FORMAT (25X,12HOUTPUT RU(I),10X,9HRU E-E(I),11X,9HRUEXCH(I),
     1  11X,9HRUCORR(I),11X,9HRECORR(I))
      WRITE (9,91) HDG1
   91 FORMAT (4X,A6,4X,2HNC,1X,5(9X,1H1,9X,1H6)//)
      NC=-1
      DO 940 I=1,KKK,10
      NC=NC+1
  940 WRITE (9,29) RC(I),NC,RU(I),RU(I+5),RUEE(I),RUEE(I+5), RUEXCH(I),
     1  RUEXCH(I+5),RUCORR(I),RUCORR(I+5),RECORR(I),RECORR(I+5)
   29 FORMAT (1H ,F9.4,I6,4X,10F10.4)
C
  945 IF (NORBPT.LE.0) GO TO 980
      IF (IREL.NE.2) GO TO 948
      DO 947 M=1,NCSPVS
      DO 947 I=6,MESH,10
  947 QNL(I-5,M)=PNL(I,M)
  948 WRITE (9,89) CONF,NCONF,IZ,ION,KUT,EXF,CORRF,CA1,CA0
      K=MIN0(NCSPVS,2)
      WRITE (9,92) (HDG3,NLBCD(M), M=1,K)
   92 FORMAT (27X,9HRSCORE(I),11X,9HRSVALE(I),11X,9HRSATOM(I),
     1  2(9X,A6,A3,2H) ))
      WRITE (9,91) HDG2
      NC=-1
      DO 950 I=1,KKK,10
      NC=NC+1
  950 WRITE (9,93) R(I),NC,RSCORE(I),RSCORE(I+5),RSVALE(I),RSVALE(I+5),
     1  RSATOM(I),RSATOM(I+5), (PNL(I,M),PNL(I+5,M), M=1,K)
C    1  RSATOM(I),RSATOM(I+5), (PNL(I,M),QNL(I,M), M=1,K)
   93 FORMAT (1H ,F9.4,I6,4X,6F10.5,4F10.6)
C
  955 IF (K.GE.NCSPVS) GO TO 961
      K=MAX0(K,NCSPVS-NORBPT)
      J=K+1
      K=MIN0(K+5,NCSPVS)
      WRITE (9,89) CONF,NCONF,IZ,ION,KUT,EXF,CORRF,CA1,CA0
      WRITE (9,94) (HDG3,NLBCD(M), M=J,K)
   94 FORMAT (16X,5(9X,A6,A3,2H) ))
      WRITE (9,91) HDG2
      NC=-1
      DO 960 I=1,KKK,10
      NC=NC+1
  960 WRITE (9,95) R(I),NC, (PNL(I,M),PNL(I+5,M), M=J,K)
C 960 WRITE (9,95) R(I),NC, (PNL(I,M),QNL(I,M), M=J,K)
   95 FORMAT (1H ,F9.4,I6,4X,10F10.6)
      GO TO 955
C
  961 IF (EE(NCSPVS).LE.0.D0) GO TO 980
      IF (NORBPT.GE.6) GO TO 963
      IF (NCONFT.GT.1.AND.MOD(NCONFT,5).NE.0) GO TO 980
  963 WRITE(9,89) CONF,NCONF,IZ,ION,KUT,EXF,CORRF,CA1,CA0
      WRITE (9,94) HDG3,NLBCD(NCSPVS)
      WRITE (9,28)
   28 FORMAT (16H    R (A0)    NC,10X,1H1,9X,1H2,9X,1H3,9X,1H4,9X,1H5,
     1  9X,1H6,9X,1H7,9X,1H8,9X,1H9,8X,2H10//)
      NC=-1
      DO 970 MIN=1,KKK,10
      NC=NC+1
      MAX=MIN+9
  970 WRITE (9,95) R(MIN),NC, (PNL(I,NCSPVS), I=MIN,MAX)
C
C
C          CALC EXPECTATION VALUES OF R**N, SPIN-ORBIT PARS,
C            RELATIVISTIC CORRS, AND SLATER INTEGRALS
C
  980 LINES=54
      IF (ITPOW.EQ.1.OR.ITPOW.GE.3) LINES=LINES-3-NITER
      IF (IPTEB.GT.0) LINES=60-13-NCSPVS
      IF (IPTEB.GT.1) LINES=30-2-NCSPVS
      IF (IPTVU.GE.4.OR.NORBPT.GT.0) LINES=0
      IF (ITPOW.LT.2) GO TO 983
      IF (LINES.GT.NCSPVS+9) GO TO 981
      WRITE (9,89) CONF,NCONF,IZ,ION,KUT,EXF,CORRF,CA1,CA0
      LINES=60
  981 LINES=LINES-9-NCSPVS
  983 CALL POWER
      IF (LINES.GT.NCSPVS+6) GO TO 982
      WRITE (9,89) CONF,NCONF,IZ,ION,KUT,EXF,CORRF,CA1,CA0
      LINES=60
  982 CALL ZETA1
      IF (IHF.EQ.1.AND.NCSPVS.GT.1) GO TO 987
      LINES=LINES-6-NCSPVS
      IF (IPTVU.GT.0) GO TO 985
      IF (LINES.GT.NCSPVS+19) GO TO 985
      WRITE (9,89) CONF,NCONF,IZ,ION,KUT,EXF,CORRF,CA1,CA0
  985 CALL SLI1
  987 REWIND 4
      READ (4) RU,RUEE,RUEXCH,RSATOM
      REWIND 4
C
      DO 988 I=1,NCSPVS
  988 NNLZ(I)=100*NNN(I)+L(I)
      NORB=1+NCSPVS-NS
      IF (NNN(NCSPVS).GT.98) ION=ION-1
      IF (IZ.EQ.IZO.AND.ION.EQ.IONO) GO TO 989
      IZO=IZ
      IONO=ION
      IERAS=IABS(NORBPT)
      NORB=MIN0(NCSPVS,MAX0(2,IERAS))
      IF (IERAS.EQ.9) NORB=NCSPVS
      NS=1+NCSPVS-NORB
  989 IF (IHF.NE.0.AND.NCSPVS.GT.1.AND.(NCSPVS.GT.2.OR.NNN(2).LE.90))
     1  GO TO 990
      IF (NCONF.EQ.0) GO TO 995
      WRITE (2) NNN,L,WWNL,NCSPVS,VPRM,CONF,NCONF,IZ,Z,ION,IREL,HXID,
     1  MESH,C,IDB,EXF,CORRF,KUT,NPAR,NLBCD,NNLZ,NKKK,EE,EE8,NORB,
     2  R,RU,((PNL(I,M),I=1,KMSH),M=NS,NCSPVS),IW6
      GO TO 995
  990 CALL HFWRTP
C
  995 RETURN
      END
      SUBROUTINE VINTI(IVINTI)
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      CHARACTER*8 NLBCD(KO),NLBCDO(KO),NLBCD8(KO),IFG(10,9),JFG(10,9),
     1  NLA,NLB
      CHARACTER CONF(3)*6,INPCARD*70
      COMMON/CHAR/CONF,NLBCD,NLBCDO,NLBCD8,IFG,JFG,NLA,NLB,INPCARD
      COMMON XI(KMSH),XJ(KMSH),V(KMSH),RSCORE(KMSH),RSVALE(KMSH),
     1  RECORR(KMSH),RUCORR(KMSH),RC(KMSH),PNLO(KMSH),X1(KMSH),X2(KMSH)
C
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
      COMMON/C3/NPAR,NZI,NFIJ,NGIJ,VPRM(50),KPAR(50),ZI(8),FIJ(30),
     1  GIJ(35),NORB,NORBPT,DH(5),DELTA,NPR
      COMMON/C4/VR(KMSH),QQ0(KMSH),IREL,NITER,NN,LAM,E,END,NODF,I,J,K,
     1  MM,IMATCH,RSINT,RSINT1,HXID,IZHXBW,IPHFWF,IHF,IHF1,NPRINT
      COMMON/C5/IZO,IONO,LBCD(21),MORB(7),IBLANK,WWWNL(39),EEO(KO),
     1  WWNL8(8),EE8,NOELEC,IERROR,WWNLO(KO),N1SC,N1SCF
      COMMON/C6/A0,A1,A2,A3,A4,AB1,AB3,B0,B1,B2,B3,ERAS,ERAS1,ERAS2
      COMMON/C7/T0,T1,T2
      COMMON/C8/NHFTRM,NFG,ETOTRL,EHF(KO),T1HF(9),T2HF(9),ETERM,
     1  NF(9),NG(9),CFG(10,9),FG(10,9),KFG(10,9),RHFMTC(KO),II
      COMMON PNL(KMSH,KO),QNL(KMSHQ,KOQ)
      COMMON/LC2/RA(KMSH),RB(KMSH)
C
      DIMENSION RSQ(KMSH),QQ(KMSH),DELP(KO),ALFM(KO),
     1  S1(10,KO),S2(10,KO),ZETA(KO,3)
      EQUIVALENCE (RU,      F1), (RUEE,  F2), (RUEXCH,RSQ,XA,EMN),
     1  (RSATOM,QQ,DRUDR,XB), (A,DELP,RRYD), (B,ALFM,RKAY)
      EQUIVALENCE (RSATOM,S1),(RSATOM(251),S2),(RSATOM(501),ZETA)
      INTEGER WWWNL,WWNL8
      INTEGER FG
C
      IF (NCSPVS.EQ.1) RETURN
      WRITE (9,10) CONF
   10 FORMAT ('1   VINTI INTEGRALS FOR  ',3A6////
     1  10X,'VINTI INTEGRAL',23X,'J**2',17X,'WT*(J**2)'/)
      SUM=0.D0
C
      DO 390 N=1,NCSPVS
      FL=L(N)
      LM1=L(N)-1
      FLM1=LM1
      DO 380 NP=1,NCSPVS
      IF (L(NP).NE.LM1) GO TO 380
      KMAX=MIN0(NKKK(N),NKKK(NP))
      KMXM2=KMAX-2
      H12=1.D0/(12.D0*R(2))
C
      DO 290 I=1,KMXM2
      IF (I.GE.KMAX-1) GO TO 130
      IF (I.GE.IDB+2) GO TO 150
      I1=I-40*((I-2)/40)
      IF (I1.GT.2) GO TO 120
      IF (I1.EQ.2) GO TO 110
      DER=-25.D0*PNL(I,NP)+48.D0*PNL(I+1,NP)-36.D0*PNL(I+2,NP)
     1  +16.D0*PNL(I+3,NP)-3.D0*PNL(I+4,NP)
      GO TO 200
  110 DER=-3.D0*PNL(I-1,NP)-10.D0*PNL(I,NP)+18.D0*PNL(I+1,NP)
     1  -6.D0*PNL(I+2,NP)+PNL(I+3,NP)
      GO TO 200
  120 IF (I1.LT.40) GO TO 150
      IF (I1.EQ.41) GO TO 130
      DER=-PNL(I-3,NP)+6.D0*PNL(I-2,NP)-18.D0*PNL(I-1,NP)
     1  +10.D0*PNL(I,NP)+3.D0*PNL(I+1,NP)
      GO TO 200
  130 DER=3.D0*PNL(I-4,NP)-16.D0*PNL(I-3,NP)+36.D0*PNL(I-2,NP)
     1  -48.D0*PNL(I-1,NP)+25.D0*PNL(I,NP)
      GO TO 200
  150 DER=PNL(I-2,NP)-8.D0*PNL(I-1,NP)+8.D0*PNL(I+1,NP)-PNL(I+2,NP)
  200 DER=H12*DER
      XI(I)=PNL(I,N)*(DER-FL*PNL(I,NP)/R(I))
      IF (IVINTI.LT.2) GO TO 280
      IF (N.EQ.3.AND.NP.EQ.2) WRITE (9,9920) I,R(I),PNL(I,NP),
     1  DER,I1,H12,PNL(I,N),XI(I)
 9920 FORMAT (I5,3F14.8,I5,3F14.8)
  280 IF (I1.EQ.41) H12=0.5*H12
  290 CONTINUE
      XI(KMAX-1)=XI(KMXM2)
      XI(KMAX)=XI(KMXM2)
C
      CALL QUAD5(XI,1,1,KMAX,FJ)
      FJSQ=FJ**2
      AA=(4.D0*FL+2.D0)*(4.D0*FLM1+2.D0)
      WT=2.D0*FL*WWNL(N)*WWNL(NP)/AA
      BB=WT*FJSQ
      SUM=SUM+BB
      WRITE (9,30) NLBCD(N),NLBCD(NP),FJ,FJSQ,BB
   30 FORMAT (5X,'J(',A3,',',A3,')=',F14.8,8X,F15.8,8X,F15.8)
  380 CONTINUE
  390 CONTINUE
C
      WRITE (9,40) SUM
   40 FORMAT (/10X,'TOTAL K-FACTOR=',F16.8)
      RETURN
      END
      SUBROUTINE PHSHIFT
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      COMMON XI(KMSH),XJ(KMSH),V(KMSH),RSCORE(KMSH),RSVALE(KMSH),
     1  RECORR(KMSH),RUCORR(KMSH),RC(KMSH),PNLO(KMSH),X1(KMSH),X2(KMSH)
C
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
      COMMON/C3/NPAR,NZI,NFIJ,NGIJ,VPRM(50),KPAR(50),ZI(8),FIJ(30),
     1  GIJ(35),NORB,NORBPT,DH(5),DELTA,NPR
      COMMON/C4/VR(KMSH),QQ0(KMSH),IREL,NITER,NN,LAM,E,END,NODF,I,J,K,
     1  MM,IMATCH,RSINT,RSINT1,HXID,IZHXBW,IPHFWF,IHF,IHF1,NPRINT
      COMMON/C5/IZO,IONO,LBCD(21),MORB(7),IBLANK,WWWNL(39),EEO(KO),
     1  WWNL8(8),EE8,NOELEC,IERROR,WWNLO(KO),N1SC,N1SCF
      COMMON/C6/A0,A1,A2,A3,A4,AB1,AB3,B0,B1,B2,B3,ERAS,ERAS1,ERAS2
      COMMON PNL(KMSH,KO),QNL(KMSHQ,KOQ)
C
      DIMENSION RSQ(KMSH),QQ(KMSH),DELP(KO),ALFM(KO),
     1  S1(10,KO),S2(10,KO),ZETA(KO,3)
      EQUIVALENCE (RU,      F1), (RUEE,  F2), (RUEXCH,RSQ,XA,EMN),
     1  (RSATOM,QQ,DRUDR,XB), (A,DELP,RRYD), (B,ALFM,RKAY)
      EQUIVALENCE (RSATOM,S1),(RSATOM(251),S2),(RSATOM(501),ZETA)
C
      DIMENSION FMZ(5,2),RZ(5,2),PHASE(5,2),SHIFT(5)
      INTEGER WWWNL,WWNL8
C
      PI=3.14159265359D0
      TWOPI=2.D0*PI
      TWOZZ=TWOZZZ-2.D0
      MM=NCSPVS
      ERAS=L(MM)
      AA=0.5D0*PI*ERAS
      FK=DSQRT(EE(MM))
      N1=5
      I1=1
      DO 120 I=1000,MESH
  120 PNLO(I)=PNL(I,MM)
      GO TO 300
C
C          CALCULATE (NON-RELATIVISTIC) COULOMB FUNCTION
C
  200 DO 210 I=2,MESH
      V(I)=-TWOZZ/R(I)
  210 X2(I)=V(I)
      NN=NNN(MM)
      LAM=L(MM)
      E=EE(MM)
      IREL1=IREL
      IREL=0
      CALL SCHEQ
      IREL=IREL1
C
C          CALC DISTORTED-WAVE OR COULOMB PHASE SHIFT
C
  300 M=MESH-5
      DO 330 N=1,N1
  310 M=M-1
      IF (PNLO(M).LT.0.D0) GO TO 310
      IF (PNLO(M-1).GT.0.D0) GO TO 310
      M=M-1
      LL=M
      IF (DABS(PNLO(M)).GT.PNLO(M+1)) LL=M+1
C          FIND NODE VIA R=C1+C2*P+C3*(P**3)
      A1=PNLO(LL-1)
      A2=PNLO(LL)
      A3=PNLO(LL+1)
      A13=A1**3
      A23=A2**3
      A33=A3**3
      B1=R(LL-1)
      B2=R(LL)
      B3=R(LL+1)
      B0=B1*(A2*A33-A3*A23)+B2*(A3*A13-A1*A33)+B3*(A1*A23-A2*A13)
      A0=A1*(A23-A33)+A2*(A33-A13)+A3*(A13-A23)
      RZ(N,I1)=B0/A0
      F1=M
      FMZ(N,I1)=F1+(RZ(N,I1)-R(M))/(R(M+1)-R(M))
      ERAS=FK*RZ(N,I1)+0.5D0*TWOZZ*DLOG(2.D0*FK*RZ(N,I1))/FK-AA
      ERAS=DMOD(ERAS,TWOPI)
      IF (ERAS.LE.0.D0) ERAS=ERAS+TWOPI
      PHASE(N,I1)=ERAS
      IF (I1.NE.2) GO TO 330
      SHIFT(N)=PHASE(N,1)-PHASE(N,2)
      IF (SHIFT(N).LT.0.D0) SHIFT(N)=SHIFT(N)+TWOPI
  330 CONTINUE
      IF (I1.EQ.2) GO TO 400
      I1=2
      GO TO 200
C
  400 WRITE (9,40) (FMZ(N,1),RZ(N,1),PHASE(N,1),FMZ(N,2),RZ(N,2),
     1  PHASE(N,2),SHIFT(N), N=1,N1)
   40 FORMAT (//2X,7HMESH PT,5X,1HR,5X,8HDW PHASE,7X,7HMESH PT,5X,
     1  1HR,6X,7HCOUL PH,4X,8HPH SHIFT/(F9.2,F9.3,F10.5,F14.2,F9.3,
     2  F10.5,F12.5))
      RETURN
      END
      SUBROUTINE SUBCOR
C
C          CALCULATE CORRELATION ENERGY DENSITY
C
      IMPLICIT REAL*8 (A-H,O-Z)
      COMMON/C6/A0,A1,A2,A3,A4,AB1,AB3,B0,B1,B2,B3,ERAS,ERAS1,ERAS2
C
  100 IF (ERAS.GT.1.D-20) GO TO 120
      B0=9999.9999D0
      B1=0.D0
      B2=0.D0
      B3=0.D0
      GO TO 200
  120 B0=(3.D0*ERAS1*ERAS1/ERAS)**.333333333D0
      A1=DSQRT(B0+9.D0)
      A2=4.D0*A1+1.142D0*B0
      EC=-1.D0/A2
      B1=ERAS1*EC
      A2=EC*EC*(2.D0/A1+1.142D0)
      B2=ERAS1*(EC-B0*A2/3.D0)
      B3=-1.22177412D0*ERAS1/B0
      EC=B2/ERAS1
      B1=B2
      EC1=-1.D0/(4.D0*A1+0.75D0*1.142D0*B0)
      B2=ERAS1*EC1
      B1=B2
  200 RETURN
      END
      SUBROUTINE CROSYM(M)
C
C     SIMULTANEOUS EQUATION SOLVER
C     WRITTEN BY I.C. HANSON, SCIENTIFIC COMPUTATION DEPARTMENT,
C     LOCKHEED MISSLES AND SPACE COMPANY, SUNNYVALE, CALIFORNIA
C     SOLVE M SIMULTANEOUS EQUATIONS BY THE METHOD OF CROUT
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
C
      N=M+1
      I1=1
    1 I3=I1
      SUM=DABS(A(I1,I1))
      DO 3 I=I1,M
      IF (SUM-DABS(A(I,I1))) 2,3,3
    2 I3=I
      SUM=DABS(A(I,I1))
    3 CONTINUE
      IF (I3-I1) 4,6,4
    4 DO 5 J=1,N
      SUM=-A(I1,J)
      A(I1,J)=A(I3,J)
    5 A(I3,J)=SUM
    6 I3=I1+1
      DO 7 I=I3,M
    7 A(I,I1)=A(I,I1)/A(I1,I1)
   14 J2=I1-1
      I3=I1+1
      IF (J2) 8,11,8
    8 DO 9 J=I3,N
      DO 9 I=1,J2
    9 A(I1,J)=A(I1,J)-A(I1,I)*A(I,J)
      IF (I1-M) 11,15,11
   11 J2=I1
      I1=I1+1
      DO 12 I=I1,M
      DO 12 J=1,J2
   12 A(I,I1)=A(I,I1)-A(I,J)*A(J,I1)
      IF (I1-M) 1,14,1
   15 DO 17 I=1,M
      J2=M-I
      I3=J2+1
      A(I3,N)=A(I3,N)/A(I3,I3)
      IF (J2) 16,18,16
   16 DO 17 J=1,J2
   17 A(J,N)=A(J,N)-A(I3,N)*A(J,I3)
   18 RETURN
      END
      SUBROUTINE QUAD5(FI,IPOW,I1,I2,A1)
C
C     INTEGRATE FI (IPOW=1) OR FI**2 (IPOW=2) FROM MESH POINT I1 TO I2.
C          INTEGRATION IS BY 8 APPLICATIONS OF NEWTON-COTES CLOSED
C            QUADRATURE FOR FIVE INTERVALS ON EACH BLOCK.
C IF I2-1 NOT A MULTIPLE OF 5, FILL OUT REMAINDER
C   OF MESH BY SIMPSONS AND/OR TRAPEZOIDAL RULE.
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
      DIMENSION FI(KMSH)
C
      MMSAVE=MM
      XIF=(R(I1+1)-R(I1))*2.5D0/288.D0
      A1=0.D0
      J=I1
      K=J-40*(J/40)
      MM=8-K/5
      I3=5*((I2-1)/5)+1
      IF (IPOW.EQ.2) GO TO 200
      GO TO 106
C
  105 MM=8
  106 MM1=(I2-J)/5
      MM=MIN0(MM,MM1)
      IF (J.EQ.IDB) MM=MM1
      XIF=XIF+XIF
      A2=0.D0
  110 A2=A2+19.D0*(FI(J)+FI(J+5))+75.D0*(FI(J+1)+FI(J+4))
     1   +50.D0*(FI(J+2)+FI(J+3))
      J=J+5
      MM=MM-1
      IF (IB.GE.0) GO TO 115
      A3=A1+XIF*A2
      WRITE (9,10) IB,J,R(J),FI(J),XIF,A2,A1,A3
   10 FORMAT (2I6,F12.5,1P,5E16.6)
  115 IF (MM.GT.0) GO TO 110
      A1=A1+XIF*A2
      IF (J.LT.I3) GO TO 105
      IF (J.EQ.I2) GO TO 150
      XIF=(R(I2)-R(I2-1))/3.D0
  120 IF (J.EQ.I2-1) GO TO 130
      A1=A1+XIF*(FI(J)+4.D0*FI(J+1)+FI(J+2))
      J=J+2
      IF (J.EQ.I2) GO TO 150
      GO TO 120
  130 A1=A1+1.5*XIF*(FI(J)+FI(J+1))
  150 MM=MMSAVE
      RETURN
C
  200 FJ5=FI(J)**2
      GO TO 206
  205 MM=8
  206 MM1=(I2-J)/5
      MM=MIN0(MM,MM1)
      IF (J.EQ.IDB) MM=MM1
      XIF=XIF+XIF
      A2=0.D0
  210 FJ=FJ5
      FJ5=FI(J+5)**2
      A2=A2+19.D0*(FJ+FJ5)+75.D0*(FI(J+1)**2+FI(J+4)**2)
     1  +50.D0*(FI(J+2)**2+FI(J+3)**2)
      J=J+5
      MM=MM-1
      IF (MM.GT.0) GO TO 210
      A1=A1+XIF*A2
      IF (J.LT.I3) GO TO 205
      IF (J.EQ.I2) GO TO 250
      XIF=(R(I2)-R(I2-1))/3.D0
  220 IF (J.EQ.I2-1) GO TO 230
      FJ=FJ5
      FJ5=FI(J+2)**2
      A1=A1+XIF*(FJ+4.D0*FI(J+1)**2+FJ5)
      J=J+2
      IF (J.EQ.I2) GO TO 250
      GO TO 220
  230 A1=A1+1.5*XIF*(FJ5+FI(J+1)**2)
  250 MM=MMSAVE
      RETURN
      END
      SUBROUTINE QUAD2(M)
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      COMMON XI(KMSH),XJ(KMSH),V(KMSH),RSCORE(KMSH),RSVALE(KMSH),
     1  RECORR(KMSH),RUCORR(KMSH),RC(KMSH),PNLO(KMSH),X1(KMSH),X2(KMSH)
C
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
      COMMON/C3/NPAR,NZI,NFIJ,NGIJ,VPRM(50),KPAR(50),ZI(8),FIJ(30),
     1  GIJ(35),NORB,NORBPT,DH(5),DELTA,NPR
      COMMON/C4/VR(KMSH),QQ0(KMSH),IREL,NITER,NN,LAM,E,END,NODF,I,J,K,
     1  MM,IMATCH,RSINT,RSINT1,HXID,IZHXBW,IPHFWF,IHF,IHF1,NPRINT
C
C     CALCULATE ATOMIC COULOMB POTENTIAL  (INTEGRATE BY SIMPSONS RULE)
C           XI=INTEGRAL(RSATOM),  XJ=INTEGRAL(RSATOM/R)
C
  510 XI(1)=0.D0
      XJ(1)=0.D0
      B2=0.D0
      IM=MIN0(MESH,IB+6)
C
      HO3=R(2)/3.D0
      I=1
      DO 515 J=1,NBLOCK
      DO 513 K=1,20
      I=I+2
      IF (I.GT.IB) GO TO 520
      XI(I)=XI(I-2)+HO3*(RSATOM(I-2)+4.D0*RSATOM(I-1)+RSATOM(I))
      B0=B2
      B2=RSATOM(I)/R(I)
  513 XJ(I)=XJ(I-2)+HO3*(B0+4.D0*RSATOM(I-1)/R(I-1)+B2)
      IF (I.GT.IDB) GO TO 515
      HO3=HO3+HO3
  515 CONTINUE
  520 IC=1
      IF (I.EQ.IB) GO TO 525
      I=I-1
      IF (I.NE.IB) GO TO 525
      IC=2
      XI(I)=XI(I-1)+1.5D0*HO3*(RSATOM(I-1)+RSATOM(I))
      B0=B2
      B2=RSATOM(I)/R(I)
      XJ(I)=XJ(I-1)+1.5*HO3*(B0+B2)
  525 IF (IB.EQ.MESH) GO TO 530
      DO 527 I=IB,IM
      XI(I)=XI(IB)
  527 XJ(I)=XJ(IB)
  530 RSINT1=XI(IB)
      IF (M.EQ.2) RSINT=RSINT1
C
C           RUEE=R*(ELECTRON-ELECTRON ENERGY), XJ=R*(TOTAL ENERGY)
C
      DO 535 I=1,IM,2
  535 XI(I)=2.D0*(XI(I)+R(I)*(XJ(IB)-XJ(I)))
      IF (IC.EQ.2) XI(IB)=2.D0*XI(IB)
      DO 540 I=3,IB,4
      B0=(XI(I)-XI(I-2)+XI(I)-XI(I+2))/8.D0
      XI(I-1)=0.5*(XI(I)+XI(I-2))+B0
  540 XI(I+1)=0.5*(XI(I)+XI(I+2))+B0
      I1=MOD(IB-1,4)
      IF (I1.NE.1) GO TO 545
      I=IB-I1
      B0=(XI(I)-XI(I-2)+XI(I)-XI(I+2))/8.D0
      XI(I+1)=0.5*(XI(I)+XI(I+2))+B0
  545 IF (M.EQ.1) RETURN
      DO 550 I=1,IB
      RUEE(I)=XI(I)
  550 XJ(I)=-TWOZ+RUEE(I)+EXF10*RUEXCH(I)
      DO 560 I=IB,MESH
      RUEE(I)=RUEE(IB)
  560 XJ(I)=XJ(IB)
      RETURN
      END
      SUBROUTINE CLOCK
C
      IMPLICIT REAL*8 (A-H,O-Z)
      COMMON/C7/T0,T1,T2
C
      CALL SECONDS(T2)
      TR=T2-T1
      TJ=T2-T0
      WRITE (9,99) TR,TJ
   99 FORMAT (//12H0    T(RUN)=,F6.2,1H,,5X,7HT(JOB)=,F7.2,8H SECONDS)
      RETURN
      END
      SUBROUTINE SECONDS(T)
C
C          TIMING ROUTINE (RESULTS FOR INFORMATION ONLY)
C               FOR OTHER MACHINES, SET T=0.0 OR ADD
C               APPROPRIATE CODE.
C
C     REAL*8 T
C------------------------------------
C          USE THIS CODE FOR A VAX OR MACINTOSH
C     REAL*4 T1
C     T1=SECNDS(0.0)
C     T=DBLE(T1)
C------------------------------------
C          USE THIS CODE FOR A CRAY
C     T=SECOND(T)
C------------------------------------
C          USE THIS CODE FOR A SUN
C     REAL ETIME,T1
C     DIMENSION T1(2)
C     T=ETIME(T1)
C-------------------------------------
C          USE THIS CODE FOR IBM RISC
C     IT=MCLOCK()
C     T=IT
C     T=T/100.D0
C-------------------------------------
C          USE THIS CODE FOR IBM-PC LAHEY FORTRAN COMPILER
      REAL*8 T,TINIT,T1
      COMMON/TIMING/TINIT,ITINIT
      CHARACTER TIMESTR*11
      INTEGER HH,MM,SS,HS
      CALL TIME(TIMESTR)
      READ (TIMESTR,10) HH,MM,SS,HS
   10 FORMAT (3(I2,1X),I2)
      T1=DFLOAT(3600*HH+60*MM+SS)+HS*1.D-2
      IF (ITINIT.EQ.0) THEN
        TINIT=T1
        ITINIT=1
      ENDIF
      T=T1-TINIT
      RETURN
      END
      SUBROUTINE POWER
C
C          EVALUATE EXPECTATION VALUES OF R TO N
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      CHARACTER*8 NLBCD(KO),NLBCDO(KO),NLBCD8(KO),IFG(10,9),JFG(10,9),
     1  NLA,NLB
      CHARACTER CONF(3)*6,INPCARD*70
      COMMON/CHAR/CONF,NLBCD,NLBCDO,NLBCD8,IFG,JFG,NLA,NLB,INPCARD
      COMMON XI(KMSH),XJ(KMSH),V(KMSH),RSCORE(KMSH),RSVALE(KMSH),
     1  RECORR(KMSH),RUCORR(KMSH),RC(KMSH),PNLO(KMSH),X1(KMSH),X2(KMSH)
C
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
      COMMON/C3/NPAR,NZI,NFIJ,NGIJ,VPRM(50),KPAR(50),ZI(8),FIJ(30),
     1  GIJ(35),NORB,NORBPT,DH(5),DELTA,NPR
      COMMON/C4/VR(KMSH),QQ0(KMSH),IREL,NITER,NN,LAM,E,END,NODF,I,J,K,
     1  MM,IMATCH,RSINT,RSINT1,HXID,IZHXBW,IPHFWF,IHF,IHF1,NPRINT
      COMMON/C5/IZO,IONO,LBCD(21),MORB(7),IBLANK,WWWNL(39),EEO(KO),
     1  WWNL8(8),EE8,NOELEC,IERROR,WWNLO(KO),N1SC,N1SCF
      COMMON/C6/A0,A1,A2,A3,A4,AB1,AB3,B0,B1,B2,B3,ERAS,ERAS1,ERAS2
      COMMON/C7/T0,T1,T2
      COMMON/C8/NHFTRM,NFG,ETOTRL,EHF(KO),T1HF(9),T2HF(9),ETERM,
     1  NF(9),NG(9),CFG(10,9),FG(10,9),KFG(10,9),RHFMTC(KO),II
      COMMON PNL(KMSH,KO),QNL(KMSHQ,KOQ)
C
      DIMENSION RSQ(KMSH),QQ(KMSH),DELP(KO),ALFM(KO),
     1  S1(10,KO),S2(10,KO),ZETA(KO,3)
      EQUIVALENCE (RU,      F1), (RUEE,  F2), (RUEXCH,RSQ,XA,EMN),
     1  (RSATOM,QQ,DRUDR,XB), (A,DELP,RRYD), (B,ALFM,RKAY)
      EQUIVALENCE (RSATOM,S1),(RSATOM(251),S2),(RSATOM(501),ZETA)
      DIMENSION PSQ(KMSH),P(KMSH,10)
      EQUIVALENCE (XJ,PSQ,P)
C
      INTEGER WWWNL,WWNL8
      INTEGER FG
C
      MM=NCSPVS
      IF (EE(MM).GT.0.D0) MM=MM-1
      IF (MM.LE.0) RETURN
  350 IF (ITPOW.GE.2) WRITE (9,35)
   35 FORMAT (///2X,7HNL  WNL,7X,2HEE,10X,2HAZ,
     1    6X,5H(R-3),6X,5H(R-2),6X,5H(R-1),6X,5H(R+1),6X,5H(R+2),
     2    6X,5H(R+3),6X,5H(R+4),6X,5H(R+6)/)
C
  400 KKK=0
      DO 410 M=1,MM
      IF (NKKK(M).GT.KKK) KKK=NKKK(M)
  410 CONTINUE
C
C          INTEGRATE
C
      DO 420 K=1,KKK
      R1=R(K)
      R2=R1*R1
      R3=R1*R2
      P(K,2)=1.D0/R3
      P(K,3)=1.D0/R2
      P(K,4)=1.D0/R1
      P(K,5)=R1
      P(K,6)=R2
      P(K,7)=R3
      P(K,8)=R2*R2
      P(K,9)=R2*R3
  420 P(K,10)=R3*R3
      DO 599 M=1,MM
      KKK=NKKK(M)
      DO 510 K=1,KKK
  510 PSQ(K)=PNL(K,M)**2
      DO 530 N=2,10
      S2(N,M)=0.D0
      DO 520 K=1,KKK
  520 XI(K)=PSQ(K)*P(K,N)
      IF (N.NE.3.OR.L(M).NE.0) GO TO 530
      XI(1)=4.D0*(XI(2)+XI(4))-6.D0*XI(3)-XI(5)
  530 CALL QUAD5(XI,1,1,KKK,S1(N,M))
      RM3(M)=S1(2,M)
  599 CONTINUE
      IF (ITPOW.LT.2) GO TO 900
C
  700 FN=1.D-20
      DO 721 M=1,MM
      DO 711 N=2,10
  711 S2(N,1)=S2(N,1)+WWNL(M)*S1(N,M)
      FN=FN+WWNL(M)
      S1(9,M)=S1(10,M)
      IF (L(M).LE.0) S1(2,M)=0.D0
  720 WRITE (9,72) NLBCD(M),WWNL(M),EE(M),AZ(M),(S1(N,M),N=2,9)
   72 FORMAT (1X,A3,F4.0,F13.5,F11.3,1P,8E11.3)
  721 CONTINUE
      IF (MM.EQ.1) RETURN
      DO 730 N=3,10
  730 S2(N,2)=S2(N,1)/FN
      R1=0.1D0
      S2(9,1)=S2(10,1)
      S2(9,2)=S2(10,2)
      WRITE (9,73)FN,(S2(N,1), N=3,9), R1,(S2(N,2),N=3,9)
   73 FORMAT (/3X,F5.0,35X,1P,7E11.3)
C
  900 RETURN
      END
      SUBROUTINE ZETA1
C
C          CALCULATE SPIN-ORBIT PARAMETERS (VIA BOTH CENTRAL-FIELD
C               FORMULA AND BLUME-WATSON METHOD)
C                     AND RELATIVISTIC ENERGY CORRECTIONS
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      CHARACTER*8 NLBCD(KO),NLBCDO(KO),NLBCD8(KO),IFG(10,9),JFG(10,9),
     1  NLA,NLB
      CHARACTER CONF(3)*6,INPCARD*70
      COMMON/CHAR/CONF,NLBCD,NLBCDO,NLBCD8,IFG,JFG,NLA,NLB,INPCARD
      COMMON XI(KMSH),XJ(KMSH),V(KMSH),RSCORE(KMSH),RSVALE(KMSH),
     1  RECORR(KMSH),RUCORR(KMSH),RC(KMSH),PNLO(KMSH),X1(KMSH),X2(KMSH)
C
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
      COMMON/C3/NPAR,NZI,NFIJ,NGIJ,VPRM(50),KPAR(50),ZI(8),FIJ(30),
     1  GIJ(35),NORB,NORBPT,DH(5),DELTA,NPR
      COMMON/C4/VR(KMSH),QQ0(KMSH),IREL,NITER,NN,LAM,E,END,NODF,I,J,K,
     1  MM,IMATCH,RSINT,RSINT1,HXID,IZHXBW,IPHFWF,IHF,IHF1,NPRINT
      COMMON/C5/IZO,IONO,LBCD(21),MORB(7),IBLANK,WWWNL(39),EEO(KO),
     1  WWNL8(8),EE8,NOELEC,IERROR,WWNLO(KO),N1SC,N1SCF
      COMMON/C6/A0,A1,A2,A3,A4,AB1,AB3,B0,B1,B2,B3,ERAS,ERAS1,ERAS2
      COMMON/C7/T0,T1,T2
      COMMON/C8/NHFTRM,NFG,ETOTRL,EHF(KO),T1HF(9),T2HF(9),ETERM,
     1  NF(9),NG(9),CFG(10,9),FG(10,9),KFG(10,9),RHFMTC(KO),II
      COMMON PNL(KMSH,KO),QNL(KMSHQ,KOQ)
C
      DIMENSION RSQ(KMSH),QQ(KMSH),DELP(KO),ALFM(KO),
     1  S1(10,KO),S2(10,KO),ZETA(KO,3)
      EQUIVALENCE (RU,      F1), (RUEE,  F2), (RUEXCH,RSQ,XA,EMN),
     1  (RSATOM,QQ,DRUDR,XB), (A,DELP,RRYD), (B,ALFM,RKAY)
      EQUIVALENCE (RSATOM,S1),(RSATOM(251),S2),(RSATOM(501),ZETA)
C
      INTEGER WWWNL,WWNL8
      INTEGER FG
      DIMENSION FI(KMSH,5),D(KMSH,3),DRUDR(KMSH),P(KMSH)
      EQUIVALENCE (RSCORE,FI),(PNLO,D),(RUEE,P)
C
  100 NPAR=1
      NZI=0
      NFIJ=0
      NGIJ=0
      DO 101 I=1,45
      VPRM(I)=0.D0
  101 KPAR(I)=0
C
      IF (IHF.EQ.1) GO TO 360
  350 WRITE (9,35)
   35 FORMAT(///1H ,8X,45H--------------------ZETA---------------------,
     1/8H  NL WNL,2X,21H ----BLUME-WATSON----,5X,16H-----(R*VI)-----,5X,
     2  7HI (RYD),6X,5HEPS S,7X,4HEVEL,7X,24HEDAR   EVEL+EDAR    EREL/
     3  13X,6H (RYD),6X,6H(CM-1),5X,5H(RYD) ,6X,6H(CM-1))
  360 DO 380 I=1,MESH
      RSQ(I)=R(I)*R(I)
      D(I,1)=-Z-Z+RUEE(I)
  380 D(I,2)=RU(I)
C
C           CALCULATE EVEL, EDAR, AND ZETA FOR EACH ORBITAL
C
  400 SUMVD=0.D0
      ETOTRL=0.D0
      DO 899 M=1,NCSPVS
      IF (EE(M)) 405,405,401
  401 EVEL(M)=0.D0
      EDAR(M)=0.D0
      ZETA(M,1)=0.D0
      ZETA(M,2)=0.D0
      ZETA(M,3)=0.D0
      GO TO 700
C
C          SET UP POTENTIALS FOR INDIVIDUAL ORBITALS AND TOTAL ATOM
C
  405 READ (4)(V(I), I=1,MESH)
      DO 406 I=1,MESH
  406 D(I,3)=V(I)*R(I)
C
C          CALCULATE DERIVATIVES OF POTENTIALS
C
      N1=3
      NBLOCK=MESH/40
      DO 460 N=N1,3
      DR=3.D0*R(2)
      I=1
      DO 420 M123=1,NBLOCK
      DO 410 J=1,10
      I=I+4
      B0=D(I-3,N)-D(I-2,N)-D(I-2,N)+D(I-1,N)
      B1=D(I-2,N)-D(I-1,N)-D(I-1,N)+D(I,N)
      B2=D(I-3,N)-D(I,N)
      DRUDR(I-3)=(-4.5D0*B0-B2)/DR
      DRUDR(I-2)=(-1.5*B1-B2)/DR
      DRUDR(I-1)=(1.5*B0-B2)/DR
  410 DRUDR(I)=(4.5*B1-B2)/DR
      IF (I.GT.IDB) GO TO 420
      DR=DR+DR
  420 CONTINUE
      DO 450 I=2,MESH
      V(I)=D(I,N)/R(I)
  450 D(I,N)=(DRUDR(I)-V(I))/RSQ(I)
  460 CONTINUE
C
C          CALC P=DPNL/DR AND ALL INTEGRANDS
C
      DR=3.D0*R(2)
      KKK=NKKK(M)
      NBLOKK=KKK/40
      I=1
      P(1)=0.D0
      DO 515 NB=1,NBLOKK
      DO 514 J=1,10
      I=I+4
      B0=PNL(I-3,M)-2.D0*PNL(I-2,M)+PNL(I-1,M)
      B1=PNL(I-2,M)-2.D0*PNL(I-1,M)+PNL(I,M)
      B2=PNL(I-3,M)-PNL(I,M)
      P(I-3)=(-4.5D0*B0-B2)/DR
      P(I-2)=(-1.5D0*B1-B2)/DR
      P(I-1)=(1.5D0*B0-B2)/DR
  514 P(I)=(4.5D0*B1-B2)/DR
      IF (I.GT.IDB) GO TO 515
      DR=DR+DR
  515 CONTINUE
C
      ERAS=(0.5D0/137.036D0)**2
      DO 520 I=1,KKK
      PSQ=PNL(I,M)*PNL(I,M)
      FI(I,1)=PSQ*D(I,1)
      FI(I,2)=PSQ*D(I,2)
      FI(I,3)=PSQ*D(I,3)
      FI(I,4)=PSQ*((EE(M)-V(I))**2)
      FI(I,5)=PNL(I,M)*(R(I)*P(I)-PNL(I,M))*D(I,3)
      ERAS1=1.D0+ERAS*(EE(M)-V(I))
      FI(I,2)=FI(I,3)/ERAS1
      IF (IREL.NE.0) FI(I,5)=FI(I,5)/ERAS1
  520 CONTINUE
      FI(1,4)=4.D0*(FI(2,4)-1.5D0*FI(3,4)+FI(4,4))-FI(5,4)
      FI(1,5)=4.D0*(FI(2,5)-1.5D0*FI(3,5)+FI(4,5))-FI(5,5)
C
C          INTEGRATE
C
      P(1)=0.D0
      P(2)=0.D0
      P(3)=0.D0
      IBO=IB
      N1=3
      IF (L(M).LE.0) N1=4
      DO 530 N=N1,5
      IF (ITPOW.GT.5.AND.N.GE.4) IB=-M
  530 CALL QUAD5(FI(1,N),1,1,KKK,P(N))
      IB=IBO
  550 ZETA(M,1)=2.66246D-5*P(1)
      ZETA(M,2)=2.66246D-5*P(2)
      ZETA(M,3)=2.66246D-5*P(3)
      IF (M.LT.N1SC) GO TO 700
      EVEL(M)=-1.33123D-5*P(4)
      EDAR(M)=-1.33123D-5*P(5)
C
  700 ZETAK1=ZETA(M,1)*109737.31D0
      ZETAK1=ZETA(M,2)
      ZETAK2=ZETA(M,2)*109737.31D0
      ZETAK3=ZETA(M,3)*109737.31D0
      EC=EVEL(M)
      IF (L(M).EQ.0) EC=EC+EDAR(M)
      ETOTRL=ETOTRL+WWNL(M)*EC
      IF (IHF.EQ.1) GO TO 705
      ERLL=EPSS(M)+EC
C          CALL ZETABW TO CALC SPIN-ORBIT INTEGRAL BY THE BLUME-WATSON M
  701 IF (EE(M).LT.0.D0) ZETAK2=ZETABW(M,RM3(M))
  702 ZETAK1=ZETAK2/109737.3D0
      WRITE (9,70) NLBCD(M),WWNL(M),ZETAK1,ZETAK2,ZETA(M,3),ZETAK3,
     1  EI(M),EPSS(M),EVEL(M),EDAR(M),EC,ERLL
   70 FORMAT (1X,A3,F4.0,F12.5,F12.3,F10.5,F12.3,F11.5,F12.5,2F11.5,
     1  F9.3,F12.5)
C
C          STORE ZETA FOR RCG INPUT
C
  705 IF (L(M).LE.0) GO TO 899
      IF (WWNL(M).EQ.0.D0) GO TO 899
      ERAS=4*L(M)+2
      IF (WWNL(M)-ERAS) 720,899,899
  720 NZI=NZI+1
      ZI(NZI)=ZETAK3*0.001D0
  721 ZI(NZI)=ZETAK2*0.001D0
C
  899 CONTINUE
      IF (IREL.NE.0) ETOTRL=0.D0
      RETURN
      END
      SUBROUTINE SLI1
C
C          EVALUATE SLATER RADIAL COULOMB INTEGRALS FK AND GK
C               AND RADIAL OVERLAP INTEGRALS
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      CHARACTER*8 NLBCD(KO),NLBCDO(KO),NLBCD8(KO),IFG(10,9),JFG(10,9),
     1  NLA,NLB
      CHARACTER CONF(3)*6,INPCARD*70
      COMMON/CHAR/CONF,NLBCD,NLBCDO,NLBCD8,IFG,JFG,NLA,NLB,INPCARD
      COMMON XI(KMSH),XJ(KMSH),V(KMSH),RSCORE(KMSH),RSVALE(KMSH),
     1  RECORR(KMSH),RUCORR(KMSH),RC(KMSH),PNLO(KMSH),X1(KMSH),X2(KMSH)
C
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
      COMMON/C3/NPAR,NZI,NFIJ,NGIJ,VPRM(50),KPAR(50),ZI(8),FIJ(30),
     1  GIJ(35),NORB,NORBPT,DH(5),DELTA,NPR
      COMMON/C4/VR(KMSH),QQ0(KMSH),IREL,NITER,NN,LAM,E,END,NODF,I,J,K,
     1  MM,IMATCH,RSINT,RSINT1,HXID,IZHXBW,IPHFWF,IHF,IHF1,NPRINT
      COMMON/C5/IZO,IONO,LBCD(21),MORB(7),IBLANK,WWWNL(39),EEO(KO),
     1  WWNL8(8),EE8,NOELEC,IERROR,WWNLO(KO),N1SC,N1SCF
      COMMON/C6/A0,A1,A2,A3,A4,AB1,AB3,B0,B1,B2,B3,ERAS,ERAS1,ERAS2
      COMMON/C7/T0,T1,T2
      COMMON/C8/NHFTRM,NFG,ETOTRL,EHF(KO),T1HF(9),T2HF(9),ETERM,
     1  NF(9),NG(9),CFG(10,9),FG(10,9),KFG(10,9),RHFMTC(KO),II
      COMMON PNL(KMSH,KO),QNL(KMSHQ,KOQ)
C
      DIMENSION RSQ(KMSH),QQ(KMSH),DELP(KO),ALFM(KO),
     1  S1(10,KO),S2(10,KO),ZETA(KO,3)
      DIMENSION XA(KMSH),XB(KMSH),F1(KMSH),F2(KMSH),RKP1(KMSH),
     1  VPAR(7,KO,KO),EMN(KO,KO),RRYD(10,2),RKAY(10,2),K1(10,2),
     2  FRAC(10,2)
      EQUIVALENCE (RU,      F1), (RUEE,  F2), (RUEXCH,RSQ,XA,EMN),
     1  (RSATOM,QQ,DRUDR,XB), (A,DELP,RRYD), (B,ALFM,RKAY)
      EQUIVALENCE (RSATOM,S1),(RSATOM(251),S2),(RSATOM(501),ZETA)
C
      INTEGER WWWNL,WWNL8
      INTEGER FG
      EQUIVALENCE (V,RKP1),(RSCORE,VPAR)
      DATA JHLF,JHLG/'F','G'/
      DATA JHUF,JHUG/'F','G'/
C
      NPR1=0
      KDMIN=0
      ETERM=0.D0
  120 DO 969 MA=1,NCSPVS
      LA=L(MA)
      I1MAX=NKKK(MA)
      DO 959 MB=MA,NCSPVS
      LB=L(MB)
      I2MAX=NKKK(MB)
      IMAX=MAX0(I1MAX,I2MAX)
      KEMIN=IABS(LA-LB)
      NOKMAX=MIN0(LA,LB)+1
      NE=NOKMAX
      ND=NOKMAX
      IF (MA.NE.MB) GO TO 400
      NE=0
      IF (WWNL(MA).LE.1.D0) ND=0
C
C          CALC PNL-PRODUCTS FOR DIRECT OR EXCHANGE CASE
C
  400 DO 700 N1=1,2
      IF (N1.LE.1) GO TO 420
      IF (NE.LE.0) GO TO 500
      DO 415 I=1,IMAX
      F1(I)=PNL(I,MA)*PNL(I,MB)
  415 F2(I)=F1(I)
      K=KEMIN-2
      GO TO 500
  420 DO 425 I=1,IMAX
      F1(I)=PNL(I,MA)**2
  425 F2(I)=PNL(I,MB)**2
      K=KDMIN-2
      IF (ND.LE.0) GO TO 800
C
C          CALC FOR EACH VALUE OF K
C
  500 DO 700 N=1,NOKMAX
      A1=0.D0
      B1=1.D0
      K=IABS(K+2)
      K1(N,N1)=K
      IF (EE(MA).GE.0.D0.OR.EE(MB).GE.0.D0) GO TO 650
      IF (N1.LT.NE+2) GO TO 520
      K1(N,N1)=0
      GO TO 650
  520 CONTINUE
C
      RKP1(1)=0.001D0
      DO 530 I=2,IMAX
      IF (N.GT.1) GO TO 529
      RKP1(I)=R(I)
      IF (K.LE.0) GO TO 530
      DO 527 M=1,K
  527 RKP1(I)=RKP1(I)*R(I)
      GO TO 530
  529 RKP1(I)=RKP1(I)*R(I)*R(I)
  530 CONTINUE
C
C          CALC R1 INTEGRAL
C
      XI(1)=0.D0
      XJ(1)=0.D0
      XA(1)=0.D0
      XB(1)=0.D0
      A2=0.D0
      B2=0.D0
      HO12=R(2)/12.D0
      NI=40
      DO 550 I=3,I1MAX,2
      A0=A2
      B0=B2
      ERAS=8.D0*F1(I-1)
      A1=ERAS*RKP1(I-1)/R(I-1)
      B1=ERAS/RKP1(I-1)
      A2=F1(I)*RKP1(I)/R(I)
      B2=F1(I)/RKP1(I)
      ERAS=HO12*(5.D0*A0+A1-A2)
      XI(I-1)=XI(I-2)+ERAS
      XA(I-1)=XA(I-2)+DABS(ERAS)
      ERAS=HO12*(5.D0*B0+B1-B2)
      XJ(I-1)=XJ(I-2)+ERAS
      XB(I-1)=XB(I-2)+DABS(ERAS)
      ERAS=HO12*(-A0+A1+5.D0*A2)
      XI(I)=XI(I-1)+ERAS
      XA(I)=XA(I-1)+DABS(ERAS)
      ERAS=HO12*(-B0+B1+5.D0*B2)
      XJ(I)=XJ(I-1)+ERAS
      XB(I)=XB(I-1)+DABS(ERAS)
      NI=NI-2
      IF (NI) 540,540,550
  540 HO12=HO12+HO12
      NI=40
      IF (I.EQ.IDB) NI=10000
  550 CONTINUE
C
      DO 560 I=2,I1MAX
      ERAS=RKP1(I)/R(I)
      XI(I)=XI(I)/RKP1(I)+(XJ(I1MAX)-XJ(I))*ERAS
  560 XA(I)=XA(I)/RKP1(I)+(XB(I1MAX)-XB(I))*ERAS
      IF (I2MAX-I1MAX) 600,600,569
  569 A0=XI(I1MAX)*RKP1(I1MAX)
      B0=XA(I1MAX)*RKP1(I1MAX)
      DO 570 I=I1MAX,I2MAX
      XI(I)=A0/RKP1(I)
  570 XA(I)=B0/RKP1(I)
C
C          CALC R2 INTEGRAL
C
  600 A0=0.D0
      B0=0.D0
      A1=0.D0
      B1=0.D0
      HO3=R(2)/1.5D0
      NI=40
      DO 620 I=3,I2MAX,2
      A2=F2(I)*XI(I)
      B2=DABS(F2(I))*XA(I)
      ERAS=4.D0*F2(I-1)
      A1=A1+HO3*(A0+ERAS*XI(I-1)+A2)
      B1=B1+HO3*(B0+DABS(ERAS)*XA(I-1)+B2)
      A0=A2
      B0=B2
      NI=NI-2
      IF (NI.GT.0) GO TO 620
      HO3=HO3+HO3
      NI=40
      IF (I.EQ.IDB) NI=10000
  620 CONTINUE
C
  650 FRAC(N,N1)=A1/B1
      RRYD(N,N1)=A1
      RKAY(N,N1)=A1*109737.31D0
      IF (NFG.EQ.0) GO TO 700
C          CALC LS-TERM CONTRIBUTION TO E(AV)
      NLA=NLBCD(MA)
      NLB=NLBCD(MB)
      DO 670 J=1,NFG
      IF ((N1.EQ.1.AND.FG(J,II).NE.JHLF.AND.FG(J,II).NE.JHUF).OR.
     1    (N1.EQ.2.AND.FG(J,II).NE.JHLG.AND.FG(J,II).NE.JHUG))
     2  GO TO 670
      IF (K1(N,N1).NE.KFG(J,II)) GO TO 670
      IF ((IFG(J,II).NE.NLA.OR.JFG(J,II).NE.NLB).AND.
     1  (JFG(J,II).NE.NLA.OR.IFG(J,II).NE.NLA)) GO TO 670 
      ETERM=ETERM+CFG(J,II)*A1
  670 CONTINUE
  700 CONTINUE
      IF (IPTVU.LT.3) GO TO 840
C
C          CALC OVERLAP INTEGRALS
C
  800 I=1
      XIF=(R(IMAX)-R(IMAX-1))*5.D0/288.D0
      ERAS=0.D0
      IF (EE(MA).GE.0.D0.OR.EE(MB).GE.0.D0) GO TO 830
  810 IF (I.LE.IDB) ERAS=0.5D0*ERAS
      DO 820 N=1,8
      I=I+5
  820 ERAS=ERAS+19.D0*(F1(I-5)+F1(I))+75.D0*(F1(I-4)+F1(I-1))
     1         +50.D0*(F1(I-3)+F1(I-2))
      IF (I-IMAX) 810,830,830
  830 VPAR(7,MB,MA)=ERAS*XIF
      IF (ND.LE.0) GO TO 959
  840 IF (IPTVU.EQ.0) GO TO 915
      IF (MA.LT.NCSPVS-IABS(NORBPT)+1) GO TO 915
C
C          OUTPUT
C
  899 IF (NPR1) 900,900,905
  900 WRITE (9,90) CONF,NCONF,IZ,ION,KUT,EXF,CORRF,CA1,CA0
   90 FORMAT (17H1SLATER INTEGRALS///1X,3A6,6X,6HNCONF=,I3,6X,2HZ=,I3,
     1  5X,4HION=,I2,5X,4HKUT=,I2,6X,4HEXF=,F5.3,5X,6HCORRF=,F5.3,3X,
     2  4HCA1=,F5.3,7H   CA0=,F5.3//)
  901 WRITE (9,91)
   91 FORMAT (1H0,16X,1HK,19X,2HFK,21X,4HFRAC,9X,1HK,19X,2HGK,21X,
     1  4HFRAC)
      WRITE (9,92)
   92 FORMAT (1H ,16X,39H-   -----------------------------------,
     1  8H   -----,9X,39H-   -----------------------------------,
     2  8H   -----//)
  905 NPR1=NPR1+NOKMAX+1
      IF (NPR1-50) 910,910,906
  906 NPR1=0
      GO TO 900
  910 DO 911 N=1,NOKMAX
  911 WRITE (9,93) NLBCD(MA),NLBCD(MB), (K1(N,N1),RRYD(N,N1),RKAY(N,N1),
     1  FRAC(N,N1), N1=1,2)
   93 FORMAT (2H (,A3,1H,,A3,1H),I8,F13.7,7H RYD  =,F13.3,5H CM-1,F8.3,
     1  I10,F13.7,7H RYD  =,F13.3,5H CM-1,F8.3)
      WRITE (9,94)
   94 FORMAT (1H )
C
C          STORE SLATER INTEGRALS FOR RCG INPUT
C
  915 A1=4*L(MA)+1
      A2=4*L(MB)+1
      IF (WWNL(MA).GT.A1) GO TO 950
      IF (MA.NE.MB) GO TO 930
      IF (WWNL(MA).LE.1.D0) GO TO 950
      IF (WWNL(MA).GE.A1) GO TO 950
      DO 924 I=2,NOKMAX
      NPAR=NPAR+1
      KPAR(NPAR)=1
  924 VPRM(NPAR)=RKAY(I,1)*0.001D0
      GO TO 950
  930 IF (WWNL(MB).GT.A2) GO TO 950
      IF (WWNL(MA).EQ.0.D0.OR.WWNL(MB).EQ.0.D0) GO TO 950
      DO 934 I=1,NOKMAX
      IF (K1(I,1).LE.0) GO TO 933
      NFIJ=NFIJ+1
      FIJ(NFIJ)=RKAY(I,1)*0.001D0
  933 NGIJ=NGIJ+1
  934 GIJ(NGIJ)=RKAY(I,2)*0.001D0
C
  950 IF (MA.NE.MB) GO TO 955
      DO 953 I=1,NOKMAX
  953 VPAR(I,MA,MB)=RRYD(I,1)
      GO TO 959
  955 VPAR(1,MA,MB)=RRYD(1,1)
      DO 956 I=1,NOKMAX
  956 VPAR(I+1,MA,MB)=RRYD(I,2)
  959 CONTINUE
C
  969 CONTINUE
C
      CALL RCN3S
  980 RETURN
      END
      SUBROUTINE RCN3S
C
C          CALCULATE IONIZATION POTENTIALS AND TOTAL ENERGIES
C           FROM VALUES OF SLATER COULOMB INTEGRALS
C
C
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      CHARACTER*8 NLBCD(KO),NLBCDO(KO),NLBCD8(KO),IFG(10,9),JFG(10,9),
     1  NLA,NLB
      CHARACTER CONF(3)*6,INPCARD*70
      COMMON/CHAR/CONF,NLBCD,NLBCDO,NLBCD8,IFG,JFG,NLA,NLB,INPCARD
      COMMON XI(KMSH),XJ(KMSH),V(KMSH),RSCORE(KMSH),RSVALE(KMSH),
     1  RECORR(KMSH),RUCORR(KMSH),RC(KMSH),PNLO(KMSH),X1(KMSH),X2(KMSH)
C
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
      COMMON/C3/NPAR,NZI,NFIJ,NGIJ,VPRM(50),KPAR(50),ZI(8),FIJ(30),
     1  GIJ(35),NORB,NORBPT,DH(5),DELTA,NPR
      COMMON/C4/VR(KMSH),QQ0(KMSH),IREL,NITER,NN,LAM,E,END,NODF,I,J,K,
     1  MM,IMATCH,RSINT,RSINT1,HXID,IZHXBW,IPHFWF,IHF,IHF1,NPRINT
      COMMON/C5/IZO,IONO,LBCD(21),MORB(7),IBLANK,WWWNL(39),EEO(KO),
     1  WWNL8(8),EE8,NOELEC,IERROR,WWNLO(KO),N1SC,N1SCF
      COMMON/C6/A0,A1,A2,A3,A4,AB1,AB3,B0,B1,B2,B3,ERAS,ERAS1,ERAS2
      COMMON/C7/T0,T1,T2
      COMMON/C8/NHFTRM,NFG,ETOTRL,EHF(KO),T1HF(9),T2HF(9),ETERM,
     1  NF(9),NG(9),CFG(10,9),FG(10,9),KFG(10,9),RHFMTC(KO),II
      COMMON/BRT/EMAG,ERET,FMI(10,3),FNI(10,4),FNORM(KO)
      COMMON PNL(KMSH,KO),QNL(KMSHQ,KOQ)
C
      DIMENSION RSQ(KMSH),QQ(KMSH),DELP(KO),ALFM(KO),
     1  S1(10,KO),S2(10,KO),ZETA(KO,3)
      DIMENSION XA(KMSH),XB(KMSH),F1(KMSH),F2(KMSH),RKP1(KMSH),
     1  VPAR(7,20,KO),EMN(KO,KO),RRYD(10,2),RKAY(10,2)
      EQUIVALENCE (RU,      F1), (RUEE,  F2), (RUEXCH,RSQ,XA,EMN),
     1  (RSATOM,QQ,DRUDR,XB), (A,DELP,RRYD), (B,ALFM,RKAY)
      EQUIVALENCE (RSATOM,S1),(RSATOM(251),S2),(RSATOM(501),ZETA)
C
      INTEGER WWWNL,WWNL8
      INTEGER FG
      EQUIVALENCE (V,RKP1),(RSCORE,VPAR)
C
      RDB=R(IDB)
      IF (IPTVU.LT.3) GO TO 200
C
C          PRINT OVERLAP INTEGRALS
C
  100 WRITE (9,30) CONF,NCONF,IZ,NCORES,NVALES,ION,C,CA1
      WRITE (9,10)
   10 FORMAT (18H0OVERLAP INTEGRALS)
      N2=MIN0(NCSPVS,12)
      WRITE (9,33) (NLBCD(N), N=1,N2)
      WRITE (9,35)
      DO 120 M=1,NCSPVS
      N2=MIN0(M,12)
  120 WRITE (9,12) NLBCD(M), (VPAR(7,M,N), N=1,N2)
   12 FORMAT (1H ,A3,F12.5,11F9.5)
      IF (NCSPVS.LE.12) GO TO 200
      WRITE (9,33) (NLBCD(N), N=13,NCSPVS)
      WRITE (9,35)
      DO 140 M=13,NCSPVS
  140 WRITE (9,12) NLBCD(M), (VPAR(7,M,N), N=13,M)
C
C          CALC COEFS OF SLATER PARAMETERS, AND INTERACTION ENERGIES
C
  200 DO 250 M=1,NCSPVS
      B(M)=0.D0
      FLM=L(M)
      IF (WWNL(M).GT.1.D0) GO TO 202
      EMN(M,M)=0.D0
      GO TO 220
  202 EMN(M,M)=VPAR(1,M,M)
      IF (L(M).LE.0) GO TO 220
      IM=L(M)+1
      FK=0.D0
      DO 206 I=2,IM
      FK=FK+2.D0
      COEF=-S3J0SQ(FLM,FK,FLM)*(2.D0*FLM+1.D0)/(4.D0*FLM+1.D0)
  206 EMN(M,M)=EMN(M,M)+COEF*VPAR(I,M,M)
C
  220 N1=M+1
      IF (N1.GT.NCSPVS) GO TO 250
      DO 240 N=N1,NCSPVS
      FLN=L(N)
      K=IABS(L(M)-L(N))-2
      FK=K
      EMN(M,N)=VPAR(1,M,N)
      IM=(L(M)+L(N)-K)/2+1
      DO 225 I=2,IM
      FK=FK+2.D0
      COEF=-S3J0SQ(FLM,FK,FLN)/2.D0
  225 EMN(M,N)=EMN(M,N)+COEF*VPAR(I,M,N)
      EMN(N,M)=EMN(M,N)
  240 CONTINUE
  250 CONTINUE
C
      N=NCSPVS
      IF (EE(N).LT.0.D0) GO TO 300
      DO 265 M=1,N
      EMN(M,N)=0.D0
  265 EMN(N,M)=0.D0
      EVEL(N)=0.D0
      EDAR(N)=0.D0
      ECORR(N)=0.D0
      UCORR(N)=0.D0
      EPSS(N)=0.D0
C
  300 IF (IPTVU.EQ.0) GO TO 400
      WRITE (9,30) CONF,NCONF,IZ,NCORES,NVALES,ION,C,CA1
   30 FORMAT (3H1  ,3A6,2X,10H    NCONF=,I3,6H    Z=,I3,11H    NCORES=,
     1  I2,11H    NVALES=,I2, 8H    ION=,I2, 14H    R(I)/X(I)=,F10.8,
     2  6X,4HCA1=,F5.3)
      WRITE (9,31) TOLSTB,TOLKM2,TOLEND,THRESH,KUT, EXF,CORRF,CA0,IHF1,
     1  MESH,IDB,RDB,EMX,R(MESH),IREL
   31 FORMAT (/8H0TOLSTB=,F5.3,3X,7HTOLK-2=,F7.5,3X,7HTOLEND=,E8.1,
     1  3X,7HTHRESH=,E8.1,3X,4HKUT=,I2,4X,4HEXF=,F5.3,9H   CORRF=,F5.3,
     2  6X,4HCA0=,F6.3//18H0RCN MOD 36  IHF1=,I2,
     3  10X,5HMESH=,I4,3X,4HIDB=,I4,3X,4HRDB=,F8.3,3X,4HEMX=,F7.2,
     4  3X,8HR(MESH)=,F8.3,5X,5HIREL=,I2)
      IF (IPTVU.EQ.1) GO TO 400
      WRITE (9,32)
   32 FORMAT (21H0INTERACTION ENERGIES)
      N2=MIN0(NCSPVS,12)
      WRITE (9,33) (NLBCD(N), N=1,N2)
   33 FORMAT (///5H     ,12(6X,A3))
      WRITE (9,35)
      DO 320 M=1,NCSPVS
      N2=MIN0(M,12)
  320 WRITE (9,34) NLBCD(M), (EMN(M,N), N=1,N2)
   34 FORMAT (1H ,A3,F12.4,11F9.4)
      IF (NCSPVS.LE.12) GO TO 400
      WRITE (9,33) (NLBCD(N), N=13,NCSPVS)
      WRITE (9,35)
   35 FORMAT (1H )
      DO 340 M=13,NCSPVS
  340 WRITE (9,34) NLBCD(M), (EMN(M,N), N=13,M)
      IF (NCSPVS.LE.12) GO TO 400
      WRITE (9,30) CONF,NCONF,IZ,NCORES,NVALES,ION,C,CA1
      WRITE (9,31) TOLSTB,TOLKM2,TOLEND,THRESH,KUT, EXF,CORRF,CA0,IHF1,
     1  MESH,IDB,RDB,EMX,R(MESH),IREL
C
C          CALC IONIZATION POTENTIALS, EPS(M), AND TOTAL CORRELATION ENE
C
  400 WRITE (9,40)
   40 FORMAT (  //1H0,12X,19HWITHOUT CORRELATION,16X,16HWITH CORRELATION
     1  /11X,23H-----------------------,11X,23H-----------------------/
     2  8H  NL WNL,6X,6HEPS FG,6X,7HEPS FGR,4X,4HCORR,7X,6HEPS FG,6X,
     3  7HEPS FGR,5X,3HN*R,5X,4HN*RC,5X,3HECT,5X,19HEC-----------------,
     4  /)
      ECT=0.D0
      XI(1)=0.D0
      FION=ION+1
      DO 405 I=1,MESH
  405 XJ(I)=0.D0
      DO 460 M=1,NCSPVS
  409 A0=0.D0
      DO 412 NP=1,NCSPVS
      N=NCSPVS+1-NP
      ERAS=WWNL(N)
      IF (M.NE.N) GO TO 411
      ERAS=ERAS-1.D0
  411 A0=A0+ERAS*EMN(M,N)
  412 A(N,1)=A0
      EPS2=EI(M)+A0
      EVD=0.D0
      IF (IREL.NE.0) GO TO 415
      EVD=EVEL(M)
      IF (L(M).EQ.0) EVD=EVD+EDAR(M)
  415 EPSCOR=ECORR(M)
      EPS1C=EPSS(M)
      EPS1=EPS1C-EPSCOR
      EPS2C=EPS2+EPSCOR
      EPS1R=EPS1+EVD
      EPS2R=EPS2+EVD
      EPS1CR=EPS1C+EVD
      EPS2CR=EPS2C+EVD
      EHF(M)=DABS(EPS2)
      FNSTR=0.D0
      FNSTRC=0.D0
      IF (EPS2.GE.0.D0) GO TO 420
      FNSTR=FION/DSQRT(-EPS2R)
      FNSTRC=FION/DSQRT(-EPS2CR)
  420 K=WWNL(M)
      KKK=NKKK(M)
      DO 426 I=1,KKK
      XJ(I)=0.D0
      DO 424 MM=1,NCSPVS
      IF (MM.EQ.M) GO TO 424
      IF (EE(MM).GE.EE(M)) GO TO 424
      XJ(I)=XJ(I)+WWNL(MM)*(PNL(I,MM)**2)
  424 CONTINUE
  426 CONTINUE
      DO 440 LP=1,K
      AX=0.D0
      IF (EE(M).GE.0.D0) GO TO 439
      DO 435 I=2,KKK
      ERAS2=PNL(I,M)**2
      ERAS1=R(I)
      ERAS=XJ(I)
      CALL SUBCOR
      XI(I)=B1*ERAS2/R(I)
  435 XJ(I)=XJ(I)+ERAS2
      CALL QUAD5(XI,1,1,KKK,AX)
  439 KK=MIN0(LP,5)
      ECM(KK)=AX
      ECT=ECT+AX
  440 CONTINUE
      WRITE (9,44) NLBCD(M),WWNL(M),EPS2,EPS2R,EPSCOR,EPS2C,EPS2CR,
     1  FNSTR,FNSTRC, ECT, (ECM(K), K=1,KK)
   44 FORMAT (1X,A3,F4.0,2F13.5,F8.5,2F13.5,2F8.4,2F10.5,4F7.4)
      ETVD=ETOTRL
      DO 450 MP=1,NCSPVS
      ERAS=A(MP,1)*WWNL(M)
      IF (M.LT.MP) GO TO 450
      ERAS=0.5*ERAS
  450 B(MP)=B(MP)+ERAS
      EEO(M)=EE(M)
      IF (M.GE.N1SC) EE(M)=EPS2CR
  460 CONTINUE
      ETVD=ETOTRL
      EMAG=0.D0
      ERET=0.D0
      IF (IREL.EQ.2) CALL EBREIT
C
C          CALC TOTAL BINDING ENERGY
C
  500 A0=0.D0
      B0=0.D0
      ERAS=0.D0
      DO 501 MP=1,NCSPVS
      M=NCSPVS+1-MP
      TEMP=1.D0
      IF (IREL.NE.0) TEMP=0.D0
      ERAS=ERAS+TEMP*(EVEL(M)+EDAR(M))*WWNL(M)
      EREL(M)=ERAS
      A0=A0+EI(M)*WWNL(M)
      A(M,1)=A0+B(M)
      B0=B0+ECORR(M)*WWNL(M)
  501 B(M)=B0
      ET2=A(1,1)+ETERM
      ET1C=ETOT+ETERM
      ET1=ET1C-ECORRT
      ET2C=ET2+ECORRT
      ET3C=ET2+ECT
      ET1R=ET1+ETVD
      ET2R=ET2+ETVD
      ET1CR=ET1C+ETVD
      ET2CR=ET2C+ETVD
      ET3CR=ET3C+ETVD
      ET4CR=ET3CR+EMAG+ERET
      WRITE (9,49) ECORRT,ECT,ETOTRL, EMAG,ERET
   49 FORMAT (/1H0,24X,7HECORRT=,F10.5,6H (OLD),16X,4HECT=,F10.5,
     1  6H (NEW),6X,7HETOTRL=,F13.5,2H +,F9.5,2H +,F9.5)
      WRITE (9,50)    ET2,ET2R,ET2C,ET2CR,ET3C,ET3CR,ET4CR
   50 FORMAT( /8H   ETOT=,2F13.5,F21.5,4F13.5)
C          STORE EAV FOR RCG INPUT
C
      VPRM(1)=ET4CR-ETERM
C
C
C          PRINT RCG INPUT PARAMETER VALUES
C
  550 IF (NZI.LE.0) GO TO 560
      DO 552 I=1,NZI
      NPAR=NPAR+1
      KPAR(NPAR)=2
  552 VPRM(NPAR)=ZI(I)
  560 IF (NFIJ.LE.0) GO TO 570
      DO 562 I=1,NFIJ
      NPAR=NPAR+1
      KPAR(NPAR)=3
  562 VPRM(NPAR)=FIJ(I)
  570 IF (NGIJ.LE.0) GO TO 580
      DO 572 I=1,NGIJ
      NPAR=NPAR+1
      KPAR(NPAR)=4
  572 VPRM(NPAR)=GIJ(I)
C
  580 WRITE (9,57)CONF,NPAR, (VPRM(I),KPAR(I), I=1,NPAR)
   57 FORMAT (//1H ,3A6,I6,F12.4,I2,4(F10.4,I2)/1X,7(F10.4,I2)/
     1  1X,7(F10.4,I2)/1X,7(F10.4,I2)/1X,7(F10.4,I2))
C
  600 RETURN
      END
      FUNCTION S3J0SQ(FJ1,FJ2,FJ3)
C
C          CALC SQUARE OF 3-J SYMBOL WITH ZERO MAGNETIC QUANTUM NUMBERS
C
      IMPLICIT REAL*8 (A-H,O-Z)
C
      FJ=FJ1+FJ2+FJ3
      A=FJ-FJ1-FJ1
      B=FJ-FJ2-FJ2
      C=FJ-FJ3-FJ3
      S3J0SQ=FCTRL(A)*FCTRL(B)*FCTRL(C)/FCTRL(FJ+1.D0)
      A=FCTRL(A*0.5D0)*FCTRL(B*0.5D0)*FCTRL(C*0.5D0)/FCTRL(FJ*0.5D0)
      S3J0SQ=S3J0SQ/(A*A)
      RETURN
      END
      FUNCTION FCTRL(A)
C
C          CALCULATE FACTORIAL OF A
C
      IMPLICIT REAL*8 (A-H,O-Z)
C
      FCTRL=1.D0
      IF (DABS(A)-0.1D0) 10,10,11
   10 A=0.D0
   11 IF (A) 12,15,13
   12 FCTRL=0.D0
      GO TO 15
   13 IMAX=A+0.1D0
      DO 14 I=1,IMAX
   14 FCTRL=FCTRL*FLOAT(I)
   15 RETURN
      END
      SUBROUTINE HFWRTP
C
C     SUBROUTINE WRITTEN BY D.C.GRIFFIN TO CONVERT HX OUTPUT TO HF INPUT
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      CHARACTER*8 NLBCD(KO),NLBCDO(KO),NLBCD8(KO),IFG(10,9),JFG(10,9),
     1  NLA,NLB
      CHARACTER CONF(3)*6,INPCARD*70
      COMMON/CHAR/CONF,NLBCD,NLBCDO,NLBCD8,IFG,JFG,NLA,NLB,INPCARD
      COMMON XI(KMSH),XJ(KMSH),V(KMSH),RSCORE(KMSH),RSVALE(KMSH),
     1  RECORR(KMSH),RUCORR(KMSH),RC(KMSH),PNLO(KMSH),X1(KMSH),X2(KMSH)
C
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
      COMMON/C3/NPAR,NZI,NFIJ,NGIJ,VPRM(50),KPAR(50),ZI(8),FIJ(30),
     1  GIJ(35),NORB,NORBPT,DH(5),DELTA,NPR
      COMMON/C4/VR(KMSH),QQ0(KMSH),IREL,NITER,NN,LAM,E,END,NODF,I,J,K,
     1  MM,IMATCH,RSINT,RSINT1,HXID,IZHXBW,IPHFWF,IHF,IHF1,NPRINT
      COMMON/C5/IZO,IONO,LBCD(21),MORB(7),IBLANK,WWWNL(39),EEO(KO),
     1  WWNL8(8),EE8,NOELEC,IERROR,WWNLO(KO),N1SC,N1SCF
      COMMON/C6/A0,A1,A2,A3,A4,AB1,AB3,B0,B1,B2,B3,ERAS,ERAS1,ERAS2
      COMMON/C7/T0,T1,T2
      COMMON/C8/NHFTRM,NFG,ETOTRL,EHF(KO),T1HF(9),T2HF(9),ETERM,
     1  NF(9),NG(9),CFG(10,9),FG(10,9),KFG(10,9),RHFMTC(KO),II
      COMMON PNL(KMSH,KO),QNL(KMSHQ,KOQ)
C
      DIMENSION RSQ(KMSH),QQ(KMSH),DELP(KO),ALFM(KO),
     1  S1(10,KO),S2(10,KO),ZETA(KO,3)
      EQUIVALENCE (RU,      F1), (RUEE,  F2), (RUEXCH,RSQ,XA,EMN),
     1  (RSATOM,QQ,DRUDR,XB), (A,DELP,RRYD), (B,ALFM,RKAY)
      EQUIVALENCE (RSATOM,S1),(RSATOM(251),S2),(RSATOM(501),ZETA)
C
      INTEGER WWWNL,WWNL8
      INTEGER FG
      DIMENSION MAXI(KO),RHF(200),PHF(KO,200)
      EQUIVALENCE (RUEXCH,MAXI),(XI,RHF),(V,PHF)
C
C
C
  200 RHOHF=-3.D0
      H=.0625D0
      NO=200
      RHOI=RHOHF
      DO 250 I=1,NO
      RHF(I)=DEXP(RHOI)/Z
  250 RHOI=RHOI+H
      NOTEMP=NO
      IF (RHF(200).GT.R(MESH)) NOTEMP=DLOG(R(MESH)/RHF(1))/H
      NUFSH=0
      DO 270 I=1,NCSPVS
      IF(WWNL(I).EQ.(4.*FLOAT(L(I))+2.)) GO TO 270
      NUFSH=NUFSH+1
  270 CONTINUE
      WRITE (7) CONF,NCONF,IZ,Z,NCSPVS,RHOHF,H,NO,NHFTRM,IREL,ETOTRL,
     1  NUFSH,IZHXBW,NS,IPHFWF
C
      IF (NHFTRM.EQ.0) GO TO 502
      DO 501 I=1,NHFTRM
      NFG=NF(I)+NG(I)
  501 WRITE (7) T2HF(I),NF(I),NG(I),NFG,
     1  (CFG(J,I),FG(J,I),KFG(J,I),IFG(J,I),JFG(J,I),J=1,NFG)
C
  502 DO 503 I=1,NCSPVS
      J=IMAT(I)
      RHFMTC(I)=R(J)
      MSEND=NKKK(I)
      REND=R(MSEND)
      MAX=DLOG(REND/RHF(1))/H
      IF(MAX.GT.NOTEMP) MAX=NOTEMP
      MAXI(I)=MAX
  503 WRITE (7) NLBCD(I),WWNL(I),AZ(I),EHF(I),RHFMTC(I),MAX
C
      JMIN=2
      DO 510 I=1,NO
      DO 504 M=1,NCSPVS
  504 PHF(M,I)=0.D0
      DO 508 J=JMIN,MESH
      IF (RHF(I).GT.R(J)) GO TO 508
      JM2=J-2
      JM1=J-1
      IF (MOD(JM2,40).EQ.0.AND.JM2.LT.IDB) JM2=J-3
      U=(RHF(I)-R(JM2))/(R(JM1)-R(JM2))
      U2=0.5D0*U*(U-1.D0)
      RHM1=1.D0/DSQRT(RHF(I))
      DO 506 M=1,NCSPVS
      IF (I.GT.MAXI(M).OR.NNN(M).GT.90) GO TO 506
      DEL1=PNL(JM1,M)-PNL(JM2,M)
      DEL2=PNL(J,M)-PNL(JM1,M)
      PHF(M,I)=(PNL(JM2,M)+DEL1*U+(DEL2-DEL1)*U2)*RHM1
  506 CONTINUE
      GO TO 509
  508 CONTINUE
  509 JMIN=J-1
  510 CONTINUE
  520 WRITE (7) (RHF(I),I=1,NO), ((PHF(I,J),J=1,NO), I=1,NCSPVS)
C
      MESHI=MIN0(MESH,1001)
      IF (NNN(NCSPVS).GT.10) WRITE (7) MESHI,IDB,
     1  (R(J),PNL(J,NCSPVS), J=1,MESHI)
C
      IF (IHF.LT.3) GO TO 700
      IDEL=1
      IF (IPHFWF.LT.0) IDEL=4
      WRITE(9,103)
  103 FORMAT (1H1,50X,22HHF INPUT WAVEFUNCTIONS)
      NPWFTP=NCSPVS-10
      IF (NPWFTP.LT.1) NPWFTP=1
      WRITE(9,104) (NLBCD(I),I=NPWFTP,NCSPVS)
  104 FORMAT (13X,3HRHF,6X,A3,10(7X,A3))
      DO 14 I=1,NO,IDEL
      ERAS=DSQRT(RHF(I))
      DO 15 J=NPWFTP,NCSPVS
      PHF(J,I)=PHF(J,I)*ERAS
   15 CONTINUE
   14 CONTINUE
      DO 13 I=1,NO,IDEL
      WRITE (9,102) I,RHF(I),(PHF(J,I),J=NPWFTP,NCSPVS)
  102 FORMAT (I5,F12.5,11F10.5)
   13 CONTINUE
  700 RETURN
      END
      SUBROUTINE HFPOT(M)
C
C          CALCULATE HARTREE-FOCK POTENTIAL TERMS OVER AND ABOVE
C               THE CLASSICAL POTENTIAL
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      CHARACTER*8 NLBCD(KO),NLBCDO(KO),NLBCD8(KO),IFG(10,9),JFG(10,9),
     1  NLA,NLB
      CHARACTER CONF(3)*6,INPCARD*70
      COMMON/CHAR/CONF,NLBCD,NLBCDO,NLBCD8,IFG,JFG,NLA,NLB,INPCARD
      COMMON XI(KMSH),XJ(KMSH),V(KMSH),RSCORE(KMSH),RSVALE(KMSH),
     1  RECORR(KMSH),RUCORR(KMSH),RC(KMSH),PNLO(KMSH),X1(KMSH),X2(KMSH)
C
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
      COMMON/C3/NPAR,NZI,NFIJ,NGIJ,VPRM(50),KPAR(50),ZI(8),FIJ(30),
     1  GIJ(35),NORB,NORBPT,DH(5),DELTA,NPR
      COMMON/C4/VR(KMSH),QQ0(KMSH),IREL,NITER,NN,LAM,E,END,NODF,I,J,K,
     1  MM,IMATCH,RSINT,RSINT1,HXID,IZHXBW,IPHFWF,IHF,IHF1,NPRINT
      COMMON/C8/NHFTRM,NFG,ETOTRL,EHF(KO),T1HF(9),T2HF(9),ETERM,
     1  NF(9),NG(9),CFG(10,9),FG(10,9),KFG(10,9),RHFMTC(KO),II
      COMMON PNL(KMSH,KO),QNL(KMSHQ,KOQ)
      COMMON/LC2/RA(KMSH),RB(KMSH)
C
      INTEGER FG
      DATA JHLF,JHLG/'F','G'/
      DATA JHUF,JHUG/'F','G'/
C
      KKK1=MIN0(NKKK(M)+40,MESH)
      KKK=KKK1
      X1(1)=0.D0
      X2(1)=0.D0
      DO 110 I=1,MESH
      RA(I)=0.D0
  110 RB(I)=0.D0
      IF (NITER.EQ.1.AND.EE(M).GT.0.D0) GO TO 455
      IF ((WWNL(M).LT.2.D0.AND.NHFTRM.EQ.0).OR.L(M).EQ.0) GO TO 300
C          CALC DIRECT TERMS
      FL=L(M)
      C1=(WWNL(M)-1.D0)*(4.D0*FL+2.D0)/(4.D0*FL+1.D0)
      DO 149 M1=1,NCSPVS
      IF (EE(M1).GT.0.D0) GO TO 149
      KX=2*L(M1)
      IF (KX.LT.2) GO TO 149
      FULL=2*KX+2
      KKK=NKKK(M1)
      DO 120 I=1,KKK
  120 XJ(I)=PNL(I,M1)**2
      DO 140 K=2,KX,2
      FK=K
      C2=0.D0
      IF (NHFTRM.EQ.0.OR.WWNL(M1).EQ.FULL) GO TO 125
      IF (NFG.LE.0) GO TO 125
C               LS-DEPENDENT TERMS
      DO 123 J=1,NFG
      IF ((FG(J,II).NE.JHLF.AND.FG(J,II).NE.JHUF).OR.KFG(J,II).NE.K)
     1  GO TO 123
      IF ((IFG(J,II).EQ.NLBCD(M1).AND.JFG(J,II).EQ.NLBCD(M)).OR
     1   .(JFG(J,II).EQ.NLBCD(M1).AND.IFG(J,II).EQ.NLBCD(M)))
     2    C2=-2.D0*CFG(J,II)/WWNL(M)
  123 CONTINUE
C
  125 IF (M1.NE.M) GO TO 128
      C2=2.D0*C2
      C3=C2
      C2=C2+C1*S3J0SQ(FL,FK,FL)
  128 CONTINUE
      IF (C2.EQ.0.D0) GO TO 140
      CALL QUADK(M,1)
      DO 130 I=3,KKK,2
      ERAS=R(I)**K
      ERAS=X1(I)/ERAS+ERAS*R(I)*(X2(KKK)-X2(I))
  130 RA(I)=RA(I)+C2*ERAS
  140 CONTINUE
  149 CONTINUE
      KKK=KKK1
      DO 150 I=3,KKK,4
      B0=(RA(I)-RA(I-2)+RA(I)-RA(I+2))*0.125D0
      RA(I-1)=0.5D0*(RA(I)+RA(I-2))+B0
  150 RA(I+1)=0.5D0*(RA(I)+RA(I+2))+B0
      IF (RA(5).EQ.0.D0.OR.RA(9).EQ.0.D0) GO TO 300
      RA(2)=(RA(3)**2)/RA(5)
      RA(4)=RA(5)*RA(7)/RA(9)
C          CALC EXCHANGE TERMS
  300 IF (NCSPVS.EQ.1) GO TO 455
      FL2=L(M)
      DO 400 M1=1,NCSPVS
      IF (M1.EQ.M) GO TO 400
      IF (EE(M1).GT.0.D0) GO TO 400
      FULL=4*L(M1)+2
      KKK=MIN0(NKKK(M1),NKKK(M))
      FL1=L(M1)
      DO 320 I=1,KKK
  320 XJ(I)=PNL(I,M1)*PNL(I,M)
      KN=IABS(L(M1)-L(M))
      KX=L(M1)+L(M)
      DO 340 K=KN,KX,2
      FK=K
      C2=0.D0
      IF (NHFTRM.EQ.0.OR.WWNL(M1).EQ.FULL) GO TO 325
      IF (NFG.LE.0) GO TO 325
C               LS-DEPENDENT TERMS
      DO 323 J=1,NFG
      IF ((FG(J,II).NE.JHLG.AND.FG(J,II).NE.JHUG).OR.KFG(J,II).NE.K) 
     1  GO TO 323
      IF ((IFG(J,II).EQ.NLBCD(M1).AND.JFG(J,II).EQ.NLBCD(M)).OR
     1   .(JFG(J,II).EQ.NLBCD(M1).AND.IFG(J,II).EQ.NLBCD(M)))
     2    C2=-2.D0*CFG(J,II)/WWNL(M)
  323 CONTINUE
C
  325 C2=C2+WWNL(M1)*S3J0SQ(FL1,FK,FL2)
      CALL QUADK(M,1)
      DO 330 I=3,KKK,2
      ERAS=R(I)**K
      ERAS=X1(I)/ERAS+ERAS*R(I)*(X2(KKK)-X2(I))
  330 RB(I)=RB(I)+C2*ERAS*PNL(I,M1)
  340 CONTINUE
  400 CONTINUE
      KKK=KKK1
      DO 450 I=3,KKK,4
      B0=(RB(I)-RB(I-2)+RB(I)-RB(I+2))*0.125D0
      RB(I-1)=0.5D0*(RB(I)+RB(I-2))+B0
  450 RB(I+1)=0.5D0*(RB(I)+RB(I+2))+B0
      IF (RB(5).EQ.0.D0.OR.RB(9).EQ.0.D0) GO TO 455
      RB(2)=(RB(3)**2)/RB(5)
      RB(4)=RB(5)*RB(7)/RB(9)
C
  455 FRAC=0.01D0
      PMAX=0.D0
      DO 458 I=2,KKK
      ERAS=PNL(I,M)
      PMAX=DMAX1(PMAX,DABS(FRAC*ERAS))
      IF (ERAS.GE.0.D0.AND.ERAS.LT.PMAX) ERAS=PMAX
      IF (ERAS.LT.0.D0.AND.ERAS.GT.-PMAX) ERAS=-PMAX
  458 RB(I)=RB(I)/ERAS
      IDEL=1
      IDEL2=IDEL*2
      KM10=KKK-10
      DO 465 I=10,KM10
      IF (PNL(I,M)*PNL(I+1,M).GT.0.D0) GO TO 465
      ERAS=(RB(I+1+IDEL)-RB(I-IDEL))/(R(I+1+IDEL)-R(I-IDEL))
      DO 462 J=1,IDEL2
  462 RB(I-IDEL+J)=RB(I-IDEL)+ERAS*(R(I-IDEL+J)-R(I-IDEL))
  465 CONTINUE
      DO 468 I=2,KKK
  468 XJ(I)=RU(I)-XI(I)-EXF10*RUEXCH(I)-RA(I)-RB(I)
      IF (KKK.GE.MESH) GO TO 480
      DO 470 I=KKK,MESH
  470 XJ(I)=XJ(KKK)
  480 CONTINUE
      IF (END.GT.0.D0.AND.IPTVU.GE.5) WRITE (9,46) M,K,KKK,
     1  (RA(I),I=2,KKK),(RB(I),I=2,KKK),(XJ(I),I=2,KKK)
   46 FORMAT (1H0/3I10/(10F12.4))
      RETURN
      END
      SUBROUTINE QUADK(M,KK)
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      COMMON XI(KMSH),XJ(KMSH),V(KMSH),RSCORE(KMSH),RSVALE(KMSH),
     1  RECORR(KMSH),RUCORR(KMSH),RC(KMSH),PNLO(KMSH),X1(KMSH),X2(KMSH)
C
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
      COMMON/C3/NPAR,NZI,NFIJ,NGIJ,VPRM(50),KPAR(50),ZI(8),FIJ(30),
     1  GIJ(35),NORB,NORBPT,DH(5),DELTA,NPR
      COMMON/C4/VR(KMSH),QQ0(KMSH),IREL,NITER,NN,LAM,E,END,NODF,I,J,K,
     1  MM,IMATCH,RSINT,RSINT1,HXID,IZHXBW,IPHFWF,IHF,IHF1,NPRINT
      COMMON/LC2/RA(KMSH),RB(KMSH)
C
C       CALCULATE  CONST*YK FUNCTION   (INTEGRATE BY SIMPSONS RULE)
C
  510 DO 511 I=2,KKK
      ERAS=R(I)**K
      X1(I)=ERAS*XJ(I)
  511 X2(I)=XJ(I)/(ERAS*(R(I)**KK))
  512 X1(1)=0.D0
      X2(1)=2.D0*X2(2)-X2(3)
      IF (DABS(X2(1)).LT.0.2D0*DABS(X2(2))) X2(1)=0.D0
C
      HO3=R(2)/3.D0
      I=1
      B12=X1(1)
      B22=X2(1)
      X2(1)=0.D0
      DO 515 J=1,NBLOCK
      DO 513 K1=1,20
      I=I+2
      IF (I.GT.KKK) GO TO 520
      B10=B12
      B12=X1(I)
      X1(I)=X1(I-2)+HO3*(B10+4.D0*X1(I-1)+B12)
      B20=B22
      B22=X2(I)
  513 X2(I)=X2(I-2)+HO3*(B20+4.D0*X2(I-1)+B22)
      IF (I.GT.IDB) GO TO 515
      HO3=HO3+HO3
  515 CONTINUE
  520 KKK1=KKK
      IF (M.LE.25) KKK=MIN0(NKKK(M)+40,MESH)
      IF (M.GT.25) KKK=MIN0(KKK+40,MESH)
      DO 527 I=KKK1,KKK,2
      X1(I)=X1(KKK1)
  527 X2(I)=X2(KKK1)
      KKK=KKK1
  530 N=2
      IF (M.LT.31) GO TO 600
C
      DO 550 I=3,KKK,4
      B0=(X1(I)-X1(I-2)+X1(I)-X1(I+2))*0.125D0
      X1(I-1)=0.5D0*(X1(I)+X1(I-2))+B0
      X1(I+1)=0.5D0*(X1(I)+X1(I+2))+B0
      B0=(X2(I)-X2(I-2)+X2(I)-X2(I+2))*0.125D0
      X2(I-1)=0.5D0*(X2(I)+X2(I-2))+B0
  550 X2(I+1)=0.5D0*(X2(I)+X2(I+2))+B0
      N=1
  600 IF (END.GT.0.D0.AND.IPTVU.GE.7) WRITE (9,60) M,K,KKK1,KKK,
     1  (XJ(I),I=1,KKK),(X1(I),I=1,KKK,N),(X2(I),I=1,KKK,N)
   60 FORMAT (1H0/4I10/(10F12.4))
      RETURN
      END
      FUNCTION ZETABW(M,RM3)
C
C      CALCULATE SPIN-ORBIT PARAMETER VIA BLUME-WATSON METHOD
C       PROC. ROY. SOC. (LONDON) A270, 127 (1962); A271, 565 (1963)
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      CHARACTER*8 NLBCD(KO),NLBCDO(KO),NLBCD8(KO),IFG(10,9),JFG(10,9),
     1  NLA,NLB
      CHARACTER CONF(3)*6,INPCARD*70
      COMMON/CHAR/CONF,NLBCD,NLBCDO,NLBCD8,IFG,JFG,NLA,NLB,INPCARD
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,DUMMY(KO),IW6,NCONFT
      COMMON/C4/VR(KMSH),QQ0(KMSH),IREL,NITER,NN,LAM,E,END,NODF,I,J,K,
     1  MM,IMATCH,RSINT,RSINT1,HXID,IZHXBW,IPHFWF,IHF,IHF1,NPRINT
      DIMENSION SNKK(KO),VKK(KO)
C
      SP=0.D0
      IF (L(M).EQ.0) GO TO 400
      FLM=L(M)
      E2=-12*L(M)-6
      E3=3.D0*DSQRT((2.D0*FLM+1.D0)/(FLM*(FLM+1.D0)))
      SP=Z*RM3*5.84366D0
      IF (IHF1.GT.5) WRITE (9,8810) M,FLM,E2,E3,SP
 8810 FORMAT (/I10,4F15.6)
C
      DO 290 MP=1,NCSPVS
      IF (EE(MP).GT.0.D0) GO TO 290
      IF (MP.EQ.M) GO TO 290
      LP=L(MP)
      FLP=LP
      WP=WWNL(MP)
      K=0
      SP=SP-2.D0*WP*SM(M,MP)
C
      KN=IABS(L(M)-LP)-2
      KX=L(M)+LP
      INV=-1
      DO 130 K=KN,KX
      SNKK(K+3)=0.D0
      VKK(K+3)=0.D0
      INV=-INV
      IF (INV.LT.0) GO TO 120
      IF (K.LT.-1) GO TO 130
      IF (K.EQ.KX.AND.L(M).EQ.LP) GO TO 130
      SNKK(K+3)=SN(M,MP)
      GO TO 130
  120 IF (K.LT.0) GO TO 130
      VKK(K+3)=VK(M,MP)
  130 CONTINUE
      IF (IHF1.GT.5) WRITE (9,8830) M,MP,NLBCD(M),NLBCD(MP),FLP,WP,SP,
     1  (K,SNKK(K),VKK(K), K=1,9)
 8830 FORMAT (/2I10,3X,A4,3X,A4,3F15.6,/(I10,2F30.6))
      KN=KN+2
      KXM2=KX-2
      IF (KXM2.LT.KN) GO TO 200
      SUM2=0.D0
      DO 160 K=KN,KXM2
      FK=K
      FKP1=FK+1.D0
      ERAS=S6J(FK,1.D0,FKP1,FLM,FLP,FLM)**2
      ERAS=ERAS*S3J0SQ(FLM,FK,FLP)
      ERAS=ERAS*(2.D0*FK+1.D0)*(2.D0*FK+3.D0)/(FK+2.D0)
      SUM2=SUM2+ERAS*SNKK(K+3)
      IF (IHF1.GT.5) WRITE (9,8840) K,FK,ERAS,SNKK(K+3),SUM2
 8840 FORMAT (/I10,5F15.6)
  160 CONTINUE
      SP=SP-E2*WP*SUM2
C
  200 E13=FLP*(FLP+1.D0)-FLM*(FLM+1.D0)
      IF (IHF1.GT.5) WRITE (9,8850) SP,E13
 8850 FORMAT (/4F15.6)
      IF (KN.EQ.0) KN=2
      SUM13=0.D0
      DO 220 K=KN,KX
      FK=K
      ERAS=DSQRT(FK*(FK+1.D0)*(2.D0*FK+1.D0))
      ERAS=ERAS*S3J0SQ(FLM,FK,FLP)
      ERAS=ERAS*S6J(FK,1.D0,FK,FLM,FLP,FLM)
      ERAS1=E13*(SNKK(K+1)/FK-SNKK(K+3)/(FK+1.D0))
      SUM13=SUM13+ERAS*(VKK(K+2)+ERAS1)
      IF (IHF1.GT.5) WRITE (9,8840) K,FK,ERAS,ERAS1,SUM13,VKK(K+2)
  220 CONTINUE
      SP=SP-E3*WP*SUM13
      IF (IHF1.GT.5) WRITE (9,8850) SP,E3,WP,SUM13
  290 CONTINUE
C
  300 W=WWNL(M)
      IF (W.LT.2.D0) GO TO 400
      K=0
      SM0=SM(M,M)
      SP=SP-(2.D0*W-3.D0)*SM0
      IF (IHF1.GT.5) WRITE (9,8850) SP,SM0
      IF (FLM.LT.2.D0) GO TO 400
      E=6.D0*((2.D0*FLM+1.D0)**2)
      KN=2
      KX=2*L(M)-2
      DO 330 K=KN,KX
      FK=K
      FKP1=FK+1.D0
      SUM=0.D0
      FKP=FK-2.D0
      DO 320 KP=1,2
      FKP=FKP+2.D0
      ERAS=S6J(FKP1,1.D0,FKP,FLM,FLM,FLM)**2
      ERAS=ERAS*S3J0SQ(FLM,FKP,FLM)
  320 SUM=SUM+(FKP1-FKP)*(2.D0*FKP+1.D0)*ERAS
      SMK=SM(M,M)
      SUM1=SUM*(2.D0*FK+3.D0)*SMK
      SP=SP+E*SUM1
      IF (IHF1.GT.5) WRITE (9,8840) K,ERAS,SUM,SMK,SUM1,SP
  330 CONTINUE
C
  400 ZETABW=SP
      RETURN
      END
      FUNCTION SM(M,MP)
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      COMMON XI(KMSH),XJ(KMSH),V(KMSH),RSCORE(KMSH),RSVALE(KMSH),
     1  RECORR(KMSH),RUCORR(KMSH),RC(KMSH),PNLO(KMSH),X1(KMSH),X2(KMSH)
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
C
      KKK=MIN0(NKKK(M),NKKK(MP))
      CALL ZK(M,MP,M,MP)
      CALL QUAD5(XJ,1,1,KKK,A1)
      SM=A1*2.921830
      RETURN
      END
      FUNCTION SN(M,MP)
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      COMMON XI(KMSH),XJ(KMSH),V(KMSH),RSCORE(KMSH),RSVALE(KMSH),
     1  RECORR(KMSH),RUCORR(KMSH),RC(KMSH),PNLO(KMSH),X1(KMSH),X2(KMSH)
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
C
      KKK=MIN0(NKKK(M),NKKK(MP))
      CALL ZK(M,MP,MP,M)
      CALL QUAD5(XJ,1,1,KKK,A1)
      SN=A1*2.921830
      RETURN
      END
      SUBROUTINE ZK(M1,M2,M3,M4)
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      COMMON XI(KMSH),XJ(KMSH),V(KMSH),RSCORE(KMSH),RSVALE(KMSH),
     1  RECORR(KMSH),RUCORR(KMSH),RC(KMSH),PNLO(KMSH),X1(KMSH),X2(KMSH)
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
      COMMON/C4/VR(KMSH),QQ0(KMSH),IREL,NITER,NN,LAM,E,END,NODF,I,J,K,
     1  MM,IMATCH,RSINT,RSINT1,HXID,IZHXBW,IPHFWF,IHF,IHF1,NPRINT
      COMMON PNL(KMSH,KO),QNL(KMSHQ,KOQ)
      COMMON/LC2/RA(KMSH),RB(KMSH)
C
      DO 120 I=1,KKK
  120 XJ(I)=PNL(I,M2)*PNL(I,M4)
      CALL QUADK(M1,3)
      KP3=K+3
      DO 160 I=3,KKK,2
  160 XJ(I)=PNL(I,M1)*PNL(I,M3)*X1(I)/(R(I)**KP3)
      XJ(1)=0.D0
      DO 170 I=3,KKK,4
      B0=(XJ(I)-XJ(I-2)+XJ(I)-XJ(I+2))*0.125D0
      XJ(I-1)=0.5D0*(XJ(I)+XJ(I-2))+B0
  170 XJ(I+1)=0.5D0*(XJ(I)+XJ(I+2))+B0
      XJ(2)=0.D0
      IF (XJ(5).NE.0.D0) XJ(2)=(XJ(3)**2)/XJ(5)
      DO 180 I=4,14,2
      XM=XJ(I-1)
      X0=XJ(I)
      XP=XJ(I+1)
      IF (X0.LT.XM.AND.X0.LT.XP) GO TO 175
      IF (X0.GT.XM.AND.X0.GT.XP) GO TO 175
      IF (XM.EQ.0.D0) GO TO 180
      IF (XP/XM.LT.6.D0) GO TO 180
  175 XJ(I)=DSQRT(XM*XP)
      IF (XP.LT.0.D0) XJ(I)=-XJ(I)
  180 CONTINUE
      RETURN
      END
      FUNCTION VK(M,MP)
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      COMMON XI(KMSH),XJ(KMSH),V(KMSH),RSCORE(KMSH),RSVALE(KMSH),
     1  RECORR(KMSH),RUCORR(KMSH),RC(KMSH),PNLO(KMSH),X1(KMSH),X2(KMSH)
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
C
      KKK=MIN0(NKKK(M),NKKK(MP))
      CALL DYK(M,MP)
      CALL QUAD5(XJ,1,1,KKK,A1)
      VK=A1
      CALL DYK(MP,M)
      CALL QUAD5(XJ,1,1,KKK,A1)
      VK=(VK-A1)*2.921830
      RETURN
      END
      SUBROUTINE DYK(M,MP)
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      COMMON XI(KMSH),XJ(KMSH),V(KMSH),RSCORE(KMSH),RSVALE(KMSH),
     1  RECORR(KMSH),RUCORR(KMSH),RC(KMSH),PNLO(KMSH),X1(KMSH),X2(KMSH)
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
      COMMON/C4/VR(KMSH),QQ0(KMSH),IREL,NITER,NN,LAM,E,END,NODF,I,J,K,
     1  MM,IMATCH,RSINT,RSINT1,HXID,IZHXBW,IPHFWF,IHF,IHF1,NPRINT
      COMMON PNL(KMSH,KO),QNL(KMSHQ,KOQ)
      COMMON/LC2/RA(KMSH),RB(KMSH)
C
      THM1=1.D0/R(3)
      I=0
      ERAS=0.D0
      ERAS1=PNL(1,MP)
      ERAS2=ERAS1
      DO 140 J=1,NBLOCK
      IF (I.LE.IDB) ERAS1=ERAS
      DO 130 JJ=1,40
      I=I+1
      IP1=I+1
      IF (IP1.GT.KKK) IP1=KKK
      ERAS=ERAS1
      ERAS1=ERAS2
      ERAS2=PNL(IP1,MP)
  130 XJ(I)=PNL(I,M)*(THM1*(ERAS2-ERAS)-ERAS1/R(I))
      IF (I.GT.IDB) GO TO 140
      THM1=0.5*THM1
  140 CONTINUE
      CALL QUADK(M,3)
      KP1=K+1
      DO 160 I=3,KKK,2
      ERAS=R(I)**KP1
      ERAS=X1(I)/(ERAS*R(I))+ERAS*(X2(KKK)-X2(I))
  160 XJ(I)=PNL(I,M)*PNL(I,MP)*ERAS
      XJ(1)=0.D0
      DO 170 I=3,KKK,4
      B0=(XJ(I)-XJ(I-2)+XJ(I)-XJ(I+2))*0.125D0
      XJ(I-1)=0.5D0*(XJ(I)+XJ(I-2))+B0
  170 XJ(I+1)=0.5D0*(XJ(I)+XJ(I+2))+B0
      XJ(2)=0.D0
      IF (XJ(5).NE.0.D0) XJ(2)=(XJ(3)**2)/XJ(5)
      DO 180 I=4,14,2
      XM=XJ(I-1)
      X0=XJ(I)
      XP=XJ(I+1)
      IF (X0.LT.XM.AND.X0.LT.XP) GO TO 175
      IF (X0.GT.XM.AND.X0.GT.XP) GO TO 175
      IF (XM.EQ.0.D0) GO TO 180
      IF (XP/XM.LT.6.D0) GO TO 180
  175 IF (XM*XP.LT.0.D0) GO TO 178
      XJ(I)=DSQRT(XM*XP)
      IF (XP.LT.0.D0) XJ(I)=-XJ(I)
      GO TO 180
  178 XJ(I)=0.5D0*(XM+XP)
  180 CONTINUE
      RETURN
      END
      FUNCTION S6J(FJ1,FJ2,FJ3,FL1,FL2,FL3)
C
C          CALCULATE 6-J SYMBOL
C
      IMPLICIT REAL*8 (A-H,O-Z)
C
      A6J=0.D0
      F1=DELSQ(FJ1, FJ2, FJ3)*DELSQ(FJ1, FL2, FL3)
     1*DELSQ(FL1, FJ2, FL3)*DELSQ(FL1, FL2, FJ3)
      IF (F1.LE.0.D0) GO TO 214
  210 A=FJ1+FJ2+FJ3
      B=FJ1+FL2+FL3
      C=FL1+FJ2+FL3
      D=FL1+FL2+FJ3
      E=FJ1+FJ2+FL1+FL2
      F=FJ2+FJ3+FL2+FL3
      G=FJ3+FJ1+FL3+FL1
      FI=DMAX1(A,B,C,D)
      I1=FI+0.001D0
      I2=DMIN1(E,F,G)+0.001D0
      IF (I2.LT.I1) GO TO 214
  211 DO 212 I=I1,I2
      F2=FCTRL(FI-A)*FCTRL(FI-B)*FCTRL(FI-C)*FCTRL(FI-D)
      F3=FCTRL(E-FI)*FCTRL(F-FI)*FCTRL(G-FI)
      A6J=A6J+((-1.D0)**MOD(I,2))*FCTRL(FI+1.D0)/(F2*F3)
  212 FI=FI+1.D0
      S6J=A6J*DSQRT(F1)
      RETURN
  214 S6J=A6J
  215 RETURN
      END
      FUNCTION DELSQ(A,B,C)
C
C          SHORT (BUT SLOWER) VERSION CALLING FACTORIAL FUNCTION
C
      IMPLICIT REAL*8 (A-H,O-Z)
C
      D=A+B
      E=D+C
C     IF (AINT(E).NE.E) GO TO 120
      TENM6=1.D-6
      IF (DABS(AINT(E)-E).GT.TENM6) GO TO 120
      F=A-B
      DELSQ=FCTRL(D-C)*FCTRL(C+F)*FCTRL(C-F)/FCTRL(E+1.D0)
      RETURN
  120 DELSQ=0.D0
      RETURN
      END
      SUBROUTINE EBREIT
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      COMMON XI(KMSH),XJ(KMSH),V(KMSH),RSCORE(KMSH),RSVALE(KMSH),
     1  RECORR(KMSH),RUCORR(KMSH),RC(KMSH),PNLO(KMSH),X1(KMSH),X2(KMSH)
C
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
      COMMON/C4/VR(KMSH),QQ0(KMSH),IREL,NITER,NN,LAM,E,END,NODF,I,J,K,
     1  MM,IMATCH,RSINT,RSINT1,HXID,IZHXBW,IPHFWF,IHF,IHF1,NPRINT
      COMMON PNL(KMSH,KO),QNL(KMSHQ,KOQ)
      COMMON/BRT/EMAG,ERET,FMI(10,3),FNI(10,4),FNORM(KO)
      DIMENSION UAB(KMSH),VAB(KMSH)
      EQUIVALENCE (UAB,RSCORE),(VAB,RSVALE)
C
C          CALCULATE NORMALIZATION CONSTANTS
C
      MMAX=NCSPVS
      IF (NNN(NCSPVS).GT.98) MMAX=NCSPVS-1
      DO 110 M=1,MMAX
      KKK=NKKK(M)
      DO 105 I=1,KKK
      XI(I)=PNL(I,M)**2+QNL(I,M)**2
      CALL QUAD5(XI,1,1,KKK,A1)
  105 FNORM(M)=A1
  110 CONTINUE
C
      EMAG=0.D0
      ERET=0.D0
C
C          SUM OVER ALL PAIRS OF ORBITALS
C
      DO 690 MB=1,MMAX
      IF (L(MB).GT.4) GO TO 690
      DO 680 MA=1,MB
      IF (L(MA).GT.4) GO TO 680
      IF (MA.EQ.MB.AND.WWNL(MA).EQ.1.D0) GO TO 680
      KKK=MIN0(NKKK(MA),NKKK(MB))
      DO 120 I=1,KKK
      ERAS=PNL(I,MA)*QNL(I,MB)
      ERAS1=PNL(I,MB)*QNL(I,MA)
      UAB(I)=ERAS-ERAS1
  120 VAB(I)=ERAS+ERAS1
C
C          CALCULATE MI AND NI INTEGRALS
C
      KP1X=L(MA)+L(MB)+2
      DO 150 KP1=1,KP1X
      DO 125 I=1,4
      IF (I.EQ.4) GO TO 125
      FMI(KP1,I)=0.D0
  125 FNI(KP1,I)=0.D0
      K=KP1-1
      IF (MA.EQ.MB) GO TO 135
      DO 130 I=1,KKK
  130 XJ(I)=UAB(I)
      CALL QUADK(31,1)
      CALL BRTINT(1,MA,MB)
  135 DO 140 I=1,KKK
  140 XJ(I)=VAB(I)
      CALL QUADK(32,1)
  150 CALL BRTINT(2,MA,MB)
C
C          SUM OVER BOTH KAPPAS, EACH ORBITAL
C
      FKAPB=L(MB)
      IF (FKAPB.EQ.0.D0) FKAPB=-1.D0
  200 ERAS=2*L(MB)+1
      QB=WWNL(MB)*DABS(FKAPB)/ERAS
      FJB=DABS(FKAPB)-0.5D0
      FKAPA=L(MA)
      IF (FKAPA.EQ.0.D0) FKAPA=-1.D0
  210 ERAS=2*L(MA)+1
      QA=WWNL(MA)*DABS(FKAPA)/ERAS
      FJA=DABS(FKAPA)-0.5D0
      KP1N0=DABS(FJA-FJB)+1.D0
      KP1X=FJA+FJB+1.D0
      FLMAG=0.D0
      FLRET=0.D0
C
C          CALCULATE LAMBDA(KAPA,KAPB) TERMS
C
  300 KP1N=KP1N0
      IF (MOD(L(MA)+KP1N0+L(MB),2).EQ.0) KP1N=KP1N0+1
      IF (MA.EQ.MB.AND.FKAPA.EQ.FKAPB) GO TO 400
      ERAS=FKAPB-FKAPA
      DO 320 KP1=KP1N,KP1X,2
      K=KP1-1
      FK=K
      FLAMBDA=S3J(FJA,FK,FJB,0.5D0,0.D0)**2
      T1=FK*FMI(K,1)
      IF (ERAS.NE.0.D0) T1=T1+ERAS*(2.D0*FMI(K,2)+ERAS*FMI(K,3)/FK)
      T1=T1/(2.D0*FK-1.D0)
      FKP1=FK+1.D0
      T2=FKP1*FMI(K+2,1)
      IF (ERAS.NE.0.D0) 
     1  T2=T2+ERAS*(-2.D0*FMI(K+2,2)+ERAS*FMI(K+2,3)/FKP1)
      T2=T2/(2.D0*FK+3.D0)
      X=FK*FKP1*(FNI(K+2,1)-FNI(K,1))
      IF (ERAS.EQ.0.D0) GO TO 310
      X=X+ERAS*(FKP1*(FNI(K+2,2)-FNI(K,2))+FK*(FNI(K,3)-FNI(K+2,3)))
      X=X+(ERAS**2)*(FNI(K,4)-FNI(K+2,4))
  310 FLMAG=FLMAG+FLAMBDA*(T1+T2)
      FLRET=FLRET+FLAMBDA*(FK*T1+FKP1*T2+X)/(FK+FKP1)
      IF (ITPOW.EQ.4)
     1  WRITE (9,3100) MA,MB,FKAPA,FKAPB,K,FLAMBDA,T1,T2,X,FLMAG,FLRET
 3100 FORMAT (2I4,2F5.1,I4,6F12.7)
  320 CONTINUE
C
C          CALCULATE LAMBDA(-KAPA,KAPB) TERMS
C
  400 ERAS=FKAPA+FKAPB
      IF (ERAS.EQ.0.D0) GO TO 500
      KP1N=KP1N-1
      IF (KP1N.LT.KP1N0) KP1N=KP1N+2
      DO 420 KP1=KP1N,KP1X,2
      K=KP1-1
      FK=K
      FLAMBDA=S3J(FJA,FK,FJB,0.5D0,0.D0)**2
      FLMAG=FLMAG+FLAMBDA*(ERAS**2)*FMI(K+1,3)/(FK*(FK+1.D0))
      IF (ITPOW.EQ.4)
     1  WRITE (9,3100) MA,MB,FKAPA,FKAPB,K,FLAMBDA,FLMAG
  420 CONTINUE
C
C
C
  500 ERAS=2.D0/(FNORM(MA)*FNORM(MB))
      FLMAG=ERAS*FLMAG
      FLRET=-ERAS*FLRET
      IF (MA.EQ.MB.AND.FKAPA.EQ.FKAPB) GO TO 520
      ERAS=QA*QB
      EMAG=EMAG+ERAS*FLMAG
      ERET=ERET+ERAS*FLRET
      GO TO 530
  520 EMAG=EMAG+QA*(QA-1.D0)*FLMAG*(FJA+0.5D0)/(2.D0*FJA)
  530 CONTINUE
      IF (ITPOW.EQ.4)
     1 WRITE (9,5300) MA,MB,FKAPA,FKAPB,QA,QB,ERAS,FLMAG,FLRET,EMAG,ERET
 5300 FORMAT (2I4,2F5.1,2F8.4,5F12.7)
      IF (FKAPA.LT.0.D0) GO TO 600
      FKAPA=-FKAPA-1.D0
      GO TO 210
C
  600 IF (FKAPB.LT.0.D0) GO TO 680
      FKAPB=-FKAPB-1.D0
      GO TO 200
  680 CONTINUE
  690 CONTINUE
C
  700 RETURN
      END
      SUBROUTINE BRTINT(N,MA,MB)
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KMSH=1801,KO=20,KMSHQ=1801,KOQ=20)
      COMMON R(KMSH),RU(KMSH),RUEE(KMSH),RUEXCH(KMSH),RSATOM(KMSH),
     1     NNLZ(KO),NNN(KO),
     2  A0M(KO),JJJ(KO),WWNL(KO),L(KO),NKKK(KO),EE(KO),
     3  EI(KO),EKIN(KO),EEN(KO),UEE(KO),UEX(KO),ECORR(KO),UCORR(KO),
     4  EPSS(KO),EVEL(KO),EDAR(KO),EREL(KO),A(5,5),B(KO),NSCH(10,KO),
     5  AZ(KO),IMAT(KO),ECM(10)
      COMMON XI(KMSH),XJ(KMSH),V(KMSH),RSCORE(KMSH),RSVALE(KMSH),
     1  RECORR(KMSH),RUCORR(KMSH),RC(KMSH),PNLO(KMSH),X1(KMSH),X2(KMSH)
C
      COMMON/C2/Z,IZ,NCONF,NCORES,NVALES,NCSPVS,ION,MESH,KUT,ICUT,IDB,
     1  RDB,CORRF,C,TWOZZZ,NBLOCK,KKK,TOLSTB,TOLKM2,TOLEND,THRESH,
     2  ETOT,ECORRT,CA0,CA1,EMX,EKINT,EENTOT,ETOTK,ETOTP,ZZZ,
     3  ALFMIN,ALFMAX,TWOION,TWOZ,NCELEC,NVELEC,ITPOW,IPTVU,XIF,
     4  EXF10,EXFM1,IPTEB,NS,IB,NCONFT2,RM3(KO),IW6,NCONFT
      COMMON/C4/VR(KMSH),QQ0(KMSH),IREL,NITER,NN,LAM,E,END,NODF,I,J,K,
     1  MM,IMATCH,RSINT,RSINT1,HXID,IZHXBW,IPHFWF,IHF,IHF1,NPRINT
      COMMON/BRT/EMAG,ERET,FMI(10,3),FNI(10,4),FNORM(KO)
      DIMENSION UAB(KMSH),VAB(KMSH)
      EQUIVALENCE (UAB,RSCORE),(VAB,RSVALE)
C
C
      KP1=K+1
  120 XI(1)=0.D0
      XJ(1)=0.D0
      DO 130 I=2,KKK
  130 XI(I)=X1(I)/(R(I)**KP1)
      IF (MA.EQ.MB) GO TO 300
C
      DO 210 I=1,KKK
  210 V(I)=UAB(I)*XI(I)
      CALL QUAD5(V,1,1,KKK,A1)
      FNI(KP1,N)=A1
C
  300 DO 310 I=1,KKK
  310 V(I)=VAB(I)*XI(I)
      CALL QUAD5(V,1,1,KKK,A1)
C     WRITE (9,3100) N,A1,(XI(I),I=1,50),(XJ(I),I=1,50),(V(I),I=1,240)
C3100 FORMAT (//I5,F14.6/(10F12.5))
      FNI(KP1,N+2)=A1
      IF (N.EQ.1) GO TO 400
      FMI(KP1,1)=2.D0*FNI(KP1,1)
      FMI(KP1,2)=FNI(KP1,2)+FNI(KP1,3)
      FMI(KP1,3)=2.D0*FNI(KP1,4)
C     WRITE (9,3100) N,A1,(XI(I),I=1,50),(XJ(I),I=1,50),(V(I),I=1,240)
  400 CONTINUE
      IF (ITPOW.EQ.4)
     1  WRITE (9,40) K,(FMI(KP1,I),I=1,3), (FNI(KP1,I),I=1,4)
   40 FORMAT (/I5,3F10.6,5X,4F10.6)
      RETURN
      END
      FUNCTION S3J (FJ1, FJ2, FJ3, FM1, FM2)
C
      IMPLICIT REAL*8 (A-H,O-Z)
C
      S3J=0.D0
      FM3=-FM1-FM2
      IF (DABS(FM3).GT.FJ3) RETURN
      A=FJ1+FJ2-FJ3
      B=FJ1-FJ2+FJ3
      C=-FJ1+FJ2+FJ3
      D=FJ1-FM1
      E=FJ2+FM2
      X=FCTRL(A)*FCTRL(B)*FCTRL(C)
      IF (X.LE.0.D0) RETURN
      X=X/FCTRL(FJ1+FJ2+FJ3+1.D0)
      X=X*FCTRL(D)*FCTRL(FJ1+FM1)*FCTRL(FJ2-FM2)*FCTRL(E)
     1  *FCTRL(FJ3-FM3)*FCTRL(FJ3+FM3)
      IF (X.LE.0.D0) RETURN
      X=DSQRT(X)
      B=D-B
      C=E-C
      ZERO=0.D0
      FK=DMAX1(ZERO,B,C)
      K1=FK
      K2=DMIN1(A,D,E)
      IF (K2.LT.K1) RETURN
      F=(-1.D0)**K1
      Y=0.D0
      DO 150 K=K1,K2
      Y=Y+F/(FCTRL(FK)*FCTRL(FK-B)*FCTRL(FK-C)*FCTRL(A-FK)
     1  *FCTRL(D-FK)*FCTRL(E-FK))
      FK=FK+1.D0
  150 F=-F
      S3J=X*Y
      K=FJ1-FJ2-FM3
      S3J=S3J*((-1.D0)**K)
      RETURN
      END
