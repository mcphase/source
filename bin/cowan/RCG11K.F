C     OVERLAY(G9,0,0)
      PROGRAM RCG11
C     PROGRAM RCG11(ING11,TAPE10=ING11,OUTG11,TAPE9=OUTG11,
C    1  TAPE3,TAPE20,TAPE31,TAPE32,TAPE41,
C    2  TAPE72,TAPE73,TAPE74,TAPE2E,TAPE2=TAPE2E,TAPE19,
C    3  OUTGINE,TAPE11=OUTGINE,TAPE13,TAPE5)
C
C     PROGRAM COPYRIGHT 1980, LOS ALAMOS NATIONAL LABORATORY AND
C          U.S. GOVERNMENT.  THIS PROGRAM MAY BE FREELY DISTRIBUTED
C          GRATIS ANY PLACE IN THE WORLD, BUT MAY NOT BE SOLD.
C
C
C
C          RCG-MOD 11, MAIN CONTROL PROGRAM
C
C
C          PROGRAM TO COMPUTE COEFFICIENT MATRICES FOR ATOMIC
C               ENERGY-LEVEL PARAMETERS (FK, GK, ZETA, ALPHA,
C               BETA, GAMMA, T, RK), READ PARAMETER VALUES,
C               AND COMPUTE AND DIAGONALIZE THE ENERGY MATRICES
C               TO OBTAIN ENERGY LEVELS AND EIGENVECTORS.
C          ALSO, IF DESIRED, COMPUTE ANGULAR COEFFICIENT MATRICES
C               FOR MAGNETIC DIPOLE AND
C               FOR ELECTRIC DIPOLE AND QUADRUPOLE TRANSITIONS,
C               READ RADIAL MULTIPOLE INTEGRALS, AND CALCULATE
C               OSCILLATOR STRENGTHS AND TRANSITION PROBABILITIES.
C
C          FIRST VERSION (RCG MOD 0) CODED BY B. FAGAN AND R. D. COWAN,
C               LOS ALAMOS SCIENTIFIC LABORATORY, SUMMER AND FALL, 1964.
C
C          RCG MOD 5 (INCLUDING CONFIGURATION INTERACTION)
C               CODED FALL,1968 BY R. D. COWAN FOR THE IBM 7030(STRETCH).
C               --- MODIFIED FOR THE CDC 6500
C               AT PURDUE UNIVERSITY, MARCH, 1971.  CONVERTED JULY-NOV,
C               1971 TO LASL CDC 7600, USING LARGE CORE MEMORY.
C               DIMENSIONS INCREASED TO 8 SUBSHELLS, FEB, 1975.
C               AUTOIONIZATION TRANS-PROB CALCS ADDED SPRING 1975.
C               PLANE-WAVE-BORN COLLISION-STRENGTH OPTIONS ADDED
C               JAN-FEB 1980 BY W. D. ROBB AND R. D. COWAN.
C          MODIFIED TO ALLOW DIFFERENT L FOR FINAL SUBSHELL, JULY 1981,
C               AND TO ACCEPT RESCALING CARDS, OCTOBER 1981.
C          MOD 10:
C               FASTER 3NJ ROUTINES INCORPORATED JULY 21, 1983.
C               MODIFIED FOR CRAY 1 COMPUTERS, DECEMBER 1983.
C               MODIFIED FOR ZEEMAN-LAB CYBER 170/750, FEBRUARY 1984.
C               OPTION TO TRUNCATE TO GIVEN SET OF LS VALUES ADDED JUNE 1984.
C               WRITE ON TAPE11 OF RCE INPUT ADDED AT NBS MAY 1986.
C               CHANGES IN ACTION OF PRINT-CONTROL VARIABLES IPCT
C                    AND ICTC MADE AT ZEEMAN LAB, DECEMBER 1987.
C
C               A VERSION FOR THE VAX 8200 MADE AT LUND UNIVERSITY,
C                    MARCH-APRIL 1988, INCORPORATING NUMEROUS MINOR
C                    ADDITIONS AND IMPROVEMENTS
C               RECONVERTED TO THE CRAY
C                    AT LANL FALL 1988, LEAVING COMMENT CARDS FOR EASY
C                    RECONVERSION TO THE VAX.  ENCODE AND DECODE
C                    STATEMENTS REMOVED BY CHANGING MANY VARIABLES TO
C                    CHARACTER STRINGS, JANUARY 1989
C               THIS VERSION (MOD 11) HAS COMMONS MODIFIED SO THAT A
C                    COMMON OF GIVEN NAME HAS THE SAME LENGTH IN ALL
C                    ROUTINES.  NEW TIMING SUBROUTINE SECONDS CODED
C                    WITH ALTERNATIVE SECTIONS AVAILABLE FOR CRAY, VAX 
C                    OR MACINTOSH, SUN, AND IBM SYSTEM/6000 RISC.
C               -------------------------------------------------------
C               NOTE: BACKSPACE COMMANDS IN THIS PROGRAM MAY CAUSE
C                    DIFFICULTIES ON THE IBM RISC (BACKSPACES OF LONG
C                    UNFORMATTED RECORDS NOT EFFECTIVE) IF FORTRAN
C                    COMPILER VERSIONS EARLIER THAN 2.02 ARE USED.
C                         ALSO, DECFORTRAN VERSION 3.0 IS INADEQUATE,
C                    AND VERSION 3.2 IS REQUIRED.
C                         VERY TIME-CONSUMING BACKSPACES IN SUBROUTINE 
C                    RCEINP REPLACED MAY 1993 BY REWIND AND
C                    READS FORWARD
C               -------------------------------------------------------
C               THE DIMENSIONS USED IN THIS VERSION OF RCG ARE TOO
C                    SMALL TO HANDLE CFP DECKS FOR F5, F6, F7, F8,
C                    F9, AND F10.  TO MAKE POSSIBLE USE OF THESE
C                    SUBSHELLS, MAKE THE FOLLOWING CHANGES IN PARAMETER
C                    STATEMENTS THROUGHOUT THE PROGRAM:
C                         KLSI  = 119
C                         KJP   = 350
C                         KMX   = 360
C                         KTRAN = 3200
C               -------------------------------------------------------
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      PARAMETER (KBGKS=41,KTRAN=600)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3/    CFP2(KLS1,KLS1,7),CIJK(10,6),
     1  U2(KLSI,KLSI,7),U3(KLSU,KLSU,9),U4(KLSU,KLSU,9),U5(KLSU,KLSU,7),
     2  U6(KLSU,KLSU,7),V2(KLSI,KLSI,7),V3(KLSI,KLSI,7),V4(KLSU,KLSU,7),
     *  V5(KLSU,KLSU,5),V6(KLSU,KLSU,5),
     3  NTI(41),IRP1MX,NALSJI(KJP),TFLN,TFLX,TFSN,TFSX,
     4  PJI(KJP),MULSI(KLSI),LBCDI(KLSI),IRHO,IRHOP,ISIG,ISIGP,FLLRHO,
     5  FLLSIG,IN,JN,JX,NII,NIJ,KI,KJ,KPI,KPJ,KDMIN,KEMIN,NKD,NKE,NKTOT,
     6  TR,TK,TC,RSUM,  J11,J12,L1,L2,TL(2,KS),TS(2,KS),
     7  TSCL(2,KS),TSCS(2,KS),NIJKP(KS,2),IRS(KS),IFL(KS),NDEL(KS),
     8    CIJR(8),CCC(8),N1,N2,N3,N4,E1,E2,E3,
     9  E4,E5,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,B1,B2,B3,B4,B5,B6,
     A  CFGP2(17,8,7),NALSJP(KJP,KS),PJ(KJP,KS)
      COMMON/CC/   U1(KLSI,KLSI,9),DUMLC1(KLC1)
      COMMON/C3LC2/CFGP1(KLSI,KLSI,7),PC(KPC),DUMLC2(KLC2)
      COMMON/C3LC3/V1(KLSI,KLSI,9),DUMLC3(KLC1)
      COMMON/C3LC4/DUMLC4(KMX**2-KISER),PCI(KISER)
      DIMENSION NPARJ(KC,KC),ISER(KISER)
      EQUIVALENCE (DUMLC4,NPARJ),(DUMLC4(KC**2+1),ISER)
      COMMON/C3LC5/GOSS(KTRAN,KBGKS)
      COMMON/C3LCD/DUMLC5
      COMMON/EE/NALSP(KLSC,KS),PSCRL(KLSC,KS),PSCRS(KLSC,KS),
     1  NCFGP(KLSC),NJK(KJK,KS),NCFGJP(KJP,KS),MULS1(KLSC),MULS4(KLSC),
     2  LHS1(KLSC),LHS4(KLSC)
      COMMON  DUMBLK(1850)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      COMMON/C6/EMIN,EMAX,SUMWT,FLBDN,FLBDX,FNUNP,FNUXP,NLEV,IEWR
      COMMON/CTKEV/NPTKEV,NTKEV,TKEV(6),TUNRGY(6),BRNCHL(6),BRNCHT(6),
     1  EIONRY
      DIMENSION CFP1(KLS1,KLS1)
      EQUIVALENCE (CFP1,CFGP1)
      DIMENSION SJNK(2),SJXK(2),NOTKP(2)
      CHARACTER*64 FIL
      CHARACTER*8 FIDLS,FIDJJ,LDES,LDESP,PARNAM,COUPL,COUPL1
      CHARACTER*4 LSYMB,LHS1
      COMMON/CHAR/PARNAM(KPR,2),FIDLS(KMX,2),FIDJJ(KMX,2),LDES(KMX),
     1  LDESP(KMX)
C
C
C      OPEN FILES
C
C          IF III=0, CHOOSE EXTERNAL NAMES OF INPUT AND
C               OUTPUT FILES INTERACTIVELY (FOR VAX).
C          IF III=1, USE STANDARD FILE NAMES (FOR VAX).
C          FOR CRAY AND CDC COMPUTERS, SET III>1 AND
C               UNCOMMENT PROGRAM CARD AT START OF PROGRAM.
C
      III=1
      IF (III.EQ.1) GO TO 50
      IF (III.GT.1) GO TO 60
C
      WRITE(6,*) ' INPUT FILE NAME '
      READ(5,3) FIL
    3 FORMAT(A)
      OPEN(10,FILE=FIL,STATUS='OLD')
      WRITE(6,*) ' OUTPUT FILE NAME '
      READ(5,3) FIL
      OPEN(9,FILE=FIL,STATUS='UNKNOWN')
      WRITE(6,*) ' FILE NAME FOR LEAST-SQS. COEFF. (BLANK, NO FILE)'
      READ(5,3) FIL
      OPEN(2,FILE=FIL,STATUS='UNKNOWN',FORM='UNFORMATTED')
      WRITE (6,*) ' FILE NAME FOR LEAST-SQS. INPUT (BLANK, NO FILE) '
      READ(5,3) FIL
      OPEN(11,FILE=FIL,STATUS='UNKNOWN')
      GO TO 55
C
   50 MSDOS=1
      OPEN(10,FILE='ING11',STATUS='OLD')
      OPEN(9,FILE='OUTG11',STATUS='UNKNOWN')
      OPEN(2,FILE='TAPE2E',STATUS='UNKNOWN',FORM='UNFORMATTED')
      OPEN(11,FILE='OUTGINE',STATUS='UNKNOWN')
   55 OPEN(20,STATUS='SCRATCH',FORM='UNFORMATTED')
      OPEN(31,STATUS='SCRATCH',FORM='UNFORMATTED')
      OPEN(32,STATUS='SCRATCH',FORM='UNFORMATTED')
      OPEN(41,STATUS='SCRATCH',FORM='UNFORMATTED')
C  55 OPEN(20,FILE='FOR020',STATUS='UNKNOWN',FORM='UNFORMATTED')
C     OPEN(31,FILE='FOR031',STATUS='UNKNOWN',FORM='UNFORMATTED')
C     OPEN(32,FILE='FOR032',STATUS='UNKNOWN',FORM='UNFORMATTED')
C     OPEN(41,FILE='FOR041',STATUS='UNKNOWN',FORM='UNFORMATTED')
C
      IF (MSDOS.EQ.1) THEN
C         READ THE PATH TO SYSTEM FILES FROM THE ROOT DIRECTORY
        OPEN(1,FILE='C:\COWAN.CFG',STATUS='OLD')
        READ(1,3) FIL
        CLOSE(1)
        I=INDEX(FIL,' ')-1
        IF (I.EQ.-1) I=LEN(FIL)-1
        FIL=FIL(1:I)//'\CODE\'
      ELSE
********* Specify the COWAN directory here *************
        FIL='/u/kramida/cowan/'
********************************************************
      ENDIF
      I=INDEX(FIL,' ')-1
      IF (I.EQ.-1) I=LEN(FIL)-1
      OPEN(12,FILE=FIL(1:I)//'FOR072',STATUS='UNKNOWN',
     1  FORM='UNFORMATTED')
      OPEN(13,FILE=FIL(1:I)//'FOR073',STATUS='UNKNOWN',
     1  FORM='UNFORMATTED')
      OPEN(14,FILE=FIL(1:I)//'FOR074',STATUS='UNKNOWN',
     1  FORM='UNFORMATTED')
      OPEN(22,FILE=FIL(1:I)//'SENIOR',STATUS='OLD')
      OPEN(3,STATUS='SCRATCH',FORM='UNFORMATTED')
      OPEN(33,FILE='FOR033',STATUS='UNKNOWN')
      OPEN(15,STATUS='SCRATCH',FORM='UNFORMATTED')
      OPEN(21,STATUS='SCRATCH')
C
C          SET INPUT AND OUTPUT DISK UNIT NUMBERS
C
   60 IR=10
      IW=9
      ID2DEF=12
      ILA=31
      ILB=32
      IC=41
C
C          CALCULATE TABLE OF SCALED FACTORIALS
C
      CALL CALCFCT
C
      NTKEV=0
      NPTKEV=0
      DELEKEV=0.D0
      IABG=1
      IV=0
      EMINA=0.D0
      FLBDN=0.D0
      FLBDX=0.D0
      NOLSKP=0
      NOTKP(1)=0
      NOTKP(2)=0
      ZERO=0.D0
      HALF=0.5D0
      ONE=1.D0
      THRHAL=1.5D0
      TWO=2.D0
      CALL CLOCK(TIME0)
      WRITE (IW,4)
    4 FORMAT (1H1/)
      IRES=0
C
   80 READ (IR,5) KCPL
    5 FORMAT (I5)
      BACKSPACE IR
      IF (KCPL.LE.2) GO TO 94
      IF (KCPL.GT.10) GO TO 90
      IF (KCPL.EQ.3) GO TO 85
      WRITE (IW,6) KCPL
    6 FORMAT (//30H *****CONTROL CARD VALUE KCPL=,I3,11H IS ILLEGAL//)
      READ (IR,5)
      GO TO 80
C
C          READ OPTIONAL FIRST CONTROL CARD (KCPL.EQ.3)
C               (ID2.GT.0--E.G. ID2=42 OR 12-- IF CUVFD TO BE CALLED)
C
   85 READ (IR,7) KCPL,ILNCUV,ID2T,FLBDN,FLBDX,DELEKEV,EIONRY,NPTKEV,
     1  (TKEV(I),I=2,6),EMINA
    7 FORMAT (I5,I2,I3,2E5.1,2F10.5,I5,5F5.3,F10.5)
      DO 87 I=1,5
   87 IF (TKEV(I+1).GT.0.D0) NTKEV=I
      TKEV(1)=9999.9D0
      WRITE (IW,11) EIONRY,IABG,IV,NPTKEV,(TKEV(I),I=2,6),TIME0
   11 FORMAT (11H0RCG MOD 11,5X,7HEIONRY=,F10.5,
     1  7X,5HIABG=,I1,3X,3HIV=,I1,4X,6HNTKEV=,I1,3X,5HTKEV=,
     2  5F6.2,6X,5HTIME=,F9.2)
      IF (ID2T.EQ.0) GO TO 80
      ID2=ID2T
C
C     CALL OVERLAY(2HG9,1,0)
      CALL CUVFD
      IRES=7
      GO TO 80
C
C          READ OPTIONAL SECOND CONTROL CARD (KCPL.GT.3)
C               (FOR CONFIGURATIONS WITH SERIAL NO..GE.NCLSKP(K),
C   RETAIN ONLY THOSE BASIS STATES HAVING
C        ONE OF THE NOTKP(K) VALUES OF TOTAL L AND S)
C
   90 READ (IR,8) J,K,NOLSKP,(MULS1(I),LHS1(I),I=1,NOLSKP)
    8 FORMAT (I4,I1,I5,14(I4,A1))
      NCLSKP(K)=J
      NOTKP(K)=NOLSKP
      IF (IRES.EQ.7) WRITE (IW,4)
      IRES=0
      IF (NOLSKP.LE.0) GO TO 80
      WRITE (IW,9) K,J,(MULS1(I),LHS1(I),I=1,NOLSKP)
    9 FORMAT (11H FOR PARITY,I2,19H AND CONFIGS. WITH ,
     1  14HSERIAL NO..GE.,I3,18H, KEEP ONLY TERMS ,14(I3,A1))
      DO 92 I=1,NOLSKP
      ERAS=MULS1(I)
      SCRSKP(I,K)=0.5D0*(ERAS-1.D0)
      DO 91 J=1,24
      IF (LHS1(I).NE.LSYMB(J)) GO TO 91
      SCRLKP(I,K)=J-1
      GO TO 92
   91 CONTINUE
   92 CONTINUE
      GO TO 80
C
   94 IF (ID4.GT.0) GO TO 95
      ID2=ID2DEF
      ID3=ID2+1
      ID4=ID3+1
   95 IF (FLBDN.LE.0.D0) FLBDN=0.001D0
      IF (FLBDX.LE.FLBDN) FLBDX=500000.D0
      IF (DELEKEV.LE.0.D0) DELEKEV=0.00025D0
C
C          READ FINAL CONTROL CARD (OR RESCALE CARD IF KCPL=0)
C
C          READ KIND OF COUPLING (1=LS, OR 2=JJ),
C               NUMBER OF SUB-SHELLS IN EACH CONFIGURATION, AND
C               NUMBER OF CONFIGURATIONS (FOR EACH PARITY).
C          IF IABG.GE.1, PARAMETERS ALPHA, BETA, GAMMA ARE INCLUDED
C               FOR EQUIVALENT ELECTRONS (ALSO T FOR D2-D8, AND
C               T1 AND T2 FOR D3-D7).  IF IABG=2 OR 4, THEN ILLEGAL-K
C               PARAMETERS ARE INCLUDED FOR NON-EQUIVALENT ELECTRONS.
C               IF IABG.GE.3, THEN SL COUPLING IS USED INSTEAD OF LS.
C          IF EAV=-55555555., INPUT FOR LEAST-SQUARES ENERGY-LEVEL-FITTING
C               PROGRAM RCE IS WRITTEN ON TAPE 2.
C          IF ICTBCD.GT.0, INPUT FOR ARGONNE LEAST-SQUARES PROGRAM
C               IS WRITTEN ON TAPE 19.  (TAPES 2 AND 19 CANNOT
C               BOTH BE WRITTEN IN THE SAME RUN.)
C          IF ICTBCD.LT.0, INPUT FOR ZEEMAN LABORATORY LEAST-SQUARES
C               PROGRAM (KONFIT) IS WRITTEN ON TAPE 5 (=TAPE 19).
C          IF IGEN=KCPLD(3).GE.5, PLANE-WAVE-BORN COLLISION
C               STRENGTHS WILL BE CALCULATED (IGEN=9 GIVES MINIMUM PRINT).
C               VALUES OF KCPL(4)-(5) AND (6)-(7) MUST BE SET APPROPRIATELY
C               FOR MINIMUM AND MAXIMUM VALUES OF THE MULTIPOLE INDEX,
C               FOR PARITY CONSERVING AND CHANGING EXCITATIONS, RESPECTIVELY.
C
      COUPL1=COUPL(1)
C     KS=8
C     KC=50
      IRW19=0
      REWIND 2
      ISCALE=0
      DELEAV=0.D0
      UENRGY=0.D0
      FACT0(1)=0.D0
      FACT0(2)=0.D0
      FACT0(3)=0.D0
      FACT0(4)=0.D0
      FACT0(5)=0.D0
      TEXCIT=0.D0
      IF (KCPL.EQ.0) GO TO 101
      ICTC=0                    ! THIS PARAMETER IS DISABLED
C
  100 READ (IR,10) KCPL,NCK,NOCSET,NSCONF,IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD,IELPUN,SJNK(1),SJXK(1),SJNK(2),SJXK(2),IMAG,IQUAD,UENINP,
     2  DMIN,ILNCUV,IPLEV,ICPC,ICFC,IDIP, IENGYD,ISPECC,
     3  IW6,IPCT,INWOL,IWS,ICTBCD
   10 FORMAT (I5,I1,2I2,I1,2I2,I1,2I2,2I1,I3,I2,I3,
     1  9I1,I1,4F2.1,2I1,F10.5,   E5.1,5I1, 2I1,   2I2, 2I1, I2)
      IF (KCPL.LT.0) THEN
        CLOSE(20,STATUS='DELETE')
        CLOSE(31,STATUS='DELETE')
        CLOSE(32,STATUS='DELETE')
        CLOSE(41,STATUS='DELETE')
        CLOSE(3,STATUS='DELETE')
        CLOSE(33,STATUS='DELETE')
        CLOSE(15,STATUS='DELETE')
        STOP '(NORMAL EXIT)'
      ENDIF
      IF (UENINP.LE.0.D0) UENINP=1000.D0
      IF (KCPL.GT.0) GO TO 104
C          IF (KCPL.EQ.0) INTERPRET AS A RESCALE CARD
      BACKSPACE IR
  101 READ (IR,12) DELEAV,KCPLD,IELPUN,UENINP,TEXCIT
   12 FORMAT (20X,F10.5,10I1,10X,F10.5,F5.2)
      ISCALE=0
      IF (UENINP.LE.0.D0) GO TO 102
      ISCALE=7
      UENRGY=UENINP
  102 I=0
      DO 103 J=1,5
      I=I+2
      ERAS=10*KCPLD(I-1)+KCPLD(I)
      IF (J.EQ.5) ERAS=10*KCPLD(9)+IELPUN
      IF (ERAS.GE.98.5D0) ERAS=100.D0
      IF (ERAS.GT.0.D0.AND.ERAS.LT.1.5D0) ERAS=0.1D0
  103 FACT0(J)=ERAS/100.D0
      GO TO 100
C
  104 IF (NSCONF(2,1).LE.KC.AND.NSCONF(2,2).LE.KC) GO TO 105
      WRITE (IW,13) NSCONF(2,1),NSCONF(2,2),KC
   13 FORMAT (' NO. OF CONFIGURATIONS=',2I4,' GREATER THAN DIM. KC=',I2)
      STOP '(TOO MANY CONFIGURATIONS)'
  105 IF (ISCALE.EQ.0) UENRGY=UENINP
      SCALE=UENINP/UENRGY
      IF (NLT11.EQ.0) NLT11=119
      IF (NEVMAX.EQ.0) NEVMAX=KMX
      IF (NOCSET.NE.0.AND.NLSMAX.NE.0) NLSMAX=KMX
      IF (IELPUN.EQ.2) ICTBCD=0
      IF (SJXK(1).LE.0.D0) SJXK(1)=99.D0
      IF (SJXK(2).LE.0.D0) SJXK(2)=99.D0
      IF (NOLSKP.EQ.0.AND.SJXK(1)+SJXK(2).NE.198.D0) NOLSKP=-7
      IF (NOLSKP.EQ.0) GO TO 106
C     KCPL=1
C     KCPLD(2)=1
C     NLSMAX=0
  106 IF (IENGYD.EQ.0) IENGYD=500
      IF (IENGYD.EQ.2) IENGYD=(NEVMAX+10)/11
      IGDLEV=0
      IF (ISPECC.EQ.0) IGDLEV=7
      IF (IGDLEV.NE.0) ISPECC=8
      IPLOTC=0
      IF (ISPECC.EQ.0) IPLOTC=1
      IGEN=KCPLD(3)
      IF (IGEN.GE.5) GO TO 110
      IRNQ=2
      IRXQ=2
      IRND=1
      IRXD=1
      GO TO 120
  110 IRNQ=KCPLD(4)
      IRXQ=MAX0(IRNQ,KCPLD(5))
      IRND=MAX0(1,KCPLD(6))
      IRXD=MAX0(IRND,KCPLD(7))
      IF (NSCONF(2,2).LE.0) IQUAD=1
      DMIN=0.D0
      ISPECC=1
      NTKEV=0
      NPTKEV=0
      IF (NCK(1).LE.0) NCK(1)=1
  120 IF (NCK(1).EQ.0) NCK(1)=KC
      IF (NCK(2).EQ.0) NCK(2)=KC
      CALL CLOCK(TIME0)
      COUPL(1)=COUPL1
      IF (IABG.GE.3) COUPL(1)=COUPL(12)
C       NOTE---THE SL-COUPLING OPTION CONCERNS ONLY (SCRS4,SCRL4)SCRJ8.
C          THE JJ, JK, ETC. REPRESENTATIONS STILL USE (LI,SI)JI.
      IF (IRES.EQ.7) WRITE (IW,4)
      IRES=7
      WRITE (IW,15) COUPL(KCPL),NSCONF,IABG,IV,NLT11,KCPLD,SJXK,
     1  ILNCUV,IPLEV,ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD
   15 FORMAT (11H0RCG MOD 11,A6,9H COUPLING,4X,7HNSCONF=,3I2,3X,
     1  2I2,I3,4X,5HIABG=,I1,3X,3HIV=,I1,2X,I4,1X,9I1,2F5.1,2X,
     2  6HPRINT=,5I1, I4,4I2)
      IF (IW6.LT.0)
     1  WRITE (*,15) COUPL(KCPL),NSCONF,IABG,IV,NLT11,KCPLD,SJXK,
     2  ILNCUV,IPLEV,ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD
      IF (ICTBCD.NE.0) THEN
        OPEN(19,FILE='TAPE19',STATUS='UNKNOWN')
        REWIND 19
      ENDIF
      IF (ICTBCD.LE.0.AND.IELPUN.LT.2) GO TO 180
      IF (IRW19.NE.0) GO TO 180
      REWIND 19
      IRW19=7
  180 IF (NOCSET.EQ.0) GO TO 200
      ICTBCD=0
      IF (NOCSET.LT.0) GO TO 200
  182 READ (2) NOCDES,NSCRJ8,NPAR,J1X
      NPAR=NPAR-J1X+1
      DO 183 N=1,NSCRJ8
      READ (2) L
      DO 183 M=1,NPAR
  183 READ (2) A
      IF (NOCDES.NE.NOCSET) GO TO 182
      GO TO 100
C
C          CALC LEVEL DESIGNATIONS AND COEFFICIENT MATRICES
C
C 200 CALL OVERLAY(2HG9,2,0)
  200 CALL LNCUV
      CALL CLOCK(TIME)
      DELT=TIME-TIME0
      WRITE (IW,25) DELT
   25 FORMAT (/19H0FINISHED LNCUV AT ,F6.3,4H MIN)
      IF (IW6.LT.0) WRITE (*,1025) DELT
 1025 FORMAT (/19H FINISHED LNCUV AT ,F6.3,4H MIN)
C
      IL=ILA
      REWIND IC
      ICPTR=0
      NOICWR=0
      K=1
C
  400 KK=K
      NOIC(K)=NOICWR
      NOICMUP(K)=0
      NOLSKP=NOTKP(K)
      DO I=1,KS
        LL(I)=LLIJK(I,1,K)
        FLL(I)=FLLIJK(I,1,K)
      ENDDO
      NOSUBC=NSCONF(1,K)
      SJN=SJNK(K)
      SJX=SJXK(K)
      IF (ICTC.EQ.0) THEN
C       CALL OVERLAY(2HG9,3,0)
        CALL PLEV
        CALL CLOCK(TIME)
        DELT=TIME-TIME0
        WRITE (IW,26) DELT
   26   FORMAT (/19H0FINISHED PLEV AT  ,F6.3,4H MIN/1H1)
        IF (IW6.LT.0) WRITE (*,1026) DELT   
 1026   FORMAT (19H FINISHED PLEV AT  ,F6.3,4H MIN)
C       CALL OVERLAY(2HG9,4,0)
        WRITE (IW,2601)
 2601   FORMAT (/19H STARTING PFGD.....)
        CALL PFGD
        CALL CLOCK(TIME)
        DELT=TIME-TIME0
        IF (IW6.LT.0) WRITE (*,1027) DELT
 1027   FORMAT (19H FINISHED PFGD AT  ,F6.3,4H MIN)
        WRITE (IW,2602) DELT
 2602   FORMAT (/19H0FINISHED PFGD AT  ,F6.3,4H MIN/1H1)
        IF (NSCONF(1,2).EQ.0.AND.ICPC.EQ.9) GO TO 100
        IF (NSCONF(2,K).GT.1) THEN
C         CALL OVERLAY(2HG9,5,0)
          WRITE (IW,2603)
 2603     FORMAT (/19H STARTING PRK......)
          CALL PRK
          CALL CLOCK(TIME)
          DELT=TIME-TIME0
          IF (IW6.LT.0) WRITE (*,1028) DELT
 1028     FORMAT (18H FINISHED PRK AT  ,F7.3,4H MIN)          
          WRITE (IW,2604) DELT
 2604     FORMAT (/19H0FINISHED PRK  AT  ,F6.3,4H MIN/1H1)
        ENDIF
        NOPC=25
        NPAR1=-7
        J1=1
        WRITE (20) NPAR1,KPAR,K,I,J,AA,CAVE,J1,NOPC,(PC(N1),N1=1,NOPC)
        REWIND 20
        J1X=NSCONF(2,K)
        NOTSX=0
        DO I=1,NOSUBC
          NOTSX=MAX0(NOTSJ1(I,J1X+1),NOTSX)
        ENDDO
        REWIND IL
        ILC=IL
        DO NN=1,2
          WRITE (ILC) NOTSJ1,NSCRJ8,SJ8MN,SJ8MX,NPAR,NPARJ,PARNAM,
     1      NOTSX, ((FL(L,I),S(L,I), L=1,NOTSX), I=1,NOSUBC),NALSJP,PJ
          ILC=IC
        ENDDO
        ICPTR=ICPTR+1
        NOICWR=NOICWR+1
C       CALL OVERLAY(2HG9,6,0)
C            WRITE (*,2468) NOICWR,NOICMUP
C2468   FORMAT (' NOICWR,NOICMUP=',I5,2X,2I5)
        WRITE (IW,2605)
 2605   FORMAT (/19H STARTING CALCFC...)
        CALL CALCFC
        CALL CLOCK(TIME)
        DELT=TIME-TIME0
        IF (IW6.LT.0) WRITE (*,1029) DELT
 1029   FORMAT (19H FINISHED CALCFC AT,F6.3,4H MIN)         
C            WRITE (*,2468) NOICWR,NOICMUP
        WRITE (IW,2606) DELT
 2606   FORMAT (/19H0FINISHED CALCFC AT,F6.3,4H MIN/1H1)
        IARG1=0
        IARG2=IL
        IARG3=IL
        IRMN=1
        IRMX=1
C       IF (IMAG.EQ.K.OR.IMAG.GT.2) CALL OVERLAY(2HG9,7,0)
        IF (IMAG.EQ.K.OR.IMAG.GT.2) CALL MUPOLE
C            WRITE (*,2468) NOICWR,NOICMUP
        IARG1=2
        IRMN=IRNQ
        IRMX=IRXQ
C       IF (IQUAD.EQ.K.OR.IQUAD.GT.2) CALL OVERLAY(2HG9,7,0)
        IF (IQUAD.EQ.K.OR.IQUAD.GT.2) CALL MUPOLE
C            WRITE (*,2468) NOICWR,NOICMUP
      ENDIF
      REWIND IL
      IF (IL.EQ.ILB) GO TO 500
      IF (NSCONF(1,2).LE.0) GO TO 600
      IL=ILB
      K=2
      GO TO 400
C
  500 IARG1=IIPRTY
      IARG2=ILA
      IARG3=ILB
      IRMN=IRND
      IRMX=IRXD
      IF (ICTC.NE.0) GO TO 600
C     CALL OVERLAY(2HG9,7,0)
      CALL MUPOLE
C          WRITE (*,2468) NOICWR,NOICMUP
C
C          CALCULATE ENERGY LEVELS AND SPECTRA
C
      WRITE (IW,2607)
 2607 FORMAT (/19H STARTING ENERGY...)
C 600 CALL OVERLAY(2HG9,8,0)
  600 CALL ENERGY
      WRITE (IW,2608) DELT
 2608 FORMAT (/19H0FINISHED ENERGY AT,F6.3,4H MIN/1H1)
      REWIND ILA
      REWIND ILB
      GO TO 100
      END
********** End of Main Program ********************
C
      BLOCK DATA 
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      PARAMETER (KBGKS=41,KENRGS=21,KCASE=50,KTRAN=600,KLAM=10000)
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      CHARACTER*8 FIDLS,FIDJJ,LDES,LDESP,PARNAM,AA,COUPL
      CHARACTER*4 LSYMB
      COMMON/CHAR/PARNAM(KPR,2),FIDLS(KMX,2),FIDJJ(KMX,2),LDES(KMX),
     1  LDESP(KMX)
      COMMON/PWBORN/NBIGKS,NENRGS,EKMINL,EKMAXL,DELEKL,BIGKS(KBGKS),
     1  XMIN,XMAX,TEV(25),CORR(KENRGS),IBK,IPWR,I11
      COMMON/TIMING/TINIT,ITINIT
C
      DATA ITINIT /0/                        ! INIT TIMING FOR IBM-PC
      DATA PARNAM(1,1),PARNAM(1,2)/'EAV     ','EAV     '/
      DATA (COUPL(I),I=1,12)/6H    LS,6H    JJ,6H  JJJK,6H  LSLK,
     1  6H  LSJK,6HLSJLKS,6HLSJLSJ,6HJ1-LSJ,1H ,1H ,1H ,6H    SL/
      DATA (LSYMB(I),I=1,24)/1HS,1HP,1HD,1HF,1HG,1HH,1HI,
     1  1HK,1HL,1HM,1HN,1HO,1HQ,1HR,1HT,1HU,1HV,1HW,
     2  1HX,1HY,1HZ,1HA,1HB,1HC/
      DATA TEV/1.D0,1.5D0,2.D0,3.D0,5.D0,7.D0,10.D0,15.D0,20.D0,30.D0,
     1  50.D0,70.D0,100.D0,150.D0,200.D0,300.D0,500.D0,700.D0,1000.D0,
     2  1500.D0,2000.D0,3000.D0,5000.D0,7000.D0,10000.D0/
      END
C
      FUNCTION CIJKF(A,B,C)
C
      IMPLICIT REAL*8 (A-H,O-Z)
C
      D=S3J0SQ(A,B,C)
      D=DSQRT((2.D0*A+1.D0)*(2.D0*B+1.D0)*D)
      TWO=2.D0
      IF (DMOD(0.5D0*(B+C-A),TWO).NE.0.D0) D=-D
      CIJKF=D
      RETURN
      END
      SUBROUTINE LOCDSK(IDSK,FLLDES,NIDES)
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
C
      REWIND IDSK
  100 READ (IDSK) LLD,NID,FLLD,NOT,NLT,NORCD
      IF (FLLD.EQ.FLLDES.AND.NID.EQ.NIDES) GO TO 300
      DO 200 NN=1,NORCD
  200 READ (IDSK)
      GO TO 100
  300 RETURN
      END
      SUBROUTINE SPRIN
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2A/SJ8K(2),NOTSJP(KS,100),NCFGP(KMX),NALSP(KMX,KS)
      COMMON/C3A/ISUBJ(KC),MULS(KS),LHS(KS),
     1  NALS(KMX,KS),NCFG(KMX),NALSJ(KMX,KS),SCRL(KMX,KS),SCRS(KMX,KS),
     2  FJ(KMX,KS),SCRJ(KMX,KS), MUL(KS),LH(KS),LF(KLSC),NSJK(110),
     3  FK(KMX),FKJ(KMX),SCRL6(KMX),SCRS6(KMX),FK6(KMX),LHQQ(KMX),
     4  MULTQQ(KMX),NALSJP(KJP,KS),PJ(KJP,KS),NOICRD
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      COMMON/CC/   C(KMX,KMX)
      COMMON/C3LC2/TMX(KMX,KMX)
      COMMON/C3LC3/CT4(KMX,KMX)
      COMMON/C3LC4/VECT(KMX,KMX)
      COMMON/C3LCD/DUMLC5
      COMMON/EE/ELEM(3,KC,2),VPAR(KPR,2),AVP(9,2),AVEIG(2),AVCG(2),
     1  NPARK(2),NPAV(KC),    EIG(KMX),ELEM1(3),FNT(9,2),I1,I2,
     2  IFACT(4),FACT(4),LCSER(KMX),X(KMX)
      DIMENSION TMXP(KMX,KMX)
      EQUIVALENCE (VECT,TMXP)
      CHARACTER*8 IDELEM(11),ELEM,D,E
      CHARACTER*8 FIDLS,FIDJJ,LDES,LDESP,PARNAM,COUPL
      CHARACTER*4 LSYMB
      COMMON/CHAR/PARNAM(KPR,2),FIDLS(KMX,2),FIDJJ(KMX,2),LDES(KMX),
     1  LDESP(KMX)
      PARAMETER (MAXBC=50000)
      CHARACTER*12 BUFC
      COMMON/BUFS/BUFC(MAXBC)
C
C
C          PRINT COEF, MUPOLE, ENERGY, OR EIGENVECTOR MATRIX.
C               IF NECESSARY, TRANSFORM AND PRINT AGAIN.
C               FOR MUPOLE ELEMENTS, ALSO PRINT SQUARES.
C          KPAR=-1,0,+1,+2 FOR FK,GK,ZETA,MUPOLE,RESPECTIVELY.
C          KPAR=-2 FOR RK
C          KPAR=+3,+4 FOR ENERGY OR EIGENVECTOR MATRIX, RESPECTIVELY.
C
C
C     KS=8
      K=KK
      J1X=NSCONF(2,K)
      JAB=MAX0(J1B-J1A,1)
      ITEST=0
  100 IF (KPAR.LT.2) THEN
        IF (ICFC.EQ.3.AND.KPAR.NE.-2) ITEST=1
        IF (ICFC.EQ.4.AND.KPAR.EQ.-2) ITEST=1
        IF (ICFC.GT.4) ITEST=1
        IF (ITEST.GT.0) WRITE (IW,10)
   10   FORMAT (1H2)
      ENDIF
  108 IP=1
      KCPL1=1
      IF (KPAR-1) 121,115,170
  115 KCPL1=KCPL
      GO TO 121
C
  120 IF (KPAR-1) 121,121,170
  121 NLSP=NLS
      IF (ITEST.NE.0) THEN
        WRITE (IW,14) PARNAM(NPAR,K),CAVE,COUPL(KCPL1),SCRJ8,
     1    (JN, (LLIJK(L,JN,K),NIJK(L,JN,K), L=1,KS), JN=J1A,J1B,JAB)
   14   FORMAT (1H0,A10,6X,5HCAVE=,F9.5,10X,A6,9H COUPLING,8X,2HJ=,F4.1,
     1    10X,6HCONFIG,I3,8(2X,A1,I2)/84X,I3,8(2X,A1,I2))
        WRITE (IW,15)
   15   FORMAT (1H0)
      ENDIF
      GO TO 200
  170 IF (KPAR-3) 171,180,190
  171 IP=2
      I12=1
      JX=MAX0(NSCONF(2,I1),NSCONF(2,I2))
      JXM1=MIN0(JX-1,8)
      IF (IDIP.EQ.0) GO TO 200
      IF (IDIP.GT.1) WRITE (IW,10)
  172 DO 174 J=1,JX
        IF (J.GT.JXM1.AND.J.LT.JX) GO TO 174
        WRITE (IW,16) I12,IX, J,(LLIJK(L,J,I1),NIJK(L,J,I1),L=1,KS),
     1    SCRJ8,J,(LLIJK(L,J,I2),NIJK(L,J,I2), L=1,KS),SCRJ8P,
     2    COUPL(KCPL1)
  174 CONTINUE
   16 FORMAT (7H MUP MX,I3,4H II=,I1,I3,8(2X,A1,I2),3X,2HJ=,
     1  F4.1,4H ---,I3,8(2X,A1,I2),3X,3HJP=,F4.1,2X,A6,4H CPL)
      WRITE (IW,15)
      GO TO 200
C
  180 KCPL1=KCPL
      NLST=NLS
      IF (IENGYD.GT.2) NLS=MIN0(NLS,11*IENGYD)
      NLSP=NLS
      JXJ=J1X
      I=5
      IF (IENGYD.LT.200) I=1
      IF (SCRJ8.NE.SJ8MN) JXJ=MIN0(JXJ,I)
      WRITE (IW,18)  COUPL(KCPL1),SCRJ8,   ((ELEM(I,JN,K), I=1,3),
     1  JN, (LLIJK(L,JN,K),NIJK(L,JN,K), L=1,KS), JN=1,JXJ)
   18 FORMAT (15H1 ENERGY MATRIX,4H   (,A6,9H COUPLING,1H),7X,
     1  2HJ=,F4.1,7X,3A6,5X,6HCONFIG,I3,8(2X,A1,I2)/
     2  (55X,3A6,11X,I3,8(2X,A1,I2)))
      IF (JXJ.LT.J1X) WRITE (IW,13)
     1  (ELEM(I,J1X,K),I=1,3), J1X,(LLIJK(L,J1X,K),NIJK(L,J1X,K),L=1,KS)
   13 FORMAT (55X,3A6,11X,I3,8(2X,A1,I2))
      WRITE (IW,15)
      IF (IENGYD-2) 500,200,200
C
  190 KCPL1=KCPL
      NLSP=NLS
  191 IF (KCPL1.EQ.1) THEN
C                CALCULATE G-FACTORS
  192   M=NOSUBC
        IF (SCRJ8.GT.0.D0) THEN
          DO 193 L=1,NLS
            SS=SCRS(L,M)
            SL=SCRL(L,M)
  193     CT4(L,1)=0.50116D0*(SS*SS+SS-SL*SL-SL)
     1      /(SCRJ8*SCRJ8+SCRJ8)+1.50116D0
          DO 194 N=1,NLS
            SS=0.D0
            DO 194 L=1,NLS
              SL=C(L,N)
              SL=SL*SL
              SS=SS+CT4(L,1)*SL
  194     CT4(N,2)=SS
          WRITE  (IW,20) (CT4(N,2), N=1,NLS)
   20     FORMAT (//11H   G-VALUES/(28X,11F9.3))
        ENDIF
      ENDIF
      IPRINT=KCPLD(9)
  196 IF (KCPLD(KCPL1).GT.0.OR.IPRINT.GE.8) GO TO 281  ! SKIP THE PRINT LOOP
      WRITE (IW,19) COUPL(KCPL1)
   19 FORMAT (//15H   EIGENVECTORS,4H   (,A6,9H COUPLING,1H)/)
C
  200 IF ((KPAR.LT.2.AND.ITEST.LE.0).OR.(KPAR.EQ.2.AND.IDIP.LE.1)) 
     1  GO TO 282             ! SKIP THE PRINT LOOP
      LX=0
  210 LN=LX+1
      LX=LX+11
      IF (LX.GT.NLSP) LX=NLSP
  212 IF (KPAR.LT.4) THEN
        IF (KPAR.EQ.2) THEN
          WRITE (IW,24) (NCFGP(L), L=LN,LX)
        ELSE
          WRITE (IW,24) (NCFG(L), L=LN,LX)
        ENDIF
        IF (KCPL1.EQ.1) THEN
          WRITE (IW,22) (FIDLS(L,IP), L=LN,LX)
   22     FORMAT (28X, 11(3H  (,A8,:))
        ELSE
          WRITE (IW,23) (FIDJJ(L,IP), L=LN,LX)
   23     FORMAT (28X, 11(2H (,A7,:))
        ENDIF
        WRITE (IW,24) (L, L=LN,LX)
   24   FORMAT (26X,11(I9,2X))
        IF (KPAR-3) 250,290,245
      ENDIF
  245 WRITE (IW,24)
      IF (KCPL1.NE.KCPL) GO TO 248
      DO 246 L=LN,LX
        N=LCSER(L)
C 246   ENCODE (8,28,IDELEM(L-LN+1)) ELEM(2,N,K),ELEM(3,N,K)
  246 WRITE (IDELEM(L-LN+1),28) ELEM(2,N,K),ELEM(3,N,K)
   28 FORMAT (A6,A2)
      N=(LN+11)/11
      WRITE (IW,25) N, (IDELEM(L-LN+1),L=LN,LX)
   25 FORMAT (I21,9X,11(A8,1X))
      WRITE (IW,29) (LDES(L),L=LN,LX)
   29 FORMAT (30X,11(1H(,A8,:))
  248 IF (LN.GT.NEVMAX) GO TO 281    ! BREAK THE LOOP
C
C          PRINT COEF, DIPOLE, OR EIGENVECTOR MATRIX
C
  250 DO 280 L=1,NLS
        N=NCFG(L)
        D=ELEM(2,N,K)
        E=ELEM(3,N,K)
C       IF (KPAR.LE.2) THEN
C         D='      '
C         E=D
C       ENDIF
  255   IF (KCPL1.LE.1) THEN
          WRITE (IW,26) N,D,E, FIDLS(L,1), L, (C(L,LP), LP=LN,LX)
   26     FORMAT (I3,1H:,2A6, 1H(,A7, I3,1X,11F9.5)
        ELSE
          WRITE (IW,27) N,D,E, FIDJJ(L,1), L, (C(L,LP), LP=LN,LX)
   27     FORMAT (I3,1H:,2A6, 1H(,A8, I3,11F9.5)
        ENDIF
  280 CONTINUE
      IF (LX.LT.NLSP) GO TO 210      ! LOOP BACK TO NEXT LN,LX
  281 WRITE (IW,27)
      IF (KPAR.GE.4) GO TO 283
  282 IF (KCPL1-KCPL) 300,400,300
  283 IF (NLS.GT.1) THEN
        PUR=0.D0
        DO 286 N=1,NLS
          FNLS=0.D0
          DO 285 L=1,NLS
            ERAS=C(L,N)
            ERAS=ERAS*ERAS
            IF (ERAS.GT.FNLS) FNLS=ERAS
  285     CONTINUE
          CT4(N,1)=FNLS
  286   PUR=PUR+FNLS
        FNLS=NLS
        AVP(KCPL1,K)=AVP(KCPL1,K)+PUR
        FNT(KCPL1,K)=FNT(KCPL1,K)+FNLS
        PUR=PUR/FNLS
        NNN=MIN0(NLS,NEVMAX)
        WRITE (IW,30) PUR, (CT4(N,1), N=1,NNN)
   30   FORMAT (13X,8H PURITY=,F5.3,2X,11F9.5/(28X,11F9.5))
      ENDIF
  288 IF (NOLSKP.NE.0) GO TO 398
      IF (KCPL1-KCPL) 400,289,400
  289 IF (NLS-1) 400,400,300
C
C          PRINT ENERGY MATRIX
C
  290 ERAS=C(1,1)
      DO 298 L=1,NLS
        N=NCFG(L)
        D=ELEM(2,N,K)
        E=ELEM(3,N,K)
        IF (KCPL1.LE.1) THEN
  291     IF (ERAS.LE.9999.D0) THEN
            WRITE (IW,31) N,D,E, FIDLS(L,1), L, (C(L,LP), LP=LN,LX)
   31       FORMAT (I3,1H:,2A6, 2H (,A8, I3,1X,11(F9.3,2X))
          ELSE
  292       WRITE (IW,32) N,D,E, FIDLS(L,1), L, (C(L,LP), LP=LN,LX)
   32       FORMAT (I3,1H:,2A6, 2H (,A8, I3,1X,11(F9.2,2X))
          ENDIF
        ELSE
  295     IF (ERAS.LE.9999.D0) THEN
            WRITE (IW,33) N,D,E, FIDJJ(L,1), L, (C(L,LP), LP=LN,LX)
   33       FORMAT (I3,1H:,2A6,  2H (,A7, I3,11F9.3)
          ELSE
  296       WRITE (IW,34) N,D,E, FIDJJ(L,1), L, (C(L,LP), LP=LN,LX)
   34       FORMAT (I3,1H:,2A6,  2H (,A7, I3,11F9.2)
          ENDIF
        ENDIF
  298 CONTINUE
      IF (LX.LT.11*IENGYD.AND.LX.LT.NLSP) GO TO 210   ! LOOP BACK
  299 WRITE (IW,34)
      NLS=NLST
      GO TO 500
C
C          TRANSFORM MATRIX
C
  300 IF (KCPL1.GT.1) GO TO 355
  305 DO L=1,NLS
        DO LP=1,NLSP
          TEMP=0.D0
          DO L0=1,NLS
            TEMP=TEMP+TMX(L0,L)*C(L0,LP)
          ENDDO
          CT4(L,LP)=TEMP
        ENDDO
      ENDDO
      IF (KPAR-2) 331,321,396
  321 DO L=1,NLS
        DO LP=1,NLSP
          TEMP=0.D0
          DO L0=1,NLSP
            TEMP=TEMP+CT4(L,L0)*TMXP(L0,LP)
          ENDDO
          C(L,LP)=TEMP
        ENDDO
      ENDDO
      GO TO 395
  331 DO L=1,NLS
        DO LP=1,L
          TEMP=0.D0
          DO L0=1,NLS
            TEMP=TEMP+CT4(L,L0)*TMX(L0,LP)
          ENDDO
          C(L,LP)=TEMP
          C(LP,L)=TEMP
        ENDDO
      ENDDO
      GO TO 395
C
  355 IF (IABS(KPAR).GT.1) THEN
        DO L=1,NLS
          DO LP=1,NLSP
            TEMP=0.D0
            DO L0=1,NLS
              ERAS=TMX(L,L0)
              IF (ERAS.NE.0.D0) TEMP=TEMP+ERAS*C(L0,LP)
            ENDDO
            CT4(L,LP)=TEMP
          ENDDO
        ENDDO
      ELSE
        DO L=1,NLS
          NTEMP=NCFG(L)
          DO LP=1,NLSP
            TEMP=0.D0
            IF (NTEMP.EQ.NCFG(LP)) THEN
              DO L0=1,NLS
                ERAS=TMX(L,L0)
                IF (ERAS.NE.0.D0) TEMP=TEMP+ERAS*C(L0,LP)
              ENDDO
            ENDIF
            CT4(L,LP)=TEMP
          ENDDO
        ENDDO
      ENDIF
      IF (KPAR-2) 381,371,397
  371 DO L=1,NLS
        DO LP=1,NLSP
          TEMP=0.D0
          DO L0=1,NLSP
            TEMP=TEMP+CT4(L,L0)*TMXP(LP,L0)
          ENDDO
          C(L,LP)=TEMP
        ENDDO
  380 ENDDO
      GO TO 395
  381 IF (IABS(KPAR).GT.1) THEN
        DO L=1,NLS
          DO LP=1,L
            TEMP=0.D0
            DO L0=1,NLS
              ERAS=TMX(LP,L0)
              IF (ERAS.NE.0.D0) TEMP=TEMP+CT4(L,L0)*ERAS
            ENDDO
            C(L,LP)=TEMP
            C(LP,L)=TEMP
          ENDDO
        ENDDO
      ELSE
        DO L=1,NLS
          NTEMP=NCFG(L)
          DO LP=1,L
            TEMP=0.D0
            IF (NTEMP.EQ.NCFG(LP)) THEN
              DO L0=1,NLS
                ERAS=TMX(LP,L0)
                IF (ERAS.NE.0.D0) TEMP=TEMP+CT4(L,L0)*ERAS
              ENDDO
            ENDIF
            C(L,LP)=TEMP
            C(LP,L)=TEMP
          ENDDO
        ENDDO
      ENDIF
C
  395 IF (KPAR.LT.2.AND.ITEST.GT.0) WRITE (IW,35)
      IF (KPAR.EQ.2.AND.IDIP.GT.1) WRITE (IW,35)
   35 FORMAT (1H0)
      KCPL1=KCPL
      GO TO 120
  396 KCPL1=2
      GO TO 398
  397 KCPL1=1
C               STORE EIGENVECTORS IN COUPLING KCPL
  398 DO L=1,NLS
        DO LP=1,NLS
          VECT(L,LP)=C(L,LP)
          C(L,LP)=CT4(L,LP)
        ENDDO
      ENDDO
      IF (NOLSKP.EQ.0) GO TO 191
C
  400 IF (KPAR.EQ.2.AND.I12.LT.2) THEN
C       WRITE (IC) SCRJ8,SCRJ8P,NLS,NLSP, ((C(L,LP),L=1,NLS), LP=1,NLSP),
C    1    NCFG,NCFGP
C************************************************************ A.KRAMIDA v
        WRITE (IC) SCRJ8,SCRJ8P,NLS,NLSP,NCFG,NCFGP
        IMSQ=NLS*NLSP
        CALL PK1(IC,NLS,NLSP,C,KMX,KMX,BUFC,IMSQ,MAXBC)   !,1,IW)
        ICPTR=ICPTR+2
C************************************************************ A.KRAMIDA ^
        NOICWR=NOICWR+2
        NOICMUP(KK)=NOICMUP(KK)+2
        IF (IDIP.NE.0) THEN
          DO L=1,NLS
            DO LP=1,NLSP
              C(L,LP)=C(L,LP)**2
            ENDDO
          ENDDO
          WRITE (IW,35)
          I12=2
          GO TO 172
        ENDIF
      ENDIF
C
  500 IF (KPAR.GE.2.OR.ITEST.NE.0) THEN
        CALL CLOCK(TIME)
        DELT=TIME-TIME0
        WRITE (IW,50) DELT
   50   FORMAT (11X,5HTIME=,F9.3,4H MIN)
        IF (KPAR.EQ.2.AND.IW6.LT.0) WRITE (*,51) SCRJ8,SCRJ8P,DELT,
     1    NLS,NLSP
   51   FORMAT (' DONE MUPOLE MATRIX FOR J=',F3.1,', JP=',
     1    F3.1,'; TIME=',F9.2,4H MIN,'; SIZE=',I4,' BY ',I4)
        IF (KPAR.EQ.4.AND.IW6.LT.0) WRITE (*,52) SCRJ8,DELT,NLS
   52   FORMAT (' DONE ENERGY FOR  J=',F3.1,
     1    '  AT TIME=',F9.2,4H MIN,',     MATRIX SIZE=',I4)
        IF (KPAR.GE.4) CALL SPRN37
      ENDIF
  600 RETURN
      END
C
      SUBROUTINE SPRN37
C
C          PRINT EIGENVECTORS IN REPRESENTATIONS 3-7
C
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3A/ISUBJ(KC),MULS(KS),LHS(KS),
     1  NALS(KMX,KS),NCFG(KMX),NALSJ(KMX,KS),SCRL(KMX,KS),SCRS(KMX,KS),
     2  FJ(KMX,KS),SCRJ(KMX,KS), MUL(KS),LH(KS),LF(KLSC),NSJK(110),
     3  FK(KMX),FKJ(KMX),SCRL6(KMX),SCRS6(KMX),FK6(KMX),LHQQ(KMX),
     4  MULTQQ(KMX),NALSJP(KJP,KS),PJ(KJP,KS),NOICRD
      COMMON/CC/   C(KMX,KMX)
      COMMON/C3LC2/TMX(KMX,KMX)
      COMMON/C3LC3/CT4(KMX,KMX)
      COMMON/C3LC4/VECT(KMX,KMX)
      COMMON/C3LCD/DUMLC5
      COMMON/EE/ELEM(3,KC,2),VPAR(KPR,2),AVP(9,2),AVEIG(2),AVCG(2),
     1  NPARK(2),NPAV(KC),    EIG(KMX),ELEM1(3),FNT(9,2),I1,I2
     2  ,IFACT(4),FACT(4)
      PARAMETER (MAXBC=50000)
      CHARACTER*12 BUFC
      COMMON/BUFS/BUFC(MAXBC)
C
      K=KK
  100 IF (NOSUBC.LE.1.OR.NLS.LE.1.OR.NLS.GT.NLSMAX) GO TO 940
      KCPL1=3
      IQ=NOSUBC
      IQM1=IQ-1
      IQM2=IQ-2
C
  110 IF (KCPLD(KCPL1)) 150,150,900
C 150 READ (IC) ((TMX(L,LP), LP=1,NLS),  FK(L),FKJ(L),SCRJ(L,IQM1),
C    1  SCRJ(L,IQM2),SCRL6(L),FK6(L),SCRS6(L),LHQQ(L),MULTQQ(L),L=1,NLS)
C     NOICRD=NOICRD+1
C *****************************************************
  150 READ (IC) (FK(L),FKJ(L),SCRJ(L,IQM1),
     1  SCRJ(L,IQM2),SCRL6(L),FK6(L),SCRS6(L),LHQQ(L),MULTQQ(L),L=1,NLS)
      NOICRD=NOICRD+1
      IMSQ=NLS*NLS
      CALL UNPK1(IC,NLS,NLS,TMX,KMX,KMX,BUFC,IMSQ,MAXBC)
      ICPTR=ICPTR+2
      NOICRD=NOICRD+1
      IPRINT=KCPLD(9)
      IF (IPRINT.GE.8) GOTO 900
C *****************************************************
C
C          TRANSFORM EIGENVECTORS
C
  200 DO L=1,NLS
        DO LP=1,NLS
          TEMP=0.D0
          DO I=1,NLS
            TEMP=TEMP+TMX(I,L)*VECT(I,LP)
          ENDDO
          C(L,LP)=TEMP
        ENDDO
      ENDDO
C
C          PRINT EIGENVECTORS IN NEW COUPLING
C
      WRITE (IW,22) COUPL(KCPL1)
   22 FORMAT (//15H   EIGENVECTORS,4H   (,A6,9H COUPLING,1H)/)
C
      LX=0
  240 LN=LX+1
      LX=LX+11
      IF (LX.GT.NLS) LX=NLS
  242 DO 250 L=1,NLS
      N=NCFG(L)
      D=ELEM(2,N,K)
      E=ELEM(3,N,K)
      GO TO (243,243,243,244,245,246,247) KCPL1
  243 WRITE (IW,23) N,D,E,SCRJ(L,IQM1),FKJ(L),L,(C(L,LP),LP=LN,LX)
   23 FORMAT (I3,1H=,A6,A5,F4.1,1HK,F4.1,I3,1X,11F9.5)
      GO TO 250
  244 LP1=SCRL(L,NOSUBC)+1.D0
      LHS4=LSYMB(LP1)
      WRITE (IW,24) N,D,E,LHS4,FK(L),L,(C(L,LP),LP=LN,LX)
   24 FORMAT (I3,1H=,2A6,2X,A1,F4.1,I4,1X,11F9.5)
      GO TO 250
  245 WRITE (IW,23) N,D,E,SCRJ(L,IQM1),FK(L),L,(C(L,LP),LP=LN,LX)
      GO TO 250
  246 WRITE (IW,26) N,D,E,SCRJ(L,IQM2),LHQQ(L),FK6(L),MULTQQ(L),L,
     1  (C(L,LP), LP=LN,LX)
   26 FORMAT (I3,1H=,A6,A5,F4.1,A1,F3.1,I2,I3,11F9.5)
      GO TO 250
  247 WRITE (IW,27) N,D,E,SCRJ(L,IQM2),MULTQQ(L),LHQQ(L),SCRJ(L,IQM1),
     1  L, (C(L,LP), LP=LN,LX)
   27 FORMAT (I3,1H=,A6,A5,F4.1,I2,A1,F3.1,I3,11F9.5)
  250 CONTINUE
      WRITE (IW,23)
      IF (LX.GE.NEVMAX) GO TO 300
      IF (LX-NLS) 240,300,300
C
C          CALCULATE PURITIES
C
  300 IF (NLS.LE.1) GO TO 900
      PUR=0.D0
      DO N=1,NLS
        TEMP=0.D0
        DO L=1,NLS
          ERAS=C(L,N)**2
          IF (ERAS.GT.TEMP) TEMP=ERAS
        ENDDO
        PUR=PUR+TEMP
        CT4(N,1)=TEMP
      ENDDO
      FNLS=NLS
      AVP(KCPL1,K)=AVP(KCPL1,K)+PUR
      FNT(KCPL1,K)=FNT(KCPL1,K)+FNLS
      PUR=PUR/FNLS
      NNN=MIN0(NLS,NEVMAX)
      WRITE  (9,30) PUR, (CT4(N,1), N=1,NNN)
   30 FORMAT (13X,8H PURITY=,F5.3,2X,11F9.5/(15X,11F9.5))
C
C
  900 KCPL1=KCPL1+1
      IF (KCPL1-4) 110,110,910
  910 IF (KCPL1-6) 920,110,921
  920 IF (IQ-3) 930,110,110
  921 IF (KCPL1-7) 110,110,930
  930 CALL CLOCK(TIME)
      DELT=TIME-TIME0
      WRITE (IW,93) DELT
   93 FORMAT (11X,5HTIME=,F9.3,4H MIN)
  940 RETURN
      END
C
      FUNCTION UNCPLA(FJ1,FJ2,FJ, FK,FJ1P,FJP)
C
      IMPLICIT REAL*8 (A-H,O-Z)
C
      A=DSQRT((2.D0*FJ+1.D0)*(2.D0*FJP+1.D0))
      TWO=2.D0
      IF (DMOD(FJ1+FJ2+FJP+FK,TWO).GT.0.D0) A=-A
      UNCPLA=A*S6J(FJ1,FJ,FJ2, FJP,FJ1P,FK)
      RETURN
      END
      FUNCTION UNCPLB(FJ1,FJ2,FJ, FK,FJ2P,FJP)
C
      IMPLICIT REAL*8 (A-H,O-Z)
C
      A=DSQRT((2.D0*FJ+1.D0)*(2.D0*FJP+1.D0))
      TWO=2.D0
      IF (DMOD(FJ1+FJ+FJ2P+FK,TWO).GT.0.D0) A=-A
      UNCPLB=A*S6J(FJ2,FJ,FJ1, FJP,FJ2P,FK)
      RETURN
      END
      FUNCTION RECPSH(FJ1,FJ2,FJP,FJ3,FJ,FJPP)
C
      IMPLICIT REAL*8 (A-H,O-Z)
C
      A=DSQRT((2.D0*FJP+1.D0)*(2.D0*FJPP+1.D0))
      TWO=2.D0
      IF (DMOD(FJ1+FJ2+FJ3+FJ,TWO).GT.0.D0) A=-A
      RECPSH=A*S6J(FJ1,FJ2,FJP, FJ3,FJ,FJPP)
      RETURN
      END
      FUNCTION RECPJP(FJ1,FJ2,FJP,FJ3,FJ,FJPP)
C
      IMPLICIT REAL*8 (A-H,O-Z)
C
      A=DSQRT((2.D0*FJP+1.D0)*(2.D0*FJPP+1.D0))
      TWO=2.D0
      IF (DMOD(FJ1+FJ+FJPP,TWO).GT.0.D0) A=-A
      RECPJP=A*S6J(FJ1,FJ2,FJP, FJ3,FJ,FJPP)
      RETURN
      END
      FUNCTION RECPEX(FJ1,FJ2,FJP,FJ3,FJ,FJPP)
C
      IMPLICIT REAL*8 (A-H,O-Z)
C
      A=DSQRT((2.D0*FJP+1.D0)*(2.D0*FJPP+1.D0))
      TWO=2.D0
      IF (DMOD(FJ2+FJ3+FJP+FJPP,TWO).GT.0.D0) A=-A
      RECPEX=A*S6J(FJ2,FJ1,FJP, FJ3,FJ,FJPP)
      RETURN
      END
      SUBROUTINE CLOCK(TIME)
C
      IMPLICIT REAL*8 (A-H,O-Z)
      CALL SECONDS(T)
      TIME=T/60.D0
      RETURN
      END
      SUBROUTINE SECONDS(T)
C
C          TIMING ROUTINE (RESULTS FOR INFORMATION ONLY)
C               FOR OTHER MACHINES, SET T=0.0 OR ADD
C               APPROPRIATE CODE.
C
      REAL*8 T
      REAL ETIME,T1,T2
      DIMENSION T2(2)
C
C------------------------------------
C          USE THIS CODE FOR A VAX OR MACINTOSH
      T1=SECNDS(0.0)
      T=DBLE(T1)
C------------------------------------
C          USE THIS CODE FOR A CRAY
C     T=SECOND(T)
C------------------------------------
C          USE THIS CODE FOR A SUN
C     T=ETIME(T2)
C-------------------------------------
C          USE THIS CODE FOR IBM RISC
C     IT=MCLOCK()
C     T=IT
C     T=T/100.D0
C-------------------------------------
C          USE THIS CODE FOR IBM-PC LAHEY FORTRAN COMPILER
C     REAL*8 TINIT,T3
C     COMMON/TIMING/TINIT,ITINIT
C     CHARACTER TIMESTR*11
C     INTEGER HH,MM,SS,HS
C     CALL TIME(TIMESTR)
C     READ (TIMESTR,10) HH,MM,SS,HS
C  10 FORMAT (3(I2,1X),I2)
C     T3=DFLOAT(3600*HH+60*MM+SS)+HS*1.D-2
C     IF (ITINIT.EQ.0) THEN
C       TINIT=T3
C       ITINIT=1
C     ENDIF
C     T=T3-TINIT
C-------------------------------------
      RETURN
      END
C
      SUBROUTINE CALCFCT
C
      IMPLICIT REAL*8 (A-H,O-Z)
      COMMON/CFACTRL/SCALE,SCALEM1,FCTN(200),FCTZ,FCT(200)
C
      SCALE=8.D0
      SCALEM1=1.D0/SCALE
      FCTZ=1.D0
      DO 100 I=1,70
      FCTN(I)=0.D0
  100 FCT(I)=FCT(I-1)*DFLOAT(I)*SCALEM1
      RETURN
      END
C
      FUNCTION S9J(A1,A2,A3,A4,A5,A6,A7,A8,A9)
C
      IMPLICIT REAL*8 (A-H,O-Z)
C
      A9J=0.D0
      A=DMAX1(DABS(A1-A9), DABS(A2-A6), DABS(A4-A8))
      C=DMIN1(A1+A9, A2+A6, A4+A8)
      FJ=2.D0*A+1.D0
      J1=FJ
      J2=2.D0*C+1.D0
      IF (J2.LT.J1) GO TO 302
      DO J=J1,J2,2
        A9J=A9J-((-1.D0)**J)*FJ*S6J(A1,A2,A3,A6,A9,A)
     1    *S6J(A4,A5,A6,A2,A,A8)*S6J(A7,A8,A9,A,A1,A4)
        A=A+1.D0
        FJ=FJ+2.D0
      ENDDO
  302 S9J=A9J
      RETURN
      END
C
      FUNCTION S6J(FJ1,FJ2,FJ3,FL1,FL2,FL3)
C
      IMPLICIT REAL*8 (A-H,O-Z)
      COMMON/CFACTRL/SCALE,SCALEM1,FCTN(200),FCTZ,FCT(200)
C
      DELSQ(IA,IB,IC,ID)=FCT(ID-IA)*FCT(ID-IB)*FCT(ID-IC)/FCT(ID+1)
      S6J=0.D0
      S1=FJ1+FJ2+FJ3
      S2=FJ1+FL2+FL3
      S3=FL1+FJ2+FL3
      IS1=S1
      IS2=S2
      IS3=S3
      IF ((S1-DFLOAT(IS1)).GT.0.01D0) GO TO 200
      IF ((S2-DFLOAT(IS2)).GT.0.01D0) GO TO 200
      IF ((S3-DFLOAT(IS3)).GT.0.01D0) GO TO 200
      IS4=FL1+FL2+FJ3
      IS5=FJ1+FJ2+FL1+FL2
      IS6=FJ2+FJ3+FL2+FL3
      IS7=FJ3+FJ1+FL3+FL1
      KN=MAX0(IS1,IS2,IS3,IS4)
      KX=MIN0(IS5,IS6,IS7)
      IF (KX.LT.KN) GO TO 200
      IT1=2.000001D0*FJ1
      IT2=2.000001D0*FJ2
      IT3=2.000001D0*FJ3
      IT4=2.000001D0*FL1
      IT5=2.000001D0*FL2
      IT6=2.000001D0*FL3
      COEF=DSQRT(DELSQ(IT1,IT2,IT3,IS1)*DELSQ(IT1,IT5,IT6,IS2)
     1  *DELSQ(IT4,IT2,IT6,IS3)*DELSQ(IT4,IT5,IT3,IS4))*SCALEM1
      SGN=DFLOAT(-1+2*MOD(KN,2))
      SUM=0.D0
      DO K=KN,KX
        SGN=-SGN
        SUM=SUM+SGN*FCT(K+1)/(FCT(K-IS1)*FCT(K-IS2)*FCT(K-IS3)*
     1    FCT(K-IS4)*FCT(IS5-K)*FCT(IS6-K)*FCT(IS7-K))
      ENDDO
      S6J=COEF*SUM
  200 RETURN
      END
C
      FUNCTION S3J0SQ(FJ1,FJ2,FJ3)
C
C          CALCULATE SQUARE OF 3-J SYMBOL WITH ZERO MAGNETIC QUANTUM NOS
C
      IMPLICIT REAL*8 (A-H,O-Z)
      COMMON/CFACTRL/SCALE,SCALEM1,FCTN(200),FCTZ,FCT(200)
C
      S3J0SQ=0.D0
      FJ=FJ1+FJ2+FJ3
      IFJ=FJ
      IF (MOD(IFJ,2).NE.0) GO TO 100
      IA=FJ-2.D0*FJ1
      IB=FJ-2.D0*FJ2
      IC=FJ-2.D0*FJ3
      IF (IA.LT.0.OR.IB.LT.0.OR.IC.LT.0) GO TO 100
      B=FCT(IA)*FCT(IB)*FCT(IC)/FCT(IFJ+1)
      A=FCT(IFJ/2)/(FCT(IA/2)*FCT(IB/2)*FCT(IC/2))
      S3J0SQ=SCALEM1*B*(A**2)
  100 RETURN
      END
C
      FUNCTION FCTRL(A)                                                 FCTR0030
C                                                                       FCTR0020
C          CALCULATE FACTORIAL OF A                                     FCTR0030
C                                                                       FCTR0040
      IMPLICIT REAL*8 (A-H,O-Z)
C
      FCTRL=1.D0                                                        FCTR0050
      IF (DABS(A)-0.1D0) 10, 10, 11                                     FCTR0060
   10 A=0.D0                                                            FCTR0070
   11 IF (A) 12, 15, 13                                                 FCTR0080
   12 FCTRL=0.D0                                                        FCTR0090
      GO TO 15                                                          FCTR0100
   13 IMAX=A+0.1D0                                                      FCTR0110
      DO 14 I=1,IMAX                                                    FCTR0120
   14 FCTRL=FCTRL*DFLOAT(I)                                             FCTR0130
   15 RETURN                                                            FCTR0140
      END                                                               FCTR0150
C
      SUBROUTINE SORT2(N,L,X,T,Y1,Y2,Y3,Y4,Y5,Y6,Y7,Y8,Y9,Y10,Y11,Y12)
C
C         N NUMBERS IN TABLE X ARE SORTED NUMERICALLY INCREASING IN     MA130002
C         VALUE. THEN L TABLES OF Y ARE REORDERED TO CORRESPOND TO THEIRMA130003
C         ASSOCIATED X. TEMPORARY TABLE T MUST BE 2N WORDS LONG.        MA130004
C
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION X(90),T(180),Y1(90),Y2(90),Y3(90),Y4(90),Y5(90),Y6(90),  MA130005
     1  Y7(90),Y8(90),Y9(90),Y10(90),Y11(90),Y12(90)                      MA130006
      INTEGER T,Y1,Y3,Y4                                                MA130007
C
      IF ( N.LE.1 ) RETURN                                              MA130008
      DO 5 I = 1,N                                                      MA130009
    5 T(I) = I                                                          MA130010
      J = 1                                                             MA130011
    6 IF (X(J).LE.X(J+1)) GO TO 8                                       MA130012
      M = J                                                             MA130013
      ERAS   = X(M+1)                                                   MA130014
    7 X(M+1) = X(M)                                                     MA130015
      T(M+1) = T(M)                                                     MA130016
      M = M - 1                                                         MA130017
      IF ( M.EQ.0 ) GO TO 9                                             MA130018
      IF ( X(M).GT.ERAS   ) GO TO 7                                     MA130019
    9 X(M+1) = ERAS                                                     MA130020
      T(M+1) = J + 1                                                    MA130021
    8 J = J + 1                                                         MA130022
      IF ( J.LT.N ) GO TO 6                                             MA130023
C         COMMENCE ORDERING OF ASSOCIATED TABLES OF Y.                  MA130024
      IF (L.EQ.0) GO TO 100
      GO TO (101,102,103,104,105,106,107,108,109,110,111,112), L
  112 CALL ORDER2(N,T,Y12)                                              MA130048
  111 CALL ORDER2(N,T,Y11)                                              MA130046
  110 CALL ORDER2(N,T,Y10)                                              MA130044
  109 CALL ORDER2(N,T,Y9)                                               MA130042
  108 CALL ORDER2(N,T,Y8)                                               MA130040
  107 CALL ORDER2(N,T,Y7)                                               MA130038
  106 CALL ORDER2(N,T,Y6)                                               MA130036
  105 CALL ORDER2(N,T,Y5)                                               MA130034
  104 CALL ORDERI(N,T,Y4)                                               MA130032
  103 CALL ORDERI(N,T,Y3)                                               MA130030
  102 CALL ORDER2(N,T,Y2)                                               MA130028
  101 CALL ORDERI(N,T,Y1)                                               MA130026
  100 RETURN                                                            MA130049
      END                                                               MA130050
C
      SUBROUTINE ORDERI(N,T,Y)
C
C         A TABLE OF N NUMBERS STARTING AT Y IS ORDERED ACCORDING TO A  MA140002
C         SEQUENCE TABLE IN THE FIRST N WORDS OF T. T MUST BE INTEGER   MA140003
C         AND 2N IN LENGTH.                                             MA140004
C
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION T(100),Y(90)                                             MA140005
      INTEGER T1,T2,T,Y                                                 MA140006
C          THE VARIABLE Y IS TYPE INTEGER
C
      DO 1 I = 1,N                                                      MA140007
      T1 = T(I)                                                         MA140008
      T2 = N + I                                                        MA140009
    1 T(T2) = Y(T1)                                                     MA140010
      DO 2 I = 1,N                                                      MA140011
      T2 = N + I                                                        MA140012
    2 Y(I) = T(T2)                                                      MA140013
      RETURN                                                            MA140014
      END                                                               MA140015
C
      SUBROUTINE ORDER2(N,T,Y)
C
C         A TABLE OF N NUMBERS STARTING AT Y IS ORDERED ACCORDING TO A  MA140002
C         SEQUENCE TABLE IN THE FIRST N WORDS OF T. T MUST BE INTEGER   MA140003
C         AND 2N IN LENGTH.                                             MA140004
C
C          THE VARIABLE Y IS REAL
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KLAM=10000)
      DIMENSION T(KLAM),Y(KLAM),YT(KLAM)                                MA140005
      INTEGER T,T1                                                      MA140006
C
      DO 1 I = 1,N                                                      MA140007
        T1 = T(I)                                                       MA140008
C       T2 = N + I                                                      MA140009
    1 YT(I) = Y(T1)                                                     MA140010
      DO 2 I = 1,N                                                      MA140011
C       T2 = N + I                                                      MA140012
    2 Y(I) = YT(I)                                                      MA140013
      RETURN                                                            MA140014
      END                                                               MA140015
C
      SUBROUTINE ORDERCH(N,T,Y)
C
C         A TABLE OF N CHAR*8  STARTING AT Y IS ORDERED ACCORDING TO A  MA140002
C         SEQUENCE TABLE IN THE FIRST N WORDS OF T. T MUST BE INTEGER   MA140003
C         AND 2N IN LENGTH.                                             MA140004
C
C          THE VARIABLE Y IS CHARACTER*8
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KLAM=10000)
      CHARACTER*8 Y,YT
      DIMENSION T(KLAM),Y(KLAM),YT(KLAM)                                MA140005
      INTEGER T,T1                                                      MA140006
C
      DO 1 I = 1,N                                                      MA140007
        T1 = T(I)                                                       MA140008
C       T2 = N + I                                                      MA140009
    1 YT(I) = Y(T1)                                                     MA140010
      DO 2 I = 1,N                                                      MA140011
C       T2 = N + I                                                      MA140012
    2 Y(I) = YT(I)                                                      MA140013
      RETURN                                                            MA140014
      END                                                               MA140015
C
C     OVERLAY(G9,1,0)
      SUBROUTINE CUVFD
C
C          READ CFP FROM CARDS OR TAPE,
C               AND SET UP TABLES FOR U, V, FK(I,I), D(I)
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3C/CFP(KLS1,KLS1),
     1  MULTBR(KLSI,2),LBRBCD(KLSI,2),IALFBR(KLSI,2),FLBR(KLSI,2),
     2  SBR(KLSI,2),ITRM(KLSI),IPNT(KLSI),ABG(KLSI,3),CAVEI(3),
     3  NALSJI(KJP),PJI(KJP),NJKI(25)
      COMMON       CFPM1(KLS1,KLS1),CFP2(KLS1,KLS1)
      COMMON PC(6100)
      COMMON/SORTDUM/DUM(2),IDUM(2)
C
      DIMENSION CFGP(KLS1,KLS1),UA(KLS1,KLS1),VA(KLS1,KLS1),
     1  UV(KLS1,KLS1),CFGPT(KLS1,KLS1)
      DIMENSION CAVEDN(7),TDN(21,7),T1DN(21,3),T2DN(21,3)
      EQUIVALENCE (CFP2,CFGP,UA,VA),(CFPM1,CFGPT,UV)
C     CHARACTER*10 ZETANM,ABGNAM(3),ABGNM1,ABGNM2,AA
      CHARACTER*8 SORTYS,SORTNO,ZETANM,ABGNAM(3),ABGNM1,ABGNM2,ERAS,AA
      CHARACTER*4 IALF,IALFBR,IA1,LL,L1,LBCD,LBRBCD,LLL,LSYMB,ICUV,
     1            LLM1,LLM2
C
      DATA ZETANM/'ZETA    '/
      DATA (ABGNAM(I),I=1,3)/'ALPHA   ','BETA    ','GAMMA   '/
      DATA ABGNM1,ABGNM2/'ALPHA   ','1000 ALP'/
      DATA IALF1/4H1   /
      DATA SORTYS,SORTNO/8H        ,8HNO SORT /
      DATA CAVEDN/-108.88888887D0,-122.5D0,-116.66666667D0,
     1  -97.22222222D0,-70.D0,-40.83333333D0,-15.55555555D0/
      DATA (TDN(I,1),I=1,5)/60.D0,210.D0,100.D0,170.D0,0.D0/
      DATA (TDN(I,2),I=1,9)/60.D0,210.D0,30.D0,130.D0,210.D0,52.5D0,
     1  34.36931771D0,322.5D0,135.D0/
      DATA (TDN(I,3),I=1,21)/70.D0,10.D0,135.D0,40.D0,30.D0,175.D0,
     1  310.D0,140.D0,37.41657387D0,150.D0,10.D0,66.66666667D0,
     2  -55.27707984D0,248.33333333D0,235.D0,160.D0,127.2792206D0,
     3  190.D0,0.D0,0.D0,640.D0/
      DATA (TDN(I,4),I=1,21)/0.D0,50.D0,30.D0,155.D0,105.D0,5.D0,15.D0,
     1  90.D0,0.D0,170.D0,150.D0,134.1640786D0,230.D0,35.D0,
     2  39.68626967D0,195.D0,0.D0,148.492424D0,275.D0,225.D0,320.D0/
      DATA (TDN(I,5),I=1,21)/0.D0,20.D0,45.D0,20.D0,-30.D0,125.D0,
     1  80.D0,70.D0,-37.41657387D0,300.D0,0.D0,33.33333333D0,
     2  55.27707984D0,91.66666667D0,225.D0,150.D0,-127.2792206D0,
     3  360.D0,0.D0,0.D0,0.D0/
      DATA (TDN(I,6),I=1,9)/0.D0,0.D0,0.D0,50.D0,90.D0,17.5D0,
     1  -34.36931771D0,67.5D0,315.D0/
      DATA (TDN(I,7),I=1,5)/0.D0,0.D0,0.D0,140.D0,0.D0/
      DATA (T1DN(I,1),I=1,9)/-9.D0,21.D0,-15.D0,35.D0,-21.D0,0.D0,
     1  -13.74772708D0,84.D0,-141.D0/
      DATA (T1DN(I,2),I=1,21)/0.D0,-24.D0,26.D0,-12.D0,12.D0,-6.D0,
     1  96.D0,28.D0,14.96662955D0,-136.D0,0.D0,20.D0,-92.86549413D0,
     2  66.D0,-30.D0,-36.D0,118.7939392D0,-144.D0,0.D0,-54.99090834D0,
     3  336.D0/
      DATA (T1DN(I,3),I=1,21)/0.D0,0.D0,0.D0,0.D0,0.D0,0.D0,0.D0,0.D0,
     1  0.D0,0.D0,0.D0,160.9968944D0,0.D0,0.D0,47.6235236D0,0.D0,0.D0,
     2  178.1909089D0,0.D0,0.D0,0.D0/
      DATA (T2DN(I,1),I=1,9)/-9.D0,21.D0,6.136363636D0,-3.75D0,2.25D0,
     1  0.D0,-13.74772708D0,-9.D0,-1.5D0/
      DATA (T2DN(I,2),I=1,21)/0.D0,-2.863636364D0,-12.75D0,-12.D0,12.D0,
     1  17.25D0,3.D0,28.D0,14.96662955D0,3.5D0,12.681818182D0,20.D0,
     2  0.603022689D0,-6.568181818D0,-6.75D0,-36.D0,-12.72792206D0,
     3  -4.5D0,0.D0,-54.99090834D0,-36.D0/
      DATA (T2DN(I,3),I=1,21)/0.D0,0.D0,0.D0,0.D0,0.D0,0.D0,0.D0,0.D0,
     1  27.15015068D0,0.D0,0.D0,5.031152949D0,0.D0,0.D0,47.6235236D0,
     2  0.D0,0.D0,-19.09188309D0,0.D0,0.D0,0.D0/
C
C
C          SET UNIT NUMBERS ONTO WHICH CFP, UV, AND COEFFS ARE
C               TO BE WRITTEN
C
      ID3=ID2+1
      ID4=ID3+1
      WRITE (IW,8) ID2,ID3,ID4
    8 FORMAT (/20H0CUVFD---WRITE UNITS,3I5)
      REWIND ID2
      REWIND ID3
      REWIND ID4
      LLM1='    '
      FLLM1=0.D0
      NIM1=-7
      NIM2=-7
      NTM1=1
      ABGNAM(1)=ABGNM1
      IF (ICTBCD.NE.0) ABGNAM(1)=ABGNM2
      GO TO 120
C
C          SET BACK CFP TABLES
C
  110 LLM2=LLM1
      NIM2=NIM1
      NTM2=NTM1
      NLTM2=NLTM1
      DO 112 M=1,NTM1
      MULT(M,3)=MULT(M,2)
      LBCD(M,3)=LBCD(M,2)
      S(M,3)=S(M,2)
      FL(M,3)=FL(M,2)
  112 IALF(M,3)=IALF(M,2)
      LLM1=LL(1)
      FLLM1=FLL(1)
      NIM1=NI(1)
      NTM1=NOT
      NLTM1=NLT
      DO 115 M=1,NOT
      MULT(M,2)=MULT(M,1)
      LBCD(M,2)=LBCD(M,1)
      S(M,2)=S(M,1)
      FL(M,2)=FL(M,1)
      IALF(M,2)=IALF(M,1)
      DO 115 N=1,NOP
  115 CFPM1(M,N)=CFP(M,N)
C
C          READ SUB-SHELL DATA, AND TERMS TO BE INCLUDED
C
  120 READ (IR,9) LL(1),NI(1),NOT,NOP,ICUV,KLAST,NLT,
     1  (MULT(M,1),LBCD(M,1),IALF(M,1), M=1,12), NOSORT
    9 FORMAT (3X,A1,3I4,2X,A1,I1,I4,4X,12(I1,A1,A2), I4)
      IF (KLAST.EQ.0) KLAST=0
      IF (NOT.LE.0) GO TO 900
      ERAS=SORTYS
      IF (NOSORT.NE.0) ERAS=SORTNO
      IF (ILNCUV+ICPC.EQ.0) GO TO 122
      WRITE (IW,10)
   10 FORMAT (1H1)
  122 IF (NLT.LE.12) GO TO 124
      READ (IR,11) (MULT(M,1),LBCD(M,1),IALF(M,1), M=13,NLT)
   11 FORMAT (20(I1,A1,A2))
  124 IF (NLT.GT.0) GO TO 126
      WRITE (IW,12) LL(1),NI(1),NOT,NOP,ICUV,KLAST,NLT,ERAS
   12 FORMAT (/1H ,A1,I2,2I5,A1,I1,I5,5X,9HALL TERMS,10X,A7)
      IF (ILNCUV.GT.0) WRITE (IW,9)
      GO TO 127
  126 WRITE (IW,13) LL(1),NI(1),NOT,NOP,ICUV,KLAST,NLT,
     1  (MULT(M,1),LBCD(M,1),IALF(M,1), M=1,NLT)
   13 FORMAT (/1H ,A1,I2,2I5,A1,I1,I5,5X,20(I1,A1,A2,1X)/
     1  29X,20(I1,A1,A2,1X))
  127 DO 128 J=1,24
      IF (LSYMB(J).EQ.LL(1)) GO TO 129
  128 CONTINUE
  129 FLL(1)=J-1
C
C          READ CFP TABLE (TYPE 2) FROM CARDS
C
  140 READ (IR,16) (MULTBR(N,2),LBRBCD(N,2),IALFBR(N,2), N=1,NOP)
   16 FORMAT (20(I1,A1,A2))
      DO 141 N=1,NOP
      DO 141 M=1,NOT
  141 CFP2(M,N)=0.D0
      M=0
  142 M=M+1
      IT=0
  143 ITO=IT
      READ (IR,17) MULT(M,4),LBCD(M,4),IALF(M,4),IT,
     1  (IPNT(J),PC(J), J=1,4)
   17 FORMAT (I1,A1,A2,I4, 4(I3,F13.10))
      IF (ITO.GT.0) GO TO 144
      M1=MULT(M,4)
      L1=LBCD(M,4)
      IA1=IALF(M,4)
  144 DO 145 J=1,4
      N=IPNT(J)
      IF (N.EQ.0) GO TO 145
      CFP2(M,N)=PC(J)
  145 CONTINUE
C CHECK CARD ORDERING
      IF (M1.NE.MULT(M,4)) GO TO 146
      IF (L1.NE.LBCD(M,4)) GO TO 146
      IF (IA1.NE.IALF(M,4)) GO TO 146
      IF (IABS(IT).EQ.(ITO+1)) GO TO 147
  146 WRITE (IW,18) LL(1),NI(1),M1,L1,IA1,ITO,MULT(M,4),LBCD(M,4),
     1  IALF(M,4),IT
   18 FORMAT (//35H0CUVFD 18--CFD CARDS OUT OF ORDER  ,A1,I2,I4,A1,A2,I6
     1  /34X,I4,A1,A2,I6///)
  147 IF (IT.GT.0) GO TO 143
      IF (M.LT.NOT) GO TO 142
C
C          REORDER PARENTS TO CORRESPOND TO TERMS OF PRECEEDING L(N),
C          AND REORDER TERMS WITH SPECIFIED NLT TERMS FIRST
C
  150 IF (LL(1).EQ.LLM1.AND.NI(1).EQ.NIM1+1) GO TO 155
      DO 151 I=1,NOP
  151 IPNT(I)=I
      GO TO 170
  155 DO 160 N=1,NOP
      DO 159 M=1,NTM1
      IF (MULTBR(N,2).NE.MULT(M,2)) GO TO 159
      IF (LBRBCD(N,2).NE.LBCD(M,2)) GO TO 159
      IF (IALFBR(N,2).EQ.IALF(M,2)) GO TO 160
  159 CONTINUE
      WRITE (IW,19) MULTBR(N,2),LBRBCD(N,2),IALFBR(N,2),LL(1),NI(1),
     1  LLM1,NIM1
   19 FORMAT (//18H0CUVFD 19--PARENT ,I1,A1,A2,4H OF ,A1,I2,
     1  27H  NOT FOUND AMONG TERMS OF ,A1,I2)
  160 IPNT(M)=N
C
  170 IF (NLT.GT.0) GO TO 175
      DO 171 I=1,NOT
  171 ITRM(I)=I
      NLT=NOT
      GO TO 185
  175 M=NLT
      DO 180 I=1,NOT
      DO 178 J=1,NLT
      IF (MULT(I,4).NE.MULT(J,1)) GO TO 178
      IF (LBCD(I,4).NE.LBCD(J,1)) GO TO 178
      IF (IALF(I,4).EQ.IALF(J,1)) GO TO 179
  178 CONTINUE
      M=M+1
      ITRM(M)=I
      GO TO 180
  179 ITRM(J)=I
  180 CONTINUE
      IF (M.EQ.NOT) GO TO 185
      WRITE (IW,20) M,NOT
   20 FORMAT (//17H0CUVFD 20--M,NOT=,2I5)
C CALC VALUES OF S AND L
  185 DO 190 M=1,NOT
      DO 188 J=1,24
      IF (LSYMB(J).EQ.LBCD(M,4)) GO TO 189
  188 CONTINUE
  189 FL(M,4)=J-1
      A=MULT(M,4)-1
  190 S(M,4)=0.5D0*A
      DO 195 N=1,NOP
      DO 192 J=1,24
      IF (LSYMB(J).EQ.LBRBCD(N,2)) GO TO 193
  192 CONTINUE
  193 FLBR(N,2)=J-1
      A=MULTBR(N,2)-1
  195 SBR(N,2)=0.5D0*A
      IF (FLL(1)-FLLM1) 198,196,200
  196 IF (NI(1).GT.NIM1) GO TO 200
  198 WRITE (IW,21)
   21 FORMAT (//37H0CUVFD 21--CFP DECKS OUT OF ORDER****//)
C
  200 DO 202 M=1,NOT
      I=ITRM(M)
C     WRITE (11,1021) IALF(I,4)
C1021 FORMAT (A2)
C     BACKSPACE 11
C     READ (11,22) N
C     BACKSPACE 11
      READ (IALF(I,4),22) N
   22 FORMAT (I1)
      A=N
      IF (A.EQ.0.D0) A=9.5D0
  202 PC(M)=-100.D0*(S(I,4)+1.D0)-FL(I,4)+0.05D0*A
C
C          IF ALL TERMS INCLUDED AND NOSORT=0, SORT BY S AND L
      IF (NLT.LT.NOT.OR.NOSORT.NE.0) GO TO 203
      CALL SORT2(NLT,1,PC(1),PC(200),ITRM,DUM,IDUM,IDUM,DUM,DUM,
     1  DUM,DUM,DUM,DUM,DUM,DUM)
C
  203 DO 205 N=1,NOP
      J=IPNT(N)
      MULTBR(N,1)=MULTBR(J,2)
      LBRBCD(N,1)=LBRBCD(J,2)
      IALFBR(N,1)=IALFBR(J,2)
      SBR(N,1)=SBR(J,2)
      FLBR(N,1)=FLBR(J,2)
      DO 205 M=1,NOT
      I=ITRM(M)
  205 CFP(M,N)=CFP2(I,J)
      DO 210 M=1,NOT
      I=ITRM(M)
      MULT(M,1)=MULT(I,4)
      LBCD(M,1)=LBCD(I,4)
      IALF(M,1)=IALF(I,4)
      S(M,1)=S(I,4)
  210 FL(M,1)=FL(I,4)
      IF (ILNCUV.EQ.0) GO TO 220
      WRITE (IW,23) (MULTBR(N,1),LBRBCD(N,1),IALFBR(N,1), N=1,NOP)
   23 FORMAT (//10H0CFP TABLE//5X,10(I9,A1,A2)/(5X,10(I9,A1,A2)))
      DO 218 M=1,NOT
  218 WRITE (IW,24) MULT(M,1),LBCD(M,1),IALF(M,1), (CFP(M,N), N=1,NOP)
   24 FORMAT (1H ,I1,A1,A4,10F12.8/(2X,10F12.8))
C CHECK ORTHONORMALITY OF CFP ROWS
  220 DO 230 M=1,NOT
      DO 229 M1=M,NOT
      SUM=-1.D0
      IF (M.EQ.M1) GO TO 222
      SUM=0.D0
      IF (MULT(M,1).NE.MULT(M1,1)) GO TO 229
      IF (LBCD(M,1).NE.LBCD(M1,1)) GO TO 229
  222 DO 224 N=1,NOP
  224 SUM=SUM+CFP(M,N)*CFP(M1,N)
      IF (DABS(SUM).LT.1.0D-6) GO TO 229
      WRITE (IW,25) MULT(M,1),LBCD(M,1),IALF(M,1),
     1             MULT(M1,1),LBCD(M1,1),IALF(M1,1)
   25 FORMAT (//36H0CUVFD 25--CFP NOT ORTHONORMAL FOR  ,2(I4,A1,A2)//)
  229 CONTINUE
  230 CONTINUE
C CHECK ORTHONORMALITY OF CFP COLUMNS
      IF (NI(1).EQ.0) GO TO 250
      A=NI(1)
      B=(4.D0*FLL(1)+3.D0-A)/A
      DO 239 N=1,NOP
      SUM=-B*(2.D0*FLBR(N,1)+1.D0)*(2.D0*SBR(N,1)+1.D0)
      DO 238 N1=N,NOP
      IF (N.EQ.N1) GO TO 232
      SUM=0.D0
      IF (MULTBR(N,1).NE.MULTBR(N1,1)) GO TO 238
      IF (LBRBCD(N,1).NE.LBRBCD(N1,1)) GO TO 238
  232 DO 234 M=1,NOT
      A=(2.D0*FL(M,1)+1.D0)*(2.D0*S(M,1)+1.D0)
  234 SUM=SUM+A*CFP(M,N)*CFP(M,N1)
      IF (DABS(SUM).LT.1.D-6) GO TO 238
      WRITE (IW,25) MULTBR(N,1),LBRBCD(N,1),IALFBR(N,1),
     1             MULTBR(N1,1),LBRBCD(N1,1),IALFBR(N1,1)
  238 CONTINUE
  239 CONTINUE
C
C          READ OR CALC CFGP (IF NEEDED) AND WRITE DISK ID2
C
  250 NLP=1
      NOCFP=0
      IF (LL(1).NE.LLM1.OR.NI(1).NE.(NIM1+1)) GO TO 252
      NLP=NLTM1
      NOCFP=1
  252 NLGP=0
      NOCFGP=0
      IF (LL(1).NE.LLM2.OR.NI(1).NE.(NIM2+2)) GO TO 254
      NLGP=NLTM2
      NOCFGP=2.D0*FLL(1)+1.D0
  254 NORCD=1+NOCFP+NOCFGP
      IF (NOCFP.GT.0) NORCD=NORCD+1
      IF (NOCFGP.GT.0) NORCD=NORCD+1
      WRITE (ID2) LL(1),NI(1),FLL(1),NOT,NLT,NORCD
      WRITE (ID2) (MULT(M,1),LBCD(M,1),IALF(M,1),FL(M,1),S(M,1),
     1  M=1,NLT), NLP,NLGP,NOCFP,NOCFGP
      IF (NOCFP.EQ.0) GO TO 257
      WRITE (ID2) ((CFP(M,N),M=1,NLT), N=1,NLP)
      WRITE (ID2) (MULT(M,2),LBCD(M,2),IALF(M,2),FL(M,2),S(M,2),M=1,NLP)
  257 IF (NOCFGP.EQ.0) GO TO 300
C
  260 WRITE (ID2) (MULT(M,3),LBCD(M,3),IALF(M,3),FL(M,3),S(M,3),
     1  M=1,NTM2)
      FLP=-1.D0
      DO 285 K=1,NOCFGP
      FLP=FLP+1.D0
      SP=0.5D0*(1.D0+(-1.D0)**K)
      MULP=2.D0*SP+1.D0
      IFLP=FLP
      LLL=LSYMB(IFLP+1)
      A=DSQRT((2.D0*FLP+1.D0)*(2.D0*SP+1.D0))
      DO 273 M=1,NLT
      X0=FL(M,1)+S(M,1)+1.D0
      DO 273 N=1,NLGP
      SUM=0.D0
      DO 272 N1=1,NOP
      B=S6J(FLL(1),FLL(1),FLP, FL(M,1),FL(N,3),FL(N1,2))
      IF (B.EQ.0.D0) GO TO 272
      B=B*S6J(HALF,HALF,SP, S(M,1),S(N,3),S(N1,2))
      IF (B.EQ.0.D0) GO TO 272
      B=B*DSQRT((2.D0*FL(N1,2)+1.D0)*(2.D0*S(N1,2)+1.D0))
      B=B*CFP(M,N1)*CFPM1(N1,N)
      SUM=SUM+B
  272 CONTINUE
      SUM=SUM*A
      X=X0+FL(N,3)+S(N,3)
      IF (DMOD(X,TWO).GT.ZERO) SUM=-SUM
  273 CFGP(M,N)=SUM
      IF (ILNCUV.EQ.0) GO TO 276
      WRITE (IW,29) LL(1),MULP,LLL, (MULT(N,3),LBCD(N,3),IALF(N,3),
     1   N=1,NLGP)
   29 FORMAT (///11H0CFGP FOR  ,A1,2H2(,I1,A1,1H)//5X,10(I9,A1,A2)/
     1  (5X,10(I9,A1,A2)))
      DO 275 M=1,NLT
  275 WRITE (IW,24) MULT(M,1),LBCD(M,1),IALF(M,1), (CFGP(M,N), N=1,NLGP)
  276 WRITE (ID2) ((CFGP(M,N),M=1,NLT), N=1,NLGP)
C          CHECK ORTHONORMALITY OF CFGP ROWS
      IF (NLGP.NE.NLTM2) GO TO 295
      L=200
      DO 280 M=1,NLT
      DO 279 M1=M,NLT
      IF (MULT(M,1).NE.MULT(M1,1)) GO TO 279
      IF (LBCD(M,1).NE.LBCD(M1,1)) GO TO 279
      L=L+1
      IF (K.EQ.1) PC(L)=0.D0
  277 DO 278 N=1,NLGP
  278 PC(L)=PC(L)+CFGP(M,N)*CFGP(M1,N)
  279 CONTINUE
  280 CONTINUE
C
  285 CONTINUE
C
      L=200
      DO 290 M=1,NLT
      DO 289 M1=M,NLT
      IF (MULT(M,1).NE.MULT(M1,1)) GO TO 289
      IF (LBCD(M,1).NE.LBCD(M1,1)) GO TO 289
      L=L+1
      IF (M.EQ.M1) PC(L)=PC(L)-1.D0
      IF (DABS(PC(L)).LT.1.D-6) GO TO 289
      WRITE (IW,30) MULT(M,1),LBCD(M,1),IALF(M,1),
     1             MULT(M1,1),LBCD(M1,1),IALF(M1,1),MULP,LLL
   30 FORMAT (/37H CUVFD 30--CFGP NOT ORTHONORMAL FOR  ,2(I4,A1,A2)/)
  289 CONTINUE
  290 CONTINUE
  295 CONTINUE
C
C          CALCULATE NUMBER OF TERMS OF EACH KIND
C
  300 K=0
      N2=-100
      DO 310 M=1,NLT
      N1=N2
      N2=-100.D0*S(M,1)-FL(M,1)
      IF (N2.NE.N1) GO TO 309
      NTRMK(K)=NTRMK(K)+1
      GO TO 310
  309 K=K+1
      NTRMK(K)=1
  310 CONTINUE
      NDIFFT=K
C
C          CALCULATE NUMBER OF LEVELS OF EACH J
C
      M=0
      DO 315 J=1,NLT
      EJI=DABS(FL(J,1)-S(J,1))-1.D0
      NJI=FL(J,1)+S(J,1)-EJI
      DO 315 IJ=1,NJI
      M=M+1
      EJI=EJI+1.D0
      NALSJI(M)=J
      A=DFLOAT(J)
      PC(M)=-200.D0*EJI-25.D0*S(J,1)-FL(J,1)+0.008403361D0*A
  315 PJI(M)=EJI
      NTOTJI=M
      CALL SORT2(M,2,PC(1),PC(500),NALSJI,PJI,IDUM,IDUM,DUM,DUM,DUM,
     1  DUM,DUM,DUM,DUM,DUM)
C
      K=1
      NJKI(K)=1
      IF (M.LE.1) GO TO 320
      DO 319 J=2,M
      IF (PJI(J).NE.PJI(J-1)) GO TO 317
      NJKI(K)=NJKI(K)+1
      GO TO 319
  317 K=K+1
      NJKI(K)=1
  319 CONTINUE
  320 NDIFJI=K
C
C        WRITE U,V ON DISK ID3, AND COEFFS FOR L(N) ON DISK ID4
C
  400 FN=NI(1)
      NMXM1=4.D0*FLL(1)+1.D0
      NPAR=0
      IF (NI(1).EQ.0.OR.NI(1).EQ.(NMXM1+1).OR.FLL(1).EQ.0.D0) GO TO 410
      NPAR=1
      IF (NI(1).EQ.1.OR.NI(1).EQ.NMXM1) GO TO 410
      NPAR=1.D0+FLL(1)
      IF (IABG.EQ.0) GO TO 410
      NPAR=1.D0+FLL(1)+FLL(1)
      IF (FLL(1).NE.TWO) GO TO 410
      NPAR=NPAR+1
      IF (NI(1).GT.2.AND.NI(1).LT.8) NPAR=NPAR+2
  410 NORCD=1+NPAR
      WRITE (ID4) LL(1),NI(1),FLL(1),NOT,NLT,NORCD
      WRITE (ID4) NDIFFT, (NTRMK(K), K=1,NDIFFT), NTOTJI,
     1  (NALSJI(M),PJI(M), M=1,NTOTJI), NDIFJI, (NJKI(M), M=1,NDIFJI)
      IF (NPAR.EQ.0) GO TO 800
      IF (NI(1).EQ.1) GO TO 500
      NORCD=4.D0*FLL(1)+2.D0
      WRITE (ID3) LL(1),NI(1),FLL(1),NOT,NLT,NORCD
C
C          CALC U MATRICES
C
      NOR=NORCD/2
      DO 485 IRP1=1,NOR
      K=IRP1-1
      R=K
      DO 435 M=1,NOT
      MPX=MIN0(M,NLT)
      DO 435 MP=1,MPX
      A=0.D0
      B=0.D0
      IF (S(M,1).NE.S(MP,1)) GO TO 434
      IF (R.GT.(FL(M,1)+FL(MP,1))) GO TO 434
      IF (R.LT.DABS(FL(M,1)-FL(MP,1))) GO TO 434
      DO 432 N=1,NOP
      B=CFP(M,N)*CFP(MP,N)
      IF (B.EQ.0.D0) GO TO 432
      B=B*S6J(FLL(1),FLL(1),R, FL(M,1),FL(MP,1),FLBR(N,1))
      X=DMOD(FLBR(N,1),TWO)
      IF (X.GT.0.D0) B=-B
      A=A+B
  432 CONTINUE
      A=A*DSQRT((2.D0*FL(M,1)+1.D0)*(2.D0*FL(MP,1)+1.D0))*FN
      X=DMOD(FLL(1)+FL(M,1)+R,TWO)
      IF (X.GT.0.D0) A=-A
      B=A
      X=DMOD(FL(M,1)-FL(MP,1),TWO)
      IF (X.NE.0.D0) B=-B
  434 UA(M,MP)=A
  435 UA(MP,M)=B
      WRITE (ID3) K, ((UA(M,MP),M=1,NLT), MP=1,NLT)
C
      IF (R.EQ.0.D0.OR.NPAR.LE.1) GO TO 485
      X=DMOD(R,TWO)
      IF (X.GT.0.D0) GO TO 460
C CALC FK
  440 A=2.D0*FLL(1)+1.D0
      CIJ=0.5D0*A*S3J0SQ(FLL(1),R,FLL(1))
      CAVE=CIJ*FN*(FN-1.D0)/(A+FLL(1)+FLL(1))
      CAVEP=CAVE-FN*CIJ
      CIJ=CIJ*A
      IF (ILNCUV.GT.0) WRITE (IW,41) K,CAVE,LL(1),NI(1)
   41 FORMAT (//2H0F,I1,8X,5HCAVE=,F12.7,10X,A1,I2//)
C
      NOPC=0
      MMAX=0
      DO 450 L=1,NDIFFT
        MMIN=MMAX+1
        MMAX=MMAX+NTRMK(L)
        DO 450 M=MMIN,MMAX
          CIJ1=CIJ/(2.D0*FL(M,1)+1.D0)
          DO 448 MP=MMIN,M
            NOPC=NOPC+1
            A=0.D0
            DO 445 MPP=1,NOT
  445       A=A+UA(MPP,M)*UA(MPP,MP)
            PC(NOPC)=CIJ1*A
            IF (M.EQ.MP) PC(NOPC)=PC(NOPC)+CAVEP
  448     CONTINUE
          IF (ICPC.EQ.0) GO TO 450
          N2=NOPC-M+MMIN
          WRITE (IW,42) NOPC,MULT(M,1),LBCD(M,1), (PC(N1), N1=N2,NOPC)
   42     FORMAT (2I5,A1,10F11.6/(13X,10F11.6))
  450 CONTINUE
      KPAR=-1
      WRITE (AA,43) K,LL(1),NI(1)
   43 FORMAT (1HF,I1,1H(,A1,I2,2H) )
      WRITE (ID4) KPAR,K,AA,CAVE,NOPC, (PC(N1), N1=1,NOPC)
      CALL CLOCK(TIME)
      DELT=TIME-TIME0
      IF (ILNCUV.GT.0) WRITE (IW,45) AA,NOPC,CAVE,DELT
   45 FORMAT (1H ,A7,7H    PC(,I4,1H),7X,5HCAVE=,F12.7,8X,5HTIME=,F9.3,
     1  4H MIN)
      GO TO 485
C CALC BETA OR GAMMA
  460 IF (K.GT.5) GO TO 485
      I=(K+1)/2
      DO 480 M=1,NLT
      A=0.D0
      DO 465 MP=1,NOT
  465 A=A+UA(MP,M)**2
      A=A/(2.D0*FL(M,1)+1.D0)
      GO TO (471,473,475) I
  471 ABG(M,2)=3.D0*A
      ABG(M,3)=0.D0
      GO TO 480
  473 ABG(M,3)=ABG(M,2)+7.D0*A
      GO TO 480
  475 ABG(M,2)=ABG(M,2)+11.D0*A
      ABG(M,3)=ABG(M,3)+11.D0*A
  480 CONTINUE
C
  485 CONTINUE
C   FINISH CALCULATION OF ALPHA, BETA, GAMMA, T, T1, AND T2
      IF (NPAR.LE.1.OR.IABG.EQ.0) GO TO 500
      A=4.D0*FLL(1)+1.D0
      B=FN*(FN-A-1.D0)
      CAVEI(2)=B/26.D0
      B=B*FLL(1)/A
      AFACT=1.D0
      IF (ICTBCD.NE.0) AFACT=0.001D0
      CAVEI(1)=B*(FLL(1)+1.D0)*AFACT
      A=1.D0/(2.D0*FLL(1)-1.D0)
      CAVEI(3)=A*B
      DO 487 M=1,NLT
      ABG(M,1)=FL(M,1)*(FL(M,1)+1.D0)*AFACT+CAVEI(1)
      ABG(M,2)=0.25D0*ABG(M,2)+CAVEI(2)
  487 ABG(M,3)=A*ABG(M,3)+CAVEI(3)
      DO 488 I=1,NOPC
  488 PC(I)=0.D0
      K=0
      IMAX=FLL(1)
      DO 492 I=1,IMAX
      J=I
      AA=ABGNAM(J)
      IF (LL(1).EQ.LSYMB(3).AND.I.EQ.2) J=3
      IF (ILNCUV.GT.0) WRITE (IW,48) AA,CAVEI(J),LL(1),NI(1)
   48 FORMAT (//1H0,A10,5HCAVE=,F12.7,10X,A1,I2//)
      M=0
      NOPC=0
      DO 490 L=1,NDIFFT
      NK=NTRMK(L)
      DO 490 N=1,NK
      M=M+1
      N2=NOPC+1
      NOPC=NOPC+N
      PC(NOPC)=ABG(M,J)
      IF (ICPC.EQ.0) GO TO 490
      WRITE (IW,42) NOPC, MULT(M,1),LBCD(M,1), (PC(N1), N1=N2,NOPC)
  490 CONTINUE
      WRITE (ID4) KPAR,K,AA,CAVEI(J),NOPC, (PC(N1), N1=1,NOPC)
      CALL CLOCK(TIME)
      DELT=TIME-TIME0
      IF (ILNCUV.GT.0) WRITE (IW,45) AA,NOPC,CAVEI(J),DELT
  492 CONTINUE
      IF (FLL(1).NE.2.D0) GO TO 500
      IF (NI(1).LE.1.OR.NI(1).GE.9) GO TO 500
      J=NI(1)-1
      K=0
      M=0
      NOPC=0
      DO 495 L=1,NDIFFT
      NK=NTRMK(L)
      DO 495 N=1,NK
      N2=NOPC+1
      DO 494 N1=1,N
      M=M+1
      NOPC=NOPC+1
      PC(NOPC)=TDN(M,J)
      IF (N1.EQ.N) PC(NOPC)=PC(NOPC)+CAVEDN(J)
  494 CONTINUE
      IF (ICPC.EQ.0) GO TO 495
      WRITE (IW,42) NOPC,MULT(M,1),LBCD(M,1), (PC(N1), N1=N2,NOPC)
  495 CONTINUE
      WRITE (AA,49) LL(1),NI(1)
   49 FORMAT(2HT(,A1,I2,3H)  )
      WRITE (ID4) KPAR,K,AA,CAVEDN(J),NOPC, (PC(N1), N1=1,NOPC)
      IF (NI(1).LE.2.OR.NI(1).GE.8) GO TO 500
      J=MIN0(NI(1)-2,8-NI(1))
      ERAS1=0.D0
      DO 499 I=1,2
      M=0
      NOPC=0
      DO 498 L=1,NDIFFT
      NK=NTRMK(L)
      DO 498 N=1,NK
      N2=NOPC+1
      DO 497 N1=1,N
      M=M+1
      NOPC=NOPC+1
      PC(NOPC)=T1DN(M,J)
      IF (I.EQ.2) PC(NOPC)=T2DN(M,J)
      IF (NI(1).GT.5) PC(NOPC)=-PC(NOPC)
  497 CONTINUE
      IF (ICPC.EQ.0) GO TO 498
      WRITE (IW,42) NOPC,MULT(M,1),LBCD(M,1), (PC(N1), N1=N2,NOPC)
  498 CONTINUE
      WRITE (AA,50) I,LL(1),NI(1)
   50 FORMAT(1HT,I1,1H(,A1,I2,2H) )
  499 WRITE (ID4) KPAR,K,AA,ERAS1,NOPC, (PC(N1), N1=1,NOPC)
C
C          CALC V MATRICES
C
  500 NOV=NOR
      IF (NI(1).EQ.1) NOV=1
      DO 585 IRP1=1,NOV
      K=IRP1-1
      IF (NOV.EQ.1) K=1
      R=K
      DO 535 M=1,NLT
      DO 535 MP=1,NLT
      A=0.D0
      B=0.D0
      IF (S(M,1)+S(MP,1).LT.1.D0) GO TO 534
      IF (DABS(S(M,1)-S(MP,1)).GT.1.D0) GO TO 534
      IF (FL(M,1)+FL(MP,1).LT.R) GO TO 534
      IF (DABS(FL(M,1)-FL(MP,1)).GT.R) GO TO 534
      DO 532 N=1,NOP
      B=CFP(M,N)*CFP(MP,N)
      IF (B.EQ.0.D0) GO TO 532
      B=B*S6J(HALF,HALF,ONE, S(M,1),S(MP,1),SBR(N,1))
     1   *S6J(FLL(1),FLL(1),R, FL(M,1),FL(MP,1),FLBR(N,1))
      X=DMOD(S(M,1)+SBR(N,1)+1.5D0+FLBR(N,1),TWO)
      IF (X.GT.0.D0) B=-B
      A=A+B
  532 CONTINUE
      A=A*FN*DSQRT(1.5D0*(2.D0*S(M,1)+1.D0)*(2.D0*S(MP,1)+1.D0)
     1  *(2.D0*FL(M,1)+1.D0)*(2.D0*FL(MP,1)+1.D0))
      X=DMOD(FLL(1)+FL(M,1)+R,TWO)
      IF (X.GT.0.D0) A=-A
      B=A
      X=DMOD(FL(M,1)-FL(MP,1)+S(M,1)-S(MP,1),TWO)
      IF (X.NE.0.D0) B=-B
  534 VA(M,MP)=A
  535 VA(MP,M)=B
      IF (NOV.EQ.1) GO TO 539
      WRITE (ID3) K, ((VA(M,MP),M=1,NLT), MP=1,NLT)
  539 IF (K.NE.1) GO TO 585
C CALC COEFFS OF ZETA
  540 IF (ILNCUV.GT.0) WRITE (IW,52) LL(1),NI(1)
   52 FORMAT (//5H0ZETA,33X,A1,I2//)
C
      B=DSQRT(FLL(1)*(FLL(1)+1.D0)*(2.D0*FLL(1)+1.D0))
      NOPC=0
      MMAX=0
      DO 560 L=1,NDIFJI
      MMIN=MMAX+1
      MMAX=MMAX+NJKI(L)
      DO 560 M=MMIN,MMAX
      J=NALSJI(M)
      DO 550 MP=MMIN,M
      JP=NALSJI(MP)
      NOPC=NOPC+1
      PC(NOPC)=0.D0
      A=VA(J,JP)
      IF (A.EQ.0.D0) GO TO 550
      X=DMOD(FL(JP,1)+S(J,1)+PJI(M),TWO)
      IF (X.GT.0.D0) A=-A
      PC(NOPC)=A*B*S6J(S(J,1),FL(J,1),PJI(M), FL(JP,1),S(JP,1),ONE)
  550 CONTINUE
      IF (ICPC.EQ.0) GO TO 560
      N2=NOPC-M+MMIN
      WRITE (IW,54) NOPC,MULT(J,1),LBCD(J,1),PJI(M),
     1  (PC(N1), N1=N2,NOPC)
   54 FORMAT (2I5,A1,F4.1,10F11.6/(17X,10F11.6))
  560 CONTINUE
      KPAR=1
      CAVE=0.D0
      AA=ZETANM
      WRITE (ID4) KPAR,K,AA,CAVE,NOPC, (PC(N1), N1=1,NOPC)
      CALL CLOCK(TIME)
      DELT=TIME-TIME0
      IF (ILNCUV.GT.0) WRITE (IW,45) AA,NOPC,CAVE,DELT
C
  585 CONTINUE
C
  800 CALL CLOCK(TIME)
      DELT=TIME-TIME0
      WRITE (IW,60) LL(1),NI(1),DELT
   60 FORMAT (26H FINISHED CUVFD CALC FOR  ,A1,I2,11H   AT TIME=,F9.3,
     1  4H MIN)
      GO TO 110
C
C          WRITE DUMMY RECORDS REQUIRED BY SYSTEM BUG ON IBM7030
C
  900 WRITE (ID2) (PC(J), J=1,20)
      WRITE (ID3) (PC(J), J=1,20)
      WRITE (ID4) (PC(J), J=1,20)
      REWIND ID2
      REWIND ID3
      REWIND ID4
      RETURN
      END
C
C     OVERLAY(G9,2,0)
      SUBROUTINE LNCUV
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3/    CFP2(KLS1,KLS1,7),CIJK(10,6),
     1  U2(KLSI,KLSI,7),U3(KLSU,KLSU,9),U4(KLSU,KLSU,9),U5(KLSU,KLSU,7),
     2  U6(KLSU,KLSU,7),V2(KLSI,KLSI,7),V3(KLSI,KLSI,7),V4(KLSU,KLSU,7),
     *  V5(KLSU,KLSU,5),V6(KLSU,KLSU,5),
     3  NTI(41),IRP1MX,NALSJI(KJP),TFLN,TFLX,TFSN,TFSX,
     4  PJI(KJP),MULSI(KLSI),LBCDI(KLSI),IRHO,IRHOP,ISIG,ISIGP,FLLRHO,
     5  FLLSIG,IN,JN,JX,NII,NIJ,KI,KJ,KPI,KPJ,KDMIN,KEMIN,NKD,NKE,NKTOT,
     6  TR,TK,TC,RSUM,  J11,J12,L1,L2,TL(2,KS),TS(2,KS),
     7  TSCL(2,KS),TSCS(2,KS),NIJKP(KS,2),IRS(KS),IFL(KS),NDEL(KS),
     8    CIJR(8),CCC(8),N1,N2,N3,N4,E1,E2,E3,
     9  E4,E5,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,B1,B2,B3,B4,B5,B6,
     A  CFGP2(17,8,7),NALSJP(KJP,KS),PJ(KJP,KS)
      COMMON/CC/   U1(KLSI,KLSI,9),DUMLC1(KLC1)
      COMMON/C3LC2/CFGP1(KLSI,KLSI,7),PC(KPC),DUMLC2(KLC2)
      COMMON/C3LC3/V1(KLSI,KLSI,9),DUMLC3(KLC1)
      COMMON/C3LC4/DUMLC4(KMX**2-KISER),PCI(KISER)
      DIMENSION NPARJ(KC,KC),ISER(KISER)
      EQUIVALENCE (DUMLC4,NPARJ),(DUMLC4(KC**2+1),ISER)
      COMMON/C3LCD/DUMLCD
      COMMON/EE/NALSP(KLSC,KS),PSCRL(KLSC,KS),PSCRS(KLSC,KS),
     1  NCFGP(KLSC),NJK(KJK,KS),NCFGJP(KJP,KS),MULS1(KLSC),MULS4(KLSC),
     2  LHS1(KLSC),LHS4(KLSC)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      COMMON/ENERGIES/ETOT(KC,2),EE8(KC,2),E0KIN(KC),EKIN(KMX)
      DIMENSION CFP1(KLS1,KLS1)
      EQUIVALENCE (CFP1,CFGP1)
      DATA IBLANK/4H    /
C
C
C
C          READ AND CHECK INPUT CONFIGURATIONS
C
C     KS=8
  200 IERROR=0
      WRITE (IW,10) UENRGY
   10 FORMAT (/8H0  K   J,11X,13HCONFIGURATION,35X,
     1  35HN   PAR   I   TERMS OF LI(NI) -----,7X,
     2  9H(E UNIT =,F8.1,6H CM-1))
      II=0
      DO 259 K=1,2
      IF (NSCONF(1,K).LE.0) GO TO 259
      WRITE (IW,11)
   11 FORMAT (1H )
      NOSUBC=NSCONF(1,K)
      JMAX=NSCONF(2,K)
      DO 202 I=1,KS
      LL(I)=LSYMB(1)
      FLL(I)=0.D0
      NLASTT(I)=1
      MULT(1,I)=1
      LBCD(1,I)=LSYMB(1)
      JJJ=MAX0(NSCONF(2,1),NSCONF(2,2))
      DO 202 J=1,JJJ
      LLIJK(I,J,K)=LSYMB(1)
      FLLIJK(I,J,K)=0.D0
  202 NIJK(I,J,K)=0
      DO 249 J=1,JMAX
      N=0
      IPRITY=1
      READ (IR,20) (LL(I),NI(I), I=1,8),(PCI(I),I=1,3),A1,A2
   20 FORMAT (8(A1,I2,2X),3A6,F13.3,F9.4)
      DO 229 I=1,NOSUBC
      NIJK(I,J,K)=NI(I)
      DO 212 L=1,24
      IF (LSYMB(L).NE.LL(I)) GO TO 212
      ILL=L-1
      FLL(I)=L-1
      FLLIJK(I,J,K)=FLL(I)
      GO TO 213
  212 CONTINUE
  213 LLIJK(I,J,K)=LL(I)
      IF (LL(I).EQ.LLIJK(I,1,K)) GO TO 220
      IF (I.EQ.NOSUBC.AND.NI(I).EQ.1) GO TO 220
      DO 217 M=1,J
      IF (NIJK(I,M,K).NE.0) GO TO 218
  217 CONTINUE
      GO TO 220
  218 IF (LL(I).EQ.LLIJK(I,M,K)) GO TO 220
      IERROR=7
  220 N=N+NI(I)
      IF (MOD(NI(I)*ILL,2).NE.0) IPRITY=-IPRITY
  229 CONTINUE
C
      NPT=0
      DO 232 I=1,NOSUBC
      NN=NIJK(I,J,K)
      NFULL=4.D0*FLL(I)+2.D0
      IF (NN.GT.1.AND.NN.LT.NFULL-1) GO TO 230
      NOT=1
      NLT=1
      MULT(1,I)=1
      LBCD(1,I)=LSYMB(1)
      IALF(1,I)=IBLANK
      FL(1,I)=0.D0
      S(1,I)=0.D0
      IF (NN.EQ.0.OR.NN.EQ.NFULL) GO TO 1230
      MULT(1,I)=2
      LBCD(1,I)=LL(I)
      FL(1,I)=FLL(I)
      S(1,I)=0.5D0
      GO TO 1230
  230 CALL LOCDSK(ID2,FLL(I),NIJK(I,J,K))
      READ(ID2) (MULT(M,I),LBCD(M,I),IALF(M,I),FL(M,I),S(M,I),M=1,NLT)
 1230 IF (I.EQ.1.AND.J.LT.JMAX) NLT=MIN0(NLT,NLT11)
      IF (I.EQ.1.AND.JMAX.EQ.1) NLT=MIN0(NLT,NLT11)
      IF (NLT.EQ.NOT) GO TO 232
      NPT=NPT+1
      IF (NPT.GT.1) GO TO 231
      WRITE (IW,21) K,J, (LL(IP),NIJK(IP,J,K),IP=1,KS), N,IPRITY,I,
     1  (MULT(L,I),LBCD(L,I),IALF(L,I), L=1,NLT)
   21 FORMAT (I4,I4,7X,8(A1,I2,3X),I5,I5,I5,3X,13(I1,A1,A2)/
     1  81X,13(I1,A1,I2))
      GO TO 232
  231 WRITE (IW,22) I, (MULT(L,I),LBCD(L,I),IALF(L,I), L=1,NLT)
   22 FORMAT (73X,I5,3X,13(I1,A1,A2)/81X,13(I1,A1,A2))
  232 CONTINUE
      IF (NPT.GT.0) GO TO 240
      A1=A1*1000.D0/UENRGY
      WRITE (IW,23) K,J, (LL(I),NIJK(I,J,K),I=1,KS), N,IPRITY,
     1  (PCI(I),I=1,3),A1,A2
   23 FORMAT (I4,I4,7X,8(A1,I2,3X),I5,I5,8X,3HALL,8X,3A6,F13.3,F9.4)
      WRITE (21,23) K,J, (LL(I),NIJK(I,J,K),I=1,KS)
      ETOT(J,K)=A1
      EE8(J,K)=A2
  240 IF (J.GT.1) GO TO 245
      IF (K-1) 241,241,242
  241 NO=N
  242 IPRTYO=IPRITY
      GO TO 249
  245 IF (N.NE.NO) GO TO 247
      IF (IPRITY.EQ.IPRTYO) GO TO 249
  247 IERROR=7
  249 CONTINUE
  259 II=II+IPRITY
      IIPRTY=1
      IF (II.NE.0) IIPRTY=2
C
      IF (IERROR.EQ.0) GO TO 281
      WRITE (IW,25)
   25 FORMAT (///27H0LNCUV 25--DECK SETUP ERROR////)
      STOP '(LNCUV 25)'
C
C          CALC (LI//CK//LJ) TABLE
C
  281 WRITE (IW,28)
   28 FORMAT (///)
      IF (ILNCUV.LE.0) GO TO 900
      N=NOSUBC
      DO 299 I1=1,NOSUBC
        DO 299 I2=I1,NOSUBC
          IF (I2.LE.I1) THEN
            I=I1
          ELSE
            N=N+1
            I=N
          ENDIF
          DO 286 NK=1,6
  286     CIJK(I,NK)=0.D0
          FK0=DABS(FLL(I1)-FLL(I2))-2.D0
          KMIN=FK0+2.D0
          NOK=(FLL(I1)+FLL(I2)-FK0)/2.D0
          DO 295 NK=1,NOK
            FK0=FK0+2.D0
  295     CIJK(I,NK)=CIJKF(FLL(I1),FLL(I2),FK0)
  297     WRITE (IW,29) KMIN,I1,LL(I1),I2,LL(I2),(CIJK(I,NK),NK=1,NOK)
   29     FORMAT (6H KMIN=,I2,5X,1H(,I1,A1,6H//CK//,I1,A1,2H)=,
     1      3X,6F15.8)
  299 CONTINUE
C
  900 RETURN
      END
C
C     OVERLAY(G9,3,0)
      SUBROUTINE PLEV
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3/    CFP2(KLS1,KLS1,7),CIJK(10,6),
     1  U2(KLSI,KLSI,7),U3(KLSU,KLSU,9),U4(KLSU,KLSU,9),U5(KLSU,KLSU,7),
     2  U6(KLSU,KLSU,7),V2(KLSI,KLSI,7),V3(KLSI,KLSI,7),V4(KLSU,KLSU,7),
     *  V5(KLSU,KLSU,5),V6(KLSU,KLSU,5),
     3  NTI(41),IRP1MX,NALSJI(KJP),TFLN,TFLX,TFSN,TFSX,
     4  PJI(KJP),MULSI(KLSI),LBCDI(KLSI),IRHO,IRHOP,ISIG,ISIGP,FLLRHO,
     5  FLLSIG,IN,JN,JX,NII,NIJ,KI,KJ,KPI,KPJ,KDMIN,KEMIN,NKD,NKE,NKTOT,
     6  TR,TK,TC,RSUM,  J11,J12,L1,L2,TL(2,KS),TS(2,KS),
     7  TSCL(2,KS),TSCS(2,KS),NIJKP(KS,2),IRS(KS),IFL(KS),NDEL(KS),
     8    CIJR(8),CCC(8),N1,N2,N3,N4,E1,E2,E3,
     9  E4,E5,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,B1,B2,B3,B4,B5,B6,
     A  CFGP2(17,8,7),NALSJP(KJP,KS),PJ(KJP,KS)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      COMMON/CC/   U1(KLSI,KLSI,9),DUMLC1(KLC1)
      COMMON/C3LC2/CFGP1(KLSI,KLSI,7),PC(KPC),DUMLC2(KLC2)
      COMMON/C3LC3/V1(KLSI,KLSI,9),DUMLC3(KLC1)
      COMMON/C3LC4/DUMLC4(KMX**2-KISER),PCI(KISER)
      DIMENSION NPARJ(KC,KC),ISER(KISER)
      EQUIVALENCE (DUMLC4,NPARJ),(DUMLC4(KC**2+1),ISER)
      COMMON/C3LCD/DUMLCD
      COMMON/C3LC7/M,I,J,K,L,I1,J2,K1,L8,J1
      COMMON/EE/NALSP(KLSC,KS),PSCRL(KLSC,KS),PSCRS(KLSC,KS),
     1  NCFGP(KLSC),NJK(KJK,KS),NCFGJP(KJP,KS),MULS1(KLSC),MULS4(KLSC),
     2  LHS1(KLSC),LHS4(KLSC)
      COMMON/SORTDUM/DUM(2),IDUM(2)
      DIMENSION CFP1(KLS1,KLS1)
      EQUIVALENCE (CFP1,CFGP1)
      CHARACTER*4 IBLANK,IALF
      DATA IBLANK/4H    /
C
C     NOTE--IF EQUIV OF CFP2 AND CFGP2 CHANGED,
C           MAKE CORRESPONDING CHANGE IN PRK CODE, STATEMENT 540 TO 569
C
C     KS=8
C     KJP=200
C     KLSC=210
C     KJK=110
      NTOTTJ(1)=0
      NDIFFT=0
      SUMX=0.D0
      SJ8MN=1000.D0
      SJ8MX=0.D0
      SJ8MX1=0.D0
      DO 50 I=1,KS
        NALSJP(1,I)=0
        NOTSJ1(I,1)=0
        NTOTJJ(I,1)=0
   50 NDIFFJ(I)=0
C
      NOTSX=0
      JX=NSCONF(2,KK)
      DO 229 J1=1,JX
        LL(NOSUBC)=LLIJK(NOSUBC,J1,KK)
        FLL(NOSUBC)=FLLIJK(NOSUBC,J1,KK)
        DO 79 I=1,KS
          NOTS=NOTSJ1(I,J1)
C             READ TERMS FROM DISK 12
          NI(I)=NIJK(I,J1,KK)
          NN=NI(I)
          NFULL=4.D0*FLL(I)+2.D0
          IF (NN.LE.1.OR.NN.GE.NFULL-1) THEN
            NOT=1
            NLT=1
            NLASTT(I)=NLT
            NOT1=NOTS+1
            NOTS=NOTS+NLT
            MULT(NOT1,I)=1
            LBCD(NOT1,I)=LSYMB(1)
            IALF(NOT1,I)=IBLANK
            FL(NOT1,I)=0.D0
            S(NOT1,I)=0.D0
            IF (NN.NE.0.AND.NN.NE.NFULL) THEN
              MULT(NOT1,I)=2
              LBCD(NOT1,I)=LL(I)
              IALF(NOT1,I)=IBLANK
              FL(NOT1,I)=FLL(I)
              S(NOT1,I)=0.5D0
            ENDIF
          ELSE
   70       CALL LOCDSK(ID2,FLL(I),NI(I))
            IF (I.EQ.1.AND.J1.LT.JX) NLT=MIN0(NLT,NLT11)
            IF (I.EQ.1.AND.JX.EQ.1) NLT=MIN0(NLT,NLT11)
            NLASTT(I)=NLT
            NOT1=NOTS+1
            NOTS=NOTS+NLT
            READ (ID2) (MULT(M,I),LBCD(M,I),IALF(M,I),FL(M,I),S(M,I),
     1        M=NOT1,NOTS)
          ENDIF
   78     NOTSJ1(I,J1+1)=NOTS
          NOTSX=MAX0(NOTS,NOTSX)
   79   CONTINUE
C
C          CALC PRELIMINARY LS TERMS
C
        M=NTOTTJ(J1)
        N1=NOTSJ1(1,J1)+1
        N2=NOTSJ1(2,J1)+1
        N3=NOTSJ1(3,J1)+1
        N4=NOTSJ1(4,J1)+1
        N5=NOTSJ1(5,J1)+1
        N6=NOTSJ1(6,J1)+1
        N7=NOTSJ1(7,J1)+1
        N8=NOTSJ1(8,J1)+1
        N11=NOTSJ1(1,J1+1)
        N22=NOTSJ1(2,J1+1)
        N33=NOTSJ1(3,J1+1)
        N44=NOTSJ1(4,J1+1)
        N55=NOTSJ1(5,J1+1)
        N66=NOTSJ1(6,J1+1)
        N77=NOTSJ1(7,J1+1)
        N88=NOTSJ1(8,J1+1)
        DO 120 I=N1,N11
          DO 120 J=N2,N22
          DO 120 K=N3,N33
          DO 120 L=N4,N44
          DO 120 I1=N5,N55
          DO 120 J2=N6,N66
          DO 120 K1=N7,N77
          DO 120 L8=N8,N88
C
C          15-FOLD DO LOOP (101 LINES) MOVED TO SUBROUTINE PLEVDOLP
C
            CALL PLEVDOLP
C
  120   CONTINUE
        NOTOTT=M
        L=NTOTTJ(J1)+1
        NTOTTJ(J1+1)=M
        IF (IPLEV.GT.0) THEN
  121     WRITE (IW,12)
   12     FORMAT (9H1LS TERMS)
          DO 122 M=L,NOTOTT
  122     WRITE (IW,13) NCFGP(M),PC(M),
     1      (NALSP(M,I),PSCRS(M,I),PSCRL(M,I), I=1,NOSUBC)
   13     FORMAT (1H ,I5,F10.5,8(I3,F5.1,F3.0))
        ENDIF
C
C          SORT ON DECREASING   25*SCRS4+SCRL4
C
  125   M1=NTOTTJ(J1+1)-NTOTTJ(J1)
        IF (M1.LE.1) GO TO 129
        CALL SORT2(M1,11,PC(L),PCI,NALSP(L,1),PSCRS(L,1),NALSP(L,2),
     1     NALSP(L,3),PSCRL(L,1),PSCRS(L,2),PSCRL(L,2),PSCRS(L,3),
     2     PSCRL(L,3),PSCRS(L,4),PSCRL(L,4),DUM)
        CALL ORDERI(M1,PCI,NALSP(L,4))
        IF (NOSUBC.LE.4) GO TO 129
        IF (NOSUBC.LT.7) GO TO 127
        CALL ORDER2(M1,PCI,PSCRL(L,8))
        CALL ORDER2(M1,PCI,PSCRS(L,8))
        CALL ORDERI(M1,PCI,NALSP(L,8))
        CALL ORDER2(M1,PCI,PSCRL(L,7))
        CALL ORDER2(M1,PCI,PSCRS(L,7))
        CALL ORDERI(M1,PCI,NALSP(L,7))
  127   CALL ORDER2(M1,PCI,PSCRL(L,6))
        CALL ORDER2(M1,PCI,PSCRS(L,6))
        CALL ORDERI(M1,PCI,NALSP(L,6))
        CALL ORDER2(M1,PCI,PSCRL(L,5))
        CALL ORDER2(M1,PCI,PSCRS(L,5))
        CALL ORDERI(M1,PCI,NALSP(L,5))
C
  129   IF (IPLEV.GT.0) THEN
  130     WRITE (IW,14)
   14     FORMAT (///18H0LS TERMS (SORTED)/)
          DO 131 M=L,NOTOTT
  131     WRITE (IW,13) NCFGP(M),PC(M),
     1      (NALSP(M,I),PSCRS(M,I),PSCRL(M,I), I=1,NOSUBC)
          WRITE (IW,15)
   15     FORMAT (1H1)
        ENDIF
C
C         CALC NO. OF TERMS OF EACH KIND
C
  135   K=NDIFFT
        N2=100000
  140   DO 143 M=L,NOTOTT
          N1=N2
          N2=25.D0*PSCRS(M,NOSUBC)+PSCRL(M,NOSUBC)
          IF (N2-N1) 142,141,1411
  141     NTRMK(K)=NTRMK(K)+1
          GO TO 143
 1411     IF (NOTOTT.GT.NLSC) THEN
            WRITE (*,1142) NOTOTT,NLSC
 1142       FORMAT(' NUMBER OF TERMS =',I5,'; NLSC =',I5)
            STOP ' DIMENSION EXCEEDED.'
          ENDIF
          STOP ' FAILED TO SORT DIFFERENT LS TERMS IN PLEVDOLP.'
  142     K=K+1
          NTRMK(K)=1
          SJ8MN=DMIN1(SJ8MN,DABS(PSCRS(M,NOSUBC)-PSCRL(M,NOSUBC)))
          SJ8MX=DMAX1(SJ8MX,PSCRS(M,NOSUBC)+PSCRL(M,NOSUBC))
          SJ8MX1=DMAX1(SJ8MX1,PSCRS(M,NOSUBC)+PSCRL(M,NOSUBC))
  143   CONTINUE
        NDIFFT=K
  150   IF (SJ8MN.EQ.SJ8MX) GO TO 170
        IF (SJ8MN.GE.SJN) GO TO 160
        SJ8MN=SJ8MN+1.D0
        GO TO 150
  160   IF (SJ8MX.LE.SJX) GO TO 170
        SJ8MX=SJ8MX-1.D0
        GO TO 160
  170   NSCRJ8=SJ8MX-SJ8MN+1.D0
C
C          CALC PRELIMINARY LEVELS FOR EACH SUBSHELL
C
  200   IF (NOLSKP.NE.0) GO TO 229
        SUM=0.D0
        DO 225 I=1,NOSUBC
          M=NTOTJJ(I,J1)
          N1=NOTSJ1(I,J1)+1
          N11=NOTSJ1(I,J1+1)
          DO 205 J=N1,N11
            EJI=DABS(FL(J,I)-S(J,I))-1.D0
            NJI=FL(J,I)+S(J,I)-EJI
            DO 205 IJ=1,NJI
              M=M+1
              EJI=EJI+1.D0
              NALSJP(M,I)=J
              A=DFLOAT(J)
              NCFGJP(M,I)=J1
              PC(M)=-200.D0*EJI-25.D0*S(J,I)-FL(J,I)+0.008403361*A
  205     PJ(M,I)=EJI
          NOTOTJ(I)=M
          NTOTJJ(I,J1+1)=M
          L=NTOTJJ(I,J1)+1
          IF (IPLEV) 215,215,206
  206     WRITE (IW,20) I
   20     FORMAT (/20H0LEVELS OF SUBSHELL ,I1)
          DO 211 N=L,M
            J=NALSJP(N,I)
  211     WRITE (IW,21)  NCFGJP(N,I),NALSJP(N,I),MULT(J,I),LBCD(J,I),
     1      PJ(N,I)
   21     FORMAT (I13,I4,I5,A1,F5.1)
C
C            SORT ON DECREASING PJ
C
  215     M1=NTOTJJ(I,J1+1)-NTOTJJ(I,J1)
          CALL SORT2(M1,2,PC(L),PCI,NALSJP(L,I),PJ(L,I),IDUM,IDUM,DUM,
     1      DUM,DUM,DUM,DUM,DUM,DUM,DUM)
C
          IF (IPLEV) 218,218,216
  216     WRITE (IW,22) I
   22     FORMAT (/20H0LEVELS OF SUBSHELL ,I1,9H (SORTED))
          DO 217 N=L,M
            J=NALSJP(N,I)
  217     WRITE (IW,21)  NCFGJP(N,I),NALSJP(N,I),MULT(J,I),LBCD(J,I),
     1      PJ(N,I)
C
C             CALC NO. OF LEVELS OF EACH PJ
C
  218     K=NDIFFJ(I)+1
          NJK(K,I)=1
          L=L+1
          IF (M.GE.L) THEN
            DO J=L,M
              IF (PJ(J,I).EQ.PJ(J-1,I)) THEN
                NJK(K,I)=NJK(K,I)+1
              ELSE
                K=K+1
                NJK(K,I)=1
              ENDIF
            ENDDO
          ENDIF
          NDIFFJ(I)=K
  225   SUM=SUM+PJ(L-1,I)
        IF (SUM.GT.SUMX) SUMX=SUM
  229 CONTINUE
C
      IF (SUMX.EQ.SJ8MX1) GO TO 256
      WRITE (IW,23) SJ8MX1,SUMX
   23 FORMAT (///15H0MAXIMUM SCRJ8=,F5.1,10H  FROM LS ,
     1  10HCALC, AND=,F5.1, 14H  FROM JJ CALC
     2  /52H   (LS.LT.JJ IS OK IF J VALUES HAVE BEEN RESTRICTED)
     3  /52H    (JJ.EQ.0 IS OK IF LS TERMS HAVE BEEN RESTRICTED))
  256 DO 270 I=1,KS
        IF (I.LE.NOSUBC.AND.NOLSKP.EQ.0) GO TO 270
        DO 260 J=1,JX
          IF (I.LE.NOSUBC) GO TO 258
          NOTSJ1(I,J+1)=J
  258     NTOTJJ(I,J)=J
          NOTOTJ(I)=J
          NDIFFJ(I)=J
          NJK(J,I)=1
          NALSJP(J,I)=J
  260   PJ(J,I)=0.D0
  270 CONTINUE
C
  300 IERROR=0
      MAXM=0
      MAXK=0
      DO 310 I=1,KS
        MAXM=MAX0(MAXM,NOTOTJ(I))
  310 MAXK=MAX0(MAXK,NDIFFJ(I))
      IF (NOTOTT.GT.KLSC.OR.NDIFFT.GT.KLSC) IERROR=7
      IF (MAXM.GT.KJP.OR.MAXK.GT.KJK) IERROR=7
      IF (NOTSX.GT.KLS2) IERROR=7
      WRITE (IW,30) KK,KLSC,NOTOTT,KLSC,NDIFFT,KJP,(NOTOTJ(I),I=1,KS),
     1  KJK,(NDIFFJ(I),I=1,KS),KLS2,NOTSX
   30 FORMAT (///25H MAXIMUM SUBSCRIPT VALUES,', PARITY NUMBER',I2//
     1  32H NALSP(M,I), PSCRL(M,I),   KLSC=,I4,15H   M=NOTOTT=   ,I5/
     2  17H NTRMK(K), LF(K),, 10X,5HKLSC=,I4,15H   K=NDIFFT=   ,I5/
     3  32H NALSJP(M,I), PJ(M,I),     KJP= ,I4,15H   M=NOTOTJ(I)=,8I5/
     4  10H NJK(K,I),,17X,5HKJK= ,I4,3X,12HK=NDIFFJ(I)=,8I5/
     5  16H FL(M,I),S(M,I),,11X,5HKLS2=,I4,14H   MMAX=NOTSX=,I6)
      JX=JX+1
      WRITE (IW,31) (NTOTTJ(J), J=1,JX)
   31 FORMAT (/8H0NTOTTJ=,20I6/(8X,20I6))
      WRITE (IW,32) (NTRMK(K), K=1,NDIFFT)
   32 FORMAT (/8H0 NTRMK=,20I6/(8X,20I6))
      IF (IERROR.EQ.0) GO TO 400
      WRITE (IW,33)
   33 FORMAT (//25H***** DIMENSIONS EXCEEDED)
      STOP '(PLEV 33)'
  400 RETURN
      END
C
      SUBROUTINE PLEVDOLP
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3/    CFP2(KLS1,KLS1,7),CIJK(10,6),
     1  U2(KLSI,KLSI,7),U3(KLSU,KLSU,9),U4(KLSU,KLSU,9),U5(KLSU,KLSU,7),
     2  U6(KLSU,KLSU,7),V2(KLSI,KLSI,7),V3(KLSI,KLSI,7),V4(KLSU,KLSU,7),
     *  V5(KLSU,KLSU,5),V6(KLSU,KLSU,5),
     3  NTI(41),IRP1MX,NALSJI(KJP),TFLN,TFLX,TFSN,TFSX,
     4  PJI(KJP),MULSI(KLSI),LBCDI(KLSI),IRHO,IRHOP,ISIG,ISIGP,FLLRHO,
     5  FLLSIG,IN,JN,JX,NII,NIJ,KI,KJ,KPI,KPJ,KDMIN,KEMIN,NKD,NKE,NKTOT,
     6  TR,TK,TC,RSUM,  J11,J12,L1,L2,TL(2,KS),TS(2,KS),
     7  TSCL(2,KS),TSCS(2,KS),NIJKP(KS,2),IRS(KS),IFL(KS),NDEL(KS),
     8    CIJR(8),CCC(8),N1,N2,N3,N4,E1,E2,E3,
     9  E4,E5,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,B1,B2,B3,B4,B5,B6,
     A  CFGP2(17,8,7),NALSJP(KJP,KS),PJ(KJP,KS)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      COMMON/CC/   U1(KLSI,KLSI,9),DUMLC1(KLC1)
      COMMON/C3LC2/CFGP1(KLSI,KLSI,7),PC(KPC),DUMLC2(KLC2)
      COMMON/C3LC3/V1(KLSI,KLSI,9),DUMLC3(KLC1)
      COMMON/C3LC4/DUMLC4(KMX**2-KISER),PCI(KISER)
      DIMENSION NPARJ(KC,KC),ISER(KISER)
      EQUIVALENCE (DUMLC4,NPARJ),(DUMLC4(KC**2+1),ISER)
      COMMON/C3LCD/DUMLCD
      COMMON/C3LC7/M,I,J,K,L,I1,J2,K1,L8,J1
      COMMON/EE/NALSP(KLSC,KS),PSCRL(KLSC,KS),PSCRS(KLSC,KS),
     1  NCFGP(KLSC),NJK(KJK,KS),NCFGJP(KJP,KS),MULS1(KLSC),MULS4(KLSC),
     2  LHS1(KLSC),LHS4(KLSC)
      DIMENSION CFP1(KLS1,KLS1)
      EQUIVALENCE (CFP1,CFGP1)
      DATA IBLANK/4H    /
C
C     NOTE--IF EQUIV OF CFP2 AND CFGP2 CHANGED,
C           MAKE CORRESPONDING CHANGE IN PRK CODE, STATEMENT 540 TO 569
C
C     KS=8
C     KJP=200
C     KLSC=210
C     KJK=110
      ES2=DABS(S(I,1)-S(J,2))-1.D0
      NS2=S(I,1)+S(J,2)-ES2
      DO 110 IS2=1,NS2
      ES2=ES2+1.D0
      EL2=DABS(FL(I,1)-FL(J,2))-1.D0
      NL2=FL(I,1)+FL(J,2)-EL2
      DO 110 IL2=1,NL2
      EL2=EL2+1.D0
      ES3=DABS(ES2-S(K,3))-1.D0
      NS3=ES2+S(K,3)-ES3
      DO 110 IS3=1,NS3
      ES3=ES3+1.D0
      EL3=DABS(EL2-FL(K,3))-1.D0
      NL3=EL2+FL(K,3)-EL3
      DO 110 IL3=1,NL3
      EL3=EL3+1.D0
      ES4=DABS(ES3-S(L,4))-1.D0
      NS4=ES3+S(L,4)-ES4
      DO 110 IS4=1,NS4
      ES4=ES4+1.D0
      EL4=DABS(EL3-FL(L,4))-1.D0
      NL4=EL3+FL(L,4)-EL4
      DO 110 IL4=1,NL4
      EL4=EL4+1.D0
      ES5=DABS(ES4-S(I1,5))-1.D0
      NS5=ES4+S(I1,5)-ES5
      DO 110 IS5=1,NS5
      ES5=ES5+1.D0
      EL5=DABS(EL4-FL(I1,5))-1.D0
      NL5=EL4+FL(I1,5)-EL5
      DO 110 IL5=1,NL5
      EL5=EL5+1.D0
      ES6=DABS(ES5-S(J2,6))-1.D0
      NS6=ES5+S(J2,6)-ES6
      DO 110 IS6=1,NS6
      ES6=ES6+1.D0
      EL6=DABS(EL5-FL(J2,6))-1.D0
      NL6=EL5+FL(J2,6)-EL6
      DO 110 IL6=1,NL6
      EL6=EL6+1.D0
      ES7=DABS(ES6-S(K1,7))-1.D0
      NS7=ES6+S(K1,7)-ES7
      DO 110 IS7=1,NS7
      ES7=ES7+1.D0
      EL7=DABS(EL6-FL(K1,7))-1.D0
      NL7=EL6+FL(K1,7)-EL7
      DO 110 IL7=1,NL7
      EL7=EL7+1.D0
      ES8=DABS(ES7-S(L8,8))-1.D0
      NS8=ES7+S(L8,8)-ES8
      DO 110 IS8=1,NS8
      ES8=ES8+1.D0
      EL8=DABS(EL7-FL(L8,8))-1.D0
      NL8=EL7+FL(L8,8)-EL8
      DO 110 IL8=1,NL8
      EL8=EL8+1.D0
      IF (DABS(EL8-ES8).GT.SJX) GO TO 110
      IF (EL8+ES8.LT.SJN) GO TO 110
      IF (NOLSKP.LE.0) GO TO 100
      IF (J1.LT.NCLSKP(KK)) GO TO 100
      DO 95 II=1,NOLSKP
      IF (EL8.EQ.SCRLKP(II,KK).AND.ES8.EQ.SCRSKP(II,KK)) GO TO 100
   95 CONTINUE
      GO TO 110
  100 M=M+1
      GO TO (108,107,106,105,104,103,102,101) NOSUBC
  101 NALSP(M,8)=L8
      PSCRS(M,8)=ES8
      PSCRL(M,8)=EL8
  102 NALSP(M,7)=K1
      PSCRS(M,7)=ES7
      PSCRL(M,7)=EL7
  103 NALSP(M,6)=J2
      PSCRS(M,6)=ES6
      PSCRL(M,6)=EL6
  104 NALSP(M,5)=I1
      PSCRS(M,5)=ES5
      PSCRL(M,5)=EL5
  105 NALSP(M,4)=L
      PSCRS(M,4)=ES4
      PSCRL(M,4)=EL4
  106 NALSP(M,3)=K
      PSCRS(M,3)=ES3
      PSCRL(M,3)=EL3
  107 NALSP(M,2)=J
      PSCRS(M,2)=ES2
      PSCRL(M,2)=EL2
  108 NALSP(M,1)=I
      PSCRS(M,1)=S(I,1)
      PSCRL(M,1)=FL(I,1)
      NCFGP(M)=J1
      A=0.D0
      PROD=1.D0
      ERAS=0.0084033613D0
      DO 109 II=1,NOSUBC
      B=DFLOAT(NALSP(M,II))
      A=A+PROD*B
C     IF (II.GT.4) ERAS=0.1D0
  109 PROD=PROD*ERAS
      PC(M)=-(25.D0*PSCRS(M,NOSUBC)+PSCRL(M,NOSUBC))+ERAS*A
  110 CONTINUE
      RETURN
      END
C     OVERLAY(G9,4,0)
      SUBROUTINE PFGD
C
C          CALC PRELIMINARY SINGLE-CONFIGURATION MATRIX ELEMENTS
C
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3/    CFP2(KLS1,KLS1,7),CIJK(10,6),
     1  U2(KLSI,KLSI,7),U3(KLSU,KLSU,9),U4(KLSU,KLSU,9),U5(KLSU,KLSU,7),
     2  U6(KLSU,KLSU,7),V2(KLSI,KLSI,7),V3(KLSI,KLSI,7),V4(KLSU,KLSU,7),
     *  V5(KLSU,KLSU,5),V6(KLSU,KLSU,5),
     3  NTI(41),IRP1MX,NALSJI(KJP),TFLN,TFLX,TFSN,TFSX,
     4  PJI(KJP),MULSI(KLSI),LBCDI(KLSI),IRHO,IRHOP,ISIG,ISIGP,FLLRHO,
     5  FLLSIG,IN,JN,JX,NII,NIJ,KI,KJ,KPI,KPJ,KDMIN,KEMIN,NKD,NKE,NKTOT,
     6  TR,TK,TC,RSUM,  J11,J12,L1,L2,TL(2,KS),TS(2,KS),
     7  TSCL(2,KS),TSCS(2,KS),NIJKP(KS,2),IRS(KS),IFL(KS),NDEL(KS),
     8    CIJR(8),CCC(8),N1,N2,N3,N4,E1,E2,E3,
     9  E4,E5,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,B1,B2,B3,B4,B5,B6,
     A  CFGP2(17,8,7),NALSJP(KJP,KS),PJ(KJP,KS)
      COMMON/CC/   U1(KLSI,KLSI,9),DUMLC1(KLC1)
      COMMON/C3LC2/CFGP1(KLSI,KLSI,7),PC(KPC),DUMLC2(KLC2)
      COMMON/C3LC3/V1(KLSI,KLSI,9),DUMLC3(KLC1)
      COMMON/C3LC4/DUMLC4(KMX**2-KISER),PCI(KISER)
      DIMENSION NPARJ(KC,KC),ISER(KISER)
      EQUIVALENCE (DUMLC4,NPARJ),(DUMLC4(KC**2+1),ISER)
      COMMON/C3LCD/DUMLCD
      COMMON/EE/NALSP(KLSC,KS),PSCRL(KLSC,KS),PSCRS(KLSC,KS),
     1  NCFGP(KLSC),NJK(KJK,KS),NCFGJP(KJP,KS),MULS1(KLSC),MULS4(KLSC),
     2  LHS1(KLSC),LHS4(KLSC)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      DIMENSION CFP1(KLS1,KLS1)
      EQUIVALENCE (CFP1,CFGP1)
      DIMENSION VFG(20,15)
      CHARACTER IDFG(15)*11
      CHARACTER*8 FIDLS,FIDJJ,LDES,LDESP,PARNAM,AA,COUPL
      COMMON/CHAR/PARNAM(KPR,2),FIDLS(KMX,2),FIDJJ(KMX,2),LDES(KMX),
     1  LDESP(KMX)
C
      CHARACTER*8 ABG(3),ZE(8)
      DATA (ABG(I),I=1,3) /'1000 ALP','BETA    ','GAMMA   '/
      DATA (ZE(I),I=1,8) /'ZETA 1','ZETA 2','ZETA 3','ZETA 4',
     1  'ZETA 5','ZETA 6','ZETA 7','ZETA 8'/
C
C
C      KS=8
      J1X=NSCONF(2,KK)
      LX=NTOTTJ(J1X+1)
      DO  97 L=1,LX
      MULS1(L)=2.D0*PSCRS(L,1)+1.D0
      MULS4(L)=2.D0*PSCRS(L,NOSUBC)+1.D0
      I=PSCRL(L,1)+1.D0
      LHS1(L)=LSYMB(I)
      I=PSCRL(L,NOSUBC)+1.D0
   97 LHS4(L)=LSYMB(I)
C
      NPAR=0
      NFG=0
      NPARJO=0
      REWIND 20
C
      DO 499 J1=1,J1X
      LL(NOSUBC)=LLIJK(NOSUBC,J1,KK)
      FLL(NOSUBC)=FLLIJK(NOSUBC,J1,KK)
      NPAR=NPAR+1
      PARNAM(NPAR,KK)=PARNAM(1,1)
      DO 99 I=1,KS
   99 NI(I)=NIJK(I,J1,KK)
C
C          OBTAIN FK(I,I) FROM DISK 14 AND TERMS OF LI(NI) FROM DISK 12
C
  100 DO 199 I=1,NOSUBC
      IF (NI(I).LE.1) GO TO 199
      N=4.D0*FLL(I)
      IF (NI(I).GT.N) GO TO 199
      CALL LOCDSK(ID2,FLL(I),NI(I))
      READ (ID2) (MULSI(M),LBCDI(M),IA,A,A, M=1,NLT)
      CALL LOCDSK(ID4,FLL(I),NI(I))
      IF (NSCONF(1,KK).GT.1) GO TO 115
      IF (SJN.GT.0.D0.OR.SJX.LT.99.D0) GO TO 115
      READ (ID4)
      GO TO 170
C
  115 READ (ID4) NDIFFI,(NTI(K),K=1,NDIFFI)
C
C          FIND CORRELATION BETWEEN TERMS OF CONF J1 AND TERMS OF LI(NI)
C
      NOPC=0
      MX=0
      DO 169 K=1,NDIFFT
      MN=MX+1
      MX=MX+NTRMK(K)
      IF (MX.LE.NTOTTJ(J1)) GO TO 169
      IF (MX.GT.NTOTTJ(J1+1)) GO TO 170
      DO 159 M=MN,MX
      J=NALSP(M,I)
      NPI0=0
      MXI=0
      DO 125 K1=1,NDIFFI
      MNI=MXI+1
      MXI=MXI+NTI(K1)
      IF (MULT(J,I).NE.MULSI(MNI)) GO TO 125
      IF (LBCD(J,I).EQ.LBCDI(MNI)) GO TO 130
  125 NPI0=NPI0+(NTI(K1)*(NTI(K1)+1))/2
  130 DO 149 MP=MN,M
      JP=NALSP(MP,I)
      NOPC=NOPC+1
      PC(NOPC)=0.D0
      ISER(NOPC)=-7
      IF (MULT(J,I).NE.MULT(JP,I)) GO TO 149
      IF (LBCD(J,I).NE.LBCD(JP,I)) GO TO 149
      DO 133 L=1,NOSUBC
      IF (PSCRL(M,L).NE.PSCRL(MP,L)) GO TO 149
      IF (PSCRS(M,L).NE.PSCRS(MP,L)) GO TO 149
      IF (L.EQ.I) GO TO 133
      IF (NALSP(M,L).NE.NALSP(MP,L)) GO TO 149
  133 CONTINUE
      NPI=NPI0
      DO 139 MI=MNI,MXI
      DO 135 MPI=MNI,MI
      NPI=NPI+1
      IF (J-NOTSJ1(I,J1).NE.MI) GO TO 135
      IF (JP-NOTSJ1(I,J1).NE.MPI) GO TO 135
      ISER(NOPC)=NPI
      GO TO 149
  135 CONTINUE
  139 CONTINUE
  149 CONTINUE
  159 CONTINUE
  169 CONTINUE
C
C          WRITE PC ON DISK 20
C
  170 NPARI=NORCD-2
      IF (IABG.EQ.0) NPARI=FLL(I)
      DO 198 N=1,NPARI
      IF (NSCONF(1,KK).GT.1) GO TO 175
      IF (SJN.GT.0.D0.OR.SJX.LT.99.D0) GO TO 175
      READ (ID4) KPAR,K,AA,CAVE,NOPC, (PC(J),J=1,NOPC)
      IF (KPAR.EQ.1) GO TO 198
      GO TO 185
  175 READ (ID4) KPAR,K,AA,CAVE,NPI, (PCI(J),J=1,NPI)
      IF (KPAR.EQ.1) GO TO 198
      DO 180 J=1,NOPC
      IF (ISER(J).LE.0) GO TO 180
      L=ISER(J)
      PC(J)=PCI(L)
  180 CONTINUE
C
  185 NPAR=NPAR+1
      NFG=NFG+1
      IF (K.NE.0) GO TO 186
      IF (IABG) 198,198,188
  186 WRITE (AA,14) K,I,I
   14 FORMAT (1HF,I1,1H(,2I1,3H)  )
  188 PARNAM(NPAR,KK)=AA
      WRITE (20) NPAR,KPAR,K,I,I,AA,CAVE,J1,NOPC, (PC(N1), N1=1,NOPC)
      IF (ICPC.LE.1.OR.ICPC.EQ.3) GO TO 197
      WRITE (IW,16) AA,CAVE
   16 FORMAT (1H2,A10,5X,5HCAVE=,F12.7//)
      NOPC=0
      LFG=0
      MX=0
      DO 191 L=1,NDIFFT
        MN=MX+1
        MX=MX+NTRMK(L)
        IF (MX.LE.NTOTTJ(J1)) GO TO 191
        IF (MX.GT.NTOTTJ(J1+1)) GO TO 197
        DO 190 M=MN,MX
          J=NALSP(M,I)
          N2=NOPC+1
          NOPC=N2+M-MN
          WRITE (IW,17) NCFGP(J),NOPC,MULT(J,I),LBCD(J,I),MULS4(M),
     1      LHS4(M), (PC(N1), N1=N2,NOPC)
   17     FORMAT (2I5,5H    (,I1,A1,1H),I4,A1, 10F10.5/(25X, 10F10.5))
          IF (ICPC.LT.5) GO TO 190
          LFG=LFG+1
          VFG(LFG,NFG)=PC(NOPC)
          WRITE (IDFG(NFG),19) K,I,LLIJK(I,1,1),I,LLIJK(I,1,1)
   19     FORMAT (1HF,I1,1H(,I2,A1,1H,,I2,A1,1H))
  190   CONTINUE
  191 CONTINUE
      IF (NOPC.GT.KISER) THEN
        WRITE (*,4501) NOPC,KISER
 4501   FORMAT(6H NOPC=,I10,11H     KISER=,I10)
        STOP '***** KISER DIMENSION ERROR *****'
      ENDIF
  197 IF (ICPC.EQ.0) GO TO 198
      CALL CLOCK(TIME)
      DELT=TIME-TIME0
      WRITE (IW,18) AA,NOPC,CAVE,DELT, (LL(L),NI(L), L=1,NOSUBC)
   18 FORMAT (/1H ,A10,5X,3HPC(,I5,1H),5X,5HCAVE=,F12.7,17X,5HDELT=,
     1  F6.3,4H MIN,7X, 8(A1,I2,3X))
  198 CONTINUE
  199 CONTINUE
C
C          OBTAIN ZETA(I) FROM DISK 14
C
  200 DO 299 I=1,NOSUBC
      IF (NI(I).LE.0) GO TO 299
      IF (FLL(I).LE.0.D0) GO TO 299
      NN=4.D0*FLL(I)+2.D0
      IF (NI(I).GE.NN) GO TO 299
      IF (NI(I).GT.1.AND.NI(I).LT.NN-1) GO TO 205
      NORCD=2
      M=1
      NTI(1)=1
      N1=2
      NALSJI(1)=1
      NALSJI(2)=1
      PJI(1)=FLL(I)+0.5D0
      PJI(2)=FLL(I)-0.5D0
      NDIFJI=2
      NTI(1)=1
      NTI(2)=1
      GO TO 220
  205 CALL LOCDSK(ID4,FLL(I),NI(I))
      IF (NSCONF(1,KK).GT.1) GO TO 215
      READ (ID4)
      GO TO 270
C
  215 READ (ID4) M,(NTI(K),K=1,M), N1,(NALSJI(K),PJI(K),K=1,N1),
     2  NDIFJI,(NTI(K),K=1,NDIFJI)
C
C          FIND CORREL. BETWEEN LEVELS IN CONF J1 AND LEVELS OF LI(NI)
C
  220 NOPC=0
      MX=0
      KX=NDIFFJ(I)
      DO 269 K=1,KX
      MN=MX+1
      MX=MX+NJK(K,I)
      IF (MX.LE.NTOTJJ(I,J1)) GO TO 269
      IF (MX.GT.NTOTJJ(I,J1+1)) GO TO 270
      DO 259 M=MN,MX
      J=NALSJP(M,I)-NOTSJ1(I,J1)
      NPI0=0
      MXI=0
      DO 225 KI=1,NDIFJI
      MNI=MXI+1
      MXI=MXI+NTI(KI)
      IF (PJ(M,I).EQ.PJI(MNI)) GO TO 230
  225 NPI0=NPI0+(NTI(KI)*(NTI(KI)+1))/2
  230 DO 249 MP=MN,M
      JP=NALSJP(MP,I)-NOTSJ1(I,J1)
      NOPC=NOPC+1
      PC(NOPC)=0.D0
      ISER(NOPC)=-7
      IF (PJ(M,I).NE.PJ(MP,I)) GO TO 249
      NPI=NPI0
      DO 239 MI=MNI,MXI
      DO 235 MPI=MNI,MI
      NPI=NPI+1
      IF (J.NE.NALSJI(MI)) GO TO 235
      IF (JP.NE.NALSJI(MPI)) GO TO 235
      ISER(NOPC)=NPI
      GO TO 249
  235 CONTINUE
  239 CONTINUE
  249 CONTINUE
  259 CONTINUE
  269 CONTINUE
C
C          WRITE PC ON DISK 20
C
  270 NPARI=NORCD-1
      DO 289 N=1,NPARI
      IF (NI(I).GT.1.AND.NI(I).LT.NN-1) GO TO 271
      A=-0.5D0
      IF (NI(I).EQ.1) A=0.5D0
      ERAS1=A*FLL(I)
      ERAS2=-A*(FLL(I)+1.D0)
      KPAR=1
      K=0
      CAVE=0.D0
      IF (NSCONF(1,KK).GT.1) GO TO 1270
      PC(1)=ERAS1
      PC(2)=ERAS2
      GO TO 285
 1270 PCI(1)=ERAS1
      PCI(2)=ERAS2
      GO TO 277
  271 IF (N.EQ.NPARI) GO TO 272
      READ (ID4)
      GO TO 289
  272 IF (NSCONF(1,KK).GT.1) GO TO 275
      READ (ID4) KPAR,K,AA,CAVE,NOPC, (PC(J),J=1,NOPC)
      GO TO 285
  275 READ (ID4) KPAR,K,AA,CAVE,NPI, (PCI(J),J=1,NPI)
  277 DO 280 J=1,NOPC
      IF (ISER(J).LE.0) GO TO 280
      L=ISER(J)
      PC(J)=PCI(L)
  280 CONTINUE
  285 NPAR=NPAR+1
      AA=ZE(I)
      PARNAM(NPAR,KK)=AA
      WRITE (20) NPAR,KPAR,K,I,I,AA,CAVE,J1,NOPC, (PC(N1), N1=1,NOPC)
      IF (ICPC.LE.1.OR.ICPC.EQ.3) GO TO 288
      WRITE (IW,16) AA,CAVE
      NOPC=0
      MX=0
      KX=NDIFFJ(I)
      DO 287 K=1,KX
      MN=MX+1
      MX=MX+NJK(K,I)
      IF (MX.LE.NTOTJJ(I,J1)) GO TO 287
      IF (MX.GT.NTOTJJ(I,J1+1)) GO TO 288
      DO 286 M=MN,MX
      J=NALSJP(M,I)
      N2=NOPC+1
      NOPC=N2+M-MN
  286 WRITE (IW,28) NCFGJP(M,I),NOPC,MULT(J,I),LBCD(J,I),PJ(M,I),
     1  (PC(N1),N1=N2,NOPC)
   28 FORMAT (3I5,A1,F4.1,10F11.6/(22X,10F11.6))
  287 CONTINUE
  288 IF (ICPC.EQ.0) GO TO 289
      CALL CLOCK(TIME)
      DELT=TIME-TIME0
      WRITE (IW,18) AA,NOPC,CAVE,DELT, (LL(L),NI(L), L=1,NOSUBC)
  289 CONTINUE
  299 CONTINUE
C
C          CALC FK(I,J)
C
      NOSCM1=NOSUBC-1
      IF (NOSCM1.LE.0) GO TO 498
      IRHO=0
CREAD U,V FROM DISK 13
      DO 7304 I=1,NOSUBC
      IF (NI(I).LE.1) GO TO 7304
      N=4.D0*FLL(I)+2.D0
      IF (NI(I).EQ.N) GO TO 7304
      CALL LOCDSK(ID3,FLL(I),NI(I))
      NOR=NORCD/2
      DO 303 K=1,NOR
      GO TO (1303,2303,3303,4303,5303,6303), I
 1303 READ (ID3) N, ((U1(II,JJ,K),II=1,NLT),JJ=1,NLT)
      GO TO 303
 2303 READ (ID3) N, ((U2(II,JJ,K),II=1,NLT),JJ=1,NLT)
      GO TO 303
 3303 READ (ID3) N, ((U3(II,JJ,K),II=1,NLT),JJ=1,NLT)
      GO TO 303
 4303 READ (ID3) N, ((U4(II,JJ,K),II=1,NLT),JJ=1,NLT)
      IF (NLT.GT.KLSU) GO TO 3031
      GO TO 303
 5303 READ (ID3) N, ((U5(II,JJ,K),II=1,NLT),JJ=1,NLT)
      IF (NLT.GT.KLSU) GO TO 3031
      GO TO 303
 6303 READ (ID3) N, ((U6(II,JJ,K),II=1,NLT),JJ=1,NLT)
      IF (NLT.GT.KLSU) GO TO 3031
  303 CONTINUE
      GO TO 3032
 3031 WRITE (*,3033) KLSU, NLT
 3033 FORMAT (' KLSU=',I5,' NLT=',I5)
      STOP "KLSU DIMENSION ERROR."
 3032 DO 304 K=1,NOR
      GO TO (1304,2304,3304,4304,5304,6304), I
 1304 READ (ID3) N, ((V1(II,JJ,K),II=1,NLT),JJ=1,NLT)
      GO TO 304
 2304 READ (ID3) N, ((V2(II,JJ,K),II=1,NLT),JJ=1,NLT)
      GO TO 304
 3304 READ (ID3) N, ((V3(II,JJ,K),II=1,NLT),JJ=1,NLT)
      GO TO 304
 4304 READ (ID3) N, ((V4(II,JJ,K),II=1,NLT),JJ=1,NLT)
      IF (NLT.GT.KLSU) GO TO 3031
      GO TO 304
 5304 READ (ID3) N, ((V5(II,JJ,K),II=1,NLT),JJ=1,NLT)
      IF (NLT.GT.KLSU) GO TO 3031
      GO TO 304
 6304 READ (ID3) N, ((V6(II,JJ,K),II=1,NLT),JJ=1,NLT)
      IF (NLT.GT.KLSU) GO TO 3031
  304 CONTINUE
 7304 CONTINUE
C
      DO 399 I=1,NOSCM1
      NII=NI(I)
      IF (NI(I)) 399,399,306
  306 IF (FLL(I)) 399,399,307
  307 N=4.D0*FLL(I)+2.D0
      IF (NI(I)-N) 308,399,399
  308 I1=I+1
      DO 389 J=I1,NOSUBC
      NIJ=NI(J)
      IF (NI(J)) 389,389,310
  310 IF (FLL(J)) 389,389,311
  311 N=4.D0*FLL(J)+2.D0
      IF (NI(J)-N) 312,389,389
  312 IF (FLL(I)-FLL(J)) 313,314,314
  313 KMAX=2.D0*FLL(I)
      GO TO 315
  314 KMAX=2.D0*FLL(J)
  315 DO 385 K=1,KMAX
      IF (IABG.NE.2.AND.IABG.NE.4.AND.MOD(K,2).NE.0) GO TO 385
      IF (ICPC.LE.1.OR.ICPC.EQ.3) GO TO 320
      WRITE (IW,31)
   31 FORMAT (1H2)
      WRITE (IW,32) K,I,J
   32 FORMAT (2H F,I1,1H(,I1,1H,,I1,1H)//)
  320 FK=K
      CIJ=CIJKF(FLL(I),FLL(I),FK)*CIJKF(FLL(J),FLL(J),FK)
      IF (MOD(K,2).NE.0) CIJ=1.D0
C
  330 NOPC=0
      NFG=NFG+1
      LFG=0
      MMAX=0
      DO 383 L=1,NDIFFT
        MMIN=MMAX+1
        MMAX=MMAX+NTRMK(L)
        IF (NCFGP(MMAX).NE.J1) GO TO 383
        NOTSI=NOTSJ1(I,J1)
        NOTSJ=NOTSJ1(J,J1)
        DO 382 M=MMIN,MMAX
          JI=NALSP(M,I)
          JJ=NALSP(M,J)
          KI=JI-NOTSI
          KJ=JJ-NOTSJ
          DO 381 MP=MMIN,M
            JPI=NALSP(MP,I)
            JPJ=NALSP(MP,J)
            KPI=JPI-NOTSI
            KPJ=JPJ-NOTSJ
            NOPC=NOPC+1
            PC(NOPC)=0.D0
            DO 341 IP=1,NOSUBC
              IF (PSCRS(M,IP)-PSCRS(MP,IP)) 381,331,381
  331         IF (IP-I) 339,332,335
  332         IF (S(JI,I)-S(JPI,I)) 381,341,381
  335         IF (IP-J) 340,336,339
  336         IF (PSCRL(M,IP)-PSCRL(MP,IP)) 381,337,381
  337         IF (S(JJ,J)-S(JPJ,J)) 381,341,381
  339         IF (PSCRL(M,IP)-PSCRL(MP,IP)) 381,340,381
  340         IF (NALSP(M,IP)-NALSP(MP,IP)) 381,341,381
  341       CONTINUE
            DO 350 IP=1,NOSUBC
              II=NALSP(M,IP)
              TL(1,IP)=FL(II,IP)
              TS(1,IP)=S(II,IP)
              TSCL(1,IP)=PSCRL(M,IP)
  350       TSCS(1,IP)=PSCRS(M,IP)
            DO 3501 IP=1,NOSUBC
              II=NALSP(MP,IP)
              TL(2,IP)=FL(II,IP)
              TS(2,IP)=S(II,IP)
              TSCL(2,IP)=PSCRL(MP,IP)
 3501       TSCS(2,IP)=PSCRS(MP,IP)
            TK=FK
c           if (npar.eq.10.and.nopc.eq.204) then
c             tk=tk
c           endif
            CALL RDIJ(I,J)
C
            PC(NOPC)=A*CIJ
  381     CONTINUE
          IF (ICPC.LE.1.OR.ICPC.EQ.3) GO TO 382
          N2=NOPC-M+MMIN
          WRITE (IW,17) NCFGP(M),NOPC,MULS1(M),LHS1(M),MULS4(M),
     1      LHS4(M), (PC(N1), N1=N2,NOPC)
          IF (ICPC.LT.5) GO TO 382
          LFG=LFG+1
          VFG(LFG,NFG)=PC(NOPC)
          WRITE (IDFG(NFG),19) K,I,LLIJK(I,1,1),J,LLIJK(J,1,1)
  382   CONTINUE
  383 CONTINUE
      NPAR=NPAR+1
      KPAR=-1
      CAVE=0.D0
      WRITE (AA,14) K,I,J
      PARNAM(NPAR,KK)=AA
      WRITE (20) NPAR,KPAR,K,I,J,AA,CAVE,J1,NOPC, (PC(N1), N1=1,NOPC)
      IF (ICPC.EQ.0) GO TO 385
      CALL CLOCK(TIME)
      DELT=TIME-TIME0
      WRITE (IW,18) AA,NOPC,CAVE,DELT, (LL(L),NI(L), L=1,NOSUBC)
  385 CONTINUE
  389 CONTINUE
  399 CONTINUE
C
C          CALC GK(I,J)
C
  400 DO 497 I=1,NOSCM1
      NII=NI(I)
      IF (NI(I)) 497,497,401
  401 N=4.D0*FLL(I)+2.D0
      IF (NI(I)-N) 403,497,497
  403 I1=I+1
      DO 489 J=I1,NOSUBC
      NIJ=NI(J)
      IF (NI(J)) 489,489,405
  405 N=4.D0*FLL(J)+2.D0
      IF (NI(J)-N) 406,489,489
  406 KMAX=FLL(I)+FLL(J)
      KMIN=DABS(FLL(I)-FLL(J))
      KDMIN=0
      IRP1MX=KMAX-KMIN+1
      MN=I+1
      MX=J-1
      DO 485 K=KMIN,KMAX
      IF (IABG.NE.2.AND.IABG.NE.4.AND.MOD(K-KMIN,2).NE.0) GO TO 485
      FK=K
      CIJ=(CIJKF(FLL(I),FLL(J),FK))**2
      A=NI(I)*NI(J)
      CAVE=A*S3J0SQ(FLL(I),FK,FLL(J))/2.D0
      LPL=FLL(I)+FLL(J)+FK
      IF (MOD(LPL,2).EQ.0) GO TO 407
      CIJ=0.5D0*((-1.D0)**K)
      CAVE=-CIJ*A/((2.D0*FLL(I)+1.D0)*(2.D0*FLL(J)+1.D0))
      CIJ=2.D0*CIJ
  407 IF (ICPC.LE.1.OR.ICPC.EQ.3) GO TO 410
      WRITE (IW,31)
      WRITE (IW,40) K,I,J,CAVE
   40 FORMAT (2H G,I1,1H(,I1,1H,,I1,1H),6X,5HCAVE=,F12.7//)
C
  410 NOPC=0
      NFG=NFG+1
      LFG=0
      MMAX=0
      DO 483 L=1,NDIFFT
      MMIN=MMAX+1
      MMAX=MMAX+NTRMK(L)
      IF (NCFGP(MMAX).NE.J1) GO TO 483
      NOTSI=NOTSJ1(I,J1)
      NOTSJ=NOTSJ1(J,J1)
      DO 482 M=MMIN,MMAX
      JI=NALSP(M,I)
      JJ=NALSP(M,J)
      KI=JI-NOTSI
      KJ=JJ-NOTSJ
      DO 481 MP=MMIN,M
      JPI=NALSP(MP,I)
      JPJ=NALSP(MP,J)
      KPI=JPI-NOTSI
      KPJ=JPJ-NOTSJ
      NOPC=NOPC+1
      PC(NOPC)=0.D0
      DO 417 IP=1,NOSUBC
      IF (IP-I) 414,417,413
  412 IF (NALSP(M,IP)-NALSP(MP,IP)) 481,417,481
  413 IF (IP-J) 412,415,414
  414 IF (NALSP(M,IP)-NALSP(MP,IP)) 481,415,481
  415 IF (PSCRL(M,IP)-PSCRL(MP,IP)) 481,416,481
  416 IF (PSCRS(M,IP)-PSCRS(MP,IP)) 481,417,481
  417 CONTINUE
C
      DO 450 III=1,2
      MM=M
      IF (III.EQ.2) MM=MP
      DO 450 IP=1,NOSUBC
      II=NALSP(MM,IP)
      TL(III,IP)=FL(II,IP)
      TS(III,IP)=S(II,IP)
      TSCL(III,IP)=PSCRL(MM,IP)
  450 TSCS(III,IP)=PSCRS(MM,IP)
      FLLRHO=FLL(I)
      FLLRHOP=FLL(I)
      FLLSIG=FLL(J)
      FLLSIGP=FLL(J)
      TK=FK
      CALL REIJ(I,J)
C
      PC(NOPC)=CIJ*RSUM
      IF (M.NE.MP) GO TO 481
      PC(NOPC)=PC(NOPC)+CAVE
  481 CONTINUE
C
      IF (ICPC.LE.1.OR.ICPC.EQ.3) GO TO 482
      N2=NOPC-M+MMIN
      WRITE (IW,17) NCFGP(M),NOPC,MULS1(M),LHS1(M),MULS4(M),
     1  LHS4(M), (PC(N1), N1=N2,NOPC)
      IF (ICPC.LT.5) GO TO 482
      LFG=LFG+1
      VFG(LFG,NFG)=PC(NOPC)
      WRITE (IDFG(NFG),47) K,I,LLIJK(I,1,1),J,LLIJK(J,1,1)
   47 FORMAT (1HG,I1,1H(,I2,A1,1H,,I2,A1,1H))
  482 CONTINUE
  483 CONTINUE
      NPAR=NPAR+1
      KPAR=0
      WRITE (AA,48) K,I,J
   48 FORMAT (1HG,I1,1H(,2I1,3H)  )
      PARNAM(NPAR,KK)=AA
      WRITE (20) NPAR,KPAR,K,I,J,AA,CAVE,J1,NOPC, (PC(N1), N1=1,NOPC)
      IF (ICPC.EQ.0) GO TO 485
      CALL CLOCK(TIME)
      DELT=TIME-TIME0
      WRITE (IW,18) AA,NOPC,CAVE,DELT, (LL(L),NI(L), L=1,NOSUBC)
  485 CONTINUE
  489 CONTINUE
  497 CONTINUE
C
  498 NPARJ(J1,J1)=NPAR-NPARJO
      NPARJO=NPAR
  499 CONTINUE
      IF (ICPC.LT.5) GO TO 900
C
C          WRITE RCN INPUT COEFFICIENTS FOR LS-DEPENDENT HF CALCNS.
C
      DO 510 K=1,LFG
      M1=2.D0*PSCRS(K,1)+1.D0
      L1=PSCRL(K,1)
      L1=LSYMB(L1+1)
      M=2.D0*PSCRS(K,NOSUBC)+1.D0
      L=PSCRL(K,NOSUBC)
      L=LSYMB(L+1)
  510 WRITE (11,51) LLIJK(1,1,1),NIJK(1,1,1),M1,L1,LLIJK(2,1,1),
     1  M,L,NFG,(VFG(K,J),IDFG(J),J=1,NFG)
   51 FORMAT (A1,I1,1H(,I1,A1,1H),A1,I2,A1,I5,5X,3(F9.5,A11)/
     1  (4(F9.5,A11)))
      WRITE (11,28)
C
  900 RETURN
      END
      SUBROUTINE RDIJ(I,J)
C
C          CALCULATE RD(I,J)
C
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3/    CFP2(KLS1,KLS1,7),CIJK(10,6),
     1  U2(KLSI,KLSI,7),U3(KLSU,KLSU,9),U4(KLSU,KLSU,9),U5(KLSU,KLSU,7),
     2  U6(KLSU,KLSU,7),V2(KLSI,KLSI,7),V3(KLSI,KLSI,7),V4(KLSU,KLSU,7),
     *  V5(KLSU,KLSU,5),V6(KLSU,KLSU,5),
     3  NTI(41),IRP1MX,NALSJI(KJP),TFLN,TFLX,TFSN,TFSX,
     4  PJI(KJP),MULSI(KLSI),LBCDI(KLSI),IRHO,IRHOP,ISIG,ISIGP,FLLRHO,
     5  FLLSIG,IN,JN,JX,NII,NIJ,KI,KJ,KPI,KPJ,KDMIN,KEMIN,NKD,NKE,NKTOT,
     6  TR,TK,TC,RSUM,  J11,J12,L1,L2,TL(2,KS),TS(2,KS),
     7  TSCL(2,KS),TSCS(2,KS),NIJKP(KS,2),IRS(KS),IFL(KS),NDEL(KS),
     8    CIJR(8),CCC(8),N1,N2,N3,N4,E1,E2,E3,
     9  E4,E5,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,B1,B2,B3,B4,B5,B6,
     A  CFGP2(17,8,7),NALSJP(KJP,KS),PJ(KJP,KS)
      COMMON/CC/   U1(KLSI,KLSI,9),DUMLC1(KLC1)
      COMMON/C3LC2/CFGP1(KLSI,KLSI,7),PC(KPC),DUMLC2(KLC2)
      COMMON/C3LC3/V1(KLSI,KLSI,9),DUMLC3(KLC1)
      COMMON/C3LC4/DUMLC4(KMX**2-KISER),PCI(KISER)
      DIMENSION NPARJ(KC,KC),ISER(KISER)
      EQUIVALENCE (DUMLC4,NPARJ),(DUMLC4(KC**2+1),ISER)
      COMMON/C3LCD/DUMLCD
      COMMON/EE/NALSP(KLSC,KS),PSCRL(KLSC,KS),PSCRS(KLSC,KS),
     1  NCFGP(KLSC),NJK(KJK,KS),NCFGJP(KJP,KS),MULS1(KLSC),MULS4(KLSC),
     2  LHS1(KLSC),LHS4(KLSC)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      DIMENSION CFP1(KLS1,KLS1)
      EQUIVALENCE (CFP1,CFGP1)
C
      N=TK+1.D0
      A=ZERO
      DO 200 II=I,J
      IF (TS(1,II).NE.TS(2,II)) GO TO 399
      IF (TSCS(1,II).NE.TSCS(2,II)) GO TO 399
  200 CONTINUE
  300 IXX=TL(1,J)+TSCL(2,J-1)+TSCL(1,J)
      A=(-ONE)**IXX
      A=A*S6J(TSCL(1,J-1),TSCL(2,J-1),TK, TL(2,J),TL(1,J),TSCL(1,J))
      MN=I+1
      MX=J-1
      IF (MN-MX) 350,350,352
  350 DO 351 M1=MN,MX
  351 A=A*UNCPLA(TSCL(1,M1-1),TL(1,M1),TSCL(1,M1),
     1    TK,TSCL(2,M1-1),TSCL(2,M1))
  352 IF (I-1) 366,366,355
  355 A=A*UNCPLB(TSCL(1,I-1),TL(1,I),TSCL(1,I), TK,TL(2,I),TSCL(2,I))
  366 IF (NII.EQ.1) GO TO 380
      IF (IRHO.NE.0) GO TO 371
      GO  TO (371,372,373,374,375,376) I
  371 A=A*U1(KI,KPI,N)
      GO TO 380
  372 A=A*U2(KI,KPI,N)
      GO TO 380
  373 A=A*U3(KI,KPI,N)
      GO TO 380
  374 A=A*U4(KI,KPI,N)
      GO TO 380
  375 A=A*U5(KI,KPI,N)
      GO TO 380
  376 A=A*U6(KI,KPI,N)
  380 IF (NIJ.EQ.1) GO TO 399
      IF (IRHO.NE.0) GO TO 381
      GO TO (381,382,383,384,385,386) J
  381 A=A*U1(KJ,KPJ,N)
      GO TO 399
  382 A=A*U2(KJ,KPJ,N)
      GO TO 399
  383 A=A*U3(KJ,KPJ,N)
      GO TO 399
  384 A=A*U4(KJ,KPJ,N)
      GO TO 399
  385 A=A*U5(KJ,KPJ,N)
      GO TO 399
  386 A=A*U6(KJ,KPJ,N)
  399 CONTINUE
C
      RETURN
      END
      SUBROUTINE REIJ(I,J)
C
C          CALCULATE RE(I,J)
C
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3/    CFP2(KLS1,KLS1,7),CIJK(10,6),
     1  U2(KLSI,KLSI,7),U3(KLSU,KLSU,9),U4(KLSU,KLSU,9),U5(KLSU,KLSU,7),
     2  U6(KLSU,KLSU,7),V2(KLSI,KLSI,7),V3(KLSI,KLSI,7),V4(KLSU,KLSU,7),
     *  V5(KLSU,KLSU,5),V6(KLSU,KLSU,5),
     3  NTI(41),IRP1MX,NALSJI(KJP),TFLN,TFLX,TFSN,TFSX,
     4  PJI(KJP),MULSI(KLSI),LBCDI(KLSI),IRHO,IRHOP,ISIG,ISIGP,FLLRHO,
     5  FLLSIG,IN,JN,JX,NII,NIJ,KI,KJ,KPI,KPJ,KDMIN,KEMIN,NKD,NKE,NKTOT,
     6  TR,TK,TC,RSUM,  J11,J12,L1,L2,TL(2,KS),TS(2,KS),
     7  TSCL(2,KS),TSCS(2,KS),NIJKP(KS,2),IRS(KS),IFL(KS),NDEL(KS),
     8    CIJR(8),CCC(8),N1,N2,N3,N4,E1,E2,E3,
     9  E4,E5,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,B1,B2,B3,B4,B5,B6,
     A  CFGP2(17,8,7),NALSJP(KJP,KS),PJ(KJP,KS)
      COMMON/CC/   U1(KLSI,KLSI,9),DUMLC1(KLC1)
      COMMON/C3LC2/CFGP1(KLSI,KLSI,7),PC(KPC),DUMLC2(KLC2)
      COMMON/C3LC3/V1(KLSI,KLSI,9),DUMLC3(KLC1)
      COMMON/C3LC4/DUMLC4(KMX**2-KISER),PCI(KISER)
      DIMENSION NPARJ(KC,KC),ISER(KISER)
      EQUIVALENCE (DUMLC4,NPARJ),(DUMLC4(KC**2+1),ISER)
      COMMON/EE/NALSP(KLSC,KS),PSCRL(KLSC,KS),PSCRS(KLSC,KS),
     1  NCFGP(KLSC),NJK(KJK,KS),NCFGJP(KJP,KS),MULS1(KLSC),MULS4(KLSC),
     2  LHS1(KLSC),LHS4(KLSC)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      DIMENSION CFP1(KLS1,KLS1)
      EQUIVALENCE (CFP1,CFGP1)
C
      DATA SQRT3H/1.224744871D0/
C
  400 IXX=TL(1,J)+TSCL(2,J-1)+TSCL(1,J)
      AR=(-ONE)**IXX
      IXX=TS(1,J)+TSCS(2,J-1)+TSCS(1,J)
      A1R=(-ONE)**IXX
      A1R=A1R*S6J(TSCS(1,J-1),TS(1,J),TSCS(1,J),TS(2,J),TSCS(2,J-1),
     1  ONE)
      MN=I+1
      MX=J-1
      IF (MN-MX) 420,420,422
  420 DO 421 M1=MN,MX
      IXX=TSCL(1,M1-1)+TL(1,M1)+TSCL(2,M1)
      IF (MOD(IXX,2).GT.0) AR=-AR
      AR=AR*DSQRT((2.D0*TSCL(1,M1)+1.D0)*(2.D0*TSCL(2,M1)+1.D0))
  421 A1R=A1R*UNCPLA(TSCS(1,M1-1),TS(1,M1),TSCS(1,M1),
     1      ONE,TSCS(2,M1-1),TSCS(2,M1))
  422 IF (I-1) 430,430,425
  425 IXX=TSCL(1,I-1)+TSCL(1,I)+TL(2,I)
      IF (MOD(IXX,2).GT.0) AR=-AR
      AR=AR*DSQRT((2.D0*TSCL(1,I)+1.D0)*(2.D0*TSCL(2,I)+1.D0))
      A1R=A1R*UNCPLB(TSCS(1,I-1),TS(1,I),TSCS(1,I),
     1      ONE,TS(2,I),TSCS(2,I))
  430 A1R=A1R*AR
      DO 431 M1=I,MX
      IF (TSCS(1,M1)-TSCS(2,M1)) 433,431,433
  431 CONTINUE
      IF (TS(1,I)-TS(2,I)) 433,432,433
  432 IF (TS(1,J)-TS(2,J)) 433,440,433
  433 AR=ZERO
C
  440 RSUM=ZERO
      R=KDMIN-1
      DO 469 IRP1=1,IRP1MX
      R=R+1.D0
      N=R+1.D0
      PR=S6J(TSCL(1,J-1),TSCL(2,J-1),R, TL(2,J),TL(1,J),TSCL(1,J))
      P1R=4.0D0
      IF (MN-MX) 443,443,445
  443 DO 444 M1=MN,MX
      IF (DMOD(R,TWO).GT.ZERO) PR=-PR
  444 PR=PR*S6J(TSCL(1,M1-1),TSCL(2,M1-1),R,
     1    TSCL(2,M1),TSCL(1,M1),TL(1,M1))
  445 IF (I.LE.1) GO TO 447
      IF (DMOD(R,TWO).GT.ZERO) PR=-PR
      PR=PR*S6J(TL(1,I),TL(2,I),R,
     1          TSCL(2,I),TSCL(1,I),TSCL(1,I-1))
  447 P1R=P1R*PR*A1R
      PR=PR*AR
      IF (NII.GT.1) GO TO 450
      P1R=P1R*SQRT3H
      GO TO 459
  450 IF (IRHO.NE.0) GO TO 451
      GO TO(451,452,453,454,455,456) I
  451 PR=PR*U1(KI,KPI,N)
      P1R=P1R*V1(KI,KPI,N)
      GO TO 459
  452 PR=PR*U2(KI,KPI,N)
      P1R=P1R*V2(KI,KPI,N)
      GO TO 459
  453 PR=PR*U3(KI,KPI,N)
      P1R=P1R*V3(KI,KPI,N)
      GO TO 459
  454 PR=PR*U4(KI,KPI,N)
      P1R=P1R*V4(KI,KPI,N)
      GO TO 459
  455 PR=PR*U5(KI,KPI,N)
      P1R=P1R*V5(KI,KPI,N)
      GO TO 459
  456 PR=PR*U6(KI,KPI,N)
      P1R=P1R*V6(KI,KPI,N)
  459 IF (NIJ.GT.1) GO TO 460
      P1R=P1R*SQRT3H
      GO TO 468
  460 IF (IRHO.NE.0) GO TO 461
      GO TO (461,462,463,464,465,466) J
  461 PR=PR*U1(KJ,KPJ,N)
      P1R=P1R*V1(KJ,KPJ,N)
      GO TO 468
  462 PR=PR*U2(KJ,KPJ,N)
      P1R=P1R*V2(KJ,KPJ,N)
      GO TO 468
  463 PR=PR*U3(KJ,KPJ,N)
      P1R=P1R*V3(KJ,KPJ,N)
      GO TO 468
  464 PR=PR*U4(KJ,KPJ,N)
      P1R=P1R*V4(KJ,KPJ,N)
      GO TO 468
  465 PR=PR*U5(KJ,KPJ,N)
      P1R=P1R*V5(KJ,KPJ,N)
      GO TO 468
  466 PR=PR*U6(KJ,KPJ,N)
      P1R=P1R*V6(KJ,KPJ,N)
  468 B=(2.D0*R+1.D0)*S6J(FLLRHO,FLLRHOP,R, FLLSIG,FLLSIGP,TK)
      IF (DMOD(R,TWO).GT.ZERO) B=-B
      RSUM=RSUM+B*(PR+P1R)
  469 CONTINUE
      RSUM=-0.5D0*RSUM
C
      RETURN
      END
C     OVERLAY(G9,5,0)
      SUBROUTINE PRK
C
C          CALC PRELIMINARY CONFIGURATION-INTERACTION MATRIX ELEMENTS
C
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      PARAMETER (KCC=KISER/4,KLC4=2*KISER+1)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3/    CFP2(KLS1,KLS1,7),CIJK(10,6),
     1  U2(KLSI,KLSI,7),U3(KLSU,KLSU,9),U4(KLSU,KLSU,9),U5(KLSU,KLSU,7),
     2  U6(KLSU,KLSU,7),V2(KLSI,KLSI,7),V3(KLSI,KLSI,7),V4(KLSU,KLSU,7),
     *  V5(KLSU,KLSU,5),V6(KLSU,KLSU,5),
     3  NTI(41),IRP1MX,NALSJI(KJP),TFLN,TFLX,TFSN,TFSX,
     4  PJI(KJP),MULSI(KLSI),LBCDI(KLSI),IRHO,IRHOP,ISIG,ISIGP,FLLRHO,
     5  FLLSIG,IN,JN,JX,NII,NIJ,KI,KJ,KPI,KPJ,KDMIN,KEMIN,NKD,NKE,NKTOT,
     6  TR,TK,TC,RSUM,  J11,J12,L1,L2,TL(2,KS),TS(2,KS),
     7  TSCL(2,KS),TSCS(2,KS),NIJKP(KS,2),IRS(KS),IFL(KS),NDEL(KS),
     8    CIJR(8),CCC(8),N1,N2,N3,N4,E1,E2,E3,
     9  E4,E5,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,B1,B2,B3,B4,B5,B6,
     A  CFGP2(17,8,7),NALSJP(KJP,KS),PJ(KJP,KS)
      COMMON/CC/   U1(KLSI,KLSI,9),DUMLC1(KLC1)
      COMMON/C3LC2/CFGP1(KLSI,KLSI,7),PC(KPC),DUMLC2(KLC2)
      COMMON/C3LC3/V1(KLSI,KLSI,9),DUMLC3(KLC1)
      COMMON/C3LC4/DUMLC4(KMX**2-KCC*8),CC(KCC,8)
      DIMENSION NPARJ(KC,KC)
      EQUIVALENCE (DUMLC4,NPARJ)
      COMMON/EE/NALSP(KLSC,KS),PSCRL(KLSC,KS),PSCRS(KLSC,KS),
     1  NCFGP(KLSC),NJK(KJK,KS),NCFGJP(KJP,KS),MULS1(KLSC),MULS4(KLSC),
     2  LHS1(KLSC),LHS4(KLSC)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      COMMON/SORTDUM/DUM(2),IDUM(2)
      CHARACTER*8 FIDLS,FIDJJ,LDES,LDESP,PARNAM,AA,COUPL
      CHARACTER*4 LSYMB
      COMMON/CHAR/PARNAM(KPR,2),FIDLS(KMX,2),FIDJJ(KMX,2),LDES(KMX),
     1  LDESP(KMX)
      INTEGER*1 J1A1,J1B1
      DIMENSION CFP1(KLS1,KLS1),NOPCCC(KLC1)
      EQUIVALENCE (CFP1,CFGP1),(DUMLC3,NOPCCC)
      DIMENSION INTEST(80)
C
C
C     KS=8
C     KCC=2500
C     KLC1=78**2-(17**2)*9
C     KPC=2000
C     NKTOTX=LOCF(CCC(1))-LOCF(CIJR(1))
C          NKTOTX=DIMENSION OF CIJR AND CCC
      NKTOTX=8
      NPCX=KPC
      NCCX=KLC1
C
      NPARJO=NPAR
      J1X=NSCONF(2,KK)
      IF (J1X.LE.1) GO TO 900
      DO 400 I=1,80
  400 INTEST(I)=0
      IF (NSCONF(3,KK).NE.0) GO TO 500
      READ (IR,50) (INTEST(I),I=1,80)
   50 FORMAT (80I1)
C
C
C
C
C          CALCULATE RK(I,J)
C
  500 J1XM1=J1X-1
      NOCCX=0
      JTEST=0
      DO 799 J1A=1,J1XM1
      J1AP1=J1A+1
      DO 799 J1B=J1AP1,J1X
      JTEST=JTEST+1
      NPARJ(J1A,J1B)=0
      IF (NSCONF(3,KK).EQ.0.AND.INTEST(JTEST).EQ.0) GO TO 799
      IF (NSCONF(3,KK).GT.0.AND.J1B.GT.J1A+NSCONF(3,KK)) GO TO 799
      IF (NSCONF(3,KK).EQ.-9.AND.(J1A.EQ.1.OR.J1B.EQ.J1A+1)) GO TO 501
      IF (NSCONF(3,KK).EQ.-9) GO TO 799
      IF (NSCONF(3,KK).EQ.-8) GO TO 501
      IF (NSCONF(3,KK).LT.0.AND.J1A.GT.MAX0(-NSCONF(3,KK),IPCT))
     1  GO TO 799
  501 DO 798 IRHO=1,NOSUBC
      IRS(1)=IRHO
      DO 798 ISIG=IRHO,NOSUBC
      IRS(2)=ISIG
      DO 798 IRHOP=1,NOSUBC
      IRS(3)=IRHOP
      DO 797 ISIGP=IRHOP,NOSUBC
      IRS(4)=ISIGP
      FLLSIG=FLLIJK(ISIG,J1A,KK)
      FLLSIGP=FLLIJK(ISIGP,J1B,KK)
C              CHECK WHETHER IRHO...ISIGP IS A POSSIBLE SET OF ELECTRONS
      IF (ISIG.EQ.NOSUBC.OR.ISIGP.EQ.NOSUBC) GO TO 1501
      IF (NIJK(NOSUBC,J1A,KK).EQ.1.AND.NIJK(NOSUBC,J1B,KK).EQ.1.AND.
     1  FLLIJK(NOSUBC,J1A,KK).NE.FLLIJK(NOSUBC,J1B,KK)) GO TO 797
 1501 IF (IRHO.NE.IRHOP.OR.ISIG.NE.ISIGP) GO TO 503
      NN=0
      DO 502 I=ISIG,NOSUBC
  502 NN=NN+NIJK(I,J1A,KK)+NIJK(I,J1B,KK)
      IF (NN.GT.2) GO TO 797
  503 DO 504 I=1,NOSUBC
      NIJKP(I,1)=NIJK(I,J1A,KK)
  504 NIJKP(I,2)=NIJK(I,J1B,KK)
      NIJKP(IRHO,1)=NIJKP(IRHO,1)-1
      NIJKP(ISIG,1)=NIJKP(ISIG,1)-1
      NIJKP(IRHOP,2)=NIJKP(IRHOP,2)-1
      NIJKP(ISIGP,2)=NIJKP(ISIGP,2)-1
      DO 505 I=1,NOSUBC
      IF (NIJKP(I,1).NE.NIJKP(I,2)) GO TO 797
  505 IF (NIJKP(I,1).LT.0) GO TO 797
C
      KDMIN=DMAX1(DABS(FLL(IRHO)-FLL(IRHOP)),DABS(FLLSIG-FLLSIGP))
      KDMAX=DMIN1(DABS(FLL(IRHO)+FLL(IRHOP)),DABS(FLLSIG+FLLSIGP))
      NKD=(KDMAX-KDMIN)/2+1
      KEMIN=DMAX1(DABS(FLL(IRHO)-FLLSIGP),DABS(FLLSIG-FLL(IRHOP)))
      NKE=NKD
      IF (IRHO.EQ.ISIG.OR.IRHOP.EQ.ISIGP) NKE=0
      IF (NKD.LE.0) GO TO 797
      IRP1MX=KDMAX-KDMIN+1
      NKTOT=NKD+NKE
      IF (NKTOT.LE.NKTOTX) GO TO 506
      WRITE (IW,51) NKTOT,NKTOTX
   51 FORMAT (///12H0*****NKTOT=,I5,29H IS GREATER THAN DIM OF CIJR=,I5,
     1  6H *****///)
      STOP '(PRK 51)'
  506 FK=KDMIN-2
      DO 507 NN=1,NKD
      FK=FK+2.D0
  507 CIJR(NN)=CIJKF(FLL(IRHO),FLL(IRHOP),FK)
     1  *CIJKF(FLLSIG,FLLSIGP,FK)
      IF (NKE.LE.0) GO TO 509
      FK=KEMIN-2
      N1=NKD+1
      DO 508 NN=N1,NKTOT
      FK=FK+2.D0
  508 CIJR(NN)=CIJKF(FLL(IRHO),FLLSIGP,FK)
     1  *CIJKF(FLL(IRHOP),FLLSIG,FK)
  509 CONTINUE
C
      DO 511 I=1,4
  511 PC(I)=IRS(I)
      CALL SORT2(4,0,PC,PC(5),IDUM,DUM,IDUM,IDUM,DUM,DUM,DUM,DUM,DUM,
     1  DUM,DUM,DUM)
      IN=PC(1)
      IX=PC(2)
      JN=PC(3)
      JX=PC(4)
C
C          DETERMINE CLASS OF CONFIGURATION INTERACTION
C
      I=1
      J=3
      IF (IRHO.LE.IRHOP) GO TO 521
      I=3
      J=1
  521 NEQP1=1
      DO 522 K=1,3
      KP1=K+1
      DO 522 L=KP1,4
  522 IF (IRS(K).EQ.IRS(L)) NEQP1=NEQP1+1
      ICLASS=0
      GO TO (526,525,524,523), NEQP1
  523 ICLASS=1
      GO TO 527
  524 ICLASS=2
      IF (IRHO.EQ.IRHOP) ICLASS=11
      IF (ICLASS.EQ.11.AND.FLLSIG.NE.FLLSIGP) ICLASS=6
      GO TO 527
  525 IF (IRS(I).EQ.IRS(I+1).AND.IRS(I).LT.IRS(J)) ICLASS=3
      IF (IRS(J).EQ.IRS(J+1).AND.IRS(J).LT.IRS(I+1)) ICLASS=4
      IF (IRS(J).EQ.IRS(J+1).AND.IRS(J).GT.IRS(I+1)) ICLASS=5
      IF (IRS(I).EQ.IRS(J)) ICLASS=6
      IF (IRS(I+1).EQ.IRS(J)) ICLASS=7
      IF (IRS(I+1).EQ.IRS(J+1)) ICLASS=8
      IF (ICLASS.EQ.8.AND.FLLSIG.NE.FLLSIGP) ICLASS=10
      GO TO 527
  526 IF (IRS(I+1).LT.IRS(J)) ICLASS=9
      IF (IRS(J).LT.IRS(I+1)) ICLASS=10
C
C          DETERMINE WHETHER CONFIGS ARE TO BE TRANSPOSED (ITRNSP=2)
C
  527 ITRNSP=1
      IF (ICLASS.EQ.2.AND.IRHO.LT.IRHOP) GO TO 530
      IF (IRHOP.EQ.ISIGP) GO TO 528
      IF (IRHO.EQ.ISIG) GO TO 530
      IF (IRHO.LT.IRHOP) GO TO 530
      IF (IRHO.EQ.IRHOP.AND.ISIG.LE.ISIGP) GO TO 530
  528 ITRNSP=2
C
C          READ U,V FROM DISK 13
C
  530 J=0
      IF (ISIG.EQ.IRHOP.OR.ISIG.EQ.ISIGP) J=ISIG
      IF (IRHO.EQ.IRHOP.OR.IRHO.EQ.ISIGP) J=IRHO
      IF (J.EQ.0) GO TO 540
      NJ=MIN0(NIJK(J,J1A,KK),NIJK(J,J1B,KK))
      NII=NJ
      NIJ=NJ
      IF (NJ.LE.1) GO TO 540
      NFULL=4.D0*FLL(J)+2.D0
      IF (NJ.EQ.NFULL) GO TO 797
      CALL LOCDSK(ID3,FLL(J),NJ)
      NOR=NORCD/2
      DO 533 K=1,NOR
  533 READ (ID3) N, ((U1(II,JJ,K),II=1,NLT), JJ=1,NLT)
      DO 534 K=1,NOR
  534 READ (ID3) N, ((V1(II,JJ,K),II=1,NLT), JJ=1,NLT)
C
C          READ CFP OR CFGP FROM DISK 12
C
  540 DO 565 I=1,NOSUBC
      NDEL(I)=IABS(NIJK(I,J1A,KK)-NIJK(I,J1B,KK))
      IF (NDEL(I).EQ.0.OR.NDEL(I).GT.2) GO TO 565
      IFL(I)=MAX0(NIJK(I,J1A,KK),NIJK(I,J1B,KK))
      IF (NDEL(I).EQ.1.AND.IFL(I).LE.2) GO TO 565
      CALL LOCDSK(ID2,FLL(I),IFL(I))
      READ (ID2) (IA,IA,IA,A,A, M=1,NLT), NLP,NLGP,NOCFP,NOCFGP
      IF (NOCFP.EQ.0) GO TO 555
      IF (IFL(I).GT.2.AND.NDEL(I).EQ.1) GO TO 545
      READ (ID2)
      GO TO 554
  545 IF (I.GT.1) GO TO 550
      READ (ID2) ((CFP1(M,N), M=1,NLT), N=1,NLP)
      GO TO 554
  550 READ (ID2) ((CFP2(M,N,I-1), M=1,NLT), N=1,NLP)
  554 READ (ID2)
  555 IF (NDEL(I).NE.2) GO TO 565
      READ (ID2)
      N=1.D0+DMIN1(FLL(IRHO)+FLLSIG, FLL(IRHOP)+FLLSIGP)
      IF (I.GT.IN) GO TO 561
      DO 560 K=1,N
  560 READ (ID2) ((CFGP1(M,L,K), M=1,NLT), L=1,NLGP)
      GO TO 565
  561 DO 562 K=1,N
  562 READ (ID2) ((CFGP2(M,L,K), M=1,NLT), L=1,NLGP)
  565 CONTINUE
C
      TC0=1.D0
      IXX=0
      DO 570 I=IRHO,ISIG
  570 IF (I.GT.IRHO) IXX=IXX+NIJK(I,J1A,KK)
      DO 571 I=IRHOP,ISIGP
  571 IF (I.GT.IRHOP) IXX=IXX+NIJK(I,J1B,KK)
      IF (IRHO.EQ.ISIG) IXX=IXX+1
      IF (IRHOP.EQ.ISIGP) IXX=IXX+1
      IXX=MOD(IXX,2)
      IF (IXX.GT.0) TC0=-TC0
      N=NIJK(IRHO,J1A,KK)
      N1=N*NIJK(ISIG,J1A,KK)
      IF (IRHO.EQ.ISIG) N1=(N1*(N-1))/N
      N=NIJK(IRHOP,J1B,KK)
      N1=N1*N*NIJK(ISIGP,J1B,KK)
      IF (IRHOP.EQ.ISIGP) N1=(N1*(N-1))/N
      IF (J.GT.0) N1=N1/(NJ*NJ)
      ERAS=N1
      TC0=TC0*DSQRT(ERAS)
      IF (IRHO.EQ.ISIG.AND.IRHOP.EQ.ISIGP) TC0=0.5D0*TC0
C
C          CALC MATRIX ELEMENTS
C
  600 LN=NTOTTJ(J1A)+1
      LX=NTOTTJ(J1A+1)
      LPN=NTOTTJ(J1B)+1
      LPX=NTOTTJ(J1B+1)
      NOPC=0
      DO 700 LP=LPN,LPX
      DO 700 L=LN,LX
      IF (PSCRL(L,NOSUBC).NE.PSCRL(LP,NOSUBC)) GO TO 700
      IF (PSCRS(L,NOSUBC).NE.PSCRS(LP,NOSUBC)) GO TO 700
      NOPC=NOPC+1
      TC=0.D0
      DO 610 I=1,NOSUBC
      IF (I.LT.IN) GO TO 605
      IF (I.LT.JX) GO TO 606
  605 IF (PSCRL(L,I).NE.PSCRL(LP,I)) GO TO 690
      IF (PSCRS(L,I).NE.PSCRS(LP,I)) GO TO 690
  606 DO 607 J=1,4
  607 IF (I.EQ.IRS(J)) GO TO 610
      IF (NALSP(L,I)-NOTSJ1(I,J1A).NE.NALSP(LP,I)-NOTSJ1(I,J1B))GOTO 690
  610 CONTINUE
C        MULT BY CFP
      TC=TC0
      DO 630 I=1,NOSUBC
      IF (NDEL(I).NE.1) GO TO 630
      IF (IFL(I).LE.2) GO TO 630
      IF (ICLASS.EQ.1.AND.I.EQ.IX) GO TO 630
      L1=L
      L2=LP
      J11=J1A
      J12=J1B
      IF (NIJK(I,J1A,KK).GT.NIJK(I,J1B,KK)) GO TO 622
      L1=LP
      L2=L
      J11=J1B
      J12=J1A
  622 N1=NALSP(L1,I)-NOTSJ1(I,J11)
      N2=NALSP(L2,I)-NOTSJ1(I,J12)
      IF (I.GT.1) GO TO 627
      TC=TC*CFP1(N1,N2)
      GO TO 630
  627 TC=TC*CFP2(N1,N2,I-1)
  630 CONTINUE
C
      IF (TC.EQ.0.D0) GO TO 690
C
      L1=L
      L2=LP
      J11=J1A
      J12=J1B
      IF (IRHO.LT.IRHOP) GO TO 635
      L1=LP
      L2=L
      J11=J1B
      J12=J1A
  635 IF (IN.EQ.1.OR.IN.EQ.IX) GO TO 640
      IF (NIJK(IN,J11,KK).LE.1) GO TO 640
      M=IN
      N1=NALSP(L1,M)
      N2=NALSP(L2,M)
      TC=TC*RECPSH(PSCRL(L1,M-1),FL(N2,M),PSCRL(L2,M),FLL(M),
     1    PSCRL(L1,M),FL(N1,M)) *RECPSH(PSCRS(L1,M-1),S(N2,M),
     2  PSCRS(L2,M),HALF,PSCRS(L1,M),S(N1,M))
      IF (TC.EQ.0.D0) GO TO 690
C
  640 MN=IN+1
      MX=IX-1
      IF (MN.GT.MX) GO TO 650
      DO 645 M=MN,MX
      N1=NALSP(L1,M)
      N2=NALSP(L2,M)
      TC=TC*RECPEX(PSCRL(L2,M-1),FLL(IN),PSCRL(L1,M-1),FL(N1,M),
     1  PSCRL(L1,M),PSCRL(L2,M)) *RECPEX(PSCRS(L2,M-1),HALF,
     2  PSCRS(L1,M-1),S(N1,M),PSCRS(L1,M),PSCRS(L2,M))
  645 CONTINUE
      IF (TC.EQ.0.D0) GO TO 690
C
  650 L1=L
      L2=LP
      J11=J1A
      J12=J1B
      FLLJX=FLLSIG
      IF (ISIG.GT.ISIGP) GO TO 655
      L1=LP
      L2=L
      J11=J1B
      J12=J1A
      FLLJX=FLLSIGP
  655 IF (JN.GE.JX) GO TO 660
      IF (NIJK(JX,J11,KK).LE.1) GO TO 660
      M=JX
      N1=NALSP(L1,M)
      N2=NALSP(L2,M)
      TC=TC*RECPJP(PSCRL(L1,M-1),FLLJX,PSCRL(L2,M-1),FL(N2,M),
     1  PSCRL(L1,M),FL(N1,M)) *RECPJP(PSCRS(L1,M-1),HALF,
     2  PSCRS(L2,M-1),S(N2,M),PSCRS(L1,M),S(N1,M))
      IF (TC.EQ.0.D0) GO TO 690
C
  660 MN=JN+1
      MX=JX-1
      IF (MN.GT.MX) GO TO 670
      FLLJX=FLLIJK(JX,J11,KK)
      DO 665 M=MN,MX
      N1=NALSP(L1,M)
      N2=NALSP(L2,M)
      TC=TC*RECPEX(PSCRL(L1,M-1),FL(N1,M),PSCRL(L1,M),FLLJX,
     1  PSCRL(L2,M),PSCRL(L2,M-1)) *RECPEX(PSCRS(L1,M-1),S(N1,M),
     2  PSCRS(L1,M),HALF,PSCRS(L2,M),PSCRS(L2,M-1))
  665 CONTINUE
  670 CONTINUE
C
  690 PC(NOPC)=TC
  700 CONTINUE
      IF (NOPC.LE.NPCX) GO TO 701
      WRITE (IW,70) NOPC,NPCX
   70 FORMAT (///11H0*****NOPC=,I5,27H IS GREATER THAN DIM OF PC=,I5,
     1  6H *****///)
      STOP '(PRK 70)'
C
  701 FLLRHO=FLL(IRHO)
      FLLRHOP=FLL(IRHOP)
      IF (ITRNSP.NE.2) GO TO 702
      ERAS=FLLRHO
      FLLRHO=FLLRHOP
      FLLRHOP=ERAS
      ERAS=FLLSIG
      FLLSIG=FLLSIGP
      FLLSIGP=ERAS
  702 IF (ICLASS.NE.7) GO TO 705
      KKK=KDMIN
      KDMIN=KEMIN
      KEMIN=KKK
      ERAS=FLLRHO
      FLLRHO=FLLSIG
      FLLSIG=ERAS
      IF (DMOD(FLL(IRHOP)-FLL(IRHO),TWO).EQ.ZERO) GO TO 705
      DO 703 NN=1,NKD
  703 CIJR(NN)=-CIJR(NN)
  705 NOPC=0
      NOCC=0
      DO 780 LP=LPN,LPX
      DO 780 L=LN,LX
      IF (PSCRL(L,NOSUBC).NE.PSCRL(LP,NOSUBC)) GO TO 780
      IF (PSCRS(L,NOSUBC).NE.PSCRS(LP,NOSUBC)) GO TO 780
      NOPC=NOPC+1
      IF (PC(NOPC).EQ.0.D0) GO TO 780
      DO 710 NN=1,NKTOT
  710 CCC(NN)=0.D0
      LCI=L
      LCIP=LP
      IF (ITRNSP.EQ.2) GO TO 722
      L1=L
      L2=LP
      J11=J1A
      J12=J1B
      GO TO 730
  722 L1=LP
      L2=L
      J11=J1B
      J12=J1A
  730 GO TO (731,732,733,734,735,736,737,738,739,740,741), ICLASS
  731 CALL CLASS1
      GO TO 750
  732 CALL CLASS2
      GO TO 750
  733 CALL CLASS3
      GO TO 750
  734 CALL CLASS4
      GO TO 750
  735 CALL CLASS5
      GO TO 750
  736 CALL CLASS6
      GO TO 750
  737 CALL CLASS7
      GO TO 750
  738 CALL CLASS8
      GO TO 750
  739 CALL CLASS9
      GO TO 750
  740 CALL CLAS10
      GO TO 750
  741 CALL CLAS11
  750 CONTINUE
C
      NOCC=NOCC+1
      IF (NOCC.LE.NCCX) GO TO 755
      WRITE (IW,75) NOCC,NCCX,J1A,J1B,IRHO,ISIG,IRHOP,ISIGP,LN,L,LX,
     1  LPN,LP,LPX
   75 FORMAT (///11H0*****NOCC=,I5,31H IS GREATER THAN DIM OF NOPCCC=,
     1  I5,6H *****,10X,2I1,I2,3I1,5X,3I5,5X,3I5///)
      STOP '(PRK 75)'
  755 NOPCCC(NOCC)=NOPC
      DO 760 NN=1,NKTOT
  760 CC(NOCC,NN)=PC(NOPC)*CIJR(NN)*CCC(NN)
  780 CONTINUE
      NOCCX=MAX0(NOCCX,NOCC)
C
      IF (ICLASS.NE.7) GO TO 781
      KKK=KDMIN
      KDMIN=KEMIN
      KEMIN=KKK
  781 DO 790 NN=1,NKTOT
      CAVE=0.D0
      IF (ICLASS.NE.11) GO TO 782
      IF (NN.LE.NKD) GO TO 782
      A=NIJK(IRHO,J1A,KK)
      CAVE=0.5D0*A*CIJR(NN)/((2.D0*FLL(IRHO)+1.D0)*(2.D0*FLLSIG+1.D0))
  782 NOPC=0
      M=1
      DO 784 LP=LPN,LPX
      DO 783 L=LN,LX
      IF (PSCRL(L,NOSUBC).NE.PSCRL(LP,NOSUBC)) GO TO 783
      IF (PSCRS(L,NOSUBC).NE.PSCRS(LP,NOSUBC)) GO TO 783
      NOPC=NOPC+1
      PC(NOPC)=0.D0
      IF (M.GT.NOCC) GO TO 783
      IF (NOPCCC(M).NE.NOPC) GO TO 783
      PC(NOPC)=CC(M,NN)
      IF ((L-LN).EQ.(LP-LPN)) PC(NOPC)=PC(NOPC)+CAVE
      M=M+1
  783 CONTINUE
  784 CONTINUE
      NPAR=NPAR+1
      IF (J1A.GT.61) THEN
        J1A1=42                    ! USE '*' SIGN FOR J1A >= 62
      ELSE
        J1A1=J1A+48
        IF (J1A.GT.9) J1A1=J1A+55  ! USE 'A'..'Z' FOR J1A=10..35
        IF (J1A.GT.35) J1A1=J1A+61 ! USE 'a'..'z' FOR J1A=36..61
      ENDIF
      IF (J1B.GT.61) THEN
        J1B1=42                    ! USE '*' SIGN FOR J1B >= 62
      ELSE
        J1B1=J1B+48
        IF (J1B.GT.9) J1B1=J1B+55  ! USE 'A'..'Z' FOR J1B=10..35
        IF (J1B.GT.35) J1B1=J1B+61 ! USE 'a'..'z' FOR J1B=36..61
      ENDIF
      IF (NN-NKD) 785,785,786
  785 K=KDMIN+2*(NN-1)
      WRITE (AA,77) J1A1,J1B1,K,IRHO,ISIG,IRHOP,ISIGP
   77 FORMAT (2A1,I1,1HD,4I1)
      GO TO 787
  786 K=KEMIN+2*(NN-NKD-1)
      WRITE (AA,78) J1A1,J1B1,K,IRHO,ISIG,IRHOP,ISIGP
   78 FORMAT (2A1,I1,1HE,4I1)
  787 PARNAM(NPAR,KK)=AA
      IF (ICPC.LE.2) GO TO 789
      WRITE (IW,80) AA,CAVE,ICLASS
   80 FORMAT (1H0,A10,5X,5HCAVE=,F12.7,15X,16HCONF INTER CLASS,I3/)
      WRITE (IW,81) (MULS1(LP),LHS1(LP),MULS4(LP),LHS4(LP),
     1  LP=LPN,LPX)
   81 FORMAT (10X,12(3X,1H(,I1,A1,1H),I2,A1)/
     1        12X,12(3X,1H(,I1,A1,1H),I2,A1)/
     2        12X,12(3X,1H(,I1,A1,1H),I2,A1)/
     3        12X,12(3X,1H(,I1,A1,1H),I2,A1))
      NT=0
      K1=1
      DO 1788 K=1,NDIFFT
      NT=NT+NTRMK(K)
      IF (NT.EQ.LN-1) K1=K+1
      IF (NT.EQ.LX) K2=K
      IF (NT.EQ.LPN-1) K1P=K+1
      IF (NT.EQ.LPX) K2P=K
 1788 CONTINUE
      NPC2=0
      L2=LN-1
      DO 4788 K=K1,K2
      LXN=NTRMK(K)
      L1=L2+1
      L2=L2+LXN
      L2P=LPN-1
      DO 2788 KP=K1P,K2P
      L2P=L2P+NTRMK(KP)
      IF (PSCRL(L2,NOSUBC).NE.PSCRL(L2P,NOSUBC)) GO TO 2788
      IF (PSCRS(L2,NOSUBC).NE.PSCRS(L2P,NOSUBC)) GO TO 2788
      GO TO 3788
 2788 CONTINUE
      GO TO 4788
 3788 NPC1=NPC2
      NPC2=NPC2+NTRMK(K)*NTRMK(KP)
      DO 788 L=L1,L2
      NPC1=NPC1+1
  788 WRITE (IW,82) MULS1(L),LHS1(L),MULS4(L),LHS4(L),
     1  (PC(I), I=NPC1,NPC2,LXN)
   82 FORMAT (2H (,I1,A1,1H),I2,A1,2X,12F10.5/(12X,12F10.5))
 4788 CONTINUE
      IF (NPC2.NE.NOPC) WRITE (IW,83) NPC2,NOPC
   83 FORMAT (///16H0*****NPC2,NOPC=,2I8,6H *****///)
  789 IF (ICPC.EQ.0) GO TO 1789
      CALL CLOCK(TIME)
      DELT=TIME-TIME0
      WRITE(IW,84) AA,NOPC,CAVE,ICLASS,DELT,(LLIJK(L,J1A,KK),
     1  NIJK(L,J1A,KK),L=1,KS), (LLIJK(L,J1B,KK),NIJK(L,J1B,KK),L=1,KS)
   84 FORMAT (/1H ,A10,4X,3HPC(,I5,1H),4X,5HCAVE=,F12.7,5X,7HICLASS=,I2,
     1  6X,5HDELT=,F6.3,4H MIN,7X, 8(A1,I2,3X)/87X,8(A1,I2,3X))
 1789 KPAR=-2
      WRITE (20) NPAR,KPAR,K,J1A,J1B,AA,CAVE,J,NOPC, (PC(I), I=1,NOPC)
  790 CONTINUE
C
  797 CONTINUE
  798 CONTINUE
      NPARJ(J1A,J1B)=NPAR-NPARJO
      NPARJO=NPAR
  799 CONTINUE
C
      WRITE (IW,86) NOCCX
   86 FORMAT (//7H0NOCCX=,I5)
      WRITE (IW,87) NPAR
   87 FORMAT (///1H0,8X,5HNPAR=,I4//9X,16HNPARJ-----------/)
      DO 890 I=1,J1X
  890 WRITE (IW,89) I, (NPARJ(I,J), J=I,J1X)
   89 FORMAT (4H J1=,I2,2X,40I3/(8X,40I3))
C
  900 CONTINUE
      RETURN
      END
      SUBROUTINE CLASS1
C
C          CALC FOR IRHO=ISIG=IRHOP.LT.ISIGP
C            OR FOR IRHOP.LT.IRHO=ISIG=ISIGP
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3/    CFP2(KLS1,KLS1,7),CIJK(10,6),
     1  U2(KLSI,KLSI,7),U3(KLSU,KLSU,9),U4(KLSU,KLSU,9),U5(KLSU,KLSU,7),
     2  U6(KLSU,KLSU,7),V2(KLSI,KLSI,7),V3(KLSI,KLSI,7),V4(KLSU,KLSU,7),
     *  V5(KLSU,KLSU,5),V6(KLSU,KLSU,5),
     3  NTI(41),IRP1MX,NALSJI(KJP),TFLN,TFLX,TFSN,TFSX,
     4  PJI(KJP),MULSI(KLSI),LBCDI(KLSI),IRHO,IRHOP,ISIG,ISIGP,FLLRHO,
     5  FLLSIG,IN,JN,JX,NII,NIJ,KI,KJ,KPI,KPJ,KDMIN,KEMIN,NKD,NKE,NKTOT,
     6  TR,TK,TC,RSUM,  J11,J12,L1,L2,TL(2,KS),TS(2,KS),
     7  TSCL(2,KS),TSCS(2,KS),NIJKP(KS,2),IRS(KS),IFL(KS),NDEL(KS),
     8    CIJR(8),CCC(8),N1,N2,N3,N4,E1,E2,E3,
     9  E4,E5,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,B1,B2,B3,B4,B5,B6,
     A  CFGP2(17,8,7),NALSJP(KJP,KS),PJ(KJP,KS)
      COMMON/CC/   U1(KLSI,KLSI,9),DUMLC1(KLC1)
      COMMON/C3LC2/CFGP1(KLSI,KLSI,7),PC(KPC),DUMLC2(KLC2)
      COMMON/C3LC3/V1(KLSI,KLSI,9),DUMLC3(KLC1)
      COMMON/C3LC4/DUMLC4(KMX**2-KISER),PCI(KISER)
      DIMENSION NPARJ(KC,KC),ISER(KISER)
      EQUIVALENCE (DUMLC4,NPARJ),(DUMLC4(KC**2+1),ISER)
      COMMON/EE/NALSP(KLSC,KS),PSCRL(KLSC,KS),PSCRS(KLSC,KS),
     1  NCFGP(KLSC),NJK(KJK,KS),NCFGJP(KJP,KS),MULS1(KLSC),MULS4(KLSC),
     2  LHS1(KLSC),LHS4(KLSC)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      DIMENSION CFP1(KLS1,KLS1)
      EQUIVALENCE (CFP1,CFGP1)
C
C
      N1=NALSP(L1,IX)
      N2=NALSP(L2,IX)
      A1=PSCRL(L1,IX-1)
      A2=PSCRL(L2,IX-1)
      A3=PSCRS(L1,IX-1)
      A4=PSCRS(L2,IX-1)
      A5=PSCRL(L1,IX)
      A6=PSCRL(L2,IX)
      A7=PSCRS(L1,IX)
      A8=PSCRS(L2,IX)
      B1=FL(N1,IX)
      B2=FL(N2,IX)
      B3=S(N1,IX)
      B4=S(N2,IX)
C
      E1=1.D0
      IF (IN.LT.IX) GO TO 130
      FLLI=FLLSIGP
      IF (IRHO.EQ.1) GO TO 141
      E1=RECPSH(A1,B2,A6,FLLI,A5,B1)*RECPSH(A3,B4,A8,HALF,A7,B3)
      GO TO 140
  130 FLLI=FLL(IN)
      E1=-RECPJP(A1,FLLI,A2,B2,A5,B1)*RECPJP(A3,HALF,A4,B4,A7,B3)
  140 IF (E1.EQ.0.D0) GO TO 900
C
  141 I=1
      J=2
      NII=MIN0(NIJK(IX,J11,KK),NIJK(IX,J12,KK))
      NIJ=1
      TL(2,1)=B2
      TS(2,1)=B4
      TSCL(2,1)=B2
      TSCS(2,1)=B4
      TL(1,2)=FLL(IX)
      TS(1,2)=0.5D0
      TL(2,2)=FLLI
      TS(2,2)=0.5D0
      TSCL(1,2)=B1
      TSCL(2,2)=B1
      TSCS(1,2)=B3
      TSCS(2,2)=B3
C
      IF (NII-1) 900,144,143
  143 NLP=NOTSJ1(IX,J12+1)-NOTSJ1(IX,J12)
      KPI=N2-NOTSJ1(IX,J12)
      GO TO 145
  144 NLP=1
      TL(1,1)=FLL(IX)
      TS(1,1)=0.5D0
      TSCL(1,1)=FLL(IX)
      TSCS(1,1)=0.5D0
      E2=E1
  145 DO 200 M=1,NLP
      IF (NII.LE.1) GO TO 152
      KI=M
      N=N1-NOTSJ1(IX,J11)
      IF (IX.GT.1) GO TO 150
      E2=E1*CFP1(N,M)
      GO TO 151
  150 E2=E1*CFP2(N,M,IX-1)
  151 IF (E2.EQ.0.D0) GO TO 200
      N=M+NOTSJ1(IX,J12)
      TL(1,1)=FL(N,IX)
      TS(1,1)=S(N,IX)
      TSCL(1,1)=FL(N,IX)
      TSCS(1,1)=S(N,IX)
  152 TK=KDMIN-2
      DO 160 NN=1,NKD
      TK=TK+2.D0
      CALL RDIJ(I,J)
      CCC(NN)=CCC(NN)+E2*A
  160 CONTINUE
  200 CONTINUE
C
  900 RETURN
      END
      SUBROUTINE CLASS2
C
C          CALC FOR IRHO=ISIG.LT.IRHOP=ISIGP
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3/    CFP2(KLS1,KLS1,7),CIJK(10,6),
     1  U2(KLSI,KLSI,7),U3(KLSU,KLSU,9),U4(KLSU,KLSU,9),U5(KLSU,KLSU,7),
     2  U6(KLSU,KLSU,7),V2(KLSI,KLSI,7),V3(KLSI,KLSI,7),V4(KLSU,KLSU,7),
     *  V5(KLSU,KLSU,5),V6(KLSU,KLSU,5),
     3  NTI(41),IRP1MX,NALSJI(KJP),TFLN,TFLX,TFSN,TFSX,
     4  PJI(KJP),MULSI(KLSI),LBCDI(KLSI),IRHO,IRHOP,ISIG,ISIGP,FLLRHO,
     5  FLLSIG,IN,JN,JX,NII,NIJ,KI,KJ,KPI,KPJ,KDMIN,KEMIN,NKD,NKE,NKTOT,
     6  TR,TK,TC,RSUM,  J11,J12,L1,L2,TL(2,KS),TS(2,KS),
     7  TSCL(2,KS),TSCS(2,KS),NIJKP(KS,2),IRS(KS),IFL(KS),NDEL(KS),
     8    CIJR(8),CCC(8),N1,N2,N3,N4,E1,E2,E3,
     9  E4,E5,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,B1,B2,B3,B4,B5,B6,
     A  CFGP2(17,8,7),NALSJP(KJP,KS),PJ(KJP,KS)
      COMMON/CC/   U1(KLSI,KLSI,9),DUMLC1(KLC1)
      COMMON/C3LC2/CFGP1(KLSI,KLSI,7),PC(KPC),DUMLC2(KLC2)
      COMMON/C3LC3/V1(KLSI,KLSI,9),DUMLC3(KLC1)
      COMMON/C3LC4/DUMLC4(KMX**2-KISER),PCI(KISER)
      DIMENSION NPARJ(KC,KC),ISER(KISER)
      EQUIVALENCE (DUMLC4,NPARJ),(DUMLC4(KC**2+1),ISER)
      COMMON/EE/NALSP(KLSC,KS),PSCRL(KLSC,KS),PSCRS(KLSC,KS),
     1  NCFGP(KLSC),NJK(KJK,KS),NCFGJP(KJP,KS),MULS1(KLSC),MULS4(KLSC),
     2  LHS1(KLSC),LHS4(KLSC)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      DIMENSION CFP1(KLS1,KLS1)
      EQUIVALENCE (CFP1,CFGP1)
C
C
      N1=NALSP(L1,JX)
      N2=NALSP(L2,JX)
      N3=NALSP(L1,IN)
      N4=NALSP(L2,IN)
      A1=PSCRL(L1,JX)
      A2=PSCRS(L1,JX)
      A3=PSCRL(L1,JX-1)
      A4=PSCRL(L2,JX-1)
      A5=PSCRS(L1,JX-1)
      A6=PSCRS(L2,JX-1)
      B1=FL(N1,JX)
      B2=FL(N2,JX)
      B3=S(N1,JX)
      B4=S(N2,JX)
      B5=FL(N3,IN)
      B6=FL(N4,IN)
      B7=S(N3,IN)
      B8=S(N4,IN)
C
      TFL=DABS(A3-A4)-1.D0
      NMIN=TFL+2.D0
      NMAX=DMIN1(2.D0*FLL(IN),2.D0*FLLSIGP,A3+A4)+1.D0
      IF (NMIN.GT.NMAX) GO TO 900
      TFSN=DABS(A5-A6)
      TFSX=A5+A6
C
      E1=DSQRT((2.D0*B2+1.D0)*(2.D0*B4+1.D0)*(2.D0*A3+1.D0)*
     1  (2.D0*A5+1.D0))
      XX=A4+A6+B2+B4+A1+A2+FLL(IN)+FLLSIGP
      IF (DMOD(XX,TWO).GT.ZERO) E1=-E1
      MN=IN+1
      MX=JX-1
      IF (MN.GT.MX) GO TO 170
      DO 150 M=MN,MX
      E1=E1*DSQRT((2.D0*PSCRL(L2,M)+1.D0)*(2.D0*PSCRS(L2,M)+1.D0)
     1  *(2.D0*PSCRL(L1,M-1)+1.D0)*(2.D0*PSCRS(L1,M-1)+1.D0))
      I=NALSP(L2,M)
      XX=FL(I,M)+S(I,M)+PSCRL(L2,M)+PSCRS(L2,M)+PSCRL(L1,M-1)
     1  +PSCRS(L1,M-1)
      IF (DMOD(XX,TWO).GT.ZERO) E1=-E1
  150 CONTINUE
  170 IF (IN.EQ.1) GO TO 200
      A7=PSCRL(L1,IN)
      A8=PSCRL(L2,IN)
      A9=PSCRS(L1,IN)
      A10=PSCRS(L2,IN)
      A11=PSCRL(L1,IN-1)
      A12=PSCRS(L1,IN-1)
      E1=E1*DSQRT((2.D0*A8+1.D0)*(2.D0*A10+1.D0)*(2.D0*B5+1.D0)*
     1  (2.D0*B7+1.D0))
      XX=A11+A12+B6+B8+A7+A9
      IF (DMOD(XX,TWO).GT.ZERO) E1=-E1
C
  200 I1=N1-NOTSJ1(JX,J11)
      I2=N2-NOTSJ1(JX,J12)
      I3=N3-NOTSJ1(IN,J11)
      I4=N4-NOTSJ1(IN,J12)
      DO 300 N=NMIN,NMAX
      TFL=TFL+1.D0
      TFS=(1+(-1)**N)/2
      IF (TFS.LT.TFSN.OR.TFS.GT.TFSX) GO TO 300
      E2=CFGP1(I3,I4,N)*CFGP2(I2,I1,N)
      IF (E2.EQ.0.D0) GO TO 300
      IF (TFS.EQ.1.D0) E2=-E2
      E2=E1*E2*S6J(B1,TFL,B2, A4,A1,A3)*S6J(B3,TFS,B4, A6,A2,A5)
      IF (MN.GT.MX) GO TO 270
      DO 250 M=MN,MX
      I=NALSP(L2,M)
      E2=E2*S6J(FL(I,M),PSCRL(L2,M-1),PSCRL(L2,M),
     1          TFL,PSCRL(L1,M),PSCRL(L1,M-1))
  250 E2=E2*S6J(S(I,M),PSCRS(L2,M-1),PSCRS(L2,M),
     1          TFS,PSCRS(L1,M),PSCRS(L1,M-1))
  270 IF (IN.EQ.1) GO TO 280
      E2=E2*S6J(A11,B6,A8, TFL,A7,B5)
      E2=E2*S6J(A12,B8,A10, TFS,A9,B7)
  280 FK=KDMIN-2
      DO 290 NN=1,NKD
      FK=FK+2.D0
  290 CCC(NN)=CCC(NN)
     1  +E2*S6J(FLL(IN),FLL(IN),TFL, FLLSIGP,FLLSIGP,FK)
  300 CONTINUE
C
  900 RETURN
      END
      SUBROUTINE CLASS3
C
C          CALC FOR IRHO=ISIG.LT.IRHOP.LT.ISIGP
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3/    CFP2(KLS1,KLS1,7),CIJK(10,6),
     1  U2(KLSI,KLSI,7),U3(KLSU,KLSU,9),U4(KLSU,KLSU,9),U5(KLSU,KLSU,7),
     2  U6(KLSU,KLSU,7),V2(KLSI,KLSI,7),V3(KLSI,KLSI,7),V4(KLSU,KLSU,7),
     *  V5(KLSU,KLSU,5),V6(KLSU,KLSU,5),
     3  NTI(41),IRP1MX,NALSJI(KJP),TFLN,TFLX,TFSN,TFSX,
     4  PJI(KJP),MULSI(KLSI),LBCDI(KLSI),IRHO,IRHOP,ISIG,ISIGP,FLLRHO,
     5  FLLSIG,IN,JN,JX,NII,NIJ,KI,KJ,KPI,KPJ,KDMIN,KEMIN,NKD,NKE,NKTOT,
     6  TR,TK,TC,RSUM,  J11,J12,L1,L2,TL(2,KS),TS(2,KS),
     7  TSCL(2,KS),TSCS(2,KS),NIJKP(KS,2),IRS(KS),IFL(KS),NDEL(KS),
     8    CIJR(8),CCC(8),N1,N2,N3,N4,E1,E2,E3,
     9  E4,E5,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,B1,B2,B3,B4,B5,B6,
     A  CFGP2(17,8,7),NALSJP(KJP,KS),PJ(KJP,KS)
      COMMON/CC/   U1(KLSI,KLSI,9),DUMLC1(KLC1)
      COMMON/C3LC2/CFGP1(KLSI,KLSI,7),PC(KPC),DUMLC2(KLC2)
      COMMON/C3LC3/V1(KLSI,KLSI,9),DUMLC3(KLC1)
      COMMON/C3LC4/DUMLC4(KMX**2-KISER),PCI(KISER)
      DIMENSION NPARJ(KC,KC),ISER(KISER)
      EQUIVALENCE (DUMLC4,NPARJ),(DUMLC4(KC**2+1),ISER)
      COMMON/EE/NALSP(KLSC,KS),PSCRL(KLSC,KS),PSCRS(KLSC,KS),
     1  NCFGP(KLSC),NJK(KJK,KS),NCFGJP(KJP,KS),MULS1(KLSC),MULS4(KLSC),
     2  LHS1(KLSC),LHS4(KLSC)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      DIMENSION CFP1(KLS1,KLS1)
      EQUIVALENCE (CFP1,CFGP1)
C
C
      I=IN
      J=JN
      N1=NALSP(L1,I)
      N2=NALSP(L2,I)
      TFLN=DMAX1(DABS(FLL(J)-FLLSIGP),DABS(FL(N1,I)-FL(N2,I)))
      TFSN=DABS(S(N1,I)-S(N2,I))
      TFLX=DMIN1(FLL(J)+FLLSIGP,2.D0*FLL(I),FL(N1,I)+FL(N2,I))
      TFSX=DMIN1(S(N1,I)+S(N2,I),ONE)
      JM1=J-1
      DO 120 M=I,JM1
      TFLN=DMAX1(DABS(PSCRL(L1,M)-PSCRL(L2,M)),TFLN)
      TFSN=DMAX1(DABS(PSCRS(L1,M)-PSCRS(L2,M)),TFSN)
      TFLX=DMIN1(PSCRL(L1,M)+PSCRL(L2,M),TFLX)
  120 TFSX=DMIN1(PSCRS(L1,M)+PSCRS(L2,M),TFSX)
      IF (TFLN.GT.TFLX) GO TO 900
      IF (TFSN.GT.TFSX) GO TO 900
C
      N3=NALSP(L1,J)
      N4=NALSP(L2,J)
      A1=PSCRL(L1,J-1)
      A2=PSCRL(L2,J-1)
      A3=PSCRS(L1,J-1)
      A4=PSCRS(L2,J-1)
      A5=PSCRL(L1,J)
      A6=PSCRL(L2,J)
      A7=PSCRS(L1,J)
      A8=PSCRS(L2,J)
      B1=FL(N3,J)
      B2=FL(N4,J)
      B3=S(N3,J)
      B4=S(N4,J)
C
      E1=DSQRT((2.D0*B2+1.D0)*(2.D0*B4+1.D0)*(2.D0*A1+1.D0)*
     1  (2.D0*A3+1.D0)*(2.D0*A6+1.D0)*(2.D0*A8+1.D0))
      XX=FLL(I)+FLL(J)+FLLSIGP+0.5D0+A1+A3-A2-A4+A5+A7-A6-A8
      IF (DMOD(XX,TWO).NE.ZERO) E1=-E1
      TFL=TFLN-1.D0
      NMIN=TFLN+1.D0
      NMAX=TFLX+1.D0
      I1=N1-NOTSJ1(I,J11)
      I2=N2-NOTSJ1(I,J12)
      DO 200 N=NMIN,NMAX
      TFL=TFL+1.D0
      TFS=(1+(-1)**N)/2
      IF (TFS.LT.TFSN.OR.TFS.GT.TFSX) GO TO 200
      E2=E1
      IF (NIJK(I,J12,KK).EQ.0) GO TO 130
      E2=E1*CFGP1(I1,I2,N)
      IF (E2.EQ.0.D0) GO TO 200
  130 IF (I.EQ.1) GO TO 140
      A9=PSCRL(L1,I-1)
      A10=PSCRS(L1,I-1)
      A11=PSCRL(L1,I)
      A12=PSCRL(L2,I)
      A13=PSCRS(L1,I)
      A14=PSCRS(L2,I)
      B5=FL(N1,I)
      B6=FL(N2,I)
      B7=S(N1,I)
      B8=S(N2,I)
      XX=A9+A10+B6+B8+A11+A13
      IF (DMOD(XX,TWO).GT.ZERO) E2=-E2
      E2=E2*DSQRT((2.D0*A12+1.D0)*(2.D0*A14+1.D0)*(2.D0*B5+1.D0)*
     1  (2.D0*B7+1.D0))
      E2=E2*S6J(A9,B6,A12, TFL,A11,B5)*S6J(A10,B8,A14, TFS,A13,B7)
  140 MN=I+1
      MX=J-1
      IF (MN.GT.MX) GO TO 160
      DO 150 M=MN,MX
      N5=NALSP(L1,M)
      A9=PSCRL(L1,M-1)
      A10=PSCRS(L1,M-1)
      A11=PSCRL(L2,M)
      A12=PSCRS(L2,M)
      B5=FL(N5,M)
      B6=S(N5,M)
      XX=B5+B6+A9+A10+A11+A12
      IF (DMOD(XX,TWO).GT.ZERO) E2=-E2
      E2=E2*DSQRT((2.D0*A9+1.D0)*(2.D0*A10+1.D0)*(2.D0*A11+1.D0)*
     1  (2.D0*A12+1.D0))
  150 E2=E2*S6J(TFL,PSCRL(L2,M-1),A9, B5,PSCRL(L1,M),A11)
     1     *S6J(TFS,PSCRS(L2,M-1),A10, B6,PSCRS(L1,M),A12)
  160 E3=E2*DSQRT((2.D0*TFL+1.D0)*(2.D0*TFS+1.D0))
      IF (TFS.EQ.1.D0) E3=-E3
      E3=E3*S9J(TFL,FLL(J),FLLSIGP, A2,B2,A6, A1,B1,A5)
     1     *S9J(TFS,HALF,HALF, A4,B4,A8, A3,B3,A7)
      FK=KDMIN-2
      DO 170 NN=1,NKD
      FK=FK+2.D0
  170 CCC(NN)=CCC(NN)+E3*S6J(FLL(I),FLL(I),TFL, FLLSIGP,FLL(J),FK)
  200 CONTINUE
C
  900 RETURN
      END
      SUBROUTINE CLASS4
C
C          CALC FOR IRHOP.LT.IRHO=ISIG.LT.ISIGP
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3/    CFP2(KLS1,KLS1,7),CIJK(10,6),
     1  U2(KLSI,KLSI,7),U3(KLSU,KLSU,9),U4(KLSU,KLSU,9),U5(KLSU,KLSU,7),
     2  U6(KLSU,KLSU,7),V2(KLSI,KLSI,7),V3(KLSI,KLSI,7),V4(KLSU,KLSU,7),
     *  V5(KLSU,KLSU,5),V6(KLSU,KLSU,5),
     3  NTI(41),IRP1MX,NALSJI(KJP),TFLN,TFLX,TFSN,TFSX,
     4  PJI(KJP),MULSI(KLSI),LBCDI(KLSI),IRHO,IRHOP,ISIG,ISIGP,FLLRHO,
     5  FLLSIG,IN,JN,JX,NII,NIJ,KI,KJ,KPI,KPJ,KDMIN,KEMIN,NKD,NKE,NKTOT,
     6  TR,TK,TC,RSUM,  J11,J12,L1,L2,TL(2,KS),TS(2,KS),
     7  TSCL(2,KS),TSCS(2,KS),NIJKP(KS,2),IRS(KS),IFL(KS),NDEL(KS),
     8    CIJR(8),CCC(8),N1,N2,N3,N4,E1,E2,E3,
     9  E4,E5,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,B1,B2,B3,B4,B5,B6,
     A  CFGP2(17,8,7),NALSJP(KJP,KS),PJ(KJP,KS)
      COMMON/CC/   U1(KLSI,KLSI,9),DUMLC1(KLC1)
      COMMON/C3LC2/CFGP1(KLSI,KLSI,7),PC(KPC),DUMLC2(KLC2)
      COMMON/C3LC3/V1(KLSI,KLSI,9),DUMLC3(KLC1)
      COMMON/C3LC4/DUMLC4(KMX**2-KISER),PCI(KISER)
      DIMENSION NPARJ(KC,KC),ISER(KISER)
      EQUIVALENCE (DUMLC4,NPARJ),(DUMLC4(KC**2+1),ISER)
      COMMON/EE/NALSP(KLSC,KS),PSCRL(KLSC,KS),PSCRS(KLSC,KS),
     1  NCFGP(KLSC),NJK(KJK,KS),NCFGJP(KJP,KS),MULS1(KLSC),MULS4(KLSC),
     2  LHS1(KLSC),LHS4(KLSC)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      DIMENSION CFP1(KLS1,KLS1)
      EQUIVALENCE (CFP1,CFGP1)
C
C
  110 M=JN
      N1=NALSP(L1,M)
      N2=NALSP(L2,M)
      A1=PSCRL(L1,M-1)
      A2=PSCRL(L2,M-1)
      A3=PSCRS(L1,M-1)
      A4=PSCRS(L2,M-1)
      A5=PSCRL(L1,M)
      A6=PSCRL(L2,M)
      A7=PSCRS(L1,M)
      A8=PSCRS(L2,M)
      B1=FL(N1,M)
      B2=FL(N2,M)
      B3=S(N1,M)
      B4=S(N2,M)
      IF (DABS(A1-A2).GT.FLL(IN)) GO TO 900
      IF (DABS(A5-A6).GT.FLLSIGP) GO TO 900
      IF (A1+A2.LT.FLL(IN)) GO TO 900
      IF (A5+A6.LT.FLLSIGP) GO TO 900
      IF (DABS(A3-A4).GT.0.5D0) GO TO 900
      IF (DABS(A7-A8).GT.0.5D0) GO TO 900
C
      E1=DSQRT((2.D0*B1+1.D0)*(2.D0*B3+1.D0)*(2.D0*A2+1.D0)*
     1  (2.D0*A4+1.D0)*(2.D0*A6+1.D0)*(2.D0*A8+1.D0))
      E2=FLL(IN)+FLLSIGP
      FXX=DMOD(E2+FLL(M)+THRHAL+A2+A4+A1-A3,TWO)
      IF (FXX.NE.0.D0) E1=-E1
C
      TFL=DMAX1(DABS(FLL(IN)-FLLSIGP),DABS(B1-B2))-1.D0
      NMIN=TFL+2.D0
      NMAX=DMIN1(2.D0*FLL(M),E2,B1+B2)+1.D0
      IF (NMIN.GT.NMAX) GO TO 900
      TFSX=B3+B4
      I1=N1-NOTSJ1(M,J11)
      I2=N2-NOTSJ1(M,J12)
      DO 200 N=NMIN,NMAX
      TFL=TFL+1.D0
      E2=CFGP2(I1,I2,N)
      IF (E2.EQ.0.D0) GO TO 200
      TFS=(1+(-1)**N)/2
      IF (TFS.GT.TFSX) GO TO 200
      IF (TFS.EQ.1.D0) E2=-E2
      E2=E1*E2*DSQRT((2.D0*TFL+1.D0)*(2.D0*TFS+1.D0))
      E2=E2*S9J(A1,FLL(IN),A2, A5,FLLSIGP,A6, B1,TFL,B2)
      E2=E2*S9J(A3,HALF,A4, A7,HALF,A8, B3,TFS,B4)
      FK=KDMIN-2
      DO 150 NN=1,NKD
      FK=FK+2.D0
  150 CCC(NN)=CCC(NN)
     1  +E2*S6J(FLL(M),FLL(M),TFL, FLL(IN),FLLSIGP,FK)
  200 CONTINUE
C
  900 RETURN
      END
      SUBROUTINE CLASS5
C
C          CALC FOR IRHOP.LT.ISIGP.LT.IRHO=ISIG
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3/    CFP2(KLS1,KLS1,7),CIJK(10,6),
     1  U2(KLSI,KLSI,7),U3(KLSU,KLSU,9),U4(KLSU,KLSU,9),U5(KLSU,KLSU,7),
     2  U6(KLSU,KLSU,7),V2(KLSI,KLSI,7),V3(KLSI,KLSI,7),V4(KLSU,KLSU,7),
     *  V5(KLSU,KLSU,5),V6(KLSU,KLSU,5),
     3  NTI(41),IRP1MX,NALSJI(KJP),TFLN,TFLX,TFSN,TFSX,
     4  PJI(KJP),MULSI(KLSI),LBCDI(KLSI),IRHO,IRHOP,ISIG,ISIGP,FLLRHO,
     5  FLLSIG,IN,JN,JX,NII,NIJ,KI,KJ,KPI,KPJ,KDMIN,KEMIN,NKD,NKE,NKTOT,
     6  TR,TK,TC,RSUM,  J11,J12,L1,L2,TL(2,KS),TS(2,KS),
     7  TSCL(2,KS),TSCS(2,KS),NIJKP(KS,2),IRS(KS),IFL(KS),NDEL(KS),
     8    CIJR(8),CCC(8),N1,N2,N3,N4,E1,E2,E3,
     9  E4,E5,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,B1,B2,B3,B4,B5,B6,
     A  CFGP2(17,8,7),NALSJP(KJP,KS),PJ(KJP,KS)
      COMMON/CC/   U1(KLSI,KLSI,9),DUMLC1(KLC1)
      COMMON/C3LC2/CFGP1(KLSI,KLSI,7),PC(KPC),DUMLC2(KLC2)
      COMMON/C3LC3/V1(KLSI,KLSI,9),DUMLC3(KLC1)
      COMMON/C3LC4/DUMLC4(KMX**2-KISER),PCI(KISER)
      DIMENSION NPARJ(KC,KC),ISER(KISER)
      EQUIVALENCE (DUMLC4,NPARJ),(DUMLC4(KC**2+1),ISER)
      COMMON/EE/NALSP(KLSC,KS),PSCRL(KLSC,KS),PSCRS(KLSC,KS),
     1  NCFGP(KLSC),NJK(KJK,KS),NCFGJP(KJP,KS),MULS1(KLSC),MULS4(KLSC),
     2  LHS1(KLSC),LHS4(KLSC)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      DIMENSION CFP1(KLS1,KLS1)
      EQUIVALENCE (CFP1,CFGP1)
C
C
      I=IX
      J=JX
      N1=NALSP(L1,J)
      N2=NALSP(L2,J)
      B1=FL(N1,J)
      B2=FL(N2,J)
      B3=S(N1,J)
      B4=S(N2,J)
      TFLN=DMAX1(DABS(FLL(I)-FLL(IN)),DABS(B1-B2))
      TFSN=DABS(B3-B4)
      TFLX=DMIN1(FLL(I)+FLL(IN),2.D0*FLLSIG,B1+B2)
      TFSX=DMIN1(B3+B4,ONE)
      DO 120 M=I,J
      A1=PSCRL(L1,M)
      A2=PSCRL(L2,M)
      A3=PSCRS(L1,M)
      A4=PSCRS(L2,M)
      IF (M.EQ.J) GO TO 120
      TFLN=DMAX1(DABS(A1-A2),TFLN)
      TFSN=DMAX1(DABS(A3-A4),TFSN)
      TFLX=DMIN1(A1+A2,TFLX)
      TFSX=DMIN1(A3+A4,TFSX)
  120 CONTINUE
      IF (TFLN.GT.TFLX) GO TO 900
      IF (TFSN.GT.TFSX) GO TO 900
C
      N3=NALSP(L1,I)
      N4=NALSP(L2,I)
      A5=PSCRL(L1,J-1)
      A6=PSCRL(L2,J-1)
      A7=PSCRS(L1,J-1)
      A8=PSCRS(L2,J-1)
      A9=PSCRL(L1,I-1)
      A10=PSCRL(L2,I-1)
      A11=PSCRS(L1,I-1)
      A12=PSCRS(L2,I-1)
      A13=PSCRL(L1,I)
      A14=PSCRL(L2,I)
      A15=PSCRS(L1,I)
      A16=PSCRS(L2,I)
      B5=FL(N3,I)
      B6=FL(N4,I)
      B7=S(N3,I)
      B8=S(N4,I)
C
      E1=DSQRT((2.D0*B6 +1.D0)*(2.D0*B8 +1.D0)*(2.D0*A10+1.D0)*
     1         (2.D0*A12+1.D0)*(2.D0*A13+1.D0)*(2.D0*A15+1.D0)*
     2         (2.D0*B1 +1.D0)*(2.D0*B3 +1.D0)*(2.D0*A6 +1.D0)*
     3         (2.D0*A8 +1.D0))
      XX=FLL(IN)+FLLSIG+A5+A7+B1+B3+A1+A3
      IF (DMOD(XX,TWO).GT.ZERO) E1=-E1
      TFL=TFLN-1.D0
      NMIN=TFLN+1.D0
      NMAX=TFLX+1.D0
      I1=N1-NOTSJ1(J,J11)
      I2=N2-NOTSJ1(J,J12)
      DO 200 N=NMIN,NMAX
      TFL=TFL+1.D0
      TFS=DFLOAT((1+(-1)**N)/2)
      IF (TFS.LT.TFSN.OR.TFS.GT.TFSX) GO TO 200
      E2=E1
      IF (NIJK(J,J12,KK).EQ.0) GO TO 130
      E2=E1*CFGP2(I1,I2,N)
      IF (E2.EQ.0.D0) GO TO 200
  130 E3=E2*S6J(B2,TFL,B1, A5,A1,A6)*S6J(B4,TFS,B3, A7,A3,A8)
      MN=I+1
      MX=J-1
      IF (MN.GT.MX) GO TO 160
      DO 150 M=MN,MX
      N5=NALSP(L1,M)
      A17=PSCRL(L2,M-1)
      A18=PSCRS(L2,M-1)
      A19=PSCRL(L1,M)
      A20=PSCRL(L2,M)
      A21=PSCRS(L1,M)
      A22=PSCRS(L2,M)
      B9=FL(N5,M)
      B10=S(N5,M)
      XX=B9+B10+A19+A21+A17+A18
      IF (DMOD(XX,TWO).GT.ZERO) E3=-E3
      E3=E3*DSQRT((2.D0*A19+1.D0)*(2.D0*A21+1.D0)*(2.D0*A17+1.D0)
     1  *(2.D0*A18+1.D0))
  150 E3=E3*S6J(B9,PSCRL(L1,M-1),A19, TFL,A20,A17)
     1    *S6J(B10,PSCRS(L1,M-1),A21, TFS,A22,A18)
  160 E4=E3*DSQRT((2.D0*TFL+1.D0)*(2.D0*TFS+1.D0))
      IF (TFS.EQ.1.D0) E4=-E4
      E4=E4*S9J(A9,FLL(IN),A10, B5,FLL(I),B6, A13,TFL,A14)
     1     *S9J(A11,HALF,A12, B7,HALF,B8, A15,TFS,A16)
      FK=KDMIN-2
      DO 170 NN=1,NKD
      FK=FK+2.D0
  170 CCC(NN)=CCC(NN)+E4*S6J(FLLSIG,FLLSIG,TFL, FLL(I),FLL(IN),FK)
  200 CONTINUE
C
  900 RETURN
      END
      SUBROUTINE CLASS6
C
C          CALC FOR IRHO=IRHOP.LT.ISIG.LT.ISIGP
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3/    CFP2(KLS1,KLS1,7),CIJK(10,6),
     1  U2(KLSI,KLSI,7),U3(KLSU,KLSU,9),U4(KLSU,KLSU,9),U5(KLSU,KLSU,7),
     2  U6(KLSU,KLSU,7),V2(KLSI,KLSI,7),V3(KLSI,KLSI,7),V4(KLSU,KLSU,7),
     *  V5(KLSU,KLSU,5),V6(KLSU,KLSU,5),
     3  NTI(41),IRP1MX,NALSJI(KJP),TFLN,TFLX,TFSN,TFSX,
     4  PJI(KJP),MULSI(KLSI),LBCDI(KLSI),IRHO,IRHOP,ISIG,ISIGP,FLLRHO,
     5  FLLSIG,IN,JN,JX,NII,NIJ,KI,KJ,KPI,KPJ,KDMIN,KEMIN,NKD,NKE,NKTOT,
     6  TR,TK,TC,RSUM,  J11,J12,L1,L2,TL(2,KS),TS(2,KS),
     7  TSCL(2,KS),TSCS(2,KS),NIJKP(KS,2),IRS(KS),IFL(KS),NDEL(KS),
     8    CIJR(8),CCC(8),N1,N2,N3,N4,E1,E2,E3,
     9  E4,E5,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,B1,B2,B3,B4,B5,B6,
     A  CFGP2(17,8,7),NALSJP(KJP,KS),PJ(KJP,KS)
      COMMON/CC/   U1(KLSI,KLSI,9),DUMLC1(KLC1)
      COMMON/C3LC2/CFGP1(KLSI,KLSI,7),PC(KPC),DUMLC2(KLC2)
      COMMON/C3LC3/V1(KLSI,KLSI,9),DUMLC3(KLC1)
      COMMON/C3LC4/DUMLC4(KMX**2-KISER),PCI(KISER)
      DIMENSION NPARJ(KC,KC),ISER(KISER)
      EQUIVALENCE (DUMLC4,NPARJ),(DUMLC4(KC**2+1),ISER)
      COMMON/EE/NALSP(KLSC,KS),PSCRL(KLSC,KS),PSCRS(KLSC,KS),
     1  NCFGP(KLSC),NJK(KJK,KS),NCFGJP(KJP,KS),MULS1(KLSC),MULS4(KLSC),
     2  LHS1(KLSC),LHS4(KLSC)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      DIMENSION CFP1(KLS1,KLS1)
      EQUIVALENCE (CFP1,CFGP1)
C
  110 M=JN
      N1=NALSP(L1,M)
      N2=NALSP(L2,M)
      A1=PSCRL(L1,M-1)
      A2=PSCRL(L2,M-1)
      A3=PSCRS(L1,M-1)
      A4=PSCRS(L2,M-1)
      A5=PSCRL(L1,M)
      A6=PSCRL(L2,M)
      A7=PSCRS(L1,M)
      A8=PSCRS(L2,M)
      B1=FL(N1,M)
      B2=FL(N2,M)
      B3=S(N1,M)
      B4=S(N2,M)
      IF (JN.LT.NOSUBC.OR.JX.LT.NOSUBC) GO TO 115
      A6=A2
      A8=A4
      B1=FLLSIG
      B2=0.D0
      B3=0.5D0
      B4=0.D0
  115 TFL=DMAX1(DABS(A1-FLLSIG), DABS(A2-FLLSIGP), DABS(B2-A5))-1.D0
      NFL=DMIN1(A1+FLLSIG, A2+FLLSIGP, B2+A5)-TFL
      IF (NFL.LE.0) GO TO 300
      TFS=DMAX1(DABS(A3-0.5D0), DABS(A4-0.5D0), DABS(B4-A7))-1.D0
      NFS=DMIN1(A3+0.5D0, A4+0.5D0, B4+A7)-TFS
      TFSN=TFS
      IF (NFS.LE.0) GO TO 300
      XX=A1+B1+A5+B2+FLLSIGP+A6+A3+B3+A7+B4+0.5D0+A8
      E1=DSQRT((2.D0*B1+1.D0)*(2.D0*A6+1.D0)*(2.D0*B3+1.D0)*
     1  (2.D0*A8+1.D0))
C
      DO 200 NL=1,NFL
      TFL=TFL+1.D0
      E2=E1*(2.D0*TFL+1.D0)*S6J(B2,FLLSIG,B1, A1,A5,TFL)
     1  *S6J(B2,A2,A6, FLLSIGP,A5,TFL)
      TFS=TFSN
      DO 200 NS=1,NFS
      TFS=TFS+1.D0
      E3=E2*(2.D0*TFS+1.D0)*S6J(B4,HALF,B3, A3,A7,TFS)
     1  *S6J(B4,A4,A8, HALF,A7,TFS)
      IF (DMOD(XX+TFL+TFS,TWO).GT.ZERO) E3=-E3
      DO 130 III=1,2
      L3=L1
      IF (III.EQ.2) L3=L2
      MM1=M-1
      DO 130 IP=1,MM1
      II=NALSP(L3,IP)
      TL(III,IP)=FL(II,IP)
      TS(III,IP)=S(II,IP)
      TSCL(III,IP)=PSCRL(L3,IP)
  130 TSCS(III,IP)=PSCRS(L3,IP)
      TL(1,M)=FLLSIG
      TS(1,M)=0.5D0
      TL(2,M)=FLLSIGP
      TS(2,M)=0.5D0
      TSCL(1,M)=TFL
      TSCS(1,M)=TFS
      TSCL(2,M)=TFL
      TSCS(2,M)=TFS
      I=IRHO
      J=M
      NIJ=1
      KI=NALSP(L1,I)-NOTSJ1(I,J11)
      KPI=NALSP(L2,I)-NOTSJ1(I,J12)
      TK=KDMIN-2
      DO 150 NN=1,NKD
      TK=TK+2.D0
      CALL RDIJ(I,J)
      CCC(NN)=CCC(NN)+E3*A
  150 CONTINUE
      N1=NKD+1
      TK=KEMIN-2
      DO 160 NN=N1,NKTOT
      TK=TK+2.D0
      CALL REIJ(I,J)
      CCC(NN)=CCC(NN)+E3*RSUM
  160 CONTINUE
  200 CONTINUE
C
  300 CONTINUE
      RETURN
      END
      SUBROUTINE CLASS7
C
C          CALC FOR IRHO.LT.ISIG=IRHOP.LT.ISIGP
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3/    CFP2(KLS1,KLS1,7),CIJK(10,6),
     1  U2(KLSI,KLSI,7),U3(KLSU,KLSU,9),U4(KLSU,KLSU,9),U5(KLSU,KLSU,7),
     2  U6(KLSU,KLSU,7),V2(KLSI,KLSI,7),V3(KLSI,KLSI,7),V4(KLSU,KLSU,7),
     *  V5(KLSU,KLSU,5),V6(KLSU,KLSU,5),
     3  NTI(41),IRP1MX,NALSJI(KJP),TFLN,TFLX,TFSN,TFSX,
     4  PJI(KJP),MULSI(KLSI),LBCDI(KLSI),IRHO,IRHOP,ISIG,ISIGP,FLLRHO,
     5  FLLSIG,IN,JN,JX,NII,NIJ,KI,KJ,KPI,KPJ,KDMIN,KEMIN,NKD,NKE,NKTOT,
     6  TR,TK,TC,RSUM,  J11,J12,L1,L2,TL(2,KS),TS(2,KS),
     7  TSCL(2,KS),TSCS(2,KS),NIJKP(KS,2),IRS(KS),IFL(KS),NDEL(KS),
     8    CIJR(8),CCC(8),N1,N2,N3,N4,E1,E2,E3,
     9  E4,E5,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,B1,B2,B3,B4,B5,B6,
     A  CFGP2(17,8,7),NALSJP(KJP,KS),PJ(KJP,KS)
      COMMON/CC/   U1(KLSI,KLSI,9),DUMLC1(KLC1)
      COMMON/C3LC2/CFGP1(KLSI,KLSI,7),PC(KPC),DUMLC2(KLC2)
      COMMON/C3LC3/V1(KLSI,KLSI,9),DUMLC3(KLC1)
      COMMON/C3LC4/DUMLC4(KMX**2-KISER),PCI(KISER)
      DIMENSION NPARJ(KC,KC),ISER(KISER)
      EQUIVALENCE (DUMLC4,NPARJ),(DUMLC4(KC**2+1),ISER)
      COMMON/EE/NALSP(KLSC,KS),PSCRL(KLSC,KS),PSCRS(KLSC,KS),
     1  NCFGP(KLSC),NJK(KJK,KS),NCFGJP(KJP,KS),MULS1(KLSC),MULS4(KLSC),
     2  LHS1(KLSC),LHS4(KLSC)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      DIMENSION CFP1(KLS1,KLS1)
      EQUIVALENCE (CFP1,CFGP1)
C
C
      I=IX
      N1=NALSP(L1,I)
      A1=PSCRL(L1,I-1)
      A2=PSCRL(L2,I-1)
      A3=PSCRS(L1,I-1)
      A4=PSCRS(L2,I-1)
      A5=PSCRL(L1,I)
      A6=PSCRL(L2,I)
      A7=PSCRS(L1,I)
      A8=PSCRS(L2,I)
      B1=FL(N1,I)
      B2=S(N1,I)
      TFLN=DMAX1(DABS(FLL(IN)-A5),DABS(B1-A2))
      TFSN=DMAX1(DABS(0.5D0-A7),DABS(B2-A4))
      TFLX=DMIN1(FLL(IN)+A5,B1+A2)
      TFSX=DMIN1(0.5D0+A7,B2+A4)
      IF (TFLN.GT.TFLX) GO TO 900
      IF (TFSN.GT.TFSX) GO TO 900
C
      J=I+1
      NIJ=1
      N2=NALSP(L2,I)
      KI=N1-NOTSJ1(I,J11)
      KPI=N2-NOTSJ1(I,J12)
      TL(1,I)=B1
      TL(2,I)=FL(N2,I)
      TS(1,I)=B2
      TS(2,I)=S(N2,I)
      TL(1,J)=FLL(IN)
      TL(2,J)=FLLSIGP
      TS(1,J)=0.5D0
      TS(2,J)=0.5D0
      TSCL(1,I-1)=A2
      TSCL(2,I-1)=A2
      TSCS(1,I-1)=A4
      TSCS(2,I-1)=A4
      TSCL(2,I)=A6
      TSCS(2,I)=A8
      TSCL(1,J)=A5
      TSCL(2,J)=A5
      TSCS(1,J)=A7
      TSCS(2,J)=A7
C
      E1=DSQRT((2.D0*A1+1.D0)*(2.D0*A3+1.D0))
      XX1=FLL(IN)+0.5D0+B1+B2+A1+A3
      TFL=TFLN-1.D0
      NLX=TFLX-TFL
      NSX=TFSX-TFSN+1.D0
      DO 200 NL=1,NLX
      TFL=TFL+1.D0
      TSCL(1,I)=TFL
      E2=E1*S6J(FLL(IN),A2,A1, B1,A5,TFL)
      TFS=TFSN-1.D0
      DO 200 NS=1,NSX
      TFS=TFS+1.D0
      TSCS(1,I)=TFS
      E3=E2*DSQRT((2.D0*TFL+1.D0)*(2.D0*TFS+1.D0))
     1  *S6J(HALF,A4,A3, B2,A7,TFS)
      IF (DMOD(XX1+TFL+TFS,TWO).GT.ZERO) E3=-E3
      TK=KEMIN-2
      DO 150 NN=1,NKD
      TK=TK+2.D0
      CALL REIJ(I,J)
      CCC(NN)=CCC(NN)-E3*RSUM
  150 CONTINUE
      N1=NKD+1
      TK=KDMIN-2
      DO 160 NN=N1,NKTOT
      TK=TK+2.D0
      CALL RDIJ(I,J)
      CCC(NN)=CCC(NN)-E3*A
  160 CONTINUE
  200 CONTINUE
C
  900 RETURN
      END
      SUBROUTINE CLASS8
C
C          CALC FOR IRHO.LT.IRHOP.LT.ISIG=ISIGP
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3/    CFP2(KLS1,KLS1,7),CIJK(10,6),
     1  U2(KLSI,KLSI,7),U3(KLSU,KLSU,9),U4(KLSU,KLSU,9),U5(KLSU,KLSU,7),
     2  U6(KLSU,KLSU,7),V2(KLSI,KLSI,7),V3(KLSI,KLSI,7),V4(KLSU,KLSU,7),
     *  V5(KLSU,KLSU,5),V6(KLSU,KLSU,5),
     3  NTI(41),IRP1MX,NALSJI(KJP),TFLN,TFLX,TFSN,TFSX,
     4  PJI(KJP),MULSI(KLSI),LBCDI(KLSI),IRHO,IRHOP,ISIG,ISIGP,FLLRHO,
     5  FLLSIG,IN,JN,JX,NII,NIJ,KI,KJ,KPI,KPJ,KDMIN,KEMIN,NKD,NKE,NKTOT,
     6  TR,TK,TC,RSUM,  J11,J12,L1,L2,TL(2,KS),TS(2,KS),
     7  TSCL(2,KS),TSCS(2,KS),NIJKP(KS,2),IRS(KS),IFL(KS),NDEL(KS),
     8    CIJR(8),CCC(8),N1,N2,N3,N4,E1,E2,E3,
     9  E4,E5,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,B1,B2,B3,B4,B5,B6,
     A  CFGP2(17,8,7),NALSJP(KJP,KS),PJ(KJP,KS)
      COMMON/CC/   U1(KLSI,KLSI,9),DUMLC1(KLC1)
      COMMON/C3LC2/CFGP1(KLSI,KLSI,7),PC(KPC),DUMLC2(KLC2)
      COMMON/C3LC3/V1(KLSI,KLSI,9),DUMLC3(KLC1)
      COMMON/C3LC4/DUMLC4(KMX**2-KISER),PCI(KISER)
      DIMENSION NPARJ(KC,KC),ISER(KISER)
      EQUIVALENCE (DUMLC4,NPARJ),(DUMLC4(KC**2+1),ISER)
      COMMON/EE/NALSP(KLSC,KS),PSCRL(KLSC,KS),PSCRS(KLSC,KS),
     1  NCFGP(KLSC),NJK(KJK,KS),NCFGJP(KJP,KS),MULS1(KLSC),MULS4(KLSC),
     2  LHS1(KLSC),LHS4(KLSC)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      DIMENSION CFP1(KLS1,KLS1)
      EQUIVALENCE (CFP1,CFGP1)
C
C
      I=IX
      J=JX
      N1=NALSP(L1,I)
      N2=NALSP(L2,I)
      A1=PSCRL(L1,I-1)
      A2=PSCRL(L2,I-1)
      A3=PSCRS(L1,I-1)
      A4=PSCRS(L2,I-1)
      A5=PSCRL(L1,I)
      A6=PSCRL(L2,I)
      A7=PSCRS(L1,I)
      A8=PSCRS(L2,I)
      B1=FL(N1,I)
      B2=FL(N2,I)
      B3=S(N1,I)
      B4=S(N2,I)
      TFLN=DMAX1(DABS(FLL(IN)-A5),DABS(A2-B1),DABS(FLL(I)-A6))
      TFSN=DMAX1(DABS(0.5D0-A7),DABS(A4-B3),DABS(0.5D0-A8))
      TFLX=DMIN1(FLL(IN)+A5,A2+B1,FLL(I)+A6)
      TFSX=DMIN1(0.5D0+A7,A4+B3,0.5D0+A8)
      IF (TFLN.GT.TFLX) GO TO 900
      IF (TFSN.GT.TFSX) GO TO 900
C
      NII=1
      KJ=NALSP(L1,J)-NOTSJ1(J,J11)
      KPJ=NALSP(L2,J)-NOTSJ1(J,J12)
      DO 120 III=1,2
      L3=L1
      IF (III.EQ.2) L3=L2
      DO 120 IP=I,J
      II=NALSP(L3,IP)
      TL(III,IP)=FL(II,IP)
      TS(III,IP)=S(II,IP)
      TSCL(III,IP)=PSCRL(L3,IP)
  120 TSCS(III,IP)=PSCRS(L3,IP)
      TL(1,I)=FLL(IN)
      TL(2,I)=FLL(I)
      TS(1,I)=0.5D0
      TS(2,I)=0.5D0
C
      E1=DSQRT((2.D0*A1+1.D0)*(2.D0*A3+1.D0)*(2.D0*B2+1.D0)*
     1  (2.D0*B4+1.D0))
      XX1=FLL(I)-FLL(IN)+A2+A4-A1-A3+A6+A8
      TFL=TFLN-1.D0
      NLX=TFLX-TFL
      NSX=TFSX-TFSN+1.D0
      DO 200 NL=1,NLX
      TFL=TFL+1.D0
      TSCL(1,I-1)=TFL
      TSCL(2,I-1)=TFL
      E2=E1*(2.D0*TFL+1.D0)*S6J(FLL(IN),A2,A1, B1,A5,TFL)
     1  *S6J(A2,B1,TFL, FLL(I),A6,B2)
      TFS=TFSN-1.D0
      DO 200 NS=1,NSX
      TFS=TFS+1.D0
      TSCS(1,I-1)=TFS
      TSCS(2,I-1)=TFS
      E3=E2*(2.D0*TFS+1.D0)*S6J(HALF,A4,A3, B3,A7,TFS)
     1  *S6J(A4,B3,TFS, HALF,A8,B4)
      IF (DMOD(XX1-TFL-TFS,TWO).NE.ZERO) E3=-E3
      TK=KDMIN-2
      DO 150 NN=1,NKD
      TK=TK+2.D0
      CALL RDIJ(I,J)
      CCC(NN)=CCC(NN)+E3*A
  150 CONTINUE
      N1=NKD+1
      TK=KEMIN-2
      DO 160 NN=N1,NKTOT
      TK=TK+2.D0
      CALL REIJ(I,J)
      CCC(NN)=CCC(NN)+E3*RSUM
  160 CONTINUE
  200 CONTINUE
C
  900 RETURN
      END
      SUBROUTINE CLASS9
C
C          CALC FOR IRHO.LT.ISIG.LT.IRHOP.LT.ISIGP
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3/    CFP2(KLS1,KLS1,7),CIJK(10,6),
     1  U2(KLSI,KLSI,7),U3(KLSU,KLSU,9),U4(KLSU,KLSU,9),U5(KLSU,KLSU,7),
     2  U6(KLSU,KLSU,7),V2(KLSI,KLSI,7),V3(KLSI,KLSI,7),V4(KLSU,KLSU,7),
     *  V5(KLSU,KLSU,5),V6(KLSU,KLSU,5),
     3  NTI(41),IRP1MX,NALSJI(KJP),TFLN,TFLX,TFSN,TFSX,
     4  PJI(KJP),MULSI(KLSI),LBCDI(KLSI),IRHO,IRHOP,ISIG,ISIGP,FLLRHO,
     5  FLLSIG,IN,JN,JX,NII,NIJ,KI,KJ,KPI,KPJ,KDMIN,KEMIN,NKD,NKE,NKTOT,
     6  TR,TK,TC,RSUM,  J11,J12,L1,L2,TL(2,KS),TS(2,KS),
     7  TSCL(2,KS),TSCS(2,KS),NIJKP(KS,2),IRS(KS),IFL(KS),NDEL(KS),
     8    CIJR(8),CCC(8),N1,N2,N3,N4,E1,E2,E3,
     9  E4,E5,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,B1,B2,B3,B4,B5,B6,
     A  CFGP2(17,8,7),NALSJP(KJP,KS),PJ(KJP,KS)
      COMMON/CC/   U1(KLSI,KLSI,9),DUMLC1(KLC1)
      COMMON/C3LC2/CFGP1(KLSI,KLSI,7),PC(KPC),DUMLC2(KLC2)
      COMMON/C3LC3/V1(KLSI,KLSI,9),DUMLC3(KLC1)
      COMMON/C3LC4/DUMLC4(KMX**2-KISER),PCI(KISER)
      DIMENSION NPARJ(KC,KC),ISER(KISER)
      EQUIVALENCE (DUMLC4,NPARJ),(DUMLC4(KC**2+1),ISER)
      COMMON/EE/NALSP(KLSC,KS),PSCRL(KLSC,KS),PSCRS(KLSC,KS),
     1  NCFGP(KLSC),NJK(KJK,KS),NCFGJP(KJP,KS),MULS1(KLSC),MULS4(KLSC),
     2  LHS1(KLSC),LHS4(KLSC)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      DIMENSION CFP1(KLS1,KLS1)
      EQUIVALENCE (CFP1,CFGP1)
C
C
      A1=PSCRL(L1,IX-1)
      A2=PSCRL(L2,IX-1)
      A3=PSCRS(L1,IX-1)
      A4=PSCRS(L2,IX-1)
      A5=PSCRL(L1,IX)
      A6=PSCRL(L2,IX)
      A7=PSCRS(L1,IX)
      A8=PSCRS(L2,IX)
      A9=PSCRL(L1,JN-1)
      A10=PSCRL(L2,JN-1)
      A11=PSCRS(L1,JN-1)
      A12=PSCRS(L2,JN-1)
      A13=PSCRL(L1,JN)
      A14=PSCRL(L2,JN)
      A15=PSCRS(L1,JN)
      A16=PSCRS(L2,JN)
      TFLN=DMAX1(DABS(FLL(IN)-FLL(IX)),DABS(FLL(JN)-FLLSIGP),
     1  DABS(A5-A6),DABS(A9-A10))
      TFLX=DMIN1(FLL(IN)+FLL(IX),FLL(JN)+FLLSIGP,A5+A6,A9+A10)
      IF (TFLN.GT.TFLX) GO TO 900
      TFSN=DMAX1(DABS(A7-A8),DABS(A11-A12))
      TFSX=DMIN1(ONE,A7+A8,A11+A12)
      IF (TFSN.GT.TFSX) GO TO 900
      N1=NALSP(L1,IX)
      N2=NALSP(L2,IX)
      N3=NALSP(L1,JN)
      N4=NALSP(L2,JN)
      B1=FL(N1,IX)
      B2=FL(N2,IX)
      B3=S(N1,IX)
      B4=S(N2,IX)
      B5=FL(N3,JN)
      B6=FL(N4,JN)
      B7=S(N3,JN)
      B8=S(N4,JN)
      E6=(2.D0*A1+1.D0)*(2.D0*B1 +1.D0)*(2.D0*A6+1.D0)*(2.D0*A9 +1.D0)
     1  *(2.D0*B6+1.D0)*(2.D0*A14+1.D0)*(2.D0*A3+1.D0)*(2.D0*B3 +1.D0)
     2  *(2.D0*A8+1.D0)*(2.D0*A11+1.D0)*(2.D0*B8+1.D0)*(2.D0*A16+1.D0)
      E6=DSQRT(E6)
      XX=FLLSIGP+A9+A13-A10-A14+0.5D0+A11+A15-A12-A16
      IF (DMOD(XX,TWO).NE.ZERO) E6=-E6
      MN=IX+1
      MX=JN-1
C
      TFL=TFLN-1.D0
      NLX=TFLX-TFL
      NSX=TFSX-TFSN+1.D0
      DO 300 NL=1,NLX
      TFL=TFL+1.D0
      E1=E6*S9J(A2,B2,A6,FLL(IN),FLL(IX),TFL,A1,B1,A5)
     1  *S9J(TFL,A10,A9,FLL(JN),B6,B5,FLLSIGP,A14,A13)*(2.D0*TFL+1.D0)
      IF (E1.EQ.0.D0) GO TO 300
      IF (TFL.EQ.0.D0) GO TO 140
      IF (DMOD(TFL,TWO).NE.ZERO) E1=-E1
      IF (MN.GT.MX) GO TO 140
      DO 130 M=MN,MX
      N5=NALSP(L1,M)
      IF (FL(N5,M).EQ.0.D0) GO TO 130
      E1=E1*RECPEX(PSCRL(L2,M-1),TFL,PSCRL(L1,M-1),FL(N5,M),
     1  PSCRL(L1,M),PSCRL(L2,M))
  130 CONTINUE
      IF (E1.EQ.0.D0) GO TO 300
  140 TFS=TFSN-1.D0
      DO 200 NS=1,NSX
      TFS=TFS+1.D0
      E2=E1*S9J(A4,B4,A8,HALF,HALF,TFS,A3,B3,A7)
     1     *S9J(TFS,A12,A11,HALF,B8,B7,HALF,A16,A15)*(2.D0*TFS+1.D0)
      IF (E2.EQ.0.D0) GO TO 200
      IF (TFS.EQ.0.D0) GO TO 155
      IF (DMOD(TFS,TWO).NE.ZERO) E2=-E2
      IF (MN.GT.MX) GO TO 155
      DO 150 M=MN,MX
      N5=NALSP(L1,M)
      IF (S(N5,M).EQ.0.D0) GO TO 150
      E2=E2*RECPEX(PSCRS(L2,M-1),TFS,PSCRS(L1,M-1),S(N5,M),
     1  PSCRS(L1,M),PSCRS(L2,M))
  150 CONTINUE
      IF (E2.EQ.0.D0) GO TO 200
  155 TK=KDMIN-2
      DO 160 NN=1,NKD
      TK=TK+2.D0
      E3=E2*S6J(FLL(IN),FLL(IX),TFL,FLLSIGP,FLL(JN),TK)
      IF (DMOD(FLL(IX)+FLL(JN)+TFL,TWO).NE.ZERO) E3=-E3
  160 CCC(NN)=CCC(NN)+E3
      N1=NKD+1
      TK=KEMIN-2
      DO 170 NN=N1,NKTOT
      TK=TK+2.D0
      E3=E2*S6J(FLL(IN),FLL(IX),TFL,FLL(JN),FLLSIGP,TK)
      IF (DMOD(TFS,TWO).NE.ZERO) E3=-E3
  170 CCC(NN)=CCC(NN)+E3
  200 CONTINUE
  300 CONTINUE
C
  900 RETURN
      END
      SUBROUTINE CLAS10
C
C          CALC FOR IRHO.LT.IRHOP.LT.ISIG.LT.ISIGP
C            OR FOR IRHO.LT.IRHOP.LT.ISIGP.LT.ISIG
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3/    CFP2(KLS1,KLS1,7),CIJK(10,6),
     1  U2(KLSI,KLSI,7),U3(KLSU,KLSU,9),U4(KLSU,KLSU,9),U5(KLSU,KLSU,7),
     2  U6(KLSU,KLSU,7),V2(KLSI,KLSI,7),V3(KLSI,KLSI,7),V4(KLSU,KLSU,7),
     *  V5(KLSU,KLSU,5),V6(KLSU,KLSU,5),
     3  NTI(41),IRP1MX,NALSJI(KJP),TFLN,TFLX,TFSN,TFSX,
     4  PJI(KJP),MULSI(KLSI),LBCDI(KLSI),IRHO,IRHOP,ISIG,ISIGP,FLLRHO,
     5  FLLSIG,IN,JN,JX,NII,NIJ,KI,KJ,KPI,KPJ,KDMIN,KEMIN,NKD,NKE,NKTOT,
     6  TR,TK,TC,RSUM,  J11,J12,L1,L2,TL(2,KS),TS(2,KS),
     7  TSCL(2,KS),TSCS(2,KS),NIJKP(KS,2),IRS(KS),IFL(KS),NDEL(KS),
     8    CIJR(8),CCC(8),N1,N2,N3,N4,E1,E2,E3,
     9  E4,E5,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,B1,B2,B3,B4,B5,B6,
     A  CFGP2(17,8,7),NALSJP(KJP,KS),PJ(KJP,KS)
      COMMON/CC/   U1(KLSI,KLSI,9),DUMLC1(KLC1)
      COMMON/C3LC2/CFGP1(KLSI,KLSI,7),PC(KPC),DUMLC2(KLC2)
      COMMON/C3LC3/V1(KLSI,KLSI,9),DUMLC3(KLC1)
      COMMON/C3LC4/DUMLC4(KMX**2-KISER),PCI(KISER)
      DIMENSION NPARJ(KC,KC),ISER(KISER)
      EQUIVALENCE (DUMLC4,NPARJ),(DUMLC4(KC**2+1),ISER)
      COMMON/EE/NALSP(KLSC,KS),PSCRL(KLSC,KS),PSCRS(KLSC,KS),
     1  NCFGP(KLSC),NJK(KJK,KS),NCFGJP(KJP,KS),MULS1(KLSC),MULS4(KLSC),
     2  LHS1(KLSC),LHS4(KLSC)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      DIMENSION CFP1(KLS1,KLS1)
      EQUIVALENCE (CFP1,CFGP1)
C
C
      FLLJN=FLLSIG
      FLLJX=FLLSIGP
      IF (IRHO.LT.IRHOP.AND.ISIG.LE.ISIGP) GO TO 110
      IF (IRHO.GE.IRHOP.AND.ISIG.GE.ISIGP) GO TO 110
      FLLJN=FLLSIGP
      FLLJX=FLLSIG
  110 LA=L1
      LB=L2
      JA=J11
      JB=J12
      TL(1,JN)=FLLJN
      TL(2,JN)=FLLJX
      TS(1,JN)=0.5D0
      TS(2,JN)=0.5D0
      IF (L1.EQ.LCI.AND.ISIG.LE.ISIGP) GO TO 120
      IF (L1.EQ.LCIP.AND.ISIGP.LE.ISIG) GO TO 120
      LA=L2
      LB=L1
      JA=J12
      JB=J11
      TL(1,JN)=FLLJX
      TL(2,JN)=FLLJN
C
  120 I=IX
      J=JN
      NII=1
      NIJ=1
      N1=NALSP(L1,I)
      N2=NALSP(L2,I)
      N3=NALSP(LA,J)
      N4=NALSP(LB,J)
      A1=PSCRL(L1,I-1)
      A2=PSCRL(L2,I-1)
      A3=PSCRS(L1,I-1)
      A4=PSCRS(L2,I-1)
      A5=PSCRL(L1,I)
      A6=PSCRL(L2,I)
      A7=PSCRS(L1,I)
      A8=PSCRS(L2,I)
      A9=PSCRL(LA,J-1)
      A10=PSCRL(LB,J-1)
      A11=PSCRS(LA,J-1)
      A12=PSCRS(LB,J-1)
      A13=PSCRL(LA,J)
      A14=PSCRL(LB,J)
      A15=PSCRS(LA,J)
      A16=PSCRS(LB,J)
      B1=FL(N1,I)
      B2=FL(N2,I)
      B3=S(N1,I)
      B4=S(N2,I)
      B5=FL(N3,J)
      B6=FL(N4,J)
      B7=S(N3,J)
      B8=S(N4,J)
      IF (JN.LT.NOSUBC.OR.JX.LT.NOSUBC) GO TO 130
      A14=A10
      A16=A12
      B5=FLLJN
      B6=0.D0
      B7=0.5D0
      B8=0.D0
C
  130 TLI=DMAX1(DABS(FLL(IN)-A5),DABS(A2-B1),DABS(FLL(I)-A6))-1.D0
      NTLI=DMIN1(FLL(IN)+A5,A2+B1,FLL(I)+A6)-TLI
      IF (NTLI.LE.0) GO TO 900
      TLJN=DMAX1(DABS(FLLJN-A9),DABS(A13-B6),DABS(FLLJX-A10))-1.D0
      NTLJ=DMIN1(FLLJN+A9,A13+B6,FLLJX+A10)-TLJN
      IF (NTLJ.LE.0) GO TO 900
      TSIN=DMAX1(DABS(0.5D0-A7),DABS(A4-B3),DABS(0.5D0-A8))-1.D0
      NTSI=DMIN1(0.5D0+A7,A4+B3,0.5D0+A8)-TSIN
      IF (NTSI.LE.0) GO TO 900
      TSJN=DMAX1(DABS(0.5D0-A11),DABS(A15-B8),DABS(0.5D0-A12))-1.D0
      NTSJ=DMIN1(0.5D0+A11,A15+B8,0.5D0+A12)-TSJN
      IF (NTSJ.LE.0) GO TO 900
C
      JM1=J-1
      DO 150 III=1,2
      M=L1
      IF (III.EQ.2) M=L2
      DO 150 IP=I,JM1
      II=NALSP(M,IP)
      TL(III,IP)=FL(II,IP)
      TS(III,IP)=S(II,IP)
      TSCL(III,IP)=PSCRL(M,IP)
  150 TSCS(III,IP)=PSCRS(M,IP)
      TL(1,I)=FLL(IN)
      TL(2,I)=FLL(IX)
      TS(1,I)=0.5D0
      TS(2,I)=0.5D0
C
      E11=(2.D0*A1+1.D0)*(2.D0*A3+1.D0)*(2.D0*B2+1.D0)
      E12=(2.D0*B4+1.D0)*(2.D0*B5+1.D0)*(2.D0*B7+1.D0)
      E13=(2.D0*A14+1.D0)*(2.D0*A16+1.D0)
      E1=DSQRT(E11*E12*E13)
c     E1=DSQRT((2.D0*A1+1.D0)*(2.D0*A3+1.D0)*(2.D0*B2+1.D0)*
c    1  (2.D0*B4+1.D0)*(2.D0*B5+1.D0)*(2.D0*B7+1.D0)*
c    2  (2.D0*A14+1.D0)*(2.D0*A16+1.D0))
      XX1=FLL(IN)+FLL(I)+FLLJX+B1+B1+A1+A2+A6
      XX1=XX1+B5+B6+A9+A13+A14+1.5D0+B3
      XX1=XX1+B3+A3+A4+A8+B7+B8+A11
      XX1=XX1+A15+A16
      DO 200 NLI=1,NTLI
      TLI=TLI+1.D0
      E2=E1*(2.D0*TLI+1.D0)*S6J(FLL(IN),A2,A1, B1,A5,TLI)
      E2=E2*S6J(A2,B1,TLI, FLL(I),A6,B2)
      TSCL(1,I-1)=TLI
      TSCL(2,I-1)=TLI
      TLJ=TLJN
      DO 200 NLJ=1,NTLJ
      TLJ=TLJ+1.D0
      E3=E2*(2.D0*TLJ+1.D0)*S6J(B6,FLLJN,B5, A9,A13,TLJ)
      E3=E3*S6J(B6,A10,A14, FLLJX,A13,TLJ)
      TSCL(1,J)=TLJ
      TSCL(2,J)=TLJ
      TSI=TSIN
      DO 200 NSI=1,NTSI
      TSI=TSI+1.D0
      E4=E3*(2.D0*TSI+1.D0)*S6J(HALF,A4,A3, B3,A7,TSI)
      E4=E4*S6J(A4,B3,TSI, HALF,A8,B4)
      TSCS(1,I-1)=TSI
      TSCS(2,I-1)=TSI
      TSJ=TSJN
      DO 200 NSJ=1,NTSJ
      TSJ=TSJ+1.D0
      E5=E4*(2.D0*TSJ+1.D0)*S6J(B8,HALF,B7, A11,A15,TSJ)
      E5=E5*S6J(B8,A12,A16, HALF,A15,TSJ)
      XX=XX1+TLI+TLJ+TSI+TSJ
      IF (DMOD(XX,TWO).GT.ZERO) E5=-E5
      TSCS(1,J)=TSJ
      TSCS(2,J)=TSJ
      TK=DFLOAT(KDMIN-2)
      DO 160 NN=1,NKD
      TK=TK+2.D0
      CALL RDIJ(I,J)
      CCC(NN)=CCC(NN)+E5*A
  160 CONTINUE
      N1=NKD+1
      TK=DFLOAT(KEMIN-2)
      DO 170 NN=N1,NKTOT
      TK=TK+2.D0
      CALL REIJ(I,J)
      CCC(NN)=CCC(NN)+E5*RSUM
  170 CONTINUE
  200 CONTINUE
C
  900 RETURN
      END
      SUBROUTINE CLAS11
C
C          CALC FOR IRHO=IRHOP, ISIG=ISIGP=NOSUBC, NI(ISIG)=1
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3/    CFP2(KLS1,KLS1,7),CIJK(10,6),
     1  U2(KLSI,KLSI,7),U3(KLSU,KLSU,9),U4(KLSU,KLSU,9),U5(KLSU,KLSU,7),
     2  U6(KLSU,KLSU,7),V2(KLSI,KLSI,7),V3(KLSI,KLSI,7),V4(KLSU,KLSU,7),
     *  V5(KLSU,KLSU,5),V6(KLSU,KLSU,5),
     3  NTI(41),IRP1MX,NALSJI(KJP),TFLN,TFLX,TFSN,TFSX,
     4  PJI(KJP),MULSI(KLSI),LBCDI(KLSI),IRHO,IRHOP,ISIG,ISIGP,FLLRHO,
     5  FLLSIG,IN,JN,JX,NII,NIJ,KI,KJ,KPI,KPJ,KDMIN,KEMIN,NKD,NKE,NKTOT,
     6  TR,TK,TC,RSUM,  J11,J12,L1,L2,TL(2,KS),TS(2,KS),
     7  TSCL(2,KS),TSCS(2,KS),NIJKP(KS,2),IRS(KS),IFL(KS),NDEL(KS),
     8    CIJR(8),CCC(8),N1,N2,N3,N4,E1,E2,E3,
     9  E4,E5,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,B1,B2,B3,B4,B5,B6,
     A  CFGP2(17,8,7),NALSJP(KJP,KS),PJ(KJP,KS)
      COMMON/CC/   U1(KLSI,KLSI,9),DUMLC1(KLC1)
      COMMON/C3LC2/CFGP1(KLSI,KLSI,7),PC(KPC),DUMLC2(KLC2)
      COMMON/C3LC3/V1(KLSI,KLSI,9),DUMLC3(KLC1)
      COMMON/C3LC4/DUMLC4(KMX**2-KISER),PCI(KISER)
      DIMENSION NPARJ(KC,KC),ISER(KISER)
      EQUIVALENCE (DUMLC4,NPARJ),(DUMLC4(KC**2+1),ISER)
      COMMON/EE/NALSP(KLSC,KS),PSCRL(KLSC,KS),PSCRS(KLSC,KS),
     1  NCFGP(KLSC),NJK(KJK,KS),NCFGJP(KJP,KS),MULS1(KLSC),MULS4(KLSC),
     2  LHS1(KLSC),LHS4(KLSC)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      DIMENSION CFP1(KLS1,KLS1)
      EQUIVALENCE (CFP1,CFGP1)
C
  100 I=IRHO
      J=ISIG
      NIJ=1
      KI=NALSP(LCI,I)-NOTSJ1(I,J1A)
      KPI=NALSP(LCIP,I)-NOTSJ1(I,J1B)
      DO 110 III=1,2
      MM=LCI
      IF (III.EQ.2) MM=LCIP
      DO 110 IP=1,NOSUBC
      II=NALSP(MM,IP)
      TL(III,IP)=FL(II,IP)
      TS(III,IP)=S(II,IP)
      TSCL(III,IP)=PSCRL(MM,IP)
  110 TSCS(III,IP)=PSCRS(MM,IP)
      TK=DFLOAT(KDMIN-2)
      DO 150 NN=1,NKD
      TK=TK+2.D0
      CALL RDIJ(I,J)
      CCC(NN)=A
  150 CONTINUE
      N1=NKD+1
      TK=DFLOAT(KEMIN-2)
      DO 160 NN=N1,NKTOT
      TK=TK+2.D0
      CALL REIJ(I,J)
      CCC(NN)=RSUM
  160 CONTINUE
C
      RETURN
      END
C
      SUBROUTINE PK1(LD,IM1,IM2,A,IA1,IA2,B,IMSQ,MAXLEN)   !,K1,IW)
C         PACKS 2-DIMENSIONAL MATRIX A(IM1,IM2) INTO THE BUFFER B.
C         IF IMSQ<IM1*IM2 AND IM1=IM2, MATRIX A IS TREATED AS SYMMETRIC;
C           ONLY UPPER TRIANGLE IS SAVED.
C         DIMENSION OF A MATRIX IS (IA1,IA2)
C         THE PACKED MATRIX IS WRITTEN TO THE DATA FILE (UNIT=LD)
C         THE OFFSET IN THE BUFFER B IS IOFFS
C
      IMPLICIT REAL*8 (A-H,O-Z)
      CHARACTER*12 B,BB
      INTEGER*2 I,J,I1,BB1
      REAL*8 R8
      DIMENSION A(IA1,IA2),B(MAXLEN),BB1(6)
      EQUIVALENCE (R8,BB1(1)),(BB,BB1(1)),(I,BB1(5)),(J,BB1(6))
C
      IMSQ2=IM1*IM2
      IOFFS=0
      IFILL=0
      DO 100 J=1,IM2
        I1=J
        IF (IMSQ.GE.IMSQ2) I1=1
        DO 100 I=I1,IM1
          R8=A(I,J)
          IF (DABS(R8).GT.1.D-30) THEN
            IF (IOFFS.GE.MAXLEN) THEN
              WRITE(*,10) MAXLEN 
   10         FORMAT(11H More than ,I5,28H non-zero elements in matrix)
              STOP '(Dimension error)'
            ENDIF
            IOFFS=IOFFS+1
            B(IOFFS)=BB
            IFILL=1
          ENDIF
  100 CONTINUE
      IF (IFILL.EQ.0) THEN
        IOFFS=IOFFS+1
        I=0
        J=0
        R8=0.D0
        B(IOFFS)=BB
      ENDIF
      WRITE (LD) IOFFS,(B(K),K=1,IOFFS)
C     WRITE (LD) K1,IOFFS,(B(K),K=1,IOFFS)
C     FCOM=DFLOAT(IOFFS)/DFLOAT(IMSQ)
C     WRITE (IW,110) K1,FCOM,IOFFS
C 110 FORMAT(' PK1 CALL NO',I3,': COMPRESSION FACTOR ',F5.3,
C    1  ', SIZE=',I10)
      RETURN
      END
C
      SUBROUTINE UNPK1(LD,IM1,IM2,A,IA1,IA2,B,IMSQ,MAXLEN)
C
      IMPLICIT REAL*8 (A-H,O-Z)
      CHARACTER*12 B,BB
      INTEGER*2 BB1
      REAL*8 R8
      DIMENSION A(IA1,IA2),B(MAXLEN),BB1(6)
      EQUIVALENCE (R8,BB1(1)),(BB,BB1(1))
C
C     READ (LD) K1,IOFFS2,(B(K),K=1,IOFFS2)
      READ (LD) IOFFS2,(B(K),K=1,IOFFS2)
C
      IF (K1.EQ.11) THEN
        K1=1
      ENDIF
C
      DO 10 J=1,IM2
        DO 10 I=1,IM1
   10 A(I,J)=0.D0
C
      IMSQ2=IM1*IM2
      IF (IMSQ.LT.IMSQ2) THEN
        DO 100 K=1,IOFFS2
          BB=B(K)
          A(BB1(5),BB1(6))=R8
          A(BB1(6),BB1(5))=R8
  100   CONTINUE
      ELSE 
        DO 200 K=1,IOFFS2
          BB=B(K)
          A(BB1(5),BB1(6))=R8
  200   CONTINUE
      ENDIF
  300 RETURN
      END
C
C     OVERLAY(G9,6,0)
      SUBROUTINE CALCFC
C
C          SET UP FINAL COEF MATRICES, AND CALC LS-JJ TRANSF MATRIX
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      PARAMETER (KCC=KISER/4)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3A/ISUBJ(KC),MULS(KS),LHS(KS),
     1  NALS(KMX,KS),NCFG(KMX),NALSJ(KMX,KS),SCRL(KMX,KS),SCRS(KMX,KS),
     2  FJ(KMX,KS),SCRJ(KMX,KS),MUL(KS),LH(KS),LF(KLSC),NSJK(110),
     3  FK(KMX),FKJ(KMX),SCRL6(KMX),SCRS6(KMX),FK6(KMX),LHQQ(KMX),
     4  MULTQQ(KMX),NALSJP(KJP,KS),PJ(KJP,KS),NOICRD
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      COMMON/CC/   C(KMX,KMX)
      COMMON/C3LC2/TMX(KMX,KMX)
      COMMON/C3LC3/CT4(KMX,KMX)
      COMMON/C3LC4/DUMLC4(KMX**2-KCC*8),CC(KCC,8)
      DIMENSION NPARJ(KC,KC)
      EQUIVALENCE (DUMLC4,NPARJ)
      COMMON/C3LCM/MN1,MX1,MN2,MX2,MN3,MX3,MN4,MX4,MN5,MX5,
     1  MN6,MX6,MN7,MX7,MN8,MX8,SJ2,SJ3,SJ4,SJ5,SJ6,SJ7,SJ8
      COMMON/EE/NALSP(KLSC,KS),PSCRL(KLSC,KS),PSCRS(KLSC,KS),
     1  NCFGP(KLSC),NJK(KJK,KS),NCFGJP(KJP,KS)
      CHARACTER*8 FIERAS,EAV
      CHARACTER*8 FIDLS,FIDJJ,LDES,LDESP,PARNAM,AA,COUPL,TMXH,R5,A1,A2
      CHARACTER*4 LSYMB,IR5,A11,A22,LHS,LI,LH,LBCD
      COMMON/CHAR/PARNAM(KPR,2),FIDLS(KMX,2),FIDJJ(KMX,2),LDES(KMX),
     1  LDESP(KMX)
      DIMENSION PC(KISER),V1(KLSI,KLSI,9),P5(KISER),IP5(KISER),
     *          R5(KISER),IR5(KISER),IIIALF(KS)
      EQUIVALENCE (CT4,PC,V1),(CC,P5,IP5),(CC,R5,IR5)
      PARAMETER (MAXBC=50000)
      CHARACTER*12 BUFC
      COMMON/BUFS/BUFC(MAXBC)
      CHARACTER*1 IBLANK,CHH
      INTEGER*1 KK1,KK2
      DATA TMXH/3HTMX/
      DATA EAV/'EAV     '/
      DATA IBLANK/1H /
      DIMENSION ISUB1(KC)
C
C
C          CALC FINAL LEVELS AND COEF MATRICES
C
C     KS=8
C     KC=50
      J1X=NSCONF(2,KK)
      REWIND IL
      READ (IL) NOTSJ1,NSCRJ8,SJ8MN,SJ8MX,NPAR,NPARJ,PARNAM,
     1  NOTSX, ((FL(L,I),S(L,I), L=1,NOTSX), I=1,NOSUBC),NALSJP,PJ
C          WRITE ON TAPE5 INPUT FOR LEAST-SQUARES PROGRAM KONFIT
      IF (ICTBCD.GT.0) WRITE (19,14)
   14 FORMAT (5X,1H )
      IF (ICTBCD.GE.0) GO TO 200
C     ENCODE (80,15,P5)
      WRITE (11,15)
   15 FORMAT (45H MATRIX COEFFICIENTS WRITTEN BY PROGRAM RCG11,35X)
      BACKSPACE 11
      READ (11,11) (P5(I),I=1,10)
   11 FORMAT (10A8)
      IP5(9)=NSCRJ8
      IP5(10)=NPAR
      IP5(11)=J1X
      IP5(12)=2-KCPL
      DO 110 I=1,NPAR
  110 R5(I+12)=PARNAM(I,KK)
      J=NPAR+12
      J1=J
      DO 120 I=1,J1X
        J=J+1
  120 WRITE(R5(J),16) (LLIJK(JJ,I,KK),NIJK(JJ,I,KK),JJ=1,3)
   16 FORMAT (3(A1,I1,1X))
      WRITE (IW,17) (IP5(I),I=1,J1)
   17 FORMAT (1X,8A10/1X,4I10/(1X,5A10))
      J1=J1+1
      WRITE (IW,18) (R5(I),I=J1,J)
   18 FORMAT (1X,5A10)
C     BUFFER OUT (5,1) (P5(1),P5(J))
C     ITEST5=UNIT(5)
C
C
  200 SCRJ8=SJ8MN-1.D0
      DO 900 N=1,NSCRJ8
      SCRJ8=SCRJ8+1.D0
      REWIND 20
C
C          SET UP LS LEVELS
C
      L=0
      MX=0
      DO 229 K=1,NDIFFT
        LF(K)=0
        MN=MX+1
        MX=MX+NTRMK(K)
        SJMN=DABS(PSCRL(MN,NOSUBC)-PSCRS(MN,NOSUBC))
        SJMX=PSCRL(MN,NOSUBC)+PSCRS(MN,NOSUBC)
        IF (SCRJ8.LT.SJMN) GO TO 229
        IF (SCRJ8.GT.SJMX) GO TO 229
        DO 219 M=MN,MX
          L=L+1
          IF (L.GT.KMX) GO TO 219
          NCFG(L)=NCFGP(M)
          DO 215 I=1,NOSUBC
            NALS(L,I)=NALSP(M,I)
            SCRL(L,I)=PSCRL(M,I)
  215     SCRS(L,I)=PSCRS(M,I)
  219   CONTINUE
        LF(K)=1
  229 CONTINUE
      NLS=L
C
C          SET UP JJ LEVELS
C
  300 IF (NOLSKP.NE.0) GO TO 350
      L=0
      K=0
      J1=1
      MX1=0
      K1MX=NDIFFJ(1)
      DO 349 K1=1,K1MX
        MN1=MX1+1
        MX1=MX1+NJK(K1,1)
        IF (NALSJP(MX1,1).GT.NOTSJ1(1,J1+1)) J1=J1+1
        MX2=0
        K2MX=NDIFFJ(2)
        DO 348 K2=1,K2MX
          MN2=MX2+1
          MX2=MX2+NJK(K2,2)
          J=NALSJP(MX2,2)
          IF (J.LE.NOTSJ1(2,J1).OR.J.GT.NOTSJ1(2,J1+1)) GO TO 348
          MX3=0
          K3MX=NDIFFJ(3)
          DO 347 K3=1,K3MX
            MN3=MX3+1
            MX3=MX3+NJK(K3,3)
            J=NALSJP(MX3,3)
            IF (J.LE.NOTSJ1(3,J1).OR.J.GT.NOTSJ1(3,J1+1)) GO TO 347
            MX4=0
            K4MX=NDIFFJ(4)
            DO 346 K4=1,K4MX
              MN4=MX4+1
              MX4=MX4+NJK(K4,4)
              J=NALSJP(MX4,4)
              IF (J.LE.NOTSJ1(4,J1).OR.J.GT.NOTSJ1(4,J1+1)) GO TO 346
              MX5=0
              K5MX=NDIFFJ(5)
              DO 345 K5=1,K5MX
                MN5=MX5+1
                MX5=MX5+NJK(K5,5)
                J=NALSJP(MX5,5)
                IF (J.LE.NOTSJ1(5,J1).OR.J.GT.NOTSJ1(5,J1+1)) GO TO 345
                MX6=0
                K6MX=NDIFFJ(6)
                DO 344 K6=1,K6MX
                  MN6=MX6+1
                  MX6=MX6+NJK(K6,6)
                  J=NALSJP(MX6,6)
                  IF (J.LE.NOTSJ1(6,J1).OR.J.GT.NOTSJ1(6,J1+1))
     1              GO TO 344
                  MX7=0
                  K7MX=NDIFFJ(7)
                  DO 343 K7=1,K7MX
                    MN7=MX7+1
                    MX7=MX7+NJK(K7,7)
                    J=NALSJP(MX7,7)
                    IF (J.LE.NOTSJ1(7,J1).OR.J.GT.NOTSJ1(7,J1+1))
     1                GO TO 343
                    MX8=0
                    K8MX=NDIFFJ(8)
                    DO 342 K8=1,K8MX
                      MN8=MX8+1
                      MX8=MX8+NJK(K8,8)
                      J=NALSJP(MX8,8)
                      IF (J.LE.NOTSJ1(8,J1).OR.J.GT.NOTSJ1(8,J1+1))
     1                  GO TO 342
                      SJ2=DABS(PJ(MN1,1)-PJ(MN2,2))-1.D0
                      NJ2=PJ(MN1,1)+PJ(MN2,2)-SJ2
                      DO 339 IJ2=1,NJ2
                        SJ2=SJ2+1.D0
                        SJ3=DABS(SJ2-PJ(MN3,3))-1.D0
                        NJ3=SJ2+PJ(MN3,3)-SJ3
                        DO 339 IJ3=1,NJ3
                          SJ3=SJ3+1.D0
                          SJ4=DABS(SJ3-PJ(MN4,4))-1.D0
                          NJ4=SJ3+PJ(MN4,4)-SJ4
                          DO 339 IJ4=1,NJ4
                            SJ4=SJ4+1.D0
                            SJ5=DABS(SJ4-PJ(MN5,5))-1.D0
                            NJ5=SJ4+PJ(MN5,5)-SJ5
                            DO 339 IJ5=1,NJ5
                              SJ5=SJ5+1.D0
                              SJ6=DABS(SJ5-PJ(MN6,6))-1.D0
                              NJ6=SJ5+PJ(MN6,6)-SJ6
                              DO 339 IJ6=1,NJ6
                                SJ6=SJ6+1.D0
                                SJ7=DABS(SJ6-PJ(MN7,7))-1.D0
                                NJ7=SJ6+PJ(MN7,7)-SJ7
                                DO 339 IJ7=1,NJ7
                                  SJ7=SJ7+1.D0
                                  SJ8=DABS(SJ7-PJ(MN8,8))-1.D0
                                  NJ8=SJ7+PJ(MN8,8)-SJ8
                                  DO 339 IJ8=1,NJ8
                                    SJ8=SJ8+1.D0
                                    IF (SJ8.NE.SCRJ8) GO TO 339
C
                                    K=K+1
                                    NSJK(K)=0
C
C              8-FOLD DO LOOP (37 LINES) MOVED TO SUBROUTINE CAFCDOLP
C
                                    CALL CAFCDOLP(L,K)
C
  339                 CONTINUE
  342               CONTINUE
  343             CONTINUE
  344           CONTINUE
  345         CONTINUE
  346       CONTINUE
  347     CONTINUE
  348   CONTINUE
  349 CONTINUE
      NDIFSJ=K
      NJJ=L
      IF (NJJ.NE.NLS) WRITE (IW,35) NLS,NJJ,SCRJ8
   35 FORMAT (///5H0NLS=,I3,5X,5H NJJ=,I3,5X,11H FOR SCRJ8=,F4.1)
      IF (NLS.LE.KMX) GO TO 350
      WRITE (IW,36) NLS,KMX,SCRJ8
   36 FORMAT (///18H0*****MATRIX SIZE=,I4,
     1  25H  GREATER THAN DIMENSION=,I4,'     FOR SCRJ8=',F4.1)
      NLS=KMX
C
C          CALC SUBSHELL TO BE USED IN BASIS-STATE LABELS
C
  350 DO 390 J=1,J1X
        ISUBJ(J)=0
        ISUB=0
	ISUB1(J)=0
        DO 380 I=1,NOSUBC
          I1=NOSUBC-I+1
          W=NIJK(I1,J,KK)
          WFM1=4.D0*FLLIJK(I1,J,KK)+1.D0
	  IF (W.NE.0.D0.AND.I1.GT.ISUB1(J)) ISUB1(J)=I1
          IF (W.EQ.0.D0.OR.W.GT.WFM1) GO TO 380
          IF (W.EQ.1.D0.OR.W.EQ.WFM1) GO TO 370
          ISUBJ(J)=-I1
          GO TO 380
  370     IF (ISUBJ(J).EQ.0.AND.I1.LT.ISUB) ISUBJ(J)=I1
          ISUB=I1
  380   CONTINUE
        IF (ISUBJ(J).EQ.0) ISUBJ(J)=1
  390 CONTINUE
C
C          WRITE COMPLETE QUANTUM NUMBERS
C               AND FORM BASIS-STATE LABELS
C
      IPT=0
      IF (ICFC.EQ.0) GO TO 405
      IPT=1
      IF (KCPLD(1)+KCPLD(2).GT.1) IPT=0
      IF (KCPLD(9).GE.9.OR.ISPECC.GE.9) IPT=0
      JJJ=MIN0(J1X,9)
      IF (IPT.EQ.0) GO TO 400
      IF (JJJ+NLS*((KS+3)/4).GT.55.OR.ICFC.GT.2) WRITE (IW,37)
   37 FORMAT (1H1)
  400 WRITE(IW,38) SCRJ8,(J,(LLIJK(I,J,KK),NIJK(I,J,KK),I=1,KS),J=1,JJJ)
   38 FORMAT (3H0J=,F4.1,10X,13HCONFIGURATION,I10,4X,8(A1,I2,3X)/
     1  (30X,I10,4X,8(A1,I2,3X)))
      IF (J1X.GT.9) WRITE (IW,39)  J1X, (LLIJK(I,J1X,KK),NIJK(I,J1X,KK),
     1  I=1,KS)
   39 FORMAT (30X,I10,4X,8(A1,I2,3X))
      WRITE (IW,40)
   40 FORMAT (7H ------/)
  405 DO 470 L=1,NLS
        DO 410 I=1,NOSUBC
          M=NALS(L,I)
          MUL(I)=MULT(M,I)
          LH(I)=LBCD(M,I)
          IIIALF(I)=IALF(M,I)
          MULS(I)=2.D0*SCRS(L,I)+1.D0
          LP1=SCRL(L,I)+1.D0
  410   LHS(I)=LSYMB(LP1)
        J=NCFG(L)
        I1=IABS(ISUBJ(J))
        MI=MUL(I1)
        LI=LH(I1)
C ****************************************************** Yu.RALCHENKO v
        WRITE (CHH,9877) IIIALF(I1)
 9877   FORMAT(A1)
        IF (CHH.NE.IBLANK) CALL SENIOR(KK,J,MI,LI,CHH)
C ****************************************************** Yu.RALCHENKO ^
        IF (ISUBJ(J).LT.0) GO TO 420
        MI=MULS(I1)
        LI=LHS(I1)
  420   WRITE (FIDLS(L,1),41) MI,LI,MULS(NOSUBC),LHS(NOSUBC),CHH
   41   FORMAT (I1,A1,1H),I2,2A1)
C ****************************************************** Yu.RALCHENKO v
        IF (IQS.NE.0) THEN
          WRITE(FIDLS(L,1),41) MUL(IQS),LH(IQS),MULS(NOSUBC),
     1      LHS(NOSUBC),CHH
        ELSE
          IF (INWOL.EQ.1) THEN
            JY=0
 9100       JY=JY+1
            IF (JY.LT.NOSUBC) THEN
              IF (MULS(NOSUBC-JY).EQ.MULS(NOSUBC).AND.LHS(NOSUBC-JY).
     1          EQ.LHS(NOSUBC)) GO TO 9100
              WRITE(FIDLS(L,1),41) MULS(NOSUBC-JY),
     1          LHS(NOSUBC-JY),MULS(NOSUBC),LHS(NOSUBC),CHH
            ENDIF
          ELSE IF (INWOL.EQ.9) THEN
            DO 3945 JKI=NOSUBC,2,-1
              IF(LHS(JKI).EQ.LHS(JKI-1).AND.MULS(JKI).EQ.MULS(JKI-1)) 
     *          GOTO 3945
              JKIIKJ=JKI-1
              GOTO 3946
 3945       CONTINUE      
 3946       WRITE (FIDLS(L,1),41) MULS(JKIIKJ),LHS(JKIIKJ),
     *        MULS(NOSUBC),LHS(NOSUBC),CHH
          ENDIF
        ENDIF
C ****************************************************** Yu.RALCHENKO ^
        IF (IPT.EQ.0) GO TO 440
        IF (NOSUBC.LE.3) GO TO 430
        WRITE (IW,42) L, NCFG(L), (NALS(L,I),MUL(I),LH(I),
     1      MULS(I),LHS(I), I=1,NOSUBC)
   42   FORMAT(1H ,I3,I3,2X,1H(,I3,I2,A1,1H),I2,A1,
     1    7(3H  (,I1,I3,A1,1H),I2,A1))
        GO TO 440
  430   WRITE (IW,43) NCFG(L), (NALS(L,I),MUL(I),LH(I),
     1      MULS(I),LHS(I), I=1,NOSUBC)
   43   FORMAT (1H ,I2,4X,3(1H(,I3,I3,A1,1H),I3,A1,4X))
  440   IF (NOLSKP.NE.0) GO TO 470
        DO 445 I=1,NOSUBC
          M=NALSJ(L,I)
          MUL(I)=MULT(M,I)
          LH(I)=LBCD(M,I)
  445   CONTINUE
        FJI=FJ(L,I1)
        IF (ISUBJ(J).GT.0) FJI=SCRJ(L,I1)
C       WRITE (FIDJJ(L,1),44) MUL(I1),LH(I1),FJI
C  44   FORMAT (1H(,I1,A1,F4.1,1H))
C A.KRAMIDA
        I2FJI1=2.D0*FJI
        I2FJI=2.D0*FJ(L,ISUB1(J))
        WRITE (FIDJJ(L,1),44) MUL(I1),LH(I1),I2FJI1,I2FJI
   44   FORMAT (I1,A1,I2,1H),I2)
C A.KRAMIDA
        IF (IPT.EQ.0) GO TO 470
        IF (NOSUBC.GT.4) GO TO 470
        IF (NOSUBC.LE.2) GO TO 460
        WRITE (IW,45) L,
     1   (NALSJ(L,I),MUL(I),LH(I),FJ(L,I),SCRJ(L,I), I=1,NOSUBC)
   45   FORMAT (1H+,I60,4X,1H(,I3,I2,A1,F4.1,1H),F4.1,
     1    3(3H  (,I2,I2,A1,F4.1,1H),F4.1))
        GO TO 470
  460   WRITE (IW,46) L,
     1   (NALSJ(L,I),MUL(I),LH(I),FJ(L,I),SCRJ(L,I), I=1,NOSUBC)
   46   FORMAT (1H+,I60,3X,3(4X,1H(,I3,I3,A1,F5.1,1H),F5.1))
  470 CONTINUE
C ****************************************************  A.KRAMIDA  v
C
C       ELIMINATE DIPLICATE TERM NAMES
C
 4715 DO 4730 L=1,NLS
        DO 4725 LP=L+1,NLS
          IF (NCFG(L).EQ.NCFG(LP).AND.FIDLS(L,1).EQ.FIDLS(LP,1)) THEN
            READ(FIDLS(L,1),4720) A1,KK1
            READ(FIDLS(LP,1),4720) A2,KK2
 4720       FORMAT (A6,A1)
            IF (KK1.GE.49.AND.KK1.LE.57) THEN          ! SENIORITY IS USED
C               IF SENIORITY NUMBERS ARE USED IN THE 7TH POSITION, THEN
C               USE OTHER SYMBOLS INSTEAD OF THE RIGHT BRACKET ')'
              READ(FIDLS(L,1),4740) A1,KK1,A11
              READ(FIDLS(LP,1),4740) A2,KK2,A22
 4740         FORMAT (A2,A1,A4)
              IF (KK1.EQ.41) THEN  ! ')' CHARACTER USED AS BRACKET
                KK2=62    ! USE '>' CHARACTER 
              ELSE
                IF (KK1.EQ.62) THEN  ! '>' CHARACTER USED
                  KK2=93    ! USE ']' CHARACTER
                ELSE
                  IF (KK1.EQ.93) THEN  ! ']' CHARACTER USED
                    KK2=125    ! USE '}' CHARACTER
                  ELSE
                    IF (KK1.EQ.125) THEN  ! '}' CHARACTER USED
                      KK2=92    ! USE '\' CHARACTER
                    ELSE
                      IF (KK1.EQ.92) THEN  ! '\' CHARACTER USED
                        KK2=124    ! USE '|' CHARACTER
                      ELSE
C       ASSUME THAT NO MORE THAN 6 DUPLICATE TERM NAMES CAN EVER OCCUR
        STOP 'MORE THAN 6 REPEATING TERMS WITH SAME SENIORITY.'
                      ENDIF
                    ENDIF
                  ENDIF
                ENDIF
              ENDIF
              WRITE(FIDLS(L,1),4740) A1,KK1,A11
              WRITE(FIDLS(LP,1),4740) A2,KK2,A22
              GO TO 4715
            ELSE
              IF (KK1.EQ.32) KK1=97  ! 'a' CHARACTER IF PREVIOUS IS ' '
              KK2=KK1+1
              WRITE(FIDLS(L,1),4720) A1,KK1
              WRITE(FIDLS(LP,1),4720) A2,KK2
              GO TO 4715
            ENDIF
          ENDIF
 4725   CONTINUE
 4730 CONTINUE
C ****************************************************  A.KRAMIDA  ^      
      IF (NOLSKP.NE.0) GO TO 595
      IF (IPT.EQ.0) GO TO 505
      WRITE (IW,43)
      IF (NOSUBC.LE.4) GO TO 505
      DO 472 L=1,NLS
        DO 471 I=1,NOSUBC
          M=NALSJ(L,I)
          MUL(I)=MULT(M,I)
  471   LH(I)=LBCD(M,I)
        WRITE (IW,47) L,
     1    (NALSJ(L,I),MUL(I),LH(I),FJ(L,I),SCRJ(L,I), I=1,NOSUBC)
   47   FORMAT (I5,1X,8(2H (,I2,I2,A1,F4.1,1H),F4.1))
  472 CONTINUE
      WRITE (IW,43)
C
C          CALC TRANSFORMATION MATRIX
C
  505 DO 530 LS=1,NLS
        ILSSL=SCRL(LS,NOSUBC)+SCRS(LS,NOSUBC)-SCRJ8
        ILSSL=MOD(ILSSL,2)
        DO 530 JJ=1,NJJ
          TMX(LS,JJ)=0.D0
          DO 510 I=1,NOSUBC
            IF (NALS(LS,I).NE.NALSJ(JJ,I)) GO TO 530
  510     CONTINUE
          TMX(LS,JJ)=1.D0
          IF (IABG.GE.3.AND.ILSSL.NE.0) TMX(LS,JJ)=-1.D0
          IF (NOSUBC.LE.1) GO TO 530
          DO 521 I=2,NOSUBC
            ML=NALS(LS,I)
            IF (FL(ML,I).EQ.0.D0.AND.S(ML,I).EQ.0.D0) GO TO 521
            IF (SCRL(LS,I-1).EQ.0.D0.AND.SCRS(LS,I-1).EQ.0.D0) GO TO 521
            A=DSQRT((2.D0*SCRL(LS,I)+1.D0)*(2.D0*SCRS(LS,I)+1.D0)
     1        *(2.D0*FJ(JJ,I)+1.D0)*(2.D0*SCRJ(JJ,I-1)+1.D0))
            B=S9J(SCRL(LS,I-1),FL(ML,I),SCRL(LS,I), SCRS(LS,I-1),
     1        S(ML,I),SCRS(LS,I), SCRJ(JJ,I-1),FJ(JJ,I),SCRJ(JJ,I))
            TMX(LS,JJ)=A*B*TMX(LS,JJ)
  521     CONTINUE
  530 CONTINUE
C        CHECK ORTHONORMALITY
      IF (ICFC.LE.1) GO TO 540
      WRITE (IW,53) COUPL(1)
   53 FORMAT (  27H0TRANSFORMATION MATRIX FROM,A6,15H TO JJ COUPLING)
  540 DO 550 L=1,NLS
      DO 550 LP=L,NLS
        SUM=0.D0
        IF (L.EQ.LP) SUM=-1.D0
        DO 543 M=1,NJJ
  543   SUM=SUM+TMX(L,M)*TMX(LP,M)
        IF (DABS(SUM).GE.1.D-7) WRITE (IW,54) L,LP
   54   FORMAT (6H ROWS ,I3, 5H AND ,I3, 16H NOT ORTHONORMAL)
  550 CONTINUE
C
      IF (ICFC.LE.1) GO TO 600
      LPX=0
  560 LPN=LPX+1
      LPX=LPX+11
      IF (LPX.GT.NJJ) LPX=NJJ
      WRITE (IW,55) (FIDJJ(LP,1), LP=LPN,LPX)
   55 FORMAT (//28X, 11(2H (,A7))
      WRITE (IW,56) (LP, LP=LPN,LPX)
   56 FORMAT (26X,11I9)
      WRITE (IW,57)
   57 FORMAT (1H )
      DO 580 L=1,NLS
  580 WRITE (IW,58) NCFG(L),FIDLS(L,1),L, (TMX(L,LP), LP=LPN,LPX)
   58 FORMAT (I11,2X,2H (,A8,I4,2X,11F9.5)
      IF (LPX.LT.NJJ) GO TO 560
  595 CALL CLOCK(TIME)
      DELT=TIME-TIME0
      WRITE (IW,59) SCRJ8,DELT
   59 FORMAT (///' CALCFC, J=',F4.1,5X,5HTIME=,F9.3,4H MIN)
      IF (IW6.LT.0) WRITE (*,59) SCRJ8,DELT
C
C          FORM FINAL COEFFICIENT MATRICES
C
  600 ILC=IL
C     DO 601 NN=1,2
C       WRITE (ILC) SCRJ8,NLS, ((TMX(L,LP),L=1,NLS), LP=1,NLS),
C    1    ((NALS(L,I),SCRL(L,I),SCRS(L,I),
C    2    I=1,NOSUBC), NCFG(L),FIDLS(L,1),FIDJJ(L,1), L=1,NLS)
C 601 ILC=IC
C  *********************************************************** A.KRAMIDA v
      DO 601 NN=1,2
        WRITE (ILC) SCRJ8,NLS, ((NALS(L,I),SCRL(L,I),SCRS(L,I),
     1    I=1,NOSUBC), NCFG(L),FIDLS(L,1),FIDJJ(L,1), L=1,NLS)
        IMSQ=NLS*NLS
        CALL PK1(ILC,NLS,NLS,TMX,KMX,KMX,BUFC,IMSQ,MAXBC)   !,2,IW)
  601 ILC=IC
C  *********************************************************** A.KRAMIDA ^
      ICPTR=ICPTR+2
      NOICWR=NOICWR+2
      NPAR=0
      NC=0
      IF (ICTBCD.LE.0) GO TO 604
      NX=MIN0(N,J1X)
      WRITE (19,61) N,NLS,SCRJ8, COUPL(KCPL), (LLIJK(I,NX,KK),
     1  NIJK(I,NX,KK), I=1,6)
   61 FORMAT (2I6,6H     1,6X,F4.1, 3X,A6,5H CPLG,6X, 2(2X,A1,I2),
     1  1X, 4(1X,A1,I1))
C
  604 NPARO=NPAR
      READ (20) NPAR,KPAR,K20,I,J,AA,CAVE,J1,NOPC, (PC(N1), N1=1,NOPC)
      IF (NPAR.EQ.-7) GO TO 890
      IF (ICTBCD.EQ.0) GO TO 609
      NPARX=NPAR
      IF (NPAR.EQ.NPARO+1) GO TO 609
      NN=-N
      NPAR20=NPAR
      NPAR=NPARO+1
  605 NC=NC+1
      PARNAM(NPAR,KK)=EAV
      DO LP=1,NLS
        DO L=LP,NLS
          C(L,LP)=0.D0
        ENDDO
        C(LP,LP)=0.D0
        IF (NCFG(LP).EQ.NC) C(LP,LP)=1.D0
      ENDDO
      GO TO 805
  609 PARNAM(NPAR,KK)=AA
      J1A=J1
      J1B=J1
  610 DO L=1,NLS
        DO LP=1,L
          C(L,LP)=0.D0
        ENDDO
      ENDDO
      IF (KPAR.GT.0) GO TO 630
      IF (KPAR.EQ.-2) GO TO 680
C
C          FK,GK MATRIX (LOWER TRIANGLE)
C
  620 LX=0
      LMX=0
      M=0
      DO K=1,NDIFFT
        LMX=LMX+NTRMK(K)
        IF (NCFGP(LMX).NE.J1) THEN
          IF (LF(K).GT.0) LX=LX+NTRMK(K)
        ELSE
          IF (LF(K).LE.0) THEN
            M=M+(NTRMK(K)*(NTRMK(K)+1))/2
          ELSE
            LN=LX+1
            LX=LX+NTRMK(K)
            DO L=LN,LX
              DO LP=LN,L
                M=M+1
                C(L,LP)=PC(M)
              ENDDO
            ENDDO
          ENDIF
        ENDIF
      ENDDO
      GO TO 690
C
C          ZETA MATRIX (LOWER TRIANGLE)
C
  630 IF (KCPL.EQ.2) GO TO 640
C          LS COUPLING
      J1V=0
      THRHAF=1.5D0
      SQRT3H=DSQRT(THRHAF)
      DO 639 L=1,NLS
        J=NCFG(L)
        IF (J.NE.J1) GO TO 639
        IF (J1V.EQ.J) GO TO 632
        J1V=J
        LIJ=NOTSJ1(I,J)
        V1(1,1,2)=SQRT3H
        EL=FLLIJK(I,J,KK)
        IF (NIJK(I,J,KK).EQ.1) GO TO 632
        CALL LOCDSK(ID3,EL,NIJK(I,J,KK))
        NOR=(NORCD/2)+2
        DO 631 M=1,NOR
  631   READ (ID3) K, ((V1(II,JJ,2),II=1,NLT), JJ=1,NLT)
  632   DO 638 LP=1,L
          IF (NCFG(LP).NE.J) GO TO 638
          K=NOSUBC
          DO 634 M=1,K
            IF (M.EQ.I) GO TO 633
            IF (NALS(L,M).NE.NALS(LP,M)) GO TO 638
            IF (M.GT.I) GO TO 633
            IF (SCRL(L,M).NE.SCRL(LP,M)) GO TO 638
            IF (SCRS(L,M).NE.SCRS(LP,M)) GO TO 638
            GO TO 634
  633       IF (DABS(SCRL(L,M)-SCRL(LP,M)).GT.1.D0) GO TO 638
            IF (DABS(SCRS(L,M)-SCRS(LP,M)).GT.1.D0) GO TO 638
  634     CONTINUE
          ERAS=1.D0
          II=SCRL(LP,K)+SCRS(L,K)+SCRJ8
          IF (IABG.GE.3) II=SCRL(L,K)+SCRS(LP,K)+SCRJ8
          IF (MOD(II,2).NE.0) ERAS=-1.D0
          ERAS=ERAS*S6J(SCRL(L,K),SCRS(L,K),SCRJ8,SCRS(LP,K),
     1      SCRL(LP,K),ONE)
          IF (I.EQ.K) GO TO 636
          IP1=I+1
          DO 635 M=IP1,K
            LT=NALS(L,M)
  635     ERAS=ERAS*UNCPLA(SCRL(L,M-1),FL(LT,M),SCRL(L,M),1.D0,
     1      SCRL(LP,M-1),SCRL(LP,M))*UNCPLA(SCRS(L,M-1),S(LT,M),
     2      SCRS(L,M),ONE,SCRS(LP,M-1),SCRS(LP,M))
  636     LT=NALS(L,I)
          LR=NALS(LP,I)
          IF (I.GT.1) ERAS=ERAS*UNCPLB(SCRL(L,I-1),FL(LT,I),SCRL(L,I),
     1      ONE,FL(LR,I),SCRL(LP,I))*UNCPLB(SCRS(L,I-1),S(LT,I),
     2      SCRS(L,I),ONE,S(LR,I),SCRS(LP,I))
          C(L,LP)=ERAS*DSQRT(EL*(EL+1.D0)*(2.D0*EL+1.D0))*
     1      V1(LT-LIJ,LR-LIJ,2)
  638   CONTINUE
  639 CONTINUE
      GO TO 690
C          JJ COUPLING
  640 KIX=NDIFFJ(I)
      LX=0
      DO 679 K=1,NDIFSJ
        LN=LX+1
        LX=LX+NSJK(K)
        J=NALSJ(LX,I)
        IF (NCFG(LN).NE.J1) GO TO 679
        ML=1
        MC=1
        DO 643 KI=1,KIX
          IF (NCFGJP(ML,I)-J1) 643,641,644
  641     IF (PJ(ML,I)-FJ(LN,I)) 644,645,642
  642     MC=MC+(NJK(KI,I)*(NJK(KI,I)+1))/2
  643   ML=ML+NJK(KI,I)
  644   WRITE (IW,64) LN,I,FJ(LN,I),ML,MC
   64   FORMAT (//19H0CANNOT FIND PJ=FJ(,I2,1H,,I1,2H)=,F4.1,
     1    5X,3HML=,I4,5X,3HMC=,I4//)
  645   M1=NJK(KI,I)-1
        IF (M1.GT.0) GO TO 655
C              (1 X 1  SUBMATRIX)
        DO LP=LN,LX
          C(LP,LP)=PC(MC)
        ENDDO
        GO TO 679
C              (N X N  SUBMATRIX)
  655   ITEST=NALSJP(ML+1,I)
        DO L=LN,LX
          IF (NALSJ(L,I).EQ.ITEST) GO TO 657
        ENDDO
  657   LDEL=L-LN
  660   ITEST=NALSJP(ML,I)
        DO L0=LN,LX
          IF (NALSJ(L0,I).EQ.ITEST) THEN
            M=MC
            L1=L0+LDEL*M1
            DO L=L0,L1,LDEL
              DO LP=L0,L,LDEL
                C(L,LP)=PC(M)
                M=M+1
              ENDDO
            ENDDO
          ENDIF
        ENDDO
  679 CONTINUE
      GO TO 690
C
C          RK MATRIX (LOWER TRIANGLE)
C
  680 J1A=I
      J1B=J
      LAMN=0
      LAMX=0
      LBMX=0
      DO 682 L=1,NLS
        IF (NCFG(L).LT.J1A) LAMN=L
        IF (NCFG(L).EQ.J1A) LAMX=L
        IF (NCFG(L).LT.J1B) LBMN=L
  682 IF (NCFG(L).EQ.J1B) LBMX=L
      IF (LAMX.EQ.0.OR.LBMX.EQ.0) GO TO 690
      LJ=LAMN
      LAMN=LAMN+1
      LBMN=LBMN+1
      LPJ=LBMN
C
      LN=NTOTTJ(J1A)+1
      LX=NTOTTJ(J1A+1)
      LPN=NTOTTJ(J1B)+1
      LPX=NTOTTJ(J1B+1)
      NOPC=0
      DO 688 LP=LPN,LPX
      DO 688 L=LN,LX
        ITEST=0
        IF (PSCRL(L,NOSUBC).NE.PSCRL(LP,NOSUBC)) ITEST=1
        IF (PSCRS(L,NOSUBC).NE.PSCRS(LP,NOSUBC)) ITEST=1
        IF (ITEST.EQ.0) NOPC=NOPC+1
        IF (DABS(PSCRL(L,NOSUBC)-PSCRS(L,NOSUBC)).GT.SCRJ8) GO TO 688
        IF (DABS(PSCRL(LP,NOSUBC)-PSCRS(LP,NOSUBC)).GT.SCRJ8) GO TO 688
        IF (PSCRL(L,NOSUBC)+PSCRS(L,NOSUBC).LT.SCRJ8) GO TO 688
        IF (PSCRL(LP,NOSUBC)+PSCRS(LP,NOSUBC).LT.SCRJ8) GO TO 688
        LJ=LJ+1
        IF (LJ.LE.LAMX) GO TO 686
        LJ=LAMN
        LPJ=LPJ+1
        IF (LPJ.LE.LBMX) GO TO 686
        WRITE (IW,68) J1A,J1B,L,LP,LJ,LPJ,LAMN,LAMX,LBMN,LBMX,NOPC,
     1    PC(NOPC),LN,LX,LPN,LPX
   68   FORMAT (//17H0***LPJ.GT.LBMX  ,
     1    2I5,3X,4I5,3X,4I5,I10,F15.7,5X,4I5)
  686   IF (ITEST.EQ.0) C(LPJ,LJ)=PC(NOPC)
  688 CONTINUE
C
C
C          COMPLETE MATRIX (UPPER TRIANGLE)
C
  690 DO L=1,NLS
        DO LP=1,L
          C(LP,L)=C(L,LP)
        ENDDO
      ENDDO
C
C          OUTPUT
C
  700 K=KC
      NNN=N
c         Lx=21
c         if (lx.gt.nls) lx=nls
c         write(iw,9801) Npar
c         do LP=1,lx
c           write(IW,9800) (C(L,LP),L=1,lx)
c         enddo
c9800     format(25F11.6)
c9801     format(' writing, NPAR=',I5)
      CALL SPRIN
C
C 800 WRITE (IC) ((C(L,LP),L=LP,NLS), LP=1,NLS)
C  *********************************************** A.KRAMIDA v
      IMSQ=NLS*(NLS+1)/2
  800 CALL PK1(IC,NLS,NLS,C,KMX,KMX,BUFC,IMSQ,MAXBC)   !,3,IW)
      ICPTR=ICPTR+1
C  *********************************************** A.KRAMIDA ^
      NOICWR=NOICWR+1
      IF (ICTBCD.EQ.0) GO TO 604
      NN=N
  805 IF (ICTBCD.GT.0) GO TO 870
C          SET UP MATRIX ELEMENTS FOR ZEEMAN-LABORATORY
C               LEAST-SQUARES PROGRAM (KONFIT)
      IF (NPAR.GT.1) GO TO 870
      I2TO18=2**18
      DO 810 L=1,NLS
        FIERAS=FIDLS(L,1)
        IF (KCPL.EQ.2) FIERAS=FIDJJ(L,1)
C       ENCODE (10,81,IP5(L)) NCFG(L),FIERAS
        WRITE (IR5(L),81) NCFG(L),FIERAS
   81   FORMAT (I1,1H(,A8)
  810 CONTINUE
      N5=NLS
      IF (KCPL.GE.2) GO TO 820
      M=NOSUBC
      DO 815 L=1,NLS
        N5=N5+1
        P5(N5)=0.D0
        IF (SCRJ8.EQ.0.D0) GO TO 815
c       P5(N5)=0.50116D0*(SCRS(L,M)*(SCRS(L,M)+1.D0)-SCRL(L,M)*
c    1    (SCRL(L,M)+1.D0))/(SCRJ8*(SCRJ8+1.D0))+1.50116D0
        P5(N5)=0.50116D0*(SCRS(L,M)*(SCRS(L,M)+1.D0)-SCRL(L,M)*
     1    (SCRL(L,M)+1.D0))
        P5(N5)=P5(N5)/(SCRJ8*(SCRJ8+1.D0))+1.50116D0
  815 CONTINUE
  820 N4=N5
      REWIND 2
      WRITE (2) N4,(P5(K),K=1,N4)
      NCOEFF=0
C
  870 N5=0
      DO 880 LP=1,NLS
        DO 879 L=LP,NLS
          IF (DABS(C(L,LP)).LE.1.D-9) GO TO 879
          IF (ICTBCD.GT.0) GO TO 874
          N5=N5+1
          IP5(N5)=((LP*I2TO18)+L)*I2TO18+NPAR
          P5(N5+1000)=C(L,LP)
          GO TO 879
C              WRITE MATRIX ELEMENTS FOR ARGONNE LEAST-SQUARES PROGRAM
  874     IF (KCPL.LE.1) GO TO 875
          WRITE (19,87) N,LP,L,NPAR,C(L,LP), NALSJ(L,1),FIDJJ(L,1),
     1      PARNAM(NPAR,1)
   87     FORMAT (4I6,F12.7, 2H (,I3,2X,A7, 2X,A8,3X,3(A1,I2,2X) )
          GO TO 879
  875     WRITE(19,88) N,LP,L,NPAR,C(L,LP), NALS(L,1),FIDLS(L,1),
     1      PARNAM(NPAR,1)
   88     FORMAT (4I6,F12.7, 2H (,I3,1X,A8,2X,A8,3X,3(A1,I2,2X) )
  879   CONTINUE
  880 CONTINUE
      IF (ICTBCD.GT.0) GO TO 888
      WRITE (2) N5,(IP5(K),K=1,N5),(P5(K+1000),K=1,N5)
      NCOEFF=NCOEFF+N5
      NPARX=NPAR
  888 IF (NN.GT.0) GO TO 604
      NPARO=NPAR
      NPAR=NPAR+1
      IF (NPAR.EQ.NPAR20) GO TO 609
      GO TO 605
C
  890 IF (ICTBCD.GE.0) GO TO 895
      WRITE (IW,89) SCRJ8,NLS,NCOEFF
   89 FORMAT (1X,F10.1,2I5)
      P5(1)=SCRJ8
      IP5(2)=NLS
      IP5(3)=NCOEFF
C     BUFFER OUT (5,1) (P5(1),P5(3))
C     ITEST=UNIT(5)
      REWIND 2
      READ (2) N4,(P5(K),K=1,N4)
      N6=N4
      DO 892 J=1,NPARX
      READ (2) N5,(P5(K+N6),K=1,N5),(P5(K+N6+NCOEFF),K=1,N5)
  892 N6=N6+N5
      WRITE (IW,90) (P5(K),K=1,NLS)
   90 FORMAT (1X,5A10)
      IF (N4.GT.NLS) WRITE (IW,9089) (P5(K+NLS),K=1,NLS)
 9089 FORMAT (1X,5F10.5)
      N4P1=N4+1
      WRITE (IW,9090) (IP5(K),P5(K+NCOEFF),K=N4P1,N6)
 9090 FORMAT (2(1X,O22,F12.8))
C     BUFFER OUT (5,1) (P5(1),P5(N6+NCOEFF))
C     ITEST5=UNIT(5)
  895 IF (ICTBCD.GT.0)  WRITE (19,14)
C
      CALL CPL37
C
C
  900 CONTINUE
C           WRITE DUMMY RECORD, REQUIRED BY SYSTEM BUG (UPON BACKSPACE)
      WRITE (IL) (PC(I), I=1,20)
C
      REWIND 20
      REWIND IL
      IF (ICTBCD.LE.0) GO TO 950
      M=NOSUBC
      IF (KCPL.NE.1) GO TO 920
      READ (IL)
      DO 915 N=1,NSCRJ8
C     READ (IL) SCRJ8,NLS,((A,L=1,NLS),LP=1,NLS),
C    1  ((A,SCRL(L,I),SCRS(L,I), I=1,M), A,A,A, L=1,NLS)
C************************************************************ A.KRAMIDA v
      READ (IL) SCRJ8,NLS,((A,SCRL(L,I),SCRS(L,I), I=1,M),
     1  A,A,A, L=1,NLS)
      READ (IL)
C************************************************************ A.KRAMIDA ^
      DO 910 L=1,NLS
      PC(L)=0.D0
      IF  (SCRJ8.EQ.0.D0) GO TO 910
      PC(L)=0.50116D0*(SCRS(L,M)*(SCRS(L,M)+1.D0)-SCRL(L,M)*
     1  (SCRL(L,M)+1.D0))/(SCRJ8*(SCRJ8+1.D0))+1.50116D0
  910 CONTINUE
  915 WRITE (19,91) (PC(L),L=1,NLS)
   91 FORMAT (6F12.6)
      REWIND IL
  920 READ (IL)
      DO 930 N=1,NSCRJ8
C       READ (IL) SCRJ8,NLS,((A,L=1,NLS), LP=1,NLS),
C    1    ((A,A,A, I=1,M), A,FIDLS(L,1),FIDJJ(L,1), L=1,NLS)
C********************************************************* A.KRAMIDA v
        READ (IL) SCRJ8,NLS,
     1    ((A,A,A, I=1,M), A,FIDLS(L,1),FIDJJ(L,1), L=1,NLS)
        READ (IL)
C********************************************************* A.KRAMIDA ^
        IF (KCPL.NE.1) GO TO 925
        WRITE (19,92) (FIDLS(L,1), L=1,NLS)
   92   FORMAT (6(2H (,A8,:,2X))
        GO TO 930
  925   WRITE (19,92) (FIDJJ(L,1), L=1,NLS)
  930 CONTINUE
      REWIND IL
      WRITE (19,93) (PARNAM(I,1), I=1,NPARX)
   93 FORMAT (6(2X,A10))
      END FILE 19
      WRITE (IW,96) COUPL(KCPL)
   96 FORMAT (/44H0COEFFICIENT MATRICES WRITTEN ON TAPE 19 IN ,
     1  A6,9H COUPLING)
  950 RETURN
      END
      SUBROUTINE CAFCDOLP(L,K)
C
C          SET UP FINAL COEF MATRICES, AND CALC LS-JJ TRANSF MATRIX
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      PARAMETER (KCC=KISER/4)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3A/ISUBJ(KC),MULS(KS),LHS(KS),
     1  NALS(KMX,KS),NCFG(KMX),NALSJ(KMX,KS),SCRL(KMX,KS),SCRS(KMX,KS),
     2  FJ(KMX,KS),SCRJ(KMX,KS),MUL(KS),LH(KS),LF(KLSC),NSJK(110),
     3  FK(KMX),FKJ(KMX),SCRL6(KMX),SCRS6(KMX),FK6(KMX),LHQQ(KMX),
     4  MULTQQ(KMX),NALSJP(KJP,KS),PJ(KJP,KS),NOICRD
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      COMMON/CC/   C(KMX,KMX)
      COMMON/C3LC2/TMX(KMX,KMX)
      COMMON/C3LC3/CT4(KMX,KMX)
      COMMON/C3LC4/DUMLC4(KMX**2-KCC*8),CC(KCC,8)
      DIMENSION NPARJ(KC,KC)
      EQUIVALENCE (DUMLC4,NPARJ)
      COMMON/C3LCM/MN1,MX1,MN2,MX2,MN3,MX3,MN4,MX4,MN5,MX5,
     1  MN6,MX6,MN7,MX7,MN8,MX8,SJ2,SJ3,SJ4,SJ5,SJ6,SJ7,SJ8
      COMMON/EE/NALSP(KLSC,KS),PSCRL(KLSC,KS),PSCRS(KLSC,KS),
     1  NCFGP(KLSC),NJK(KJK,KS),NCFGJP(KJP,KS)
      DIMENSION PC(KISER),V1(KLSI,KLSI,9),P5(KISER),IP5(KISER)
      EQUIVALENCE (CT4,PC,V1),(CC,P5,IP5)
      DATA TMXH/3HTMX/
      DATA EAV/3HEAV/
C
C
C     KS=8
C     KC=50
C
      DO 325 M1=MN1,MX1
      DO 325 M2=MN2,MX2
      DO 325 M3=MN3,MX3
      DO 325 M4=MN4,MX4
      DO 325 M5=MN5,MX5
      DO 325 M6=MN6,MX6
      DO 325 M7=MN7,MX7
      DO 325 M8=MN8,MX8
      L=L+1
      IF (L.GT.KMX) GO TO 325
      NSJK(K)=NSJK(K)+1
      GO TO (324,323,322,321,318,317,316,315) NOSUBC
  315 SCRJ(L,8)=SJ8
      FJ(L,8)=PJ(M8,8)
      NALSJ(L,8)=NALSJP(M8,8)
  316 SCRJ(L,7)=SJ7
      FJ(L,7)=PJ(M7,7)
      NALSJ(L,7)=NALSJP(M7,7)
  317 SCRJ(L,6)=SJ6
      FJ(L,6)=PJ(M6,6)
      NALSJ(L,6)=NALSJP(M6,6)
  318 SCRJ(L,5)=SJ5
      FJ(L,5)=PJ(M5,5)
      NALSJ(L,5)=NALSJP(M5,5)
  321 SCRJ(L,4)=SJ4
      FJ(L,4)=PJ(M4,4)
      NALSJ(L,4)=NALSJP(M4,4)
  322 SCRJ(L,3)=SJ3
      FJ(L,3)=PJ(M3,3)
      NALSJ(L,3)=NALSJP(M3,3)
  323 SCRJ(L,2)=SJ2
      FJ(L,2)=PJ(M2,2)
      NALSJ(L,2)=NALSJP(M2,2)
  324 SCRJ(L,1)=PJ(M1,1)
      FJ(L,1)=PJ(M1,1)
      NALSJ(L,1)=NALSJP(M1,1)
  325 CONTINUE
      RETURN
      END
C
      SUBROUTINE CPL37
C
C          CALC TRANSF MATRICES FROM LS TO REPRESENTATIONS 3-7
C
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      PARAMETER (KCC=KISER/4)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3A/ISUBJ(KC),MULS(KS),LHS(KS),
     1  NALS(KMX,KS),NCFG(KMX),NALSJ(KMX,KS),SCRL(KMX,KS),SCRS(KMX,KS),
     2  FJ(KMX,KS),SCRJ(KMX,KS), MUL(KS),LH(KS),LF(KLSC),NSJK(110),
     3  FK(KMX),FKJ(KMX),SCRL6(KMX),SCRS6(KMX),FK6(KMX),LHQQ(KMX),
     4  MULTQQ(KMX),NALSJP(KJP,KS),PJ(KJP,KS),NOICRD
      COMMON/CC/   C(KMX,KMX)
      COMMON/C3LC2/TMX(KMX,KMX)
      COMMON/C3LC3/CT4(KMX,KMX)
      COMMON/C3LC4/DUMLC4(KMX**2-KCC*8),CC(KCC,8)
      DIMENSION NPARJ(KC,KC)
      EQUIVALENCE (DUMLC4,NPARJ)
      DIMENSION IQL(KMX),IQM1L(KMX),IQM2L(KMX),SCRJM1(KMX),SCRJM2(KMX)
      CHARACTER*8 FIDLS,FIDJJ,LDES,LDESP,PARNAM,AA,COUPL
      CHARACTER*4 LSYMB,LHQQ,LHS4
      COMMON/CHAR/PARNAM(KPR,2),FIDLS(KMX,2),FIDJJ(KMX,2),LDES(KMX),
     1  LDESP(KMX)
      PARAMETER (MAXBC=50000)
      CHARACTER*12 BUFC
      COMMON/BUFS/BUFC(MAXBC)
C
C
C        CALC TRANSFORMATION MATRICES FROM LS (KCPL=1) OR JJ (KCPL=2) TO
C               FIVE ADDITIONAL COUPLINGS (KCPL1=3,4,5,6,7)
C
  100 IF (NOSUBC.LE.1.OR.NLS.LE.1) GO TO 980
      IF (NLS.GT.NLSMAX) GO TO 980
      KCPL1=3
      IF (KCPL.EQ.1) GO TO 101
      REWIND 2
C     WRITE (2) ((TMX(L,LP),L=1,NLS), LP=1,NLS)
C  ******************************************************** A.KRAMIDA v
      IMSQ=NLS*NLS
      CALL PK1(2,NLS,NLS,TMX,KMX,KMX,BUFC,IMSQ,MAXBC)   !,4,IW)
C  ******************************************************** A.KRAMIDA ^
  101 NMAX=NSCONF(2,KK)
      DO 107 NC=1,NMAX
        IQ=0
        IQM1=0
        IQM2=0
        DO 104 I=1,NOSUBC
          J=NOSUBC-I+1
          IERAS=4.D0*FLLIJK(J,NC,KK)+2.D0
          IF (NIJK(J,NC,KK).EQ.0.OR.NIJK(J,NC,KK).EQ.IERAS) GO TO 104
          IF (IQ.EQ.0) THEN
            IQ=J
            GO TO 104
          ENDIF
          IF (IQM1.EQ.0) THEN
            IQM1=J
            GO TO 104
          ENDIF
          IF (IQM2.EQ.0) IQM2=J
          GO TO 105
  104   CONTINUE
  105   IQM1=MAX0(1,IQM1)
        IQM2=MAX0(1,IQM2)
        DO 106 L=1,NLS
          IF (NCFG(L).NE.NC) GO TO 106
          IQL(L)=IQ
          IQM1L(L)=IQM1
          IQM2L(L)=IQM2
  106   CONTINUE
  107 CONTINUE
      IF (IABG.LT.3) GO TO 110
      DO 109 L=1,NLS
        M=NOSUBC
        I=SCRL(L,M)+SCRS(L,M)-SCRJ8
        IF (MOD(I,2).NE.0) GO TO 109
        DO 108 LP=1,NLS
  108   TMX(L,LP)=-TMX(L,LP)
  109 CONTINUE
C
  110 DO 111 L=1,NLS
  111 LF(L)=0
      IF (KCPLD(KCPL1).LE.0) GO TO 200
      IF (KCPL1.NE.4) GO TO 120
      IF (KCPLD(5)) 200,200,970
  120 IF (KCPL1.NE.6) GO TO 970
  121 IF (KCPLD(7).GT.0) GO TO 970
  200 GO TO (100,100,300,400,500,600,700) KCPL1
C
C          JJJK COUPLING (KCPL1=3)
C
  300 DO 349 L=1,NLS
        IQM1=IQM1L(L)
        IQ=MAX0(IQL(L),IQM1+1)
        SCRJM1(L)=SCRJ(L,IQM1)
        IF (LF(L).NE.0) GO TO 349
        LF(L)=L
        NQ=NALSJ(L,IQ)
        FKK=DMIN1(SCRJ(L,IQM1)+FL(NQ,IQ), SCRJ8+S(NQ,IQ))
        FKJ(L)=FKK
        IF (L.GE.NLS) GO TO 349
        L1=L+1
        DO 339 LP=L1,NLS
          DO I=1,IQ
            IF (NALSJ(L,I).NE.NALSJ(LP,I)) GO TO 339
          ENDDO
          DO I=1,IQM1
            IF (FJ(L,I).NE.FJ(LP,I)) GO TO 339
            IF (SCRJ(L,I).NE.SCRJ(LP,I)) GO TO 339
          ENDDO
          LF(LP)=L
          FKK=FKK-1.D0
          FKJ(LP)=FKK
  339   CONTINUE
  349 CONTINUE
C
      DO 369 L=1,NLS
        IQM1=IQM1L(L)
        IQ=MAX0(IQL(L),IQM1+1)
        NQ=NALSJ(L,IQ)
        FJLQ=FJ(L,IQ)
        FJLQ21=2.D0*FJLQ+1.D0
        FLNQ=FL(NQ,IQ)
        SNQ=S(NQ,IQ)
        I=SCRJ(L,IQM1)+FLNQ+SNQ+SCRJ8+0.001D0
        DO 368 LP=1,NLS
          CT4(L,LP)=TMX(L,LP)
          C(L,LP)=0.D0
          IF(NCFG(L).NE.NCFG(LP)) GO TO 368
          IF (LF(L).NE.LF(LP)) GO TO 368
          A=DSQRT((2.D0*FKJ(LP)+1.D0)*FJLQ21)
          IF (MOD(I,2).NE.0) A=-A
          B=S6J(FKJ(LP),SNQ,SCRJ8,FJLQ,SCRJ(L,IQM1),FLNQ)
          C(L,LP)=A*B
  368   CONTINUE
  369 CONTINUE
      GO TO 900
C
C          LSLK COUPLING (KCPL1=4)
C
  400 DO 449 L=1,NLS
        IQM1=IQM1L(L)
        IQ=MAX0(IQL(L),IQM1+1)
        IF (LF(L).NE.0) GO TO 449
        LF(L)=L
        NQ=NALS(L,IQ)
        FKK=DMIN1(SCRL(L,IQ)+SCRS(L,IQM1), SCRJ8+S(NQ,IQ))
        FK(L)=FKK
        IF (L.GE.NLS) GO TO 449
        L1=L+1
        DO 439 LP=L1,NLS
          DO 425 I=1,IQ
            IF (NALS(L,I).NE.NALS(LP,I)) GO TO 439
  425     CONTINUE
          IF (SCRL(L,IQ).NE.SCRL(LP,IQ)) GO TO 439
          DO 430 I=1,IQM1
          IF (SCRL(L,I).NE.SCRL(LP,I)) GO TO 439
          IF (SCRS(L,I).NE.SCRS(LP,I)) GO TO 439
  430     CONTINUE
          LF(LP)=L
          FKK=FKK-1.D0
          FK(LP)=FKK
  439   CONTINUE
  449 CONTINUE
C
      DO 469 L=1,NLS
        IQM1=IQM1L(L)
        IQ=MAX0(IQL(L),IQM1+1)
        NQ=NALS(L,IQ)
        SNQ=S(NQ,IQ)
        DO 468 LP=1,NLS
          TMX(L,LP)=0.D0
          IF(NCFG(L).NE.NCFG(LP)) GO TO 468
          IF (LF(L).NE.LF(LP)) GO TO 468
          I=SCRL(L,IQ)+SCRS(L,IQM1)+S(NQ,IQ)+SCRJ8+0.001D0
          A=DSQRT((2.D0*FK(LP)+1.D0)*(2.D0*SCRS(L,IQ)+1.D0))
          IF (MOD(I,2).NE.0) A=-A
          B=S6J(FK(LP),SNQ,SCRJ8,SCRS(L,IQ),SCRL(L,IQ),SCRS(L,IQM1))
          TMX(L,LP)=A*B
  468   CONTINUE
  469 CONTINUE
      GO TO 930
C
C          LSJK COUPLING (KCPL1=5)
C
  500 DO 549 L=1,NLS
        IQM1=IQM1L(L)
        IQ=MAX0(IQL(L),IQM1+1)
        IF (LF(L).NE.0) GO TO 549
        LF(L)=L
        NQ=NALS(L,IQ)
        FJJ=DMIN1(SCRL(L,IQM1)+SCRS(L,IQM1), FL(NQ,IQ)+FK(L))
        SCRJ(L,IQM1)=FJJ
        SCRJM1(L)=FJJ
        IF (L.GE.NLS) GO TO 549
        L1=L+1
        DO 539 LP=L1,NLS
          DO 525 I=1,IQ
           IF (NALS(L,I).NE.NALS(LP,I)) GO TO 539
  525     CONTINUE
          IF (FK(L).NE.FK(LP)) GO TO 539
          DO 530 I=1,IQM1
            IF (SCRL(L,I).NE.SCRL(LP,I)) GO TO 539
            IF (SCRS(L,I).NE.SCRS(LP,I)) GO TO 539
  530     CONTINUE
          LF(LP)=L
          FJJ=FJJ-1.D0
          SCRJ(LP,IQM1)=FJJ
          SCRJM1(LP)=FJJ
  539   CONTINUE
  549 CONTINUE
C
      DO 569 L=1,NLS
        IQM1=IQM1L(L)
        IQ=MAX0(IQL(L),IQM1+1)
        SCRLQ1=SCRL(L,IQM1)
        FKL=FK(L)
        SCRLQ=SCRL(L,IQ)
        SCRSQ1=SCRS(L,IQM1)
        DO 568 LP=1,NLS
          CT4(L,LP)=TMX(L,LP)
          C(L,LP)=0.D0
          IF(NCFG(L).NE.NCFG(LP)) GO TO 568
          IF (LF(L).NE.LF(LP)) GO TO 568
          NQ=NALS(LP,IQ)
          I=SCRL(L,IQ)+SCRJ(LP,IQM1)+FL(NQ,IQ)+SCRS(L,IQM1)+0.001D0
          A=DSQRT((2.D0*SCRLQ+1.D0)*(2.D0*SCRJ(LP,IQM1)+1.D0))
          IF (MOD(I,2).NE.0) A=-A
          B=S6J(SCRLQ,SCRSQ1,FKL,SCRJ(LP,IQM1),FL(NQ,IQ),SCRLQ1)
          C(L,LP)=A*B
  568   CONTINUE
  569 CONTINUE
      GO TO 900
C
C          LSJLKS COUPLING (KCPL1=6)
C
C      CALC QU. NOS. FOR KCPL1=6 AND 7 BOTH
  600 DO 646 L=1,NLS
        IQM2=IQM2L(L)
        IQM1=MAX0(IQM1L(L),IQM2+1)
        IQ=MAX0(IQL(L),IQM1+1)
        IF (LF(L).NE.0) GO TO 646
        L1=L
        NQM1=NALS(L,IQM1)
        NQ=NALS(L,IQ)
        NJQ=2.D0*DMIN1(SCRL(L,IQM2),SCRS(L,IQM2))+1.D0
        NLQ=2.D0*DMIN1(FL(NQM1,IQM1),FL(NQ,IQ))+1.D0
        NSQ=2.D0*DMIN1(S(NQM1,IQM1),S(NQ,IQ))+1.D0
        SJQ=SCRL(L,IQM2)+SCRS(L,IQM2)
        DO 645 IJQ=1,NJQ
          SLQ=FL(NQM1,IQM1)+FL(NQ,IQ)
          DO 644 ILQ=1,NLQ
            SSQ=S(NQM1,IQM1)+S(NQ,IQ)
            DO 643 ISQ=1,NSQ
              FKK=SJQ+SLQ+1.D0
              FKMN=DABS(SJQ-SLQ)
              FJJ=SLQ+SSQ+1.D0
              FJMN=DABS(SLQ-SSQ)
  602         FKK=FKK-1.D0
              IF (FKK.LT.FKMN) GO TO 643
              IF (FKK+SSQ-SCRJ8) 643,608,606
  606         IF (DABS(FKK-SSQ).GT.SCRJ8) GO TO 602
  608         FJJ=FJJ-1.D0
              IF (FJJ.LT.FJMN) GO TO 643
              IF (FJJ+SJQ-SCRJ8) 643,615,612
  612         IF (DABS(FJJ-SJQ).GT.SCRJ8) GO TO 608
  615         LF(L1)=L
              SCRJ(L1,IQM2)=SJQ
              SCRJM2(L1)=SJQ
              SCRL6(L1)=SLQ
              FK6(L1)=FKK
              SCRS6(L1)=SSQ
              SCRJ(L1,IQM1)=FJJ
              SCRJM1(L1)=FJJ
              I=SLQ+1.D0
              LHQQ(L1)=LSYMB(I)
              MULTQQ(L1)=2.D0*SSQ+1.D0
              IF (L1.GE.NLS) GO TO 646
              L11=L1+1
              DO 630 LP=L11,NLS
                DO 622 I=1,IQ
                  IF (NALS(LP,I).NE.NALS(L,I)) GO TO 630
  622           CONTINUE
                DO 625 I=1,IQM2
                  IF (SCRL(LP,I).NE.SCRL(L,I)) GO TO 630
                  IF (SCRS(LP,I).NE.SCRS(L,I)) GO TO 630
  625           CONTINUE
                L1=LP
                GO TO 602
  630         CONTINUE
              GO TO 646
  643       SSQ=SSQ-1.D0
  644     SLQ=SLQ-1.D0
  645   SJQ=SJQ-1.D0
  646 CONTINUE
C
      DO 669 L=1,NLS
        IQM2=IQM2L(L)
        IQM1=MAX0(IQM1L(L),IQM2+1)
        IQ=MAX0(IQL(L),IQM1+1)
        NQM1=NALS(L,IQM1)
        NQ=NALS(L,IQ)
        A1=SCRL(L,IQM2)
        A2=SCRS(L,IQM2)
        A4=SCRL(L,IQM1)
        A5=SCRS(L,IQM1)
        A6=SCRL(L,IQ)
        A7=SCRS(L,IQ)
        A8=FL(NQM1,IQM1)
        A9= S(NQM1,IQM1)
        A10=FL(NQ,IQ)
        A11= S(NQ,IQ)
        DO 668 LP=1,NLS
          TMX(L,LP)=0.D0
          IF(NCFG(L).NE.NCFG(LP)) GO TO 668
          IF (LF(L).NE.LF(LP)) GO TO 668
          A3=SCRJ(LP,IQM2)
          A12=FK6(LP)
          A13=SCRL6(LP)
          A14=SCRS6(LP)
          I=A1+A2+A3+A6+A7-SCRJ8
          I=I+A8+A9+A10+A11+A13-A14
c         A=DSQRT((2.D0*A4+1.D0)*(2.D0*A5+1.D0)*(2.D0*A6+1.D0)*
c    1      (2.D0*A7+1.D0)*(2.D0*A13+1.D0)*(2.D0*A14+1.D0)*
c    2      (2.D0*A12+1.D0)*(2.D0*A3+1.D0))
          AAA1=(2.D0*A4+1.D0)*(2.D0*A5+1.D0)*(2.D0*A6+1.D0)
          AAA2=(2.D0*A7+1.D0)*(2.D0*A13+1.D0)*(2.D0*A14+1.D0)
          AAA3=(2.D0*A12+1.D0)*(2.D0*A3+1.D0)
          A=DSQRT(AAA1*AAA2*AAA3)
          IF (MOD(I,2).NE.0) A=-A
          B=S6J(A1,A8,A4, A10,A6,A13) * S6J(A2,A9,A5, A11,A7,A14)
     1      *S6J(A12,A14,SCRJ8, A7,A6,A2) * S6J(A6,A2,A12, A3,A13,A1)
          TMX(L,LP)=A*B
  668   CONTINUE
  669 CONTINUE
      GO TO 930
C
C          LSJ(LSJ) COUPLING (KCPL1=7)
C
  700 DO 769 L=1,NLS
        IQM2=IQM2L(L)
        IQM1=MAX0(IQM1L(L),IQM2+1)
        IQ=MAX0(IQL(L),IQM1+1)
        A1=SCRJ(L,IQM2)
        A2=SCRL6(L)
        A3=FK6(L)
        A4=SCRS6(L)
        DO 768 LP=1,NLS
          CT4(L,LP)=TMX(L,LP)
          C(L,LP)=0.D0
          IF(NCFG(L).NE.NCFG(LP)) GO TO 768
          IF (LF(L).NE.LF(LP)) GO TO 768
          IF (A1.NE.SCRJ(LP,IQM2)) GO TO 768
          IF (A2.NE.SCRL6(LP)) GO TO 768
          IF (A4.NE.SCRS6(LP)) GO TO 768
          A6=SCRJ(LP,IQM1)
          I=A1+A2+A4+SCRJ8
          A=DSQRT((2.D0*A3+1.D0)*(2.D0*A6+1.D0))
          IF (MOD(I,2).NE.0) A=-A
          B=S6J(A1,A2,A3, A4,SCRJ8,A6)
          C(L,LP)=A*B
  768   CONTINUE
  769 CONTINUE
C     GO TO 900
C
C          OUTPUT
C
  900 DO 910 L=1,NLS
        DO 910 LP=1,NLS
          TMX(L,LP)=0.D0
          DO 905 K=1,NLS
  905     TMX(L,LP)=TMX(L,LP)+CT4(L,K)*C(K,LP)
  910 CONTINUE
C
  930 IF (IABG.LT.3) GO TO 935
      DO 934 L=1,NLS
        M=NOSUBC
        I=SCRL(L,M)+SCRS(L,M)-SCRJ8
        IF (MOD(I,2).NE.0) GO TO 934
        DO 933 LP=1,NLS
  933   TMX(L,LP)=-TMX(L,LP)
  934 CONTINUE
  935 IF (KCPL.EQ.1) GO TO 939
      IF (KCPL1.EQ.5.OR.KCPL1.EQ.7) GO TO 939
C          TRANSFORM FROM LS TO JJ REPRESENTATION
      REWIND 2
C     READ (2) ((C(L,LP),L=1,NLS), LP=1,NLS)
C  ******************************************************** A.KRAMIDA v
      IMSQ=NLS*NLS
      CALL UNPK1(2,NLS,NLS,C,KMX,KMX,BUFC,IMSQ,MAXBC)
C  ******************************************************** A.KRAMIDA ^
      DO L=1,NLS
        DO LP=1,NLS
          CT4(L,LP)=TMX(L,LP)
        ENDDO
      ENDDO
      DO L=1,NLS
        DO LP=1,NLS
          DELT=0.D0
          DO LPP=1,NLS
            DELT=DELT+C(LPP,L)*CT4(LPP,LP)
          ENDDO
          TMX(L,LP)=DELT
        ENDDO
      ENDDO
  939 IF (KCPLD(KCPL1).NE.0) GO TO 970
C     WRITE (IC) ((TMX(L,LP), LP=1,NLS),  FK(L),FKJ(L),SCRJM1(L),
C    1  SCRJM2(L),SCRL6(L),FK6(L),SCRS6(L),LHQQ(L),MULTQQ(L),L=1,NLS)
C  ********************************************************* A.KRAMIDA v
      WRITE (IC) (FK(L),FKJ(L),SCRJM1(L),
     1  SCRJM2(L),SCRL6(L),FK6(L),SCRS6(L),LHQQ(L),MULTQQ(L),L=1,NLS)
      IMSQ=NLS*NLS
      CALL PK1(IC,NLS,NLS,TMX,KMX,KMX,BUFC,IMSQ,MAXBC)  !,5,IW)
      ICPTR=ICPTR+2
C  ********************************************************* A.KRAMIDA ^
      NOICWR=NOICWR+2
C
      IF (ICFC.LE.0) GO TO 970
      WRITE (IW,91) COUPL(KCPL),COUPL(KCPL1)
   91 FORMAT (9H0TMX FROM, A6, 5H  TO ,A6,9H COUPLING//)
      LX=0
  940 LN=LX+1
      LX=LX+11
      IF (LX.GT.NLS) LX=NLS
      GO TO (943,943,943,944,945,946,947) KCPL1
  943 WRITE (IW,93) (SCRJM1(L),FKJ(L), L=LN,LX)
   93 FORMAT (28X,11(F4.1,1HK,F4.1))
      GO TO 950
  944 LP1=SCRL(L,NOSUBC)+1.D0
      LHS4=LSYMB(LP1)
      WRITE (IW,94) (LHS4,FK(L), L=LN,LX)
   94 FORMAT (28X,11(2X,A1,1H(,F4.1,1H)))
      GO TO 950
  945 WRITE (IW,93) (SCRJM1(L),FK(L), L=LN,LX)
      GO TO 950
  946 WRITE (IW,96) (SCRJM2(L),LHQQ(L),FK6(L),MULTQQ(L), L=LN,LX)
   96 FORMAT (28X,11(F4.1,A1,F3.1,I1))
      GO TO 950
  947 WRITE (IW,97) (SCRJM2(L),MULTQQ(L),LHQQ(L),SCRJM1(L),
     1    L=LN,LX)
   97 FORMAT (28X,11(F4.1,I1,A1,F3.1))
  950 DO 955 L=1,NLS
      IF (KCPL.EQ.1) GO TO 953
      WRITE (IW,98) NCFG(L),FIDJJ(L,1), L, (TMX(L,LP), LP=LN,LX)
   98 FORMAT (I11,2X,2H (,A7,I4,2X,11F9.5)
      GO TO 955
  953 WRITE (IW,98) NCFG(L),FIDLS(L,1), L, (TMX(L,LP), LP=LN,LX)
  955 CONTINUE
      IF (LX.LT.NLS) GO TO 940
C
  970 KCPL1=KCPL1+1
      IF (KCPL1.LE.4) GO TO 110
      IF (KCPL1-6) 972,110,973
  972 IF (NOSUBC-3) 980,110,110
  973 IF (KCPL1-7) 110,121,980
  980 CALL CLOCK(TIME)
      DELT=TIME-TIME0
      WRITE (IW,99) DELT
   99 FORMAT (11X,5HTIME=,F9.3,4H MIN)
      RETURN
      END
C
C     OVERLAY(G9,7,0)
      SUBROUTINE MUPOLE
C
C
C          COMPUTE MAGNETIC-DIPOLE (II=0), ELECTRIC-DIPOLE (II=1),
C               OR ELECTRIC-QUADRUPOLE (II=2) MATRICES
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      PARAMETER (KCC=KISER/4,KLC4=2*KISER+1,KLC42=KMX**2)
      PARAMETER (KMULT=100)
      COMMON/MAGEE/NMULT,NDUM,NEXP(KMX),SUMS(KMULT),
     1  IALS(KMULT,KS,2),SL(KMULT,KS,2),SS(KMULT,KS,2),NEXPED(KMULT,2),
     2  ETRM(KMULT,2)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2A/SJ8K(2),NOTSJP(KS,100),NCFGP(KMX),NALSP(KMX,KS)
      COMMON/C3A/ISUBJ(KC),MULS(KS),LHS(KS),
     1  NALS(KMX,KS),NCFG(KMX),NALSJ(KMX,KS),SCRL(KMX,KS,2),
     2  SCRS(KMX,KS,2), MUL(KS),LH(KS),LF(KLSC),NSJK(110),
     3  FK(KMX),FKJ(KMX),SCRL6(KMX),SCRS6(KMX),FK6(KMX),LHQQ(KMX),
     4  MULTQQ(KMX),NALSJP(KJP,KS),PJ(KJP,KS),NOICRD
      COMMON/CC/   C(KMX,KMX)
      COMMON/C3LC2/TMX(KMX,KMX)
      COMMON/C3LC3/CT4(KMX,KMX)
      COMMON/C3LC4/DUMLC4(KLC42)
      COMMON/EE/ELEM(3,KC,2),VPAR(KPR,2),AVP(9,2),AVEIG(2),AVCG(2),
     1  NPARK(2),NPAV(KC),    EIG(KMX),ELEM1(3),FNT(9,2),I1,I2
     2  ,IFACT(4),FACT(4)
      COMMON    FL(KMX,KS,2),S(KMX,KS,2),CFP2(KLS1,KLS1),CFP1(KLS1,KLS1)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      DIMENSION TMXP(KMX,KMX),VECT(KMX,KMX)
      EQUIVALENCE (DUMLC4,TMXP)
      DIMENSION U1(KLS1,KLS1),NPARJ(KC,KC)
      EQUIVALENCE (CFP1,U1),(DUMLC4,VECT),(DUMLC4(KLC4),NPARJ)
      CHARACTER*8 FIDMULT(KMULT,2)
      CHARACTER*8 FIDLS,FIDJJ,LDES,LDESP,PARNAM,AA,COUPL
      CHARACTER*4 LSYMB
      COMMON/CHAR/PARNAM(KPR,2),FIDLS(KMX,2),FIDJJ(KMX,2),LDES(KMX),
     1  LDESP(KMX)
      COMMON/CHAR1/FIDMULT
      PARAMETER (MAXBC=50000)
      CHARACTER*12 BUFC
      COMMON/BUFS/BUFC(MAXBC)
C
C
      IRMN1=IRMN+1
      IRMX1=IRMX+1
      RMX=IRMX
      II=IARG1
      IL1=IARG2
      IL2=IARG3
      IX=II
      I1=IL1-ILA+1
      I2=IL2-ILA+1
      DO 990 IR1=IRMN1,IRMX1,2
      R=IR1-1
      SUMS20=0.D0
      SUMS21=0.D0
      REWIND IL1
      READ (IL1) NOTSJ1,NSCRJ8,SJ8MN,SJ8MX,NPAR,NPARJ,PARNAM,
     1  NOTSX, ((FL(L,I,1),S(L,I,1), L=1,NOTSX), I=1,NOSUBC)
      SJ8K(I1)=SJ8MN-1.D0
      REWIND IL2
      READ (IL2) NOTSJP,NSCRJP,SJ8PMN,SJ8PMX,NPAR,NPARJ,PARNAM,
     1  NOTSX, ((FL(L,I,2),S(L,I,2), L=1,NOTSX), I=1,NOSUBC)
      SJ8K(I2)=SJ8PMN-1.D0
      J1A=NSCONF(2,I1)
      J1B=NSCONF(2,I2)
      DO 105 I=1,J1A
      DO 105 J=1,J1B
  105 SOPI2(I,J)=0.D0
      NMULT=0
      DO 106 I=1,KMULT
  106 SUMS(I)=0.D0
C
      NSC=NOSUBC
      SJD=SJ8K(I1)
  110 SJD=SJD+1.D0
      IF (SJD.GT.SJ8MX) GO TO 950
  120 N=SJ8K(I1)-SJD
      IF (N.LT.0) GO TO 126
  122 N=N+1
C     DO 124 I=1,N
C 124 BACKSPACE IL1
      CALL BACK(IL1,2*N)
C 126 READ (IL1) SJ8K(I1),NLS, ((TMX(L,LP),L=1,NLS), LP=1,NLS),
C    1  ((NALS(L,I),SCRL(L,I,1),SCRS(L,I,1),I=1,NSC),
C    2  NCFG(L),FIDLS(L,1),FIDJJ(L,1), L=1,NLS)
C********************************************************* A.KRAMIDA v
  126 READ (IL1) SJ8K(I1),NLS,
     1  ((NALS(L,I),SCRL(L,I,1),SCRS(L,I,1),I=1,NSC),
     2  NCFG(L),FIDLS(L,1),FIDJJ(L,1), L=1,NLS)
      IMSQ=NLS*NLS
      CALL UNPK1(IL1,NLS,NLS,TMX,KMX,KMX,BUFC,IMSQ,MAXBC)
C********************************************************* A.KRAMIDA ^
      IF (SJ8K(I1).NE.SJD) GO TO 120
      Y=100.D0
      DO 127 I=IRMN1,IRMX1,2
      R1=I-1
      X=DABS(SJD-R1)
      IF (X.LE.Y) Y=X
  127 CONTINUE
      IF (II.EQ.0) Y=DABS(SJD-1.D0)
  128 X=0.D0
      IF (I1.EQ.I2) X=SJD
      SJPD=DMAX1(SJ8PMN,Y,X)
      GO TO 135
  130 SJPD=SJPD+1.D0
      IF (SJD.EQ.0.D0) SJPD=SJPD+1.D0
  135 IF (SJPD.GT.DMIN1(SJD+RMX,SJ8PMX)) GO TO 110
  140 N=SJ8K(I2)-SJPD
      IF (N.LT.0) GO TO 146
  142 N=N+1
C     DO 144 I=1,N
C 144 BACKSPACE IL2
      CALL BACK(IL2,2*N)
C 146 READ (IL2) SJ8K(I2),NLSP, ((TMXP(L,LP),L=1,NLSP), LP=1,NLSP),
C    1  ((NALSP(L,I),SCRL(L,I,2),SCRS(L,I,2),I=1,NSC),
C    2  NCFGP(L),FIDLS(L,2),FIDJJ(L,2), L=1,NLSP)
  146 READ (IL2) SJ8K(I2),NLSP, 
     1  ((NALSP(L,I),SCRL(L,I,2),SCRS(L,I,2),I=1,NSC),
     2  NCFGP(L),FIDLS(L,2),FIDJJ(L,2), L=1,NLSP)
      IMSQ=NLSP*NLSP
      CALL UNPK1(IL2,NLSP,NLSP,TMXP,KMX,KMX,BUFC,IMSQ,MAXBC)
      IF (SJ8K(I2).NE.SJPD) GO TO 140
C
C
  150 NCO=0
      NCPO=0
      DO 879 L=1,NLS
      NC=NCFG(L)
      DO 878 LP=1,NLSP
      NCP=NCFGP(LP)
      C(L,LP)=0.D0
      IF (II.GT.0) GO TO 300
C
C          CALC MAGNETIC DIPOLE ELEMENT
C
  200 IF (NC.NE.NCP) GO TO 878
      DO 210 I=1,NOSUBC
      IF (NALS(L,I).NE.NALSP(LP,I)) GO TO 878
      IF (SCRL(L,I,1).NE.SCRL(LP,I,2)) GO TO 878
  210 IF (SCRS(L,I,1).NE.SCRS(LP,I,2)) GO TO 878
      A1=SCRL(L,NOSUBC,1)
      A2=SCRS(L,NOSUBC,1)
      TC=1.00232D0*UNCPLB(A1,A2,SJD,ONE,A2,SJPD)
     1  *DSQRT(A2*(A2+1.D0)*(2.D0*A2+1.D0))
      IF (SJD.EQ.SJPD) TC=TC+DSQRT(SJD*(SJD+1.D0)*(2.D0*SJD+1.D0))
      GO TO 700
C
C          CALC ELECTRIC MULTIPOLE ELEMENT
C
  300 IF (NC.EQ.NCO.AND.NCP.EQ.NCPO) GO TO 400
C
C          DETERMINE WHETHER A TRANSITION IS POSSIBLE (ITRANS.NE.0)
C
      ITRANT=ITRANS
      IT=I
      JT=J
      ITRANS=0
      DO 340 IRHO=1,NOSUBC
      DO 340 IRHOP=1,NOSUBC
      DO 302 I=1,NOSUBC
      IF (I.EQ.IRHO.OR.I.EQ.IRHOP) GO TO 302
      IF (NIJK(I,NC,I1)+NIJK(I,NCP,I2).EQ.0) GO TO 302
      IF (FLLIJK(I,NC,I1).NE.FLLIJK(I,NCP,I2)) GO TO 340
      IF (NIJK(I,NC,I1).NE.NIJK(I,NCP,I2)) GO TO 340
  302 CONTINUE
      IF (IRHO.NE.IRHOP) GO TO 320
      IF (IL1.NE.IL2.OR.NC.NE.NCP) GO TO 305
      DO 304 I=IRHO,NOSUBC
      IERAS=4.D0*FLLIJK(I,NC,I1)+2.D0
      NN=NIJK(I,NC,I1)
      IF ((NN.EQ.0.OR.NN.EQ.IERAS).AND.I.EQ.IRHO) GO TO 340
      IF (I.EQ.IRHO) GO TO 304
      IF (NN.EQ.0.OR.NN.EQ.IERAS) GO TO 304
      IF (FLLIJK(I,NC,I1).EQ.0.D0) GO TO 304
      GO TO 340
  304 CONTINUE
      GO TO 320
  305 NN=0
      DO 310 I=IRHO,NOSUBC
  310 NN=NN+NIJK(I,NC,I1)+NIJK(I,NCP,I2)
      IF (NN.GT.2) GO TO 340
  320 A=FLLIJK(IRHO,NC,I1)+FLLIJK(IRHOP,NCP,I2)
      IF (DMOD(A+R,TWO).NE.ZERO) GO TO 340
      IF (A.LT.R) GO TO 340
      IF (DABS(FLLIJK(IRHO,NC,I1)-FLLIJK(IRHOP,NCP,I2)).GT.R) GO TO 340
      DO 325 I=1,NOSUBC
      N=NIJK(I,NC,I1)
      IF (I.EQ.IRHO) N=N-1
      M=NIJK(I,NCP,I2)
      IF (I.EQ.IRHOP) M=M-1
      IF (N.NE.M) GO TO 340
      IF (N.LT.0) GO TO 340
  325 CONTINUE
      GO TO 350
  340 CONTINUE
      ITRANS=ITRANT
      I=IT
      J=JT
      GO TO 878
C
C          CALCULATE THEORETICAL S/P2
C
  350 NCO=NC
      NCPO=NCP
      IF (SOPI2(NC,NCP).NE.0.D0) GO TO 355
      ERAS=2.D0
      DO 354 I=1,NOSUBC
      B=NIJK(I,NC,I1)
      B1=NIJK(I,NCP,I2)
      IF (B.GE.B1) GO TO 351
      A=4.D0*FLLIJK(I,NCP,I2)+1.D0
      GO TO 354
  351 A=4.D0*FLLIJK(I,NC,I1)+2.D0
      IF (I.NE.IRHO) GO TO 354
      IF (I1.NE.I2.OR.NC.NE.NCP) GO TO 353
      ERAS=ERAS*B*(A-B)/(A*(A-1.D0))
      GO TO 354
  353 A=A-1.D0
      B=B-1.D0
  354 ERAS=ERAS*FCTRL(A)/(FCTRL(B)*FCTRL(A-B))
      SOPI2(NC,NCP)=ERAS
      IF (I1.EQ.I2) SOPI2(NCP,NC)=ERAS
C
C          DETERMINE WHETHER CONFIGS ARE TO BE INTERCHANGED (ITRANS=-1)
C
  355 I=MIN0(IRHO,IRHOP)
      J=MAX0(IRHO,IRHOP)
      M=NIJK(IRHO,NC,I1)
      N=NIJK(IRHOP,NCP,I2)
      ITRANS=1
      TC0=1.D0
      IF (IL1.EQ.IL2.AND.NC.EQ.NCP) GO TO 370
      A=M*N
      TC0=DSQRT(A)
      IF (IRHO.GT.IRHOP) N=M
      M=0
      DO 360 K=I,J
      IF (K.NE.I.AND.K.NE.J) M=M+NIJK(K,NC,I1)
  360 CONTINUE
      IF (MOD(M+N,2).EQ.0) TC0=-TC0
      IF (I.NE.IRHO) ITRANS=-1
      IF (ITRANS.GT.0) GO TO 370
      IF (DMOD(DABS(SJPD-SJD+R),TWO).NE.ZERO) TC0=-TC0
C
C          READ CFP FROM DISK 12, OR U2 FROM DISK 13 (FOR E2 TRANSITIONS),
C               OR READ U0, U2, U4,... (FOR PLANE-WAVE-BORN CALCULATIONS)
C
  370 N=NIJK(IRHO,NC,I1)
      ALL=FLLIJK(IRHO,NC,I1)
      IF (I.EQ.J) GO TO 390
      III=1
  375 IF (N.LE.2) GO TO 385
      CALL LOCDSK(ID2,ALL,N)
      READ (ID2) (IA,IA,IA,A,A, M=1,NLT), NLP
      IF (III.EQ.1.AND.ITRANS.EQ.(-1)) GO TO 380
      IF (III.EQ.2.AND.ITRANS.EQ.1) GO TO 380
      READ (ID2) ((CFP1(K,M), K=1,NLT), M=1,NLP)
      GO TO 385
  380 READ (ID2) ((CFP2(K,M), K=1,NLT), M=1,NLP)
  385 IF (III.EQ.2) GO TO 400
      N=NIJK(IRHOP,NCP,I2)
      ALL=FLLIJK(IRHOP,NCP,I2)
      III=2
      GO TO 375
C
  390 IF (N.LT.2) GO TO 400
      CALL LOCDSK(ID3,ALL,N)
      IF (IR1.LE.1) GO TO 396
      DO 394 K=2,IR1
  394 READ (ID3)
  396 READ (ID3) K73, ((U1(K,M), K=1,NLT), M=1,NLT)
C
C
C
  400 IF (ITRANS) 410,878,405
  405 L1=L
      L2=LP
      NC1=NC
      NC2=NCP
      J1=I1
      J2=I2
      K1=1
      K2=2
      SJ1=SJD
      SJ2=SJPD
      GO TO 420
  410 L1=LP
      L2=L
      NC1=NCP
      NC2=NC
      J1=I2
      J2=I1
      K1=2
      K2=1
      SJ1=SJPD
      SJ2=SJD
C        TEST SELECTION RULES
  420 DO 430 M=1,NOSUBC
      A=DABS(SCRL(L,M,1)-SCRL(LP,M,2))
      B=SCRL(L,M,1)+SCRL(LP,M,2)
      IF (M.GE.J) GO TO 426
      IF (M.LT.I) GO TO 424
      IF (A.GT.FLLIJK(I,NC1,J1)) GO TO 878
      IF (B.LT.FLLIJK(I,NC1,J1)) GO TO 878
      IF (M.EQ.I) GO TO 430
      GO TO 428
  424 IF (A.NE.0.D0) GO TO 878
      GO TO 427
  426 IF (A.GT.R) GO TO 878
      IF (B.LT.R) GO TO 878
  427 IF (SCRS(L,M,1).NE.SCRS(LP,M,2)) GO TO 878
      IF (M.EQ.J) GO TO 430
  428 IF (NALS(L,M)-NOTSJ1(M,NC).NE.NALSP(LP,M)-NOTSJP(M,NCP)) GO TO 878
  430 CONTINUE
C
  450 TC=TC0
      A1=SCRL(L1,NOSUBC,K1)
      A2=SCRL(L2,NOSUBC,K2)
      A3=SCRS(L1,NOSUBC,K1)
      TC=TC*UNCPLA(A1,A3,SJ1, R,A2,SJ2)
C
      MN=J+1
      IF (MN.GT.NOSUBC) GO TO 460
      DO 455 M=MN,NOSUBC
      A1=SCRL(L1,M-1,K1)
      A2=SCRL(L1,M,K1)
      A3=SCRL(L2,M,K2)
      N1=NALS(L,M)
      A4=FL(N1,M,1)
  455 TC=TC*UNCPLA(A1,A4,A2, R,SCRL(L2,M-1,K2),A3)
C
  460 IF (IL1.EQ.IL2.AND.NC.EQ.NCP) GO TO 600
C
C          COMPLETE CALCULATION FOR NON-CONF-DIAG CASE
C
  500 IF (NIJK(I,NC1,J1).LE.2) GO TO 510
      N1=NALS(L,I)-NOTSJ1(I,NC)
      N2=NALSP(LP,I)-NOTSJP(I,NCP)
      A=CFP1(N1,N2)
      IF (ITRANS.LT.0) A=CFP1(N2,N1)
      TC=TC*A
  510 IF (NIJK(J,NC2,J2).LE.2) GO TO 520
      N1=NALS(L,J)-NOTSJ1(J,NC)
      N2=NALSP(LP,J)-NOTSJP(J,NCP)
      A=CFP2(N1,N2)
      IF (ITRANS.GT.0) A=CFP2(N2,N1)
      TC=TC*A
C
  520 FLI=FLLIJK(I,NC1,J1)
      IF (I.EQ.1) GO TO 530
      IF (NIJK(I,NC1,J1).EQ.1) GO TO 530
      A1=SCRL(L1,I-1,K1)
      A2=SCRL(L1,I,K1)
      A3=SCRL(L2,I,K2)
      N1=NALS(L,I)
      N2=NALSP(LP,I)
      IF (ITRANS.GT.0) GO TO 522
      N1=N2
      N2=NALS(L,I)
  522 A4=FL(N1,I,J1)
      A5=FL(N2,I,J2)
      B1=SCRS(L1,I-1,K1)
      B2=SCRS(L1,I,K1)
      B3=SCRS(L2,I,K2)
      B4=S(N1,I,J1)
      B5=S(N2,I,J2)
      TC=TC*RECPSH(A1,A5,A3,FLI,A2,A4)*RECPSH(B1,B5,B3,HALF,B2,B4)
C
  530 MN=I+1
      MX=J-1
      IF (MN.GT.MX) GO TO 540
      DO 539 M=MN,MX
      A1=SCRL(L1,M-1,K1)
      A2=SCRL(L2,M-1,K2)
      A3=SCRL(L1,M,K1)
      A4=SCRL(L2,M,K2)
      N1=NALS(L,M)
      A5=FL(N1,M,1)
      B1=SCRS(L1,M-1,K1)
      B2=SCRS(L2,M-1,K2)
      B3=SCRS(L1,M,K1)
      B4=SCRS(L2,M,K2)
      B5=S(N1,M,1)
  539 TC=TC*RECPEX(A2,FLI,A1,A5,A3,A4)*RECPEX(B2,HALF,B1,B5,B3,B4)
C
  540 FLJ=FLLIJK(J,NC2,J2)
      N1=NALS(L,J)
      N2=NALSP(LP,J)
      IF (ITRANS.GT.0) GO TO 542
      N1=N2
      N2=NALS(L,J)
  542 A1=SCRL(L1,J-1,K1)
      A2=SCRL(L2,J-1,K2)
      A3=SCRL(L1,J,K1)
      A4=SCRL(L2,J,K2)
      IF (I.EQ.J) GO TO 560
      A5=FL(N1,J,J1)
      A6=FL(N2,J,J2)
      B5=S(N1,J,J1)
      IF (B5.EQ.0.D0) GO TO 550
      B1=SCRS(L1,J-1,K1)
      B2=SCRS(L2,J-1,K2)
      B3=SCRS(L1,J,K1)
      B6=S(N2,J,J2)
      TC=TC*RECPJP(B2,HALF,B1,B5,B3,B6)
  550 IF (A5.EQ.0.D0) GO TO 560
      IF (DMOD(FLJ+A5-A6,TWO).NE.ZERO) TC=-TC
      TC=TC*DSQRT((2.D0*A1+1.D0)*(2.D0*A6+1.D0)*(2.D0*A3+1.D0)*
     1  (2.D0*A4+1.D0))
      TC=TC*S9J(A1,A2,FLI, A5,A6,FLJ, A3,A4,R)
      GO TO 700
  560 IF (J.EQ.1) GO TO 700
      IF (A2.EQ.0.D0) GO TO 700
      TC=TC*UNCPLB(A2,FLI,A3, R,FLJ,A4)
      GO TO 700
C
C          COMPLETE CALCULATION FOR CONF-DIAG CASE
C
  600 IF (I.EQ.1) GO TO 620
      N1=NALS(L,I)
      N2=NALSP(LP,I)
  610 A1=SCRL(L1,I-1,K1)
      A3=SCRL(L1,I,K1)
      A4=SCRL(L2,I,K2)
      A5=FL(N1,I,1)
      A6=FL(N2,I,2)
      TC=TC*UNCPLB(A1,A5,A3, R,A6,A4)
  620 IF (NIJK(I,NC1,J1).EQ.1) GO TO 700
      N1=NALS(L,I)-NOTSJ1(I,NC)
      N2=NALSP(LP,I)-NOTSJP(I,NCP)
      TC=TC*U1(N1,N2)
C
  700 A1=TC*TC
      SUMS21=SUMS21+A1
      IF (I1.NE.I2) GO TO 720
      IF (SJD.NE.SJPD) GO TO 710
      IF (L.LE.LP) GO TO 725
      GO TO 720
  710 SUMS21=SUMS21+A1
  720 SUMS20=SUMS20+A1
  725 IF (IABG.LT.3) GO TO 730
      M=NOSUBC
      IPP=SCRL(L,M,1)+SCRS(L,M,1)-SJD+SCRL(LP,M,2)+SCRS(LP,M,2)-SJPD
      IF (MOD(IPP,2).NE.0) TC=-TC
  730 C(L,LP)=TC
C
C          SUM LINE STRENGTH FOR EACH MULTIPLET (SPECIAL FOR MAGEE)
C
      IF (IELPUN.LT.2) GO TO 878
      IF (A1.LE.0.D0) GO TO 878
      IF (NMULT.EQ.0) GO TO 830
      DO 820 NN=1,NMULT
      DO 810 JJ=1,KS
      IF (NALS(L,JJ).NE.IALS(NN,JJ,1).OR.NALSP(LP,JJ).NE.IALS(NN,JJ,2))
     1  GO TO 820
      IF (SCRL(L,JJ,1).NE.SL(NN,JJ,1).OR.SCRL(LP,JJ,2).NE.SL(NN,JJ,2))
     1  GO TO 820
      IF (SCRS(L,JJ,1).NE.SS(NN,JJ,1).OR.SCRS(LP,JJ,2).NE.SS(NN,JJ,2))
     1  GO TO 820
  810 CONTINUE
      SUMS(NN)=SUMS(NN)+A1
      GO TO 878
  820 CONTINUE
  830 NMULT=NMULT+1
      IF (NMULT.LE.KMULT) GO TO 832
      WRITE (IW,83) NMULT,KMULT
   83 FORMAT ('0*****NMULT=',I3,'  GREATER THAN DIMENSION KMULT=',I3)
      STOP '(MUPOLE 83)'
  832 NN=NMULT
      DO 840 JJ=1,KS
      IALS(NN,JJ,1)=NALS(L,JJ)
      IALS(NN,JJ,2)=NALSP(LP,JJ)
      SL(NN,JJ,1)=SCRL(L,JJ,1)
      SL(NN,JJ,2)=SCRL(LP,JJ,2)
      SS(NN,JJ,1)=SCRS(L,JJ,1)
      SS(NN,JJ,2)=SCRS(LP,JJ,2)
      SUMS(NN)=A1
      FIDMULT(NN,1)=FIDLS(L,1)
      FIDMULT(NN,2)=FIDLS(LP,2)
      NEXPED(NN,1)=0.D0
      NEXPED(NN,2)=0.D0
  840 CONTINUE
C
  878 CONTINUE
  879 CONTINUE
C
C          OUTPUT (TRANSFORM TO JJ COUPLING IF NECESSARY)
C
  900 KPAR=2
      SCRJ8=SJD
      SCRJ8P=SJPD
      CALL SPRIN
C
  925 GO TO 130
C
C          WRITE DUMMY RECORD
C
  950 SCRJ8=-7.D0
      NLS=1
C     WRITE (IC) SCRJ8,SCRJ8,NLS,NLS, C(1,1), NCFG,NCFGP
C****************************************************** A.KRAMIDA v
      WRITE (IC) SCRJ8,SCRJ8,NLS,NLS,NCFG,NCFGP
      IMSQ=NLS*NLS
      CALL PK1(IC,NLS,NLS,C,KMX,KMX,BUFC,IMSQ,MAXBC)   !,6,IW)
      ICPTR=ICPTR+2
C****************************************************** A.KRAMIDA ^
      NOICWR=NOICWR+2
      NOICMUP(KK)=NOICMUP(KK)+2
      REWIND IL1
      REWIND IL2
      J1X=NSCONF(2,I1)
      J2X=NSCONF(2,I2)
      SSOPI2=0.D0
      DO 958 NC=1,J1X
      DO 958 NCP=1,J2X
  958 SSOPI2=SSOPI2+SOPI2(NC,NCP)
      WRITE (IW,92) SUMS21,SUMS20,SSOPI2
   92 FORMAT (///15H0SUMS21,SUMS20=,2F12.5/8X,7HSSOPI2=,F12.5//)
      DO 960 I=1,J1X
  960 WRITE (IW,93) (SOPI2(I,J), J=1,J2X)
   93 FORMAT (45X,9F8.3)
      IF (II.EQ.0) SOPI2(1,1)=SUMS21
C     WRITE (IC) SOPI2
C****************************************************** A.KRAMIDA v
      IMSQ=KC*KC
      CALL PK1(IC,KC,KC,SOPI2,KC,KC,BUFC,IMSQ,MAXBC)   !,7,IW)
      ICPTR=ICPTR+1
C****************************************************** A.KRAMIDA ^
      NOICWR=NOICWR+1
      NOICMUP(KK)=NOICMUP(KK)+1
  990 CONTINUE
      RETURN
      END
C
C     OVERLAY(G9,10,0)
      SUBROUTINE ENERGY
C
C          READ PARAMETER VALUES, CALC ENERGY MATRICES, AND DIAGONALIZE
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      PARAMETER (KCC=KISER/4,KLC4=2*KISER+1,KLC42=KMX**2,KEXC=40)
      PARAMETER (KBGKS=41,KENRGS=21,KCASE=50,KTRAN=600,KLAM=10000)
      PARAMETER (KMULT=100)
      COMMON/MAGEE/NMULT,NDUM,NEXP(KMX),SUMS(KMULT),
     1  IALS(KMULT,KS,2),SL(KMULT,KS,2),SS(KMULT,KS,2),NEXPED(KMULT,2),
     2  ETRM(KMULT,2)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3A/ISUBJ(KC),MULS(KS),LHS(KS),
     1  NALS(KMX,KS),NCFG(KMX),NALSJ(KMX,KS),SCRL(KMX,KS),SCRS(KMX,KS),
     2  FJ(KMX,KS),SCRJ(KMX,KS), MUL(KS),LH(KS),LF(KLSC),NSJK(110),
     3  FK(KMX),FKJ(KMX),SCRL6(KMX),SCRS6(KMX),FK6(KMX),LHQQ(KMX),
     4  MULTQQ(KMX),NALSJP(KJP,KS),PJ(KJP,KS),NOICRD
      COMMON/CC/   C(KMX,KMX)
      COMMON/C3LC2/TMX(KMX,KMX)
      COMMON/C3LC3/CT4(KMX,KMX)
      COMMON/C3LC4/DUMLC4(KLC42)
C     COMMON/C3LC5/CI(KMX,KMX)
      DIMENSION CI(KMX,KMX)
      EQUIVALENCE (CI,TMX)
      COMMON/C3LC6/GAAXC(KMX,KEXC),BRNCHX(KEXC,KEXC)
      COMMON/EE/ELEM(3,KC,2),VPAR(KPR,2),AVP(9,2),AVEIG(2),AVCG(2),
     1  NPARK(2),NPAV(KC),    EIG(KMX),ELEM1(3),FNT(9,2),I1,I2,
     2  IFACT(4),FACT(4),LCSER(KMX),X(KMX)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      COMMON/C6/EMIN,EMAX,SUMWT,FLBDN,FLBDX,FNUNP,FNUXP,NLEV,IEWR
      DIMENSION VECT(KMX,KMX),NPARJ(KC,KC),DELE(KMX),ENK(2),EXK(2)
      EQUIVALENCE (DUMLC4(KLC4),NPARJ),(DELE,CT4)
      DIMENSION CPURTY(KMX,KC),NLCFGJ(KC),NSCFGJ(KC)
      DIMENSION AA(KMX,KMX),CII(KMX,KMX),JPAR(KPR)
      EQUIVALENCE (CT4,AA,CPURTY),(DUMLC4,VECT,CII,JPAR)
      EQUIVALENCE (DUMLC4,NLCFGJ),(DUMLC4(500),NSCFGJ)
      COMMON/C7/G1,SUMGAA,SUMGAR,SUMGAAT
      COMMON/C8/EXC(KEXC),JEXC(KEXC),MEXC(KEXC)
      COMMON/C9/L1,L2,CFLAG(KC,2),CGENGY(KC,2),SWT(KC,2),IMAX
      COMMON/PWBORN/NBIGKS,NENRGS,EKMINL,EKMAXL,DELEKL,BIGKS(KBGKS),
     1  XMIN,XMAX,TEV(25),CORR(KENRGS),IBK,IPWR,I11
      COMMON/ENERGIES/ETOT(KC,2),EE8(KC,2),E0KIN(KC),EKIN(KMX)
      CHARACTER*8 LDESN(KMX),FIDMULT(KMULT,2),ELEM,ELEM1
      CHARACTER*8 FIDLS,FIDJJ,LDES,LDESP,PARNAM,COUPL,CFLAG
      CHARACTER LSYMB*4,BLNK*1,STAR*1
      COMMON/CHAR/PARNAM(KPR,2),FIDLS(KMX,2),FIDJJ(KMX,2),LDES(KMX),
     1  LDESP(KMX)
      COMMON/CHAR1/FIDMULT
      EQUIVALENCE (ELEM(1,1,1),IELEM)
      PARAMETER (MAXBC=50000)
      CHARACTER*12 BUFC
      COMMON/BUFS/BUFC(MAXBC)
      DATA BLNK,STAR/1H ,1H*/
C
C     KS=8
C     KMX=260
C     KEXC=40
      IKKK=KCPLD(8)
      IF (NLSMAX.NE.0) IKKK=0
      IPRINT=KCPLD(9)
      DO 99 I=1,594
   99 ELEM(I,1,1)=BLNK
      IEWR=0
C
C          READ QUANTUM NUMBERS
C
  100 IL=ILA
      IE=ILA
      NLSX=0
      K=1
      G1AA=0.D0
      SUMGAA=0.D0
      SUMGAAT=0.D0
      REWIND IC
      ICPTR=0
  101 REWIND IE
      READ (IC) NOTSJ1,NSCRJ8,SJ8MN,SJ8MX,NPAR,NPARJ,PARNAM
      ICPTR=ICPTR+1
      ICRD=1
      KK=K
C
C          READ PARAMETER VALUES
      IF (IPRINT.GE.7) GO TO 102
      WRITE (IW,12)
   12 FORMAT (1H1)
  102 IXC=0
      IXC1=1
      NLST=0
      DO I=1,KEXC
        JEXC(I)=KEXC+1
        EXC(I)=0.D0
      ENDDO
C
      J1X=NSCONF(2,K)
      NPAR0=1
      DO 131 I=1,J1X
      NPAV(I)=NPAR0
      NPAR1=NPAR0+1
      NPAR4=NPAR0+4
      NPARSN=NPARJ(I,I)+NPAR0-1
  105 READ (IR,10) (ELEM1(N),N=1,3), X(NPAR0),
     1  (X(N),JPAR(N),N=NPAR1,NPAR4),TYPE,IFACT
   10 FORMAT (2A6,A7,1X,F10.5,4(F9.4,I1),A2,4I2)
      IF (NPAR0+K.NE.2) GO TO 109
      IF (ELEM1(1)(1:6).NE.'    0 ') GO TO 109
C          INTERPRET AS A RESCALE CARD
      DELEAV=X(1)
      IERAS=10000.D0*X(2)+0.2D0
      IERAS=10*IERAS+JPAR(2)
      DO 107 J=1,5
        II=IERAS/100
        JJ=IERAS-100*II
        IF (JJ.EQ.99) JJ=100
        ERAS=DFLOAT(JJ)
        IF (ERAS.GT.0.D0.AND.ERAS.LT.1.5D0) ERAS=0.1D0
        FACT0(6-J)=0.01D0*ERAS
  107 IERAS=II
      ERAS=X(4)
      IF (ERAS.LE.0.D0) GO TO 108
      SCALE=SCALE*UENRGY/ERAS
      UENRGY=ERAS
      GO TO 105
  108 UENRGY=SCALE*UENRGY
      SCALE=1.D0
      GO TO 105
C
  109 IF (X(NPAR0).LT.-90000000.D0) GO TO 900
      IF (X(NPAR0).LT.-50000000.D0) GO TO 800
      IF (X(NPAR0).LT.-30000000.D0) GO TO 100
      DO 112 N=1,3
  112 ELEM(N,I,K)=ELEM1(N)
      DO 114 J=1,5
  114 VPAR(NPAR0+J-1,K)=X(NPAR0+J-1)
      IF (NPARJ(I,I).LE.5) GO TO 120
      NPAR5=NPAR4+1
      READ (IR,11) (VPAR(N,K),JPAR(N),N=NPAR5,NPARSN)
   11 FORMAT (7(F9.4,I1))
  120 DO 121 J=1,4
        IF (IFACT(J).EQ.99.OR.IFACT(J).EQ.0) IFACT(J)=100
        ERAS=IFACT(J)
  121 FACT(J)=0.01D0*ERAS
C          SHIFT EAV AND/OR RESCALE SINGLE-CONFIGURATION PARAMETERS
      N1=NPAR1
      ERAS=VPAR(NPAR0,K)
      IF (ERAS.LE.-4000.D0) GO TO 123
      VPAR(NPAR0,K)=ERAS+DELEAV
      N1=NPAR0
  123 DO 125 N=N1,NPARSN
  125 VPAR(N,K)=SCALE*VPAR(N,K)
      IF (NPAR1.GT.NPARSN) GO TO 127
      DO 126 N=NPAR1,NPARSN
        J=JPAR(N)
        IF (J.LT.1.OR.J.GT.4) GO TO 126
        IF (FACT0(J).EQ.0.D0) GO TO 126
        VPAR(N,K)=VPAR(N,K)*FACT0(J)/FACT(J)
  126 CONTINUE
  127 DO 128 J=1,4
        IF (FACT0(J).GT.0.D0) FACT(J)=FACT0(J)
  128 CONTINUE
      E0KIN(I)=0.D0
      IF (VPAR(NPAR0,K).GT.-4000.D0) GO TO 130
      ERAS=EE8(I,K)
      ERAS=ERAS*109737.0/UENRGY
      E0KIN(I)=ETOT(1,1)-ETOT(I,K)+ERAS+VPAR(NPAR0,K)
C
  130 WRITE (IW,13) (ELEM(N,I,K),N=1,3),UENRGY,TYPE,FACT,
     1  I, (LLIJK(L,I,K),NIJK(L,I,K), L=1,NOSUBC)
   13 FORMAT (//1X,3A6,4X,20HPARAMETER VALUES IN ,F7.1,7H CM-1 (,
     1  A2,6H TIMES,4F5.2,1H), 3X,I3,8(2X,A1,I2))
      WRITE (IW,14) (PARNAM(N,K),N=NPAR0,NPARSN)
C  14 FORMAT (/39X,A10,4(5X,A10)/4X,7(5X,A10)/4X,7(5X,A10)/4X,7(5X,A10))
   14 FORMAT (/39X, A8, 4(7X,A8)/2X,7(7X,A8)/2X,7(7X,A8)/2X,7(7X,A8))
      WRITE(IW,15) (VPAR(N,K),N=NPAR0,NPARSN)
   15 FORMAT (/ 30X,5F15.3/(7F15.3))
      NPAR0=NPARSN+1
      CFLAG(I,K)=BLNK
      CGENGY(I,K)=0.D0
      SWT(I,K)=0.D0
  131 CONTINUE
      NOT=NPAR0
      NJJ=NPARJ(J1X,J1X)
      IF (J1X.LE.1) GO TO 139
      J1XM1=J1X-1
      DO 138 J1A=1,J1XM1
        J1AP1=J1A+1
        DO 138 J1B=J1AP1,J1X
          JAB=MAX0(J1B-J1A,1)
          IF (NPARJ(J1A,J1B).EQ.0) GO TO 138
          NPAR4=NPAR0+4
          READ(IR,16) (ELEM1(N),N=1,3),(VPAR(N,K),JPAR(N),
     1    N=NPAR0,NPAR4),TYPE,IFACT
   16     FORMAT (2A6,A7,1X,5(F9.4,I1),A2,4I2)
          IF (IFACT(4).EQ.99.OR.IFACT(4).EQ.0) IFACT(4)=100
          ERAS=IFACT(4)
          FACT5=0.01D0*ERAS
          NPARSN=NPARJ(J1A,J1B)+NPAR0-1
          IF (NPARJ(J1A,J1B).LE.5) GO TO 132
          NPAR5=NPAR4+1
          READ (IR,11) (VPAR(N,K),JPAR(N),N=NPAR5,NPARSN)
C           RESCALE CONFIGURATION-INTERACTION PARAMETERS
  132     SCALE1=SCALE
          J=JPAR(NPAR0)
          IF (J.LT.1.OR.J.GT.5) GO TO 133
          IF (FACT0(J).EQ.0.D0) GO TO 133
          SCALE1=SCALE*FACT0(J)/FACT5
          FACT5=FACT0(J)
  133     DO 134 N=NPAR0,NPARSN
  134     VPAR(N,K)=SCALE1*VPAR(N,K)
C
  136     WRITE (IW,17) (ELEM1(N),N=1,3),UENRGY,TYPE,FACT5,
     1      (JN, (LLIJK(L,JN,K),NIJK(L,JN,K), L=1,KS), JN=J1A,J1B,JAB)
   17     FORMAT (//1X,2A6,A7,3X,20HPARAMETER VALUES IN ,F7.1,7H CM-1 (,
     1    A2,6H TIMES, F5.2,1H),18X,I3,8(2X,A1,I2)/89X,I3,8(2X,A1,I2))
          WRITE (IW,14) (PARNAM(N,K),N=NPAR0,NPARSN)
          WRITE (IW,15) (VPAR(N,K),N=NPAR0,NPARSN)
          NPAR0=NPARSN+1
  138 CONTINUE
  139 DO 140 I=1,9
        AVP(I,K)=0.D0
  140 FNT(I,K)=0.D0
      AVCG(K)=0.D0
      AVEIG(K)=0.D0
      SUMWT=0.D0
      EMIN=1.0D20
      EMAX=-1.0D20
      NLEV=0
      NPAR=NPARSN
      NPARK(K)=NPAR
      DO 150 L=1,KMX
  150 LCSER(L)=0
C
C          CALCULATE ENERGY MATRICES
C
  200 DO 399 NN=1,NSCRJ8
C       READ (IC) SCRJ8,NLS, ((TMX(L,LP),L=1,NLS), LP=1,NLS),
C    1    ((NALS(L,I),SCRL(L,I),SCRS(L,I),
C    2    I=1,NOSUBC), NCFG(L),FIDLS(L,1),FIDJJ(L,1), L=1,NLS)
C       ICRD=ICRD+1
C ***************************************************** A.KRAMIDA v
        READ (IC) SCRJ8,NLS, ((NALS(L,I),SCRL(L,I),SCRS(L,I),
     1    I=1,NOSUBC), NCFG(L),FIDLS(L,1),FIDJJ(L,1), L=1,NLS)
        IMSQ=NLS*NLS
        CALL UNPK1(IC,NLS,NLS,TMX,KMX,KMX,BUFC,IMSQ,MAXBC)
        ICPTR=ICPTR+2
        ICRD=ICRD+2
C ***************************************************** A.KRAMIDA ^
        NLSX=MAX0(NLSX,NLS)
        NOICRD=0
        WT=2.D0*SCRJ8+1.D0
        ERAS=0.D0
        IF (NLS.LE.0) NLS=1
        DO 212 L=1,NLS
          DO 211 LP=1,L
  211     C(L,LP)=0.D0
          J=NCFG(L)
          I=NPAV(J)
          ERAS=ERAS+VPAR(I,K)
  212   C(L,L)=VPAR(I,K)
        AVCG(K)=AVCG(K)+ERAS*WT
        IF (NPAR.LE.1) GO TO 225
        DO 222 IPAR=2,NPAR
          DO 218 J=1,J1X
            IF (IPAR.EQ.NPAV(J)) GO TO 222
  218     CONTINUE
C         READ (IC) ((CT4(L,LP),L=LP,NLS), LP=1,NLS)
C ************************************************* A.KRAMIDA v
          CALL UNPK1(IC,NLS,NLS,CT4,KMX,KMX,BUFC,0,MAXBC)
          ICPTR=ICPTR+1
C ************************************************* A.KRAMIDA ^
c         Lx=21
c         if (lx.gt.nls) lx=nls
c         write(iw,9221) ipar
c         do LP=1,lx
c           write(IW,9220) (CT4(L,LP),L=1,lx)
c         enddo
c9220     format(25F11.6)
c9221     format(' reading, IPAR=',I5)
          ICRD=ICRD+1
          NOICRD=NOICRD+1
          DO 220 L=1,NLS
            DO 220 LP=1,L
  220     C(L,LP)=C(L,LP)+VPAR(IPAR,K)*CT4(L,LP)
  222   CONTINUE
  225   DO 230 L=1,NLS
          DO 230 LP=1,L
  230   C(LP,L)=C(L,LP)
        IF (IPRINT.LT.7) THEN
          KPAR=3
          CALL SPRIN
        ENDIF
        IF (IPRINT.LT.8) THEN
          REWIND 3
          IMSQ=NLS*NLS
          CALL PK1(3,NLS,NLS,TMX,KMX,KMX,BUFC,IMSQ,MAXBC)   !,8,IW)
        ENDIF
  240   LX=0
        DO L=1,NLS
          J=NCFG(L)
          I=NPAV(J)
          IF (VPAR(I,K).GT.-4000.D0) LX=L
        ENDDO
        LXP1=LX+1
        JX=NLS-LX+1
        JXP1=JX+1
        NLSP1=NLS+1
        L=NOSUBC
        J=1
        KKK=1
        IF (LX.EQ.0.OR.LX.EQ.NLS) GO TO 271
        DO LP=1,NLS
          DO L=1,NLS
            CI(L,LP)=0.D0
          ENDDO
        ENDDO
        I=0
C       DO 260 LP=1,NLS
        DO 260 LP=LX+1,NLS
C         IF (LP.LE.LX) GO TO 260
          I=I+1
          DO 255 L=1,LX
            CI(L,I)=C(L,LP)
            C(L,LP)=0.D0
  255     C(LP,L)=0.D0
  260   CONTINUE
C          CALC STATISTICAL WEIGHT OF FIRST CONFIGURATION OR
C               (IF CONTINUUM CONFIGURATIONS PRESENT) OF ION CORE
        DO 265 L=LXP1,NLS
          J=NCFG(L)
          I=NPAV(J)
          IF (VPAR(I,K).LT.-9000.D0) GO TO 266
  265   CONTINUE
  266   KKK=K
        M=0
        DO I=1,NOSUBC
          L=NOSUBC-I+1
          IF (NIJK(L,J,KKK).GT.0) M=M+1
          IF (M.EQ.2) GO TO 271
        ENDDO
  271   G1=1.D0
        DO 280 I=1,L
          E1=4.D0*FLLIJK(I,J,KKK)+2.D0
          E2=NIJK(I,J,KKK)
  280   G1=G1*FCTRL(E1)/(FCTRL(E2)*FCTRL(E1-E2))
        IF (LX.GT.0.AND.LX.LT.NLS) G1AA=G1
        IF (G1AA.GT.0.D0) G1=G1AA
C
C          CALC EIGENVALUES AND VECTORS
C
  300   I=0
        CALL CLOCK(TIME1)
C          C CONTAINS MATRIX TO BE DIAGONALIZED.
C          MLEW RETURNS EIGENVALUES AND VECTORS IN EIG AND C, RESPECTIVELY
C       CALL OVERLAY(2HG9,8,3)
        CALL MLEW
        ERAS=0.D0
        DO 320 LP=1,NLS
  320   ERAS=ERAS+EIG(LP)
        CALL CLOCK(TIME)
        TDIAG=TIME-TIME1
        AVEIG(K)=AVEIG(K)+ERAS*WT
        ERAS=NLS
        SUMWT=SUMWT+ERAS*WT
        EMIN=DMIN1(EMIN,EIG(1))
        EMAX=DMAX1(EMAX,EIG(NLS))
        NLEV=NLEV+NLS
C          CHECK ORTHONORMALITY OF EIGENVECTORS
        DO 329 L=1,NLS
          DO 329 LP=L,NLS
            ERAS=0.D0
            IF (L.EQ.LP) ERAS=-1.D0
            ERAS1=ERAS
            DO 328 J=1,NLS
              ERAS=ERAS+C(J,L)*C(J,LP)
  328       ERAS1=ERAS1+C(L,J)*C(LP,J)
            IF (DABS(ERAS).GT.1.D-10.OR.DABS(ERAS1).GT.1.D-10)
     1        WRITE (IW,29) L,LP,ERAS,ERAS1
   29       FORMAT (35H *****POOR ORTHONORMALITY FOR L,LP=,2I4,
     1        3X,1P2E10.2)
  329   CONTINUE
C
C          CALCULATE CONFIGURATION SERIAL NUMBER FOR LEVEL LP
C
        DO 330 J=1,J1X
          NLCFGJ(J)=0
          NSCFGJ(J)=0
          DO 330 LP=1,NLS
  330   CPURTY(LP,J)=0.D0
        DO 331 L=1,NLS
          LCSER(L)=0
          J=NCFG(L)
          NSCFGJ(J)=NSCFGJ(J)+1
          DO 331 LP=1,NLS
  331   CPURTY(LP,J)=CPURTY(LP,J)+C(L,LP)**2
C
        DO 333 LP=1,NLS
          ERAS=0.D0
          DO 332 J=1,J1X
            IF (CPURTY(LP,J).LT.ERAS) GO TO 332
            ERAS=CPURTY(LP,J)
            LCSER(LP)=J
            M=J
  332     CONTINUE
  333   NLCFGJ(M)=NLCFGJ(M)+1
C
        DO 334 J=1,J1X
  334   IF (NLCFGJ(J).NE.NSCFGJ(J)) CFLAG(J,K)=STAR
        ICOUNT=0
  335   IERAS=0
        DO 337 J=1,J1X
          IF (NLCFGJ(J).GE.NSCFGJ(J)) GO TO 337
          IERAS=7
          ERAS=0.D0
          DO 336 LP=1,NLS
            J1=LCSER(LP)
            IF (J1.EQ.J.OR.NLCFGJ(J1).LE.NSCFGJ(J1)) GO TO 336
            IF (CPURTY(LP,J).LT.ERAS) GO TO 336
            ERAS=CPURTY(LP,J)
            M=LP
  336     CONTINUE
          J1=LCSER(M)
          LCSER(M)=J
          NLCFGJ(J1)=NLCFGJ(J1)-1
          NLCFGJ(J)=NLCFGJ(J)+1
  337   CONTINUE
        ICOUNT=ICOUNT+1
        IF (IERAS.NE.0.AND.ICOUNT.LE.NLS) GO TO 335
        ERAS=2.D0*SCRJ8+1.D0
        DO 338 LP=1,NLS
          J=LCSER(LP)
          CGENGY(J,K)=CGENGY(J,K)+ERAS*EIG(LP)
  338   SWT(J,K)=SWT(J,K)+ERAS
        NNTRM=0
C          CALCULATE LEVEL DESIGNATIONS
        DO 340 LP=1,NLS
          C2X=0.D0
          DO 339 L=1,NLS
            IF (NCFG(L).NE.LCSER(LP)) GO TO 339
            C2=C(L,LP)**2
            IF (C2.LT.C2X) GO TO 339
            LD=L
            C2X=C2
  339     CONTINUE
          LDES(LP)=FIDLS(LD,1)
          IF (KCPL.EQ.2) LDES(LP)=FIDJJ(LD,1)
          IF (C(LD,LP).LE.0.D0) THEN
            DO 1339 L=1,NLS
 1339       C(L,LP)=-C(L,LP)
          ENDIF
C           DETERMINE EXPEDIENCY NUMBER (SPECIAL FOR MAGEE)
 2339     IF (IELPUN.LT.2) GO TO 340
          IF (SCRJ8.GT.DABS(SCRL(LD,NOSUBC)-SCRS(LD,NOSUBC))) GO TO 340
          IF (NNTRM.EQ.0) GO TO 4339
          DO N1=1,NNTRM
            IF (LDES(LP).EQ.LDESN(N1)) GO TO 5339
          ENDDO
 4339     NNTRM=NNTRM+1
          N1=NNTRM
          LDESN(N1)=LDES(LP)
          NEXP(N1)=0
 5339     NEXP(N1)=NEXP(N1)+1
          DO 7339 L1=1,NMULT
            IF (LDES(LP).NE.FIDMULT(L1,K)) GO TO 7339
            DO 6339 K1=1,NOSUBC
              IF (NALS(LD,K1).NE.IALS(L1,K1,K)) GO TO 7339
              IF (SCRL(LD,K1).NE.SL(L1,K1,K)) GO TO 7339
              IF (SCRS(LD,K1).NE.SS(L1,K1,K)) GO TO 7339
 6339       CONTINUE
            NEXPED(L1,K)=NEXP(N1)
            ETRM(L1,K)=EIG(LP)
 7339     CONTINUE
C
  340   CONTINUE
C
C          PRINT EIGENVALUES AND VECTORS
C
        IF (IPRINT.GE.9) GO TO 350
        IF (IPRINT.LT.7.AND.IENGYD.GE.2.AND.NLS.GT.11) THEN
          IF (EIG(NLS).LE.9999.D0) THEN
            WRITE (IW,30) SCRJ8,(EIG(L),L=1,NLS)
   30       FORMAT (15H1  EIGENVALUES ,5X,3H(J=,F4.1,1H)/(/28X,11F9.3))
          ELSE
            WRITE (IW,31) SCRJ8,(EIG(L),L=1,NLS)
   31       FORMAT (15H1  EIGENVALUES ,5X,3H(J=,F4.1,1H)/(/28X,11F9.2))
          ENDIF
        ELSE
  342     IF (EIG(NLS).LE.9999.D0) THEN
            WRITE (IW,32) SCRJ8,(EIG(L),L=1,NLS)
   32       FORMAT (15H0  EIGENVALUES ,5X,3H(J=,F4.1,1H)/(/28X,11F9.3))
          ELSE
  343       WRITE (IW,33) SCRJ8,(EIG(L),L=1,NLS)
   33       FORMAT (15H0  EIGENVALUES ,5X,3H(J=,F4.1,1H)/(/28X,11F9.2))
          ENDIF
        ENDIF
  345   WRITE (IW,34) (LCSER(L), L=1,NLS)
   34   FORMAT (15H   CONFIG. NO. /(25X,11I9))
C          PRINT FREE-ELECTRON KINETIC ENERGIES
        IF (LX.EQ.0.OR.LX.EQ.NLS) GO TO 350
        LLX=NLS-LX
        DO 349 LP=1,LLX
          DO 347 L=1,NLS
            EKIN(L)=0.D0
            IF (L.LE.LLX) GO TO 347
            IJJ=LCSER(LP)
            EKIN(L)=EIG(L)+E0KIN(IJJ)-EIG(LP)
  347     CONTINUE
          WRITE (IW,28) (ELEM(L1,IJJ,K), L1=1,3),
     1    LDES(LP),(EKIN(L),L=2,NLS)
   28     FORMAT (' KE FOR CORE  ',2A6,A2,2H (,A7,10F9.3
     1      /(28X,11F9.3))
  349   CONTINUE
  350   KPAR=4
  355   WRITE (IE) SCRJ8,NLS, (EIG(LP), (CI(L,LP),L=1,NLS), LP=1,NLS),
     1    ((C(L,LP),L=1,NLS), LP=1,NLS),LCSER,LDES
        IEWR=IEWR+1
        IJJ=0
        DO L=3,7
          IF (KCPLD(L).EQ.0) IJJ=IJJ+1
        ENDDO
  358   IF (IPRINT.LT.8.OR.IJJ.NE.0) THEN
          IF (IPRINT.LT.8) THEN
            CALL SPRIN
            REWIND 3
            IMSQ=NLS*NLS
            CALL UNPK1(3,NLS,NLS,TMX,KMX,KMX,BUFC,IMSQ,MAXBC)
          ELSE
            CALL SPRN37
          ENDIF
        ENDIF
  359   IF (IELPUN.EQ.1) WRITE (11,35) (ELEM(L,1,K), L=1,3),
     1    SCRJ8,NLS, (EIG(L), L=1,NLS)
   35   FORMAT (3A6,2X,F5.1,I5/(6F12.3))
C
C          CALCULATE AUTOIONIZATION TRANSITION PROBABILITIES
C
        DO 360 LP=1,NLS
          AA(LP,JX)=0.D0
          AA(LP,JXP1)=0.D0
          DO 360 I=1,KEXC
  360   GAAXC(LP,I)=0.D0
        IF (LX.EQ.0.OR.LX.EQ.NLS) GO TO 380
        IF (NLS.GT.KMX) WRITE (IW,36) NLS,KMX
   36   FORMAT (//10H *****NLS=,I3,29H .GT. MAX ALLOWABLE VALUE OF ,
     1    I3,18H FOR AA CALCN*****//)
        BACKSPACE IE
        READ (IE) SCRJ8,NLS, (EIG(LP), (CI(L,LP),L=1,NLS), LP=1,NLS),
     1    ((C(L,LP),L=1,NLS), LP=1,NLS)
        DO LP=1,NLS
          DO L=1,NLS
            CII(L,LP)=0.D0
          ENDDO
        ENDDO
        AAMX=0.D0
        DO 362 LP=1,NLS
          DO 362 J=LXP1,NLS
            I=J-LX
            SUM=0.D0
            DO 361 L=1,LX
  361       SUM=SUM+C(L,LP)*CI(L,I)
  362   CII(LP,J)=SUM
        DO 365 LP=1,NLS
          DO 364 I=1,NLS
            IF (EIG(I).GT.-4000.D0) GO TO 364
            AA(LP,I)=0.D0
            IF (EIG(I).LT.-8000.D0.OR.EMINA.EQ.0.D0) GO TO 2362
            IF (EIG(LP).LT.EMINA) GO TO 364
            J=LCSER(I)
            JJ=NPAV(J)
            ETEMP=EIG(I)-VPAR(JJ,K)
C             INCLUDE FOLLOWING STATEMENT ONLY IN SPECIAL CASES
C           IF (ETEMP.GT.0.D0) GO TO 364
C
 2362       SUM=0.D0
            DO 363 L=LXP1,NLS
  363       SUM=SUM+CII(LP,L)*C(L,I)
            AA(LP,I)=((SUM*UENRGY/109735.3D0)**2)*6.28318D0*2066.D0
            IF (EIG(I).LT.-8000.D0) AA(LP,JX)=AA(LP,JX)+AA(LP,I)
            AA(LP,JXP1)=AA(LP,JXP1)+AA(LP,I)
  364     CONTINUE
  365   AAMX=DMAX1(AA(LP,JXP1),AAMX)
        ERAS=1.D0
        L=13
        IF (AAMX.LT.0.1D0) L=10
        IF (AAMX.GT.999.9D0) L=16
        L1=L
        IF (L.EQ.13) GO TO 367
        ERAS=10.D0**(13-L)
        DO 366 LP=1,NLS
          DO 366 I=1,JXP1
  366   AA(LP,I)=ERAS*AA(LP,I)
  367   IF (IPRINT.GE.9) GO TO 371
        WRITE (IW,37) L
   37   FORMAT (17H AA(UNITS OF 10**,I2,5H/SEC))
        I=0
        DO 370 J=LX,NLSP1
          I=I+1
          IF (NLS.EQ.LXP1.AND.I.GE.2) GO TO 370
          IF (KCPLD(1)+KCPLD(2).LT.3) GO TO 368
          IF (I.LT.JX.AND.(NLS-LX).GT.2.AND.NLS.GT.11) GO TO 370
  368     IF (J.GE.NLS) GO TO 369
          N1=LCSER(I)
          WRITE (IW,38) (ELEM(I1,N1,K),I1=2,3), LDES(I), 
     1      (AA(LP,I),LP=1,NLS)
c  38     FORMAT (8X,2A6,1H(,A8,11F9.4/(29X,11F9.4))
   38     FORMAT (8X,2A6,1H(,A8,1P,11E9.2/(29X,11E9.2))
          GO TO 370
  369     ITEMP=-8000
          IF (J.EQ.NLSP1) ITEMP=-4000
          WRITE (IW,39) ITEMP, (AA(LP,I),LP=1,NLS)
c  39     FORMAT (12X,11H TOT, E.LT.,I5,11F9.4/(29X,11F9.4))
   39     FORMAT (12X,11H TOT, E.LT.,I5,1P,11E9.2/(29X,11E9.2))
  370   CONTINUE
  371   ERAS=1.0D13/ERAS
        GG=2.D0*SCRJ8+1.D0
        DO 372 LP=1,NLS
          AA(LP,JX)=ERAS*AA(LP,JX)
          AA(LP,JXP1)=ERAS*AA(LP,JXP1)
          SUMGAA=SUMGAA+GG*AA(LP,JX)
  372   SUMGAAT=SUMGAAT+GG*AA(LP,JXP1)
        ERAS=GG*ERAS
        JXM1=JX-1
        DO 378 L=1,JXM1
          IF (EIG(L).GT.-4000.D0) GO TO 378
          J=LCSER(L)
          JJ=NPAV(J)
          ETEMP=EIG(L)-VPAR(JJ,K)
          IF (IXC.EQ.0) GO TO 375
          DO 374 I=1,IXC
            IF (DABS(ETEMP-EXC(I)).LT.0.01D0.AND.J.EQ.JEXC(I)) GO TO 376
  374     CONTINUE
  375     IXC=IXC+1
          I=IXC
          EXC(I)=ETEMP
          JEXC(I)=J
  376     DO 377 LP=1,NLS
  377     GAAXC(LP,I)=GAAXC(LP,I)+ERAS*AA(LP,L)
  378   CONTINUE
        IXC1=MAX0(IXC,1)
        IF (IPRINT.LT.9) THEN
          WRITE (IW,40) SUMGAA,SUMGAAT
   40     FORMAT (/20X,7HSUMGAA=,1PE13.5,10X,8HSUMGAAT=,E13.5//
     1      10X,11HEXC   GAAXC/)
        ENDIF
  380   WRITE (IE) LX, (AA(LP,JX),AA(LP,JXP1), LP=1,NLS),
     1    NLST,IXC,IXC1, (EXC(I), (GAAXC(LP,I),LP=JX,NLS), I=1,IXC1)
        NLST=NLST+LX
        IF (IPRINT.GE.9) GO TO 399
        IF (NLS.LE.1) GO TO 397
        IF (IXC.EQ.0) GO TO 388
        IF (LX.EQ.0.OR.LX.EQ.NLS) GO TO 388
        ERAS=10.D0**(-L1)
        DO 386 I=1,IXC
          DO 384 LP=1,NLS
  384     GAAXC(LP,I)=ERAS*GAAXC(LP,I)
  386   WRITE (IW,41) JEXC(I),EXC(I), (GAAXC(LP,I), LP=1,NLS)
   41   FORMAT (13X,I3,F12.4,11F9.4/(29X,11F9.4))
  388   CONTINUE
C
C          CALCULATE LEVEL DISTRIBUTION
C
        FNLS=NLS
        SUM=0.D0
        DO 391 L=1,NLS
  391   SUM=SUM+EIG(L)
        AVEEIG=SUM/(FNLS+1.0D-10)
        SUM=0.D0
        SUM3=0.D0
        DO 392 L=1,NLS
          DELTA=EIG(L)-AVEEIG
          DELTA2=DELTA**2
          SUM=SUM+DELTA2
  392   SUM3=SUM3+DELTA2*DELTA
        RMS1=DSQRT(SUM/FNLS)
        SUM3=SUM3/FNLS
        ALF3=SUM3/(RMS1**3+1.0D-10)
        NLSM1=NLS-1
        FNLSM1=NLSM1
        DO 393 L=1,NLSM1
  393   DELE(L)=EIG(L+1)-EIG(L)
        SUM=0.D0
        DO 394 L=1,NLSM1
  394   SUM=SUM+DELE(L)
        AVEDEL=SUM/FNLSM1
        SUM=0.D0
        DO 395 L=1,NLSM1
  395   SUM=SUM+(DELE(L)-AVEDEL)**2
        RMS2=DSQRT(SUM/FNLSM1)
        CALL CLOCK(TIME)
        DELT=TIME-TIME0
        WRITE (IW,42) AVEEIG,RMS1,ALF3,AVEDEL,RMS2,DELT,TDIAG
   42   FORMAT (//17H0AVEEIG,RMS,ALF3=,2F12.3,F9.4,5X,11HAVEDEL,RMS=,
     1    2F12.3,7X,15HTIME, DIAGTIME=,F9.2,F9.4,4H MIN)
C
C 397   IF (IV.NE.0) CALL OVERLAY(2HG9,8,2)
  397   IF (IV.NE.0) CALL CALCV
C
  399 CONTINUE
C           WRITE DUMMY RECORD, REQUIRED BY SYSTEM BUG
      WRITE (IE) (EIG(L), L=1,20)
C
      DO 400 J=1,J1X
  400 CGENGY(J,K)=CGENGY(J,K)*UENRGY/((SWT(J,K)+1.D-8)*109737.31D0)
      IF (K.EQ.1.AND.NSCONF(1,2).GT.0.AND.IPRINT.GE.7) GO TO 430
      AVCG(K)=AVCG(K)/SUMWT
      AVEIG(K)=AVEIG(K)/SUMWT
      DO 410 I=1,9
      IF (FNT(I,K).EQ.0.D0) GO TO 410
      AVP(I,K)=AVP(I,K)/FNT(I,K)
  410 CONTINUE
      IF (AVP(1,K).GT.0) GO TO 415
      DO 412 I=1,9
  412 AVP(I,K)=1.D0
  415 IF (K.EQ.1.AND.NSCONF(1,2).GT.0.AND.IPRINT.GE.7) GO TO 430
      WRITE  (IW,43) (COUPL(I), I=1,7)
   43 FORMAT (///13H AVE PURITIES,29X,9(A6,2X)/)
      DO 420 K1=1,K
        J1X=NSCONF(2,K1)
        IF (J1X.LT.2) J1X=2
        J1=J1X-1
  420 WRITE (IW,44) ((ELEM(I,JN,K1), I=1,3), JN=1,J1X,J1),
     1  (AVP(I,K1), I=1,7), AVCG(K1),AVEIG(K1)
   44 FORMAT (1X,3A6,3H---,3A6,7F8.3,5X,6H  EAV=,F10.4/101X,6HAVEIG=,
     1  F10.4)
      ENK(K)=EMIN
      EXK(K)=EMAX
C
C 430 IF (ISPECC.GE.8) CALL OVERLAY(2HG9,8,1)
  430 IF (ISPECC.GE.8) CALL LVDIST
C
      REWIND IE
      IF (IMAG.NE.K.AND.IMAG.LT.3) GO TO 450
C     CALL OVERLAY(2HG9,8,4)
      IARG1=0
      IARG2=IE
      IARG3=IE
      CALL SPECTR
  450 IF (IQUAD.NE.K.AND.IQUAD.LT.3) GO TO 470
C     CALL OVERLAY(2HG9,8,4)
      IARG1=2
      IARG2=IE
      IARG3=IE
      IRMN=IRNQ
      CALL SPECTR
C     IF (IGEN.GE.5) CALL OVERLAY(2HG9,8,5)
      IF (IGEN.GE.5) CALL BORN
  470 IF (NSCONF(1,2).LE.0) GO TO 100
      IF (IE.EQ.ILB) GO TO 500
  480 IL=ILB
      IE=ILB
      K=2
      GO TO 101
C
C 500 CALL OVERLAY(2HG9,8,4)
  500 IARG1=IIPRTY
      IARG2=ILA
      IARG3=ILB
      IRMN=IRND
      EMEAN=0.5D0*(DMAX1(ENK(1),ENK(2))+DMAX1(EXK(1),EXK(2)))
      CALL SPECTR
C          WRITE MULTIPLET LINE STRENGTH ON TAPE 19 (FOR MAGEE)
      IF (IELPUN.LT.2) GO TO 515
      STOT=0.D0
      DO 505 NN=1,NMULT
  505 STOT=STOT+SUMS(NN)
      WRITE (19,50) ((LLIJK(I,1,K),NIJK(I,1,K),I=1,3), K=1,2),
     1  NMULT,STOT,SSOPI2
   50 FORMAT (2X,3(A1,I2,2X),' - ',3(A1,I2,2X),'     NMULT=',I3,
     1  '     STOT=',F9.5,'     THEORY=',F9.5)
      DO 510 NN=1,NMULT
  510 WRITE (19,51) (FIDMULT(NN,K),NEXPED(NN,K),ETRM(NN,K), K=1,2),
     1  SUMS(NN)
   51 FORMAT (2X,1H(,A8,I4,F12.5,5X,1H(,A8,I4,F12.5,F15.5)
C
C     IF (IGEN.GE.5) CALL OVERLAY(2HG9,8,5)
  515 IF (IGEN.GE.5) CALL BORN
      IF (IKKK.LE.8) GO TO 100
C     DO 520 I=1,ICRD
C 520 BACKSPACE IC
      CALL BACKIC(IC,ICRD,ICPTR)
      GO TO 480
C
C 800 CALL OVERLAY(2HG9,8,6)
  800 CALL RCEINP
      GO TO 100
C
  900 RETURN
      END
C
C     OVERLAY(G9,10,1)
      SUBROUTINE LVDIST
C
C          PLOT LEVEL DISTRIBUTION ON MICROFILM
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      PARAMETER (KCC=KISER/4,KLC4=2*KISER+1)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C3D/ECUT(42),EPLOT(82),ICUT(42),GCUT(42),TITLE(20),GPLT(82)
      COMMON/EE/ELEM(3,KC,2),VPAR(KPR,2),AVP(9,2),AVEIG(2),AVCG(2),
     1  NPARK(2),NPAV(KC),    EIG(KMX),ELEM1(3),FNT(9,2),I1,I2
     2  ,IFACT(4),FACT(4)
      COMMON/C6/EMIN,EMAX,SUMWT,FLBDN,FLBDX,FNUNP,FNUXP,NLEV,IEWR
      COMMON/CJE07/IXL,IXR,IYT,IYB,XMN,XMX,YMX,YMN
C
  100 IF (NLEV.LT.10) GO TO 900
      K=KK
      FN=40.D0
      DEL=0.0005D0*(EMAX-EMIN)
      EMIN=EMIN-DEL
      EMAX=EMAX+DEL
      DELE=(EMAX-EMIN)/FN
      ECUT(1)=EMIN
      EPLOT(1)=EMIN-0.5D0*DELE
      NP2=FN+2.D0
      DO 150 J=1,NP2
      IF (J.EQ.1) GO TO 140
      ECUT(J)=ECUT(J-1)+DELE
      EPLOT(J)=EPLOT(J-1)+DELE
  140 ICUT(J)=0
  150 GCUT(J)=0.D0
C
      REWIND IE
      DISP=0.D0
      THIRD=0.D0
      DO 300 NN=1,NSCRJ8
      READ (IE) SCRJ8,NLS, (EIG(L), (B, LP=1,NLS), L=1,NLS),
     1  ((B, LP=1,NLS), L=1,NLS)
      READ (IE)
      WT=2.D0*SCRJ8+1.D0
      JCUT=2
      DO 230 N=1,NLS
  210 IF (EIG(N).LT.ECUT(JCUT)) GO TO 220
      JCUT=JCUT+1
      GO TO 210
  220 ICUT(JCUT)=ICUT(JCUT)+1
      GCUT(JCUT)=GCUT(JCUT)+WT
      ERAS1=EIG(N)-AVEIG(K)
      ERAS2=WT*ERAS1*ERAS1
      DISP=DISP+ERAS2
  230 THIRD=THIRD+ERAS2*ERAS1
  300 CONTINUE
      DISP=DISP/SUMWT
      RMS=DSQRT(DISP)
      THIRD=THIRD/SUMWT
      ALF3=THIRD/(RMS**3)
      WRITE (IW,30)
   30 FORMAT (//1H0,8X,1HJ,7X,4HECUT,8X,5HEPLOT,7X,4HICUT,6X,4HGCUT,8X,
     1  5HSUMWT,7X,4HDISP,9X,3HRMS,8X,4HALF3/)
      DO 310 J=1,NP2
      GCUT(J)=GCUT(J)/SUMWT
      WRITE(IW,31)J,ECUT(J),EPLOT(J),ICUT(J),GCUT(J),SUMWT,DISP,RMS,ALF3
   31 FORMAT (I10,2F12.3,I10,F12.6,F12.0,2F12.3,F12.4)
  310 CONTINUE
C     NP1=NP2-1
C     L=0
C     DO 320 J=1,NP1
C     L1=J-1
C     DO 320 J1=1,2
C     L=L+1
C     L1=L1+1
C     EPLOT(L)=ECUT(J)
C 320 GPLT(L)=GCUT(L1)
C     NP1T2=2*NP1
C
C     J1X=MAX0(NSCONF(2,K),2)
C     J1=J1X-1
C     ENCODE (44,40,TITLE) ((ELEM(I,JN,K),I=1,3), JN=1,J1X,J1)
C  40 FORMAT (6X,3A6,2H--,3A6)
C     ENCODE (111,41,TITLE(6)) NLEV,SUMWT,RMS,ALF3
C  41 FORMAT (50X,5HNLEV=,I4,4X,6HSUMWT=,F7.0,4X,4HRMS=,F10.3,4X,
C    1  5HALF3=,F8.4)
C     CALL PLOJB(EPLOT,GPLT,NP1T2,1,0,28,0.D0,1.D0,0.93D0,TITLE,161,
C    1  13HE (1000 CM-1),13,29HFRACTIONAL STATISTICAL WEIGHT,29)
C     DO 420 I=1,3
C     FI=I
C     EPLOT(I)=AVCG(K)+(FI-2.D0)*RMS
C 420 GCUT(I)=0.D0
C     CALL PLOJB(EPLOT,GCUT,3,1,1,-24,0.D0,1.D0,0.93D0,TITLE,0,
C    1  B,0,B,0)
C     CALL LINCNT(59)
C     WRITE (12,42) (COUPL(I), I=1,7)
C  42 FORMAT (10X,13H AVE PURITIES,29X,9(A6,2X)/)
C     WRITE (12,44) ((ELEM(I,JN,K), I=1,3), JN=1,J1X,J1),
C    1  (AVP(I,K), I=1,7), AVCG(K)
C  44 FORMAT (11X,3A6,3H---,3A6,7F8.3,5X,6H  EAV=,F10.4)
C
C          PLOT SKEWED-GAUSSIAN CURVE
C
C     DE=(XMX-XMN)/81.D0
C     EPLOT(1)=XMN
C     DO 505 J=2,82
C 505 EPLOT(J)=EPLOT(J-1)+DE
C     C=(ECUT(2)-ECUT(1))/(RMS*DSQRT(2.D0*3.14159D0))
C     DO 510 J=1,82
C     X=(EPLOT(J)-AVEIG(K))/RMS
C     X2=X*X
C     Y=1.D0-0.5D0*ALF3*(X-X*X2/3.D0)
C 510 GPLT(J)=C*Y*DEXP(-0.5D0*X2)
C     CALL PLOJB(EPLOT,GPLT,82,1,0,-28,0.D0,1.D0,0.95D0,TITLE,0,B,0,B,0)
  900 RETURN
      END
      SUBROUTINE PLOJB(X,Y,NPTS,INC,LNN,NSYM,C,XAA,YAA,LABELZ,NZL,LABEL
     1  X,NXL,LABELY,NYL)
      IMPLICIT REAL*8 (A-H,O-Z)
      A=EPLOT
      RETURN
      END
C
C     OVERLAY(G9,10,2)
      SUBROUTINE CALCV
C
C          CALC V MATRIX (DERIVATIVES OF EIGENVALUES WRT PARAMETERS)
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      PARAMETER (KCC=KISER/4,KLC4=2*KISER+1)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2/LL(KS),NI(KS),FLL(KS),MULT(KLS2,KS),LBCD(KLS2,KS),
     1  IALF(KLS2,KS),FL(KLS2,KS),S(KLS2,KS),NTRMK(KLSC),FLLRHOP,FLLSIGP
      COMMON/C3A/ISUBJ(KC),MULS(KS),LHS(KS),
     1  NALS(KMX,KS),NCFG(KMX),NALSJ(KMX,KS),SCRL(KMX,KS),SCRS(KMX,KS),
     2  FJ(KMX,KS),SCRJ(KMX,KS), MUL(KS),LH(KS),LF(KLSC),NSJK(110),
     3  FK(KMX),FKJ(KMX),SCRL6(KMX),SCRS6(KMX),FK6(KMX),LHQQ(KMX),
     4  MULTQQ(KMX),NALSJP(KJP,KS),PJ(KJP,KS),NOICRD
      COMMON/CC/   C(KMX,KMX)
      COMMON/C3LC2/TMX(KMX,KMX)
      COMMON/C3LC3/CT4(KMX,KMX)
      COMMON/C3LC4/VECT(KMX,KMX)
      COMMON/EE/ELEM(3,KC,2),VPAR(KPR,2),AVP(9,2),AVEIG(2),AVCG(2),
     1  NPARK(2),NPAV(KC),    EIG(KMX),ELEM1(3),FNT(9,2),I1,I2
     2  ,IFACT(4),FACT(4)
      CHARACTER*8 FIDLS,FIDJJ,LDES,LDESP,PARNAM,AA,COUPL
      CHARACTER*4 LSYMB
      COMMON/CHAR/PARNAM(KPR,2),FIDLS(KMX,2),FIDJJ(KMX,2),LDES(KMX),
     1  LDESP(KMX)
C
      DIMENSION V(100,64)
      EQUIVALENCE (C,V)
C          NOTE---V(KPR,KMX) SPILLS OVER INTO /C3LC2/
      PARAMETER (MAXBC=50000)
      CHARACTER*12 BUFC
      COMMON/BUFS/BUFC(MAXBC)
C
      M=NOICRD
      IF (M.EQ.0) GO TO 900
      K=KK
C     DO 100 JJ=1,M
C 100 BACKSPACE IC
      CALL BACKIC(IC,M,ICPTR)
      NLST=MIN0(NLS,NEVMAX)
C
C          CALC V MATRIX
C
      DO 229 IPAR=1,NPAR
        DO J=1,J1X
          IF (IPAR.EQ.NPAV(J)) THEN
            DO L=1,NLS
              DO LP=1,NLS
                CT4(L,LP)=0.D0
              ENDDO
              IF (NCFG(L).EQ.J) CT4(L,L)=1.D0
            ENDDO
            GO TO 212
          ENDIF
        ENDDO
C
C       READ (IC) ((CT4(L,LP),L=LP,NLS), LP=1,NLS)
C ********************************************************** A.KRAMIDA v
        CALL UNPK1(IC,NLS,NLS,CT4,KMX,KMX,BUFC,0,MAXBC)
        ICPTR=ICPTR+1
C ********************************************************** A.KRAMIDA ^
        DO 210 L=1,NLS
        DO 210 LP=1,L
  210   CT4(LP,L)=CT4(L,LP)
C
  212   DO M=1,NLST
          DELT=0.D0
          DO L=1,NLS
            A=0.D0
            DO LP=1,NLS
              A=A+CT4(L,LP)*VECT(LP,M)
            ENDDO
            DELT=DELT+VECT(L,M)*A
          ENDDO
          V(IPAR,M)=DELT
        ENDDO
  229 CONTINUE
C
C
C
      WRITE (IW,35)
   35 FORMAT (////9H V MATRIX)
      LX=0
  310 WRITE (IW,36)
   36 FORMAT (1H )
      LN=LX+1
      LX=LX+11
      IF (LX.GT.NLST) LX=NLST
      DO 320 I=1,NPAR
  320 WRITE (IW,37) PARNAM(I,K), (V(I,L), L=LN,LX)
   37 FORMAT (1X,A10,4X,11F9.5)
      IF (LX.LT.NLST) GO TO 310
C
      M=NOICRD-NPAR+J1X
      IF (M.LE.0) GO TO 900
      DO 400 I=1,M
  400 READ (IC) A
      ICPTR=ICPTR+M
C
  900 CALL CLOCK(TIME)
      DELT=TIME-TIME0
      WRITE (IW,93) DELT
   93 FORMAT (11X,5HTIME=,F9.3,4H MIN)
      RETURN
      END
C
C     OVERLAY(G9,10,3)
      SUBROUTINE MLEW
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      PARAMETER (KCC=KISER/4,KLC4=2*KISER+1,KLC42=KMX**2,KEXC=40)
      PARAMETER (KBGKS=41,KENRGS=21,KCASE=50,KTRAN=600,KLAM=10000)
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C3A/ISUBJ(KC),MULS(KS),LHS(KS),
     1  NALS(KMX,KS),NCFG(KMX),NALSJ(KMX,KS),SCRL(KMX,KS),SCRS(KMX,KS),
     2  FJ(KMX,KS),SCRJ(KMX,KS), MUL(KS),LH(KS),LF(KLSC),NSJK(110),
     3  FK(KMX),FKJ(KMX),SCRL6(KMX),SCRS6(KMX),FK6(KMX),LHQQ(KMX),
     4  MULTQQ(KMX),NALSJP(KJP,KS),PJ(KJP,KS),NOICRD
      COMMON/CC/   C(KMX,KMX)
      COMMON/C3LC4/VECT(KMX,KMX)
      COMMON/EE/ELEM(3,KC,2),VPAR(KPR,2),AVP(9,2),AVEIG(2),AVCG(2),
     1  NPARK(2),NPAV(KC),    EIG(KMX),ELEM1(3),FNT(9,2),I1,I2,
     2  IFACT(4),FACT(4),LCSER(KMX),X(KMX)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
C
      CALL TRED2(KMX,NLS,C,EIG,FK,C)
      CALL TQL2(KMX,NLS,EIG,FK,C,M)
      IF (M.NE.0) WRITE (IW,10) M
   10 FORMAT (36H*****ERROR IN DIAGONALIZATION, IERR=,I4)
      RETURN
      END
C
      SUBROUTINE TRED2(NM,N,A,D,E,Z)                                    TRED2  3
C***BEGIN PROLOGUE  TRED2                                               TRED2  4
C***DATE WRITTEN   760101   (YYMMDD)                                    TRED2  5
C***REVISION DATE  830518   (YYMMDD)                                    TRED2  6
C***CATEGORY NO.  D4C1B1                                                TRED2  7
C***KEYWORDS  EIGENVALUES,EIGENVECTORS,EISPACK                          TRED2  8
C***AUTHOR  SMITH, B. T., ET AL.                                        TRED2  9
C***PURPOSE  REDUCE REAL SYMMETRIC MATRIX TO SYMMETRIC TRIDIAGONAL      TRED2 10
C            MATRIX USING AND ACCUMULATING ORTHOGONAL TRANSFORMATION    TRED2 11
C***DESCRIPTION                                                         TRED2 12
C                                                                       TRED2 13
C     THIS SUBROUTINE IS A TRANSLATION OF THE ALGOL PROCEDURE TRED2,    TRED2 14
C     NUM. MATH. 11, 181-195(1968) BY MARTIN, REINSCH, AND WILKINSON.   TRED2 15
C     HANDBOOK FOR AUTO. COMP., VOL.II-LINEAR ALGEBRA, 212-226(1971).   TRED2 16
C                                                                       TRED2 17
C     THIS SUBROUTINE REDUCES A REAL SYMMETRIC MATRIX TO A              TRED2 18
C     SYMMETRIC TRIDIAGONAL MATRIX USING AND ACCUMULATING               TRED2 19
C     ORTHOGONAL SIMILARITY TRANSFORMATIONS.                            TRED2 20
C                                                                       TRED2 21
C     ON INPUT                                                          TRED2 22
C                                                                       TRED2 23
C        NM MUST BE SET TO THE ROW DIMENSION OF TWO-DIMENSIONAL         TRED2 24
C          ARRAY PARAMETERS AS DECLARED IN THE CALLING PROGRAM          TRED2 25
C          DIMENSION STATEMENT.                                         TRED2 26
C                                                                       TRED2 27
C        N IS THE ORDER OF THE MATRIX.                                  TRED2 28
C                                                                       TRED2 29
C        A CONTAINS THE REAL SYMMETRIC INPUT MATRIX.  ONLY THE          TRED2 30
C          LOWER TRIANGLE OF THE MATRIX NEED BE SUPPLIED.               TRED2 31
C                                                                       TRED2 32
C     ON OUTPUT                                                         TRED2 33
C                                                                       TRED2 34
C        D CONTAINS THE DIAGONAL ELEMENTS OF THE TRIDIAGONAL MATRIX.    TRED2 35
C                                                                       TRED2 36
C        E CONTAINS THE SUBDIAGONAL ELEMENTS OF THE TRIDIAGONAL         TRED2 37
C          MATRIX IN ITS LAST N-1 POSITIONS.  E(1) IS SET TO ZERO.      TRED2 38
C                                                                       TRED2 39
C        Z CONTAINS THE ORTHOGONAL TRANSFORMATION MATRIX                TRED2 40
C          PRODUCED IN THE REDUCTION.                                   TRED2 41
C                                                                       TRED2 42
C        A AND Z MAY COINCIDE.  IF DISTINCT, A IS UNALTERED.            TRED2 43
C                                                                       TRED2 44
C     QUESTIONS AND COMMENTS SHOULD BE DIRECTED TO B. S. GARBOW,        TRED2 45
C     APPLIED MATHEMATICS DIVISION, ARGONNE NATIONAL LABORATORY         TRED2 46
C     ------------------------------------------------------------------TRED2 47
C***REFERENCES  B. T. SMITH, J. M. BOYLE, J. J. DONGARRA, B. S. GARBOW, TRED2 48
C                 Y. IKEBE, V. C. KLEMA, C. B. MOLER, *MATRIX EIGEN-    TRED2 49
C                 SYSTEM ROUTINES - EISPACK GUIDE*, SPRINGER-VERLAG,    TRED2 50
C                 1976.                                                 TRED2 51
C***ROUTINES CALLED  (NONE)                                             TRED2 52
C***END PROLOGUE  TRED2                                                 TRED2 53
C                                                                       TRED2 54
      IMPLICIT REAL*8 (A-H,O-Z)
      INTEGER I,J,K,L,N,II,NM,JP1                                       TRED2 55
      DIMENSION A(NM,N),D(N),E(N),Z(NM,N)                               TRED2 56
C     REAL A(NM,N),D(N),E(N),Z(NM,N)                                    TRED2 56
C     REAL F,G,H,HH,SCALE                                               TRED2 57
C                                                                       TRED2 58
C***FIRST EXECUTABLE STATEMENT  TRED2                                   TRED2 59
      DO 100 I = 1, N                                                   TRED2 60
C                                                                       TRED2 61
         DO 100 J = 1, I                                                TRED2 62
            Z(I,J) = A(I,J)                                             TRED2 63
  100 CONTINUE                                                          TRED2 64
C                                                                       TRED2 65
      IF (N .EQ. 1) GO TO 320                                           TRED2 66
C     .......... FOR I=N STEP -1 UNTIL 2 DO -- ..........               TRED2 67
      DO 300 II = 2, N                                                  TRED2 68
         I = N + 2 - II                                                 TRED2 69
         L = I - 1                                                      TRED2 70
         H = 0.D0                                                       TRED2 71
         SCALE = 0.D0                                                   TRED2 72
         IF (L .LT. 2) GO TO 130                                        TRED2 73
C     .......... SCALE ROW (ALGOL TOL THEN NOT NEEDED) ..........       TRED2 74
         DO 120 K = 1, L                                                TRED2 75
  120    SCALE = SCALE + DABS(Z(I,K))                                   TRED2 76
C                                                                       TRED2 77
         IF (SCALE .NE. 0.D0) GO TO 140                                 TRED2 78
  130    E(I) = Z(I,L)                                                  TRED2 79
         GO TO 290                                                      TRED2 80
C                                                                       TRED2 81
  140    DO 150 K = 1, L                                                TRED2 82
            Z(I,K) = Z(I,K) / SCALE                                     TRED2 83
            H = H + Z(I,K) * Z(I,K)                                     TRED2 84
  150    CONTINUE                                                       TRED2 85
C                                                                       TRED2 86
         F = Z(I,L)                                                     TRED2 87
         G = -SIGN(DSQRT(H),F)                                          TRED2 88
         E(I) = SCALE * G                                               TRED2 89
         H = H - F * G                                                  TRED2 90
         Z(I,L) = F - G                                                 TRED2 91
         F = 0.D0                                                       TRED2 92
C                                                                       TRED2 93
         DO 240 J = 1, L                                                TRED2 94
            Z(J,I) = Z(I,J) / H                                         TRED2 95
            G = 0.D0                                                    TRED2 96
C     .......... FORM ELEMENT OF A*U ..........                         TRED2 97
            DO 180 K = 1, J                                             TRED2 98
  180       G = G + Z(J,K) * Z(I,K)                                     TRED2 99
C                                                                       TRED2100
            JP1 = J + 1                                                 TRED2101
            IF (L .LT. JP1) GO TO 220                                   TRED2102
C                                                                       TRED2103
            DO 200 K = JP1, L                                           TRED2104
  200       G = G + Z(K,J) * Z(I,K)                                     TRED2105
C     .......... FORM ELEMENT OF P ..........                           TRED2106
  220       E(J) = G / H                                                TRED2107
            F = F + E(J) * Z(I,J)                                       TRED2108
  240    CONTINUE                                                       TRED2109
C                                                                       TRED2110
         HH = F / (H + H)                                               TRED2111
C     .......... FORM REDUCED A ..........                              TRED2112
         DO 260 J = 1, L                                                TRED2113
            F = Z(I,J)                                                  TRED2114
            G = E(J) - HH * F                                           TRED2115
            E(J) = G                                                    TRED2116
C                                                                       TRED2117
            DO 260 K = 1, J                                             TRED2118
               Z(J,K) = Z(J,K) - F * E(K) - G * Z(I,K)                  TRED2119
  260    CONTINUE                                                       TRED2120
C                                                                       TRED2121
  290    D(I) = H                                                       TRED2122
  300 CONTINUE                                                          TRED2123
C                                                                       TRED2124
  320 D(1) = 0.D0                                                       TRED2125
      E(1) = 0.D0                                                       TRED2126
C     .......... ACCUMULATION OF TRANSFORMATION MATRICES ..........     TRED2127
      DO 500 I = 1, N                                                   TRED2128
         L = I - 1                                                      TRED2129
         IF (D(I) .EQ. 0.D0) GO TO 380                                  TRED2130
C                                                                       TRED2131
         DO 360 J = 1, L                                                TRED2132
            G = 0.D0                                                    TRED2133
C                                                                       TRED2134
            DO 340 K = 1, L                                             TRED2135
  340       G = G + Z(I,K) * Z(K,J)                                     TRED2136
C                                                                       TRED2137
            DO 360 K = 1, L                                             TRED2138
               Z(K,J) = Z(K,J) - G * Z(K,I)                             TRED2139
  360    CONTINUE                                                       TRED2140
C                                                                       TRED2141
  380    D(I) = Z(I,I)                                                  TRED2142
         Z(I,I) = 1.D0                                                  TRED2143
         IF (L .LT. 1) GO TO 500                                        TRED2144
C                                                                       TRED2145
         DO 400 J = 1, L                                                TRED2146
            Z(I,J) = 0.D0                                               TRED2147
            Z(J,I) = 0.D0                                               TRED2148
  400    CONTINUE                                                       TRED2149
C                                                                       TRED2150
  500 CONTINUE                                                          TRED2151
C                                                                       TRED2152
      RETURN                                                            TRED2153
      END                                                               TRED2154
C
      SUBROUTINE TQL2(NM,N,D,E,Z,IERR)                                  TQL2   3
C***BEGIN PROLOGUE  TQL2                                                TQL2   4
C***DATE WRITTEN   760101   (YYMMDD)                                    TQL2   5
C***REVISION DATE  830518   (YYMMDD)                                    TQL2   6
C***CATEGORY NO.  D4A5,D4C2A                                            TQL2   7
C***KEYWORDS  EIGENVALUES,EIGENVECTORS,EISPACK                          TQL2   8
C***AUTHOR  SMITH, B. T., ET AL.                                        TQL2   9
C***PURPOSE  COMPUTE EIGENVALUES AND EIGENVECTORS OF SYMMETRIC          TQL2  10
C            TRIDIAGONAL MATRIX.                                        TQL2  11
C***DESCRIPTION                                                         TQL2  12
C                                                                       TQL2  13
C     THIS SUBROUTINE IS A TRANSLATION OF THE ALGOL PROCEDURE TQL2,     TQL2  14
C     NUM. MATH. 11, 293-306(1968) BY BOWDLER, MARTIN, REINSCH, AND     TQL2  15
C     WILKINSON.                                                        TQL2  16
C     HANDBOOK FOR AUTO. COMP., VOL.II-LINEAR ALGEBRA, 227-240(1971).   TQL2  17
C                                                                       TQL2  18
C     THIS SUBROUTINE FINDS THE EIGENVALUES AND EIGENVECTORS            TQL2  19
C     OF A SYMMETRIC TRIDIAGONAL MATRIX BY THE QL METHOD.               TQL2  20
C     THE EIGENVECTORS OF A FULL SYMMETRIC MATRIX CAN ALSO              TQL2  21
C     BE FOUND IF  TRED2  HAS BEEN USED TO REDUCE THIS                  TQL2  22
C     FULL MATRIX TO TRIDIAGONAL FORM.                                  TQL2  23
C                                                                       TQL2  24
C     ON INPUT                                                          TQL2  25
C                                                                       TQL2  26
C        NM MUST BE SET TO THE ROW DIMENSION OF TWO-DIMENSIONAL         TQL2  27
C          ARRAY PARAMETERS AS DECLARED IN THE CALLING PROGRAM          TQL2  28
C          DIMENSION STATEMENT.                                         TQL2  29
C                                                                       TQL2  30
C        N IS THE ORDER OF THE MATRIX.                                  TQL2  31
C                                                                       TQL2  32
C        D CONTAINS THE DIAGONAL ELEMENTS OF THE INPUT MATRIX.          TQL2  33
C                                                                       TQL2  34
C        E CONTAINS THE SUBDIAGONAL ELEMENTS OF THE INPUT MATRIX        TQL2  35
C          IN ITS LAST N-1 POSITIONS.  E(1) IS ARBITRARY.               TQL2  36
C                                                                       TQL2  37
C        Z CONTAINS THE TRANSFORMATION MATRIX PRODUCED IN THE           TQL2  38
C          REDUCTION BY  TRED2, IF PERFORMED.  IF THE EIGENVECTORS      TQL2  39
C          OF THE TRIDIAGONAL MATRIX ARE DESIRED, Z MUST CONTAIN        TQL2  40
C          THE IDENTITY MATRIX.                                         TQL2  41
C                                                                       TQL2  42
C      ON OUTPUT                                                        TQL2  43
C                                                                       TQL2  44
C        D CONTAINS THE EIGENVALUES IN ASCENDING ORDER.  IF AN          TQL2  45
C          ERROR EXIT IS MADE, THE EIGENVALUES ARE CORRECT BUT          TQL2  46
C          UNORDERED FOR INDICES 1,2,...,IERR-1.                        TQL2  47
C                                                                       TQL2  48
C        E HAS BEEN DESTROYED.                                          TQL2  49
C                                                                       TQL2  50
C        Z CONTAINS ORTHONORMAL EIGENVECTORS OF THE SYMMETRIC           TQL2  51
C          TRIDIAGONAL (OR FULL) MATRIX.  IF AN ERROR EXIT IS MADE,     TQL2  52
C          Z CONTAINS THE EIGENVECTORS ASSOCIATED WITH THE STORED       TQL2  53
C          EIGENVALUES.                                                 TQL2  54
C                                                                       TQL2  55
C        IERR IS SET TO                                                 TQL2  56
C          ZERO       FOR NORMAL RETURN,                                TQL2  57
C          J          IF THE J-TH EIGENVALUE HAS NOT BEEN               TQL2  58
C                     DETERMINED AFTER 30 ITERATIONS.                   TQL2  59
C                                                                       TQL2  60
C     CALLS PYTHAG(A,B) FOR SQRT(A**2 + B**2).                          TQL2  61
C                                                                       TQL2  62
C     QUESTIONS AND COMMENTS SHOULD BE DIRECTED TO B. S. GARBOW,        TQL2  63
C     APPLIED MATHEMATICS DIVISION, ARGONNE NATIONAL LABORATORY         TQL2  64
C     ------------------------------------------------------------------TQL2  65
C***REFERENCES  B. T. SMITH, J. M. BOYLE, J. J. DONGARRA, B. S. GARBOW, TQL2  66
C                 Y. IKEBE, V. C. KLEMA, C. B. MOLER, *MATRIX EIGEN-    TQL2  67
C                 SYSTEM ROUTINES - EISPACK GUIDE*, SPRINGER-VERLAG,    TQL2  68
C                 1976.                                                 TQL2  69
C***ROUTINES CALLED  PYTHAG                                             TQL2  70
C***END PROLOGUE  TQL2                                                  TQL2  71
C                                                                       TQL2  72
      IMPLICIT REAL*8 (A-H,O-Z)
      INTEGER I,J,K,L,M,N,II,L1,L2,NM,MML,IERR                          TQL2  73
      DIMENSION D(N),E(N),Z(NM,N)                                       TQL2  74
C     REAL D(N),E(N),Z(NM,N)                                            TQL2  74
C     REAL B,C,C2,C3,DL1,EL1,F,G,H,P,R,S,S2                             TQL2  75
C     REAL PYTHAG                                                       TQL2  76
C                                                                       TQL2  77
C***FIRST EXECUTABLE STATEMENT  TQL2                                    TQL2  78
      IERR = 0                                                          TQL2  79
      IF (N .EQ. 1) GO TO 1001                                          TQL2  80
C                                                                       TQL2  81
      ONE=1.D0
      DO 100 I = 2, N                                                   TQL2  82
  100 E(I-1) = E(I)                                                     TQL2  83
C                                                                       TQL2  84
      F = 0.D0                                                          TQL2  85
      B = 0.D0                                                          TQL2  86
      E(N) = 0.D0                                                       TQL2  87
C                                                                       TQL2  88
      DO 240 L = 1, N                                                   TQL2  89
         J = 0                                                          TQL2  90
         H = DABS(D(L)) + DABS(E(L))                                    TQL2  91
         IF (B .LT. H) B = H                                            TQL2  92
C     .......... LOOK FOR SMALL SUB-DIAGONAL ELEMENT ..........         TQL2  93
         DO 110 M = L, N                                                TQL2  94
            IF (B + DABS(E(M)) .EQ. B) GO TO 120                        TQL2  95
C     .......... E(N) IS ALWAYS ZERO, SO THERE IS NO EXIT               TQL2  96
C                THROUGH THE BOTTOM OF THE LOOP ..........              TQL2  97
  110    CONTINUE                                                       TQL2  98
C                                                                       TQL2  99
  120    IF (M .EQ. L) GO TO 220                                        TQL2 100
  130    IF (J .EQ. 30) GO TO 1000                                      TQL2 101
         J = J + 1                                                      TQL2 102
C     .......... FORM SHIFT ..........                                  TQL2 103
         L1 = L + 1                                                     TQL2 104
         L2 = L1 + 1                                                    TQL2 105
         G = D(L)                                                       TQL2 106
         P = (D(L1) - G) / (2.D0 * E(L))                                TQL2 107
C        R = PYTHAG(P,1.D0)                                             TQL2 108
           PP=DMAX1(DABS(P),ONE)                                        PYTHAG14
           QQ=DMIN1(DABS(P),ONE)                                        PYTHAG15
           IF (QQ.EQ.0.D0) GO TO 20                                     PYTHAG16
   10      CONTINUE                                                     PYTHAG17
           RR=(QQ/PP)**2                                                PYTHAG18
           TT=4.D0+RR                                                   PYTHAG19
           IF (TT.EQ.4.D0) GO TO 20                                     PYTHAG20
           SS=RR/TT                                                     PYTHAG21
           PP=PP+2.D0*PP*SS                                             PYTHAG22
           QQ=QQ*SS                                                     PYTHAG23
           GO TO 10                                                     PYTHAG24
   20    R=PP                                                           PYTHAG25
         D(L) = E(L) / (P + SIGN(R,P))                                  TQL2 109
         D(L1) = E(L) * (P + SIGN(R,P))                                 TQL2 110
         DL1 = D(L1)                                                    TQL2 111
         H = G - D(L)                                                   TQL2 112
         IF (L2 .GT. N) GO TO 145                                       TQL2 113
C                                                                       TQL2 114
         DO 140 I = L2, N                                               TQL2 115
  140    D(I) = D(I) - H                                                TQL2 116
C                                                                       TQL2 117
  145    F = F + H                                                      TQL2 118
C     .......... QL TRANSFORMATION ..........                           TQL2 119
         P = D(M)                                                       TQL2 120
         C = 1.D0                                                       TQL2 121
         C2 = C                                                         TQL2 122
         EL1 = E(L1)                                                    TQL2 123
         S = 0.D0                                                       TQL2 124
         MML = M - L                                                    TQL2 125
C     .......... FOR I=M-1 STEP -1 UNTIL L DO -- ..........             TQL2 126
         DO 200 II = 1, MML                                             TQL2 127
            C3 = C2                                                     TQL2 128
            C2 = C                                                      TQL2 129
            S2 = S                                                      TQL2 130
            I = M - II                                                  TQL2 131
            G = C * E(I)                                                TQL2 132
            H = C * P                                                   TQL2 133
            IF (DABS(P) .LT. DABS(E(I))) GO TO 150                      TQL2 134
            C = E(I) / P                                                TQL2 135
            R = DSQRT(C*C+1.D0)                                         TQL2 136
            E(I+1) = S * P * R                                          TQL2 137
            S = C / R                                                   TQL2 138
            C = 1.D0 / R                                                TQL2 139
            GO TO 160                                                   TQL2 140
  150       C = P / E(I)                                                TQL2 141
            R = DSQRT(C*C+1.D0)                                         TQL2 142
            E(I+1) = S * E(I) * R                                       TQL2 143
            S = 1.D0 / R                                                TQL2 144
            C = C * S                                                   TQL2 145
  160       P = C * D(I) - S * G                                        TQL2 146
            D(I+1) = H + S * (C * G + S * D(I))                         TQL2 147
C     .......... FORM VECTOR ..........                                 TQL2 148
            DO 180 K = 1, N                                             TQL2 149
               H = Z(K,I+1)                                             TQL2 150
               Z(K,I+1) = S * Z(K,I) + C * H                            TQL2 151
               Z(K,I) = C * Z(K,I) - S * H                              TQL2 152
  180       CONTINUE                                                    TQL2 153
C                                                                       TQL2 154
  200    CONTINUE                                                       TQL2 155
C                                                                       TQL2 156
         P = -S * S2 * C3 * EL1 * E(L) / DL1                            TQL2 157
         E(L) = S * P                                                   TQL2 158
         D(L) = C * P                                                   TQL2 159
         IF (B + DABS(E(L)) .GT. B) GO TO 130                           TQL2 160
  220    D(L) = D(L) + F                                                TQL2 161
  240 CONTINUE                                                          TQL2 162
C     .......... ORDER EIGENVALUES AND EIGENVECTORS ..........          TQL2 163
      DO 300 II = 2, N                                                  TQL2 164
         I = II - 1                                                     TQL2 165
         K = I                                                          TQL2 166
         P = D(I)                                                       TQL2 167
C                                                                       TQL2 168
         DO 260 J = II, N                                               TQL2 169
            IF (D(J) .GE. P) GO TO 260                                  TQL2 170
            K = J                                                       TQL2 171
            P = D(J)                                                    TQL2 172
  260    CONTINUE                                                       TQL2 173
C                                                                       TQL2 174
         IF (K .EQ. I) GO TO 300                                        TQL2 175
         D(K) = D(I)                                                    TQL2 176
         D(I) = P                                                       TQL2 177
C                                                                       TQL2 178
         DO 280 J = 1, N                                                TQL2 179
            P = Z(J,I)                                                  TQL2 180
            Z(J,I) = Z(J,K)                                             TQL2 181
            Z(J,K) = P                                                  TQL2 182
  280    CONTINUE                                                       TQL2 183
C                                                                       TQL2 184
  300 CONTINUE                                                          TQL2 185
C                                                                       TQL2 186
      GO TO 1001                                                        TQL2 187
C     .......... SET ERROR -- NO CONVERGENCE TO AN                      TQL2 188
C                EIGENVALUE AFTER 30 ITERATIONS ..........              TQL2 189
 1000 IERR = L                                                          TQL2 190
 1001 RETURN                                                            TQL2 191
      END                                                               TQL2 192
C
      SUBROUTINE BACK(NU,NBACK)
      DO 10 I=1,NBACK
  10  BACKSPACE NU
      RETURN
      END
C
      SUBROUTINE BACKIC(NU,NBACK,IPTR)
      IPTR=IPTR-NBACK
      IF (IPTR.LT.0) IPTR=0
      IF (NBACK.LT.3) THEN
        DO 10 I=1,NBACK
  10    BACKSPACE NU
      ELSE
        REWIND NU
        DO 20 I=1,IPTR
  20    READ (NU)
      ENDIF  
      RETURN
      END
C
C     OVERLAY(G9,10,4)
      SUBROUTINE SPECTR
C
C
C        CALC SPECTRUM FOR MAGNETIC DIPOLE(II=0), ELECTRIC DIPOLE(II=1),
C             OR ELECTRIC QUADRUPOLE(II=2) TRANSITIONS
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      PARAMETER (KCC=KISER/4,KLC4=2*KISER+1,KLAM=10000,KEXC=40)
      PARAMETER (KBGKS=41,KENRGS=21,KCASE=50,KTRAN=600)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C2B/NCFG(KMX),NCFGP(KMX),PMUP(KC,KC),EIG(KMX),EIGP(KMX),
     1  LCSER(KMX),LCSERP(KMX)
      COMMON/C9/L1,L2,CFLAG(KC,2),CGENGY(KC,2),SWT(KC,2),IMAX
      COMMON/C3B/T(KLAM),TP(KLAM),S2(KLAM),SOABSS(KLAM),
     1  AA(KMX),AAP(KMX),GAA(KLAM),GAAP(KLAM),BRNCH(KLAM),
     2  ICUT(66),SGFCUT(66),SFCUT(66),DIDGF(66),DSGFDGF(66),TITLE(20),
     3  FICUT(66),FNUCUT(66),FNUPLT(82),SGF(66),FIPLT(82),SGFPLT(82),
     4  NCSER(KLAM),AAT(KMX),AAPT(KMX)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      COMMON/C6/EMIN,EMAX,SUMWT,FLBDN,FLBDX,FNUNP,FNUXP,NLEV,IEWR
      COMMON/CC/   D(KMX,KMX)
      COMMON/C3LC2/V(KMX,KMX)
      COMMON/C3LC3/CT4(KMX,KMX)
      COMMON/C3LC4/CTA(KMX,KMX)
      COMMON/C3LC5/GOSS(KTRAN,KBGKS)
      COMMON/C3LC6/GAAXC(KMX,KEXC),BRNCHX(KEXC,KEXC)
      CHARACTER*8 ELEM,ELEMJ
      COMMON/EE/ELEM(3,KC,2),VPAR(KPR,2),AVP(9,2),AVEIG(2),AVCG(2),
     1  NPARK(2),NPAV(KC),FJT(KLAM),FJTP(KLAM),NCSERP(KLAM),
     2  GAAT(KLAM),GAAPT(KLAM)
      COMMON/CTKEV/NPTKEV,NTKEV,TKEV(6),TUNRGY(6),BRNCHL(6),BRNCHT(6),
     1  EIONRY
      COMMON/SORTDUM/DUM(2),IDUM(2)
      DIMENSION GFCUT(66)
      DIMENSION X(KLAM),FNU(KLAM),FLAM(KLAM),SUMFJ(KC)
      EQUIVALENCE (CTA,X,FNU),(CT4,FLAM)
      DIMENSION SPID(3)
      COMMON/C7/G1,SUMGAA,SUMGAR,SUMGAAT
      COMMON/C8/EXC(KEXC),JEXC(KEXC),MEXC(KEXC)
      COMMON/ENERGIES/ETOT(KC,2),EE8(KC,2),E0KIN(KC),EKIN(KMX)
      COMMON/PWBORN/NBIGKS,NENRGS,EKMINL,EKMAXL,DELEKL,BIGKS(KBGKS),
     1  XMIN,XMAX,TEV(25),CORR(KENRGS),IBK,IPWR,I1
      DIMENSION ISER(KLAM),EXC1(KEXC),JEXC1(KEXC),ELEMJ(KEXC),DELM1(KC)
      CHARACTER BR1*9,IDFG(15)*11
      CHARACTER*8 LLDES(KLAM),LLDESP(KLAM)
      CHARACTER*8 FIDLS,FIDJJ,LDES,LDESP,PARNAM,COUPL
      CHARACTER*4 LSYMB,H18
      COMMON/CHAR/PARNAM(KPR,2),FIDLS(KMX,2),FIDJJ(KMX,2),LDES(KMX),
     1  LDESP(KMX)
      PARAMETER (MAXBC=50000)
      CHARACTER*12 BUFC
      COMMON/BUFS/BUFC(MAXBC)
      CHARACTER*8 H1,H2,H3,H4,H5,H6,H7,H8,H9,H10,H11,H12,H13,H14,H15,
     1 H17,H19,SPID,IERAS
      DATA H1/1H /,H2/4H ---/,H3/6HINTENS/,H4/3HITY/,H5/6HWAVENU/,
     1  H6/4HMBER/,H7/6H(CM  )/,H8/6HWAVELE/,H9/4HNGTH/,H10/3H(A)/,
     2  H11/2H =/,H12/6HOSCILL/,H13/8HATOR STR/,H14/8HENGTH (G/,
     3  H15/2HF)/,H17/2H-1/,H18/1H(/,H19/7HF.10+6)/
      DATA (SPID(I),I=1,3) /8H MAG DIP,8HELEC DIP,8HELEC QUD/
      CHARACTER*24 AA1,AA2
C
C
C     KMX=260
C     KEXC=40
C     KLAM=10000
C     KTRAN=600
C
C          FOR SPECIAL LUND UNIV. PRINT FORMATS (ON LEVEL-SORT
C               LINE LISTS), SET ILUND=1; OTHERWISE, SET ILUND=0.
C
      ILUND=1
C
C          FOR PAPER WITH 66 LINES PER PAGE, HEADINGS ON EVERY PAGE,
C               SET JLINES=52.
C          FOR PAPER WITH 51 LINES PER PAGE, HEADINGS EVERY SECOND
C               PAGE, SET JLINES=84.
C
      JLINES=52
C
C
CC                                87 06 02  JOE
C          IF DMIN.LT.0, DELETE UPWARD TRANSITIONS FOR LEVEL SORTS.
C          IF ABS(DMIN) GT 1.0 AND LE 50.0, DELETE WEAK LINES ON THE
C               BASIS OF GA<10**ABS(DMIN) RATHER THAN GF<ABS(DMIN).
      NEGTP=0
      IF (DMIN.LT.0.D0) NEGTP=1
      DMINGA=DABS(DMIN)
      IF (DMINGA.GT.1.D0.AND.DMINGA.LE.50.D0) THEN
        IMINGA=DMINGA
        DMINGA=10.D0**IMINGA
        DMIN=0.D0
      ELSE
        DMINGA=0.D0
        IMINGA=0
      ENDIF
CC                                 SLUT
      IF (IARG1.EQ.0) GO TO 92
      IF (IGEN.LT.5) GO TO 92
      READ (IR,8) NBIGKS,EKMINL,EKMAXL,DELEKL,NENRGS,XMIN,XMAX
    8 FORMAT (I5,3F15.10,I10,2F10.2)
      WRITE (IW,9) NBIGKS,EKMINL,EKMAXL,DELEKL,NENRGS,XMIN,XMAX
    9 FORMAT (//I5,3F15.10,I10,2F10.2)
      DO 90 I=1,KTRAN
      DO 90 J=1,NBIGKS
   90 GOSS(I,J)=0.D0
   92 II=IARG1
      IE1=IARG2
      IE2=IARG3
      TUNRGY(1)=9.9D10
      DO 94 I=2,6
   94 TUNRGY(I)=TKEV(I)*8065479.D0/UENRGY
      UENREV=UENRGY/8065.479D0
      GOLD=0.D0
      HOLD=0.D0
      IPWR=1
      IBK=0
C
C          READ REDUCED MUPOLE MATRIX ELEMENTS
C
      IREAD=0
      IF (II.EQ.0) GO TO 104
  100 READ (IR,12) IERAS,N
   12 FORMAT (50X,A1,6X,I1)
      BACKSPACE IR
      IF (IERAS.NE.H18) GO TO 999
      IF (IGEN.LT.5.AND.N.NE.II) GO TO 999
      IPWR=N
      IPTG=0
      IF (IBK.EQ.0.OR.(IPWR.GT.IRMN.AND.IBK.EQ.1)) IPTG=1
      IF (II.NE.1) IPTG=0
      IF (IPTG.EQ.1) WRITE (IW,13) SPID(II+1)
   13 FORMAT (1H1,59X,A9,9H SPECTRUM////)
      IBACK=IREAD
      IF (IGEN.GE.5.AND.N.NE.IRMN) IBACK=0
      IF (IBACK.NE.0) THEN
C       DO 102 I=1,IREAD
C 102   BACKSPACE IC
        CALL BACKIC(IC,IREAD,ICPTR)
        IREAD=0
      ENDIF
  104 L1=IE1-ILA+1
      L2=IE2-ILA+1
      JNX1=NSCONF(2,L1)
      JNX2=NSCONF(2,L2)
      JNX=MAX0(JNX1,JNX2)
      DO 110 I=1,JNX1
      DO 110 J=1,JNX2
        PMUP(I,J)=1.D0
        IF (II.NE.0) THEN
          READ (IR,14) A,B,C,Z,E,F, PMUP(I,J), G,H, FRAC, PID
   14     FORMAT (3A6,2X,3A6,2X, F10.5, A6,A8, F6.4, A2,2E4.1)
          IF (IPTG.EQ.1) WRITE(IW,15) I,A,B,C,J,Z,E,F,G,H,PMUP(I,J),
     1      FRAC,PID
   15     FORMAT (I5,5X,3A6,I10,5X,3A6,10X,A6,A8,1H=,F15.5,6X,5HFRAC=,
     1      F7.4,5X,A2)
          IF (PMUP(I,J).NE.0.D0) DELM1(J)=1.D0/FRAC**2
          CSIGMA=0.D0
          IF (G.EQ.GOLD.AND.H.EQ.HOLD) CSIGMA=8.06662D-18
          GOLD=G
          HOLD=H
        ENDIF
  110 CONTINUE
C          CSIGMA.GT.0.0 FOR PHOTOIONIZATION CROSS-SECTION CALC (SIGMA)
      IF (NSCONF(3,2).GE.0.OR.L1.EQ.L2) CSIGMA=0.D0
C
  120 GFCUT(1)=0.D0
      ERAS=-14.D0
      DEL=0.25D0
      DO J=2,65
        ERAS=ERAS+DEL
        GFCUT(J)=DEXP(2.302585093D0*ERAS)
      ENDDO
      GFCUT(66)=1.0D10
      FNUX=1.0D8/(FLBDN*UENRGY)
      FNUN=1.0D8/(FLBDX*UENRGY)
      ASSIGN 57 TO IFMT1
      ASSIGN 58 TO IFMT2
      IF (CSIGMA.GT.0.D0) GO TO 150
      ASSIGN 56 TO IFMT1
      IF (TEXCIT.EQ.0.D0) GO TO 150
      ASSIGN 51 TO IFMT1
      ASSIGN 53 TO IFMT2
C
C
C
  150 REWIND IE1
      REWIND IE2
      REWIND 20
      FNUNP=1.0D20
      FNUXP=0.D0
      SJ31=100.D0
      SJ32=100.D0
      PMAX=DSQRT(2.D0/3.D0)
      PMAX=0.0001D0
      DO 160 I=1,JNX1
      DO 160 J=1,JNX2
        IF (DABS(PMUP(I,J)).GT.DABS(PMAX)) PMAX=PMUP(I,J)
  160 CONTINUE
      A=1.D0/PMAX
      PSQ=3.0375D-6*(PMAX**2)
      IF (II.EQ.0) PSQ=PSQ*(0.5D0/137.04D0)**2
      IF (IGEN.GE.5) GO TO 162
      IF (II.EQ.2) PSQ=PSQ*((3.14159D0*0.529D0)**2)/5.D0
      GO TO 163
  162 PSQ=PSQ*3.D0
  163 SUMS2=0.D0
      SUMS2N=0.D0
      SUMS2M=0.D0
      SUMGF=0.D0
      SUMF=0.D0
      SUMGAR=0.D0
      JCUTX=0
      DO 170 J=1,66
        ICUT(J)=0
        SGFCUT(J)=0.D0
  170 SFCUT(J)=0.D0
      I=0
      I0=0
      I0N=0
      I0X=0
      IJJP=0
      ILOSTT=0
      ICDLT=0
      IBRNCH=0
      D0MAX=0.D0
      D0MAX1=0.D0
      DO 175 L=1,KMX
      DO 175 J=1,KEXC
  175 GAAXC(L,J)=0.D0
  180 IF (IPTG.EQ.1) WRITE (IW,18)
   18 FORMAT (////18X,12HNO. OF LINES/
     1  5X,1HJ,5X,2HJP,5X,4HJ-JP,3X,5HTOTAL,3X,4HKLAM,4X,5HILOST,
     2  8X,4HDMIN,6X,3HI0 ,5X,3HI0N,5X,3HI0X,3X,6HITRUNC,3X,5HNTKEV/)
C
C          READ DIPOLE MATRIX FOR BASIS VECTORS
C
C 200 READ (IC) SCRJ8,SCRJ8P,NLS,NLSP, ((D(L,LP),L=1,NLS), LP=1,NLSP),
C    1  NCFG,NCFGP
C     IREAD=IREAD+1
C ********************************************************** A.KRAMIDA v
  200 READ (IC) SCRJ8,SCRJ8P,NLS,NLSP,NCFG,NCFGP
      IMSQ=NLS*NLSP
      CALL UNPK1(IC,NLS,NLSP,D,KMX,KMX,BUFC,IMSQ,MAXBC)
      ICPTR=ICPTR+2
      IREAD=IREAD+2
C ********************************************************** A.KRAMIDA ^
      IF (SCRJ8.LT.0.D0) GO TO 560
      DO 220 L=1,NLS
      DO 220 LP=1,NLSP
        IN=NCFG(L)
        JN=NCFGP(LP)
  220 D(L,LP)=D(L,LP)*A*PMUP(IN,JN)
  250 ITRUNC=I
      I00=I0
      I0N0=I0N
      I0X0=I0X
      IJJP0=IJJP
      SUMS20=SUMS2
      SUMSN0=SUMS2N
      SUMSM0=SUMS2M
      ILOST=0
C
C          READ EIGENVALUES AND VECTORS
C          AND CALC MUPOLE MATRIX FOR ACTUAL EIGENVECTORS
C
  300 IF (SCRJ8-SJ31) 301,302,305
  301 CONTINUE
  302 REWIND IE1
C 301 BACKSPACE IE1
C     BACKSPACE IE1
C 302 BACKSPACE IE1
C     BACKSPACE IE1
  305 READ (IE1) SJ31,NLS, (EIG(LP), (V(L,LP),L=1,NLS), LP=1,NLS),
     1  ((V(L,LP),L=1,NLS), LP=1,NLS),LCSER,LDES
      READ (IE1) LX, (AA(LP),AAT(LP), LP=1,NLS)
      IF (SCRJ8-SJ31) 301,308,305
  308 IF (IE1.EQ.IE2) SJ32=SJ31
      IF (LX.NE.0.AND.LX.NE.NLS) IBRNCH=7
      DO L=1,NLS
        DO LP=1,NLSP
          ERASS=0.D0
          ERASA=0.D0
          DO K=1,NLS
            ERAS=V(K,L)*D(K,LP)
            ERASA=ERASA+DABS(ERAS)
            ERASS=ERASS+ERAS
          ENDDO
          CTA(L,LP)=ERASA
          CT4(L,LP)=ERASS
        ENDDO
      ENDDO
  400 IF (SCRJ8P-SJ32) 401,402,405
  401 CONTINUE
  402 REWIND IE2
C 401 BACKSPACE IE2
C     BACKSPACE IE2
C 402 BACKSPACE IE2
C     BACKSPACE IE2
  405 READ (IE2) SJ32,NLSP, (EIGP(LP), (V(L,LP),L=1,NLSP), LP=1,NLSP),
     1  ((V(L,LP),L=1,NLSP), LP=1,NLSP),LCSERP,LDESP
      READ (IE2) LXP, (AAP(LP),AAPT(LP), LP=1,NLSP)
     1  ,NLST,IXC,IXC1, (EXC(J), (GAAXC(LP+NLST,J),LP=1,LXP), J=1,IXC1)
      IF (SCRJ8P-SJ32) 401,408,405
  408 IF (IE1.EQ.IE2) SJ31=SJ32
      IF (LXP.NE.0.AND.LXP.NE.NLSP) IBRNCH=7
C
C          CALC SPECTRUM
C
      IJJP=0
      DELDMIN=0.1D0
      ICONTIN=0
      DO 520 L=1,NLS
      DO 520 LP=1,NLSP
        IF (EIG(L).GT.-4000.D0.AND.EIGP(LP).GT.-4000.D0) GO TO 450
        ICONTIN=7
        GO TO 520
  450   IF (IE1.EQ.IE2.AND.SCRJ8.EQ.SCRJ8P.AND.L.GT.LP) GO TO 520
        ERASA=0.D0
        ERAS=0.D0
        DO K=1,NLSP
          ERASA=ERASA+CTA(L,K)*DABS(V(K,LP))
          ERAS=ERAS+CT4(L,K)*V(K,LP)
        ENDDO
        ERASS=ERAS*DABS(ERAS)
        ERAS=ERAS*ERAS
        SUMS2=SUMS2+ERAS
        IF (IE1.NE.IE2) GO TO 490
        IF (SCRJ8.NE.SCRJ8P) GO TO 480
        IF (L.EQ.LP) GO TO 520
  480   SUMS2=SUMS2+ERAS
  490   CONTINUE
        D0=ERAS
        ERAS1=DABS(EIG(L)-EIGP(LP))
        IF (LCSER(L).LE.NCK(1).AND.LCSERP(LP).LE.NCK(2)) GO TO 494
        IF (L1.NE.L2) GO TO 492
        IF (LCSERP(LP).LE.NCK(1).AND.LCSER(L).LE.NCK(2)) GO TO 494
  492   ICDLT=ICDLT+1
        GO TO 520
  494   SUMS2N=SUMS2N+ERAS
        IF (L1.EQ.L2.AND.SCRJ8.EQ.SCRJ8P) SUMS2N=SUMS2N+ERAS
        IF (ERAS1.GE.FNUN) GO TO 498
        I0N=I0N+1
        GO TO 520
  498   IF (ERAS1.LE.FNUX) GO TO 499
        I0X=I0X+1
        GO TO 520
  499   IF (TEXCIT.LE.0.D0) GO TO 501
        TEMP=ERAS1*UENRGY
        GA=0.6698D0*PSQ*ERAS*(TEMP**3)
        D0=GA*DEXP(-(DMAX1(EIG(L),EIGP(LP))-EMEAN)/TEXCIT)
  501   IF (D0.GE.DMIN) GO TO 510
        I0=I0+1
        IF (D0.GT.D0MAX) D0MAX=D0
        GO TO 520
  510   IF (I.LT.KLAM) GO TO 515
        IF (ITRUNC.GT.0) GO TO 511
        IF (ITRUNC.EQ.0) GO TO 513
  511   I=ITRUNC
        I0=I00
        I0N=I0N0
        I0X=I0X0
        SUMS2=SUMS20
        SUMS2N=SUMSN0
        SUMS2M=SUMSM0
        IF (DMIN.LE.0.D0.AND.NTKEV.EQ.0) GO TO 560
        IF (DMIN.LE.0.D0.AND.TEXCIT.GT.0.D0) DMIN=1.0D4
        IF (DMIN.LE.0.D0) DMIN=0.00001D0
C       DO 512 I=1,IREAD
C 512   BACKSPACE IC
        CALL BACKIC(IC,IREAD,ICPTR)
        IREAD=0
        DMIN=DMIN+DMIN1(DMIN,DELDMIN)
        IF (DMIN.GT.4.D0) DMIN=2.D0*DMIN
C A.KRAMIDA
        IF (IMINGA.GT.0) DMINGA=2.D0*DMINGA
        GO TO 150
  513   ILOST=ILOST+1
        GO TO 520
  515   I=I+1
        IJJP=IJJP+1
        ERAS1=1.D-6*(SCRJ8+0.01D0*DFLOAT(L))
        T(I)=EIG(L)+ERAS1
        FJT(I)=SCRJ8
        ERAS2=1.D-6*(SCRJ8P+0.01D0*DFLOAT(LP))
        TP(I)=EIGP(LP)+ERAS2
        FJTP(I)=SCRJ8P
        IF (IGDLEV.EQ.0.OR.I.EQ.1) GO TO 518
        IF (T(I).EQ.T(1)) GO TO 518
        IF (T(I).LT.T(1)) GO TO 517
        I=I-1
        IJJP=MAX0(IJJP-1,0)
        GO TO 520
  517   T(1)=T(I)
        FJT(1)=FJT(I)
        TP(1)=TP(I)
        FJTP(1)=FJTP(I)
        IJJP=MAX0(IJJP-I+1,0)
        I=1
        SUMS2M=0.D0
  518   GAA(I)=(2.D0*SCRJ8+1.D0)*AA(L)
        GAAP(I)=(2.D0*SCRJ8P+1.D0)*AAP(LP)
        GAAT(I)=(2.D0*SCRJ8+1.D0)*AAT(L)
        GAAPT(I)=(2.D0*SCRJ8P+1.D0)*AAPT(LP)
        S2(I)=ERAS
        SUMS2M=SUMS2M+ERAS
        SOABSS(I)=(ERASS+1.0D-30)/(ERASA*ERASA+1.0D-30)
        ISER(I)=LP-(NLSP-LXP)+NLST
        NCSER(I)=LCSER(L)
        NCSERP(I)=LCSERP(LP)
        LLDES(I)=LDES(L)
        LLDESP(I)=LDESP(LP)
  519   IF (IE1.NE.IE2.OR.T(I).LT.TP(I)) GO TO 5191
        T(I)=EIGP(LP)+ERAS2
        FJT(I)=SCRJ8P
        TP(I)=EIG(L)+ERAS1
        FJTP(I)=SCRJ8
        ERAS=GAA(I)
        GAA(I)=GAAP(I)
        GAAP(I)=ERAS
        ERAS=GAAT(I)
        GAAT(I)=GAAPT(I)
        GAAPT(I)=ERAS
        NCSER(I)=LCSERP(LP)
        NCSERP(I)=LCSER(L)
        LLDES(I)=LDESP(LP)
        LLDESP(I)=LDES(L)
C******************************************************* A.KRAMIDA v
 5191   IF (IMINGA.EQ.0) GO TO 520
        ERAS1=(DABS(T(I)-TP(I)))*UENRGY
        ERAS2=1.0D8/ERAS1
        GF=PSQ*S2(I)*ERAS1
        IF (IGEN.LT.5.AND.II.EQ.2) GF=GF/(ERAS2**2)
        ALGGF=-99.999D0
        IF (GF.GT.0.D0) ALGGF=DLOG10(GF)
        GA=0.66698D0*GF*ERAS1*ERAS1
        IF (TEXCIT.GT.0.D0) 
     1    ALGGF=GA*DEXP(-(DMAX1(T(I),TP(I))-EMEAN)/TEXCIT)
        JC=NCSERP(I)
        IF (CSIGMA.GT.0.D0) GA=CSIGMA*GF*DELM1(JC)/(2.D0*SCRJ8P+1.D0)
        IF (DABS(GA).LT.DMINGA) THEN
          I=I-1
          I0=I0+1
          IF (GA.GT.D0MAX1) D0MAX1=GA
          IJJP=MAX0(IJJP-1,0)
        ENDIF
C**************************************************** A.KRAMIDA ^
  520 CONTINUE
  550 IF (IPTG.EQ.1.AND.DMIN.LE.9999.D0) WRITE (IW,52) SCRJ8,SCRJ8P,
     1  IJJP,I,KLAM,ILOST,DMIN,I0,I0N,I0X,ITRUNC,NTKEV
   52 FORMAT (1H ,2F6.1,4I8,F15.6,I6,4I8)
      IF (IPTG.EQ.1.AND.DMIN.GT.9999.D0) WRITE (IW,49) SCRJ8,SCRJ8P,
     1  IJJP,I,KLAM,ILOST,DMIN,I0,I0N,I0X,ITRUNC,NTKEV
   49 FORMAT (1H ,2F6.1,4I8,1PE15.3,I6,4I8)
      IF (I.EQ.KLAM.AND.ILOST.GT.0) GO TO 560
      GO TO 200
C
C          SORT LINES BY LEVELS OF FIRST PARITY
C
  560 IMAX=I
      IF (IMAX.EQ.0) GO TO 980
      ILOSTT=ILOSTT+ILOST
      IPT=0
      IF (MOD(ISPECC,2).NE.0) IPT=1
      IF (ISPECC.EQ.9) IPT=0
      IF (IGEN.GE.5) IPT=IPTG
      IF (IPT.EQ.0.AND.IGEN.LT.5) GO TO 567
      DO 562 I=1,IMAX
  562 X(I)=1.0D8*T(I)+TP(I)
      CALL SORT2(IMAX,12,X,D,ISER,T,NCSER,NCSERP,TP,FJT,FJTP,S2,SOABSS,
     1  GAA,GAAP,GAAT)
      IF (IMAX.LE.1) GO TO 563
      CALL ORDER2(IMAX,D,GAAPT)
      CALL ORDERCH(IMAX,D,LLDES)
      CALL ORDERCH(IMAX,D,LLDESP)
  563 IF (IGEN.LT.5) GO TO 567
      IF (IMAX.LE.KTRAN) GO TO 565
      WRITE (IW,54) KTRAN,IMAX
   54 FORMAT (//26H0*****WARNING-- ONLY FIRST,I5,3H OF,I6,
     1  42H LINES RETAINED, FOR LACK OF STORAGE SPACE///)
      IMAX=KTRAN
  565 IF (IPWR.NE.IRMN) GO TO 567
      EK=EKMINL+DELEKL*DFLOAT(IBK)
      IBK=IBK+1
      IF (IBK.GT.KBGKS) STOP 57
      BIGKS(IBK)=EK
  567 SUMFIU=0.D0
      SUMFID=-0.D0
      SUMGFPH=0.D0
      JCX=MIN0(NSCONF(2,2),NCK(2))
      DO 570 JC=1,JCX
  570 SUMFJ(JC)=0.D0
      SUMGA=0.D0
      S2MAX=0.D0
      GFMAX=0.D0
      I1=1
      J=0
      JNXX=JNX
      IJOE=1
      DO 599 I=1,IMAX
        IF (J.GT.0) GO TO 575
        IF (IPT.EQ.0) GO TO 575
        IF (ILUND.NE.0.AND.I.GT.1) GO TO 575
        WRITE (IW,55) SPID(II+1),UENRGY,UENREV,
     1    (JN, (ELEM(L,JN,L1),L=1,3), (ELEM(L,JN,L2),L=1,3), JN=1,JNXX)
   55   FORMAT (1H1,9X,A8,9H SPECTRUM,5X,21H(ENERGIES IN UNITS OF,
     1    F8.1,7H CM-1 =,F8.2,4H EV)//(I5,6X,3A6,12H   ---      ,3A6))
        IF (ILUND.NE.0) THEN
          WRITE (IW,1056)
 1056     FORMAT (/'            E      J     LEVEL        DELTA E ',
     1      ' LAMBDA(A)  LOG GF GA(SEC-1) CF/BR'/)
        ELSE
  572     IF (TEXCIT.EQ.0.D0) WRITE (IW,IFMT1)
          IF (TEXCIT.GT.0.D0) WRITE (IW,IFMT1) TEXCIT
   51     FORMAT (/1H0,8X,7H   E   , 3X,8HJ   CONF,11X,8H   EP   , 2X,
     1      4H JP ,6H CONFP,10X,
     2    8H DELTA E,3X,9HLAMBDA(A),10H S/PMAX**2,3X,2HGF,10H GA*BLTZMN,
     3      10H GA(SEC-1),9H CF,BRNCH/103X,6H(TEXC=,F7.1,1H))
   56     FORMAT (/1H0,8X,18H   E      J   CONF,11X,8H   EP   , 
     1      12H   JP  CONFP,10X,
     2      45H DELTA E   LAMBDA(A) S/PMAX**2   GF    LOG GF,
     3      19H GA(SEC-1) CF,BRNCH/)
   57     FORMAT (/1H0,8X,18H   E      J   CONF,11X,8H   EP   ,
     1      12H   JP  CONFP,10X,
     2      45H DELTA E   LAMBDA(A) S/PMAX**2   GF    LOG GF,
     3      16H SIGMA(CM2)   CF/)
          J=JLINES-JNXX
          JNXX=MIN0(5,JNX)
        ENDIF
  575   FNU(I)=DABS(T(I)-TP(I))
        ERAS1=FNU(I)*UENRGY
        FLAM(I)=1.0D8/ERAS1
        IF (S2(I).GT.S2MAX) S2MAX=S2(I)
        GF=PSQ*S2(I)*ERAS1
        IF (IGEN.GE.5) GOSS(I,IBK)=GOSS(I,IBK)+GF
        IF (IGEN.LT.5.AND.II.EQ.2) GF=GF/(FLAM(I)**2)
        ALGGF=-99.999D0
        IF (GF.GT.0.D0) ALGGF=DLOG10(GF)
        GA=0.66698D0*GF*ERAS1*ERAS1
        IF (TEXCIT.GT.0.D0)
     1    ALGGF=GA*DEXP(-(DMAX1(T(I),TP(I))-EMEAN)/TEXCIT)
        JC=NCSERP(I)
        IF (CSIGMA.GT.0.D0) GA=CSIGMA*GF*DELM1(JC)/(2.D0*FJT(I)+1.D0)
        IF (GF.GT.GFMAX) GFMAX=GF
        SUMGF=SUMGF+GF
        SUMF=SUMF+GF/(2.D0*FJT(I)+1.D0)
        IF (IPT.EQ.0) GO TO 599
        IF (ILUND.NE.0) THEN
          NCCC=NCSER(I)
          IF (IJOE.GT.0) WRITE (IW,1057) T(I),FJT(I),NCCC,LLDES(I),
     1      (ELEM(L,NCCC,L1),L=1,3)
 1057     FORMAT (5X,7H* * *  ,F10.3,F5.1,I4,2H (,A8,4X,3A6,6H * * *,/)
          IJOE=0
          IF (T(I).LT.TP(I).AND.NEGTP.EQ.1) GO TO 578
          IF (GA.LT.DMINGA) GO TO 578
          WRITE (IW,1058) I,TP(I),FJTP(I),
     1      NCSERP(I),LLDESP(I),FNU(I),FLAM(I),ALGGF,GA,SOABSS(I)
 1058     FORMAT (1H ,I4,F11.3,F5.1,I3,1X,1H(,A8,F11.3,
     1      F11.3,F8.3,1PE10.3,0PF6.2)
        ELSE
  577     WRITE (IW,IFMT2)I,T(I),FJT(I),NCSER(I),LLDES(I),TP(I),FJTP(I),
     1    NCSERP(I),LLDESP(I),FNU(I),FLAM(I),S2(I),GF,ALGGF,GA,SOABSS(I)
   53     FORMAT (1H ,I4,F11.4,F5.1,I3,2H (,A8,F13.4,F5.1,I3,2H (,A8,
     1      F13.4,F12.4,F8.3,F9.4,1P2E9.2,0PF8.4)
   58     FORMAT (1H ,I4,F11.4,F5.1,I3,2H (,A7,F13.4,F5.1,I3,2H (,A7,
     1      F13.4,F12.4,F8.3,F9.4,F8.3,1PE10.3,0PF8.4)
          J=J-1
        ENDIF
  578   IF (T(I).GT.TP(I)) GO TO 580
        SUMFIU=SUMFIU+GF
        SUMFJ(JC)=SUMFJ(JC)+GF
        GO TO 584
  580   SUMGA=SUMGA+GA
        SUMFID=SUMFID-GF
  584   CONTINUE
        IF (IABS(IW6).LE.6) GO TO 585
        IF (TP(I).LE.T(I)) GO TO 1584
        SUMGFPH=SUMGFPH+GF
 1584   IF (I.EQ.IMAX) GO TO 2584
        IF (DABS(TP(I+1)-TP(I)).LT.1.0D-6*TP(I)) GO TO 585
 2584   JJJ=NCSER(I)
        JJJP=NCSERP(I)
        EPHOTON=ETOT(JJJP,2)-ETOT(JJJ,1)
        EBD=TP(I)-EE8(JJJP,2)*109737.31D0/UENRGY
        DELEBDBD=EBD-T(I)
        EK=EPHOTON-DELEBDBD
        WRITE (IW,4584) EPHOTON,EBD,DELEBDBD,SUMGFPH,EK
 4584   FORMAT (' EPHOTON(AV)=',F9.4,5X,'   EBOUND=',F9.4,8X,
     1    '   DELE-BDBD=',F9.4,12X,'  SUMGF=',F9.4,6X,'   EKIN=',F9.4)
        SUMGFPH=0.D0
  585   IF (I.EQ.IMAX) GO TO 586
        IF (T(I+1).EQ.T(I)) GO TO 599
  586   ERAS=2.D0*FJT(I)+1.D0
        FLIFE=9.9946D33
        IF (SUMGA.GT.0.D0) FLIFE=ERAS/SUMGA
        ERAS=1.D0/ERAS
        SUMFIU=SUMFIU*ERAS
        SUMFID=SUMFID*ERAS
        SUMFI=SUMFIU+SUMFID
        IF (ILUND.NE.0) THEN
          IJOE=1
          WRITE (IW,1059) SUMFIU,SUMFID,SUMFI,FLIFE,SUMGA
 1059     FORMAT (/1X,6HSUMFI=,F7.4,F8.4,2H =,F8.4,2X,
     1      9HRAD.LIFE=,1PE10.3,4H SEC,2X,6HSUMGA=,E10.3/)
        ELSE
          WRITE (IW,59) T(I),FJT(I),SUMFIU,SUMFID,SUMFI,FLIFE,SUMGA
   59     FORMAT (5X,F13.4,F5.1,17X,6HSUMFI=,F7.4,F8.4,2H =,F8.4,5X,
     1      9HLIFETIME=,1PE10.3,4H SEC,5X,6HSUMGA=,E10.3)
        ENDIF
  589   DO 590 JC=1,JCX
  590   SUMFJ(JC)=SUMFJ(JC)*ERAS
        IF (JCX.GT.1) WRITE (IW,60) (SUMFJ(JC),JC, JC=1,JCX)
   60   FORMAT (6X,13HSUMF BY CONF=,10(F8.4,I3)/19X,10(F8.4,I3))
        DO 592 L=I1,I
          BRNCH(L)=0.D0
          IF (T(L).LT.TP(L)) GO TO 592
          BRNCH(L)=GAAT(L)+SUMGA
          IF (BRNCH(L).LE.0.D0) GO TO 592
          ERAS1=FNU(L)*UENRGY
          BRNCH(L)=GAA(L)*0.66698D0*PSQ*S2(L)*(ERAS1**3)/BRNCH(L)
  592   CONTINUE
        I1=I+1
        SUMFIU=0.D0
        SUMFID=-0.D0
        DO 595 JC=1,JCX
  595   SUMFJ(JC)=0.D0
        SUMGA=0.D0
C       WRITE (IW,61)
C  61   FORMAT (1H )
        IF (ILUND.NE.0) THEN
          IJOE=1
C         WRITE (IW,2061)
C2061     FORMAT ('      =  =  =  =  =  =  =  =  =  =  =  =  =  =  ='/)
        ELSE
          J=J-2
          IF (JCX.GT.1) J=J-(JCX+9)/10
        ENDIF
  599 CONTINUE
      CALL CLOCK(TIME)
      DELT=TIME-TIME0
      IF (IW6.LT.0) WRITE (*,2059) DELT
 2059 FORMAT (' FINISHED FIRST-PARITY SORT AT TIME=',F9.3,' MIN')
C
C          SORT LINES BY LEVELS OF SECOND PARITY
C
      IF (CSIGMA.GT.0.D0) ASSIGN 56 TO IFMT1
      IPT=0
      IF (ISPECC.GE.8.OR.ICONTIN.NE.0) IPT=1
      IF (MOD(ISPECC/2,2).NE.0) IPT=2
      IF (IPT.EQ.0) GO TO 700
      BRNCHR=0.D0
      DO 602 I=1,6
  602 BRNCHT(I)=0.D0
      BRNCHA=0.D0
      DO 605 J=1,KEXC
        DO 604 I=1,KEXC
  604   BRNCHX(I,J)=0.D0
        MEXC(J)=J
        ERAS=DFLOAT(10000)*DFLOAT(JEXC(J))
  605 V(J,23)=ERAS+EXC(J)
      CALL SORT2(IXC1,3,V(1,23),D,MEXC,EXC,JEXC,IDUM,DUM,DUM,DUM,DUM,
     1  DUM,DUM,DUM,DUM)
      DO 608 I=1,IMAX
  608 V(I,23)=T(I)+1.0D9*TP(I)
      CALL SORT2(IMAX,12,V(1,23),D,ISER,T,NCSER,NCSERP,TP,FJT,FJTP,
     1  S2,SOABSS,GAA,GAAP,GAAT)
      IF (IMAX.GT.1) THEN
        CALL ORDER2(IMAX,D,GAAPT)
        CALL ORDER2(IMAX,D,BRNCH)
        CALL ORDERCH(IMAX,D,LLDES)
        CALL ORDERCH(IMAX,D,LLDESP)
      ENDIF
  609 SUMFIU=0.D0
      SUMFID=-0.D0
      SUMGA=0.D0
      I1=1
      J=0
      JNXX=JNX
      IJOE=1
      DO 640 I=1,IMAX
        FNU(I)=DABS(T(I)-TP(I))
        ERAS1=FNU(I)*UENRGY
        FLAM(I)=1.0D8/ERAS1
        IF (J.GT.0) GO TO 610
        IF (IPT.LT.2) GO TO 610
        IF (ILUND.NE.0.AND.I.GT.1) GO TO 610
        WRITE (IW,55) SPID(II+1),UENRGY,UENREV,
     1    (JN,(ELEM(L,JN,L1),L=1,3),(ELEM(L,JN,L2),L=1,3),JN=1,JNXX)
        IF (ILUND.NE.0) THEN
          WRITE (IW,1056)
        ELSE
          IF (TEXCIT.EQ.0.D0) WRITE (IW,IFMT1)
          IF (TEXCIT.GT.0.D0) WRITE (IW,IFMT1) TEXCIT
          J=JLINES-JNXX
          JNXX=MIN0(5,JNX)
        ENDIF
  610   GF=PSQ*S2(I)*ERAS1
        IF (IGEN.LT.5.AND.II.EQ.2) GF=GF/(FLAM(I)**2)
        ALGGF=-99.999D0
        IF (GF.GT.0.D0) ALGGF=DLOG10(GF)
        GA=0.66698D0*GF*ERAS1*ERAS1
        IF (TEXCIT.GT.0.D0)
     1    ALGGF=GA*DEXP(-(DMAX1(T(I),TP(I))-EMEAN)/TEXCIT)
        IF (IPT.LT.2) GO TO 612
        IF (ILUND.EQ.0) GO TO 611
        NCCC=NCSERP(I)
        IF (IJOE.GT.0) WRITE (IW,1057) TP(I),FJTP(I),NCCC,LLDESP(I),
     1    (ELEM(L,NCCC,L2),L=1,3)
        IJOE=0
CC
        IF (T(I).GT.TP(I).AND.NEGTP.EQ.1) GO TO 612
        IF (GA.LT.DMINGA) GO TO 612
        WRITE (IW,1058) I,T(I),FJT(I),NCSER(I),LLDES(I),
     1    FNU(I),FLAM(I),ALGGF,GA,SOABSS(I)
        GO TO 612
  611   WRITE (IW,IFMT2) I,T(I),FJT(I),NCSER(I),LLDES(I),TP(I),FJTP(I),
     1    NCSERP(I),LLDESP(I),FNU(I),FLAM(I),S2(I),GF,ALGGF,GA,SOABSS(I)
        J=J-1
  612   IF (T(I).LT.TP(I)) GO TO 615
        SUMFIU=SUMFIU+GF
        GO TO 617
  615   SUMGA=SUMGA+GA
        SUMGAR=SUMGAR+GA
        SUMFID=SUMFID-GF
  617   CONTINUE
        IF (I.EQ.IMAX) GO TO 620
        IF (TP(I+1).EQ.TP(I)) GO TO 640
  620   ERAS=2.D0*FJTP(I)+1.D0
        FLIFE=9.9946D33
        IF (SUMGA.GT.0.D0) FLIFE=ERAS/SUMGA
        ERAS=1.D0/ERAS
        SUMFIU=SUMFIU*ERAS
        SUMFID=SUMFID*ERAS
        SUMFI=SUMFIU+SUMFID
        IF (ILUND.EQ.0) GO TO 621
        IJOE=1
        IF (IPT.GE.1)
     1    WRITE (IW,1059) SUMFIU,SUMFID,SUMFI,FLIFE,SUMGA
        GO TO 1621
  621   IF (IPT.GE.1)
     1    WRITE (IW,62) TP(I),FJTP(I),SUMFIU,SUMFID,SUMFI,FLIFE,SUMGA
   62   FORMAT (12X,F13.3,F6.1,9X,6HSUMFI=,F7.4,F8.4,2H =,F8.4,5X,
     1    14HRAD. LIFETIME=,1PE10.3,4H SEC,5X,6HSUMGA=,E10.3)
 1621   BRNCH(I)=GAAPT(I)+SUMGA
        IF (BRNCH(I).LE.0.D0) GO TO 630
        BRNCHA=BRNCHA+GAAP(I)*(GAAPT(I)-GAAP(I))/BRNCH(I)
        BRION=GAAPT(I)/BRNCH(I)
        IF (IPT.LT.1.OR.BRION.LE.0.D0) GO TO 622
        FLIFE=1.D0/(ERAS*(SUMGA+GAAPT(I)))
        WRITE (IW,63) BRION,FLIFE,GAAPT(I)
   63   FORMAT (55X,6HBRION=,1PE10.3,5X,14HTOT. LIFETIME=,E10.3,
     1    4H SEC,4X,7HGAATOT=,E10.3)
        J=J-1
  622   IF (IXC.EQ.0) GO TO 625
        J2=ISER(I)
        DO 624 JJ=1,IXC
        M1=MEXC(JJ)
        JEXC1(JJ)=JEXC(JJ)
        EXC1(JJ)=EXC(JJ)
        DO 624 JK=1,IXC
        M2=MEXC(JK)
        BRNCHX(JJ,JK)=BRNCHX(JJ,JK)+GAAXC(J2,M1)*GAAXC(J2,M2)/BRNCH(I)
  624   CONTINUE
  625   ERAS=0.D0
        DO 627 L=I1,I
        GA=0.D0
        IF (T(L).GT.TP(L)) BRNCH(L)=0.D0
        IF (T(L).GT.TP(L)) GO TO 627
        GA=0.66698D0*PSQ*S2(L)*((FNU(L)*UENRGY)**3)
        BRNCH(L)=GAAP(I)*GA/BRNCH(I)
        BRNCHR=BRNCHR+BRNCH(L)
        ERAS=ERAS+BRNCH(L)
  627   CONTINUE
C            PRINT T-DEPENDENCE OF BRNCH, SUMMED OVER BOTH
C                 UPPER AND LOWER LEVELS
        IF (NTKEV.EQ.0) GO TO 630
        NC=NCSERP(I)
        LL=NPAV(NC)
        ERAS1=VPAR(LL,L2)-TP(I)
        NP1=NTKEV+1
        DO 629 L=1,NP1
        BRNCHL(L)=ERAS*DEXP(ERAS1/TUNRGY(L))
  629   BRNCHT(L)=BRNCHT(L)+BRNCHL(L)
        IF (NPTKEV.GT.1) WRITE (IW,64) (TKEV(L),BRNCHL(L), L=1,NP1)
   64   FORMAT (18H T(KEV), BRNCH=   ,6(0PF6.1,1PE11.4))
        J=J-1
  630   CONTINUE
        I1=I+1
        SUMFIU=0.D0
        SUMFID=-0.D0
        SUMGA=0.D0
        IF (ILUND.EQ.0) GO TO 639
        IJOE=1
C       WRITE (IW,2061)
        GO TO 640
C 639   WRITE (IW,61)
  639   CONTINUE
        J=J-2
  640 CONTINUE
      JNXX=JNX
      IF (NPTKEV.GT.0.AND.BRNCHR.GT.0.D0)
     1  WRITE (IW,55) SPID(II+1),UENRGY,UENREV,
     2  (JN, (ELEM(L,JN,L1),L=1,3), (ELEM(L,JN,L2),L=1,3), JN=1,JNXX)
C
      WRITE (IW,65) BRNCHR,BRNCHA
   65 FORMAT (//14X,10H GM*FRBAR=,1PE11.4,10X,9HGM*FABAR=,E11.4)
      NP1=NTKEV+1
      IF (NTKEV.GT.0) WRITE (IW,64) (TKEV(L),BRNCHT(L), L=1,NP1)
      IF (NPTKEV.EQ.0.OR.NPTKEV.EQ.2) GO TO 670
      JNXX=MIN0(JNXX,3)
      WRITE (33,71) (ELEM(L,1,1),L=1,3),((ELEM(L,JN,2),L=1,3),JN=1,JNXX)
   71 FORMAT (4(3A6,2X))
      WRITE (33,72) (TKEV(L), L=2,NP1)
   72 FORMAT (37X,11HT(KEV)=INF.,2X,5F6.2)
      GM=1.D0
      NN=NSCONF(2,2)
      LL=0
      DO 642 I=1,NOSUBC
      MM=NOSUBC-I+1
      ERAS=NIJK(MM,NN,2)
      IF (ERAS.GT.0.D0) LL=LL+1
      IF (LL.EQ.1) GO TO 642
      ERAS1=4.D0*FLLIJK(MM,NN,2)+2.D0
      GM=GM*FCTRL(ERAS1)/(FCTRL(ERAS)*FCTRL(ERAS1-ERAS))
  642 CONTINUE
C     DECODE (6,73,ELEM(2,NN,2)) EK
      READ(ELEM(2,NN,2),73) EK
   73 FORMAT (F6.2)
      EK=EK*0.0136058D0
      DO 644 L=2,NP1
  644 BRNCHT(L)=BRNCHT(L)/BRNCHT(1)
      BRNCHT(1)=BRNCHT(1)/GM
C     ENCODE (10,74,IDFG) BRNCHT(1)
      WRITE (IDFG,74) BRNCHT(1)
   74 FORMAT (1PE10.3)
C     DECODE (10,75,IDFG) A1,A2
      READ (IDFG,75) A1,A2
   75 FORMAT (A6,1X,A3)
C     ENCODE (9,76,A3) A1,A2
      WRITE (BR1,76) A1,A2
   76 FORMAT (A6,A3)
      NC=NCSERP(IMAX)
      LL=NPAV(NC)
      EKEV=VPAR(LL,L2)*UENRGY/8065479.D0
      DEKEV=0.D0
      IF (EIONRY.NE.0.D0) DEKEV=EIONRY*0.0136058D0+EK-EKEV
      EKEV=EKEV+DEKEV
      IF (BRNCHT(NP1).GE.1.D0) WRITE (33,77) (ELEM(L,1,1),L=1,2),
     1  EKEV,GM,(ELEM(L,1,2),L=2,3),EK,BR1,(BRNCHT(L),L=2,NP1)
   77 FORMAT (2A6,F8.4,F4.1,1X,A6,A3,F7.3,A9,5F6.3)
      IF (BRNCHT(NP1).LT.1.D0) WRITE (33,78) (ELEM(L,1,1),L=1,2),
     1  EKEV,GM,(ELEM(L,1,2),L=2,3),EK,BR1,(BRNCHT(L),L=2,NP1)
   78 FORMAT (2A6,F8.4,F4.1,1X,A6,A3,F7.3,A9,5F6.4)
C          SUM BRNCH OVER UPPER LEVELS
C               (FOR VARIOUS T, AND FOR EACH LOWER LEVEL)
      DO 645 I=1,IMAX
  645 V(I,23)=T(I)
      CALL SORT2(IMAX,12,V(1,23),D,ISER,T,NCSER,NCSERP,TP,FJT,FJTP,
     1  S2,SOABSS,GAA,GAAP,BRNCH)
      IF (IMAX.LE.1) GO TO 646
      CALL ORDERCH(IMAX,D,LLDES)
      CALL ORDERCH(IMAX,D,LLDESP)
  646 WRITE (IW,66) (TKEV(L),L=2,6)
   66 FORMAT (/8X,11HLOWER LEVEL, 13H  T(KEV)=INF.,5F17.2)
      DO 650 L=1,6
  650 BRNCHL(L)=1.0D-20
      DO 665 I=1,IMAX
      FNU(I)=DABS(T(I)-TP(I))
      NC=NCSERP(I)
      LL=NPAV(NC)
      ERAS1=VPAR(LL,L2)-TP(I)
      IF (T(I).GE.TP(I)) GO TO 656
      DO 654 L=1,NP1
  654 BRNCHL(L)=BRNCHL(L)+BRNCH(I)*DEXP(ERAS1/TUNRGY(L))
  656 IF (I.EQ.IMAX) GO TO 658
      IF (T(I+1).EQ.T(I)) GO TO 665
  658 WRITE (IW,67) NCSER(I),T(I),FJT(I), (BRNCHL(L), L=1,NP1)
   67 FORMAT (I5,F13.4,F5.1,1PE12.4,5E17.4)
      DO 660 L=2,NP1
  660 BRNCHL(L)=BRNCHL(L)/BRNCHL(1)
      BRNCHL(1)=BRNCHL(1)/GM
C     ENCODE (10,74,IDFG) BRNCHL(1)
      WRITE (IDFG,74) BRNCHL(1)
C     DECODE (10,75,IDFG) A1,A2
      READ (IDFG,75) A1,A2
C     ENCODE (9,76,A3) A1,A2
      WRITE (BR1,76) A1,A2
      EKEV=T(I)*UENRGY/8065479.D0+DEKEV
      NC=NCSER(I)
      IF (BRNCHL(NP1).GE.1.D0) WRITE (33,77) (ELEM(L,NC,1),L=1,2),
     1  EKEV,FJT(I),(ELEM(L,1,2),L=2,3),EK,BR1,(BRNCHL(L),L=2,NP1)
      IF (BRNCHL(NP1).LT.1.D0) WRITE (33,78) (ELEM(L,NC,1),L=1,2),
     1  EKEV,FJT(I),(ELEM(L,1,2),L=2,3),EK,BR1,(BRNCHL(L),L=2,NP1)
      DO 663 L=1,6
  663 BRNCHL(L)=1.0D-20
  665 CONTINUE
      ERAS=-1.D0
      WRITE (33,77) H1,H1,ERAS
C          WRITE BRANCHING FACTORS FOR AUTOIONIZATION
C               CONTRIBUTIONS TO COLLISIONAL EXCITATION
  670 IF (IXC.EQ.0) GO TO 699
      WRITE (IW,81) (JEXC(J),EXC(J), J=1,IXC)
   81 FORMAT (//25X,3HEXC,6X,6HBRNCHX//(32X,10(I3,F7.2)))
      WRITE (IW,82)
      DO 672 I=1,IXC
      J=JEXC(I)
  672 WRITE (IW,82) J, (ELEM(M,J,2),M=1,2), EXC(I),(BRNCHX(I,L),L=1,IXC)
   82 FORMAT (I3,2X,2A6,F12.4,3X,1P10E10.2/(32X,1P10E10.2))
      IF (IXC.LE.1) GO TO 699
      IXC2=0
      IF (NSCONF(2,2).LE.2) GO TO 690
C          SUM OVER L OF CONTINUUM ELECTRON
      DO 673 J=1,IXC
      N=JEXC(J)
  673 ELEMJ(J)=ELEM(2,N,2)
      NETOT=0
      DO 675 N=1,NOSUBC
  675 NETOT=NETOT+NIJK(N,1,2)
      NC=JEXC(IXC)-JEXC(1)
      IF (NC.LE.0) GO TO 690
      IXC1=IXC
      MIXC=JEXC(IXC)
      I=0
  676 I=I+1
      IF (I.GE.IXC1) GO TO 684
      MI=JEXC1(I)
      IF (MI.EQ.MIXC) GO TO 684
      J=I
  678 J=J+1
      IF (J.GT.IXC1) GO TO 676
      MJ=JEXC1(J)
      IF (MJ.EQ.MI) GO TO 678
      IF (DABS(EXC1(J)-EXC1(I)).GT.0.01D0) GO TO 678
      NE=0
      DO 679 N=1,NOSUBC
        NE=NE+MAX0(NIJK(N,MI,2),NIJK(N,MJ,2))
        IF (NE.GE.NETOT) GO TO 681
        IF (NIJK(N,MI,2).NE.NIJK(N,MJ,2)) GO TO 678
  679 CONTINUE
  681 DO 682 N1=1,IXC
  682 BRNCHX(N1,I)=BRNCHX(N1,I)+BRNCHX(N1,J)
      IXC1=IXC1-1
      DO 683 N=J,IXC1
      JEXC1(N)=JEXC1(N+1)
      EXC1(N)=EXC1(N+1)
      ELEMJ(N)=ELEMJ(N+1)
      DO 683 N1=1,IXC
  683 BRNCHX(N1,N)=BRNCHX(N1,N+1)
      J=J-1
      GO TO 678
  684 IF (IXC1.EQ.IXC) GO TO 690
  685 WRITE (IW,81) (JEXC1(J),EXC1(J), J=1,IXC1)
  686 WRITE (IW,82)
      DO 687 I=1,IXC
      J=JEXC(I)
  687 WRITE (IW,82) J,(ELEM(M,J,2),M=1,2), EXC(I),(BRNCHX(I,L),L=1,IXC1)
      IF (IXC2.GT.0) GO TO 699
C          SUM OVER LEVELS WITHIN THE CORE
  690 I=0
      IXC2=IXC1
  691 I=I+1
      IF (I.EQ.IXC2) GO TO 695
      MI=JEXC1(I)
      J=I+1
  692 MJ=JEXC1(J)
      IF (MJ.NE.MI) GO TO 691
      DO 693 N=1,IXC
  693 BRNCHX(N,I)=BRNCHX(N,I)+BRNCHX(N,J)
      IXC2=IXC2-1
      IF (I.EQ.IXC2) GO TO 695
      DO 694 J1=J,IXC2
      JEXC1(J1)=JEXC1(J1+1)
      EXC1(J1)=EXC1(J1+1)
      DO 694 N=1,IXC
  694 BRNCHX(N,J1)=BRNCHX(N,J1+1)
      GO TO 692
  695 IF (IXC2.EQ.IXC1) GO TO 699
      DO 697 J=1,IXC2
      N=JEXC1(J)
  697 ELEMJ(J)=ELEM(2,N,2)
      WRITE (IW,87) (JEXC1(J),ELEMJ(J), J=1,IXC2)
   87 FORMAT(//25X,3HEXC,6X,6HBRNCHX//(32X,10(I3,2X,A5)))
      IXC1=IXC2
      GO TO 686
  699 CALL CLOCK(TIME)
      DELT=TIME-TIME0
      IF (IW6.LT.0) WRITE (*,2069) DELT
 2069 FORMAT (' FINISHED SECOND-PARITY SORT AT TIME=',F9.3,' MIN')
C
C          SORT LINES BY WAVENUMBER
C
  700 IPT=0
      IF (ISPECC.GE.4) IPT=2
      IF (ISPECC.EQ.9) IPT=1
      IF (IPT.EQ.0) GO TO 980
      CALL SORT2(IMAX,12,FNU,D,ISER,T,NCSER,NCSERP,TP,FJT,FJTP,
     1  S2,SOABSS,GAA,GAAP,BRNCH)
      IF (IMAX.GT.1) CALL ORDERCH(IMAX,D,LLDES)
      IF (IMAX.GT.1) CALL ORDERCH(IMAX,D,LLDESP)
      FNUNP=DMIN1(FNUNP,FNU(1))
      FNUXP=DMAX1(FNUXP,FNU(IMAX))
      IF (ISPECC.GE.8) WRITE (20) IMAX,PSQ, (FNU(I),S2(I),
     1  BRNCH(I), I=1,IMAX)
C
  708 J=0
      JNXX=JNX
      DO 720 I=1,IMAX
      ERAS1=FNU(I)*UENRGY
      FLAM(I)=1.0D8/ERAS1
      GF=PSQ*S2(I)*ERAS1
      IF (IGEN.LT.5.AND.II.EQ.2) GF=GF/(FLAM(I)**2)
      ALGGF=-99.999D0
      IF (GF.GT.0.D0) ALGGF=DLOG10(GF)
      GA=0.66698D0*GF*ERAS1*ERAS1
      IF (TEXCIT.GT.0.D0)
     1  ALGGF=GA*DEXP(-(DMAX1(T(I),TP(I))-EMEAN)/TEXCIT)
      IF (ILUND.GT.0.AND.I.GT.1) GO TO 710
      IF (GA.LT.DMINGA) GO TO 710
      IF (J.GT.0) GO TO 710
      IF (IPT.NE.1) THEN
        WRITE (IW,55) SPID(II+1),UENRGY,UENREV,
     1    (JN, (ELEM(L,JN,L1),L=1,3), (ELEM(L,JN,L2),L=1,3), JN=1,JNXX)
        IF (TEXCIT.EQ.0.D0) WRITE (IW,IFMT1)
        IF (TEXCIT.GT.0.D0) WRITE (IW,IFMT1) TEXCIT
      ENDIF
  709 J=JLINES-JNXX
      JNXX=MIN0(5,JNX)
  710 J=J-1
      IF (IPT.LT.2) GO TO 720
      IF (GA.LT.DMINGA) GO TO 720
      IF (IBRNCH.EQ.0) GO TO 715
      WRITE (IW,88) I,T(I),FJT(I),NCSER(I),LLDES(I),TP(I),FJTP(I),
     1  NCSERP(I),LLDESP(I),FNU(I),FLAM(I),S2(I),GF,ALGGF,GA,BRNCH(I)
   88 FORMAT (1H ,I4,F11.4,F5.1,I3,2H (,A8,F13.4,F5.1,I3,2H (,A7,F13.4,
     1  F12.4,F8.3,F9.4,F8.3,1PE10.3,E9.2)
      GO TO 720
  715 WRITE (IW,IFMT2) I,T(I),FJT(I),NCSER(I),LLDES(I),TP(I),FJTP(I),
     1  NCSERP(I),LLDESP(I),FNU(I),FLAM(I),S2(I),GF,ALGGF,GA,SOABSS(I)
  720 CONTINUE
C
C
      CALL CLOCK(TIME)
      DELT=TIME-TIME0
      IF (IPTG.EQ.1) WRITE (IW,95) DELT
   95 FORMAT (//' FINISHED WAVELENGTH SORT AT TIME=',F9.3,4H MIN//)
      IF (IW6.LT.0) WRITE (*,2095) DELT
 2095 FORMAT (' FINISHED WAVELENGTH SORT AT TIME=',F9.3,4H MIN//)
  980 IF (SCRJ8.LT.0.D0) GO TO 985
      I=0
      IF (IMAX.NE.ITRUNC) GO TO 180
C     IREAD=IREAD-1
      BACKSPACE IC
C **************************************************** A.KRAMIDA
      IREAD=IREAD-2
      BACKSPACE IC
      ICPTR=ICPTR-2
C ****************************************************        
      GO TO 200
C
C 985 READ (IC) SOPI2
C **************************************************** A.KRAMIDA
  985 IMSQ=KC*KC
      CALL UNPK1(IC,KC,KC,SOPI2,KC,KC,BUFC,IMSQ,MAXBC)
      ICPTR=ICPTR+1
C ****************************************************        
      IREAD=IREAD+1
      SSOPX2=0.D0
      DO 986 I=1,JNX1
      DO 986 J=1,JNX2
  986 SSOPX2=SSOPX2+SOPI2(I,J)*(PMUP(I,J)**2)
      SSOPX2=SSOPX2*(A**2)
      IF (ISPECC.LT.8) GO TO 988
      IF (IMAX.EQ.0) GO TO 988
      IRAS=5
      ERAS=-1.D0
      WRITE (20) IRAS,ERAS, (ERAS,ERAS,ERAS, I=1,IRAS)
      CALL WNDIST(II)
  988 CONTINUE
C
      IF (IPTG.EQ.0) GO TO 991
      CALL CLOCK(TIME)
      DELT=TIME-TIME0
      IF (IMINGA.EQ.0) THEN
        WRITE (IW,96) DELT,TIME,PMAX,SSOPX2,SUMS2N,SUMS2,SUMS2M,SUMGF,
     1   SUMF,SUMGAR,DMIN,I0,D0MAX,I0N,FLBDX,I0X,FLBDN,ILOSTT,ICDLT,NCK
   96   FORMAT (//6H TIME=,F9.2,4H MIN,1X,10H(ABS TIME=,F9.2,1H),1X,
     1   9HFOR PMAX=,F8.5,1H,,F10.4,F10.4/37X,12HSUMS2,SUMGF=,F10.4,
     2   F10.4,F9.4/44X,5HSUMF=,F30.4,9X,7HSUMGAR=,1PE11.4/37X,6HS2MIN=,
     3   0PF27.5// 5X,I9,28H LINES OMITTED, WITH MAX S2=,F28.5// 5X,I9,
     4   31H LINES OMITTED, WITH LAMBDA  > ,F14.4/ 5X,I9,8H ANGSTR.,
     5   31H LINES OMITTED, WITH LAMBDA  < ,F14.4/ 5X,I9,8H ANGSTR.,
     6   31H LINES OMITTED, INSUFF STORAGE / 5X,I9,
     7   33H LINES OMITTED, CONF SERIAL NOS >,I5,1H,,I5)
        IF (IW6.LT.0) WRITE (*,96) DELT,TIME,PMAX,SSOPX2,SUMS2N,SUMS2,
     1    SUMS2M,SUMGF,SUMF,SUMGAR,DMIN,I0,D0MAX,I0N,FLBDX,I0X,FLBDN,
     2    ILOSTT,ICDLT,NCK
      ELSE            ! A.KRAMIDA
        WRITE (IW,961) DELT,TIME,PMAX,SSOPX2,SUMS2N,SUMS2,SUMS2M,SUMGF,
     1   SUMF,SUMGAR,DMINGA,I0,D0MAX1,I0N,FLBDX,I0X,FLBDN,ILOSTT,ICDLT,
     2   NCK
  961   FORMAT (//6H TIME=,F9.2,4H MIN,1X,10H(ABS TIME=,F9.2,1H),1X,
     1   9HFOR PMAX=,F8.5,1H,,F10.4,F10.5/37X,12HSUMS2,SUMGF=,F10.4,
     2   F11.5,F9.4/44X,5HSUMF=,F30.4,9X,7HSUMGAR=,1PE11.4/37X,6HGAMIN=,
     3   0PE27.3// 5X,I9,28H LINES OMITTED, WITH MAX GA=,0PE28.5// 5X,
     4   I9,
     5   31H LINES OMITTED, WITH LAMBDA  > ,F14.4,8H ANGSTR./ 5X,I9,
     6   31H LINES OMITTED, WITH LAMBDA  < ,F14.4,8H ANGSTR./ 5X,I9,
     7   31H LINES OMITTED, INSUFF STORAGE / 5X,I9,
     8   33H LINES OMITTED, CONF SERIAL NOS >,I5,1H,,I5)
        IF (IW6.LT.0) WRITE (*,961) DELT,TIME,PMAX,SSOPX2,SUMS2N,SUMS2,
     1    SUMS2M,SUMGF,SUMF,SUMGAR,DMINGA,I0,D0MAX1,I0N,FLBDX,I0X,FLBDN,
     2    ILOSTT,ICDLT,NCK
      ENDIF
      WRITE (IW,97) (COUPL(I), I=1,7)
   97 FORMAT (///13H AVE PURITIES,29X,9(A6,2X)/)
      DO 990 K1=L1,L2
      J1X=NSCONF(2,K1)
      IF (J1X.LT.2) J1X=2
      J1=J1X-1
      WRITE(IW,98) ((ELEM(I,JN,K1), I=1,3), JN=1,J1X,J1),
     1  (AVP(I,K1), I=1,7), AVCG(K1),AVEIG(K1)
   98 FORMAT (1X,3A6,3H---,3A6,7F8.3,5X,6H  EAV=,F10.4/101X,6HAVEIG=,
     1  F10.4)
  990 CONTINUE
C
  991 IF (II.EQ.0) RETURN
      IF (IGEN.LT.5) GO TO 100
      IF (IGEN.GT.7.OR.MOD(IBK-1,5).NE.0) GO TO 100
c     IMAX=MIN0(IMAX,30)
  992 WRITE (IW,99) IBK,BIGKS(IBK),IPWR,IMAX, (GOSS(I,IBK), I=1,IMAX)
   99 FORMAT (/46H0WEIGHTED GENERALIZED OSC. STRENGTHS AT BIGKS(,I3,
     1  2H)=,F12.7,8H   IPWR=,I1,12H   FOR FIRST,I3,6H LINES//(10F12.8))
      GO TO 100
C
  999 RETURN
      END
      SUBROUTINE WNDIST(II)
C
C          PLOT WAVENUMBER DISTRIBUTION ON MICROFILM
C               (SPECIAL VERSION FOR GAUSSIAN SMEAR)
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      PARAMETER (KCC=KISER/4,KLC4=2*KISER+1,KLAM=10000)
      PARAMETER (KW=104,KP=2*KW+2)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C3B/T(KLAM),TP(KLAM),S2(KLAM),SOABSS(KLAM),
     1  AA(KMX),AAP(KMX),GAA(KLAM),GAAP(KLAM),BRNCH(KLAM),
     2  ICUT(66),SGFCUT(66),SFCUT(66),DIDGF(66),DSGFDGF(66),TITLE(20),
     3  FICUT(66),FNUCUT(66),FNUPLT(82),DUM(66),FIPLT(82),SGFPLT(82),
     4  NCSER(KLAM),AADUM(KMX),AAPT(KMX)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      COMMON/C6/EMIN,EMAX,SUMWT,FLBDN,FLBDX,FNUNP,FNUXP,NLEV,IEWR
      COMMON/CC/   D(KMX,KMX)
      COMMON/C3LC2/V(KMX,KMX)
      COMMON/C3LC3/CT4(KMX,KMX)
      COMMON/C3LC4/CTA(KMX,KMX)
      COMMON/EE/ELEM(3,KC,2),VPAR(KPR,2),AVP(9,2),AVEIG(2),AVCG(2),
     1  NPARK(2),NPAV(KC),FJT(KLAM),FJTP(KLAM)
C
      DIMENSION X(KLAM),FNU(KLAM),FLAM(KLAM), FNUT(KLAM)
      EQUIVALENCE (CTA,X,FNU),(CT4,FLAM), (D,FNUT)
      DIMENSION FNUS(100),GAMMA(7)
      EQUIVALENCE (T,FNUS)
      DIMENSION EPLT(KLAM),SGF(KLAM)
      EQUIVALENCE (TP,EPLT),(SOABSS,SGF)
      COMMON/C7/G1,SUMGAA,SUMGAR,SUMGAAT
      CHARACTER*8 FIDLS,FIDJJ,LDES,LDESP,PARNAM,AA,COUPL,IEL
      CHARACTER*4 LSYMB
      COMMON/CHAR/PARNAM(KPR,2),FIDLS(KMX,2),FIDJJ(KMX,2),LDES(KMX),
     1  LDESP(KMX)
      DATA IGF,IDI/2HGF,2HDI/
C
C          DELE IN KEV,  FNUN AND FNUNP IN CM-1
C
      DELE=DELEKEV
      IF (DELE.LE.0.D0) DELE=0.0005D0
  100 DEL=0.0005D0*(1.002D0*FNUXP-FNUNP)
      FNUN=FNUNP-DEL
      FNUX=FNUXP+DEL
  105 DELNU=8065479.D0*DELE/UENRGY
      IERAS=(FNUX-FNUN)/DELNU
      NP2=IERAS+3
      IF (NP2.LE.KLAM/2) GO TO 110
      IF (IERAS.GT.KLAM-5) WRITE (2,10) ((ELEM(I,1,J),I=1,3),J=1,2),
     1  FNUXP,FNUNP,DELE
   10 FORMAT (///5H*****,3A6,3H - ,3A6,2F15.1,6H DELE=,F7.5,
     1  10H TOO SMALL///)
      DELE=2.D0*DELE
      GO TO 105
  110 IMIN=FNUNP/DELNU
      FIMIN=IMIN
      EPLT(1)=FIMIN*DELE
      DO 150 J=1,NP2
      EPLT(J+1)=EPLT(J)+DELE
  150 SGF(J)=0.D0
C
      REWIND 20
      ITOT=0
      GFTOT=0.D0
      SBR=0.D0
  200 READ (20) IMAX,PSQ, (FNU(I),S2(I), BRNCH(I), I=1,IMAX)
      IF (PSQ.LT.0.D0) GO TO 300
      DO 205 I=1,IMAX
  205 SBR=SBR+BRNCH(I)
      DO 230 I=1,IMAX
      ERAS1=FNU(I)*UENRGY
      GF=PSQ*S2(I)*ERAS1
      IF (II.EQ.2.AND.IGEN.LT.5) GF=GF*((1.D-8*ERAS1)**2)
      IF (SBR.GT.0.D0) GF=BRNCH(I)
      J=FNU(I)/DELNU+1.5D0
      J=J-IMIN
      IF (J.LT.1.OR.J.GT.NP2) WRITE (2,20) NP2,J, FNU(I),DELNU
   20 FORMAT (10X,2I10,2F15.1)
      SGF(J)=SGF(J)+GF
      ITOT=ITOT+1
  230 GFTOT=GFTOT+GF
      GO TO 200
C
  300 FITOT=ITOT
  305 DO 310 J=1,NP2
      SGF(J)=SGF(J)/(GFTOT+1.D-10)
  310 CONTINUE
      III=1
      GAMMA(1)=0.D0
      IMX=NP2
      ID=IGF
      IF (SBR.GT.0.D0) ID=IDI
C     ENCODE (8,91,IEL) ELEM(1,1,1),ID
      WRITE (IEL,91) ELEM(1,1,1),ID
   91 FORMAT (A6,A2)
      BRFAC=0.D0
      IF (SBR.GT.0.D0) BRFAC=GFTOT/SUMGAA
      WRITE (IW,92) (ELEM(J,1,1),J=1,3), ID,GAMMA(III),G1,GFTOT,
     1  EPLT(1),DELE,IMX,BRFAC
   92 FORMAT (//1H0,3A6,2X,A2,2F5.0,10X,1PE10.3,0P2F10.6,I10,10X,
     1  6HBRFAC=,F10.6)
      WRITE (11,94) (ELEM(J,1,1),J=1,3), ID,GAMMA(III),G1,GFTOT,
     1  EPLT(1),DELE,IMX
   94 FORMAT (3A6,A2,2F5.0,10X,1PE10.3,0P2F10.6,I10)
      JX=0
      I=0
  865 JN=JX+1
      JX=MIN0(JN+6,IMX)
      I=I+1
  866 WRITE (IW,93) IEL,I, (SGF(J), J=JN,JX)
   93 FORMAT (1X,A8,I4,7F10.7)
      WRITE (11,95) IEL,I, (SGF(J), J=JN,JX)
   95 FORMAT (A8,I2,7F10.7)
      IF (JX.LT.IMX) GO TO 865
  868 CONTINUE
C
C
      IF (SBR.EQ.0.D0) GO TO 900
      NOSUBC=NSCONF(1,2)
      GJ=1.D0
      DO 880 I=1,NOSUBC
      W=NIJK(I,1,2)
      FLL=FLLIJK(I,1,2)
      WF=4.D0*FLL+2.D0
  880 GJ=GJ*FCTRL(WF)/(FCTRL(W)*FCTRL(WF-W))
      AAT=SUMGAA/GJ
      ART=SUMGAR/GJ
      PAPP=AAT*ART/(AAT+ART)
      PDET=GFTOT/GJ
      BAPP=AAT/(AAT+ART)
      BDET=GFTOT/(SUMGAR+1.D-10)
      RR=BDET/BAPP
      AATEFF=ART/(1.D0/BDET-1.D0)
      WRITE (IW,88) ((ELEM(I,1,J),I=1,3), J=1,2), GJ,AAT,ART,PAPP,PDET,
     1  BAPP,BDET,RR,AATEFF
C     WRITE (3,88) ((ELEM(I,1,J),I=1,3), J=1,2), GJ,AAT,ART,PAPP,PDET,
C    1  BAPP,BDET,RR,AATEFF
   88 FORMAT (1H0,44X,2HGJ,5X,3HAAT,8X,3HART,5X,9HAA*AR/SUM,4X,
     1  6HP(DET),4X,6HB(APP),4X,6HB(DET),4X,7HDET/APP,3X,8HAAT(EFF)/
     2  1X,3A6,3H---,2X,3A6,F5.0,1P4E11.3,0P3F10.7,1PE11.3)
      IF (SUMGAA.GE.SUMGAAT) GO TO 883
      AATT=SUMGAAT/GJ
      PAPP=AAT*ART/(AATT+ART)
      BAPP=PAPP/ART
      RR=BDET/BAPP
      WRITE (IW,88) ((ELEM(I,1,J),I=1,3), J=1,2), GJ,AATT,ART,PAPP,PDET,
     1  BAPP,BDET,RR,AATEFF
C     WRITE (3,88) ((ELEM(I,1,J),I=1,3), J=1,2), GJ,AATT,ART,PAPP,PDET,
C    1  BAPP,BDET,RR,AATEFF
  883 JX=MAX0(NSCONF(2,1),NSCONF(2,2))
      IF (JX.LT.2) GO TO 900
      DO 885 JJ=2,JX
      WRITE (IW,89) ((ELEM(I,JJ,J),I=1,3), J=1,2)
C     WRITE (3,89) ((ELEM(I,JJ,J),I=1,3), J=1,2)
   89 FORMAT (1X,3A6,3H---,2X,3A6)
  885 CONTINUE
  900 RETURN
      END
C     OVERLAY(G9,10,5)
      SUBROUTINE BORN
C
C     A ROUTINE TO INTEGRATE GENERALISED OSCILLATOR STRENGTHS
C              TO GIVE PLANE-WAVE BORN COLLISION STRENGTHS
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KPR=2100,KMX=260,KLAM=10000)
      PARAMETER (KBGKS=41,KENRGS=21,KCASE=50,KTRAN=600)
      COMMON/CC/   D(KMX,KMX)
      COMMON/EE/ELEM(3,KC,2),VPAR(KPR,2),AVP(9,2),AVEIG(2),AVCG(2),
     1  NPARK(2),NPAV(KC),FJT(KLAM),FJTP(KLAM),NCSERP(KLAM)
      COMMON/C3LC5/GOSS(KTRAN,KBGKS)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,INTDUM,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C3B/T(KLAM),TP(KLAM),S2(KLAM),SOABSS(KLAM),
     1  AA(KMX),AAP(KMX),GAA(KLAM),GAAP(KLAM),BRNCH(KLAM),
     2  ICUT(66),SGFCUT(66),SFCUT(66),DIDGF(66),DSGFDGF(66),TITLE(20),
     3  FICUT(66),FNUCUT(66),FNUPLT(82),SGF(66),FIPLT(82),SGFPLT(82),
     4  NCSER(KLAM),AAT(KMX),AAPT(KMX)
      COMMON/AKN/XBAR,N,M,YBAR
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      COMMON/C9/L1,L2,CFLAG(KC,2),CGENGY(KC,2),SWT(KC,2),IMAX
      COMMON/PWBORN/NBIGKS,NENRGS,EKMINL,EKMAXL,DELEKL,BIGKS(KBGKS),
     1  XMIN,XMAX,TEV(25),CORR(KENRGS),IBK,IPWR,I1
      DIMENSION FST(KBGKS),EN(KENRGS),NCS(KCASE,2)
      DIMENSION XS(KENRGS),CS(KENRGS,KCASE),CSM(KENRGS,KCASE),
     1  GFST(KCASE),CSM2(KENRGS),DECSWT(KCASE),CSWT(KCASE),C1(KENRGS),
     2  C2(KENRGS),FK(51),YK(51),FMXEL(51),SUMI(51),RATEM2(KENRGS)
      EQUIVALENCE (CS,GAA),(CSM,GAAP),(FST,AA),
     1  (DECSWT,AAP)
      CHARACTER*8 T1,T2,T3,T4,T5
      DATA T1,T2,T3,T4,T5/6H COWAN,6H MPWB ,6H TOTAL,6H MOD2 ,6H  PWB /
C
C      SET PUNCH QUANTITIES
C
C     KCASE=50
      M1=-NENRGS
      M2=30
      M3=0
      M4=1
      M5=-M1
      AN=DFLOAT(NENRGS-1)
      M=3
      NPTS=NBIGKS-1
      NK=NENRGS+1
      NK2=NK/2
      MM=1
C
C         INITIALIZE ARRAYS
C
      ICS=1
      NCS(ICS,1)=NCSER(1)
      NCS(ICS,2)=NCSERP(1)
      DO 110 K=1,KCASE
      GFST(K)=0.D0
      DECSWT(K)=0.D0
      CSWT(K)=0.D0
      DO 110 I=1,NENRGS
      CSM(I,K)=0.D0
  110 CS(I,K)=0.D0
      ENMAX=DEXP(2.D0*EKMAXL)
      DO 120 I=1,NBIGKS
  120 FST(I)=DEXP(BIGKS(I))
      WRITE (IW,12) NBIGKS,ENMAX, (FST(I),I=1,NBIGKS)
   12 FORMAT (1H1//20H K-VALUES,   NBIGKS=,I3,8H  ENMAX=,F14.7//
     1  (10F12.7))
C
C      LOOP OVER THE TRANSITIONS
C
      IPWR=MOD(IPWR,2)
      TEN=10.D0
      SWT0=0.D0
      TR0=-9999999.D0
      FJTR0=-1.D0
      DO 490 IT=1,IMAX
      TR=T(IT)
      TPR=TP(IT)
      FJTR=FJT(IT)
      FJTPR=FJTP(IT)
      IF (TR.NE.TR0.OR.FJTR.NE.FJTR0) SWT0=SWT0+2.D0*FJTR+1.D0
      TR0=TR
      FJTR0=FJTR
      DO 200 I=1,IBK
  200 FST(I)=GOSS(IT,I)
      FNU=DABS(TPR-TR)
      ERAS1=FNU*UENRGY
      DELTAE=ERAS1/109737.31D0
      C=3.D0/DELTAE
      IF (IPWR.EQ.0) C=15.D0*C
      FLAM=1.0D8/ERAS1
      NC1=NCSER(IT)
      NC2=NCSERP(IT)
      ICT=0
      DO 220 ID=1,ICS
      NI1=NCS(ID,1)
      NI2=NCS(ID,2)
      IF (NC1.EQ.NI1.AND.NC2.EQ.NI2) ICT=ID
  220 CONTINUE
      IF (ICT.GT.0) GO TO 230
      ICS=ICS+1
      NCS(ICS,1)=NC1
      NCS(ICS,2)=NC2
      ICT=ICS
  230 CONTINUE
C
C     INTEGRATE THE GOS OVER A LOGARITHMIC MESH FOR
C              VARIOUS INCIDENT ELECTRON ENERGIES
C
      GF=GOSS(IT,1)
      GFST(ICT)=GFST(ICT)+GF
      E1=XMIN*DELTAE
      E2=XMAX*DELTAE
      E1L=DLOG(E1)
      E2L=DLOG(E2)
      EI=(E2L-E1L)/AN
      DO 300 K=1,NENRGS
      EL=E1L+(K-1)*EI
  300 EN(K)=DEXP(EL)
      WRITE (IW,30)
   30 FORMAT (/1H0,14X,7H   E   , 4X,2HJ ,10X,8H   EP   , 3X,3H JP,12X,
     1  8H DELTA E,3X,9HLAMBDA(A),2X,9HS/PMAX**2,4X,2HGF,5X,6HLOG GF,3X,
     2  9HGA(SEC-1)/)
      ALGGF=-99.999D0
      IF (GF.GT.0.D0) ALGGF=DLOG10(GF)
      GA=0.66698D0*GF*ERAS1*ERAS1
      WRITE (IW,32) IT,NC1,NC2,TR,FJTR,TPR,FJTPR,FNU,FLAM,
     1  S2(IT),GF,ALGGF,GA
   32 FORMAT (1H ,I4,2I2,F13.3, F6.1,F18.3, F6.1,F20.2,F11.3,F11.5,
     1  F9.4,F9.4,1PE12.3)
      IF (IGEN.LT.9) WRITE (IW,33) (GOSS(IT,K), K=1,NBIGKS)
   33 FORMAT (36H0WEIGHTED GENERALIZED OSC. STRENGTHS/(10F12.8))
      WRITE (IW,34)
   34 FORMAT (//16X,2H X,11X,5HE(RY),10X,5HOMEGA,7X,8HOMEGA*FX,
     1  7X,7HOMEGAM2,10X,5HT(EV),3X,15HRATEM2(CM3/SEC),2X,9HCORR(PCT)/)
      N=NBIGKS
      EK0=DELTAE*3.D0
      DO 480 KEN=1,NK
      KEN1=KEN-1
      IF (KEN.GT.1) EK0=EN(KEN1)
      EKN=EK0-DELTAE
      AK0=DSQRT(EK0)
      AKN=DSQRT(EKN)
      AKMAX=AK0+AKN
      AKMIN=AK0-AKN
      AKMAXL=DLOG(AKMAX)
      AKMINL=DLOG(AKMIN)
      AKINTL=(AKMAXL-AKMINL)/DFLOAT(NPTS)
      XBAR=AKMINL-AKINTL
      AKXX=1.000001D0*AKMAXL
      AM=1.D0
      SUM=0.D0
      II=0
  350 XBAR=XBAR+AKINTL
      IF (XBAR.GT.AKXX) GO TO 390
      CALL AKNINT(BIGKS,FST)
      SUM=SUM+YBAR*AM
      IF (AM.GT.3.D0) GO TO 370
      AM=4.D0
      IF (KEN.NE.NK) GO TO 350
      II=II+1
      FK(II)=DEXP(XBAR)
      YK(II)=YBAR
      ERAS=C*YBAR
      IF (IPWR.EQ.0) ERAS=ERAS/(FK(II)**2)
      FMXEL(II)=0.D0
      IF (ERAS.GT.0.D0) FMXEL(II)=DSQRT(ERAS)
      IF (ERAS.LT.0.D0) FMXEL(II)=-DSQRT(-ERAS)
      SUMI(II)=SUM-YBAR
      GO TO 350
  370 AM=2.D0
      GO TO 350
  390 SUM=SUM-YBAR
      SUM=SUM*AKINTL/3.D0
C
C     EVALUATE STORE AND MODIFY THE PWB COLLISION STRENGTH
C
      COLLS=8.D0*SUM/DELTAE
      XE=EK0/DELTAE
      IF (KEN.EQ.1) COLLM=COLLS
      XE1=(1.D0-XE)*0.07702D0
      FX=1.D0-0.2D0*DEXP(XE1)
      COLLSM=COLLS*FX
      IF (XE.LT.3.D0) COLLSM=COLLM*FX
      IF (KEN.EQ.1) GO TO 480
      XS(KEN1)=XE
      C1(KEN1)=COLLS
      C2(KEN1)=COLLSM
      CS(KEN1,ICT)=CS(KEN1,ICT)+COLLS
      CSM(KEN1,ICT)=CSM(KEN1,ICT)+COLLSM
  480 CONTINUE
      DECSWT(ICT)=DECSWT(ICT)+DELTAE*C1(NK2)
      CSWT(ICT)=CSWT(ICT)+C1(NK2)
      N=NENRGS
      DO 485 I=1,NENRGS
      CSM2(I)=0.D0
      IF ((C1(I)+C2(I)).EQ.0.D0) GO TO 485
      XBAR=XS(I)+3.D0/(1.D0+XS(I))
      CALL AKNINT(XS,C1)
      CSM2(I)=YBAR
  485 CONTINUE
      ERAS=2.D0*FJTR+1.D0
      CALL RCOEFF(XS,CSM2,RATEM2,DELTAE,ERAS,UENRGY)
      DO 486 I=1,NENRGS
      I2=I+I1
  486 WRITE (IW,48) XS(I),EN(I),C1(I),C2(I),CSM2(I),TEV(I2),RATEM2(I),
     1  CORR(I)
   48 FORMAT (8X,5F14.7,F15.1,1PE15.4,0PF11.1)
      IF (IGEN.GT.5) GO TO 490
      III=1
      IF (II.GT.ILA) III=2
      DO 488 I=1,II,III
  488 SUMI(I)=SUMI(I)/(SUMI(II)+1.0D-15)
      WRITE (IW,49) AKMIN,AKMAX,(FK(I),YK(I),FMXEL(I),SUMI(I),I=1,II)
   49 FORMAT (//2F12.6,16X,1HK,12X,2HGF,10X,6HMXELEM,9X,3HINT/
     1  (30X,4F14.8))
  490 CONTINUE
C
C     PUNCH THE TOTAL COLLISION STRENGTH
C
      N=NENRGS
      DO 890 JTN=1,ICS
      NC1=NCS(JTN,1)
      NC2=NCS(JTN,2)
      FPRT=0.D0
      IF (L1.NE.L2) FPRT=GFST(JTN)/SWT(NC1,1)
      DEAV=DABS(CGENGY(NC2,L2)-CGENGY(NC1,L1))
      DE1=DABS(CGENGY(NC2,L2)-T(1)*UENRGY/109737.31D0)
      DE2=0.D0
      IF (CSWT(JTN).GT.0.D0) DE2=DECSWT(JTN)/CSWT(JTN)
      DO 810 I=1,NENRGS
      XBAR=XS(I)+3.D0/(1.D0+XS(I))
      CALL AKNINT(XS,CS(1,JTN))
  810 CSM2(I)=YBAR
      DELTAE=DMAX1(DEAV,DE2)
      IF (DELTAE.EQ.0.D0) DELTAE=DE1
      CALL RCOEFF(XS,CSM2,RATEM2,DELTAE,SWT0,UENRGY)
      WRITE (IW,60)
   60 FORMAT (1H1,//20X,44H ****     TOTAL COLLISION STRENGTHS     ****
     1  ////)
      WRITE (IW,81) M1,M2,M3,M4,T1,T2,(ELEM(L,NC1,L1),L=1,3),
     1  CFLAG(NC1,L1),CFLAG(NC2,L2),(ELEM(L,NC2,L2),L=1,3),T3
   81 FORMAT (4I5,5A6,A1,4H -- ,A1,4A6)
      WRITE (IW,84) DEAV,FPRT,DE1,DE2,DELTAE
   84 FORMAT (/6H DEAV=,F15.8,12H RY,    FAV=,F14.10,3F15.8///
     1  13X,1HX,13X,2HCS,13X,3HCSM,6X,14HXEFF=X+3/(1+X),
     2  10X,5HT(EV),3X,15HRATEM2(CM3/SEC),2X,9HCORR(PCT)/)
      DO 850 I=1,NENRGS
      I2=I+I1
  850 WRITE (IW,86) XS(I),CS(I,JTN),CSM(I,JTN),CSM2(I),
     1  TEV(I2),RATEM2(I),CORR(I)
   86 FORMAT (3X,4F15.9,F17.1,1PE15.4,0PF11.1)
      WRITE (11,81) M5,M2,M3,M3,T1,T5,(ELEM(L,NC1,L1),L=1,3),
     1  CFLAG(NC1,L1),CFLAG(NC2,L2),(ELEM(L,NC2,L2),L=1,3),T3
      WRITE (11,88) (XS(I),I=1,NENRGS)
      WRITE (11,88) (CS(I,JTN),I=1,NENRGS)
   88 FORMAT (5E16.8)
      WRITE (11,81) M5,M2,M3,M3,T1,T2,(ELEM(L,NC1,L1),L=1,3),
     1  CFLAG(NC1,L1),CFLAG(NC2,L2),(ELEM(L,NC2,L2),L=1,3),T3
      WRITE (11,88) (XS(I),I=1,NENRGS)
      WRITE (11,88) (CSM(I,JTN),I=1,NENRGS)
      WRITE (11,81) M1,M2,M3,M4,T1,T4,(ELEM(L,NC1,L1),L=1,3),
     1  CFLAG(NC1,L1),CFLAG(NC2,L2),(ELEM(L,NC2,L2),L=1,3),T3
      WRITE (11,88) DEAV,FPRT,DE1,DE2
      WRITE (11,88) (XS(I),I=1,NENRGS)
      WRITE (11,88) (CSM2(I),I=1,NENRGS)
  890 CONTINUE
      CALL CLOCK(TIME)
      DELT=TIME-TIME0
      WRITE (IW,89) DELT
   89 FORMAT (//6H TIME=,F9.3,4H MIN//)
      RETURN
      END
C
      SUBROUTINE AKNINT(X,Y)
C                                                                       002
C AITKEN REPEATED INTERPOLATION                                         003
C                                                                       004
C   XBAR = ABSCISSA AT WHICH INTERPOLATION IS DESIRED                   005
C   IABS(IN) = NO. OF VALUES IN TABLE                                   006
C   IM   = DEGREE OF APPROXIMATING POLYNOMIAL                           009
C   X    = VECTOR OF IABS(IN) VALUES OF ABSCISSA                        010
C   Y    = VECTOR OF IABS(IN) VALUES OF ORDINATE                        011
C   T    = TEMPORARY STORAGE VECTOR OF 4*(M+1) LOCATIONS)               012
C                                                                       013
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KBGKS=41)
C
      DIMENSION X(KBGKS),Y(KBGKS),T(80)
      COMMON/AKN/XBAR,N,M,YB                                            015
C                                                                       018
      DO 10 J=1,N                                                       035
      IF (XBAR.LE.X(J)) GO TO 11                                        036
   10 CONTINUE
      J=N                                                               037
   11 K=M+1                                                             044
      J=J-K/2                                                           045
      J=MIN0(J,N-M)                                                     047
      J=MAX0(J,1)                                                       046
      MEND=J+M                                                          048
      DO 12 I=J,MEND                                                    049
      KK=I-J+1                                                          050
      T(KK) = Y(I)                                                      051
   12 T(KK+K)=X(I)-XBAR                                                 052
      DO 13 I=1,M                                                       053
      KK=I+1                                                            054
      DO 13 JJ=KK,K                                                     055
      T(JJ)=(T(I)*T(JJ+K) -T(JJ)*T(I+K))/(X(JJ+J-1) - X(I+J-1))         056
   13 CONTINUE                                                          057
      YB=T(K)
      RETURN                                                            059
      END                                                               068
C
      SUBROUTINE RCOEFF(X,Y,Z,DELTAE,SWT0,UENRGY)
C
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KPR=2100,KMX=260,KLAM=10000)
      PARAMETER (KBGKS=41,KENRGS=21,KCASE=50,KTRAN=600)
      COMMON/CC/   D(KMX,KMX)
      COMMON/EE/ELEM(3,KC,2),VPAR(KPR,2),AVP(9,2),AVEIG(2),AVCG(2),
     1  NPARK(2),NPAV(KC),FJT(KLAM),FJTP(KLAM),NCSERP(KLAM)
      COMMON/C3B/T(KLAM),TP(KLAM),S2(KLAM),SOABSS(KLAM),
     1  AA(KMX),AAP(KMX),GAA(KLAM),GAAP(KLAM),BRNCH(KLAM),
     2  ICUT(66),SGFCUT(66),SFCUT(66),DIDGF(66),DSGFDGF(66),TITLE(20),
     3  FICUT(66),FNUCUT(66),FNUPLT(82),SGF(66),FIPLT(82),SGFPLT(82),
     4  NCSER(KLAM),AAT(KMX),AAPT(KMX)
      COMMON/C5/IARG1,IARG2,IARG3,IGEN,IRNQ,IRXQ,IRND,IRXD,IRMN,IRMX,
     1  DELEKEV,DELEAV,SCALE,FACT0(5),EMINA,SCRLKP(14,2),
     2  SCRSKP(14,2),NCLSKP(2),NOLSKP
      COMMON/C9/L1,L2,CFLAG(KC,2),CGENGY(KC,2),SWT(KC,2),IMAX
      COMMON/PWBORN/NBIGKS,NENRGS,EKMINL,EKMAXL,DELEKL,BIGKS(KBGKS),
     1  XMIN,XMAX,TEV(25),CORR(KENRGS),IBK,IPWR,I1
      DIMENSION X(KENRGS),Y(KENRGS),Z(KENRGS)
C
      I1=0
      ERAS=(TP(IMAX)-T(1))*UENRGY/8065.479D0
      IF ((NCSER(1).EQ.NCSERP(IMAX).AND.IARG1.EQ.2).AND.ERAS.GT.25.D0)
     1  I1=4
      IF ((NCSER(1).NE.NCSERP(IMAX).OR.IARG1.EQ.1).AND.ERAS.GT.250.D0)
     1  I1=4
      D1=DLOG(X(2)/X(1))/3.D0
C
      DO 900 I=1,NENRGS
      I2=I+I1
      TRYD=TEV(I2)/13.605D0
      C1=DELTAE/TRYD
      C2=2.1717D-8/(SWT0*DSQRT(TRYD))
      C3=C1*C2
C          INTEGRATE TO XMAX VIA SIMPSONS RULE
      SUM=(X(1)-1.D0)*Y(1)*DEXP(-C1*X(1))/D1
      SUM0=C3*D1*SUM
      A1=1.D0
      J=0
  150 J=J+1
      IF (J.GT.NENRGS) GO TO 190
      ERAS=Y(J)*X(J)*DEXP(-C1*X(J))
      SUM=SUM+A1*ERAS
      IF (A1.EQ.4.D0) GO TO 160
      A1=4.D0
      GO TO 150
  160 A1=2.D0
      GO TO 150
  190 SUM=SUM-ERAS
      SUM=C3*SUM*D1
C          ADD INTEGRAL FROM XMAX TO INFINITY
      ALN1=DLOG(C1*X(NENRGS-2))
      X0=C1*X(NENRGS)
      ALN2=DLOG(X0)
      A=(Y(NENRGS)-Y(NENRGS-2))/(ALN2-ALN1)
      IF (A.LT.0.D0) A=0.D0
      B=Y(NENRGS)-A*ALN2
      ERAS=Y(NENRGS)*DEXP(-X0)+A*E1(X0)
      Z(I)=SUM+C2*ERAS
      SUM2=C2*ERAS
      CORR(I)=100.D0*(SUM0+SUM2)/(Z(I)+1.0D-50)
  900 CONTINUE
      RETURN
      END
C
      FUNCTION E1(X)
C
C COMPUTES THE EXPONENTIAL INTEGRAL E1(X).
C
C JULY 1977 EDITION.  W. FULLERTON, C3, LOS ALAMOS SCIENTIFIC LAB.
C     MODIFIED MARCH 1982 BY R.D. COWAN FOR X.GT.-1 ONLY
C          AND WITH ABBREVIATED SERIES FOR ONLY 5 FIGURE ACCURACY
C
C
C
C SERIES FOR E12        ON THE INTERVAL -1.LE.X.LE.+1
C
C SERIES FOR AE13       ON THE INTERVAL  +1.LE.X.LE.4
C
C SERIES FOR AE14       ON THE INTERVAL  4.LE.X.LE.100
C
C
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION E12CS(7),AE13CS(7),AE14CS(7)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
C
      DATA E12 CS( 1) /  -0.0373902147D0 /
      DATA E12 CS( 2) /   0.0427239860D0 /
      DATA E12 CS( 3) /   -.1303182079D0 /
      DATA E12 CS( 4) /    .0144191240D0 /
      DATA E12 CS( 5) /   -.0013461707D0 /
      DATA E12 CS( 6) /    .0001073102D0 /
      DATA E12 CS( 7) /   -.0000074299D0 /
      DATA AE13CS( 1) /   -.6057732466D0 /
      DATA AE13CS( 2) /   -.1125352434D0 /
      DATA AE13CS( 3) /    .0134322662D0 /
      DATA AE13CS( 4) /   -.0019268451D0 /
      DATA AE13CS( 5) /    .0003091183D0 /
      DATA AE13CS( 6) /   -.0000535641D0 /
      DATA AE13CS( 7) /    .0000098278D0 /
      DATA AE14CS( 1) /   -.1892918000D0 /
      DATA AE14CS( 2) /   -.0864811785D0 /
      DATA AE14CS( 3) /    .0072241015D0 /
      DATA AE14CS( 4) /   -.0008097559D0 /
      DATA AE14CS( 5) /    .0001099913D0 /
      DATA AE14CS( 6) /   -.0000171733D0 /
      DATA AE14CS( 7) /    .0000029856D0 /
      DATA XMAX /0.D0/
C
      IF (XMAX.NE.0.D0) GO TO 40
      NTE12=7
      NTAE13=7
      NTAE14=7
      XMAX=100.D0
C
 40   IF (X.GT.1.D0) GO TO 50
      IF (X.EQ.0.D0) WRITE (IW,1)
    1 FORMAT (24H *****ERROR IN E1, X=0.0)
C
C E1(X) = -EI(-X) FOR -1.D0 .LT. X .LE. 1.D0,  X .NE. 0.D0
C
      E1=(-DLOG(DABS(X))-0.6875D0+X)+CSEVL(X,E12CS,NTE12)
      RETURN
C
 50   IF (X.GT.4.D0) GO TO 60
C
C E1(X) = -EI(-X) FOR 1.D0 .LT. X .LE. 4.D0
C
      E1=DEXP(-X)/X*(1.D0+CSEVL((8.D0/X-5.D0)/3.D0,AE13CS,NTAE13))
      RETURN
C
 60   IF (X.GT.XMAX) GO TO 70
C
C E1(X) = -EI(-X) FOR 4. .LT. X .LE. XMAX
C
      E1 = DEXP(-X)/X * (1.D0 + CSEVL(8.D0/X-1.D0,AE14CS,NTAE14))
      RETURN
C
C E1(X) = -EI(-X) FOR X .GT. XMAX
C
   70 E1=0.D0
      RETURN
      END
C
      FUNCTION CSEVL (X,CS,N)
C APRIL 1977 VERSION. W.FULLERTON, C-3, LOS ALAMOS SCIENTIFIC LABORATORY
C
C EVALUATE THE N-TERM CHEBYSHEV SERIES CS AT X. ADAPTED FROM
C R BROUCKE, ALGORITHM 446, C.A.C.M., 16, 254 (1973). ALSO SEE FOX
C AND PARKER, CHEBYSHEV POLYS IN NUMERICAL ANALYSIS, OXFORD PRESS, P.56.
C
C       INPUT ARGUMENTS --
C X    VALUE AT WHICH THE SERIES IS TO BE EVALUATED.
C CS   ARRAY OF N TERMS OF A CHEBYSHEV SERIES. IN EVAL-
C      UATING CS, ONLY HALF THE FIRST COEF IS SUMMED.
C N    NUMBER OF TERMS IN ARRAY CS.
C
C
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION CS(1)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
C
      IF (N.LT.1.OR.N.GT.1000) WRITE (IW,1) N
    1 FORMAT (24H *****ERROR IN CSEVL, N=,I7)
      IF (X.LT.-1.D0.OR.X.GT.1.D0) WRITE (IW,2) X
    2 FORMAT (24H *****ERROR IN CSEVL, X=,F10.5)
C
       B1=0.D0
       B0=0.D0
       TWOX=2.D0*X
       DO 10 I=1,N
       B2=B1
       B1=B0
       NI=N+1-I
       B0=TWOX*B1-B2+CS(NI)
 10    CONTINUE
C
       CSEVL = 0.5D0 * (B0-B2)
C
       RETURN
      END
C
C     OVERLAY(G9,10,6)
      SUBROUTINE RCEINP
C
C        SET UP TAPE2E FOR BINARY INPUT TO RCE,
C             AND FILE OUTGINE FOR BCD INPUT TO RCE
C
C         IF NLSMAX.GT.0, NLS.LE.NLSMAX, KCPLD(I)=0, AND ALL OTHER
C              KCPLD=1, THEN COEF MATRICES WILL BE WRITTEN ON TAPE 2 IN
C              COUPLING I AND TRANSFORMATION MATRIX WILL BE TMX(I,LS).
C         OTHERWISE, IF KCPL=1, COEF MATRICES WILL BE IN LS, TMX(LS,JJ),
C              IF KCPL=2, COEF MATRICES WILL BE IN JJ, TMX(JJ,LS).
C
C
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (KS=8,KC=50,KLSI=47,KLS1=KLSI+1,KLS2=KLSI+51,KLSC=500,
     1  KJK=110,KJP=200,KMX=260,KLC1=KMX**2-(KLSI**2)*9,KISER=10000,
     2  KPR=2100,KJJT=50,KPC=2000,KLC2=KMX**2-(KLSI**2)*7-KPC,
     3  KLSU=17)
      PARAMETER (KCC=KISER/4,KLC4=2*KISER+1,KLC42=KMX**2,KMX2=KMX/2)
      COMMON/IDSKNO/IR,IW,ID2,ID3,ID4,ILA,ILB,IL,IC,IE
      COMMON/C1/KCPL,NOCSET,NSCONF(3,2),IABG,IV,NLSMAX,NLT11,NEVMAX,
     1  KCPLD(9),SJN,SJX,IMAG,IQUAD,UENRGY,DMIN,IELPUN,ILNCUV,IPLEV,
     2  ICPC,ICFC,IDIP,IENGYD,ISPECC,IPCT,ICTC,ICTBCD,KCPL1,COUPL(12),
     3  LSYMB(24),NOSUBC,KK,TIME0,TIME,DELT,NDIFFT,NOTOTT,
     4  SJ8MN,SJ8MX,IGDLEV,NSCRJ8,SCRJ8,SCRJ8P,NLS,NLSP,NJJ,
     5  NNN,NDIFSJ,KPAR,NPAR,IX,CAVE,SUMS20,NOPC,J1A,J1B,
     6  NIJK(KS,KC,2),NOTSJ1(KS,100),NOT,NLT,NORCD,A,LCI,LCIP,J1X,
     7  ICNVRT(2),NLASTT(KS),NDIFFJ(KS),NOTOTJ(KS),NTOTTJ(100),
     8  NTOTJJ(KS,100),LLIJK(KS,KC,2),IIPRTY,FLLIJK(KS,KC,2),
     9  SSOPI2,SOPI2(KC,KC),NCK(2),TEXCIT,EMEAN,ZERO,HALF,ONE,THRHAL,
     *  TWO,IPLOTC,IW6,NOICWR,NOIC(2),NOICMUP(2),IQS,INWOL,ICPTR
      COMMON/C3A/ISUBJ(KC),MULS(KS),LHS(KS),
     1  NALS(KMX,KS),NCFG(KMX),NALSJ(KMX,KS),SCRL(KMX,KS),SCRS(KMX,KS),
     2  FJ(KMX,KS),SCRJ(KMX,KS), MUL(KS),LH(KS),LF(KLSC),NSJK(110),
     3  FK(KMX),FKJ(KMX),SCRL6(KMX),SCRS6(KMX),FK6(KMX),LHQQ(KMX),
     4  MULTQQ(KMX),NALSJP(KJP,KS),PJ(KJP,KS),NOICRD
      COMMON/C6/EMIN,EMAX,SUMWT,FLBDN,FLBDX,FNUNP,FNUXP,NLEV,IEWR
      COMMON/CC/   C(KMX,KMX)
      COMMON/C3LC2/TMX(KMX,KMX)
      COMMON/C3LC3/CT4(KMX,KMX)
      COMMON/C3LC4/DUMLC4(KLC42)
      COMMON/EE/ELEM(3,KC,2),VPAR(KPR,2),AVP(9,2),AVEIG(2),AVCG(2),
     1  NPARK(2),NPAV(KC),    EIG(KMX),ELEM1(3),FNT(9,2),I1,I2,
     2  IFACT(4),FACT(4),LCSER(KMX),X(KMX)
      DIMENSION NPARJ(KC,KC)
      EQUIVALENCE (DUMLC4(KLC4),NPARJ)
      CHARACTER*8 FIDLS,FIDJJ,LDES,LDESP,PARNAM,AA,COUPL,SJ8,
     1  YIDEN(KMX,2)
      CHARACTER LSYMB*4,LHS4,LHS41,PARNM(KPR)*10
      COMMON/CHAR/PARNAM(KPR,2),FIDLS(KMX,2),FIDJJ(KMX,2),LDES(KMX),
     1  LDESP(KMX)
      PARAMETER (MAXBC=50000)
      CHARACTER*12 BUFC
      COMMON/BUFS/BUFC(MAXBC)
      INTEGER*1 KK1,KK2
C
C
      CALL CLOCK(TIME)
      DELT=TIME-TIME0
      IF (IW6.LT.0) WRITE (*,95) DELT
   95 FORMAT (//' START RCEINP AT TIME=',F9.3,4H MIN/)
      REWIND 2
      NOCSET = IABS(NOCSET)
      IF (NOCSET.EQ.0) NOCSET=1
      K=1
      IL=ILA
  100 J1X = NSCONF(2,K)
      NPAR = 0
      DO 140 MZQ=1,J1X
        NPAR = NPAR+NPARJ(MZQ,MZQ)
        DO 140 NZQ=MZQ,J1X
          IF (NZQ.NE.MZQ) NPAR = NPAR+NPARJ(MZQ,NZQ)
  140 CONTINUE
      WRITE (2) NOCSET,NSCRJ8,NPAR,J1X,((NPARJ(L,LP),LP=L,J1X),
     1 L=1,J1X)
      NPAR = NPAR-J1X
      NORD=0
      ISPACE=0
      ITRANS=0
      KCPRCE=0
      IF (NOSUBC.EQ.1) GO TO 151
      II=7
      IF (NOSUBC.LT.3) II=4
      DO 150 I=3,II
        IF (KCPLD(I).NE.0) GO TO 150
        ISPACE=ISPACE+1
        JJJ=I
  150 CONTINUE
      IF (ISPACE.EQ.1) THEN
        ITRANS=1
        KCPRCE=JJJ
      ENDIF
C
  151 DO 400 MZQ=1,NSCRJ8
C               READ TMX(LS,JJ)
C     READ (IC) SCRJ8,NLS, ((TMX(L,LP),L=1,NLS), LP=1,NLS),
C    1  ((NALS(L,I),SCRL(L,I),SCRS(L,I),
C    2  I=1,NOSUBC), NCFG(L),FIDLS(L,1),FIDJJ(L,1), L=1,NLS)
C ****************************************************  A.KRAMIDA  v
      READ (IC) SCRJ8,NLS, ((NALS(L,I),SCRL(L,I),SCRS(L,I),
     1  I=1,NOSUBC), NCFG(L),FIDLS(L,1),FIDJJ(L,1), L=1,NLS)
      IMSQ=NLS*NLS
      CALL UNPK1(IC,NLS,NLS,TMX,KMX,KMX,BUFC,IMSQ,MAXBC)
      ICPTR=ICPTR+2
C ****************************************************  A.KRAMIDA  ^      
      I1=KCPL
      I2=3-I1
  152 DO 160 L=1,NLS
C       YIDEN(L,I1)=FIDLS(L,1)
C       YIDEN(L,I2)=FIDJJ(L,1)
        WRITE (YIDEN(L,I1),14) FIDLS(L,1)
        WRITE (YIDEN(L,I2),14) FIDJJ(L,1)
   14   FORMAT (1H(,A7)
C       ENCODE (8,18,SJ8) SCRJ8
        WRITE (SJ8,18) SCRJ8
   18   FORMAT (2X,2HJ=,F4.1)
C               CALC G-MATRIX, AND TRANSFORM IF KCPL=2
        DO 154 LP=1,NLS
  154   C(L,LP)=0.D0
        IF (SCRJ8.EQ.0.D0) GO TO 160
        SS=SCRS(L,NOSUBC)
        SL=SCRL(L,NOSUBC)
        C(L,L)=0.50116D0*(SS**2+SS-SL**2-SL)/(SCRJ8**2+SCRJ8)+1.50116D0
  160 CONTINUE
      IF (KCPL.EQ.1) GO TO 165
      DO L=1,NLS
        DO LP=1,NLS
          SS=0.D0
          DO LPP=1,NLS
            SS=SS+C(L,LPP)*TMX(LPP,LP)
          ENDDO
          CT4(L,LP)=SS
        ENDDO
      ENDDO
C               TRANSPOSE FROM TMX(LS,JJ) TO TMX(JJ,LS)
      DO L=1,NLS
        DO LP=L,NLS
          A=TMX(L,LP)
          TMX(L,LP)=TMX(LP,L)
          TMX(LP,L)=A
        ENDDO
      ENDDO
      DO L=1,NLS
        DO LP=1,NLS
          A=0.D0
          DO LPP=1,NLS
            A=A+TMX(L,LPP)*CT4(LPP,LP)
          ENDDO
          C(L,LP)=A
        ENDDO
      ENDDO
C               WRITE G-MATRIX ON 15
  165 REWIND 15
      IMSQ=NLS*(NLS+1)/2
      CALL PK1(15,NLS,NLS,C,KMX,KMX,BUFC,IMSQ,MAXBC)   !,13,IW)
C     WRITE (15) ((C(L,LP),L=LP,NLS), LP=1,NLS)
      IF (ITRANS.EQ.0) GO TO 188
      IF (NLS.GT.NLSMAX) GO TO 188
      DO L=1,NLS
        YIDEN(L,2)=YIDEN(L,1)
      ENDDO
      I2=I1
      I1=KCPRCE
      IF (NLS.EQ.1) GO TO 188
      DO I=1,NPAR
        READ (IC) DUMDCG
      ENDDO
      ICPTR=ICPTR+NPAR
C               READ TMX(I,KCPL)
C     READ (IC) ((TMX(LP,L),LP=1,NLS),FK(L),FKJ(L),SCRJ(L,1),SCRJ(L,2),
C    1 SCRL6(L),FK6(L),SCRS6(L),LHQQ(L),MULTQQ(L),L=1,NLS)
C **************************************************** A.KRAMIDA v
      READ (IC) (FK(L),FKJ(L),SCRJ(L,1),SCRJ(L,2),
     1 SCRL6(L),FK6(L),SCRS6(L),LHQQ(L),MULTQQ(L),L=1,NLS)
      IMSQ=NLS*NLS
      CALL UNPK1(IC,NLS,NLS,TMX,KMX,KMX,BUFC,IMSQ,MAXBC)
      ICPTR=ICPTR+2
C **************************************************** A.KRAMIDA ^
      GO TO (176,176,176,178,180,182,184) KCPRCE
  176 DO L=1,NLS
        KK1=0
        LP1=0
        DO LP=1,L-1       ! MAKE THE TERM NAME UNIQUE (FOR RCE)
          READ (YIDEN(LP,1),2101) RD1,KK2,RD2
          IF (RD1.EQ.SCRJ(L,1).AND.RD2.EQ.FKJ(L)) THEN
            KK1=KK2
            LP1=LP
          ENDIF
        ENDDO
        IF (KK1.NE.0) THEN
          IF (KK1.EQ.32) THEN
            KK1=97                     ! REPLACE ' ' FOR 'a'
            WRITE(YIDEN(LP1,1),21) SCRJ(LP1,1),KK1,FKJ(LP1)
          ENDIF
          KK1=KK1+1
          IF (KK1.GT.122) KK1=65 ! 'A' CHARACTER
          IF (KK1.EQ.91) KK1=90  ! TOO MANY EQUAL TERMS: FAIL
        ELSE
          KK1=32
        ENDIF
        WRITE (YIDEN(L,1),21) SCRJ(L,1),KK1,FKJ(L)
   21   FORMAT(F3.1,1HK,A1,F3.1)
 2101   FORMAT(F3.1,1X,A1,F3.1)
      ENDDO
      GO TO 186
  178 DO L=1,NLS
        LP1=SCRL(L,NOSUBC)+1.D0
        LHS4=LSYMB(LP1)
        KK1=0
        LP1=0
        DO LP=1,L-1       ! MAKE THE TERM NAME UNIQUE (FOR RCE)
          READ (YIDEN(LP,1),2201) KK2,LHS41,RD1
          IF (LHS41.EQ.LHS4.AND.RD1.EQ.FK(L)) THEN
            KK1=KK2
            LP1=LP
          ENDIF
        ENDDO
        IF (KK1.NE.0) THEN
          IF (KK1.EQ.32) THEN
            KK1=97                     ! REPLACE ' ' FOR 'a'
            LP2=SCRL(LP1,NOSUBC)+1
            LHS41=LSYMB(LP2)
            WRITE(YIDEN(LP1,1),22) KK1,LHS41,FK(LP1)
          ENDIF
          KK1=KK1+1
          IF (KK1.GT.122) KK1=65 ! 'A' CHARACTER
          IF (KK1.EQ.91) KK1=90  ! TOO MANY EQUAL TERMS: FAIL
        ELSE
          KK1=32
        ENDIF
        WRITE (YIDEN(L,1),22) KK1,LHS4,FK(L)
   22   FORMAT(2A1,1H(,F4.1,1H))
 2201   FORMAT(2A1,1X,F4.1)
      ENDDO
      GO TO 186
  180 DO L=1,NLS
        KK1=0
        LP1=0
        DO LP=1,L-1       ! MAKE THE TERM NAME UNIQUE (FOR RCE)
          READ (YIDEN(LP,1),2101) RD1,KK2,RD2
          IF (RD1.EQ.SCRJ(L,1).AND.RD2.EQ.FK(L)) THEN
            KK1=KK2
            LP1=LP
          ENDIF
        ENDDO
        IF (KK1.NE.0) THEN
          IF (KK1.EQ.32) THEN
            KK1=97                     ! REPLACE ' ' FOR 'a'
            WRITE(YIDEN(LP1,1),21) SCRJ(LP1,1),KK1,FK(LP1)
          ENDIF
          KK1=KK1+1
          IF (KK1.GT.122) KK1=65 ! 'A' CHARACTER
          IF (KK1.EQ.91) KK1=90  ! TOO MANY EQUAL TERMS: FAIL
        ELSE
          KK1=32
        ENDIF
        WRITE (YIDEN(L,1),21) SCRJ(L,1),KK1,FK(L)
      ENDDO
      GO TO 186
  182 DO L=1,NLS
        WRITE (YIDEN(L,1),23) SCRJ(L,2),LHQQ(L),FK6(L),MULTQQ(L)
   23   FORMAT(F3.1,A1,F3.1,I1)
      ENDDO
      GO TO 186
  184 DO L=1,NLS
        WRITE (YIDEN(L,1),24) SCRJ(L,2),MULTQQ(L),LHQQ(L),SCRJ(L,1)
   24   FORMAT(F3.1,I1,A1,F3.1)
      ENDDO
C 186 NPARS=NPAR+1
  186 NPARS=NPAR+2
C     DO 187 I=1,NPARS
C 187 BACKSPACE IC
      CALL BACKIC(IC,NPARS,ICPTR)
C     REWIND IC
C     NORD=NOIC(K)+2+(MZQ-1)*(NPAR+2)
C     NORD=NOIC(K)+3+(MZQ-1)*(NPAR+4)   ! 3 and 4 instead of 2 due to PK1
C     DO 187 I=1,NORD
C 187 READ (IC) DUMDCG
C        WRITE (*,1125) NPARS,NOIC,NOICMUP,NORD
C1125 FORMAT (' NPARS,NOIC,NOICMUP,NORD=',I5,2X,2I5,2X,2I5,2X,I5)
C               WRITE TMX(I,KCPL), OR (IF ITRANS=0 OR NLS.GT.NLSMAX)
C   TMX(LS,JJ) IF KCPL=1 OR TMX(JJ,LS) IF KCPL=2.
C 188 WRITE (2) SJ8,NLS, ((TMX(L,LP),L=1,NLS), LP=1,NLS),
C    1 (NCFG(L),L=1,NLS),((YIDEN(L,NZQ),L=1,NLS),NZQ=1,2)
C  ******************************************************** A.KRAMIDA v
  188 WRITE (2) I1,I2,SJ8,NLS,
     1 (NCFG(L),L=1,NLS),((YIDEN(L,NZQ),L=1,NLS),NZQ=1,2)
      IMSQ=NLS*NLS
      CALL PK1(2,NLS,NLS,TMX,KMX,KMX,BUFC,IMSQ,MAXBC)  !,10,IW)
C  ******************************************************** A.KRAMIDA ^
      NPARS=NPAR+1
      DO 250 NZQ=1,NPARS  ! WRITE MATRIX OF dC(L,LP)/dPAR
C  ******************************************************** A.KRAMIDA v
        IF (NZQ.NE.NPARS) THEN            ! READ COEFF MATRIX
          CALL UNPK1(IC,NLS,NLS,C,KMX,KMX,BUFC,0,MAXBC)
          ICPTR=ICPTR+1
        ELSE                              ! READ G MATRIX
          REWIND 15
          CALL UNPK1(15,NLS,NLS,C,KMX,KMX,BUFC,0,MAXBC)
        ENDIF
C  ******************************************************** A.KRAMIDA ^
  210   IF (ITRANS.EQ.0) GO TO 240
        IF (NLS.EQ.1) GO TO 240
        IF (NLS.GT.NLSMAX) GO TO 240
C               IF ITRANS.GT.0 AND NLS.LE.NLSMAX, TRANSF MATRIX TO I.
        DO 220 L=2,NLS
          LS=L-1
          DO 220 LP=1,LS
  220   C(LP,L)=C(L,LP)
        DO L=1,NLS
          DO LP=1,NLS
            DELT=0.D0
            DO LPP=1,NLS
              DELT=DELT+TMX(L,LPP)*C(LPP,LP)
            ENDDO
            CT4(L,LP)=DELT
          ENDDO
        ENDDO
        DO L=1,NLS
          DO LP=1,L
            DELT=0.D0
            DO LPP=1,NLS
              DELT=DELT+CT4(L,LPP)*TMX(LP,LPP)
            ENDDO
            C(L,LP)=DELT
          ENDDO
        ENDDO
C
C 240   WRITE (2) ((C(L,LP),L=LP,NLS), LP=1,NLS)
C  ******************************************************** A.KRAMIDA
        IMSQ=NLS*(NLS+1)/2
  240   CALL PK1(2,NLS,NLS,C,KMX,KMX,BUFC,IMSQ,MAXBC)  !,11,IW)
C  ********************************************************
  250 CONTINUE
      CALL CLOCK(TIME)
      DELT=TIME-TIME0
      IF (IW6.LT.0) WRITE (*,15) MZQ,NSCRJ8,DELT,NLS,NPARS
   15 FORMAT (' END CALC OF MATRIX',I3,' OF',I3,';   TIME=',
     1  F9.2,',   SIZE=',I3,',   NPARS=',I4)
      IF (ISPACE.EQ.0) GO TO 400
      IF (NLS.EQ.1) GO TO 400
      IF (NLS.GT.NLSMAX) GO TO 400
      DO 399 I=1,ISPACE
        ICPTR=ICPTR+2
        READ (IC) DUMDCG     ! ADDITIONAL READ BECAUSE OF USE OF PK1
  399 READ (IC) DUMDCG
  400 CONTINUE
      CALL CLOCK(TIME)
      DELT=TIME-TIME0
      WRITE (IW,40) NOCSET,DELT,COUPL(I1),COUPL(I2)
   40 FORMAT (12H0CSET NUMBER,I4,27H WRITTEN ON TAPE 2 AT TIME=,F9.2,
     1  17H  FOR COUPLINGS  ,A8,7H  AND  ,A8//)
      IF (IW6.LT.0) WRITE (*,40) NOCSET,DELT,COUPL(I1),COUPL(I2)
C
C          WRITE INPUT FOR RCE ON DISK 11, USING (IF A DIAGONALIZATION
C               HAS BEEN MADE) COMPUTED INSTEAD OF EXPERIMENTAL LEVELS,
C               AND USING THE THEORETICAL PARAMETER VALUES
C               AS PRELIMINARY ESTIMATES; IF NO DIAGONALIZATION,
C               THEN USE ZEROES FOR THE ABOVE QUANTITIES.
C
  500 NOCYPR=1
      NOCYCR=30
      NOCYCE=5
      INVECT=0
      IORDER=0
      ISAMPLE=0
      WRITE (11,51) NOCYPR,NOCYCR,NOCYCE,IW6,INVECT,IORDER,ISAMPLE
   51 FORMAT (7I5)
      NCDES=NOCSET
      IDENOM=0
      IPRNV=1
      IPRNA=1
      WMAX=0.D0
      IPRNX=1
      IPRNSQ=3
      SCALE=1.D0
      WRITE (11,52) NCDES,IDENOM,IPRNV,IPRNA,WMAX,IPRNX,IPRNSQ,SCALE
   52 FORMAT (4I5,F10.3,2I5,F10.4)
C     WRITE (11,53) ELEM(1,1,K),(ELEM(2,I,K),ELEM(3,I,K), I=1,J1X)
C  53 FORMAT (A8,2X,6(A6,A4)/7(A6,A4))
      WRITE (11,53) ELEM(1,1,K),(ELEM(2,I,K),ELEM(3,I,K), I=1,6)
   53 FORMAT (A8,2X,6(A6,A4))
      NL1=J1X/7
      DO 522 I1=1,NL1 
        IM1=6
        IF (I1.EQ.NL1) IM1=MOD(J1X,7)+1
  522 WRITE (11,521) (ELEM(2,I1*7+I,K),ELEM(3,I1*7+I,K), I=0,IM1)
  521 FORMAT (7(A6,A4))
      NPAR=NPAR+J1X
      J=0
      DO 530 I=1,NPAR
      WRITE (PARNM(I),523) PARNAM(I,K)
  523 FORMAT (A8,2X)
      IF (PARNM(I)(1:3).NE.'EAV') GO TO 530
      J=J+1
      WRITE (PARNM(I),524) ELEM(2,J,K)
  524 FORMAT (4HEAV ,A6)
  530 CONTINUE
      WRITE (11,54) (PARNM(I), I=1,NPAR)
   54 FORMAT (7A10)
      REWIND IL
      IF (IEWR.GT.0) GO TO 550
      DO 540 LP=1,KMX
  540 EIG(LP)=0.D0
      DO 545 I=1,KPR
  545 VPAR(I,K)=0.D0
      READ (IL)
  550 GRE=0.D0
      DO 552 I=1,NPAR
  552 GRE=DMAX1(VPAR(I,K),GRE)
      DO 560 N=1,NSCRJ8
      IF (IEWR.GT.0) GO TO 558
      READ (IL) SJ,NLS
      GO TO 559
  558 READ (IL) SJ,NLS, (EIG(LP), (ERAS,L=1,NLS), LP=1,NLS)
C 558 READ (IL) SJ,NLS, (EIG(LP), LP=1,NLS)
C     READ (IL)
      READ (IL)
  559 IF (GRE.LE.7.0D3) WRITE (11,55) (EIG(LP), LP=1,NLS)
   55 FORMAT (7F10.4)
      IF (GRE.GT.7.0D3.AND.GRE.LE.7.0D4) WRITE(11,56) (EIG(LP),LP=1,NLS)
   56 FORMAT (7F10.3)
      IF (GRE.GT.7.0D4) WRITE (11,57) (EIG(LP), LP=1,NLS)
   57 FORMAT (7F10.2)
  560 WRITE (11,58) (LP, LP=1,NLS)
   58 FORMAT (7I10)
      NPAR=0
      DO 565 MZQ=1,J1X
  565 NPAR=NPAR+NPARJ(MZQ,MZQ)
      J=-50
      DO 570 I=1,NPAR
      MULTQQ(I)=0
      IF (IEWR.EQ.0.OR.I.EQ.1.OR.VPAR(I,K).GT.0.D0) GO TO 570
      MULTQQ(I)=-99
  570 CONTINUE
      IF (J1X.EQ.1) GO TO 600
      J1X1=J1X-1
      DO 590 MZQ=1,J1X1
      MZQ1=MZQ+1
      NPAR2=0
      DO 585 MP=MZQ1,J1X
  585 NPAR2=NPAR2+NPARJ(MZQ,MP)
      NPAR2=NPAR+NPAR2
      NPAR=NPAR+1
      J=J-1
      DO 588 I=NPAR,NPAR2
  588 MULTQQ(I)=J
  590 NPAR=NPAR2
  600 WRITE (11,58) (MULTQQ(I), I=1,NPAR)
      XMAX=0.D0
      WRITE (11,55) (XMAX, I=1,NPAR)
      IF (GRE.LE.7.0D3) WRITE (11,55) (VPAR(I,K), I=1,NPAR)
      IF (GRE.GT.7.0D3.AND.GRE.LE.7.0D4)
     1  WRITE (11,56) (VPAR(I,K), I=1,NPAR)
      IF (GRE.GT.7.0D4) WRITE (11,57) (VPAR(I,K), I=1,NPAR)
      F0=1.D0
      FM=0.D0
      F1=-1.D0
      DELF=0.D0
      NOFMAX=1000
      GMAX=1.D0
      DXMAX=10000.D0
      CRIT1=-0.3D0
      CRIT=0.D0
      ICRIT2=-1
      WRITE (11,60) F0,FM,F1,DELF,NOFMAX,GMAX,DXMAX,CRIT1,CRIT,ICRIT2
   60 FORMAT (3F10.1,F5.2,I5,F10.3,F10.2,2F5.2,I2)
      NCDES=-1
      WRITE (11,52) NCDES
C
      IF (K.EQ.2) GO TO 900
      K=2
      IL=ILB
C        WRITE (*,1125) NPARS,NOIC,NOICMUP,NORD
      IF (NSCONF(1,K).EQ.0) GO TO 900
      IF (NOICMUP(1).NE.0) THEN
        ISPACE=NOICMUP(1)
        DO 700 I=1,ISPACE
          ICPTR=ICPTR+1
  700   READ (IC) DUMDCG
      ENDIF
  710 NOCSET=NOCSET+1
      READ (IC) NOTSJ1,NSCRJ8,SJ8MN,SJ8MX,NPAR,NPARJ,PARNAM
      ICPTR=ICPTR+1
      GO TO 100
C
  900 RETURN
      END
C
      SUBROUTINE SENIOR(KK,J,MI,LI,CHH)
      IMPLICIT REAL*8 (A-H,O-Z)
      CHARACTER*1 LL(8),D,CHH,LI
      CHARACTER CH1*2,CH2*3,CH1R*2,CH2R*3,CHH1*2
      DIMENSION CH2R(20),NN(8)
      DATA D/'D'/

      REWIND 21
 11   READ (21,10) KK1,J1,(LL(I),NN(I), I=1,8)
 10   FORMAT(I4,I4,7X,8(A1,I2,3X))
      IF(KK1.NE.KK.OR.J1.NE.J) GO TO 11
      I=0
  20  I=I+1
      IF (I.GT.8) RETURN
      IF (LL(I).EQ.'F') RETURN
      IF(LL(I).EQ.D) GO TO 30
      GO TO 20
  30  NNI=NN(I)
      GO TO (20,20,20,4,4,4,4,4,20,20,20) NNI+1
  4   WRITE (CH1,40) LL(I),NNI
  40  FORMAT(A1,I1)
      WRITE (CH2,50) MI,LI,CHH
  50  FORMAT(I1,A1,A1)
      REWIND 22
  100 READ (22,60) CH1R
   60 FORMAT (A2)
      IF (CH1R.NE.CH1) GO TO 100
      READ (22,'(20A3)') (CH2R(L), L=1,20)
      DO 110 II=1,20
        IF (CH2.NE.CH2R(II)) GO TO 110
        READ(CH2R(II+1),70) CHH1,CHH
   70   FORMAT(A2,A1)
        GO TO 120
  110 CONTINUE
  120 CONTINUE
      RETURN
      END
